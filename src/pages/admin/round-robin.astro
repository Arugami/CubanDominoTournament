---
// Admin Group Stage - Group Stage Tournament Management
// 8 teams -> Group A + Group B (3 matchdays each) -> seed finals
import AdminLayout from '../../components/admin/AdminLayout.astro';
---

<AdminLayout title="Group Stage" activeNav="round-robin">
  <div class="rr-page">
    <!-- Header Actions -->
    <div class="page-actions">
      <div class="rr-status">
        <span id="rrStatus">Loading...</span>
      </div>
      <div class="action-buttons">
        <button class="btn btn--secondary btn-slam" id="assignTeamsBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <polyline points="17 11 19 13 23 9" />
          </svg>
          <span class="btn__label">Build Groups</span>
        </button>
        <button class="btn btn--primary btn-slam" id="seedFinalsBtn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
            <path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z" />
          </svg>
          Seed Finals
        </button>
      </div>
    </div>

    <!-- Standings Grid -->
    <div class="standings-grid">
      <div class="card standings-card">
        <div class="card__header">
          <h2 class="card__title">Group A</h2>
          <span class="standings-subtitle" id="standingsSubtitleA">0/6 matches</span>
        </div>
        <div class="standings-table-wrapper">
          <table class="standings-table" aria-label="Group A standings">
            <thead>
              <tr>
                <th class="col-rank">#</th>
                <th class="col-team">Team</th>
                <th class="col-record">W-L</th>
                <th class="col-diff">+/-</th>
              </tr>
            </thead>
            <tbody id="standingsBodyA">
              <tr class="loading-row">
                <td colspan="4">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card standings-card">
        <div class="card__header">
          <h2 class="card__title">Group B</h2>
          <span class="standings-subtitle" id="standingsSubtitleB">0/6 matches</span>
        </div>
        <div class="standings-table-wrapper">
          <table class="standings-table" aria-label="Group B standings">
            <thead>
              <tr>
                <th class="col-rank">#</th>
                <th class="col-team">Team</th>
                <th class="col-record">W-L</th>
                <th class="col-diff">+/-</th>
              </tr>
            </thead>
            <tbody id="standingsBodyB">
              <tr class="loading-row">
                <td colspan="4">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Matchday Selector Pills -->
    <div class="round-pills">
      <button class="round-pill active" data-round="all">All</button>
      <button class="round-pill" data-round="1">Day 1</button>
      <button class="round-pill" data-round="2">Day 2</button>
      <button class="round-pill" data-round="3">Day 3</button>
    </div>

    <!-- Matches Container -->
    <div class="matches-container" id="matchesContainer">
      <div class="loading-matches">Loading matches...</div>
    </div>
  </div>

  <!-- Seed Finals Confirmation Modal -->
  <div class="modal-backdrop" id="seedFinalsModal">
    <div class="modal modal--sm">
      <div class="modal__header">
        <h2 class="modal__title">Seed Finals Bracket</h2>
      </div>
      <div class="modal__body">
        <p>Semifinals will be seeded from group results:</p>
        <div class="seeding-preview" id="seedingPreview">
          <div class="seeding-match">
            <span class="seeding-label">Semi 1:</span>
            <span class="seeding-teams">A1 <span id="a1Name">-</span> vs B2 <span id="b2Name">-</span></span>
          </div>
          <div class="seeding-match">
            <span class="seeding-label">Semi 2:</span>
            <span class="seeding-teams">B1 <span id="b1Name">-</span> vs A2 <span id="a2Name">-</span></span>
          </div>
        </div>
        <p class="warning-text">Make sure all 12 group stage matches are complete.</p>
      </div>
      <div class="modal__actions">
        <button type="button" class="btn btn--secondary" id="cancelSeed">Cancel</button>
        <button type="button" class="btn btn--primary" id="confirmSeed">Seed Finals</button>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .rr-page {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .page-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .rr-status {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
    text-align: center;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .action-buttons .btn {
    flex: 1;
    max-width: 160px;
    justify-content: center;
    padding: 10px 16px;
    font-size: 0.75rem;
  }

  .action-buttons .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .action-buttons .btn.is-loading {
    opacity: 0.75;
    pointer-events: none;
  }

  .action-buttons .btn.is-loading svg {
    animation: spin 0.9s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Standings Grid */
  .standings-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }

  /* Standings Card */
  .standings-card {
    padding: 0;
    overflow: hidden;
  }

  .standings-card .card__header {
    padding: 16px;
    margin-bottom: 0;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 12px;
  }

  .standings-subtitle {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.4);
    white-space: nowrap;
  }

  .standings-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .standings-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .standings-table th {
    padding: 10px 12px;
    text-align: left;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--copper);
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid var(--border-subtle);
  }

  .standings-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .standings-table tr:last-child td {
    border-bottom: none;
  }

  .col-rank {
    width: 40px;
    text-align: center !important;
  }

  .col-team {
    min-width: 120px;
  }

  .col-record {
    width: 60px;
    text-align: center !important;
  }

  .col-diff {
    width: 60px;
    text-align: right !important;
  }

  /* Standings Row Styles */
  .standings-row {
    transition: background 0.2s ease;
  }

  .standings-row:hover {
    background: rgba(255, 255, 255, 0.02);
  }

  .standings-row--qualifier {
    background: rgba(212, 165, 116, 0.05);
  }

  .standings-row--qualifier:hover {
    background: rgba(212, 165, 116, 0.08);
  }

  .rank-cell {
    font-family: "Bodoni Moda", serif;
    font-weight: 700;
    color: var(--brass);
    text-align: center;
  }

  .rank-cell--top2 {
    color: var(--gold);
  }

  .team-cell {
    font-weight: 500;
    color: #fff;
  }

  .record-cell {
    font-family: "IBM Plex Sans", sans-serif;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    text-align: center;
  }

  .diff-cell {
    font-weight: 600;
    text-align: right;
  }

  .diff-cell--positive {
    color: #81c784;
  }

  .diff-cell--negative {
    color: #e57373;
  }

  .diff-cell--neutral {
    color: rgba(255, 255, 255, 0.4);
  }

  .loading-row td {
    text-align: center;
    color: rgba(255, 255, 255, 0.4);
    font-style: italic;
    padding: 24px;
  }

  /* Matchday Pills */
  .round-pills {
    display: flex;
    gap: 6px;
    padding: 4px;
    overflow-x: auto;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }

  .round-pills::-webkit-scrollbar {
    display: none;
  }

  .round-pill {
    flex-shrink: 0;
    padding: 8px 14px;
    font-family: "IBM Plex Sans Condensed", sans-serif;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(255, 255, 255, 0.4);
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid transparent;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    -webkit-tap-highlight-color: transparent;
  }

  .round-pill.active {
    color: var(--brass);
    background: rgba(212, 165, 116, 0.15);
    border-color: var(--border-accent);
  }

  .round-pill:active {
    transform: scale(0.95);
  }

  /* Matches Container */
  .matches-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .loading-matches {
    text-align: center;
    color: rgba(255, 255, 255, 0.4);
    font-style: italic;
    padding: 40px 20px;
  }

  .matchday-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .matchday-group__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 4px;
  }

  .matchday-group__title {
    font-family: "Bodoni Moda", serif;
    font-size: 1rem;
    font-weight: 700;
    color: var(--brass);
  }

  .matchday-group__progress {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.4);
    padding: 4px 10px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
  }

  .group-slice {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 12px;
    border: 1px solid var(--border-subtle);
    border-radius: 14px;
    background: rgba(0, 0, 0, 0.25);
  }

  .group-slice__header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(212, 165, 116, 0.12);
  }

  .group-slice__title {
    font-family: "IBM Plex Sans Condensed", sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.7);
  }

  .group-slice__meta {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.35);
    white-space: nowrap;
  }

  /* Match Card - Domino Tile Feel */
  .match-card {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 14px;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    -webkit-tap-highlight-color: transparent;
  }

  .match-card.saving {
    transform: scale(0.98);
    box-shadow: 0 0 0 2px rgba(212, 165, 116, 0.3);
  }

  .match-card--completed {
    border-color: rgba(129, 199, 132, 0.3);
  }

  .match-card--in-progress {
    border-color: var(--border-accent);
    background: rgba(212, 165, 116, 0.03);
  }

  .match-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .match-card__label {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--copper);
  }

  .match-card__status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
  }

  .match-card__status--in_progress {
    background: var(--brass);
    box-shadow: 0 0 8px rgba(212, 165, 116, 0.5);
    animation: pulse 2s ease-in-out infinite;
  }

  .match-card__status--completed {
    background: #81c784;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .match-card__teams {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
  }

  .team-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 10px;
    border: 1px solid transparent;
    transition: all 0.2s ease;
  }

  .team-row.winner {
    background: linear-gradient(90deg, rgba(212, 165, 116, 0.12), rgba(212, 165, 116, 0.03));
    border-color: var(--brass);
  }

  .team-row.winner .team-name {
    color: var(--brass);
  }

  .team-name {
    flex: 1;
    font-size: 0.9rem;
    font-weight: 500;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .score-input {
    width: 52px;
    padding: 8px 6px;
    font-family: "IBM Plex Sans", sans-serif;
    font-size: 1rem;
    font-weight: 600;
    text-align: center;
    color: #fff;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    outline: none;
    -webkit-tap-highlight-color: transparent;
    transition: border-color 0.2s ease;
  }

  .score-input:focus {
    border-color: var(--brass);
  }

  .score-input::placeholder {
    color: rgba(255, 255, 255, 0.2);
  }

  .score-input::-webkit-outer-spin-button,
  .score-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .save-btn {
    width: 100%;
    padding: 12px 16px;
    font-family: "IBM Plex Sans Condensed", sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--brass);
    background: rgba(212, 165, 116, 0.1);
    border: 1px solid var(--border-accent);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.15s ease;
    -webkit-tap-highlight-color: transparent;
    min-height: 44px;
  }

  .save-btn:active {
    background: rgba(212, 165, 116, 0.25);
    transform: scale(0.98);
  }

  .save-btn.saving {
    opacity: 0.7;
    pointer-events: none;
  }

  .save-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* Modal Styles */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    display: flex;
    align-items: flex-end;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .modal-backdrop.open {
    opacity: 1;
    visibility: visible;
  }

  .modal {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: 20px 20px 0 0;
    width: 100%;
    transform: translateY(100%);
    transition: transform 0.3s ease;
  }

  .modal-backdrop.open .modal {
    transform: translateY(0);
  }

  .modal--sm {
    max-height: 60vh;
  }

  .modal__header {
    padding: 20px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .modal__title {
    font-family: "Bodoni Moda", serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--brass);
  }

  .modal__body {
    padding: 20px;
    padding-bottom: max(20px, env(safe-area-inset-bottom));
  }

  .modal__body p {
    margin-bottom: 12px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
  }

  .seeding-preview {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    padding: 16px;
    margin: 16px 0;
  }

  .seeding-match {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-subtle);
  }

  .seeding-match:last-child {
    border-bottom: none;
  }

  .seeding-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--copper);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .seeding-teams {
    font-size: 0.85rem;
    color: #fff;
  }

  .seeding-teams span {
    color: var(--brass);
    font-weight: 600;
  }

  .warning-text {
    color: #e57373;
    font-size: 0.85rem;
  }

  .modal__actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-top: 16px;
    border-top: 1px solid var(--border-subtle);
    margin-top: 8px;
  }

  .modal__actions .btn {
    width: 100%;
    justify-content: center;
    padding: 14px 20px;
    font-size: 1rem;
  }

  /* Desktop overrides */
  @media (min-width: 769px) {
    .rr-page {
      gap: 24px;
    }

    .page-actions {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }

    .action-buttons {
      gap: 12px;
      justify-content: flex-end;
    }

    .action-buttons .btn {
      flex: none;
      max-width: none;
    }

    .standings-grid {
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .standings-card .card__header {
      padding: 20px 24px;
    }

    .standings-table th,
    .standings-table td {
      padding: 14px 16px;
    }

    .standings-table {
      font-size: 0.9rem;
    }

    .round-pills {
      justify-content: center;
      gap: 8px;
    }

    .round-pill {
      padding: 10px 18px;
      font-size: 0.75rem;
    }

    .matchday-groups-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }

    .modal-backdrop {
      align-items: center;
    }

    .modal {
      border-radius: 16px;
      max-width: 420px;
      transform: translateY(20px);
    }

    .modal__actions {
      flex-direction: row;
      justify-content: flex-end;
    }

    .modal__actions .btn {
      width: auto;
      padding: 10px 20px;
      font-size: 0.85rem;
    }
  }
</style>

<script>
  // Admin Group Stage Controller
  let teams = [];
  let matches = [];
  let groupStandings = [];
  let selectedRound = 'all';

  window.addEventListener('adminReady', async ({ detail: { supabase } }) => {
    await loadData(supabase);
    setupEventListeners(supabase);
    setupRealtimeSubscription(supabase);
  });

  async function loadData(supabase) {
    const [teamsRes, matchesRes, standingsRes] = await Promise.all([
      supabase.from('teams').select('*').order('seed'),
      supabase.from('matches').select('*').eq('phase', 'group').order('group_code').order('round_robin_round').order('match_number'),
      supabase.from('group_standings').select('*')
    ]);

    teams = teamsRes.data || [];
    matches = matchesRes.data || [];
    groupStandings = standingsRes.data || [];

    renderStandings();
    renderMatches();
    updateStatus();
  }

  function getGroupTeams(groupCode) {
    return teams.filter(t => t.group_code === groupCode).sort((a, b) => (a.seed || 99) - (b.seed || 99));
  }

  function getGroupStandingsRows(groupCode) {
    const groupTeams = getGroupTeams(groupCode);

    const statsByTeam = new Map(
      groupStandings
        .filter(s => s.group_code === groupCode)
        .map(s => [s.team_id, s])
    );

    const rows = groupTeams.map(team => {
      const stats = statsByTeam.get(team.id) || {};
      return {
        team,
        team_id: team.id,
        wins: stats.wins || 0,
        losses: stats.losses || 0,
        point_diff: stats.point_diff || 0,
        points_for: stats.points_for || 0,
        games_played: stats.games_played || 0
      };
    });

    rows.sort((a, b) => {
      if (b.wins !== a.wins) return b.wins - a.wins;
      if (b.point_diff !== a.point_diff) return b.point_diff - a.point_diff;
      if (b.points_for !== a.points_for) return b.points_for - a.points_for;
      return (a.team.seed || 99) - (b.team.seed || 99);
    });

    return rows;
  }

  function renderStandings() {
    renderGroupStandings('A');
    renderGroupStandings('B');

    const seedFinalsBtn = document.getElementById('seedFinalsBtn');
    const seed = getSeedPreview();
    seedFinalsBtn.disabled = !seed.canSeed;

    document.getElementById('a1Name').textContent = seed.a1?.team?.name || '-';
    document.getElementById('a2Name').textContent = seed.a2?.team?.name || '-';
    document.getElementById('b1Name').textContent = seed.b1?.team?.name || '-';
    document.getElementById('b2Name').textContent = seed.b2?.team?.name || '-';
  }

  function renderGroupStandings(groupCode) {
    const tbody = document.getElementById(groupCode === 'A' ? 'standingsBodyA' : 'standingsBodyB');
    const subtitle = document.getElementById(groupCode === 'A' ? 'standingsSubtitleA' : 'standingsSubtitleB');

    const groupMatches = matches.filter(m => m.group_code === groupCode);
    const completed = groupMatches.filter(m => m.status === 'completed').length;

    subtitle.textContent = `${completed}/6 matches`;

    const rows = getGroupStandingsRows(groupCode);
    if (rows.length === 0) {
      tbody.innerHTML = '<tr class="loading-row"><td colspan="4">Groups not built yet</td></tr>';
      return;
    }

    tbody.innerHTML = rows.map((r, idx) => {
      const rank = idx + 1;
      const isQualifier = rank <= 2;
      const diffClass = r.point_diff > 0 ? 'diff-cell--positive' :
                        r.point_diff < 0 ? 'diff-cell--negative' : 'diff-cell--neutral';
      const diffPrefix = r.point_diff > 0 ? '+' : '';

      return `
        <tr class="standings-row ${isQualifier ? 'standings-row--qualifier' : ''}">
          <td class="rank-cell ${isQualifier ? 'rank-cell--top2' : ''}">${rank}</td>
          <td class="team-cell">${r.team?.name || 'Unknown'}</td>
          <td class="record-cell">${r.wins}-${r.losses}</td>
          <td class="diff-cell ${diffClass}">${diffPrefix}${r.point_diff}</td>
        </tr>
      `;
    }).join('');
  }

  function getSeedPreview() {
    const groupA = getGroupStandingsRows('A');
    const groupB = getGroupStandingsRows('B');

    const a1 = groupA[0];
    const a2 = groupA[1];
    const b1 = groupB[0];
    const b2 = groupB[1];

    const completed = matches.filter(m => m.status === 'completed').length;
    const canSeed = Boolean(a1 && a2 && b1 && b2 && completed === 12);

    return { canSeed, a1, a2, b1, b2 };
  }

  function renderMatches() {
    const container = document.getElementById('matchesContainer');

    if (matches.length === 0) {
      container.innerHTML = '<div class="loading-matches">No group-stage matches yet. Press “Build Groups”.</div>';
      return;
    }

    const roundsToShow = selectedRound === 'all'
      ? [1, 2, 3]
      : [parseInt(selectedRound)];

    container.innerHTML = roundsToShow.map(day => {
      const dayMatches = matches.filter(m => m.round_robin_round === day);
      const completed = dayMatches.filter(m => m.status === 'completed').length;

      const groupA = dayMatches.filter(m => m.group_code === 'A');
      const groupB = dayMatches.filter(m => m.group_code === 'B');

      return `
        <div class="matchday-group" data-round-group="${day}">
          <div class="matchday-group__header">
            <span class="matchday-group__title">Day ${day}</span>
            <span class="matchday-group__progress">${completed}/${dayMatches.length} complete</span>
          </div>
          <div class="matchday-groups-grid">
            ${renderGroupSlice('A', groupA)}
            ${renderGroupSlice('B', groupB)}
          </div>
        </div>
      `;
    }).join('');

    container.querySelectorAll('[data-save-match]').forEach(btn => {
      btn.addEventListener('click', handleSaveMatch);
    });
  }

  function renderGroupSlice(groupCode, groupMatches) {
    const completed = groupMatches.filter(m => m.status === 'completed').length;
    return `
      <div class="group-slice" data-group="${groupCode}">
        <div class="group-slice__header">
          <span class="group-slice__title">Group ${groupCode}</span>
          <span class="group-slice__meta">${completed}/${groupMatches.length} complete</span>
        </div>
        ${groupMatches.map(match => renderMatchCard(match)).join('')}
      </div>
    `;
  }

  function renderMatchCard(match) {
    const team1 = teams.find(t => t.id === match.team1_id);
    const team2 = teams.find(t => t.id === match.team2_id);
    const isWinner1 = match.winner_id && match.winner_id === match.team1_id;
    const isWinner2 = match.winner_id && match.winner_id === match.team2_id;

    const statusClass = match.status === 'completed' ? 'match-card--completed' :
                        match.status === 'in_progress' ? 'match-card--in-progress' : '';

    const statusDotClass = match.status === 'completed' ? 'match-card__status--completed' :
                           match.status === 'in_progress' ? 'match-card__status--in_progress' : '';

    const label = `Group ${match.group_code} • Match ${match.match_number}`;

    return `
      <div class="match-card ${statusClass}" data-match-id="${match.id}">
        <div class="match-card__header">
          <span class="match-card__label">${label}</span>
          <span class="match-card__status ${statusDotClass}"></span>
        </div>
        <div class="match-card__teams">
          <div class="team-row ${isWinner1 ? 'winner' : ''}">
            <span class="team-name">${team1?.name || 'TBD'}</span>
            <input
              type="number"
              class="score-input"
              data-score="1"
              value="${match.team1_score || ''}"
              min="0"
              max="200"
              placeholder="-"
              inputmode="numeric"
              ${!team1 ? 'disabled' : ''}
            />
          </div>
          <div class="team-row ${isWinner2 ? 'winner' : ''}">
            <span class="team-name">${team2?.name || 'TBD'}</span>
            <input
              type="number"
              class="score-input"
              data-score="2"
              value="${match.team2_score || ''}"
              min="0"
              max="200"
              placeholder="-"
              inputmode="numeric"
              ${!team2 ? 'disabled' : ''}
            />
          </div>
        </div>
        <button class="save-btn" data-save-match="${match.id}" ${!team1 || !team2 ? 'disabled' : ''}>
          Save Scores
        </button>
      </div>
    `;
  }

  function updateStatus() {
    const statusEl = document.getElementById('rrStatus');
    const completed = matches.filter(m => m.status === 'completed').length;
    const haveMatches = matches.length > 0;
    const groupTeams = teams.filter(t => t.group_code === 'A' || t.group_code === 'B').length;

    if (!haveMatches) {
      statusEl.textContent = 'Group stage not built yet';
      return;
    }

    if (groupTeams < 8) {
      statusEl.textContent = `Groups incomplete (${groupTeams}/8 teams assigned)`;
      return;
    }

    statusEl.textContent = `${completed}/12 matches complete`;
  }

  async function handleSaveMatch(e) {
    const matchId = e.target.dataset.saveMatch;
    const card = document.querySelector(`[data-match-id="${matchId}"]`);
    const btn = e.target;

    const score1Input = card.querySelector('[data-score="1"]');
    const score2Input = card.querySelector('[data-score="2"]');

    const score1 = parseInt(score1Input?.value) || 0;
    const score2 = parseInt(score2Input?.value) || 0;

    const match = matches.find(m => m.id === matchId);
    if (!match) return;

    card.classList.add('saving');
    btn.classList.add('saving');
    btn.textContent = 'Saving...';

    let winnerId = null;
    let status = 'pending';

    if (match.team1_id && match.team2_id) {
      if (score1 > 0 || score2 > 0) {
        status = 'in_progress';
      }
      if (score1 > 0 && score2 > 0 && score1 !== score2) {
        winnerId = score1 > score2 ? match.team1_id : match.team2_id;
        status = 'completed';
      }
    }

    try {
      await window.supabase.from('matches').update({
        team1_score: score1,
        team2_score: score2,
        winner_id: winnerId,
        status,
        completed_at: status === 'completed' ? new Date().toISOString() : null
      }).eq('id', matchId);

      await loadData(window.supabase);

      if (window.showToast) {
        if (status === 'completed') {
          const winner = teams.find(t => t.id === winnerId);
          window.showToast(`${winner?.name || 'Team'} wins!`, 'success');
        } else {
          window.showToast('Scores saved', 'success');
        }
      }
    } catch (err) {
      console.error('Save error:', err);
      if (window.showToast) {
        window.showToast('Failed to save scores', 'default');
      }
    } finally {
      card.classList.remove('saving');
      btn.classList.remove('saving');
      btn.textContent = 'Save Scores';
    }
  }

  function setupEventListeners(supabase) {
    // Round filter pills
    document.querySelectorAll('.round-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        document.querySelectorAll('.round-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        selectedRound = pill.dataset.round;
        renderMatches();
      });
    });

    // Build groups button
    const buildBtn = document.getElementById('assignTeamsBtn');
    const buildLabel = buildBtn.querySelector('.btn__label');
    const originalLabel = buildLabel?.textContent || 'Build Groups';

    buildBtn.addEventListener('click', async () => {
      const seededTeams = teams.filter(t => t.seed).sort((a, b) => a.seed - b.seed);

      if (seededTeams.length < 8) {
        if (window.showToast) {
          window.showToast(`Need 8 seeded teams. Currently have ${seededTeams.length}.`, 'default');
        }
        return;
      }

      buildBtn.classList.add('is-loading');
      buildBtn.disabled = true;
      if (buildLabel) buildLabel.textContent = 'Building…';

      try {
        const { error } = await supabase.rpc('assign_teams_to_group_stage');
        if (error) throw error;

        await loadData(supabase);
        if (window.showToast) {
          window.showToast('Groups built. Matches generated.', 'success');
        }
      } catch (err) {
        console.error('Build groups error:', err);
        if (window.showToast) {
          window.showToast('Failed to build groups', 'default');
        }
      } finally {
        buildBtn.classList.remove('is-loading');
        buildBtn.disabled = false;
        if (buildLabel) buildLabel.textContent = originalLabel;
      }
    });

    // Seed Finals modal
    const modal = document.getElementById('seedFinalsModal');

    document.getElementById('seedFinalsBtn').addEventListener('click', () => {
      modal.classList.add('open');
    });

    document.getElementById('cancelSeed').addEventListener('click', () => {
      modal.classList.remove('open');
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('open');
    });

    document.getElementById('confirmSeed').addEventListener('click', async () => {
      try {
        const { error } = await supabase.rpc('seed_finals_from_group_standings');
        if (error) throw error;

        modal.classList.remove('open');
        if (window.showToast) {
          window.showToast('Finals bracket seeded!', 'success');
        }

        setTimeout(() => {
          window.location.href = '/admin/bracket';
        }, 900);
      } catch (err) {
        console.error('Seed finals error:', err);
        if (window.showToast) {
          window.showToast(err.message || 'Failed to seed finals', 'default');
        }
      }
    });
  }

  function setupRealtimeSubscription(supabase) {
    supabase
      .channel('admin-group-stage-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, () => {
        loadData(supabase);
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'teams' }, () => {
        loadData(supabase);
      })
      .subscribe();
  }
</script>

