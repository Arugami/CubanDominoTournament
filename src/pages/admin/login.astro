---
// Admin Login - La Oficina (Commissioner Access)
const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>La Oficina | CDL Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,700;0,6..96,800;0,6..96,900;1,6..96,400;1,6..96,700&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Sans+Condensed:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --ink: #1c130f;
        --copper: #b76a3b;
        --cream: #f8efe6;
        --bone: #fff7ef;
        --brass: #d4a574;
        --gold: #e8c17a;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        overflow-x: hidden;
        max-width: 100vw;
      }

      body {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        background: #0a0705;
        color: #fff;
        min-height: 100dvh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }

      /* ===== ATMOSPHERIC BACKGROUND ===== */
      .atmosphere {
        position: fixed;
        inset: 0;
        background:
          /* Warm copper glow from top */
          radial-gradient(ellipse at 50% 0%, rgba(183, 106, 59, 0.12) 0%, transparent 50%),
          /* Brass warmth from corner */
          radial-gradient(ellipse at 80% 80%, rgba(212, 165, 116, 0.08) 0%, transparent 40%),
          /* Base warm dark */
          radial-gradient(ellipse at center, #1a120d 0%, #0a0705 100%);
        pointer-events: none;
        z-index: 0;
      }

      /* Film grain */
      .grain {
        position: fixed;
        inset: -50%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.04;
        pointer-events: none;
        z-index: 1;
        animation: grainShift 0.4s steps(10) infinite;
      }

      @keyframes grainShift {
        0%, 100% { transform: translate(0, 0); }
        25% { transform: translate(-3%, -3%); }
        50% { transform: translate(3%, 1%); }
        75% { transform: translate(-1%, 2%); }
      }

      /* Warm vignette - tobacco room edges */
      .vignette {
        position: fixed;
        inset: 0;
        background:
          /* Subtle brass glow at center */
          radial-gradient(ellipse at 50% 30%, rgba(212, 165, 116, 0.04) 0%, transparent 50%),
          /* Dark vignette edges */
          radial-gradient(ellipse at center, transparent 0%, rgba(10, 7, 5, 0.7) 100%);
        pointer-events: none;
        z-index: 2;
      }

      /* ===== MAIN CONTAINER ===== */
      .login-container {
        position: relative;
        z-index: 10;
        width: 100%;
        max-width: 360px;
      }

      /* ===== HEADER ===== */
      .page-header {
        text-align: center;
        margin-bottom: 32px;
      }

      /* ===== CDL WORDMARK - Iconic mark with signature line ===== */
      .cdl-wordmark {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
      }

      .cdl-wordmark__text {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: 2.4rem;
        font-weight: 900;
        font-style: italic;
        letter-spacing: 0.08em;
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .cdl-wordmark__line {
        width: 60px;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--brass), transparent);
      }

      .page-title {
        font-family: "Bodoni Moda", serif;
        font-size: 1.8rem;
        font-weight: 400;
        font-style: italic;
        color: var(--cream);
        letter-spacing: 0.02em;
        line-height: 1.2;
        margin-bottom: 8px;
      }

      .page-subtitle {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--brass);
        opacity: 0.7;
      }

      /* ===== FORM AREA - Open feel, carved into the room ===== */
      .form-area {
        position: relative;
        /* No full border - left accent only */
        border: none;
        border-left: 3px solid var(--brass);
        padding: 0 0 0 28px;
        /* Subtle inner shadow for depth */
        background: transparent;
      }

      /* Subtle glow on the left accent */
      .form-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: -3px;
        width: 3px;
        height: 100%;
        background: var(--brass);
        box-shadow: 0 0 20px rgba(212, 165, 116, 0.3);
        pointer-events: none;
      }

      /* ===== FORM STYLES ===== */
      .form-group {
        margin-bottom: 24px;
      }

      .form-label {
        display: block;
        font-family: "Bodoni Moda", serif;
        font-size: 0.85rem;
        font-weight: 400;
        color: var(--cream);
        margin-bottom: 8px;
        letter-spacing: 0.02em;
      }

      .form-input {
        width: 100%;
        padding: 12px 0;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.5);
        background: transparent;
        border: none;
        border-bottom: 1px solid rgba(212, 165, 116, 0.4);
        border-radius: 0;
        outline: none;
        transition: all 0.3s ease;
        -webkit-tap-highlight-color: transparent;
      }

      .form-input:focus {
        color: var(--cream);
        border-bottom-color: var(--brass);
      }

      .form-input::placeholder {
        color: rgba(255, 255, 255, 0.25);
        font-style: italic;
      }

      /* ===== SUBMIT BUTTON ===== */
      .submit-btn {
        width: 100%;
        padding: 16px 24px;
        margin-top: 8px;
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--ink);
        background: linear-gradient(
          180deg,
          var(--gold) 0%,
          var(--brass) 50%,
          var(--copper) 100%
        );
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow:
          0 4px 16px rgba(183, 106, 59, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
        -webkit-tap-highlight-color: transparent;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow:
          0 8px 24px rgba(183, 106, 59, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      .submit-btn:active {
        transform: translateY(0) scale(0.98);
      }

      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* ===== MESSAGES ===== */
      .message {
        text-align: center;
        padding: 14px 16px;
        margin-bottom: 20px;
        font-size: 0.8rem;
        letter-spacing: 0.02em;
        border: 1px solid;
      }

      .message--error {
        background: rgba(180, 60, 50, 0.1);
        border-color: rgba(180, 60, 50, 0.3);
        color: #e07a72;
      }

      /* ===== FOOTER ===== */
      .footer-link {
        display: block;
        text-align: center;
        margin-top: 28px;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--brass);
        text-decoration: none;
        opacity: 0.5;
        transition: opacity 0.3s ease;
      }

      .footer-link:hover {
        opacity: 0.8;
      }

      .back-link {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 32px;
        padding: 12px 20px;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        color: var(--brass);
        opacity: 0.6;
        text-decoration: none;
        transition: all 0.3s ease;
        border-radius: 8px;
      }

      .back-link:hover {
        opacity: 1;
        background: rgba(212, 165, 116, 0.08);
      }

      .back-link__arrow {
        font-size: 1.1rem;
        transition: transform 0.3s ease;
      }

      .back-link:hover .back-link__arrow {
        transform: translateX(-4px);
      }

      .back-link__text {
        font-style: italic;
      }

      .hidden {
        display: none !important;
      }

      /* ===== RESPONSIVE ===== */
      @media (max-width: 400px) {
        .form-area {
          padding-left: 20px;
        }

        .page-title {
          font-size: 1.4rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Atmospheric layers -->
    <div class="atmosphere"></div>
    <div class="grain"></div>
    <div class="vignette"></div>

    <div class="login-container">
      <div class="page-header">
        <div class="cdl-wordmark">
          <span class="cdl-wordmark__text">CDL</span>
          <span class="cdl-wordmark__line"></span>
        </div>
        <h1 class="page-title">La Oficina</h1>
        <p class="page-subtitle">Commissioner Access</p>
      </div>

      <div class="form-area">
        <div id="errorMessage" class="message message--error hidden"></div>

        <form id="loginForm">
          <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-input"
              placeholder="your@email.com"
              required
              autocomplete="email"
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              class="form-input"
              placeholder="••••••••"
              required
              autocomplete="current-password"
            />
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">
            Enter
          </button>
        </form>

        <a href="/admin/setup" class="footer-link">First time? Set up access</a>
      </div>

      <a href="/" class="back-link">
        <span class="back-link__arrow">←</span>
        <span class="back-link__text">Back to main site</span>
      </a>
    </div>

    <script define:vars={{ SUPABASE_URL, SUPABASE_ANON_KEY }}>
      async function initSupabase() {
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
        return createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }

      const form = document.getElementById('loginForm');
      const submitBtn = document.getElementById('submitBtn');
      const errorMessage = document.getElementById('errorMessage');

      function showError(text) {
        errorMessage.textContent = text;
        errorMessage.classList.remove('hidden');
      }

      function hideError() {
        errorMessage.classList.add('hidden');
      }

      // Check if user is already logged in
      (async () => {
        try {
          const supabase = await initSupabase();
          const { data: { session } } = await supabase.auth.getSession();

          if (session) {
            const { data: adminUser } = await supabase
              .from('admin_users')
              .select('id')
              .eq('email', session.user.email)
              .single();

            if (adminUser) {
              window.location.href = '/admin';
            }
          }
        } catch (err) {
          console.error('Session check error:', err);
        }
      })();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        const email = document.getElementById('email').value.trim().toLowerCase();
        const password = document.getElementById('password').value;

        if (!email || !password) return;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Entering...';

        try {
          const supabase = await initSupabase();

          // Check if this email is in admin_users
          const { data: adminUser, error: adminError } = await supabase
            .from('admin_users')
            .select('*')
            .eq('email', email)
            .single();

          if (!adminUser) {
            showError('Access denied. This email is not authorized.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Enter';
            return;
          }

          // Try to sign in
          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password
          });

          if (error) {
            if (error.message.includes('Invalid login credentials')) {
              showError('Incorrect password. Try again or claim your seat first.');
            } else {
              showError(error.message);
            }
            submitBtn.disabled = false;
            submitBtn.textContent = 'Enter';
            return;
          }

          // Update last login timestamp
          await supabase
            .from('admin_users')
            .update({ last_login: new Date().toISOString() })
            .eq('email', email);

          // Success - redirect to dashboard
          window.location.href = '/admin';

        } catch (err) {
          console.error('Login error:', err);
          showError('Something went wrong. Please try again.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enter';
        }
      });
    </script>
  </body>
</html>
