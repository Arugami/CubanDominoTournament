---
// Update this number manually when players sign up
const PLAYERS_REGISTERED = 0;
const PLAYERS_GOAL = 16; // 8 teams × 2 players

const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>La Salida | Cuban Domino League</title>
    <meta
      name="description"
      content="La Salida — The first Cuban Domino League tournament at Mr Garcia Cigars. January 31, 2025. $25 per player, 16 spots. Winner takes all."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:opsz,wght@6..96,400;6..96,700;6..96,800;6..96,900&family=IBM+Plex+Sans:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --ink: #1c130f;
        --muted: #594a3f;
        --copper: #b76a3b;
        --cream: #f8efe6;
        --bone: #fff7ef;
        --brass: #d4a574;
        --gold: #ffd700;
        --shadow: 0 18px 45px rgba(20, 10, 6, 0.18);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        overflow-x: hidden;
        max-width: 100vw;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        background: #0a0705;
        color: #fff;
      }

      /* Scroll Container */
      .story {
        height: 100vh;
        height: 100dvh; /* iOS Safari fix - uses actual visible viewport */
        overflow-x: hidden;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        overscroll-behavior: contain;
      }

      /* Panel Base */
      .panel {
        min-height: 100vh;
        min-height: 100dvh;
        height: 100vh;
        height: 100dvh;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 24px;
        overflow: hidden; /* Prevent horizontal scroll from parallax bg */
      }

      .panel-bg {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      /* Panel in view - no transform effects */
      .panel.in-view .panel-bg {
        /* Clean, stable backgrounds */
      }

      /* Hero "walking in" effect */
      .panel--hero {
        overflow: hidden;
      }

      .panel--hero .panel-bg {
        inset: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center center;
      }

      /* Hero overlay - HIDDEN to prevent flicker */
      .panel--hero .panel-overlay {
        display: none !important;
      }

      /* Combined overlay baked into ::before to prevent flicker */
      .panel--hero .panel-bg::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          /* Vertical gradient (was .panel-overlay) */
          linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.35) 0%,
            rgba(0, 0, 0, 0.55) 100%
          ),
          /* Side vignettes */
          linear-gradient(
            90deg,
            rgba(0, 0, 0, 0.7) 0%,
            rgba(0, 0, 0, 0.3) 15%,
            transparent 30%,
            transparent 70%,
            rgba(0, 0, 0, 0.3) 85%,
            rgba(0, 0, 0, 0.7) 100%
          );
        pointer-events: none;
        z-index: 1;
      }

      @media (max-width: 768px) {
        /* Smooth momentum scrolling on iOS */
        .story {
          -webkit-overflow-scrolling: touch;
          touch-action: pan-y;
          scroll-snap-type: y mandatory;
        }

        /* Disable parallax bg overhang on mobile for performance */
        .panel-bg {
          inset: 0;
          width: 100%;
          height: 100%;
        }

        /* Disable hero scroll transitions on mobile */
        .panel--hero .panel-bg {
          transition: none;
        }

        .panel--hero .panel-bg::before {
          background:
            /* Vertical gradient */
            linear-gradient(
              to bottom,
              rgba(0, 0, 0, 0.35) 0%,
              rgba(0, 0, 0, 0.55) 100%
            ),
            /* Side vignettes (lighter on mobile) */
            linear-gradient(
              90deg,
              rgba(0, 0, 0, 0.4) 0%,
              transparent 20%,
              transparent 80%,
              rgba(0, 0, 0, 0.4) 100%
            );
        }

        /* Use portrait-optimized hero on mobile */
        .panel-bg--hero {
          background-image: url('/FRAMES/frame-hero-mobile.webp') !important;
          background-position: center center;
        }
      }

      /* Vignette overlay - disabled to prevent flicker */
      .panel--hero::after {
        display: none;
      }

      /* Hero panel - disable ALL transitions to prevent flicker */
      .panel--hero,
      .panel--hero *,
      .panel--hero::before,
      .panel--hero::after {
        transition: none !important;
        animation-play-state: running; /* Keep intentional animations running */
      }

      /* Hero content always visible - no fade in */
      .panel--hero .panel-content {
        opacity: 1 !important;
        transform: none !important;
      }

      /* Isolate hero to reduce repaints (avoid forcing GPU on text) */
      .panel--hero {
        contain: layout style paint;
        isolation: isolate;
      }

      .panel--hero .panel-bg {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }

      /* Fade hero elements without transforms to avoid font flicker */
      @keyframes fadeInOnly {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .panel--hero .brand-lockup,
      .panel--hero .event-title,
      .panel--hero .hero-tagline,
      .panel--hero .hero-subtitle,
      .panel--hero .event-numeral {
        animation: fadeInOnly 0.9s ease-out both !important;
        transform: none !important;
      }

      /* Stagger the fade-in timing */
      .panel--hero .brand-lockup { animation-delay: 0.05s !important; }
      .panel--hero .event-title { animation-delay: 0.15s !important; }
      .panel--hero .event-numeral { animation-delay: 0.2s !important; }
      .panel--hero .hero-tagline { animation-delay: 0.25s !important; }
      .panel--hero .hero-subtitle { animation-delay: 0.35s !important; }

      /* Kill any ::after shine effects on hero text */
      .panel--hero .event-numeral::after {
        display: none !important;
      }


      .panel-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.35) 0%,
          rgba(0, 0, 0, 0.55) 100%
        );
      }

      .panel--form .panel-overlay {
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.6) 0%,
          rgba(0, 0, 0, 0.8) 100%
        );
      }

      /* Form panel gradient background */
      .panel-bg-gradient {
        position: absolute;
        inset: 0;
        background:
          radial-gradient(ellipse at 50% 0%, rgba(183, 106, 59, 0.15) 0%, transparent 50%),
          radial-gradient(ellipse at 80% 80%, rgba(212, 165, 116, 0.1) 0%, transparent 40%),
          linear-gradient(180deg, #0d0906 0%, #1a120d 50%, #0a0705 100%);
      }

      .panel-headline--form {
        font-size: clamp(2.2rem, 7vw, 3.5rem);
      }

      .panel-content {
        position: relative;
        z-index: 1;
        text-align: center;
        max-width: 900px;
        width: 100%;
        opacity: 0;
        transform: translateY(30px);
        transition:
          opacity 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94),
          transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      .panel.in-view .panel-content {
        opacity: 1;
        transform: translateY(0);
      }

      /* First panel starts visible */
      .panel:first-child .panel-content {
        opacity: 1;
        transform: translateY(0);
      }

      /* ========================================
         BRAND LOCKUP - Cuban Domino League
         ======================================== */
      .brand-lockup {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 24px;
        animation: fadeInDown 1s ease-out;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .brand-name {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(0.9rem, 2.5vw, 1.3rem);
        font-weight: 400;
        letter-spacing: 0.35em;
        text-transform: uppercase;
        color: var(--brass);
        text-shadow: 0 2px 10px rgba(212, 165, 116, 0.5);
        margin-bottom: 8px;
        position: relative;
        padding: 0 20px;
      }

      /* Decorative lines flanking brand name */
      .brand-name::before,
      .brand-name::after {
        content: "";
        position: absolute;
        top: 50%;
        width: 40px;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--brass), transparent);
      }

      .brand-name::before {
        right: 100%;
        margin-right: 8px;
      }

      .brand-name::after {
        left: 100%;
        margin-left: 8px;
      }

      .brand-presents {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(0.85rem, 2vw, 1.1rem);
        font-style: italic;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.6);
        letter-spacing: 0.15em;
        text-transform: lowercase;
      }

      /* Event Title - TOURNAMENT I */
      .event-title {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        margin-bottom: 24px;
        animation: fadeInUp 1s ease-out 0.3s both;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .event-name {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(2.2rem, 11vw, 8rem);
        font-weight: 900;
        font-optical-sizing: auto;
        line-height: 0.85;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.9),
          0 4px 20px rgba(0, 0, 0, 0.7),
          0 8px 40px rgba(0, 0, 0, 0.5);
      }

      @media (min-width: 768px) {
        .event-name {
          letter-spacing: 0.08em;
        }
      }

      .event-numeral {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(5rem, 25vw, 14rem);
        font-weight: 900;
        line-height: 0.75;
        color: var(--cream);
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.9),
          0 6px 20px rgba(0, 0, 0, 0.5),
          0 0 80px rgba(212, 165, 116, 0.2);
        position: relative;
      }

      /* La Salida specific styling */
      .event-numeral--salida {
        font-size: clamp(3rem, 16vw, 10rem);
        font-style: italic;
        font-weight: 700;
        letter-spacing: 0.02em;
        line-height: 0.9;
        -webkit-font-smoothing: antialiased;
        text-rendering: geometricPrecision;
      }

      .event-numeral--salida::after {
        content: none; /* Disable the "I" shine effect */
      }

      /* Metallic shine effect on numeral */
      .event-numeral::after {
        content: "I";
        position: absolute;
        left: 0;
        top: 0;
        background: linear-gradient(
          135deg,
          transparent 20%,
          rgba(255, 255, 255, 0.4) 40%,
          rgba(255, 255, 255, 0.4) 60%,
          transparent 80%
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 3s ease-in-out infinite;
      }

      @keyframes shine {
        0%, 100% { opacity: 0; }
        50% { opacity: 1; }
      }

      /* Hero tagline - "The First Cuban Domino League Championship" */
      .hero-tagline {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        font-size: clamp(0.7rem, 1.5vw, 0.85rem);
        font-weight: 500;
        color: var(--brass);
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        letter-spacing: 0.2em;
        text-transform: uppercase;
        margin-top: 20px;
        margin-bottom: 8px;
        opacity: 0.75;
        animation: fadeInUp 1s ease-out 0.5s both;
      }

      /* Hero subtitle adjustment */
      .hero-subtitle {
        font-size: clamp(0.8rem, 2vw, 1rem);
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        letter-spacing: 0.1em;
        text-transform: uppercase;
        animation: fadeInUp 1s ease-out 0.6s both;
      }

      .hero-subtitle .dot {
        color: var(--copper);
        margin: 0 12px;
      }

      .hero-subtitle a,
      .panel-subtitle a {
        color: inherit;
        text-decoration: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        transition: border-color 0.2s, color 0.2s;
      }

      .hero-subtitle a:hover,
      .panel-subtitle a:hover {
        color: var(--brass);
        border-bottom-color: var(--brass);
      }

      /* Typography - Bodoni Moda Black for vintage cigar lounge elegance */
      .panel-headline {
        font-family: "Bodoni Moda", "Didot", "Times New Roman", serif;
        font-size: clamp(2.2rem, 10vw, 6.5rem);
        font-weight: 900;
        font-optical-sizing: auto;
        line-height: 1.1;
        margin-bottom: 20px;
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.9),
          0 4px 20px rgba(0, 0, 0, 0.7),
          0 8px 40px rgba(0, 0, 0, 0.5);
        letter-spacing: 0.06em;
      }

      /* Panel 3 crescendo - extra tension */
      .panel:nth-child(3) .panel-headline {
        letter-spacing: 0.04em;
        font-size: clamp(2.4rem, 11vw, 7rem);
      }

      @media (min-width: 768px) {
        .panel-headline {
          font-size: clamp(3.2rem, 12vw, 6.5rem);
          letter-spacing: 0.08em;
        }

        .panel:nth-child(3) .panel-headline {
          letter-spacing: 0.06em;
          font-size: clamp(3.5rem, 13vw, 7rem);
        }
      }

      .nowrap {
        white-space: nowrap;
      }

      .panel-headline .accent {
        color: inherit;
        font-style: italic;
      }

      .panel-headline .accent--italic {
        font-family: "Bodoni Moda", "Didot", serif;
        font-weight: 400;
        font-style: italic;
      }

      .panel-subtitle {
        font-size: clamp(1.1rem, 3.5vw, 1.6rem);
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        text-shadow:
          0 2px 8px rgba(0, 0, 0, 0.8),
          0 4px 20px rgba(0, 0, 0, 0.5);
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .panel-subtitle--italic {
        font-family: "Bodoni Moda", "Didot", serif;
        font-style: italic;
        font-weight: 400;
        text-transform: none;
        letter-spacing: 0.02em;
      }

      /* Panel greeting - small Cuban welcome quote */
      .panel-greeting {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        font-style: italic;
        font-weight: 400;
        color: var(--brass);
        letter-spacing: 0.15em;
        margin-bottom: 1.5em;
        opacity: 0.9;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        animation: fadeInUp 0.8s ease-out 0.2s both;
      }

      /* Whisper subtitle - elegant italic like "presents" */
      .panel-whisper {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(1.2rem, 4vw, 2rem);
        font-style: italic;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.7);
        letter-spacing: 0.1em;
        margin-top: 0.5em;
        text-shadow:
          0 2px 8px rgba(0, 0, 0, 0.8),
          0 4px 20px rgba(0, 0, 0, 0.5);
      }

      .panel-subtitle--attitude {
        font-style: italic;
        text-transform: none;
        font-size: clamp(1.3rem, 4vw, 2rem);
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 12px;
        letter-spacing: 0.02em;
      }

      .panel-subtitle--details {
        font-size: clamp(0.9rem, 2.5vw, 1.2rem);
        margin-top: 8px;
      }

      .panel-subtitle .dot {
        color: var(--copper);
        margin: 0 10px;
      }

      /* Scroll Indicator */
      .scroll-indicator {
        position: absolute;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
        animation: bounce 2s infinite;
      }

      .scroll-indicator svg {
        width: 24px;
        height: 24px;
      }

      @keyframes bounce {
        0%, 100% { transform: translateX(-50%) translateY(0); }
        50% { transform: translateX(-50%) translateY(8px); }
      }

      /* Progress Tracker */
      .progress-tracker {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 20px 28px;
        margin-bottom: 28px;
        max-width: 400px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .progress-count {
        font-size: 1.1rem;
      }

      .progress-count .number {
        color: var(--brass);
        font-family: "Bodoni Moda", serif;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .progress-spots {
        color: var(--copper);
        font-size: 0.95rem;
      }

      .progress-bar {
        height: 10px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 99px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--copper), var(--brass));
        border-radius: 99px;
        transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
      }

      /* Shimmer effect on progress bar */
      .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s ease-in-out infinite;
        animation-delay: 1.5s;
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      .progress-cta {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        text-align: center;
      }

      /* Who's In Section */
      .whos-in {
        max-width: 400px;
        width: 100%;
        margin: 0 auto 20px;
        text-align: center;
      }

      .whos-in__title {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 12px;
      }

      .whos-in__list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }

      .whos-in__team {
        background: rgba(183, 106, 59, 0.15);
        border: 1px solid rgba(183, 106, 59, 0.3);
        border-radius: 12px;
        padding: 10px 14px;
        text-align: center;
        transition: all 0.2s ease;
      }

      .whos-in__team:hover {
        background: rgba(183, 106, 59, 0.25);
        transform: translateY(-2px);
      }

      .whos-in__team-name {
        font-family: "Bodoni Moda", serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--brass);
        margin-bottom: 2px;
      }

      .whos-in__players {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .whos-in__empty {
        color: rgba(255, 255, 255, 0.4);
        font-style: italic;
        font-size: 0.9rem;
      }

      /* Individual Player Display */
      .whos-in__player {
        background: rgba(183, 106, 59, 0.12);
        border: 1px solid rgba(183, 106, 59, 0.25);
        border-radius: 20px;
        padding: 8px 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
      }

      .whos-in__player:hover {
        background: rgba(183, 106, 59, 0.2);
        transform: translateY(-1px);
      }

      .whos-in__player-name {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--cream);
      }

      .whos-in__player-badge {
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--copper);
        background: rgba(183, 106, 59, 0.2);
        border-radius: 4px;
        padding: 2px 6px;
      }

      /* Chat Widget - The Sacred Table (Amber Glass & Brass) */
      .chat-widget {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
        font-family: "IBM Plex Sans", sans-serif;
        filter: drop-shadow(0 20px 40px rgba(10, 5, 2, 0.6));
      }

      /* Toggle Button - The Seal */
      .chat-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(28, 19, 15, 0.95);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        color: var(--brass);
        border: 1px solid var(--muted);
        border-radius: 2px;
        padding: 12px 24px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        position: relative;
        overflow: hidden;
      }

      /* Double border effect for menu/sacred feel */
      .chat-toggle::before {
        content: '';
        position: absolute;
        inset: 3px;
        border: 1px solid rgba(212, 165, 116, 0.3); /* Low opacity brass */
        pointer-events: none;
      }

      .chat-toggle:hover {
        transform: translateY(-2px);
        border-color: var(--brass);
        background: rgba(40, 25, 20, 0.98);
        box-shadow: 0 8px 30px rgba(212, 165, 116, 0.15); /* Warm glow */
      }

      .chat-toggle__text {
        font-family: "Bodoni Moda", serif;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        font-size: 0.85rem;
        font-weight: 600;
        position: relative;
        top: 1px;
        color: var(--brass);
      }

      .chat-toggle__icon {
        width: 8px;
        height: 8px;
        background: var(--brass);
        border-radius: 50%;
        box-shadow: 0 0 10px var(--brass);
        animation: soulPulse 4s infinite;
      }

      @keyframes soulPulse {
        0%, 100% { opacity: 0.6; box-shadow: 0 0 5px var(--brass); }
        50% { opacity: 1; box-shadow: 0 0 15px var(--brass), 0 0 30px rgba(212, 165, 116, 0.4); }
      }

      .chat-toggle__badge {
        background: var(--copper);
        color: #fff;
        font-family: "Bodoni Moda", serif;
        font-size: 0.75rem;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-left: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      }

      /* Chat Panel - The Vessel */
      .chat-panel {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 360px;
        height: 520px;
        background: rgba(20, 14, 11, 0.92); /* Deep Tobacco */
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--muted);
        display: none;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 
          0 20px 50px rgba(0,0,0,0.8),
          inset 0 0 100px rgba(0,0,0,0.5); /* Inner vignette */
        transform-origin: bottom center;
        border-radius: 2px;
      }

      /* Inner Gold Border */
      .chat-panel::after {
        content: "";
        position: absolute;
        inset: 4px;
        border: 1px solid rgba(212, 165, 116, 0.2);
        pointer-events: none;
        z-index: 10;
      }

      .chat-panel.is-open {
        display: flex;
        animation: ritualOpen 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      }

      @keyframes ritualOpen {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Header - The Inscription */
      .chat-header {
        display: flex;
        justify-content: center; /* Symmetry */
        align-items: center;
        padding: 24px 24px 16px;
        position: relative;
        border-bottom: 1px solid rgba(212, 165, 116, 0.1);
      }

      .chat-header__title {
        font-family: "Bodoni Moda", serif;
        font-weight: 700;
        font-size: 1rem;
        color: var(--brass);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        position: relative;
      }
      
      /* Fancy underlines/accents */
      .chat-header__title::after {
        content: "";
        display: block;
        width: 24px;
        height: 1px;
        background: var(--copper);
        margin: 8px auto 0;
        opacity: 0.6;
      }

      .chat-header__close {
        position: absolute;
        right: 16px;
        top: 16px;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        cursor: pointer;
        font-family: "Bodoni Moda", serif;
        font-size: 1.5rem;
        line-height: 1;
        transition: color 0.3s;
        z-index: 20;
      }
      .chat-header__close:hover { color: var(--brass); }

      /* Content Area */
      .chat-body-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scrollbar-width: thin;
        scrollbar-color: var(--muted) transparent;
      }
      
      .chat-messages::-webkit-scrollbar { width: 4px; }
      .chat-messages::-webkit-scrollbar-track { background: transparent; }
      .chat-messages::-webkit-scrollbar-thumb { background: var(--muted); }

      /* Message Styling - The Script */
      .chat-message {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        animation: fadeUp 0.4s ease-out;
      }
      
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .chat-message__avatar {
        width: 32px;
        height: 32px;
        flex-shrink: 0;
        border-radius: 50%;
        border: 1px solid var(--brass);
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.3);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      }
      
      /* Simple Icon placeholders - SVG driven usually, using CSS shapes for now or minimal content */
      .avatar-option-img {
         width: 16px;
         height: 16px;
         background-size: contain;
      }

      /* Pixel Flag Emoji Styling - retro game aesthetic */
      .avatar-flag-pixel {
        font-size: 24px;
        line-height: 1;
        display: block;
        text-align: center;
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        /* Pixel art effect - sharper, more contrast */
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        filter: contrast(1.15) saturate(1.3) drop-shadow(0 2px 4px rgba(0,0,0,0.4));
        transition: transform 0.15s ease;
      }

      .avatar-option:hover .avatar-flag-pixel {
        transform: scale(1.15);
      }

      .avatar-option.selected .avatar-flag-pixel {
        filter: contrast(1.2) saturate(1.4) drop-shadow(0 0 8px rgba(255,215,0,0.4));
      }

      /* --- RITUAL ICONS (Legacy Flag Support) --- */
      .avatar-flag {
        font-size: 20px;
        line-height: 1;
        display: block;
        text-align: center;
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      }

      /* --- Identity Screen --- */
      .chat-identity {
        padding: 40px 30px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-y: auto;
      }

      .chat-message__content-wrapper {
        flex: 1;
        min-width: 0;
      }

      .chat-message__header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .chat-message__author {
        font-family: "Bodoni Moda", serif;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Free Agent Badge */
      .free-agent-badge {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--copper);
        background: rgba(183, 106, 59, 0.15);
        border: 1px solid rgba(183, 106, 59, 0.3);
        border-radius: 4px;
        padding: 2px 6px;
        white-space: nowrap;
      }

      .chat-message__author-name {
        font-family: "Bodoni Moda", serif;
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--brass); /* Default Gold/Brass */
        letter-spacing: 0.05em;
      }
      
      /* Self is highlighted in Gold/Ochún */
      .chat-message--self .chat-message__author { 
        color: var(--gold); 
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
      }
      
      /* Others in Copper */
      .chat-message:not(.chat-message--self) .chat-message__author {
        color: var(--copper);
      }

      .chat-message__time {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.3);
        letter-spacing: 0.05em;
      }

      .chat-message__content {
        color: rgba(248, 239, 230, 0.9); /* Cream */
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.9rem;
        line-height: 1.5;
        font-weight: 300;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      }

      /* Reactions */
      .chat-message__reactions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
        align-items: center;
      }

      .reaction-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: all 0.2s;
      }
      .reaction-chip:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }
      .reaction-chip--active {
        background: rgba(212, 165, 116, 0.2);
        border-color: var(--brass);
        color: var(--brass);
      }

      .reaction-add {
        width: 24px;
        height: 24px;
        padding: 0;
        background: transparent;
        border: 1px dashed rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.3);
        cursor: pointer;
        font-size: 0.85rem;
        line-height: 1;
        transition: all 0.2s;
        opacity: 0;
      }
      .chat-message:hover .reaction-add {
        opacity: 1;
      }
      .reaction-add:hover {
        border-color: var(--brass);
        color: var(--brass);
        background: rgba(212, 165, 116, 0.1);
      }

      /* Reaction Picker */
      .reaction-picker {
        position: fixed;
        display: none;
        gap: 4px;
        padding: 8px 12px;
        background: rgba(28, 19, 15, 0.98);
        border: 1px solid rgba(212, 165, 116, 0.3);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .reaction-picker.is-open {
        display: flex;
      }
      .reaction-picker button {
        width: 32px;
        height: 32px;
        padding: 0;
        background: transparent;
        border: none;
        border-radius: 4px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.15s;
      }
      .reaction-picker button:hover {
        background: rgba(212, 165, 116, 0.2);
        transform: scale(1.2);
      }

      /* Pinned Messages */
      .chat-message--pinned {
        background: rgba(212, 165, 116, 0.08);
        border-left: 2px solid var(--brass);
        margin-left: -8px;
        padding-left: 8px;
        position: relative;
      }
      .pinned-badge {
        position: absolute;
        top: -8px;
        right: 8px;
        font-size: 0.65rem;
        color: var(--brass);
        background: rgba(28, 19, 15, 0.95);
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid rgba(212, 165, 116, 0.3);
      }

      /* Pin Button */
      .chat-message__header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .pin-btn {
        background: transparent;
        border: none;
        font-size: 0.7rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s, transform 0.2s;
        padding: 2px;
        filter: grayscale(1);
      }
      .chat-message:hover .pin-btn {
        opacity: 0.5;
      }
      .pin-btn:hover {
        opacity: 1 !important;
        transform: scale(1.2);
        filter: grayscale(0);
      }
      .pin-btn--active {
        opacity: 1 !important;
        filter: grayscale(0);
      }

      /* Pinned Section */
      .pinned-section {
        background: rgba(212, 165, 116, 0.05);
        border-bottom: 1px solid rgba(212, 165, 116, 0.15);
        padding-bottom: 16px;
        margin-bottom: 16px;
      }
      .pinned-section__label {
        font-family: "Bodoni Moda", serif;
        font-size: 0.7rem;
        color: var(--brass);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        padding: 8px 16px;
        opacity: 0.7;
      }

      .chat-empty {
        text-align: center;
        color: rgba(255, 255, 255, 0.3);
        margin-top: 40px;
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-size: 0.9rem;
        letter-spacing: 0.05em;
      }

      /* Input Area - The Ledger */
      .chat-input-area {
        padding: 20px;
        display: flex;
        gap: 16px;
        border-top: 1px solid rgba(212, 165, 116, 0.1);
        background: rgba(0, 0, 0, 0.2);
      }

      .chat-input {
        flex: 1;
        background: transparent;
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding: 8px 0;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.3s;
        border-radius: 0;
      }

      .chat-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
        font-style: italic;
      }

      .chat-input:focus {
        border-color: var(--brass);
      }

      .chat-send {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: transparent;
        border: 1px solid var(--brass);
        color: var(--brass);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .chat-send svg { 
        width: 16px; height: 16px; 
        fill: currentColor;
        stroke: none;
      }

      .chat-send:not(:disabled):hover {
        background: var(--brass);
        color: #000;
        box-shadow: 0 0 15px rgba(212, 165, 116, 0.4);
      }
      
      .chat-send:disabled {
        border-color: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
      }

      /* Identity Screen - The Initiation */
      .chat-identity {
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        text-align: center;
        justify-content: center;
      }
      
      .identity-header {
        font-family: "Bodoni Moda", serif;
        font-size: 0.85rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--copper);
        margin-bottom: 30px;
        opacity: 0.8;
      }

      .chat-identity__title {
        font-family: "Bodoni Moda", serif;
        font-size: 1.8rem;
        color: var(--brass);
        margin-bottom: 8px;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-shadow: 0 4px 20px rgba(0,0,0,0.5);
      }
      
      .chat-identity__subtitle {
        color: rgba(255, 255, 255, 0.6);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.9rem;
        font-weight: 300;
        margin-bottom: 40px;
      }

      .avatar-selector {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        margin-bottom: 32px;
        max-width: 280px;
        margin-left: auto;
        margin-right: auto;
      }
      
      .avatar-option {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }
      
      .avatar-option:hover { 
        transform: scale(1.1);
        border-color: var(--cream);
      }
      
      .avatar-option.selected {
        border-color: var(--gold);
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.15);
        background: rgba(255, 215, 0, 0.05);
      }
      
      .avatar-option::after {
        /* Glow dot instead of checkmark */
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%) scale(0);
        width: 4px; height: 4px;
        background: var(--gold);
        border-radius: 50%;
        transition: transform 0.3s;
      }
      
      .avatar-option.selected::after {
        transform: translateX(-50%) scale(1);
      }
      
      .avatar-option .check-mark { display: none; } /* Hide old checkmark */

      .chat-identity__select {
        width: 100%;
        margin-bottom: 16px;
        background: rgba(0, 0, 0, 0.3);
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--cream);
        padding: 12px 0;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 1rem;
        outline: none;
        text-align: center;
        text-align-last: center;
        border-radius: 0;
        -webkit-appearance: none;
        cursor: pointer;
      }
      
      .chat-identity__select:focus {
        border-bottom-color: var(--brass);
      }
      
      .chat-identity__btn {
        margin-top: 24px;
        background: transparent;
        border: 1px solid var(--brass);
        color: var(--brass);
        padding: 14px 32px;
        font-family: "Bodoni Moda", serif;
        font-size: 0.9rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .chat-identity__btn:not(:disabled):hover {
        background: var(--brass);
        color: #0d0906; /* Dark ink */
        box-shadow: 0 0 20px rgba(212, 165, 116, 0.3);
      }
      
      .chat-identity__btn:disabled {
        border-color: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
      }

      .chat-identity__register-hint {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
        margin-top: 12px;
        font-family: "IBM Plex Sans", sans-serif;
      }

      .chat-identity__register-link {
        color: var(--brass);
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.2s;
      }

      .chat-identity__register-link:hover {
        border-bottom-color: var(--brass);
      }

      /* Mobile */
      @media (max-width: 768px) {
        .chat-widget {
          bottom: 16px;
          right: 16px;
          left: 16px; /* Centered button area */
          display: flex;
          justify-content: flex-end; /* Or center if preferred, keeping right for thumb */
        }

        /* Make toggle bigger / easier to tap */
        .chat-toggle {
          padding: 14px 28px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }

        .chat-panel {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          width: 100%;
          height: 92dvh; /* Use dynamic viewport height for mobile browsers */
          border-radius: 20px 20px 0 0;
          border-bottom: none;
          box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
        }
        
        .chat-panel.is-open {
          animation: slideUpMobile 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes slideUpMobile {
          from { transform: translateY(100%); }
          to { transform: translateY(0); }
        }
        
        .chat-header {
           padding: 16px 20px; /* Tighter padding */
           min-height: 60px;
        }
        
        .chat-header__title {
           font-size: 0.9rem;
        }

        /* Adjust input area for safe areas (iPhone Home Bar) */
        .chat-input-area {
          padding: 16px 20px max(16px, env(safe-area-inset-bottom));
          background: rgba(20, 14, 11, 0.95); /* Opaque background behind input */
        }
        
        .chat-send {
          width: 44px; height: 44px; /* Larger tap target */
        }
      }

      /* Form Panel */
      .panel--form {
        min-height: 100vh;
        min-height: 100dvh;
        height: auto;
        padding: 60px 24px 100px;
        align-items: center;
        justify-content: flex-start;
        padding-top: 80px;
      }

      /* Form panel content always visible (no fade-in animation) */
      .panel--form .panel-content {
        opacity: 1;
        transform: none;
      }

      .panel--form .panel-headline {
        font-size: clamp(2.6rem, 9vw, 4.5rem);
        margin-bottom: 12px;
      }

      .panel--form .panel-subtitle {
        margin-bottom: 24px;
      }

      /* ========================================
         RULES PANEL - CDL:1 La Salida
         ======================================== */
      .panel--rules {
        background: linear-gradient(
          180deg,
          #0d0906 0%,
          #1a120d 40%,
          #0d0906 100%
        );
      }

      .panel--rules .panel-content {
        max-width: 700px;
      }

      .rules-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .rules-header__event {
        font-family: "Bodoni Moda", serif;
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        letter-spacing: 0.3em;
        text-transform: uppercase;
        color: var(--brass);
        margin-bottom: 8px;
      }

      .rules-header__title {
        font-family: "Bodoni Moda", serif;
        font-size: clamp(2.5rem, 8vw, 4rem);
        font-weight: 700;
        font-style: italic;
        color: var(--brass);
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.5),
          0 4px 16px rgba(183, 106, 59, 0.25);
        margin-bottom: 4px;
      }

      .rules-header__subtitle {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.5);
        letter-spacing: 0.15em;
        text-transform: uppercase;
      }

      .rules-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 32px;
      }

      .rule-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(183, 106, 59, 0.2);
        border-radius: 16px;
        padding: 20px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
      }

      .rule-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(183, 106, 59, 0.4);
        transform: translateY(-2px);
      }

      .rule-card__icon {
        font-size: 1.8rem;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(183, 106, 59, 0.1);
        border-radius: 12px;
        flex-shrink: 0;
      }

      .rule-card__content {
        flex: 1;
      }

      .rule-card__title {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: var(--cream);
        margin-bottom: 2px;
      }

      .rule-card__desc {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.5);
      }

      .rules-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin: 32px 0;
      }

      .rules-divider::before,
      .rules-divider::after {
        content: '';
        height: 1px;
        width: 60px;
        background: linear-gradient(90deg, transparent, var(--copper), transparent);
      }

      .rules-divider__domino {
        font-size: 1.5rem;
        opacity: 0.6;
      }

      .rules-footer {
        text-align: center;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
      }

      .rules-footer__emphasis {
        color: var(--brass);
        font-weight: 600;
      }

      @media (min-width: 600px) {
        .rules-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* Mobile rules panel - tighter spacing for iOS viewport */
      @media (max-width: 599px) {
        .panel--rules {
          padding: 16px;
        }

        .rules-header {
          margin-bottom: 20px;
        }

        .rules-header__title {
          font-size: clamp(2rem, 7vw, 3rem);
        }

        .rules-grid {
          gap: 10px;
          margin-bottom: 16px;
        }

        .rule-card {
          padding: 14px 16px;
          gap: 12px;
          border-radius: 12px;
        }

        .rule-card__icon {
          width: 40px;
          height: 40px;
          font-size: 1.4rem;
          border-radius: 10px;
        }

        .rule-card__title {
          font-size: 0.9rem;
        }

        .rule-card__desc {
          font-size: 0.75rem;
        }

        .rules-footer {
          font-size: 0.8rem;
        }
      }

      /* Form Shell */
      .form-shell {
        background: rgba(255, 255, 255, 0.06);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        padding: 28px;
        max-width: 520px;
        width: 100%;
        margin: 0 auto;
      }

      .form-intro {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .form-intro p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.95rem;
        margin-bottom: 12px;
      }

      .form-intro ul {
        list-style: none;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 16px;
        margin-top: 14px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .form-intro li {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .form-intro li::before {
        content: "◆";
        color: var(--copper);
        font-size: 0.6rem;
      }

      form {
        display: grid;
        gap: 16px;
      }

      label {
        display: grid;
        gap: 6px;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
      }

      input,
      textarea {
        padding: 14px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        font: inherit;
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
        transition: border-color 0.2s, background 0.2s;
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--copper);
        background: rgba(255, 255, 255, 0.12);
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(255, 255, 255, 0.35);
      }

      textarea {
        min-height: 80px;
        resize: vertical;
      }

      .players {
        display: grid;
        gap: 12px;
        padding: 16px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(183, 106, 59, 0.25);
      }

      .players h4 {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--brass);
        margin-bottom: 4px;
      }

      .checkbox {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
      }

      .checkbox input {
        margin-top: 3px;
        width: 18px;
        height: 18px;
        accent-color: var(--copper);
      }

      button[type="submit"] {
        border: none;
        border-radius: 999px;
        padding: 18px 36px;
        font-weight: 700;
        font-size: 1.15rem;
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        background: linear-gradient(135deg, var(--copper), #8f3c22);
        color: #fff;
        cursor: pointer;
        box-shadow:
          0 4px 15px rgba(143, 60, 34, 0.5),
          0 12px 35px rgba(143, 60, 34, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
        transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s ease;
        margin-top: 12px;
        position: relative;
        overflow: hidden;
      }

      button[type="submit"]::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s ease;
      }

      button[type="submit"]:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow:
          0 6px 20px rgba(143, 60, 34, 0.6),
          0 16px 45px rgba(143, 60, 34, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      button[type="submit"]:hover::before {
        left: 100%;
      }

      button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: progress;
        transform: none;
      }

      .status {
        min-height: 24px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        font-size: 0.95rem;
      }

      /* Success Celebration State - Full viewport takeover */
      .success {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: radial-gradient(ellipse at center top, rgba(30, 20, 15, 0.98) 0%, rgba(10, 7, 5, 0.99) 100%);
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px 24px;
        overflow-y: auto;
      }

      .success.is-visible {
        display: flex;
        animation: successReveal 0.5s ease-out;
      }

      @keyframes successReveal {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Domino Hero */
      .domino-container {
        position: relative;
        margin-bottom: 40px;
        perspective: 1000px;
      }

      .domino {
        width: 90px;
        height: 180px;
        background: linear-gradient(165deg, #fefefe 0%, #f5f0eb 40%, #e8e2db 100%);
        border-radius: 14px;
        margin: 0 auto;
        position: relative;
        box-shadow:
          0 25px 50px rgba(0, 0, 0, 0.6),
          0 0 80px rgba(212, 165, 116, 0.3),
          0 0 120px rgba(255, 215, 0, 0.1),
          inset 0 2px 0 rgba(255, 255, 255, 0.8);
        animation: dominoSlam 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
      }

      @keyframes dominoSlam {
        0% { transform: rotateX(-90deg) translateY(-40px); opacity: 0; }
        60% { transform: rotateX(10deg); }
        100% { transform: rotateX(0deg) translateY(0); opacity: 1; }
      }

      .domino::before {
        content: '';
        position: absolute;
        left: 10%;
        right: 10%;
        top: 50%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--copper), transparent);
        border-radius: 2px;
        transform: translateY(-50%);
      }

      .domino::after {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 14px;
        background: radial-gradient(ellipse at center, rgba(212, 165, 116, 0.3) 0%, transparent 70%);
        animation: glowPulse 2s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes glowPulse {
        0%, 100% { opacity: 0.5; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.05); }
      }

      .domino-top, .domino-bottom {
        position: absolute;
        left: 0;
        right: 0;
        height: 50%;
      }

      .domino-top { top: 0; }
      .domino-bottom { bottom: 0; }

      .pip {
        position: absolute;
        width: 16px;
        height: 16px;
        background: radial-gradient(circle at 30% 30%, var(--copper), #2a1810);
        border-radius: 50%;
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.5),
          0 1px 2px rgba(0, 0, 0, 0.2);
      }

      /* Double six pip positions - top half (90x180 domino) */
      .domino-top .pip:nth-child(1) { top: 14px; left: 16px; }
      .domino-top .pip:nth-child(2) { top: 14px; right: 16px; }
      .domino-top .pip:nth-child(3) { top: 50%; left: 16px; transform: translateY(-50%); }
      .domino-top .pip:nth-child(4) { top: 50%; right: 16px; transform: translateY(-50%); }
      .domino-top .pip:nth-child(5) { bottom: 18px; left: 16px; }
      .domino-top .pip:nth-child(6) { bottom: 18px; right: 16px; }

      /* Double six pip positions - bottom half */
      .domino-bottom .pip:nth-child(1) { top: 14px; left: 16px; }
      .domino-bottom .pip:nth-child(2) { top: 14px; right: 16px; }
      .domino-bottom .pip:nth-child(3) { top: 50%; left: 16px; transform: translateY(-50%); }
      .domino-bottom .pip:nth-child(4) { top: 50%; right: 16px; transform: translateY(-50%); }
      .domino-bottom .pip:nth-child(5) { bottom: 14px; left: 16px; }
      .domino-bottom .pip:nth-child(6) { bottom: 14px; right: 16px; }

      /* Shimmer particles */
      .shimmer {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--gold);
        border-radius: 50%;
        animation: shimmerFloat 3s ease-in-out infinite;
        opacity: 0;
      }

      .shimmer:nth-child(1) { left: 20%; top: 20%; animation-delay: 0s; }
      .shimmer:nth-child(2) { left: 80%; top: 30%; animation-delay: 0.5s; }
      .shimmer:nth-child(3) { left: 10%; top: 60%; animation-delay: 1s; }
      .shimmer:nth-child(4) { left: 90%; top: 70%; animation-delay: 1.5s; }
      .shimmer:nth-child(5) { left: 50%; top: 10%; animation-delay: 2s; }

      @keyframes shimmerFloat {
        0%, 100% { opacity: 0; transform: translateY(0) scale(0.5); }
        50% { opacity: 1; transform: translateY(-10px) scale(1); }
      }

      /* Success Headlines */
      .success-headline {
        font-family: "Bodoni Moda", serif;
        font-size: clamp(3rem, 12vw, 4.5rem);
        font-weight: 700;
        color: var(--cream);
        letter-spacing: 0.02em;
        margin-bottom: 12px;
        animation: fadeUp 0.6s ease-out 0.4s both;
        line-height: 1.1;
      }

      .success-headline span {
        color: var(--brass);
        display: inline-block;
        text-shadow:
          0 0 30px rgba(212, 165, 116, 0.5),
          0 0 60px rgba(183, 106, 59, 0.3);
        animation: brassShine 3s ease-in-out infinite;
      }

      @keyframes brassShine {
        0%, 100% {
          text-shadow: 0 0 30px rgba(212, 165, 116, 0.5), 0 0 60px rgba(183, 106, 59, 0.3);
          filter: brightness(1);
        }
        50% {
          text-shadow: 0 0 50px rgba(212, 165, 116, 0.7), 0 0 100px rgba(183, 106, 59, 0.4);
          filter: brightness(1.1);
        }
      }

      .success-subheadline {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 36px;
        animation: fadeUp 0.6s ease-out 0.5s both;
        letter-spacing: 0.03em;
      }

      /* Event Details Card */
      .event-details {
        background: linear-gradient(135deg, rgba(183, 106, 59, 0.15) 0%, rgba(183, 106, 59, 0.05) 100%);
        border: 1px solid rgba(212, 165, 116, 0.3);
        border-radius: 20px;
        padding: 28px 40px;
        margin-bottom: 32px;
        position: relative;
        overflow: hidden;
        animation: fadeUp 0.6s ease-out 0.6s both;
        width: 100%;
        max-width: 320px;
      }

      .event-details::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.1), transparent);
        animation: cardShine 4s ease-in-out infinite;
      }

      @keyframes cardShine {
        0% { left: -100%; }
        50%, 100% { left: 200%; }
      }

      .event-date {
        font-family: "Bodoni Moda", serif;
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--brass);
        margin-bottom: 8px;
        letter-spacing: 0.02em;
      }

      .event-venue {
        font-size: 1.15rem;
        color: var(--cream);
        margin-bottom: 6px;
        font-weight: 500;
        letter-spacing: 0.01em;
      }

      .event-time {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.6);
        letter-spacing: 0.02em;
      }

      /* Divider */
      .success-divider {
        display: flex;
        align-items: center;
        gap: 20px;
        margin: 28px 0;
        width: 100%;
        max-width: 240px;
        animation: fadeUp 0.6s ease-out 0.7s both;
      }

      .success-divider::before,
      .success-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.5), transparent);
      }

      .divider-pip {
        width: 10px;
        height: 10px;
        background: radial-gradient(circle at 30% 30%, var(--brass), var(--copper));
        border-radius: 50%;
        box-shadow: 0 0 12px rgba(212, 165, 116, 0.4);
      }

      /* Tagline */
      .success-tagline {
        font-family: "Bodoni Moda", serif;
        font-size: 1.4rem;
        font-style: italic;
        color: var(--brass);
        opacity: 0.9;
        animation: fadeUp 0.6s ease-out 0.8s both;
        letter-spacing: 0.02em;
      }

      /* Email reminder */
      .email-reminder {
        margin-top: 40px;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.45);
        animation: fadeUp 0.6s ease-out 0.9s both;
      }

      .email-reminder a {
        color: rgba(212, 165, 116, 0.7);
        text-decoration: none;
        transition: color 0.2s ease;
        border-bottom: 1px solid rgba(212, 165, 116, 0.3);
        padding-bottom: 2px;
      }

      .email-reminder a:hover {
        color: var(--brass);
        border-bottom-color: var(--brass);
      }

      /* Footer */
      .footer-note {
        margin-top: 28px;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.85rem;
        text-align: center;
      }

      .footer-note a {
        color: var(--brass);
        text-decoration: none;
      }

      /* Responsive */
      @media (max-width: 640px) {
        .panel {
          padding: 20px 16px;
        }

        .form-shell {
          padding: 22px 18px;
        }

        .players {
          padding: 14px;
        }

        .progress-tracker {
          padding: 16px 20px;
        }

        .panel--form {
          padding-top: 60px;
        }
      }

      /* Hide honeypot */
      .honeypot {
        position: absolute;
        left: -9999px;
      }

      /* Floating Music Toggle */
      .music-toggle {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(28, 19, 15, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(183, 106, 59, 0.4);
        border-radius: 50px;
        padding: 12px 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 13px;
        color: #d4a574;
      }

      .music-toggle:hover {
        background: rgba(28, 19, 15, 1);
        border-color: rgba(183, 106, 59, 0.7);
        transform: scale(1.02);
      }

      .music-toggle:active,
      .music-toggle:focus {
        transform: scale(0.95);
        background: rgba(28, 19, 15, 1);
      }

      /* Hide music toggle on mobile */
      @media (max-width: 768px) {
        .music-toggle {
          display: none !important;
        }
      }

      .music-toggle__icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .music-toggle__label {
        white-space: nowrap;
      }

      /* Playing state */
      .music-toggle.is-playing {
        border-color: #b76a3b;
        box-shadow: 0 0 20px rgba(183, 106, 59, 0.3);
      }

      .music-toggle.is-playing .music-toggle__icon {
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Sound wave bars animation */
      .sound-bars {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 16px;
      }

      .sound-bars span {
        display: block;
        width: 3px;
        background: #d4a574;
        border-radius: 2px;
        animation: soundBar 0.8s ease-in-out infinite;
      }

      .sound-bars span:nth-child(1) { height: 40%; animation-delay: 0s; }
      .sound-bars span:nth-child(2) { height: 70%; animation-delay: 0.15s; }
      .sound-bars span:nth-child(3) { height: 50%; animation-delay: 0.3s; }
      .sound-bars span:nth-child(4) { height: 80%; animation-delay: 0.45s; }

      @keyframes soundBar {
        0%, 100% { transform: scaleY(1); }
        50% { transform: scaleY(0.5); }
      }

      .music-toggle:not(.is-playing) .sound-bars span {
        animation: none;
        height: 30%;
      }

      /* Collapse label after first tap */
      .music-toggle.collapsed {
        padding: 12px;
      }

      .music-toggle.collapsed .music-toggle__label {
        display: none;
      }

      @media (max-width: 768px) {
        .music-toggle {
          top: 16px;
          right: 16px;
          padding: 10px 14px;
          font-size: 12px;
          transition: opacity 0.3s ease, transform 0.3s ease;
        }

      }

      /* ========================================
         BRAND FOOTER
         ======================================== */
      .brand-footer {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin-top: 48px;
        padding-top: 32px;
        border-top: 1px solid rgba(183, 106, 59, 0.2);
      }

      .brand-footer__logo {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: 1.8rem;
        font-weight: 900;
        letter-spacing: 0.15em;
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
      }

      /* Decorative dots around logo */
      .brand-footer__logo::before,
      .brand-footer__logo::after {
        content: "◆";
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.4rem;
        color: var(--copper);
        -webkit-text-fill-color: var(--copper);
      }

      .brand-footer__logo::before {
        right: calc(100% + 12px);
      }

      .brand-footer__logo::after {
        left: calc(100% + 12px);
      }

      .brand-footer__text {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.4);
        letter-spacing: 0.05em;
      }

      .brand-footer__tagline {
        font-family: "Bodoni Moda", "Didot", serif;
        font-style: italic;
        font-size: 0.95rem;
        color: rgba(212, 165, 116, 0.6);
        letter-spacing: 0.08em;
      }

      @media (max-width: 640px) {
        .brand-footer {
          margin-top: 36px;
          padding-top: 24px;
        }
      }
    </style>
  </head>
  <body>
    <main class="story">
      <!-- Panel 1: Brand Introduction -->
      <section class="panel panel--hero" id="heroPanel">
        <div class="panel-bg panel-bg--hero" style="background-image: url('/FRAMES/frame-hero.webp')"></div>
        <div class="panel-overlay"></div>
        <div class="panel-content">
          <div class="brand-lockup">
            <span class="brand-name">Cuban Domino League</span>
            <span class="brand-presents">presents</span>
          </div>
          <h1 class="event-title">
            <span class="event-numeral event-numeral--salida">La Salida</span>
          </h1>
          <p class="hero-tagline">The First Cuban Domino League Championship</p>
          <p class="hero-subtitle">January 31, 2025<span class="dot">•</span><a href="https://mrgarciacigars.com/" target="_blank" rel="noreferrer">Mr Garcia Cigars</a></p>
        </div>
        <div class="scroll-indicator">
          <span>Enter</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
          </svg>
        </div>
      </section>

      <!-- Panel 2: The Welcome -->
      <section class="panel">
        <div class="panel-bg" style="background-image: url('/FRAMES/frame-2.webp')"></div>
        <div class="panel-overlay"></div>
        <div class="panel-content">
          <h2 class="panel-headline"><span class="accent">We</span> have been<br>expecting you</h2>
        </div>
      </section>

      <!-- Panel 3: The Call -->
      <section class="panel">
        <div class="panel-bg" style="background-image: url('/FRAMES/frame-3.webp')"></div>
        <div class="panel-overlay"></div>
        <div class="panel-content">
          <h2 class="panel-headline"><span class="accent">We've</span> watched you train</h2>
          <p class="panel-whisper">It's finally time</p>
        </div>
      </section>

      <!-- Panel 4: Winner Takes All -->
      <section class="panel">
        <div class="panel-bg" style="background-image: url('/FRAMES/frame-4.webp')"></div>
        <div class="panel-overlay"></div>
        <div class="panel-content">
          <h2 class="panel-headline">Winner <span class="accent">Takes All</span></h2>
        </div>
        <div class="scroll-indicator">
          <span>Rules</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
          </svg>
        </div>
      </section>

      <!-- Panel 5: Rules -->
      <section class="panel panel--rules">
        <div class="panel-content">
          <div class="rules-header">
            <p class="rules-header__event">CDL:1</p>
            <h2 class="rules-header__title">La Salida</h2>
            <p class="rules-header__subtitle">House Rules</p>
          </div>

          <div class="rules-grid">
            <div class="rule-card">
              <div class="rule-card__icon">🎯</div>
              <div class="rule-card__content">
                <p class="rule-card__title">Games to 150</p>
                <p class="rule-card__desc">First team to 150 points wins</p>
              </div>
            </div>

            <div class="rule-card">
              <div class="rule-card__icon">🎲</div>
              <div class="rule-card__content">
                <p class="rule-card__title">5 Doubles? Throw Back</p>
                <p class="rule-card__desc">Reshuffle if you draw 5+ doubles</p>
              </div>
            </div>

            <div class="rule-card">
              <div class="rule-card__icon">⚖️</div>
              <div class="rule-card__content">
                <p class="rule-card__title">Tie = Lose Salida</p>
                <p class="rule-card__desc">On a tie, you forfeit the opening</p>
              </div>
            </div>

            <div class="rule-card">
              <div class="rule-card__icon">💵</div>
              <div class="rule-card__content">
                <p class="rule-card__title">$25 Per Player</p>
                <p class="rule-card__desc">Cash on arrival</p>
              </div>
            </div>

            <div class="rule-card">
              <div class="rule-card__icon">👥</div>
              <div class="rule-card__content">
                <p class="rule-card__title">16 Players Max</p>
                <p class="rule-card__desc">8 teams of 2 players each</p>
              </div>
            </div>

            <div class="rule-card">
              <div class="rule-card__icon">🤝</div>
              <div class="rule-card__content">
                <p class="rule-card__title">Teams Assigned</p>
                <p class="rule-card__desc">Paired by host before event</p>
              </div>
            </div>
          </div>

          <div class="rules-divider">
            <span class="rules-divider__domino">🁣</span>
          </div>

          <p class="rules-footer">
            Sign up solo. Get paired. <span class="rules-footer__emphasis">Take the pot.</span>
          </p>
        </div>
      </section>

      <!-- Panel 6: Registration Form -->
      <section class="panel panel--form">
        <div class="panel-bg-gradient"></div>
        <div class="panel-content">
          <h2 class="panel-headline panel-headline--form">La mesa <span class="accent">te espera</span></h2>
          <p class="panel-subtitle">CDL:1 La Salida • 16 Spots</p>

          <!-- Who's In Section -->
          <div class="whos-in" id="whosIn">
            <p class="whos-in__title">Who's In So Far</p>
            <div class="whos-in__list" id="whosInList">
              <p class="whos-in__empty">Loading players...</p>
            </div>
          </div>

          <!-- Progress Tracker -->
          <div class="progress-tracker">
            <div class="progress-header">
              <span class="progress-count"><span class="number" id="playerCount">0</span> players in</span>
              <span class="progress-spots" id="spotsLeft">{PLAYERS_GOAL - PLAYERS_REGISTERED} spots left</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p class="progress-cta">16 spots. Teams paired before event.</p>
          </div>

          <!-- Form -->
          <div class="form-shell">
            <div class="form-intro">
              <p>Register yourself. Teams assigned before event.</p>
              <ul>
                <li>$25 cash on arrival</li>
                <li>Games to 150 points</li>
                <li>Teams paired by host</li>
              </ul>
            </div>

<form id="signup" novalidate>
              <input
                type="text"
                name="company"
                autocomplete="off"
                tabindex="-1"
                aria-hidden="true"
                class="honeypot"
              />

              <label>
                Your Name
                <input name="playerName" required placeholder="Desi Arnaz" />
              </label>

              <label>
                Email
                <input name="email" type="email" required placeholder="you@email.com" />
              </label>

              <label>
                Phone
                <input name="phone" type="tel" required placeholder="(555) 123-4567" />
              </label>

              <label>
                Notes (optional)
                <textarea name="notes" placeholder="Anything you want Erik or the league to know?"></textarea>
              </label>

              <label class="checkbox">
                <input name="ruleConfirm" type="checkbox" required />
                I understand teams are assigned by host before event.
              </label>

              <button type="submit" id="submitBtn">Register — $25</button>
              <p class="status" id="status" aria-live="polite"></p>
            </form>
          </div>

          <p class="footer-note">
            Questions? Email <a href="mailto:Erik@CubanDominoLeague.com">Erik@CubanDominoLeague.com</a>
            <br>
            Venue: <a href="https://mrgarciacigars.com/" target="_blank" rel="noreferrer">Mr Garcia Cigars</a> — 74th & Broadway
          </p>

          <footer class="brand-footer">
            <span class="brand-footer__logo">CDL</span>
            <span class="brand-footer__text">© 2025 Cuban Domino League</span>
            <span class="brand-footer__tagline">La mesa te espera</span>
          </footer>
        </div>
      </section>
    </main>

    <!-- Success Overlay (outside main for position:fixed to work) -->
    <div class="success" id="success">
      <!-- Domino Hero Element -->
      <div class="domino-container">
        <span class="shimmer"></span>
        <span class="shimmer"></span>
        <span class="shimmer"></span>
        <span class="shimmer"></span>
        <span class="shimmer"></span>

        <div class="domino">
          <div class="domino-top">
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
          </div>
          <div class="domino-bottom">
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
          </div>
        </div>
      </div>

      <!-- Headlines -->
      <h2 class="success-headline">You're <span>In</span>.</h2>
      <p class="success-subheadline">Check your email for confirmation details</p>

      <!-- Event Details -->
      <div class="event-details">
        <div class="event-date">January 31, 2025</div>
        <div class="event-venue">Mr Garcia Cigars</div>
        <div class="event-time">Doors open at 6PM</div>
      </div>

      <!-- Tagline -->
      <div class="success-divider">
        <span class="divider-pip"></span>
      </div>
      <p class="success-tagline">"Your seat's waiting."</p>

      <!-- Email reminder -->
      <p class="email-reminder">
        Questions? <a href="mailto:Erik@cubandominoleague.com">Erik@cubandominoleague.com</a>
      </p>
    </div>

    <!-- Music Toggle Button -->
    <button class="music-toggle" id="musicToggle" aria-label="Toggle background music">
      <span class="music-toggle__icon">
        <span class="sound-bars">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </span>
      </span>
      <span class="music-toggle__label">Tap for music</span>
    </button>

    <!-- Background Audio (desktop only) -->
    <audio id="bgMusic" loop preload="none">
      <source src="/AUDIO/background-music.mp3" type="audio/mpeg">
    </audio>

    <!-- Chat Widget - The Sacred Table -->
    <div class="chat-widget" id="chatWidget">
      <div class="chat-toggle" id="chatToggle">
        <span class="chat-toggle__icon"></span>
        <span class="chat-toggle__text">La Mesa</span>
        <span class="chat-toggle__badge" id="chatBadge" style="display: none;">0</span>
      </div>

      <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
          <span class="chat-header__title">
            The Table
          </span>
          <button class="chat-header__close" id="chatClose">×</button>
        </div>

        <!-- Identity selection -->
        <div class="chat-identity" id="chatIdentity">
          <div class="identity-header">Est. 2025</div>
          <p class="chat-identity__title">Identify</p>
          <p class="chat-identity__subtitle">Take your seat at the table.</p>

          <div class="avatar-selector">
            <div class="avatar-option selected" data-avatar="cuba" title="Cuba">
              <span class="avatar-flag-pixel">🇨🇺</span>
            </div>
            <div class="avatar-option" data-avatar="usa" title="USA">
              <span class="avatar-flag-pixel">🇺🇸</span>
            </div>
            <div class="avatar-option" data-avatar="pr" title="Puerto Rico">
              <span class="avatar-flag-pixel">🇵🇷</span>
            </div>
            <div class="avatar-option" data-avatar="dr" title="Dominican Republic">
              <span class="avatar-flag-pixel">🇩🇴</span>
            </div>
            <div class="avatar-option" data-avatar="venezuela" title="Venezuela">
              <span class="avatar-flag-pixel">🇻🇪</span>
            </div>
            <div class="avatar-option" data-avatar="colombia" title="Colombia">
              <span class="avatar-flag-pixel">🇨🇴</span>
            </div>
            <div class="avatar-option" data-avatar="spain" title="Spain">
              <span class="avatar-flag-pixel">🇪🇸</span>
            </div>
          </div>

          <select class="chat-identity__select" id="chatPlayerSelect">
            <option value="">Select Your Name</option>
          </select>
          <p class="chat-identity__register-hint">
            Don't see your name? <a href="#signup" class="chat-identity__register-link" id="chatRegisterLink">Register first</a>
          </p>
          <button class="chat-identity__btn" id="chatJoinBtn" disabled>Enter</button>
        </div>

        <!-- Chat Screen Area -->
        <div class="chat-body-container" id="chatBodyContainer" style="display: none;">
          <div class="chat-messages" id="chatMessages">
            <div class="chat-empty">The table is quiet.</div>
          </div>

          <!-- Reaction Picker (floating) -->
          <div class="reaction-picker" id="reactionPicker">
            <button data-emoji="🔥" title="Fuego">🔥</button>
            <button data-emoji="😂" title="Jaja">😂</button>
            <button data-emoji="👏" title="Respeto">👏</button>
            <button data-emoji="💪" title="Fuerza">💪</button>
            <button data-emoji="🌴" title="Cuba">🌴</button>
          </div>

          <div class="chat-input-area" id="chatInputArea">
            <input type="text" class="chat-input" id="chatInput" placeholder="Speak..." maxlength="500">
            <button class="chat-send" id="chatSend" disabled>
              <svg viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script define:vars={{ PLAYERS_REGISTERED, PLAYERS_GOAL, SUPABASE_URL, SUPABASE_ANON_KEY }}>
      // Panel parallax and content animations
      const allPanels = document.querySelectorAll('.panel');

      const panelObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('in-view');
          } else {
            entry.target.classList.remove('in-view');
          }
        });
      }, { threshold: 0.4 });

      // Skip observing the first panel (hero) - it should always be visible
      allPanels.forEach((panel, index) => {
        if (index > 0) {
          panelObserver.observe(panel);
        }
      });

      // First panel is always in view
      allPanels[0]?.classList.add('in-view');

      // Progress counter animation
      const playerCountEl = document.getElementById("playerCount");
      const spotsLeftEl = document.getElementById("spotsLeft");
      const progressFillEl = document.getElementById("progressFill");

      function animateCounter(target, duration = 1000) {
        let start = 0;
        const startTime = performance.now();

        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic

          const current = Math.floor(eased * target);
          playerCountEl.textContent = current;

          if (progress < 1) {
            requestAnimationFrame(update);
          } else {
            playerCountEl.textContent = target;
          }
        }

        requestAnimationFrame(update);
      }

      // Animate progress bar and counter when panel comes into view
      const formPanel = document.querySelector(".panel--form");
      let hasAnimated = false;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !hasAnimated) {
            hasAnimated = true;

            // Animate counter
            animateCounter(PLAYERS_REGISTERED);

            // Animate progress bar
            const percentage = (PLAYERS_REGISTERED / PLAYERS_GOAL) * 100;
            setTimeout(() => {
              progressFillEl.style.width = percentage + "%";
            }, 100);

            // Update spots left
            spotsLeftEl.textContent = (PLAYERS_GOAL - PLAYERS_REGISTERED) + " spots left";
          }
        });
      }, { threshold: 0.3 });

      observer.observe(formPanel);

      // Form submission
      const form = document.getElementById("signup");
      const statusEl = document.getElementById("status");
      const successEl = document.getElementById("success");
      const submitBtn = document.getElementById("submitBtn");

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!form.reportValidity()) return;
        statusEl.textContent = "Submitting…";
        submitBtn.disabled = true;

        const payload = Object.fromEntries(new FormData(form).entries());

        try {
          const response = await fetch("/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await response.json().catch(() => ({}));
          if (data && data.ok) {
            form.reset();
            form.style.display = "none";
            successEl.classList.add("is-visible");
            statusEl.textContent = "";
            // Hide everything except success for clean full-screen takeover
            document.querySelector(".form-intro").style.display = "none";
            document.querySelector(".panel--form .panel-headline").style.display = "none";
            document.querySelector(".panel--form .panel-subtitle").style.display = "none";
            document.querySelector(".progress-tracker").style.display = "none";
            const footer = document.querySelector(".footer-note");
            if (footer) footer.style.display = "none";
          } else {
            statusEl.textContent = "Error. Try again or contact the host.";
          }
        } catch (error) {
          statusEl.textContent = "Network error. Please try again.";
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Music Toggle - Desktop only
      const musicToggle = document.getElementById('musicToggle');
      const bgMusic = document.getElementById('bgMusic');
      let isPlaying = false;

      bgMusic.volume = 0.08;

      musicToggle.addEventListener('click', function() {
        musicToggle.classList.add('collapsed');

        if (isPlaying) {
          bgMusic.pause();
          musicToggle.classList.remove('is-playing');
          isPlaying = false;
        } else {
          bgMusic.volume = 0;
          bgMusic.play();
          // Fade in
          let vol = 0;
          const fadeIn = setInterval(() => {
            vol += 0.004;
            if (vol >= 0.08) {
              bgMusic.volume = 0.08;
              clearInterval(fadeIn);
            } else {
              bgMusic.volume = vol;
            }
          }, 25);
          musicToggle.classList.add('is-playing');
          isPlaying = true;
        }
      });

      // Smooth volume fade
      function fadeAudio(audio, targetVolume, duration, callback) {
        const startVolume = audio.volume;
        const volumeDiff = targetVolume - startVolume;
        const steps = 20;
        const stepTime = duration / steps;
        let currentStep = 0;

        const fadeInterval = setInterval(() => {
          currentStep++;
          audio.volume = Math.max(0, Math.min(1, startVolume + (volumeDiff * (currentStep / steps))));

          if (currentStep >= steps) {
            clearInterval(fadeInterval);
            audio.volume = targetVolume;
            if (callback) callback();
          }
        }, stepTime);
      }

      // ========================================
      // WHO'S IN - Load registered players
      // ========================================
      let registeredPlayers = [];

      async function loadPlayers() {
        const whosInList = document.getElementById('whosInList');
        const chatPlayerSelect = document.getElementById('chatPlayerSelect');

        try {
          const response = await fetch('/api/players');
          const data = await response.json();
          registeredPlayers = data.players || [];

          if (registeredPlayers.length === 0) {
            whosInList.innerHTML = '<p class="whos-in__empty">Be the first to register!</p>';
          } else {
            // Display players in a grid
            whosInList.innerHTML = registeredPlayers.map(player => `
              <div class="whos-in__player">
                <span class="whos-in__player-name">${escapeHtml(player.name)}</span>
                <span class="whos-in__player-badge">Free Agent</span>
              </div>
            `).join('');

            // Populate chat player selector
            chatPlayerSelect.innerHTML = '<option value="">Select Your Name...</option>' +
              registeredPlayers.map(player =>
                `<option value="${escapeHtml(player.name)}">${escapeHtml(player.name)}</option>`
              ).join('');
          }
        } catch (err) {
          console.error('Failed to load players:', err);
          whosInList.innerHTML = '<p class="whos-in__empty">Could not load players</p>';
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Load players on page load
      loadPlayers();

      // ========================================
      // CHAT - Supabase real-time chat
      // ========================================
      // Chat state (declare early so it's available)
      let chatIdentity = JSON.parse(localStorage.getItem('cdl_chat_identity') || 'null');
      let unreadCount = 0;
      let chatOpen = false;
      let selectedAvatar = 'cuba'; // Default

      // Initialize Supabase
      let supabase = null;

      // Dynamically load Supabase script
      function loadSupabaseScript() {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/dist/umd/supabase.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      function initSupabase() {
        if (window.supabase && !supabase) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          return true;
        }
        return !!supabase;
      }

      // Load Supabase and initialize (only if configured)
      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        loadSupabaseScript().then(() => {
          if (initSupabase() && chatIdentity) {
            loadMessages();
            subscribeToMessages();
          }
        }).catch(err => {
          console.error('Failed to load Supabase:', err);
        });
      }

      // ========================================
      // CHAT WIDGET LOGIC
      // ========================================
      const chatWidget = document.getElementById('chatWidget');
      const chatToggle = document.getElementById('chatToggle');
      const chatPanel = document.getElementById('chatPanel');
      const chatClose = document.getElementById('chatClose');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
      const chatMessages = document.getElementById('chatMessages');
      const chatIdentityScreen = document.getElementById('chatIdentity');
      const chatBodyContainer = document.getElementById('chatBodyContainer');
      const chatBadge = document.getElementById('chatBadge');

      // Haptics Helper
      const vibrate = (pattern = 5) => {
        if (navigator.vibrate) navigator.vibrate(pattern);
      };

      // Toggle Chat & Scroll Lock
      function toggleChat() {
        const isOpen = chatPanel.style.display === 'flex';
        
        if (isOpen) {
          // Close
          chatPanel.classList.remove('is-open');
          setTimeout(() => {
             chatPanel.style.display = 'none';
             document.body.style.overflow = ''; // Unlock scroll
          }, 300);
          vibrate(5);
        } else {
          // Open
          chatPanel.style.display = 'flex';
          // Force reflow
          void chatPanel.offsetWidth;
          chatPanel.classList.add('is-open');
          chatBadge.style.display = 'none';
          unreadCount = 0;
          
          if (window.innerWidth <= 768) {
            document.body.style.overflow = 'hidden'; // Lock scroll on mobile
          }
          vibrate(10);
          
          // Focus input if joined
          if (chatBodyContainer.style.display !== 'none') {
             setTimeout(() => chatInput.focus(), 100);
          }
        }
      }

      chatToggle.addEventListener('click', toggleChat);
      chatClose.addEventListener('click', toggleChat);

      // Register link in chat - close chat and scroll to registration
      const chatRegisterLink = document.getElementById('chatRegisterLink');
      chatRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        toggleChat(); // Close the chat
        // Scroll to registration form
        const signupForm = document.getElementById('signup');
        if (signupForm) {
          signupForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });

      // Swipe to Close (Mobile)
      let touchStartY = 0;
      let touchEndY = 0;

      chatPanel.addEventListener('touchstart', (e) => {
        touchStartY = e.changedTouches[0].screenY;
      }, {passive: true});

      chatPanel.addEventListener('touchmove', (e) => {
         // Prevent closing if scrolling messages
         if (chatMessages.contains(e.target) && chatMessages.scrollTop > 0) return;
         touchEndY = e.changedTouches[0].screenY;
      }, {passive: true});

      chatPanel.addEventListener('touchend', (e) => {
        touchEndY = e.changedTouches[0].screenY;
        const swipeDistance = touchEndY - touchStartY;
        
        // If swiped down more than 100px (and not scrolling messages)
        if (swipeDistance > 100 && (!chatMessages.contains(e.target) || chatMessages.scrollTop <= 0)) {
           toggleChat(); // Close
        }
      });
      
      // Prevent background scroll when touching the chat on mobile
      chatPanel.addEventListener('touchmove', (e) => {
         if (!chatMessages.contains(e.target)) {
            e.preventDefault();
         }
      }, {passive: false});


      // Identity State (Continued)

      // Avatar selection
      const avatarOptions = document.querySelectorAll('.avatar-option');
      avatarOptions.forEach(opt => {
        opt.addEventListener('click', () => {
          avatarOptions.forEach(o => o.classList.remove('selected'));
          opt.classList.add('selected');
          selectedAvatar = opt.dataset.avatar;
        });
      });

      // Player selection handler (individual sign-ups, no teams until draft)
      const chatPlayerSelect = document.getElementById('chatPlayerSelect');
      const chatJoinBtn = document.getElementById('chatJoinBtn');

      chatPlayerSelect.addEventListener('change', (e) => {
        chatJoinBtn.disabled = !e.target.value;
      });

      // Join chat handler - Free Agent status until team assignment
      chatJoinBtn.addEventListener('click', () => {
        const playerName = chatPlayerSelect.value;
        // Using selectedAvatar from global state

        if (playerName) {
          // All players are Free Agents until the team assignment
          chatIdentity = { teamName: null, playerName, avatar: selectedAvatar, status: 'free_agent' };
          localStorage.setItem('cdl_chat_identity', JSON.stringify(chatIdentity));
          showChatInterface();
        }
      });

      function showChatInterface() {
        chatIdentityScreen.style.display = 'none';
        chatBodyContainer.style.display = 'flex'; // Use flex for the container
        chatSend.disabled = false;

        // Only load if supabase is ready, otherwise the interval will handle it
        if (supabase) {
          loadMessages();
          subscribeToMessages();
        }
      }

      // If already have identity, show chat interface
      if (chatIdentity) {
        // Restore selected avatar if saved, otherwise default
        if(chatIdentity.avatar) selectedAvatar = chatIdentity.avatar;
        showChatInterface();
      }

      // Load existing messages
      async function loadMessages() {
        if (!supabase) return;
        try {
          const { data, error } = await supabase
            .from('messages')
            .select('*')
            .order('created_at', { ascending: true })
            .limit(50);

          if (error) throw error;

          if (data && data.length > 0) {
            renderMessages(data);
          }
        } catch (err) {
          console.error('Failed to load messages:', err);
        }
      }

      function renderMessages(messages) {
        if (messages.length === 0) {
          chatMessages.innerHTML = '<div class="chat-empty">-- NO MESSAGES --</div>';
          return;
        }

        // Separate pinned and regular messages
        const pinned = messages.filter(m => m.is_pinned);
        const regular = messages.filter(m => !m.is_pinned);

        let html = '';

        // Show pinned messages section if any
        if (pinned.length > 0) {
          html += '<div class="pinned-section"><div class="pinned-section__label">📌 Pinned</div>';
          html += pinned.map(msg => createMessageHTML(msg)).join('');
          html += '</div>';
        }

        // Show regular messages
        html += regular.map(msg => createMessageHTML(msg)).join('');

        chatMessages.innerHTML = html;

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Map of avatar codes to emojis
      const FLAG_MAP = {
        'cuba': '🇨🇺',
        'usa': '🇺🇸',
        'pr': '🇵🇷',
        'dr': '🇩🇴',
        'venezuela': '🇻🇪',
        'colombia': '🇨🇴',
        'spain': '🇪🇸'
      };

      // Simple hash function for consistent avatars for others
      function getHashAvatar(name) {
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const avatars = Object.keys(FLAG_MAP);
        return avatars[Math.abs(hash) % avatars.length];
      }

      function createMessageHTML(msg) {
        // For individual sign-ups, check by player name (no teams until draft)
        const isSelf = chatIdentity && msg.player_name === chatIdentity.playerName;
        const selfClass = isSelf ? 'chat-message--self' : '';
        const pinnedClass = msg.is_pinned ? 'chat-message--pinned' : '';

        // Check if Free Agent (no team assigned yet)
        const isFreeAgent = !msg.team_name || msg.team_name === 'Free Agent';

        // Use stored avatar, fallback to hash for old messages
        // Default to 'cuba' if local, or hash if remote
        let avatarType = msg.avatar || (isSelf ? (chatIdentity.avatar || 'cuba') : getHashAvatar(msg.player_name));

        // Handle legacy avatars (map old pixel types to flags if they exist in DB)
        if (!FLAG_MAP[avatarType]) {
             // quick map for legacy data
             if (avatarType === 'domino') avatarType = 'cuba';
             else if (avatarType === 'cigar') avatarType = 'usa';
             else if (avatarType === 'cafecito') avatarType = 'pr';
             else if (avatarType === 'carro') avatarType = 'dr';
             else if (avatarType === 'palma') avatarType = 'venezuela';
             else if (avatarType === 'bandera') avatarType = 'colombia';
             else if (avatarType === 'conga') avatarType = 'spain';
             else avatarType = 'cuba'; // Fallback
        }

        const emoji = FLAG_MAP[avatarType] || '🇨🇺';

        // Free Agent badge HTML
        const freeAgentBadge = isFreeAgent ? '<span class="free-agent-badge">Free Agent</span>' : '';

        // Parse reactions - use player name as identifier (not team_player)
        const reactions = msg.reactions || {};
        const reactionHTML = Object.entries(reactions).map(([emoji, users]) => {
          const count = users.length;
          const userReacted = chatIdentity && users.includes(chatIdentity.playerName);
          return count > 0 ? `<button class="reaction-chip ${userReacted ? 'reaction-chip--active' : ''}" data-emoji="${emoji}" data-msg-id="${msg.id}">${emoji} ${count}</button>` : '';
        }).join('');

        return `
          <div class="chat-message ${selfClass} ${pinnedClass}" data-msg-id="${msg.id}">
            ${msg.is_pinned ? '<div class="pinned-badge">📌</div>' : ''}
            <div class="chat-message__avatar">
              <span class="avatar-flag">${emoji}</span>
            </div>
            <div class="chat-message__content-wrapper">
              <div class="chat-message__header">
                <span class="chat-message__author">
                  <span class="chat-message__author-name">${escapeHtml(msg.player_name)}</span>
                  ${freeAgentBadge}
                </span>
                <span class="chat-message__header-actions">
                  <button class="pin-btn ${msg.is_pinned ? 'pin-btn--active' : ''}" data-msg-id="${msg.id}" title="${msg.is_pinned ? 'Unpin' : 'Pin'}">📌</button>
                  <span class="chat-message__time">${formatTime(msg.created_at)}</span>
                </span>
              </div>
              <div class="chat-message__content">${escapeHtml(msg.content)}</div>
              <div class="chat-message__reactions">
                ${reactionHTML}
                <button class="reaction-add" data-msg-id="${msg.id}">+</button>
              </div>
            </div>
          </div>
        `;
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'NOW';
        if (diffMins < 60) return `${diffMins}m`;
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h`;
        return date.toLocaleDateString();
      }

      // Subscribe to new messages
      function subscribeToMessages() {
        if (!supabase) return;
        supabase
          .channel('messages')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
            const msg = payload.new;
            appendMessage(msg);

            // Update unread count if chat is closed
            if (!chatOpen) {
              unreadCount++;
              chatBadge.textContent = unreadCount;
              chatBadge.style.display = 'inline-block'; // Changed to inline-block
            }
          })
          .subscribe();
      }

      function appendMessage(msg) {
        // Remove empty state if present
        const emptyEl = chatMessages.querySelector('.chat-empty');
        if (emptyEl) emptyEl.remove();

        const msgHTML = createMessageHTML(msg);
        const tempContainer = document.createElement('div');
        tempContainer.innerHTML = msgHTML;
        
        chatMessages.appendChild(tempContainer.firstElementChild);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Send message
      async function sendMessage() {
        const content = chatInput.value.trim();
        if (!content || !chatIdentity) return;

        // Make sure Supabase is initialized
        if (!supabase) {
          initSupabase();
          if (!supabase) {
            alert('Chat is still loading...');
            return;
          }
        }

        chatSend.disabled = true;
        chatInput.disabled = true;

        try {
          const { error } = await supabase
            .from('messages')
            .insert({
              team_name: chatIdentity.teamName || null, // null = Free Agent
              player_name: chatIdentity.playerName,
              content: content,
              avatar: chatIdentity.avatar || 'cuba'
            });

          if (error) throw error;

          chatInput.value = '';
        } catch (err) {
          console.error('Failed to send message:', err);
          alert('Failed to send. Signal lost.');
        } finally {
          chatSend.disabled = false;
          chatInput.disabled = false;
          chatInput.focus();
        }
      }

      chatSend.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Enable send button when there's input
      chatInput.addEventListener('input', () => {
        chatSend.disabled = !chatInput.value.trim();
      });

      // ========================================
      // REACTIONS - Handle emoji reactions
      // ========================================
      const reactionPicker = document.getElementById('reactionPicker');
      let activeMessageId = null;

      // Position and show reaction picker
      function showReactionPicker(msgId, buttonEl) {
        activeMessageId = msgId;
        const rect = buttonEl.getBoundingClientRect();

        // Position above the button
        reactionPicker.style.left = rect.left + 'px';
        reactionPicker.style.top = (rect.top - 50) + 'px';
        reactionPicker.classList.add('is-open');
      }

      function hideReactionPicker() {
        reactionPicker.classList.remove('is-open');
        activeMessageId = null;
      }

      // Handle clicks on + button to show picker
      chatMessages.addEventListener('click', async (e) => {
        const addBtn = e.target.closest('.reaction-add');
        const chipBtn = e.target.closest('.reaction-chip');

        if (addBtn) {
          e.stopPropagation();
          const msgId = addBtn.dataset.msgId;
          if (activeMessageId === msgId) {
            hideReactionPicker();
          } else {
            showReactionPicker(msgId, addBtn);
          }
        } else if (chipBtn) {
          // Toggle reaction on existing chip
          e.stopPropagation();
          const msgId = chipBtn.dataset.msgId;
          const emoji = chipBtn.dataset.emoji;
          await toggleReaction(msgId, emoji);
        } else {
          hideReactionPicker();
        }
      });

      // Handle emoji selection from picker
      reactionPicker.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (btn && activeMessageId) {
          const emoji = btn.dataset.emoji;
          await toggleReaction(activeMessageId, emoji);
          hideReactionPicker();
        }
      });

      // Close picker when clicking outside
      document.addEventListener('click', (e) => {
        if (!reactionPicker.contains(e.target) && !e.target.closest('.reaction-add')) {
          hideReactionPicker();
        }
      });

      // Toggle a reaction on a message
      async function toggleReaction(msgId, emoji) {
        if (!supabase || !chatIdentity) return;

        const userId = `${chatIdentity.teamName}_${chatIdentity.playerName}`;

        try {
          // Get current message
          const { data: msg, error: fetchError } = await supabase
            .from('messages')
            .select('reactions')
            .eq('id', msgId)
            .single();

          if (fetchError) throw fetchError;

          const reactions = msg.reactions || {};
          const users = reactions[emoji] || [];

          // Toggle user's reaction
          const userIndex = users.indexOf(userId);
          if (userIndex > -1) {
            users.splice(userIndex, 1);
          } else {
            users.push(userId);
          }

          // Update or remove the emoji
          if (users.length > 0) {
            reactions[emoji] = users;
          } else {
            delete reactions[emoji];
          }

          // Save to Supabase
          const { error: updateError } = await supabase
            .from('messages')
            .update({ reactions })
            .eq('id', msgId);

          if (updateError) throw updateError;

          // Re-render messages to show updated reactions
          loadMessages();

        } catch (err) {
          console.error('Failed to toggle reaction:', err);
        }
      }

      // ========================================
      // PINNED MESSAGES - Handle pinning
      // ========================================

      // Handle pin button clicks
      chatMessages.addEventListener('click', async (e) => {
        const pinBtn = e.target.closest('.pin-btn');
        if (pinBtn) {
          e.stopPropagation();
          const msgId = pinBtn.dataset.msgId;
          await togglePin(msgId);
        }
      });

      // Toggle pin on a message
      async function togglePin(msgId) {
        if (!supabase || !chatIdentity) return;

        try {
          // Get current message
          const { data: msg, error: fetchError } = await supabase
            .from('messages')
            .select('is_pinned')
            .eq('id', msgId)
            .single();

          if (fetchError) throw fetchError;

          const newPinState = !msg.is_pinned;

          // Save to Supabase
          const { error: updateError } = await supabase
            .from('messages')
            .update({ is_pinned: newPinState })
            .eq('id', msgId);

          if (updateError) throw updateError;

          // Re-render messages
          loadMessages();

        } catch (err) {
          console.error('Failed to toggle pin:', err);
        }
      }
    </script>
  </body>
</html>
