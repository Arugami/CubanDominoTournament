---
import { TOURNAMENT_I } from '../lib/event';
const EVENT = TOURNAMENT_I;

// Update this number manually when players sign up
const PLAYERS_REGISTERED = 0;
const PLAYERS_GOAL = 16; // 8 teams × 2 players

const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>La Salida | Cuban Domino League</title>
    <meta
      name="description"
      content={`La Salida — The first Cuban Domino League tournament at ${EVENT.venueName}. ${EVENT.dateLong}. They taught you for this moment. Make them proud.`}
    />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,700;0,6..96,800;0,6..96,900;1,6..96,400;1,6..96,700&family=IBM+Plex+Sans:ital,wght@0,400;0,500;0,600;1,400&family=IBM+Plex+Sans+Condensed:wght@600;700&family=IBM+Plex+Serif:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --ink: #1c130f;
        --muted: #594a3f;
        --copper: #b76a3b;
        --cream: #f8efe6;
        --bone: #fff7ef;
        --brass: #d4a574;
        --gold: #ffd700;
        --shadow: 0 18px 45px rgba(20, 10, 6, 0.18);
      }

      @font-face {
        font-family: 'SF Sports Night';
        src: url('/FONT/sf-sports-night/TrueType/SFSportsNight.woff2') format('woff2'),
             url('/FONT/sf-sports-night/TrueType/SFSportsNight.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        overflow-x: hidden;
        max-width: 100vw;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        background: #0a0705;
        color: #fff;
      }


      /* ============================================
         LOADING SCREEN - HYPNOTIC CDL
         "The ritual before the game"
         ============================================ */

      /* Master timing - synchronized heartbeat (4s = meditative breathing) */
      :root {
        --heartbeat: 4s;
        --breath-ease: cubic-bezier(0.4, 0, 0.2, 1); /* Fast inhale, slow exhale */
        --ember-color: rgba(255, 180, 100, 0.9);
        --glow-warm: rgba(232, 190, 140, 1);
        --glow-deep: rgba(183, 106, 59, 0.8);
      }

      .loading-screen {
        position: fixed;
        inset: 0;
        z-index: 99999;
        background: radial-gradient(ellipse at center, #1a120d 0%, #080503 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: opacity 0.6s ease-out, visibility 0.6s ease-out, transform 0.7s ease-out;
        overflow: hidden;
        transform: translate3d(0, 0, 0);
        will-change: opacity, transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }

      /* Keep the loader visible, but stop blocking scroll/taps quickly. */
      .loading-screen.is-passive {
        pointer-events: none;
      }

      .loading-screen.is-hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      /* ===== EXIT ANIMATION - "The Smoke Clears" ===== */
      .loading-screen.is-exiting {
        transform: translateY(-25px);
      }

      .loading-screen.is-exiting .cdl-tile {
        transform: scale(0.92) translateY(-15px);
        opacity: 0.7;
      }

      .loading-screen.is-exiting .ember {
        animation: emberExit 0.8s ease-out forwards;
      }

      /* Fog exhales outward and upward during exit */
      .loading-screen.is-exiting .fog-layer--ambient {
        transform: translate(-50%, -55%) scale(1.15);
        opacity: 0.2;
        transition: transform 0.5s ease-out, opacity 0.5s ease-out;
      }

      @keyframes emberExit {
        0% {
          opacity: 0.6;
        }
        100% {
          opacity: 0;
          transform: translateY(-120px) scale(0.5);
        }
      }

      /* ===== BREATHING STATE - "The Room Lives" ===== */
      /* After entrance completes, the room enters a meditative pulse */
      .loading-screen.is-breathing .cdl-tile {
        animation: tileFloat 6s ease-in-out infinite;
      }

      .loading-screen.is-breathing .cdl-tile__letter {
        animation: letterPulse var(--heartbeat) ease-in-out infinite;
      }

      .loading-screen.is-breathing .cdl-tile__divider {
        animation: dividerPulse var(--heartbeat) ease-in-out infinite;
      }

      .loading-screen.is-breathing .cdl-tile__glow {
        animation: glowPulse var(--heartbeat) ease-in-out infinite;
      }

      .loading-screen.is-breathing .fog-layer--ambient {
        animation: ambientBreath 5s ease-in-out infinite;
      }

      /* ===== EXIT ANTICIPATION - "The Final Breath" ===== */
      /* A brief intensification before release */
      .loading-screen.is-anticipating .cdl-tile__glow {
        transform: translate(-50%, -50%) scale(1.15);
        opacity: 0.8;
        transition: transform 0.4s ease-out, opacity 0.4s ease-out;
      }

      .loading-screen.is-anticipating .cdl-tile__letter {
        filter: brightness(1.15);
        transition: filter 0.4s ease-out;
      }

      /* Fog pulls inward during anticipation - the "inhale" */
      .loading-screen.is-anticipating .fog-layer--ambient {
        transform: translate(-50%, -50%) scale(0.92);
        opacity: 0.7;
        transition: transform 0.4s ease-in, opacity 0.4s ease-in;
      }

      /* Film grain overlay - cinematic texture */
      .loading-screen::before {
        content: '';
        position: absolute;
        inset: -50%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.035;
        pointer-events: none;
        z-index: 10;
        /* Smooth (non-steps) motion avoids "flicker" reads on the tile shadow */
        animation: grainShift 7s linear infinite;
        will-change: transform;
      }

      @keyframes grainShift {
        0%, 100% { transform: translate3d(0, 0, 0); }
        20% { transform: translate3d(-0.6%, -0.4%, 0); }
        40% { transform: translate3d(0.45%, 0.3%, 0); }
        60% { transform: translate3d(-0.35%, 0.55%, 0); }
        80% { transform: translate3d(0.25%, -0.25%, 0); }
      }

      /* Deep vignette - pulls focus to center */
      .loading-screen::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(
          ellipse at center,
          transparent 0%,
          transparent 30%,
          rgba(0, 0, 0, 0.5) 70%,
          rgba(0, 0, 0, 0.8) 100%
        );
        pointer-events: none;
        z-index: 5;
      }

      /* ===== EMBER PARTICLES - floating upward like cigar smoke ===== */
      .ember-container {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 3;
        overflow: hidden;
      }

      .ember {
        position: absolute;
        width: 3px;
        height: 3px;
        background: var(--ember-color);
        border-radius: 50%;
        filter: blur(1px);
        opacity: 0;
        animation: emberFloatA 7s linear infinite;  /* Longer duration, linear for smooth keyframes */
        will-change: transform, opacity;  /* Hint to GPU for smoother rendering */
      }

      /* Varied sizes - some embers are larger, brighter */
      .ember--lg { width: 4px; height: 4px; filter: blur(0.5px); }
      .ember--sm { width: 2px; height: 2px; filter: blur(1.5px); opacity: 0.7; }

      /* 12 embers with varied paths, positions, and timing */
      /* Paths A, B, C distributed for organic variety */
      .ember:nth-child(1)  { left: 48%; bottom: 42%; animation: emberFloatA 7s linear infinite; animation-delay: 0s; }
      .ember:nth-child(2)  { left: 51%; bottom: 44%; animation: emberFloatB 6.5s linear infinite; animation-delay: 0.7s; }
      .ember:nth-child(3)  { left: 49%; bottom: 40%; animation: emberFloatC 7.2s linear infinite; animation-delay: 1.4s; }
      .ember:nth-child(4)  { left: 52%; bottom: 43%; animation: emberFloatA 6.8s linear infinite; animation-delay: 2.1s; }
      .ember:nth-child(5)  { left: 47%; bottom: 45%; animation: emberFloatB 7.5s linear infinite; animation-delay: 2.8s; }
      .ember:nth-child(6)  { left: 50%; bottom: 41%; animation: emberFloatC 6.3s linear infinite; animation-delay: 3.5s; }
      .ember:nth-child(7)  { left: 48%; bottom: 44%; animation: emberFloatA 7.1s linear infinite; animation-delay: 0.4s; }
      .ember:nth-child(8)  { left: 51%; bottom: 42%; animation: emberFloatB 6.6s linear infinite; animation-delay: 1.1s; }
      .ember:nth-child(9)  { left: 49%; bottom: 46%; animation: emberFloatC 7.4s linear infinite; animation-delay: 1.8s; }
      .ember:nth-child(10) { left: 52%; bottom: 43%; animation: emberFloatA 6.9s linear infinite; animation-delay: 2.5s; }
      .ember:nth-child(11) { left: 48%; bottom: 41%; animation: emberFloatB 7.3s linear infinite; animation-delay: 3.2s; }
      .ember:nth-child(12) { left: 50%; bottom: 45%; animation: emberFloatC 6.4s linear infinite; animation-delay: 4.0s; }

      /* ===== ORGANIC EMBER PATHS - Like sparks from the domino tile ===== */
      /* Path A: Drifts right with gentle sine wave */
      @keyframes emberFloatA {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.3);
        }
        5% {
          opacity: 0.4;
          transform: translateY(-10px) translateX(2px) rotate(15deg) scale(0.7);
        }
        15% {
          opacity: 0.85;
          transform: translateY(-30px) translateX(8px) rotate(35deg) scale(1);
        }
        30% {
          opacity: 0.75;
          transform: translateY(-55px) translateX(5px) rotate(70deg) scale(0.9);
        }
        50% {
          opacity: 0.6;
          transform: translateY(-90px) translateX(15px) rotate(120deg) scale(0.7);
        }
        70% {
          opacity: 0.4;
          transform: translateY(-125px) translateX(10px) rotate(180deg) scale(0.5);
        }
        85% {
          opacity: 0.2;
          transform: translateY(-155px) translateX(20px) rotate(220deg) scale(0.35);
        }
        100% {
          opacity: 0;
          transform: translateY(-180px) translateX(25px) rotate(270deg) scale(0.2);
        }
      }

      /* Path B: Drifts left with different rhythm */
      @keyframes emberFloatB {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.4);
        }
        8% {
          opacity: 0.5;
          transform: translateY(-15px) translateX(-3px) rotate(-20deg) scale(0.8);
        }
        20% {
          opacity: 0.8;
          transform: translateY(-40px) translateX(-10px) rotate(-50deg) scale(1);
        }
        40% {
          opacity: 0.65;
          transform: translateY(-75px) translateX(-5px) rotate(-100deg) scale(0.85);
        }
        60% {
          opacity: 0.45;
          transform: translateY(-110px) translateX(-15px) rotate(-160deg) scale(0.6);
        }
        80% {
          opacity: 0.25;
          transform: translateY(-145px) translateX(-8px) rotate(-220deg) scale(0.4);
        }
        100% {
          opacity: 0;
          transform: translateY(-175px) translateX(-18px) rotate(-280deg) scale(0.2);
        }
      }

      /* Path C: Mostly vertical with subtle sway */
      @keyframes emberFloatC {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.35);
        }
        10% {
          opacity: 0.6;
          transform: translateY(-20px) translateX(4px) rotate(25deg) scale(0.9);
        }
        25% {
          opacity: 0.8;
          transform: translateY(-45px) translateX(-2px) rotate(60deg) scale(1);
        }
        45% {
          opacity: 0.55;
          transform: translateY(-85px) translateX(6px) rotate(110deg) scale(0.75);
        }
        65% {
          opacity: 0.35;
          transform: translateY(-120px) translateX(-4px) rotate(170deg) scale(0.55);
        }
        85% {
          opacity: 0.15;
          transform: translateY(-155px) translateX(3px) rotate(230deg) scale(0.35);
        }
        100% {
          opacity: 0;
          transform: translateY(-185px) translateX(0) rotate(290deg) scale(0.15);
        }
      }

      /* ===== ATMOSPHERIC FOG - breathing warmth ===== */
      .fog-container {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
        z-index: 1;
      }

      .fog-layer--ambient {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 150%;
        height: 150%;
        transform: translate(-50%, -50%);
        background: radial-gradient(
          ellipse 60% 50% at 50% 48%,
          rgba(183, 106, 59, 0.18) 0%,
          rgba(139, 69, 19, 0.10) 25%,
          rgba(100, 50, 20, 0.04) 40%,
          rgba(50, 25, 10, 0.02) 55%,
          transparent 75%
        );
        /* Fog appears once, then stays static */
        animation: fogAlone 2s ease-in-out forwards;
        /* Exit transition - fog drifts up and dissipates */
        transition: transform 0.7s ease-out, opacity 0.6s ease-out;
      }

      /* Phase 1: Fog breathes alone — gentler, less dramatic */
      @keyframes fogAlone {
        0% {
          transform: translate(-50%, -50%) scale(0.9);
          opacity: 0.3;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.05);
          opacity: 0.7;
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;
        }
      }

      @keyframes ambientBreath {
        0%, 100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.03);  /* Was 1.15 — subtler, no visible edges */
          opacity: 0.6;  /* Was 1 — gentler pulse */
        }
      }

      /* ===== REDUCED MOTION ACCESSIBILITY ===== */
      @media (prefers-reduced-motion: reduce) {
        .loading-screen,
        .loading-screen *,
        .loading-screen::before,
        .loading-screen::after {
          animation: none !important;
          transition-duration: 0.3s !important;
        }

        /* Show elements immediately without choreography */
        .cdl-tile__letter,
        .cdl-tile__divider,
        .fog-layer--ambient {
          opacity: 1 !important;
        }

        /* Hide embers entirely */
        .ember-container {
          display: none;
        }
      }

      /* ===== THE CDL TILE - sacred geometry ===== */
      .cdl-tile {
        z-index: 4;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        position: relative;
        padding: 20px 0;
        /* Tile appears once, then stays static */
        animation: tileAppear 1.2s cubic-bezier(0.16, 1, 0.3, 1) 0.8s forwards;
        /* Exit transition - "the smoke clears" */
        transition: transform 0.7s ease-out, opacity 0.6s ease-out;
      }

	      /* Shadow grounds the tile - "Physical Digital" */
	      .cdl-tile::after {
	        content: '';
	        position: absolute;
	        bottom: -30px;
	        left: 50%;
	        transform: translate3d(-50%, 0, 0);
	        width: 132px;
	        height: 26px;
	        background: radial-gradient(
	          ellipse at center,
	          rgba(0, 0, 0, 0.38) 0%,
	          rgba(0, 0, 0, 0.24) 28%,
	          rgba(0, 0, 0, 0.14) 45%,
	          rgba(0, 0, 0, 0.06) 62%,
	          transparent 78%
	        );
	        z-index: -1;
	        opacity: 0;  /* Start invisible, animate in with tile */
        animation: shadowAppear 1.2s cubic-bezier(0.16, 1, 0.3, 1) 0.8s forwards;
	        will-change: transform, opacity;
	        -webkit-backface-visibility: hidden;
	        backface-visibility: hidden;
	      }

      /* Shadow breathes with tile */
      .loading-screen.is-breathing .cdl-tile::after {
        opacity: 0.6;  /* Reset base state for breathing phase */
        animation: shadowBreath 6s ease-in-out infinite;
      }

		      @keyframes shadowBreath {
		        0%, 100% {
		          opacity: 0.6;
		        }
		        25% {
		          opacity: 0.5;
		        }
		        50% {
		          opacity: 0.6;
		        }
		        75% {
		          opacity: 0.7;
		        }
		      }

      @keyframes shadowAppear {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 0.6;
        }
      }

      @keyframes tileAppear {
        0% {
          opacity: 0;
          transform: scale(0.9);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Gentle orbital float - hypnotic drift */
      @keyframes tileFloat {
        0%, 100% {
          transform: translateY(0) rotate(0deg);
        }
        25% {
          transform: translateY(-3px) rotate(0.3deg);
        }
        50% {
          transform: translateY(0) rotate(0deg);
        }
        75% {
          transform: translateY(3px) rotate(-0.3deg);
        }
      }

      /* Letter arrangement */
      .cdl-tile__upper {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        width: 200px;
        margin-bottom: 0;
      }

      .cdl-tile__letter {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: 100px;
        color: #f0d4a8; /* Solid luminous color — the letters ARE the light */
        line-height: 1;
        letter-spacing: 0;
        opacity: 0;
        /* The letters ARE the light source — intense mystical glow */
        text-shadow:
          0 0 5px rgba(255, 255, 255, 0.5),
          0 0 15px var(--glow-warm),
          0 0 30px var(--glow-warm),
          0 0 60px rgba(212, 165, 116, 0.8),
          0 0 100px var(--glow-deep),
          0 0 150px rgba(183, 106, 59, 0.4);
        /* Letters emerge once, then stay static */
        animation: letterReveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) 1.5s forwards;
      }

      /* Subtler letter entrance - emerge, don't crash */
      @keyframes letterReveal {
        0% {
          opacity: 0;
          transform: translateY(15px) scale(0.95);
          filter: blur(8px);
        }
        60% {
          filter: blur(0);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* Synchronized heartbeat glow - all letters breathe together (5-step smooth curve) */
      @keyframes letterPulse {
        0%, 100% {
          /* Must match base .cdl-tile__letter text-shadow to avoid jerk on animation switch */
          opacity: 1;
          text-shadow:
            0 0 5px rgba(255, 255, 255, 0.5),
            0 0 15px var(--glow-warm),
            0 0 30px var(--glow-warm),
            0 0 60px rgba(212, 165, 116, 0.8),
            0 0 100px var(--glow-deep),
            0 0 150px rgba(183, 106, 59, 0.4);
          filter: brightness(1);
        }
        25% {
          opacity: 1;
          text-shadow:
            0 0 6px rgba(255, 255, 255, 0.52),
            0 0 17px var(--glow-warm),
            0 0 38px var(--glow-warm),
            0 0 75px rgba(212, 165, 116, 0.85),
            0 0 100px var(--glow-deep),
            0 0 150px rgba(183, 106, 59, 0.45);
          filter: brightness(1.03);
        }
        50% {
          opacity: 1;
          text-shadow:
            0 0 8px rgba(255, 255, 255, 0.6),
            0 0 20px var(--glow-warm),
            0 0 50px rgba(212, 165, 116, 0.9),
            0 0 100px var(--glow-deep),
            0 0 150px rgba(183, 106, 59, 0.5);
          filter: brightness(1.06);
        }
        75% {
          opacity: 1;
          text-shadow:
            0 0 6px rgba(255, 255, 255, 0.52),
            0 0 17px var(--glow-warm),
            0 0 38px var(--glow-warm),
            0 0 75px rgba(212, 165, 116, 0.85),
            0 0 100px var(--glow-deep),
            0 0 150px rgba(183, 106, 59, 0.45);
          filter: brightness(1.03);
        }
      }

      .cdl-tile__letter--c {
        align-self: flex-start;
        margin-left: 16px;  /* Proportional to container */
        animation-delay: 1.5s;  /* First to emerge */
      }

      .cdl-tile__letter--d {
        align-self: flex-end;
        margin-right: 16px;  /* Proportional to container */
        margin-top: -20px;  /* Tighter diagonal — leaning together */
        animation-delay: 1.9s;  /* 0.4s after C */
      }

      .cdl-tile__letter--l {
        animation-delay: 2.3s;  /* 0.4s after D */
      }

      /* ===== THE DIVIDER - "The Bone" placed on the table ===== */
      .cdl-tile__divider {
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent 0%, #f0d4a8 50%, transparent 100%);
        margin: 18px 0;
        opacity: 0;
        box-shadow:
          0 0 10px var(--glow-warm),
          0 0 25px rgba(212, 165, 116, 0.7),
          0 0 50px var(--glow-deep);
        /* Divider slams once, then stays static */
        animation: dividerSlam 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 2.1s forwards;
      }

      /* The slam - like placing a domino tile */
      @keyframes dividerSlam {
        0% {
          opacity: 0;
          transform: scaleX(0) scaleY(3);
          filter: blur(4px);
        }
        50% {
          opacity: 1;
          transform: scaleX(1.1) scaleY(1);
          filter: blur(0);
        }
        70% {
          transform: scaleX(0.95) scaleY(1);
        }
        100% {
          opacity: 0.9;
          transform: scaleX(1) scaleY(1);
        }
      }

      /* Synchronized with letter heartbeat - unified pulse intensity (5-step smooth curve) */
      @keyframes dividerPulse {
        0%, 100% {
          opacity: 0.85;
          box-shadow:
            0 0 6px rgba(232, 190, 140, 0.5),
            0 0 15px rgba(212, 165, 116, 0.3),
            0 0 30px rgba(183, 106, 59, 0.15);
        }
        25% {
          opacity: 0.9;
          box-shadow:
            0 0 9px rgba(232, 190, 140, 0.6),
            0 0 22px rgba(212, 165, 116, 0.5),
            0 0 45px rgba(183, 106, 59, 0.25);
        }
        50% {
          opacity: 1;
          box-shadow:
            0 0 14px var(--glow-warm),
            0 0 35px rgba(212, 165, 116, 0.8),
            0 0 70px var(--glow-deep);
        }
        75% {
          opacity: 0.9;
          box-shadow:
            0 0 9px rgba(232, 190, 140, 0.6),
            0 0 22px rgba(212, 165, 116, 0.5),
            0 0 45px rgba(183, 106, 59, 0.25);
        }
      }

      .cdl-tile__lower {
        display: flex;
        justify-content: center;
        width: 200px;
      }

      /* Inner glow behind the tile — reinforces that letters emit light */
      .cdl-tile__glow {
        position: absolute;
        width: 280px;
        height: 280px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: radial-gradient(
          circle,
          rgba(212, 165, 116, 0.28) 0%,
          rgba(183, 106, 59, 0.16) 30%,
          rgba(150, 80, 40, 0.08) 50%,
          rgba(100, 50, 20, 0.03) 70%,
          transparent 90%
        );
        border-radius: 50%;
        opacity: 0;
        /* Glow crescendos once, then stays static */
        animation: glowCrescendo 1.5s ease-out 0.8s forwards;
        pointer-events: none;
        z-index: -1;
        /* Smooth state transitions */
        transition: transform 0.4s ease-out, opacity 0.4s ease-out;
      }

      /* Phase 2: Glow crescendo — smooth, no overshoot */
      @keyframes glowCrescendo {
        0% {
          transform: translate(-50%, -50%) scale(0.6);
          opacity: 0;
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;
        }
      }

      /* 5-step smooth curve for hypnotic breathing */
      @keyframes glowPulse {
        0%, 100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;  /* Matches crescendo end — no jerk */
        }
        25% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.55;
        }
        50% {
          transform: translate(-50%, -50%) scale(1);  /* No scale — prevents gradient edge visibility */
          opacity: 0.65;  /* Slightly increased to compensate for no scale */
        }
        75% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.55;
        }
      }

      /* Mobile adjustments */
	      @media (max-width: 768px) {
        .cdl-tile__upper,
        .cdl-tile__lower {
          width: 100px;
        }
        .cdl-tile__letter {
          font-size: 44px;
        }
        .cdl-tile__letter--d {
          margin-top: -14px;
        }
        .cdl-tile__divider {
          margin: 12px 0;
        }
        .cdl-tile__tagline {
          font-size: 8px;
          letter-spacing: 0.4em;
          margin-top: 24px;
        }
      }

      /* CSS-based scroll lock when chat is open (no JS needed) */
      body.chat-open {
        overflow: hidden !important;
      }

      /* Panel Background Dim - Tobias: "Threshold moment" - 5% dim when entering La Mesa */
      body.chat-open .story {
        filter: brightness(0.95);
        transition: filter 0.3s ease;
      }

      /* Modern browsers: use :has() selector */
      @supports selector(:has(*)) {
        body:has(.chat-panel.is-open) {
          overflow: hidden !important;
        }
        body:has(.chat-panel.is-open) .story {
          filter: brightness(0.95);
          transition: filter 0.3s ease;
        }
      }

      /* Scroll Container */
      .story {
        height: 100vh;
        height: 100dvh; /* iOS Safari fix - uses actual visible viewport */
        overflow-x: hidden;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        overscroll-behavior: contain;
        scroll-padding-bottom: 46px; /* Account for fixed ticker */
        position: relative;
      }

      /* Panel Base */
      .panel {
        min-height: 100vh;
        min-height: 100dvh;
        height: 100vh;
        height: 100dvh;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 24px;
        overflow: hidden; /* Prevent horizontal scroll from parallax bg */
        /* Camera cut transitions - panels fade in as they enter view */
        /* Per Tobias audit: 8% was too subtle, now 15% + scale + blur for real "camera cut" feel */
        opacity: 0.85;
        transform: scale(0.985);
        filter: blur(0.3px);
        transition:
          opacity 0.4s ease-out,
          transform 0.5s cubic-bezier(0.16, 1, 0.3, 1),
          filter 0.4s ease-out;
        /* Performance hint for upcoming transition */
        will-change: opacity, transform, filter;
      }

      /* Panel fully visible - "camera cut" moment */
      .panel.in-view {
        opacity: 1;
        transform: scale(1);
        filter: blur(0);
        /* Clear will-change after transition to free GPU memory */
        will-change: auto;
      }

      .panel-bg {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        z-index: 0; /* Establish a stacking context so film grain never floats above typography (iOS quirk) */
        isolation: isolate; /* Contain blend/film layers to the background only (don’t trap typography) */
      }

      /* Global overlays live INSIDE the scroll container (sticky) so iOS Safari stacking stays correct. */
      .story-overlays {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 4; /* Above panel overlays (2), below text (10+) */
      }

      /* Global Cinematic Vignette - Tobias Signature */
      .vignette-overlay {
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at center,
          transparent 15%,
          rgba(0, 0, 0, 0.35) 60%,
          rgba(0, 0, 0, 0.85) 100%
        );
        pointer-events: none;
        z-index: 1;
      }

      /* ============================================
         VIGNETTE INTENSITY VARIATIONS BY PANEL
         Tobias: "Vignettes should breathe with the story"
         Hero: Standard | Whisper: Intimate | Build: Opening | Slam: Focused
         ============================================ */

      /* Panel 2 (Whisper): 85% intensity - intimate, close focus */
      .panel--whisper .vignette-overlay {
        background: radial-gradient(
          circle at center,
          transparent 12%,
          rgba(0, 0, 0, 0.40) 55%,
          rgba(0, 0, 0, 0.92) 100%
        );
      }

      /* Panel 3 (Build): 75% intensity - opening up, room to breathe */
      .panel--build .vignette-overlay {
        background: radial-gradient(
          circle at center,
          transparent 20%,
          rgba(0, 0, 0, 0.30) 65%,
          rgba(0, 0, 0, 0.78) 100%
        );
      }

      /* Panel 4 (Slam): 90% intensity - maximum focus on SEAT */
      .panel--slam .vignette-overlay {
        background: radial-gradient(
          circle at center,
          transparent 10%,
          rgba(0, 0, 0, 0.45) 50%,
          rgba(0, 0, 0, 0.95) 100%
        );
      }

      /* Film grain overlay - "Like photos from 1978" — Wes Anderson
         2-3% noise - not visible, but felt. Memory texture.
         NOTE: feColorMatrix saturate=0 converts turbulence to grayscale.
         Without this, feTurbulence generates RGB colored noise causing green tint. */
      .panel-bg::after {
        content: '';
        position: absolute;
        inset: 0;
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)' opacity='0.03'/%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 1;
        mix-blend-mode: normal;
        opacity: 0.2;
      }

      /* Tobias: Chromatic Aberration - Edge Distortion
         Gives it that vintage lens feel, pulling the digital into the physical world. */
      .chromatic-aberration {
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        opacity: 0.18;
        mix-blend-mode: normal;
        background:
          radial-gradient(circle at 49.8% 50%, rgba(180, 180, 180, 0.04) 0%, transparent 80%),
          radial-gradient(circle at 50.2% 50%, rgba(180, 180, 180, 0.04) 0%, transparent 80%);
      }

      /* Tobias: Tobacco Fog Layer - Depth Through Layers */
      .fog-layer {
        position: absolute;
        inset: -20%; /* Bleed for movement */
        width: 140%;
        height: 140%;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(183, 106, 59, 0.12) 0%,
          rgba(28, 19, 15, 0.18) 45%,
          transparent 75%
        );
        filter: blur(70px);
        pointer-events: none;
        z-index: 1;
        opacity: 0;
        transition: opacity 3s ease;
        animation: fogDrift 60s cubic-bezier(0.45, 0.05, 0.55, 0.95) infinite; /* Tobias: Breath-like cadence */
      }

      @keyframes fogDrift {
        0% { transform: translate(0, 0) rotate(0deg); }
        33% { transform: translate(-3%, 2%) rotate(2deg); }
        66% { transform: translate(2%, -3%) rotate(-1deg); }
        100% { transform: translate(0, 0) rotate(0deg); }
      }

      .panel.in-view .fog-layer {
        opacity: 1;
      }

      /* Tobias: Smoke Layer - Foreground Atmosphere */
      /* z-index: 3 - BELOW text (z-index 10+) but above fog (z-index 1) */
      .smoke-layer {
        position: absolute;
        inset: -10%;
        width: 120%;
        height: 120%;
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.005' numOctaves='5' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 3;
        opacity: 0;
        mix-blend-mode: normal;
        transition: opacity 4s ease;
        animation: smokeDrift 40s linear infinite;
      }

      @keyframes smokeDrift {
        from { transform: translate(0, 0) scale(1); }
        to { transform: translate(-5%, 5%) scale(1.1); }
      }

      .panel.in-view .smoke-layer {
        opacity: 0.6;
      }

      /* Lens Push - Subtle background motion when in view */
      .panel-bg {
        transition: transform 12s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 1s ease;
      }

      .panel.in-view .panel-bg {
        transform: scale(1.05); /* Tobias: Lens Push - subtle walking-in feel */
      }

      /* Hero "walking in" effect */
      .panel--hero {
        overflow: hidden;
      }

      .panel--hero .panel-bg {
        inset: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center center;
      }

      /* Hero overlay - HIDDEN to prevent flicker */
      .panel--hero .panel-overlay {
        display: none !important;
      }

      /* Combined overlay baked into ::before to prevent flicker */
      .panel--hero .panel-bg::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          /* Tobias: Smoke Texture - "Fog, not a wall" */
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E"),
          /* Vertical gradient */
          linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.55) 0%,
            rgba(0, 0, 0, 0.1) 40%,
            rgba(0, 0, 0, 0.1) 60%,
            rgba(0, 0, 0, 0.85) 100%
          ),
          /* Tobias: Deeper Schneider Vignette */
          radial-gradient(
            circle at 50% 50%,
            transparent 30%,
            rgba(0, 0, 0, 0.3) 65%,
            rgba(0, 0, 0, 0.75) 100%
          ),
          /* Side vignettes - deeper for center focus */
          linear-gradient(
            90deg,
            rgba(0, 0, 0, 0.8) 0%,
            rgba(0, 0, 0, 0.3) 15%,
            transparent 30%,
            transparent 70%,
            rgba(0, 0, 0, 0.3) 85%,
            rgba(0, 0, 0, 0.8) 100%
          );
        pointer-events: none;
        z-index: 1;
      }

      /* Tobias: Ember Burn - Cinematic Light Leak */
      .panel--hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at 90% 10%,
          rgba(183, 106, 59, 0.15) 0%,
          transparent 60%
        );
        mix-blend-mode: color-dodge;
        pointer-events: none;
        z-index: 3;
        animation: emberBreath 8s ease-in-out infinite alternate;
      }

      @keyframes emberBreath {
        0% { opacity: 0.4; transform: scale(1); }
        100% { opacity: 0.7; transform: scale(1.1); }
      }

      /* Tobias: Lens Focus Load transition */
      .is-loading .panel--hero .panel-bg {
        filter: blur(8px) brightness(0.7);
        transform: scale(1.05);
      }

      .panel--hero .panel-bg {
        transition: filter 2.5s cubic-bezier(0.16, 1, 0.3, 1), transform 3s cubic-bezier(0.16, 1, 0.3, 1);
        filter: blur(0) brightness(1);
        transform: scale(1);
      }

      @media (max-width: 768px) {
        /* Smooth momentum scrolling on iOS */
        .story {
          -webkit-overflow-scrolling: touch;
          touch-action: pan-y;
          scroll-snap-type: y mandatory;
          scroll-padding-bottom: 40px; /* Mobile ticker is 40px */
        }

        /* Disable parallax bg overhang on mobile for performance */
        .panel-bg {
          inset: 0;
          width: 100%;
          height: 100%;
        }

        /* Disable hero scroll transitions on mobile */
        .panel--hero .panel-bg {
          transition: none;
        }

        .panel--hero .panel-bg::before {
          background:
            /* Deepened mobile vignette to match desktop mood */
            linear-gradient(
              to bottom,
              rgba(0, 0, 0, 0.75) 0%,
              rgba(0, 0, 0, 0.2) 40%,
              rgba(0, 0, 0, 0.85) 100%
            ),
            /* Side vignettes */
            linear-gradient(
              90deg,
              rgba(0, 0, 0, 0.8) 0%,
              transparent 25%,
              transparent 75%,
              rgba(0, 0, 0, 0.8) 100%
            );
        }

        /* Use portrait-optimized hero on mobile */
        .panel-bg--hero {
          background-image: url('/FRAMES/frame-hero-mobile.webp') !important;
          background-position: center center;
        }
      }

      /* Vignette overlay - disabled to prevent flicker */
      .panel--hero::after {
        display: none;
      }

      /* Hero panel - disable ALL transitions to prevent flicker */
      .panel--hero,
      .panel--hero *,
      .panel--hero::before,
      .panel--hero::after {
        transition: none !important;
        animation-play-state: running; /* Keep intentional animations running */
      }

      /* Hero content always visible - no fade in */
      .panel--hero .panel-content {
        opacity: 1 !important;
        transform: none !important;
      }

      /* Isolate hero to reduce repaints (avoid forcing GPU on text) */
      .panel--hero {
        contain: layout style paint;
        isolation: isolate;
      }

      .panel--hero .panel-bg {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }

      /* Tobias: "The Settle" - Elements arrive with weight */
      @keyframes heroSettle {
        0% {
          opacity: 0;
          transform: translate3d(0, 20px, 0) scale(1.02);  /* More lift, less scale */
          filter: blur(8px);  /* Cleaner entry */
        }
        100% {
          opacity: 1;
          transform: translate3d(0, 0, 0) scale(1);
          filter: blur(0);
        }
      }

      /* Keep simple fade for secondary elements to avoid chaos */
      @keyframes fadeInOnly {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      /* Gate hero animations until the loading screen is dismissed */
      body:not(.is-ready) .panel--hero .event-title,
      body:not(.is-ready) .panel--hero .hero-badge,
      body:not(.is-ready) .panel--hero .hero-tagline,
      body:not(.is-ready) .panel--hero .hero-subtitle,
      body:not(.is-ready) .panel--hero .event-numeral {
        opacity: 0 !important;
      }

      body.is-ready .panel--hero .event-title {
        animation: heroSettle 1.4s cubic-bezier(0.22, 1, 0.36, 1) both !important;
        will-change: transform, filter, opacity;
      }

      body.is-ready .panel--hero .hero-badge,
      body.is-ready .panel--hero .hero-tagline,
      body.is-ready .panel--hero .hero-subtitle,
      body.is-ready .panel--hero .event-numeral {
        animation: fadeInOnly 0.9s ease-out both !important;
        transform: none !important;
      }

      /* Stagger the fade-in timing - CDL 1 badge first, then cascade down */
      /* Tighter stagger = unified reveal, like one "scene" appearing */
      body.is-ready .panel--hero .hero-badge { animation-delay: 0s !important; }
      body.is-ready .panel--hero .event-title { animation-delay: 0.08s !important; }
      body.is-ready .panel--hero .event-numeral { animation-delay: 0.14s !important; }
      body.is-ready .panel--hero .hero-tagline { animation-delay: 0.22s !important; }
      body.is-ready .panel--hero .hero-subtitle { animation-delay: 0.32s !important; }

      /* Kill any ::after shine effects on hero text */
      .panel--hero .event-numeral::after {
        display: none !important;
      }


      /* z-index: 2 - BELOW text (z-index 10+) */
      .panel-overlay {
        position: absolute;
        inset: 0;
        background:
          radial-gradient(
            circle at 50% 50%,
            transparent 20%,
            rgba(0, 0, 0, 0.5) 60%,
            rgba(0, 0, 0, 0.9) 100%
          ),
          linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.4) 0%,
            transparent 30%,
            transparent 70%,
            rgba(0, 0, 0, 0.7) 100%
          );
        pointer-events: none;
        z-index: 2;
      }

      .panel--form .panel-overlay {
        background: 
          radial-gradient(
            circle at 50% 50%,
            transparent 20%,
            rgba(28, 19, 15, 0.5) 60%,
            rgba(28, 19, 15, 0.95) 100%
          ),
          linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.3) 0%,
            rgba(0, 0, 0, 0.6) 100%
          );
      }

      /* Form panel gradient background */
      .panel-bg-gradient {
        position: absolute;
        inset: 0;
        background:
          radial-gradient(ellipse at 50% 0%, rgba(183, 106, 59, 0.15) 0%, transparent 50%),
          radial-gradient(ellipse at 80% 80%, rgba(212, 165, 116, 0.1) 0%, transparent 40%),
          linear-gradient(180deg, #0d0906 0%, #1a120d 50%, #0a0705 100%);
      }

      .panel-headline--form {
        font-size: clamp(2.2rem, 7vw, 3.5rem);
      }

      .panel-content {
        position: relative;
        z-index: 10;
        text-align: center;
        max-width: 900px;
        width: 100%;
        opacity: 0;
        transform: translateY(30px);
        transition:
          opacity 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94),
          transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      .panel.in-view .panel-content {
        opacity: 1;
        transform: translateY(0);
      }

      /* First panel starts visible */
      .panel:first-child .panel-content {
        opacity: 1;
        transform: translateY(0);
      }

      /* ========================================
         BRAND LOCKUP - THE TILE
         The "Primary Mark" (C D over L)
         ======================================== */
      .brand-tile {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 24px;
      }

      .brand-tile__upper {
        display: flex;
        gap: 12px;
        margin-bottom: 16px; /* Negative space spine */
      }

      .brand-tile__letter {
        font-family: "Bodoni Moda", serif;
        font-weight: 700;
        font-size: 56px;
        color: var(--brass);
        line-height: 1;
        letter-spacing: -0.02em;
        text-align: center;
      }

      .brand-tile__lower {
        display: flex;
        justify-content: center;
      }

      /* Event Title - TOURNAMENT I - Tobias: "The Settle" */
      .event-title {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin-bottom: 18px;
      }

      .event-name {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(2.2rem, 11vw, 8rem);
        font-weight: 900;
        font-optical-sizing: auto;
        line-height: 0.85;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.9),
          0 4px 20px rgba(0, 0, 0, 0.7),
          0 8px 40px rgba(0, 0, 0, 0.5);
      }

      @media (min-width: 768px) {
        .event-name {
          letter-spacing: 0.08em;
        }
      }

      .event-numeral {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(5rem, 25vw, 14rem);
        font-weight: 900;
        line-height: 0.75;
        color: var(--cream);
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.9),
          0 6px 20px rgba(0, 0, 0, 0.5),
          0 0 80px rgba(212, 165, 116, 0.2);
        position: relative;
      }

      /* La Salida - THE HERO - Stacked bold treatment */
      /* Matches LA LEY energy - commanding, carved in stone */
      .event-numeral--salida {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        margin: 0;
        position: relative;
      }

      .event-numeral--salida::before {
        content: none;
      }

      .event-numeral--salida::after {
        content: none;
      }

      /* Stacked LA SALIDA lines */
      .salida-line {
        font-family: "Bodoni Moda", serif;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        line-height: 0.82;
        color: rgba(255, 252, 245, 0.7);
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      }

      /* "LA" - the setup */
      .salida-line:first-child {
        font-size: clamp(2.2rem, 8vw, 5rem);
      }

      /* "SALIDA" - THE EXIT. The moment of truth. */
      /* Reduced from 7 to 4 layers - hero shouldn't outshine the climax */
      .salida-line--main {
        font-size: clamp(4.5rem, 18vw, 12rem);
        color: var(--cream);
        text-shadow:
          0 0 20px rgba(255, 252, 245, 0.4),
          0 0 50px rgba(212, 165, 116, 0.4),
          0 0 80px rgba(212, 165, 116, 0.2),
          0 4px 25px rgba(0, 0, 0, 0.85);
        filter: brightness(1.05);
      }

      /* Metallic shine effect on numeral */
      .event-numeral::after {
        content: "I";
        position: absolute;
        left: 0;
        top: 0;
        background: linear-gradient(
          135deg,
          transparent 20%,
          rgba(255, 255, 255, 0.4) 40%,
          rgba(255, 255, 255, 0.4) 60%,
          transparent 80%
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 3s ease-in-out infinite;
      }

      @keyframes shine {
        0%, 100% { opacity: 0; }
        50% { opacity: 1; }
      }

      /* ============================================
         HERO BADGE - Domino tile (Bone Language)
         Smaller version of slam-badge for hero
         ============================================ */
      .hero-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 52px;
        height: 72px;
        margin: 0 auto 20px auto;
        background: linear-gradient(
          145deg,
          rgba(20, 14, 10, 0.9) 0%,
          rgba(12, 8, 5, 0.95) 100%
        );
        border: 2px solid var(--brass);
        border-radius: 10px;
        position: relative;
        box-shadow:
          0 0 20px rgba(212, 165, 116, 0.25),
          0 0 40px rgba(212, 165, 116, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 6px 24px rgba(0, 0, 0, 0.5);
      }

      .hero-badge::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 8px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.1) 100%
        );
        pointer-events: none;
      }

      .hero-badge__top,
      .hero-badge__bottom {
        font-family: "Bodoni Moda", serif;
        font-weight: 900;
        font-style: italic;
        letter-spacing: 0.08em;
        /* Brass-to-copper gradient — matches footer CDL */
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .hero-badge__top {
        font-size: 0.85rem;
        margin-top: 8px;
      }

      .hero-badge__divider {
        width: 36px;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--brass) 20%,
          var(--brass) 80%,
          transparent 100%
        );
        margin: 5px 0;
        opacity: 0.6;
      }

      .hero-badge__bottom {
        font-size: 1.4rem;
        font-style: italic;
        margin-bottom: 6px;
      }

      /* Mobile - slightly smaller */
      @media (max-width: 768px) {
        .hero-badge {
          width: 46px;
          height: 64px;
          margin: 0 auto 16px auto;
        }

        .hero-badge__top {
          font-size: 0.75rem;
          margin-top: 7px;
        }

        .hero-badge__divider {
          width: 30px;
          margin: 4px 0;
        }

        .hero-badge__bottom {
          font-size: 1.2rem;
          margin-bottom: 5px;
        }
      }

      /* Hero tagline - Championship stamp with decorative lines */
      /* Tobias: Clear hierarchy - this is the WHAT */
      .hero-tagline {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: clamp(0.65rem, 2.2vw, 0.85rem);
        font-weight: 600;
        color: var(--cream);
        text-transform: uppercase;
        letter-spacing: 0.18em;
        margin-top: 24px;
        margin-bottom: 14px;
        opacity: 1;
        text-shadow:
          0 0 20px rgba(0, 0, 0, 0.95),
          0 2px 15px rgba(0, 0, 0, 0.9);
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        position: relative;
      }

      /* Decorative lines on sides - championship banner feel */
      .hero-tagline::before,
      .hero-tagline::after {
        content: "";
        width: clamp(20px, 8vw, 60px);
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, var(--brass) 50%, transparent 100%);
        opacity: 0.6;
      }

      /* Hero subtitle - practical info (date + venue) */
      /* Tobias: WHERE/WHEN - readable but doesn't compete with title */
      .hero-subtitle {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: clamp(0.7rem, 1.6vw, 0.85rem);
        font-weight: 500;
        color: var(--cream);
        opacity: 0.78;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        margin-top: 6px;
        text-shadow:
          0 0 15px rgba(0, 0, 0, 0.95),
          0 2px 10px rgba(0, 0, 0, 0.9);
      }
      .hero-subtitle a {
        color: var(--brass);
        text-decoration: none;
        border-bottom: 1px solid rgba(212, 165, 116, 0.3);
        transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        display: inline-block; /* Required for transform */
      }
      .hero-subtitle a:hover {
        color: var(--cream);
        border-bottom-color: var(--cream);
        transform: translateY(-2px); /* Tobias: The Lift */
        text-shadow: 0 4px 12px rgba(0,0,0,0.5);
      }

      .hero-subtitle .dot {
        display: inline-block;
        margin: 0 0.5em;
        opacity: 0.5;
      }

      /* MOBILE HERO ENHANCEMENTS - 99% of users are on iPhone */
      @media (max-width: 768px) {
        /* La Salida stacked treatment on mobile */
        .salida-line:first-child {
          font-size: clamp(1.8rem, 8vw, 3.5rem);
        }

        .salida-line--main {
          font-size: clamp(3.5rem, 18vw, 8rem);
          filter: brightness(1.1);
          text-shadow:
            0 0 12px rgba(255, 252, 245, 0.7),
            0 0 35px rgba(255, 252, 245, 0.4),
            0 0 60px rgba(212, 165, 116, 0.6),
            0 0 100px rgba(212, 165, 116, 0.4),
            0 4px 20px rgba(0, 0, 0, 0.95),
            0 8px 40px rgba(0, 0, 0, 0.8);
        }

        /* Tagline bigger on mobile for readability */
        .hero-tagline {
          font-size: clamp(0.6rem, 3vw, 0.8rem);
          letter-spacing: 0.14em;
          gap: 12px;
        }

        /* Date/venue more prominent on mobile */
        .hero-subtitle {
          font-size: clamp(0.68rem, 2.8vw, 0.82rem);
          opacity: 0.82;
          letter-spacing: 0.1em;
        }
      }

      .mesa-live-text span {
        color: var(--brass);
        font-weight: 600;
      }

      /* Typography - Bodoni Moda Black for vintage cigar lounge elegance */
      .panel-headline {
        font-family: "Bodoni Moda", "Didot", "Times New Roman", serif;
        font-size: clamp(2.2rem, 10vw, 6.5rem);
        font-weight: 900;
        font-optical-sizing: auto;
        line-height: 1.1;
        margin-bottom: 20px;
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.9),
          0 4px 20px rgba(0, 0, 0, 0.7),
          0 8px 40px rgba(0, 0, 0, 0.5);
        letter-spacing: 0.06em;
      }

      /* Panel 3 crescendo - extra tension */
      .panel:nth-child(3) .panel-headline {
        letter-spacing: 0.04em;
        font-size: clamp(2.4rem, 11vw, 7rem);
      }

      @media (min-width: 768px) {
        .panel-headline {
          font-size: clamp(3.2rem, 12vw, 6.5rem);
          letter-spacing: 0.08em;
        }

        .panel:nth-child(3) .panel-headline {
          letter-spacing: 0.06em;
          font-size: clamp(3.5rem, 13vw, 7rem);
        }
      }

      .nowrap {
        white-space: nowrap;
      }

      .panel-headline .accent {
        color: inherit;
        font-style: italic;
      }

      .panel-headline .accent--italic {
        font-family: "Bodoni Moda", "Didot", serif;
        font-weight: 400;
        font-style: italic;
      }

      .panel-subtitle {
        font-size: clamp(1.1rem, 3.5vw, 1.6rem);
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        text-shadow:
          0 2px 8px rgba(0, 0, 0, 0.8),
          0 4px 20px rgba(0, 0, 0, 0.5);
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .panel-subtitle--italic {
        font-family: "Bodoni Moda", "Didot", serif;
        font-style: italic;
        font-weight: 400;
        text-transform: none;
        letter-spacing: 0.02em;
      }

      /* Panel greeting - small Cuban welcome quote */
      .panel-greeting {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        font-style: italic;
        font-weight: 400;
        color: var(--brass);
        letter-spacing: 0.15em;
        margin-bottom: 1.5em;
        opacity: 0.9;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        animation: fadeInUp 0.8s ease-out 0.2s both;
      }

      /* Whisper subtitle - elegant italic like "presents" */
      .panel-whisper {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(1rem, 3.5vw, 1.8rem);
        font-style: italic;
        font-weight: 400;
        color: rgba(248, 239, 230, 0.55); /* Softer cream for "memory" feel */
        letter-spacing: 0.15em;
        margin-top: 0.6em;
        text-shadow:
          0 2px 10px rgba(0, 0, 0, 0.9);
        animation: fadeIn 2s ease-out 0.5s both;
      }

      /* ========================================
         CINEMATIC STORYTELLING - Three Scenes
         Scene 1: The Whisper (greeting + tension)
         Scene 2: The Revelation (the twist)
         Scene 3: The Stakes (winner takes all)
         ======================================== */

      /* ================================================
         SCENE 1: THE CINEMATIC FRAME
         Letterbox bars create intentional text zones.
         This is CINEMA, not a legibility hack.
         Top = His greeting. Bottom = The tension.
         Center = The man, unobstructed.
         ================================================ */

      .panel--whisper {
        justify-content: center;
        align-items: center;
        padding: 0;
      }

      .panel--whisper .whisper-top,
      .panel--whisper .whisper-bottom {
        opacity: 0;
        transition: opacity 420ms ease;
      }

      .panel--whisper.in-view .whisper-top,
      .panel--whisper.in-view .whisper-bottom {
        opacity: 1;
      }

      /* Revisit: subtle "breath" (not a full replay) to keep the room alive */
      .panel--whisper.reentering .whisper-top,
      .panel--whisper.reentering .whisper-bottom,
      .panel--build.reentering .build-top,
      .panel--build.reentering .build-center,
      .panel--build.reentering .build-bottom,
      .panel--slam.reentering .slam-top,
      .panel--slam.reentering .slam-center,
      .panel--slam.reentering .slam-bottom {
        animation: revisitBreath 380ms ease-out both;
      }

      /* Rules plaque - separate animation without opacity (has transparent bg) */
      .panel--rules.reentering .rules-plaque {
        animation: revisitBreathNoOpacity 380ms ease-out both;
      }

      /* Form panel - subtle breath on re-entry */
      .panel--form.reentering .form-shell,
      .panel--form.reentering .progress-tracker {
        animation: revisitBreath 380ms ease-out both;
      }

      @keyframes revisitBreathNoOpacity {
        from { transform: translateY(2px) scale(1.01); }
        to { transform: translateY(0) scale(1); }
      }

      @keyframes revisitBreath {
        from { opacity: 0.82; transform: translateY(2px) scale(1.01); }
        to { opacity: 1; transform: translateY(0) scale(1); }
      }

      /* iOS fix: ensure full opacity when panel is in view */
      .panel--whisper.in-view .whisper-top,
      .panel--whisper.in-view .whisper-bottom {
        opacity: 1;
      }

      /* TOP LETTERBOX - Setup whisper + Greeting converge from different directions */
      .whisper-top {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 8vh 6vw 12vh;
        background: linear-gradient(
          to bottom,
          rgba(10, 7, 5, 0.95) 0%,
          rgba(10, 7, 5, 0.8) 40%,
          rgba(10, 7, 5, 0.3) 75%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        flex-direction: column;
        align-items: stretch; /* Allow children to position themselves */
        gap: 2vh;
        pointer-events: none;
      }

      /* "Que bola asere" - Drifts in from the RIGHT like smoke curling */
      .whisper-greeting {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 500;  /* Warmer, more readable on mobile */
        font-size: clamp(1.4rem, 5vw, 2.2rem);
        color: var(--brass);
        letter-spacing: 0.03em;
        text-transform: none;
        text-align: right;  /* Right-aligned - asymmetric */
        align-self: flex-end;  /* Push to right */
        padding-right: 6vw;
        opacity: 0;
        margin-bottom: 1vh;
        text-shadow:
          0 0 30px rgba(212, 165, 116, 0.5),
          0 0 60px rgba(212, 165, 116, 0.25),
          0 2px 15px rgba(0, 0, 0, 0.6);
      }

      /* "This table remembers." - Emerges from blur in CENTER (the room whispers) */
      /* Voice differentiation: More ghostly than greeting (45% vs brass) */
      .whisper-setup {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: clamp(1rem, 3.5vw, 1.3rem);  /* Slightly larger */
        color: rgba(248, 239, 230, 0.55);  /* Cream @ 55% — still ethereal, more readable */
        letter-spacing: 0.05em;
        text-align: center;  /* Centered - the room */
        align-self: center;
        opacity: 0;
        text-shadow:
          0 0 25px rgba(248, 239, 230, 0.2),
          0 2px 10px rgba(0, 0, 0, 0.5);
      }

      /* BOTTOM LETTERBOX - The recognition slides from LEFT (asymmetric payoff) */
      .whisper-bottom {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 8vh 6vw 16vh;
        background: linear-gradient(
          to top,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.85) 35%,
          rgba(10, 7, 5, 0.4) 70%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* LEFT-aligned - asymmetry */
        text-align: left;
        pointer-events: none;
      }

      .whisper-narrative {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 1.2vh;
      }

      .whisper-line {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        color: var(--brass);
        opacity: 0;
        transition: opacity 420ms ease;
        letter-spacing: 0.05em;
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      }

      /* THE LINE - "You've sat here before." - LARGEST, emerges from below */
      /* Typography: IBM PLEX SANS = RECOGNITION VOICE (different instrument) */
      /* Lin-Manuel: When the room speaks DIRECTLY to YOU, the font shifts */
      /* Visual cohesion: Increased size (~15%) for stronger hierarchy contrast */
      .whisper-line--ancestors {
        font-family: 'IBM Plex Sans', sans-serif;  /* RECOGNITION VOICE - modern, direct */
        font-size: clamp(2.1rem, 8vw, 3.7rem);  /* Increased ~15% - the payoff dominates */
        font-style: normal;  /* UPRIGHT - statement of fact, not whisper */
        font-weight: 700;    /* BOLD - recognition lands with full weight */
        color: #fff;
        letter-spacing: 0.04em;
        padding-left: 6vw;  /* Left offset */
        text-align: left;
        margin-top: 2.5vh;  /* Breathing room - pause before recognition */
        margin-bottom: 4vh;
        text-shadow:
          0 0 35px rgba(255, 255, 255, 0.35),
          0 0 60px rgba(212, 165, 116, 0.6),
          0 0 100px rgba(212, 165, 116, 0.35),
          0 4px 30px rgba(0, 0, 0, 0.85);
      }

      /* "They" — the ancestors, emphasized in brass */
      .ancestors-they {
        font-style: normal;
        color: var(--brass);
        text-shadow:
          0 0 30px rgba(212, 165, 116, 0.8),
          0 0 60px rgba(212, 165, 116, 0.5),
          0 0 100px rgba(212, 165, 116, 0.3);
      }

      /* Animation for main line - the recognition statement */
      /* Emerges THIRD - smooth fade-up (memory surfacing), lands SOLID */
      /* THE moment: ancestor recognizes YOU. Must emerge from SILENCE. */
      /* Lin-Manuel: THE BREATH - 1.2s silence before recognition lands */
      .panel--whisper.in-view:not(.has-played) .whisper-line--ancestors {
        animation: recognitionSlide 1.8s cubic-bezier(0.16, 1, 0.3, 1) 5.0s forwards;  /* 5.0s delay - 1.2s silence after greeting lands */
      }

      /* Recognition statement - SMOOTH fade-up from blur (memory surfacing) */
      /* Tobias: Small translations (60% reduction), blur as memory */
      /* Visual cohesion: Strengthened final glow to match payoff prominence */
      @keyframes recognitionSlide {
        0% {
          opacity: 0;
          transform: translateY(20px);
          filter: blur(6px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
          text-shadow:
            0 0 40px rgba(255, 255, 255, 0.4),
            0 0 70px rgba(212, 165, 116, 0.6),
            0 0 110px rgba(212, 165, 116, 0.35),
            0 4px 30px rgba(0, 0, 0, 0.85);
        }
      }

      /* Table doesn't dance. It SITS there. Solid. */
      .panel--whisper.has-played .whisper-line--ancestors {
        opacity: 1;
        transform: none;
        filter: none;
        text-shadow:
          0 0 40px rgba(255, 255, 255, 0.4),
          0 0 70px rgba(212, 165, 116, 0.6),
          0 0 110px rgba(212, 165, 116, 0.35),
          0 4px 30px rgba(0, 0, 0, 0.85);
      }

      /* THE LINE - The challenge that sets up INHERITED */
      .whisper-line--mystery {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.3em;
        font-style: italic;
        font-weight: 400;
        color: var(--cream);
        letter-spacing: 0.02em;
        margin-top: 2vh;
        text-shadow:
          0 0 30px rgba(212, 165, 116, 0.4),
          0 4px 25px rgba(0, 0, 0, 0.6);
      }

      /* Top line - smaller setup */
      .whisper-line__top {
        font-size: clamp(1.4rem, 5vw, 2rem);
        opacity: 0.85;
      }

      /* Bottom line - THE moment with "learned" */
      .whisper-line__bottom {
        font-size: clamp(2.2rem, 9vw, 4rem);
        font-weight: 500;
      }

      /* Callback word "learned" - brass glow thread to Panel 3 */
      .callback-word {
        font-style: italic;
        color: var(--brass);
        text-shadow:
          0 0 25px rgba(212, 165, 116, 0.7),
          0 0 50px rgba(212, 165, 116, 0.4);
      }

      /* Cinematic animations - SMOOTH emergence, no bounce */
      /* Lin-Manuel: "Build the pauses into the animation timing. The words that matter need room to BREATHE." */
      /* Tobias: "Text isn't a domino tile. It shouldn't SLAM. Text should EMERGE — like smoke, like memory surfacing." */

      /* NEW TIMELINE (3-beat reveal: Room → Greeting → Recognition):
         Lin-Manuel: "Silence isn't empty. It's where the feeling lives."

         0.3s: "This table remembers." emerges from blur (1.2s, the room whispers)
         1.5s: Animation complete
         ← 0.8s SILENCE (room settles)
         2.3s: "Que bola asere" drifts in (1.5s smoke emerge)
         3.8s: Animation complete
         ← 1.2s SILENCE (greeting lands, THE BREATH)
         5.0s: "You've sat here before." emerges (1.8s memory surface)
         6.8s: Animation complete
         ← 1.2s SILENCE (recognition sinks in)
         8.0s: Scroll hint fades in

         Total: 8.0s (+2.4s of meaningful silence - THE BREATH before recognition)
      */

      .panel--whisper.in-view:not(.has-played) .whisper-setup {
        animation: setupEmerge 1.2s cubic-bezier(0.16, 1, 0.3, 1) 0.3s forwards;  /* 0.3s delay */
      }

      .panel--whisper.in-view:not(.has-played) .whisper-greeting {
        animation: greetingDrift 1.5s ease-out 2.3s forwards;
      }

      /* ===== GREETING EMBERS - alive, present, welcoming ===== */
      /* Embers rise from the greeting like warmth from a familiar voice */

      .whisper-greeting-wrap {
        position: relative;
        display: inline-block;
      }

      /* Text glow - the ember source */
      .panel--whisper.in-view .whisper-greeting {
        text-shadow:
          0 0 30px rgba(255, 180, 100, 0.4),
          0 0 60px rgba(255, 180, 100, 0.2),
          0 0 100px rgba(212, 165, 116, 0.15);
        animation: textEmberGlow 4s ease-in-out infinite;
      }

      @keyframes textEmberGlow {
        0%, 100% {
          text-shadow:
            0 0 30px rgba(255, 180, 100, 0.4),
            0 0 60px rgba(255, 180, 100, 0.2),
            0 0 100px rgba(212, 165, 116, 0.15);
        }
        50% {
          text-shadow:
            0 0 40px rgba(255, 180, 100, 0.5),
            0 0 80px rgba(255, 180, 100, 0.3),
            0 0 120px rgba(212, 165, 116, 0.2);
        }
      }

      /* Color temperature variants */
      :root {
        --ember-hot: rgba(255, 210, 140, 0.95);
        --ember-warm: rgba(255, 180, 100, 0.9);
        --ember-cool: rgba(220, 150, 90, 0.75);
        --ember-sepia: rgba(195, 160, 110, 0.65);
      }

      .greeting-ember {
        position: absolute;
        width: 3px;
        height: 3px;
        background: var(--ember-warm);
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
        filter: blur(0.5px);
        will-change: transform, opacity;
      }

      /* Size variants with glow halos */
      .greeting-ember--lg {
        width: 5px;
        height: 5px;
        filter: blur(0.3px);
        box-shadow:
          0 0 6px var(--ember-hot),
          0 0 12px rgba(255, 180, 100, 0.4);
      }
      .greeting-ember--md { width: 3px; height: 3px; filter: blur(0.5px); }
      .greeting-ember--sm {
        width: 2px;
        height: 2px;
        filter: blur(1px);
        background: var(--ember-cool);
      }

      /* Temperature variants */
      .greeting-ember--hot { background: var(--ember-hot); }
      .greeting-ember--cool { background: var(--ember-cool); }

      /* Spark variant - brighter ignition flash for recognition moment */
      .greeting-ember--spark {
        background: var(--ember-hot);
        box-shadow:
          0 0 8px var(--ember-hot),
          0 0 16px rgba(255, 210, 140, 0.6);
      }

      /* Micro-mote layer - atmospheric depth particles */
      .greeting-mote {
        position: absolute;
        width: 1px;
        height: 1px;
        background: var(--ember-cool);
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
        filter: blur(1.5px);
        will-change: transform, opacity;
      }

      /* 10 embers clustered at text center, rising outward */
      .greeting-ember:nth-child(2)  { left: 45%; top: 50%; }
      .greeting-ember:nth-child(3)  { left: 50%; top: 45%; }
      .greeting-ember:nth-child(4)  { left: 55%; top: 50%; }
      .greeting-ember:nth-child(5)  { left: 48%; top: 55%; }
      .greeting-ember:nth-child(6)  { left: 52%; top: 48%; }
      .greeting-ember:nth-child(7)  { left: 46%; top: 52%; }
      .greeting-ember:nth-child(8)  { left: 54%; top: 46%; }
      .greeting-ember:nth-child(9)  { left: 49%; top: 54%; }
      .greeting-ember:nth-child(10) { left: 51%; top: 49%; }
      .greeting-ember:nth-child(11) { left: 47%; top: 51%; }

      /* Micro-motes positioned for atmospheric depth */
      .greeting-mote:nth-child(12) { left: 43%; top: 47%; }
      .greeting-mote:nth-child(13) { left: 57%; top: 53%; }
      .greeting-mote:nth-child(14) { left: 50%; top: 42%; }

      /* ===== ORGANIC EMBER PATHS - 8-step journeys matching loading screen ===== */

      /* Path A: Drifts right with gentle sine wave + double-beat breathing */
      @keyframes greetingEmberA {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.2);
        }
        5% {
          opacity: 0.9; /* Spark flash */
          transform: translateY(-8px) translateX(2px) rotate(15deg) scale(0.8);
        }
        15% {
          opacity: 0.75;
          transform: translateY(-25px) translateX(8px) rotate(40deg) scale(1);
        }
        30% {
          opacity: 0.68; /* Micro-flicker */
          transform: translateY(-50px) translateX(5px) rotate(75deg) scale(0.9);
        }
        42% {
          opacity: 0.62;
          transform: translateY(-68px) translateX(10px) rotate(100deg) scale(1.08); /* Lub */
        }
        48% {
          opacity: 0.58;
          transform: translateY(-78px) translateX(12px) rotate(115deg) scale(0.95); /* Dub */
        }
        54% {
          opacity: 0.55;
          transform: translateY(-85px) translateX(11px) rotate(128deg) scale(1.05); /* Settle */
        }
        65% {
          opacity: 0.42;
          transform: translateY(-98px) translateX(8px) rotate(155deg) scale(0.78);
        }
        80% {
          opacity: 0.22;
          transform: translateY(-115px) translateX(15px) rotate(200deg) scale(0.48);
        }
        90% {
          opacity: 0.1;
          transform: translateY(-128px) translateX(18px) rotate(230deg) scale(0.32);
        }
        100% {
          opacity: 0;
          transform: translateY(-140px) translateX(20px) rotate(260deg) scale(0.2);
        }
      }

      /* Path A with spark variant - brighter recognition flash */
      @keyframes greetingEmberASpark {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.2);
        }
        3% {
          opacity: 1.0; /* Bright recognition flash */
          transform: translateY(-4px) translateX(1px) rotate(8deg) scale(1.3);
        }
        8% {
          opacity: 0.85;
          transform: translateY(-12px) translateX(3px) rotate(20deg) scale(0.9);
        }
        18% {
          opacity: 0.72;
          transform: translateY(-28px) translateX(9px) rotate(45deg) scale(1);
        }
        32% {
          opacity: 0.65;
          transform: translateY(-52px) translateX(6px) rotate(78deg) scale(0.88);
        }
        45% {
          opacity: 0.58;
          transform: translateY(-72px) translateX(11px) rotate(108deg) scale(1.06);
        }
        52% {
          opacity: 0.52;
          transform: translateY(-82px) translateX(13px) rotate(125deg) scale(0.92);
        }
        65% {
          opacity: 0.38;
          transform: translateY(-98px) translateX(9px) rotate(158deg) scale(0.72);
        }
        82% {
          opacity: 0.18;
          transform: translateY(-118px) translateX(16px) rotate(205deg) scale(0.42);
        }
        100% {
          opacity: 0;
          transform: translateY(-142px) translateX(21px) rotate(265deg) scale(0.18);
        }
      }

      /* Warming transition - particle warms from cool to hot as it rises */
      @keyframes greetingEmberWarming {
        0% {
          opacity: 0;
          background: var(--ember-cool);
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.25);
        }
        6% {
          opacity: 0.85;
          background: var(--ember-cool);
          transform: translateY(-10px) translateX(-2px) rotate(-18deg) scale(0.85);
        }
        20% {
          opacity: 0.72;
          background: var(--ember-warm);
          transform: translateY(-32px) translateX(-8px) rotate(-45deg) scale(1);
        }
        40% {
          opacity: 0.62;
          background: var(--ember-warm);
          transform: translateY(-58px) translateX(-5px) rotate(-82deg) scale(1.05);
        }
        55% {
          opacity: 0.52;
          background: var(--ember-hot);
          transform: translateY(-78px) translateX(-12px) rotate(-120deg) scale(0.92);
        }
        70% {
          opacity: 0.35;
          background: var(--ember-hot);
          transform: translateY(-98px) translateX(-9px) rotate(-165deg) scale(0.68);
        }
        88% {
          opacity: 0.15;
          background: var(--ember-hot);
          transform: translateY(-122px) translateX(-16px) rotate(-215deg) scale(0.38);
        }
        100% {
          opacity: 0;
          background: var(--ember-hot);
          transform: translateY(-145px) translateX(-20px) rotate(-260deg) scale(0.15);
        }
      }

      /* Micro-mote path - tiny atmospheric particles with more drift */
      @keyframes greetingMote {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) scale(0.5);
        }
        10% {
          opacity: 0.45;
          transform: translateY(-5px) translateX(3px) scale(0.8);
        }
        35% {
          opacity: 0.4;
          transform: translateY(-20px) translateX(-5px) scale(1);
        }
        60% {
          opacity: 0.3;
          transform: translateY(-45px) translateX(8px) scale(0.9);
        }
        85% {
          opacity: 0.15;
          transform: translateY(-70px) translateX(-3px) scale(0.6);
        }
        100% {
          opacity: 0;
          transform: translateY(-90px) translateX(5px) scale(0.4);
        }
      }

      /* Path B: Drifts left with double-beat breathing */
      @keyframes greetingEmberB {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.25);
        }
        6% {
          opacity: 0.95; /* Spark flash */
          transform: translateY(-10px) translateX(-3px) rotate(-20deg) scale(0.85);
        }
        18% {
          opacity: 0.78;
          transform: translateY(-30px) translateX(-10px) rotate(-50deg) scale(1);
        }
        32% {
          opacity: 0.65;
          transform: translateY(-52px) translateX(-6px) rotate(-85deg) scale(0.92);
        }
        44% {
          opacity: 0.58;
          transform: translateY(-70px) translateX(-12px) rotate(-115deg) scale(1.08); /* Lub */
        }
        50% {
          opacity: 0.52;
          transform: translateY(-80px) translateX(-14px) rotate(-130deg) scale(0.95); /* Dub */
        }
        56% {
          opacity: 0.48;
          transform: translateY(-88px) translateX(-12px) rotate(-148deg) scale(1.03); /* Settle */
        }
        68% {
          opacity: 0.35;
          transform: translateY(-102px) translateX(-10px) rotate(-178deg) scale(0.68);
        }
        85% {
          opacity: 0.18;
          transform: translateY(-125px) translateX(-18px) rotate(-222deg) scale(0.38);
        }
        92% {
          opacity: 0.08;
          transform: translateY(-138px) translateX(-20px) rotate(-252deg) scale(0.25);
        }
        100% {
          opacity: 0;
          transform: translateY(-150px) translateX(-22px) rotate(-280deg) scale(0.15);
        }
      }

      /* Path C: Mostly vertical with subtle sway + double-beat breathing */
      @keyframes greetingEmberC {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.3);
        }
        4% {
          opacity: 0.85; /* Spark flash */
          transform: translateY(-12px) translateX(1px) rotate(10deg) scale(0.9);
        }
        16% {
          opacity: 0.73;
          transform: translateY(-35px) translateX(-3px) rotate(35deg) scale(1);
        }
        30% {
          opacity: 0.62;
          transform: translateY(-58px) translateX(3px) rotate(65deg) scale(0.88);
        }
        43% {
          opacity: 0.55;
          transform: translateY(-75px) translateX(-1px) rotate(95deg) scale(1.08); /* Lub */
        }
        49% {
          opacity: 0.5;
          transform: translateY(-85px) translateX(-2px) rotate(112deg) scale(0.95); /* Dub */
        }
        55% {
          opacity: 0.45;
          transform: translateY(-92px) translateX(2px) rotate(128deg) scale(1.05); /* Settle */
        }
        68% {
          opacity: 0.32;
          transform: translateY(-108px) translateX(4px) rotate(162deg) scale(0.62);
        }
        84% {
          opacity: 0.14;
          transform: translateY(-128px) translateX(-1px) rotate(212deg) scale(0.38);
        }
        92% {
          opacity: 0.06;
          transform: translateY(-138px) translateX(1px) rotate(242deg) scale(0.28);
        }
        100% {
          opacity: 0;
          transform: translateY(-148px) translateX(3px) rotate(270deg) scale(0.18);
        }
      }

      /* Staggered timing - embers emerge WITH text entrance (2.3s greeting delay) */
      /* Synced with "Que Bola Asere" text animation for cohesive feel */
      .panel--whisper.in-view .greeting-ember:nth-child(2) {
        animation: greetingEmberA 6.5s ease-out 2.5s infinite;
      }
      .panel--whisper.in-view .greeting-ember:nth-child(3) {
        animation: greetingEmberB 7.2s ease-out 2.7s infinite;
      }
      .panel--whisper.in-view .greeting-ember:nth-child(4) {
        animation: greetingEmberC 6.8s ease-out 2.9s infinite;
      }
      /* Spark variant - brighter recognition flash */
      .panel--whisper.in-view .greeting-ember:nth-child(5) {
        animation: greetingEmberASpark 7.5s ease-out 3.1s infinite;
      }
      .panel--whisper.in-view .greeting-ember:nth-child(6) {
        animation: greetingEmberB 6.3s ease-out 3.4s infinite;
      }
      /* Warming transition - cool to hot as it rises */
      .panel--whisper.in-view .greeting-ember:nth-child(7) {
        animation: greetingEmberWarming 7.0s ease-out 3.7s infinite;
      }
      .panel--whisper.in-view .greeting-ember:nth-child(8) {
        animation: greetingEmberA 6.6s ease-out 4.0s infinite;
      }
      /* Another spark variant */
      .panel--whisper.in-view .greeting-ember:nth-child(9) {
        animation: greetingEmberASpark 7.3s ease-out 4.3s infinite;
      }
      /* Another warming transition */
      .panel--whisper.in-view .greeting-ember:nth-child(10) {
        animation: greetingEmberWarming 6.4s ease-out 4.6s infinite;
      }
      .panel--whisper.in-view .greeting-ember:nth-child(11) {
        animation: greetingEmberA 7.1s ease-out 4.9s infinite;
      }

      /* Micro-mote animations - atmospheric depth (synced with embers) */
      .panel--whisper.in-view .greeting-mote:nth-child(12) {
        animation: greetingMote 8.5s ease-out 2.9s infinite;
      }
      .panel--whisper.in-view .greeting-mote:nth-child(13) {
        animation: greetingMote 9.2s ease-out 3.7s infinite;
      }
      .panel--whisper.in-view .greeting-mote:nth-child(14) {
        animation: greetingMote 7.8s ease-out 4.5s infinite;
      }


      /* ===== LINEAGE DUST - ancestral memory, dust in afternoon light ===== */
      /* These drift horizontally like motes catching light through a window */

      .lineage-dust-wrap {
        position: relative;
        display: inline-block;
      }

      /* Text glow - softer, more nostalgic */
      .panel--build.in-view .build-family__line--generations {
        text-shadow:
          0 0 25px rgba(255, 180, 100, 0.3),
          0 0 50px rgba(212, 165, 116, 0.15);
        animation: lineageTextGlow 5s ease-in-out infinite;
      }

      @keyframes lineageTextGlow {
        0%, 100% {
          text-shadow:
            0 0 25px rgba(255, 180, 100, 0.3),
            0 0 50px rgba(212, 165, 116, 0.15);
        }
        50% {
          text-shadow:
            0 0 35px rgba(255, 180, 100, 0.4),
            0 0 70px rgba(212, 165, 116, 0.25);
        }
      }

      .lineage-dust {
        position: absolute;
        width: 3px;
        height: 3px;
        background: var(--ember-warm);
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
        filter: blur(0.5px);
        will-change: transform, opacity;
      }

      .lineage-dust--lg {
        width: 4px;
        height: 4px;
        filter: blur(0.3px);
        box-shadow:
          0 0 5px var(--ember-warm),
          0 0 10px rgba(255, 180, 100, 0.3);
      }
      .lineage-dust--md { width: 3px; height: 3px; filter: blur(0.5px); }
      .lineage-dust--sm {
        width: 2px;
        height: 2px;
        filter: blur(1.2px);
        background: var(--ember-cool);
      }

      /* Sepia variant - nostalgic tone for ancestral dust */
      .lineage-dust--sepia {
        background: var(--ember-sepia);
        box-shadow:
          0 0 4px rgba(195, 160, 110, 0.4),
          0 0 8px rgba(195, 160, 110, 0.2);
      }

      /* 10 particles in the space between tío and father */
      .lineage-dust:nth-child(2)  { left: 42%; top: 40%; }
      .lineage-dust:nth-child(3)  { left: 48%; top: 50%; }
      .lineage-dust:nth-child(4)  { left: 45%; top: 35%; }
      .lineage-dust:nth-child(5)  { left: 52%; top: 55%; }
      .lineage-dust:nth-child(6)  { left: 46%; top: 60%; }
      .lineage-dust:nth-child(7)  { left: 50%; top: 45%; }
      .lineage-dust:nth-child(8)  { left: 44%; top: 52%; }
      .lineage-dust:nth-child(9)  { left: 54%; top: 42%; }
      .lineage-dust:nth-child(10) { left: 47%; top: 58%; }
      .lineage-dust:nth-child(11) { left: 51%; top: 48%; }

      /* ===== LINEAGE DUST PATHS - Horizontal drift like dust in sunlight ===== */
      /* Reduced rotation (max 45-60deg) - dust tumbles gently, doesn't spin */
      /* Extended fade-out (25% tail) - memories linger, don't vanish suddenly */

      /* Path A: Drifts right, settling slowly - reduced rotation */
      @keyframes lineageDustA {
        0% {
          opacity: 0;
          transform: translate(0, 0) rotate(0deg) scale(0.2);
        }
        8% {
          opacity: 0.7; /* Gentle spark */
          transform: translate(8px, -4px) rotate(8deg) scale(0.9);
        }
        25% {
          opacity: 0.6;
          transform: translate(25px, 2px) rotate(18deg) scale(1);
        }
        42% {
          opacity: 0.55;
          transform: translate(42px, 6px) rotate(28deg) scale(1.08); /* Lub */
        }
        48% {
          opacity: 0.52;
          transform: translate(48px, 10px) rotate(32deg) scale(0.95); /* Dub */
        }
        54% {
          opacity: 0.48;
          transform: translate(55px, 12px) rotate(36deg) scale(1.03); /* Settle */
        }
        70% {
          opacity: 0.35;
          transform: translate(70px, 18px) rotate(45deg) scale(0.82);
        }
        85% {
          opacity: 0.18;
          transform: translate(82px, 26px) rotate(52deg) scale(0.55);
        }
        /* Extended 25% fade tail */
        92% {
          opacity: 0.08;
          transform: translate(88px, 30px) rotate(56deg) scale(0.38);
        }
        100% {
          opacity: 0;
          transform: translate(95px, 35px) rotate(60deg) scale(0.22);
        }
      }

      /* Path B: Drifts left, slightly rising - reduced rotation */
      @keyframes lineageDustB {
        0% {
          opacity: 0;
          transform: translate(0, 0) rotate(0deg) scale(0.25);
        }
        10% {
          opacity: 0.65; /* Gentle spark */
          transform: translate(-10px, -6px) rotate(-10deg) scale(0.95);
        }
        28% {
          opacity: 0.55;
          transform: translate(-30px, -2px) rotate(-22deg) scale(1);
        }
        44% {
          opacity: 0.5;
          transform: translate(-48px, 3px) rotate(-32deg) scale(1.08); /* Lub */
        }
        50% {
          opacity: 0.46;
          transform: translate(-55px, 6px) rotate(-36deg) scale(0.94); /* Dub */
        }
        56% {
          opacity: 0.42;
          transform: translate(-62px, 8px) rotate(-40deg) scale(1.02); /* Settle */
        }
        72% {
          opacity: 0.3;
          transform: translate(-75px, 14px) rotate(-48deg) scale(0.72);
        }
        88% {
          opacity: 0.14;
          transform: translate(-88px, 22px) rotate(-54deg) scale(0.42);
        }
        /* Extended 25% fade tail */
        94% {
          opacity: 0.06;
          transform: translate(-94px, 26px) rotate(-57deg) scale(0.3);
        }
        100% {
          opacity: 0;
          transform: translate(-100px, 30px) rotate(-60deg) scale(0.18);
        }
      }

      /* Path C: Gentle downward float with sway - reduced rotation */
      @keyframes lineageDustC {
        0% {
          opacity: 0;
          transform: translate(0, 0) rotate(0deg) scale(0.3);
        }
        12% {
          opacity: 0.6; /* Gentle spark */
          transform: translate(5px, 8px) rotate(6deg) scale(0.9);
        }
        30% {
          opacity: 0.55;
          transform: translate(-8px, 25px) rotate(15deg) scale(1);
        }
        46% {
          opacity: 0.48;
          transform: translate(8px, 42px) rotate(26deg) scale(1.05); /* Lub */
        }
        52% {
          opacity: 0.44;
          transform: translate(10px, 48px) rotate(30deg) scale(0.92); /* Dub */
        }
        58% {
          opacity: 0.4;
          transform: translate(6px, 54px) rotate(34deg) scale(1.02); /* Settle */
        }
        74% {
          opacity: 0.28;
          transform: translate(-4px, 70px) rotate(42deg) scale(0.68);
        }
        88% {
          opacity: 0.12;
          transform: translate(6px, 85px) rotate(50deg) scale(0.4);
        }
        /* Extended 25% fade tail */
        94% {
          opacity: 0.05;
          transform: translate(3px, 92px) rotate(54deg) scale(0.28);
        }
        100% {
          opacity: 0;
          transform: translate(0px, 100px) rotate(58deg) scale(0.18);
        }
      }

      /* Path D: Settle path - horizontal drift then gentle parabolic fall */
      /* Like memories surfacing, catching light, then settling */
      @keyframes lineageDustSettle {
        0% {
          opacity: 0;
          transform: translate(0, 0) rotate(0deg) scale(0.25);
        }
        10% {
          opacity: 0.62;
          transform: translate(15px, -8px) rotate(5deg) scale(0.92); /* Rise */
        }
        25% {
          opacity: 0.58;
          transform: translate(35px, -12px) rotate(12deg) scale(1); /* Peak drift */
        }
        40% {
          opacity: 0.52;
          transform: translate(50px, -6px) rotate(20deg) scale(1.06); /* Lub */
        }
        46% {
          opacity: 0.48;
          transform: translate(55px, 0px) rotate(24deg) scale(0.94); /* Dub - apex */
        }
        52% {
          opacity: 0.44;
          transform: translate(58px, 8px) rotate(28deg) scale(1.02); /* Settle start */
        }
        68% {
          opacity: 0.32;
          transform: translate(62px, 28px) rotate(36deg) scale(0.78); /* Parabolic fall */
        }
        82% {
          opacity: 0.18;
          transform: translate(64px, 52px) rotate(44deg) scale(0.52);
        }
        92% {
          opacity: 0.08;
          transform: translate(65px, 72px) rotate(50deg) scale(0.35);
        }
        100% {
          opacity: 0;
          transform: translate(65px, 90px) rotate(55deg) scale(0.2);
        }
      }

      /* Slower timing for contemplative feel */
      /* Using ease-out for organic movement, paired emergence (memories surface together) */
      /* Pair 1: emerge together at 4.2s */
      .panel--build.in-view .lineage-dust:nth-child(2) {
        animation: lineageDustA 8s ease-out 4.2s infinite;
      }
      .panel--build.in-view .lineage-dust:nth-child(3) {
        animation: lineageDustB 8.8s ease-out 4.25s infinite;
      }
      /* Pair 2: emerge together at 5.0s */
      .panel--build.in-view .lineage-dust:nth-child(4) {
        animation: lineageDustSettle 7.5s ease-out 5.0s infinite;
      }
      .panel--build.in-view .lineage-dust:nth-child(5) {
        animation: lineageDustC 8.5s ease-out 5.05s infinite;
      }
      /* Pair 3: emerge together at 5.8s */
      .panel--build.in-view .lineage-dust:nth-child(6) {
        animation: lineageDustB 9.2s ease-out 5.8s infinite;
      }
      .panel--build.in-view .lineage-dust:nth-child(7) {
        animation: lineageDustA 7.8s ease-out 5.85s infinite;
      }
      /* Pair 4: emerge together at 6.6s */
      .panel--build.in-view .lineage-dust:nth-child(8) {
        animation: lineageDustSettle 8.8s ease-out 6.6s infinite;
      }
      .panel--build.in-view .lineage-dust:nth-child(9) {
        animation: lineageDustC 8.2s ease-out 6.65s infinite;
      }
      /* Pair 5: emerge together at 7.4s */
      .panel--build.in-view .lineage-dust:nth-child(10) {
        animation: lineageDustB 9.5s ease-out 7.4s infinite;
      }
      .panel--build.in-view .lineage-dust:nth-child(11) {
        animation: lineageDustSettle 7.2s ease-out 7.45s infinite;
      }

      /* ===== MESA EMBERS - the table beckons ===== */
      /* These rise from "La mesa te espera" like warmth from a waiting table */

      .slam-slogan-wrap {
        position: relative;
        display: inline-block;
      }

      /* Text glow - inviting warmth */
      .panel--slam.in-view .slam-slogan {
        text-shadow:
          0 0 25px rgba(255, 180, 100, 0.35),
          0 0 50px rgba(212, 165, 116, 0.2),
          0 0 80px rgba(212, 165, 116, 0.1);
        animation: mesaTextGlow 3.5s ease-in-out infinite;
      }

      @keyframes mesaTextGlow {
        0%, 100% {
          text-shadow:
            0 0 25px rgba(255, 180, 100, 0.35),
            0 0 50px rgba(212, 165, 116, 0.2),
            0 0 80px rgba(212, 165, 116, 0.1);
        }
        50% {
          text-shadow:
            0 0 35px rgba(255, 180, 100, 0.45),
            0 0 70px rgba(212, 165, 116, 0.3),
            0 0 100px rgba(212, 165, 116, 0.15);
        }
      }

      .mesa-ember {
        position: absolute;
        width: 3px;
        height: 3px;
        background: var(--ember-warm);
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
        filter: blur(0.5px);
        will-change: transform, opacity;
      }

      /* Size variants with glow halos */
      .mesa-ember--lg {
        width: 5px;
        height: 5px;
        filter: blur(0.3px);
        box-shadow:
          0 0 6px var(--ember-hot),
          0 0 12px rgba(255, 180, 100, 0.4);
      }
      .mesa-ember--md { width: 3px; height: 3px; filter: blur(0.5px); }
      .mesa-ember--sm {
        width: 2px;
        height: 2px;
        filter: blur(1px);
        background: var(--ember-cool);
      }

      /* Temperature variants */
      .mesa-ember--hot { background: var(--ember-hot); }
      .mesa-ember--cool { background: var(--ember-cool); }

      /* Pulse particle - stationary heartbeat at center */
      .mesa-ember--pulse {
        width: 6px;
        height: 6px;
        background: var(--ember-hot);
        filter: blur(0.4px);
        box-shadow:
          0 0 8px var(--ember-hot),
          0 0 16px rgba(255, 180, 100, 0.5);
      }

      /* 10 embers spread across the slogan text */
      .mesa-ember:nth-child(2)  { left: 20%; top: 50%; }
      .mesa-ember:nth-child(3)  { left: 35%; top: 45%; }
      .mesa-ember:nth-child(4)  { left: 50%; top: 50%; }
      .mesa-ember:nth-child(5)  { left: 65%; top: 45%; }
      .mesa-ember:nth-child(6)  { left: 80%; top: 50%; }
      .mesa-ember:nth-child(7)  { left: 28%; top: 55%; }
      .mesa-ember:nth-child(8)  { left: 42%; top: 48%; }
      .mesa-ember:nth-child(9)  { left: 58%; top: 52%; }
      .mesa-ember:nth-child(10) { left: 72%; top: 47%; }
      .mesa-ember:nth-child(11) { left: 45%; top: 53%; }
      /* Pulse particle - center of slogan */
      .mesa-ember--pulse { left: 50%; top: 50%; transform: translate(-50%, -50%); }

      /* ===== MESA EMBER PATHS - The Beckoning Fire ===== */
      /* Faster tempo (4.5-6s), ease-in curves (acceleration = urgency) */

      /* Path A: Rises with rightward drift - faster, urgent */
      @keyframes mesaEmberA {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.2);
        }
        8% {
          opacity: 0.9; /* Strong spark */
          transform: translateY(-12px) translateX(4px) rotate(20deg) scale(0.88);
        }
        22% {
          opacity: 0.78;
          transform: translateY(-32px) translateX(10px) rotate(50deg) scale(1);
        }
        38% {
          opacity: 0.68;
          transform: translateY(-55px) translateX(7px) rotate(85deg) scale(1.08); /* Lub */
        }
        44% {
          opacity: 0.62;
          transform: translateY(-65px) translateX(10px) rotate(100deg) scale(0.94); /* Dub */
        }
        50% {
          opacity: 0.56;
          transform: translateY(-75px) translateX(12px) rotate(118deg) scale(1.04); /* Settle */
        }
        68% {
          opacity: 0.38;
          transform: translateY(-92px) translateX(10px) rotate(160deg) scale(0.72);
        }
        85% {
          opacity: 0.18;
          transform: translateY(-108px) translateX(16px) rotate(208deg) scale(0.42);
        }
        100% {
          opacity: 0;
          transform: translateY(-125px) translateX(20px) rotate(255deg) scale(0.18);
        }
      }

      /* Path B: Rises with leftward drift - faster, urgent */
      @keyframes mesaEmberB {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.25);
        }
        7% {
          opacity: 0.92; /* Strong spark */
          transform: translateY(-14px) translateX(-5px) rotate(-25deg) scale(0.9);
        }
        20% {
          opacity: 0.8;
          transform: translateY(-36px) translateX(-12px) rotate(-60deg) scale(1);
        }
        36% {
          opacity: 0.68;
          transform: translateY(-58px) translateX(-9px) rotate(-100deg) scale(1.08); /* Lub */
        }
        42% {
          opacity: 0.62;
          transform: translateY(-68px) translateX(-14px) rotate(-118deg) scale(0.94); /* Dub */
        }
        48% {
          opacity: 0.55;
          transform: translateY(-78px) translateX(-12px) rotate(-138deg) scale(1.04); /* Settle */
        }
        65% {
          opacity: 0.38;
          transform: translateY(-95px) translateX(-11px) rotate(-185deg) scale(0.68);
        }
        84% {
          opacity: 0.16;
          transform: translateY(-112px) translateX(-18px) rotate(-232deg) scale(0.38);
        }
        100% {
          opacity: 0;
          transform: translateY(-128px) translateX(-22px) rotate(-280deg) scale(0.15);
        }
      }

      /* Path C: Rises mostly straight - faster, urgent */
      @keyframes mesaEmberC {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.3);
        }
        9% {
          opacity: 0.85; /* Strong spark */
          transform: translateY(-16px) translateX(3px) rotate(15deg) scale(0.92);
        }
        24% {
          opacity: 0.72;
          transform: translateY(-42px) translateX(-2px) rotate(42deg) scale(1);
        }
        40% {
          opacity: 0.62;
          transform: translateY(-68px) translateX(5px) rotate(78deg) scale(1.08); /* Lub */
        }
        46% {
          opacity: 0.55;
          transform: translateY(-78px) translateX(2px) rotate(95deg) scale(0.94); /* Dub */
        }
        52% {
          opacity: 0.48;
          transform: translateY(-88px) translateX(-1px) rotate(115deg) scale(1.05); /* Settle */
        }
        70% {
          opacity: 0.32;
          transform: translateY(-102px) translateX(6px) rotate(158deg) scale(0.62);
        }
        88% {
          opacity: 0.12;
          transform: translateY(-118px) translateX(0px) rotate(205deg) scale(0.35);
        }
        100% {
          opacity: 0;
          transform: translateY(-132px) translateX(4px) rotate(252deg) scale(0.16);
        }
      }

      /* Burst path - short 70px impatient rise */
      @keyframes mesaEmberBurst {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.3);
        }
        10% {
          opacity: 0.95; /* Intense spark */
          transform: translateY(-15px) translateX(2px) rotate(18deg) scale(1);
        }
        30% {
          opacity: 0.82;
          transform: translateY(-38px) translateX(-3px) rotate(45deg) scale(1.1); /* Lub */
        }
        38% {
          opacity: 0.72;
          transform: translateY(-48px) translateX(1px) rotate(58deg) scale(0.92); /* Dub */
        }
        46% {
          opacity: 0.62;
          transform: translateY(-55px) translateX(-2px) rotate(72deg) scale(1.02); /* Settle */
        }
        65% {
          opacity: 0.4;
          transform: translateY(-62px) translateX(3px) rotate(95deg) scale(0.72);
        }
        85% {
          opacity: 0.18;
          transform: translateY(-68px) translateX(0px) rotate(118deg) scale(0.45);
        }
        100% {
          opacity: 0;
          transform: translateY(-72px) translateX(2px) rotate(140deg) scale(0.25);
        }
      }

      /* Pulse animation - heartbeat at center (2s cycle) */
      @keyframes mesaPulse {
        0%, 100% {
          opacity: 0.6;
          transform: translate(-50%, -50%) scale(1);
          box-shadow:
            0 0 8px var(--ember-hot),
            0 0 16px rgba(255, 180, 100, 0.5);
        }
        25% {
          opacity: 0.85;
          transform: translate(-50%, -50%) scale(1.15);
          box-shadow:
            0 0 12px var(--ember-hot),
            0 0 24px rgba(255, 180, 100, 0.65);
        }
        35% {
          opacity: 0.7;
          transform: translate(-50%, -50%) scale(0.95);
          box-shadow:
            0 0 6px var(--ember-hot),
            0 0 14px rgba(255, 180, 100, 0.45);
        }
        50% {
          opacity: 0.78;
          transform: translate(-50%, -50%) scale(1.08);
          box-shadow:
            0 0 10px var(--ember-hot),
            0 0 20px rgba(255, 180, 100, 0.55);
        }
        65% {
          opacity: 0.65;
          transform: translate(-50%, -50%) scale(1);
          box-shadow:
            0 0 8px var(--ember-hot),
            0 0 16px rgba(255, 180, 100, 0.5);
        }
      }

      /* Flare animation - occasional brightness boost */
      @keyframes mesaEmberFlare {
        0% {
          opacity: 0;
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.25);
          filter: blur(0.5px);
        }
        8% {
          opacity: 1.0; /* FLARE - maximum brightness */
          transform: translateY(-14px) translateX(3px) rotate(22deg) scale(1.2);
          filter: blur(0.2px);
        }
        18% {
          opacity: 0.78;
          transform: translateY(-32px) translateX(-5px) rotate(48deg) scale(1);
          filter: blur(0.5px);
        }
        35% {
          opacity: 0.65;
          transform: translateY(-55px) translateX(6px) rotate(82deg) scale(1.06);
        }
        42% {
          opacity: 0.58;
          transform: translateY(-65px) translateX(2px) rotate(98deg) scale(0.92);
        }
        55% {
          opacity: 0.45;
          transform: translateY(-82px) translateX(-4px) rotate(128deg) scale(1.02);
        }
        72% {
          opacity: 0.28;
          transform: translateY(-98px) translateX(5px) rotate(168deg) scale(0.65);
        }
        90% {
          opacity: 0.1;
          transform: translateY(-115px) translateX(1px) rotate(212deg) scale(0.35);
        }
        100% {
          opacity: 0;
          transform: translateY(-128px) translateX(3px) rotate(255deg) scale(0.15);
        }
      }

      /* Staggered timing - faster 4.5-6s range with ease-in (urgency) */
      /* Note: Removed :not(.has-played) so embers persist as ambient effect */
      .panel--slam.in-view .mesa-ember:nth-child(2) {
        animation: mesaEmberA 5.2s ease-in 5.8s infinite;
      }
      .panel--slam.in-view .mesa-ember:nth-child(3) {
        animation: mesaEmberB 5.8s ease-in 6.0s infinite;
      }
      /* Burst paths - short impatient rises */
      .panel--slam.in-view .mesa-ember:nth-child(4) {
        animation: mesaEmberBurst 4.5s ease-in 6.2s infinite;
      }
      .panel--slam.in-view .mesa-ember:nth-child(5) {
        animation: mesaEmberA 5.5s ease-in 6.5s infinite;
      }
      /* Flare particle - occasional brightness boost */
      .panel--slam.in-view .mesa-ember:nth-child(6) {
        animation: mesaEmberFlare 5.0s ease-in 6.8s infinite;
      }
      .panel--slam.in-view .mesa-ember:nth-child(7) {
        animation: mesaEmberC 5.3s ease-in 7.0s infinite;
      }
      /* Another burst path */
      .panel--slam.in-view .mesa-ember:nth-child(8) {
        animation: mesaEmberBurst 4.8s ease-in 7.3s infinite;
      }
      .panel--slam.in-view .mesa-ember:nth-child(9) {
        animation: mesaEmberB 5.6s ease-in 7.5s infinite;
      }
      .panel--slam.in-view .mesa-ember:nth-child(10) {
        animation: mesaEmberC 4.9s ease-in 7.8s infinite;
      }
      .panel--slam.in-view .mesa-ember:nth-child(11) {
        animation: mesaEmberA 5.4s ease-in 8.0s infinite;
      }

      /* Pulse particle animation - heartbeat at center */
      .panel--slam.in-view .mesa-ember--pulse {
        animation: mesaPulse 2s ease-in-out 5.8s infinite;
      }

      .panel--whisper.in-view:not(.has-played) .whisper-line--mystery {
        animation: mysterySlam 1.6s cubic-bezier(0.16, 1, 0.3, 1) 2.5s forwards;
      }

      /* Mystery slam - Clean cut. Lands with weight. */
      @keyframes mysterySlam {
        0% {
          opacity: 0;
          transform: translateY(15px);
          filter: blur(6px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
          text-shadow:
            0 0 40px rgba(212, 165, 116, 0.5),
            0 2px 20px rgba(0, 0, 0, 0.6);
        }
      }

      /* Setup emerges from blur - scale + blur like focus pulling (the room whispers) */
      @keyframes setupEmerge {
        0% {
          opacity: 0;
          transform: scale(0.92);
          filter: blur(12px);
        }
        60% {
          opacity: 0.9;
          transform: scale(1.01);
          filter: blur(2px);
        }
        100% {
          opacity: 1;
          transform: scale(1);
          filter: blur(0);
        }
      }

      /* Greeting drifts from RIGHT - SMOOTH smoke emerge (no bounce) */
      /* Tobias: Small translations (25px instead of 60px), blur as memory */
      @keyframes greetingDrift {
        0% {
          opacity: 0;
          transform: translateX(25px);
          filter: blur(6px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
          filter: blur(0);
          text-shadow:
            0 0 50px rgba(212, 165, 116, 0.6),
            0 0 100px rgba(212, 165, 116, 0.3),
            0 4px 20px rgba(0, 0, 0, 0.8);
        }
      }


      /* Simple greeting reveal - fallback */
      @keyframes greetingReveal {
        0% {
          opacity: 0;
          transform: translateY(8px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Legacy: greeting reveals right-to-left */
      @keyframes greetingRevealRTL {
        0% {
          opacity: 0;
          transform: translateX(30px) scale(0.98);
          filter: blur(12px);
        }
        100% {
          opacity: 1;
          transform: translateX(0) scale(1);
          filter: blur(0);
        }
      }

      @keyframes cinematicReveal {
        0% {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
          filter: blur(8px);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      @keyframes wordBuild {
        0% {
          opacity: 0;
          transform: translateY(15px);
          filter: blur(4px);
        }
        100% {
          opacity: 0.8;
          transform: translateY(0);
          filter: blur(0);
        }
      }

      @keyframes wordBuildFinal {
        0% {
          opacity: 0;
          transform: translateY(15px) scale(0.9);
          filter: blur(4px);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* Scroll indicator - appears after narrative completes */
      /* Part of flex flow inside whisper-bottom, not absolutely positioned */
      .whisper-scroll-hint {
        margin-top: 3vh;
        opacity: 0;
        transition: opacity 420ms ease;
        pointer-events: none;
        display: flex;
        justify-content: center;
      }

      .whisper-scroll-hint__chevron {
        width: 18px;
        height: 18px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.5;
      }

      .panel--whisper.in-view .whisper-scroll-hint {
        animation: scrollHintReveal 1s ease-out 2.5s forwards;  /* Standardized: 2.5s after panel entry for consistent rhythm */
      }

      /* Smooth transitions for has-played state changes
         Prevents abrupt "light flicker" when animations end and class is added
         The 0.5s ease-out masks the class toggle, feels like camera "settling" */
      .whisper-setup,
      .whisper-greeting,
      .whisper-line--mystery {
        transition: opacity 0.5s ease-out, text-shadow 0.5s ease-out, filter 0.5s ease-out;
      }

      /* Once played: returning should feel "static" and inevitable (no replays). */
      .panel--whisper.has-played .whisper-setup {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--whisper.has-played .whisper-greeting {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--whisper.has-played .whisper-line--mystery {
        opacity: 1;
        transform: none;
        filter: none;
        text-shadow:
          0 0 40px rgba(212, 165, 116, 0.5),
          0 2px 20px rgba(0, 0, 0, 0.6);
      }
      .panel--whisper.has-played .whisper-scroll-hint {
        opacity: 1;
      }

      @keyframes scrollHintReveal {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      /* Hero scroll hint - appears after the hero has time to breathe */
      .hero-scroll-hint {
        position: absolute;
        left: 0;
        right: 0;
        bottom: calc(46px + 80px); /* Higher - consistent with other panels */
        z-index: 12;
        display: flex;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
      }
      @media (max-width: 768px) {
        .hero-scroll-hint {
          bottom: calc(40px + 60px);
        }
      }
      .hero-scroll-hint__chevron {
        width: 18px;
        height: 18px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.45;
      }
      .hero-scroll-hint.is-ready {
        animation: scrollHintReveal 1s ease-out forwards;
      }

      /* ================================================
         SCENE 2: THE REVELATION - The Cinematic Climax
         "You didn't learn this game. You inherited it."
         The word "inherited" is the SLAM moment.
         ================================================ */

      .panel--build {
        justify-content: center;
        align-items: center;
        padding: 0;
        position: relative;
      }

      /* ============================================
         GOLDEN HOUR LIGHT SHIFT
         Temperature rises from cool → warm as heritage builds to "Te toca"
         Lin-Manuel: "The light follows the feeling"
         ============================================ */
      .panel--build::after {
        content: '';
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 5;  /* Above background, below text */
        opacity: 0;
        background: radial-gradient(
          ellipse 80% 60% at center,
          rgba(212, 165, 116, 0.08) 0%,
          transparent 70%
        );
      }

      /* Static warm glow - no color shift animation (mobile performance) */
      .panel--build.in-view::after,
      .panel--build.has-played::after {
        opacity: 0.5;
        background: radial-gradient(
          ellipse 80% 60% at center,
          rgba(212, 165, 116, 0.12) 0%,
          transparent 70%
        );
      }

      /* TOP LETTERBOX - The setup whispered from darkness */
      .build-top {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 8vh 6vw 14vh; /* Generous top breathing */
        background: linear-gradient(
          to bottom,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.9) 30%,
          rgba(10, 7, 5, 0.5) 70%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        justify-content: center;
        pointer-events: none;
      }

      .build-setup {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: clamp(1rem, 4vw, 1.5rem);
        color: rgba(255, 255, 255, 0.88);
        letter-spacing: 0.12em;
        text-align: center;
        opacity: 0;
        transition: opacity 420ms ease;
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      }

      /* CENTER - Asymmetric layout with LEFT offset for visual journey */
      .build-center {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: flex-start;  /* LEFT-aligned - asymmetry */
        justify-content: center;
        text-align: left;
        padding-left: 8vw;  /* Left offset */
        pointer-events: none;
        margin-top: -8vh;  /* Position above center */
      }

      .build-revelation {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2vh; /* More breathing room */
        /* isolation removed - was causing color flash during text-shadow animation */
      }

      .build-word {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        opacity: 0;
        transition: opacity 420ms ease;
      }

      /* "It was" - the setup on one line */
      .build-word--itwas {
        font-size: clamp(1.4rem, 5vw, 2.2rem);
        color: rgba(212, 165, 116, 0.98);
        letter-spacing: 0.06em;
        margin-bottom: 1.5vh;
        text-shadow:
          0 0 16px rgba(212, 165, 116, 0.22),
          0 2px 15px rgba(0, 0, 0, 0.5);
      }

      /* "Your abuelo sat here." - DESCENDS from above (ancestors arriving) */
      /* Typography: ITALIC = flows with memory, matches tío/father line */
      .build-word--primary {
	        font-size: clamp(1.6rem, 7vw, 3.2rem);
	        font-style: italic;  /* ITALIC - matches family line, memory flowing */
	        color: transparent; /* Render fill via animation (prevents Chrome shadow flicker) */
	        font-weight: 600;    /* Ancestor weight - bolder for mobile readability */
	        letter-spacing: 0.03em;
	        line-height: 1.15;
	        display: block;
	        text-align: left;
	        position: relative;
	        -webkit-font-smoothing: antialiased;
	        text-shadow: none;
      }

      /* Chrome workaround: avoid animating large blurred text-shadow directly on the glyph run.
         We render a blurred "memory" layer + a separate glow layer and animate only opacity/transform. */
      .build-word--primary::before,
      .build-word--primary::after {
        content: attr(data-text);
        position: absolute;
        inset: 0;
        display: block;
        pointer-events: none;
        font: inherit;
        letter-spacing: inherit;
        line-height: inherit;
        text-align: inherit;
        white-space: inherit;
      }

      /* Blurred "memory" fill that fades out as the sharp text lands */
      .build-word--primary::before {
        color: rgba(255, 255, 255, 0.95);
        filter: blur(6px);
        opacity: 1;
        text-shadow:
          0 0 30px rgba(212, 165, 116, 0.18),
          0 4px 24px rgba(0, 0, 0, 0.75);
        transform: translateZ(0);
      }

      /* Brass glow layer (transparent fill; shadow-only) that pulses in */
      .build-word--primary::after {
        color: transparent;
        opacity: 0;
        text-shadow:
          0 0 35px rgba(255, 255, 255, 0.4),
          0 0 65px rgba(212, 165, 116, 0.65),
          0 0 100px rgba(212, 165, 116, 0.4),
          0 4px 30px rgba(0, 0, 0, 0.8);
      }

      /* Family cascade: "Your tío." → "Your father." */
      /* Generational descent building to the torch pass */
      .build-family {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        width: 85vw;
        gap: 1.0vh;
        margin-top: 1.5vh;
      }

      .build-family__line {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 500;  /* Bolder for mobile readability */
        letter-spacing: 0.05em;
        opacity: 0;
        text-shadow:
          0 0 20px rgba(212, 165, 116, 0.3),
          0 2px 12px rgba(0, 0, 0, 0.5);
      }

      /* "Your tío. Your father." - Two generations on one line (direct lineage) */
      .build-family__line--generations {
        align-self: center;
        text-align: center;
        font-size: clamp(1.3rem, 5vw, 2rem);
        color: rgba(212, 165, 116, 0.9);
      }

      /* Life cycle container - the passage of time */
      .build-lifecycle {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5vh;
        margin-top: 2vh;
      }

      /* "Every Sunday. Every celebration." - Universal, spans time */
      /* Typography: ITALIC = memory/time passing, different from the family names */
      .build-lifecycle__line {
        font-family: "Bodoni Moda", serif;
        font-style: italic;  /* Time flows differently */
        font-weight: 500;  /* Bolder for mobile readability */
        font-size: clamp(1rem, 4vw, 1.6rem);
        color: rgba(248, 239, 230, 0.85);  /* Cream @ 85% — readable in sunlight */
        letter-spacing: 0.04em;
        line-height: 1.6;
        text-align: center;
        opacity: 0;
        text-shadow:
          0 0 20px rgba(248, 239, 230, 0.3),
          0 0 40px rgba(212, 165, 116, 0.2),
          0 2px 15px rgba(0, 0, 0, 0.6);
      }

      /* "Every goodbye." - The closer, lands 1 second after */
      .build-lifecycle__closer {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 500;
        font-size: clamp(1rem, 4vw, 1.6rem);
        color: rgba(248, 239, 230, 0.85);
        letter-spacing: 0.04em;
        line-height: 1.6;
        text-align: center;
        opacity: 0;
        display: block;
        margin-top: 0.3em;
        text-shadow:
          0 0 20px rgba(248, 239, 230, 0.3),
          0 0 40px rgba(212, 165, 116, 0.2),
          0 2px 15px rgba(0, 0, 0, 0.6);
      }

      /* "Te toca." - THE CLIMAX - RISES from below */
      /* Pure Cuban table-talk: "It's your turn." The torch passes. */
      /* Typography: IBM Plex Sans = DIRECT ADDRESS voice (matches Panel 2 recognition) */
      /* Pattern: IBM Plex Sans = "speaking directly to YOU" moments */
      .build-word--torch {
        font-family: 'IBM Plex Sans', sans-serif;  /* DIRECT ADDRESS - matches "You've sat here before" */
        font-size: clamp(2.4rem, 11vw, 4.8rem);  /* Increased ~20% - THE climax */
        font-weight: 700;    /* Bold weight - torch moment lands hard */
        font-style: normal;  /* UPRIGHT - definitive, final */
        color: #fff;  /* Full white - maximum impact */
        letter-spacing: 0.05em;
        line-height: 1.2;
        display: block;
        white-space: nowrap;  /* Force single line on all devices */
        margin-top: 3vh;  /* Breathing room - Lin-Manuel's "pause" before the torch */
        opacity: 0;
        text-shadow:
          0 0 40px rgba(255, 255, 255, 0.4),
          0 0 70px rgba(212, 165, 116, 0.7),
          0 0 110px rgba(212, 165, 116, 0.45),
          0 0 150px rgba(212, 165, 116, 0.25),
          0 4px 30px rgba(0, 0, 0, 0.85);
        position: relative;
      }

      /* "Te toca" relies on torchRise animation alone.
         One moment, one effect - the torch rises, nothing competes. */

      /* Legacy: keep inherited for backwards compat */
      .build-word--inherited {
        font-size: clamp(3.5rem, 18vw, 10rem);
        font-style: normal;
        color: #fff;
        font-weight: 500;
        letter-spacing: 0.1em;
        line-height: 0.85;
        text-shadow:
          0 0 25px rgba(255, 255, 255, 0.35),
          0 0 50px rgba(212, 165, 116, 0.7),
          0 0 100px rgba(212, 165, 116, 0.5),
          0 0 150px rgba(212, 165, 116, 0.25),
          0 8px 50px rgba(0, 0, 0, 0.8);
      }

      /* BOTTOM LETTERBOX - Torch RISES from below as the climax */
      .build-bottom {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 6vh 6vw 10vh;
        background: linear-gradient(
          to top,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.88) 35%,
          rgba(10, 7, 5, 0.5) 70%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        flex-direction: column;
        align-items: flex-start;  /* LEFT-aligned - visual anchor with Panel 2 */
        justify-content: flex-end;
        gap: 3vh;
        pointer-events: none;
      }

      .build-scroll-hint {
        opacity: 0;
        transition: opacity 420ms ease;
        display: flex;
        justify-content: center;
      }

      .build-scroll-hint__chevron {
        width: 18px;
        height: 18px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.5;
      }

      /* PANEL 3 ANIMATION SEQUENCE - FAMILY + LIFE CYCLE HYBRID */
      /* Lin-Manuel: "Names give you FACES. Life cycle gives you TIME. Together, WEIGHT." */
      /* Lin-Manuel's Principle: "Silence isn't empty. It's where the feeling lives." */

      /* LET THE ANCESTORS LAND - TIGHTENED TIMELINE (7.5s total):
         0.3s: "Your abuelo sat here." descends (2.2s + glow pulse)
         2.5s: Animation complete
         ← 0.5s SILENCE (ancestor lands)
         3.0s: "Your tío. Your father." scales in (1.0s, centered)
         4.0s: Animation complete
         ← 0.8s SILENCE (generations settle)
         4.8s: "Every Sunday. Every celebration. Every goodbye." fades in (1.5s)
         6.3s: Animation complete
         ← 0.4s TIGHTENED SILENCE (users getting impatient)
         6.7s: "Te toca." rises - moved earlier for faster pacing
         7.2s: Scroll hint fades in
         7.5s: Scroll lock releases
      */

      .panel--build.in-view:not(.has-played) .build-setup {
        animation: cinematicReveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) 0.2s forwards;
      }

      /* "Your abuelo sat here." - DESCENDS from above with emotional glow pulse */
      .panel--build.in-view:not(.has-played) .build-word--primary {
        animation: ancestorDescendStable 2.2s cubic-bezier(0.16, 1, 0.3, 1) 0.5s forwards;  /* +0.2s stall for anticipation */
      }
      .panel--build.in-view:not(.has-played) .build-word--primary::before {
        animation: ancestorBlurFade 2.2s cubic-bezier(0.16, 1, 0.3, 1) 0.5s forwards;
      }
      .panel--build.in-view:not(.has-played) .build-word--primary::after {
        animation: ancestorGlowPulse 2.2s cubic-bezier(0.16, 1, 0.3, 1) 0.5s forwards;
      }

      /* "Your tío. Your father." - Two generations scale in together */
      /* Waits for abuelo to land (0.5s SILENCE after 2.5s) */
      .panel--build.in-view:not(.has-played) .build-family__line--generations {
        animation: scaleFromCenter 1.0s ease-out 3.0s forwards;
      }

      /* "Every Sunday. Every celebration." - Time fades in */
      /* Waits for generations to settle (0.8s SILENCE after 4.0s) */
      .panel--build.in-view:not(.has-played) .build-lifecycle__line {
        animation: lifeCycleFade 1.5s ease-out 4.8s forwards;
      }

      /* "Every goodbye." - The closer, lands 3 seconds after for drama */
      .panel--build.in-view:not(.has-played) .build-lifecycle__closer {
        animation: lifeCycleFade 1.5s ease-out 7.8s forwards;
      }

      /* "Te toca." - THE CLIMAX - RISES from below */
      /* Starts at 10.0s (after goodbye absorbs), 2.0s duration, lands at 12.0s */
      .panel--build.in-view:not(.has-played) .build-word--torch {
        animation: torchRise 2.0s cubic-bezier(0.16, 1, 0.3, 1) 10.5s forwards;  /* Lin-Manuel's 1.2s silence after "Every goodbye" */
      }

      /* Legacy: keep inherited animation */
      .panel--build.in-view:not(.has-played) .build-word--inherited {
        animation: inheritedDawning 3s cubic-bezier(0.16, 1, 0.3, 1) 0.8s forwards;
      }

      .panel--build.in-view:not(.has-played) .build-scroll-hint {
        animation: scrollHintReveal 1s ease-out 2.5s forwards;  /* Standardized: 2.5s after panel entry for consistent rhythm */
      }

      /* ANCESTOR DESCENDS - SMOOTH drop from above (no bounce) */
      /* Tobias: Small translations (30px instead of 60px), blur as memory */
      @keyframes ancestorDescend {
        0% {
          opacity: 0;
          transform: translateY(-30px);
          filter: blur(6px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
          text-shadow:
            0 0 30px rgba(255, 255, 255, 0.35),
            0 0 60px rgba(212, 165, 116, 0.6),
            0 0 100px rgba(212, 165, 116, 0.4),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
      }

      /* ANCESTOR DESCENDS WITH GLOW - Emotional version with glow pulse */
      /* The ancestor emerges from deeper memory, then warms into presence */
      @keyframes ancestorDescendWithGlow {
        0% {
          opacity: 0;
          transform: translateY(-40px) scale(1.02);
          text-shadow:
            0 0 20px rgba(255, 255, 255, 0),
            0 0 40px rgba(212, 165, 116, 0),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
        50% {
          opacity: 0.85;
          transform: translateY(-5px) scale(1.0);
          text-shadow:
            0 0 25px rgba(255, 255, 255, 0.25),
            0 0 50px rgba(212, 165, 116, 0.4),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
        70% {
          opacity: 1;
          transform: translateY(0) scale(1.0);
          text-shadow:
            0 0 30px rgba(255, 255, 255, 0.35),
            0 0 60px rgba(212, 165, 116, 0.5),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
        85% {
          /* GLOW PULSE - the memory warms */
          opacity: 1;
          transform: translateY(0) scale(1.0);
          text-shadow:
            0 0 50px rgba(255, 255, 255, 0.5),
            0 0 80px rgba(212, 165, 116, 0.8),
            0 0 120px rgba(212, 165, 116, 0.5),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
        100% {
          /* Settle to final state */
          opacity: 1;
          transform: translateY(0) scale(1.0);
          text-shadow:
            0 0 35px rgba(255, 255, 255, 0.4),
            0 0 65px rgba(212, 165, 116, 0.65),
            0 0 100px rgba(212, 165, 116, 0.4),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
      }

      /* ANCESTOR DESCENDS (STABLE) - same motion, but no animated text-shadow/filter */
      @keyframes ancestorDescendStable {
        0% {
          opacity: 0;
          transform: translateY(-40px) scale(1.02);
          color: transparent;
        }
        50% {
          opacity: 0.85;
          transform: translateY(-5px) scale(1.0);
          color: transparent;
        }
        70% {
          opacity: 1;
          transform: translateY(0) scale(1.0);
          color: rgba(255, 255, 255, 1);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1.0);
          color: #fff;
        }
      }

      @keyframes ancestorBlurFade {
        0% { opacity: 1; }
        55% { opacity: 0.9; }
        70% { opacity: 0; }
        100% { opacity: 0; }
      }

      @keyframes ancestorGlowPulse {
        0% { opacity: 0; }
        70% { opacity: 0.65; }
        85% { opacity: 1; }
        100% { opacity: 0.9; }
      }

      /* SLIDE FROM RIGHT - SMOOTH poetry line enters from right (no bounce) */
      @keyframes slideFromRight {
        0% {
          opacity: 0;
          transform: translateX(20px);
          filter: blur(4px);
        }
        100% {
          opacity: 0.85;
          transform: translateX(0);
          filter: blur(0);
        }
      }

      /* SCALE FROM CENTER - SMOOTH poetry line emerges from center (no bounce) */
      @keyframes scaleFromCenter {
        0% {
          opacity: 0;
          transform: scale(0.9);
          filter: blur(4px);
        }
        100% {
          opacity: 0.85;
          transform: scale(1);
          filter: blur(0);
        }
      }

      /* SLIDE FROM LEFT - SMOOTH poetry line enters from left (no bounce) */
      @keyframes slideFromLeft {
        0% {
          opacity: 0;
          transform: translateX(-20px);
          filter: blur(4px);
        }
        100% {
          opacity: 0.85;
          transform: translateX(0);
          filter: blur(0);
        }
      }

      /* LIFE CYCLE FADE - Time passes, ethereal fade-in */
      /* The universal moments: routine, celebration, loss */
      @keyframes lifeCycleFade {
        0% {
          opacity: 0;
          transform: scale(0.95);
          filter: blur(8px);
        }
        60% {
          opacity: 0.85;
          transform: scale(1.01);
          filter: blur(1px);
        }
        100% {
          opacity: 1;
          transform: scale(1);
          filter: blur(0);
          text-shadow:
            0 0 25px rgba(248, 239, 230, 0.4),
            0 0 50px rgba(212, 165, 116, 0.3),
            0 2px 15px rgba(0, 0, 0, 0.6);
        }
      }

      /* TORCH RISES - THE CLIMAX - SMOOTH rise from below (weight, presence) */
      /* Tobias: Small translations (25px instead of 80px), blur as memory surfacing */
      /* Visual cohesion: Torch animation with intensified final glow */
      @keyframes torchRise {
        0% {
          opacity: 0;
          transform: translateY(25px);
          filter: blur(6px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
          text-shadow:
            0 0 45px rgba(255, 255, 255, 0.45),
            0 0 80px rgba(212, 165, 116, 0.75),
            0 0 120px rgba(212, 165, 116, 0.5),
            0 0 160px rgba(212, 165, 116, 0.3),
            0 4px 35px rgba(0, 0, 0, 0.85);
        }
      }

      /* Legacy: Memory surface - kept for backwards compat */
      @keyframes memorySurface {
        0% {
          opacity: 0;
          transform: translateY(25px);
          filter: blur(10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
          text-shadow:
            0 0 30px rgba(255, 255, 255, 0.35),
            0 0 60px rgba(212, 165, 116, 0.6),
            0 0 100px rgba(212, 165, 116, 0.4),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
      }

      /* Legacy: Poetry line reveal */
      @keyframes poetryLineReveal {
        0% {
          opacity: 0;
          transform: translateY(8px);
          filter: blur(3px);
        }
        100% {
          opacity: 0.85;
          transform: translateY(0);
          filter: blur(0);
        }
      }

      /* Legacy: Torch pass */
      @keyframes torchPass {
        0% {
          opacity: 0;
          transform: translateY(8px);
          filter: blur(4px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
        }
      }

      /* Legacy: basic heritage reveal */
      @keyframes heritageReveal {
        0% {
          opacity: 0;
          transform: translateY(20px);
          filter: blur(8px);
        }
        60% {
          opacity: 1;
          filter: blur(0);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
        }
      }

      /* Smooth transitions for has-played state changes (Panel 3)
         Prevents abrupt "light flicker" when animations end */
      .build-word--primary,
      .build-family__line,
      .build-lifecycle__line,
      .build-lifecycle__closer,
      .build-word--torch {
        transition: opacity 0.5s ease-out, text-shadow 0.5s ease-out, filter 0.5s ease-out;
      }

      .panel--build.has-played .build-setup {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--build.has-played .build-word--itwas {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--build.has-played .build-word--primary {
        opacity: 1;
        transform: none;
        filter: none;
        color: #fff;
      }
      .panel--build.has-played .build-word--primary::before {
        opacity: 0;
      }
      .panel--build.has-played .build-word--primary::after {
        opacity: 0.9;
      }
      .panel--build.has-played .build-family__line {
        opacity: 0.85;
        transform: none;
        filter: none;
      }
      .panel--build.has-played .build-lifecycle__line {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--build.has-played .build-lifecycle__closer {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--build.has-played .build-word--torch {
        opacity: 1;
        transform: none;
        filter: none;
        text-shadow:
          0 0 45px rgba(255, 255, 255, 0.45),
          0 0 80px rgba(212, 165, 116, 0.75),
          0 0 120px rgba(212, 165, 116, 0.5),
          0 0 160px rgba(212, 165, 116, 0.3),
          0 4px 35px rgba(0, 0, 0, 0.85);
      }

      /* Like wordBuild, but lands at full presence */
      @keyframes wordBuildBright {
        0% {
          opacity: 0;
          transform: translateY(15px);
          filter: blur(4px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
        }
      }
      .panel--build.has-played .build-word--inherited {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--build.has-played .build-scroll-hint {
        opacity: 1;
      }

      /* The SLAM - "inherited" hits like a domino on the table */
      @keyframes revelationSlam {
        0% {
          opacity: 0;
          transform: translateY(50px) scale(0.8);
          filter: blur(15px);
        }
        40% {
          opacity: 1;
          filter: blur(0);
        }
        55% {
          transform: translateY(-5px) scale(1.02);
        }
        70% {
          transform: translateY(2px) scale(0.99);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* "INHERITED." dawns like a memory surfacing - slow, weighted, inevitable */
      @keyframes inheritedDawning {
        0% {
          opacity: 0;
          transform: scale(0.85);
          filter: blur(25px);
          letter-spacing: 0.2em;
        }
        20% {
          opacity: 0.3;
          filter: blur(15px);
        }
        50% {
          opacity: 0.7;
          filter: blur(5px);
          letter-spacing: 0.12em;
        }
        80% {
          opacity: 0.95;
          filter: blur(1px);
        }
        100% {
          opacity: 1;
          transform: scale(1);
          filter: blur(0);
          letter-spacing: 0.1em;
          text-shadow:
            0 0 30px rgba(255, 255, 255, 0.4),
            0 0 60px rgba(212, 165, 116, 0.8),
            0 0 120px rgba(212, 165, 116, 0.5),
            0 0 180px rgba(212, 165, 116, 0.3);
        }
      }

      /* ================================================
         SCENE 3: THE MISSION - Make Them Proud
         The final word "PROUD" is the emotional slam.
         This is why you're here. For them.
         ================================================ */

      .panel--slam {
        justify-content: center;
        align-items: center;
        padding: 0;
      }

      /* TOP LETTERBOX - Event context sets the stage */
      .slam-top {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 14vh 6vw 8vh;
        background: linear-gradient(
          to bottom,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.85) 40%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        pointer-events: none;
      }

      /* CENTER - The stakes command attention */
      .slam-center {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        pointer-events: none;
      }

      /* ============================================
         CDL 1 BADGE - The Bone Language
         A domino tile as championship marker
         ============================================ */
      .slam-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 70px;
        height: 100px;
        margin-bottom: 3vh;
        background: linear-gradient(
          145deg,
          rgba(20, 14, 10, 0.95) 0%,
          rgba(12, 8, 5, 0.98) 100%
        );
        border: 2px solid var(--brass);
        border-radius: 12px; /* Bone Language */
        position: relative;
        opacity: 0;
        /* Brass glow - championship energy */
        box-shadow:
          0 0 20px rgba(212, 165, 116, 0.3),
          0 0 40px rgba(212, 165, 116, 0.15),
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 8px 32px rgba(0, 0, 0, 0.5);
      }

      /* Subtle shine overlay - metallic feel */
      .slam-badge::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.1) 100%
        );
        pointer-events: none;
      }

      .slam-badge__top,
      .slam-badge__bottom {
        font-family: "Bodoni Moda", serif;
        font-weight: 900;
        font-style: italic;
        letter-spacing: 0.08em;
        /* Brass-to-copper gradient — matches footer CDL */
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .slam-badge__top {
        font-size: 1.1rem;
        margin-top: 12px;
      }

      .slam-badge__divider {
        width: 50px;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--brass) 20%,
          var(--brass) 80%,
          transparent 100%
        );
        margin: 8px 0;
        opacity: 0.7;
      }

      .slam-badge__bottom {
        font-size: 1.8rem;
        font-style: italic;
        margin-bottom: 8px;
      }

      /* Badge animation - appears first, sets the stage */
      .panel--slam.in-view:not(.has-played) .slam-badge {
        animation: badgeReveal 1s cubic-bezier(0.16, 1, 0.3, 1) 0.1s forwards;
      }

      .panel--slam.has-played .slam-badge {
        opacity: 1;
      }

      /* Badge reveal - simple scale entrance */
	      @keyframes badgeReveal {
	        0% {
	          opacity: 0;
	          transform: scale(0.86) translateY(8px);
	          filter: blur(3px);
	        }
	        60% {
	          transform: scale(1.015) translateY(0);
	        }
	        100% {
	          opacity: 1;
	          transform: scale(1) translateY(0);
	          filter: blur(0);
        }
      }

      .slam-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
      }

      .slam-word {
        font-family: "Bodoni Moda", serif;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        line-height: 0.85;
        opacity: 0;
        transition: opacity 420ms ease;
      }

      .slam-word--winner {
        font-size: clamp(2.2rem, 10vw, 5rem);
        color: rgba(255, 255, 255, 0.65);
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      }

      .slam-word--takes {
        font-size: clamp(2.6rem, 12vw, 6rem);
        color: rgba(255, 255, 255, 0.8);
        text-shadow: 0 2px 25px rgba(0, 0, 0, 0.5);
      }

      /* "SEAT" - THE MONEY. Everything on the line. */
      /* Typography: Inherits font-weight: 900 from .slam-word = MAXIMUM SLAM */
      /* Lin-Manuel: The climax word needs maximum weight to LAND */
      .slam-word--all {
        position: relative;
        font-size: clamp(4.5rem, 22vw, 14rem);
        /* Inherits font-weight: 900 from .slam-word - maximum slam */
        color: #fff;
        line-height: 0.8;
        text-shadow:
          0 0 30px rgba(255, 255, 255, 0.3),
          0 0 60px rgba(212, 165, 116, 0.6),
          0 0 100px rgba(212, 165, 116, 0.4),
          0 0 150px rgba(212, 165, 116, 0.2),
          0 4px 30px rgba(0, 0, 0, 0.8),
          0 8px 50px rgba(0, 0, 0, 0.5);
      }

      /* Impact ripple ring - visual shockwave on SEAT slam */
      .slam-word--all::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 120%;
        height: 120%;
        transform: translate(-50%, -50%) scale(0);
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(212, 165, 116, 0.3) 0%,
          rgba(212, 165, 116, 0.15) 40%,
          transparent 70%
        );
        pointer-events: none;
        opacity: 0;
      }

      .panel--slam.in-view:not(.has-played) .slam-word--all::before {
        animation: seatImpactRing 0.6s cubic-bezier(0.16, 1, 0.3, 1) 2.35s forwards;
      }

	      @keyframes seatImpactRing {
	        0% { transform: translate(-50%, -50%) scale(0.6); opacity: 0.6; }
	        100% { transform: translate(-50%, -50%) scale(2.3); opacity: 0; }
	      }

      .panel--slam.has-played .slam-word--all::before {
        display: none;
      }

      /* BOTTOM LETTERBOX - Scroll hint after the stakes */
      .slam-bottom {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 8vh 6vw 14vh;
        background: linear-gradient(
          to top,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.85) 40%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        pointer-events: none;
      }

      /* "La mesa te espera." - The slogan landing, tucked under SEAT as signature */
      .slam-slogan {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: clamp(1rem, 4vw, 1.5rem);
        color: var(--brass);
        letter-spacing: 0.06em;
        text-align: center;
        opacity: 0;
        margin-top: 2vh;  /* Tighter gap below SEAT */
        margin-bottom: 0;
        text-shadow:
          0 0 25px rgba(212, 165, 116, 0.5),
          0 0 50px rgba(212, 165, 116, 0.25),
          0 2px 15px rgba(0, 0, 0, 0.6);
      }

      .slam-scroll-hint {
        opacity: 0;
        transition: opacity 420ms ease;
        display: flex;
        justify-content: center;
      }

      .slam-scroll-hint__chevron {
        width: 18px;
        height: 18px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.5;
      }

      /* Scene 3 animation sequence - context first, then the SLAM with REVERBERATION
         Lin-Manuel: "Silence isn't empty. It's where the feeling lives."

         Timeline (let the slam echo):
         0.0s  Context                     [0.8s] ──→ 0.8s
         0.1s  Badge                       [1.0s] ──→ 1.1s
         0.5s  "Take"                      [0.5s] ──→ 1.0s
         1.0s  "Your"                      [0.5s] ──→ 1.5s
                ↓ 0.3s breath
         1.8s  "SEAT"                      [1.2s] ──→ 3.0s
                ↓ 0.8s SILENCE (the slam reverberates)
         3.8s  "La mesa te espera."        [1.8s] ──→ 5.6s

         Total: 5.6s (+1.0s of meaningful silence vs old 4.6s timeline)
      */
      .panel--slam.in-view:not(.has-played) .slam-word--winner {
        animation: slamWord 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.5s forwards;  /* Take */
      }

      .panel--slam.in-view:not(.has-played) .slam-word--takes {
        animation: slamWord 0.5s cubic-bezier(0.16, 1, 0.3, 1) 1.0s forwards;  /* Your */
      }

      .panel--slam.in-view:not(.has-played) .slam-word--all {
        animation: slamFinal 1.2s cubic-bezier(0.16, 1, 0.3, 1) 1.8s forwards;  /* SEAT - the slam */
      }

      .panel--slam.in-view:not(.has-played) .slam-slogan {
        animation: sloganLanding 1.8s cubic-bezier(0.16, 1, 0.3, 1) 3.8s forwards;  /* 0.8s silence after slam lands */
      }

      .panel--slam.in-view:not(.has-played) .slam-scroll-hint {
        animation: scrollHintReveal 1s ease-out 2.5s forwards;  /* Standardized: 2.5s after panel entry for consistent rhythm */
      }

      /* Smooth transitions for has-played state changes (Panel 4)
         Note: .slam-word already has transition defined in base styles */
      .slam-slogan {
        transition: opacity 0.5s ease-out, text-shadow 0.5s ease-out, filter 0.5s ease-out;
      }

      .panel--slam.has-played .slam-word {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--slam.has-played .slam-slogan {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--slam.has-played .slam-scroll-hint {
        opacity: 1;
      }

      /* Event context - grounds the stakes in reality */
      /* Dimmed to 65% - context recedes, doesn't compete with headlines */
      .slam-context {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: clamp(0.65rem, 2vw, 0.8rem);
        font-weight: 500;
        color: rgba(248, 239, 230, 0.65);
        opacity: 0;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        margin-bottom: 3vh;
        text-shadow: 0 2px 15px rgba(0, 0, 0, 0.9);
      }

      .slam-context .dot {
        display: inline-block;
        margin: 0 0.6em;
        color: var(--brass);
        opacity: 0.6;
      }

      /* Animation - context loads FIRST, sets the stage */
      .panel--slam.in-view:not(.has-played) .slam-context {
        animation: fadeInDown 0.8s ease-out 0s forwards;
      }

      .panel--slam.has-played .slam-context {
        opacity: 0.75;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 0.75;
          transform: translateY(0);
        }
      }

	      @keyframes slamWord {
	        0% {
	          opacity: 0;
	          transform: translateY(-14px) scale(1.06);
	          filter: blur(3px);
	        }
	        100% {
	          opacity: 1;
	          transform: translateY(0) scale(1);
	          filter: blur(0);
	        }
	      }

	      @keyframes slamFinal {
	        0% {
	          opacity: 0;
	          transform: translateY(-48px) scale(1.28);
	          filter: blur(10px);
	          text-shadow:
	            0 0 30px rgba(255, 255, 255, 0),
	            0 0 60px rgba(212, 165, 116, 0),
	            0 4px 30px rgba(0, 0, 0, 0.8);
	        }
	        /* THE IMPACT - the "thwack" moment */
	        45% {
	          opacity: 1;
	          transform: translateY(10px) scale(0.96);
	          filter: blur(0) brightness(1.1);
	          text-shadow:
	            0 0 34px rgba(255, 255, 255, 0.45),
	            0 0 70px rgba(212, 165, 116, 0.75),
	            0 0 110px rgba(212, 165, 116, 0.55),
	            0 6px 40px rgba(0, 0, 0, 0.9);
	        }
	        /* First rebound */
	        60% {
	          transform: translateY(-4px) scale(1.01);
	          filter: blur(0) brightness(1.06);
	        }
	        /* Micro-settle */
	        75% {
	          transform: translateY(1px) scale(0.998);
	          filter: blur(0) brightness(1.02);
	        }
	        /* Final rest */
	        100% {
	          opacity: 1;
	          transform: translateY(0) scale(1);
          filter: blur(0) brightness(1);
          text-shadow:
            0 0 30px rgba(255, 255, 255, 0.3),
            0 0 60px rgba(212, 165, 116, 0.6),
            0 0 100px rgba(212, 165, 116, 0.4),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
      }

      /* Slogan landing - the signature moment, elegant arrival */
	      @keyframes sloganLanding {
	        0% {
	          opacity: 0;
	          transform: translateY(12px);
	          filter: blur(5px);
	        }
	        100% {
	          opacity: 1;
	          transform: translateY(0);
	          filter: blur(0);
	        }
	      }

	      /* Panel 4 uses the original slamFinal and sloganLanding animations.
	         "One moment, one effect" - the domino SLAMS once. */

	      @media (prefers-reduced-motion: reduce) {
	        .slam-context,
	        .slam-badge,
	        .slam-word,
	        .slam-slogan,
	        .slam-scroll-hint {
	          animation: none !important;
	          opacity: 1 !important;
	          transform: none !important;
	          filter: none !important;
	        }
	        .slam-context {
	          opacity: 0.75 !important;
	        }
	        .slam-word--all::before {
	          display: none !important;
	        }
	      }

      /* Mobile adjustments for cinematic panels */
      @media (max-width: 768px) {
        /* Cinematic frame - still breathe on mobile */
        .whisper-top {
          padding: max(50px, 6vh) 5vw 10vh; /* Never less than 50px from top */
        }

        .whisper-bottom {
          padding: 10vh 5vw 16vh; /* Extra space for La Mesa */
        }

        .whisper-greeting {
          font-size: clamp(1.2rem, 5vw, 1.8rem); /* Entry greeting - prominent on mobile */
        }

        /* Mobile: Larger, bolder for impact on small screens */
        .whisper-line--challenge {
          font-size: clamp(1.2rem, 5vw, 1.6rem);
        }

        .whisper-line--counter {
          font-size: clamp(1.4rem, 6vw, 1.9rem);
        }

        .whisper-line__top {
          font-size: clamp(1.2rem, 4.5vw, 1.6rem);
        }

        .whisper-line__bottom {
          font-size: clamp(1.8rem, 8vw, 2.8rem);
        }

        /* Panel 3 mobile - cinematic frame */
        .build-top {
          padding: max(50px, 6vh) 5vw 12vh; /* Never less than 50px from top */
        }

        .build-bottom {
          padding: 8vh 5vw 16vh;
        }

        .build-setup {
          font-size: clamp(0.9rem, 3.5vw, 1.2rem);
        }

        .build-word--itwas {
          font-size: clamp(1.2rem, 5vw, 1.8rem);
        }

        .build-word--inherited {
          font-size: clamp(2.2rem, 11vw, 4rem); /* Reduced for uppercase */
        }

        .build-word--primary {
          font-size: clamp(1.4rem, 6vw, 2.5rem);
          margin-bottom: 0.4em;
        }

        .build-family {
          margin-top: 1vh;
        }

        .build-family__line {
          font-size: clamp(1.15rem, 4.5vw, 1.65rem);
        }

        .build-lifecycle__line {
          font-size: clamp(1.1rem, 4.5vw, 1.7rem);
        }

        .build-lifecycle__closer {
          font-size: clamp(1.1rem, 4.5vw, 1.7rem);
        }

        /* Panel 4 mobile - cinematic frame */
        .slam-top {
          padding: 12vh 5vw 6vh;
        }

        .slam-bottom {
          padding: 6vh 5vw 16vh;
        }

        /* CDL badge mobile - slightly smaller */
        .slam-badge {
          width: 60px;
          height: 85px;
          margin-bottom: 2.5vh;
        }

        .slam-badge__top {
          font-size: 0.95rem;
          margin-top: 10px;
        }

        .slam-badge__divider {
          width: 40px;
          margin: 6px 0;
        }

        .slam-badge__bottom {
          font-size: 1.5rem;
          margin-bottom: 6px;
        }

        .slam-word--winner {
          font-size: clamp(2rem, 12vw, 4rem);
        }

        .slam-word--takes {
          font-size: clamp(2.4rem, 14vw, 5rem);
        }

        .slam-word--all {
          font-size: clamp(3.5rem, 22vw, 9rem);
        }

        /* Event context - slightly larger on mobile for readability */
        .slam-context {
          font-size: clamp(0.6rem, 2.8vw, 0.75rem);
          letter-spacing: 0.1em;
          margin-bottom: 2.5vh;
        }
      }

      .panel-subtitle--attitude {
        font-style: italic;
        text-transform: none;
        font-size: clamp(1.3rem, 4vw, 2rem);
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 12px;
        letter-spacing: 0.02em;
      }

      .panel-subtitle--details {
        font-size: clamp(0.9rem, 2.5vw, 1.2rem);
        margin-top: 8px;
      }

      .panel-subtitle .dot {
        color: var(--copper);
        margin: 0 10px;
      }

      /* Scroll Indicator */
      .scroll-indicator {
        position: absolute;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
        /* Removed bounce - per Tobias: "calm, felt, not coached" */
        /* Static hint that fades in; no motion that screams "UI element" */
      }

      .scroll-indicator svg {
        width: 24px;
        height: 24px;
      }

      /* Progress Tracker - Hidden, replaced by unified .form-scarcity */
      .progress-tracker {
        display: none;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .progress-count {
        font-size: 1.1rem;
      }

      .progress-count .number {
        color: var(--brass);
        font-family: "Bodoni Moda", serif;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .progress-spots {
        color: var(--copper);
        font-size: 0.95rem;
      }

      .progress-bar {
        height: 10px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 99px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--copper), var(--brass));
        border-radius: 99px;
        transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
      }

      /* Shimmer effect on progress bar */
      .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s ease-in-out infinite;
        animation-delay: 1.5s;
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      .progress-cta {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        text-align: center;
      }

      /* Who's In Section */
      .whos-in {
        max-width: 400px;
        width: 100%;
        margin: 0 auto 20px;
        text-align: center;
      }

      .whos-in__title {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 12px;
      }

      .whos-in__list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }

      .whos-in__team {
        background: rgba(183, 106, 59, 0.15);
        border: 1px solid rgba(183, 106, 59, 0.3);
        border-radius: 12px;
        padding: 10px 14px;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .whos-in__team:hover {
        background: rgba(183, 106, 59, 0.25);
        transform: translateY(-4px); /* Tobias: The Lift */
        box-shadow: 
          0 8px 24px rgba(0, 0, 0, 0.4),
          0 0 15px rgba(212, 165, 116, 0.1);
      }

      .whos-in__team-name {
        font-family: "Bodoni Moda", serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--brass);
        margin-bottom: 2px;
      }

      .whos-in__players {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .whos-in__empty {
        color: rgba(255, 255, 255, 0.4);
        font-style: italic;
        font-size: 0.9rem;
      }

      /* Individual Player Display */
      .whos-in__player {
        background: rgba(183, 106, 59, 0.12);
        border: 1px solid rgba(183, 106, 59, 0.25);
        border-radius: 12px;
        padding: 8px 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .whos-in__player:hover {
        background: rgba(183, 106, 59, 0.2);
        transform: translateY(-3px); /* Tobias: The Lift */
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
      }

      .whos-in__player-name {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--cream);
      }

      .whos-in__player-badge {
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--copper);
        background: rgba(183, 106, 59, 0.2);
        border-radius: 12px;
        padding: 2px 6px;
      }

      /* Chat Widget - The Sacred Table (Amber Glass & Brass) */
      .chat-widget--hidden {
        display: none !important;
      }

	      .chat-widget {
	        position: fixed;
	        bottom: 0;
	        left: 0;
	        right: 0;
	        z-index: 10001; /* Must be higher than chat-backdrop (10000) */
	        font-family: "IBM Plex Sans", sans-serif;
	        background: transparent;
	        pointer-events: auto; /* Allow ticker/chat interaction */
	      }

      /* ===========================================
         THE BONE LANGUAGE - Domino Tile Button
         "Put the bone in their face." — George Lois
         =========================================== */
      .chat-toggle {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        gap: 0;
        width: 84px;
        height: 135px;
        background: linear-gradient(
          180deg,
          #f5f0e6 0%,
          #e8e0d0 50%,
          #ddd5c5 100%
        );
        border: none;
        border-radius: 12px;
        padding: 0;
        cursor: pointer;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(212, 165, 116, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.5),
          inset 0 -2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        position: relative;
        overflow: visible;
        animation: boneHeartbeat 3s ease-in-out infinite;
      }

      /* Heartbeat pulse - the bone is alive */
      @keyframes boneHeartbeat {
        0%, 100% {
          transform: scale(1);
          box-shadow:
            0 8px 32px rgba(0, 0, 0, 0.5),
            0 0 0 1px rgba(212, 165, 116, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.5),
            inset 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
        50% {
          transform: scale(1.02);
          box-shadow:
            0 10px 40px rgba(0, 0, 0, 0.55),
            0 0 0 1px rgba(212, 165, 116, 0.5),
            0 0 30px rgba(212, 165, 116, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.5),
            inset 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
      }

      /* Domino pip pattern - 5 pips like the "5" side of a die */
      .chat-toggle::before {
        content: '';
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: 54px;
        height: 54px;
        background:
          radial-gradient(circle at 25% 25%, var(--brass) 6px, transparent 6px),
          radial-gradient(circle at 75% 25%, var(--brass) 6px, transparent 6px),
          radial-gradient(circle at 50% 50%, var(--brass) 6px, transparent 6px),
          radial-gradient(circle at 25% 75%, var(--brass) 6px, transparent 6px),
          radial-gradient(circle at 75% 75%, var(--brass) 6px, transparent 6px);
        pointer-events: none;
      }

      /* Horizontal divider line - the bone's spine */
      .chat-toggle::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 10px;
        right: 10px;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(183, 106, 59, 0.4) 15%,
          rgba(183, 106, 59, 0.4) 85%,
          transparent 100%
        );
        pointer-events: none;
      }

      .chat-toggle:hover {
        animation: none;
        transform: translateY(-8px) scale(1.04); /* Tobias: Enhanced Lift */
        box-shadow:
          0 24px 60px rgba(0, 0, 0, 0.7),
          0 0 0 1px rgba(212, 165, 116, 0.6),
          0 0 80px rgba(212, 165, 116, 0.25),
          inset 0 1px 0 rgba(255, 255, 255, 0.5),
          inset 0 -2px 4px rgba(0, 0, 0, 0.1);
      }

      .chat-toggle__text {
        font-family: "Bodoni Moda", serif;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.7rem;
        font-weight: 700;
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        padding: 8px 6px 14px;
      }

      /* Hide the old pulsing dot - pips are the new icon */
      .chat-toggle__icon {
        display: none;
      }

      .chat-toggle__badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--copper);
        color: #fff;
        font-family: "Bodoni Moda", serif;
        font-size: 0.75rem;
        min-width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        box-shadow: 0 3px 12px rgba(0,0,0,0.5);
        border: 2px solid #f5f0e6;
      }

      /* Chat Panel - The Vessel */
      .chat-panel {
        position: fixed;
        bottom: 0;
        right: 24px;
        width: 400px;
        height: 600px;
        max-height: 80vh;
        overscroll-behavior: contain; /* Prevent scroll chaining to body */
        background:
          radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.4) 100%),
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E"),
          linear-gradient(180deg, rgb(28, 19, 15) 0%, rgb(20, 14, 11) 100%);
        background-blend-mode: normal, overlay, normal;
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px 12px 0 0;
        display: flex;
        flex-direction: column;
        /*
         * Clip overflow without creating a scroll container.
         * Otherwise focus/scroll can move the entire panel (header + hub) out of view.
         */
        overflow: hidden;
        overflow: clip;
        box-shadow: 0 -12px 48px rgba(0,0,0,0.6);
        z-index: 10003; /* Above ticker (10002) */
        transform: translateY(100%) scale(0.96);
        transform-origin: center bottom;
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
        opacity: 0;
        pointer-events: none; /* Prevent interaction when closed */
      }

      @media (max-width: 768px) {
        .chat-panel {
          right: 0;
          left: 0;
          width: 100%;
          bottom: 0;
          height: 80vh;
          border-radius: 12px 12px 0 0;

        }
      }

      /* Subtle wood grain accent on left edge */
      .chat-panel::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: repeating-linear-gradient(
          180deg,
          rgba(139, 90, 43, 0.15) 0px,
          rgba(139, 90, 43, 0.08) 2px,
          transparent 2px,
          transparent 6px
        );
        pointer-events: none;
        z-index: 11;
      }

      .chat-panel.is-open {
        transform: translateY(0) scale(1);
        opacity: 1;
        pointer-events: auto; /* Enable interaction when open */
      }

      /* Second-screen peek: keep the room open without taking over */
      .chat-panel.is-open.is-peek {
        height: 420px;
        max-height: 56vh;
      }

      /* Hide hub in peek mode - only show in full mode */
      .chat-panel.is-open.is-peek .mesa-hub-stack {
        display: none;
      }

      /* Identity Mode: Hide header and seats when showing "Claim Your Seat" */
      .chat-panel.is-identity-mode .chat-header,
      .chat-panel.is-identity-mode .mesa-seats {
        display: none !important;
      }

      /* Tobias: "Breath Spacing" - staggered content reveal after panel slides in */
      .chat-panel .chat-identity,
      .chat-panel .chat-body-container {
        opacity: 0;
        transform: translateY(8px);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .chat-panel.is-open .chat-header {
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.35s ease, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        transition-delay: 0.1s;
      }

      .chat-panel.is-open .chat-identity,
      .chat-panel.is-open .chat-body-container {
        opacity: 1;
        transform: translateY(0);
        transition-delay: 0.2s;
      }

      .chat-panel.is-closing {
        transform: translateY(100%) scale(0.96);
        opacity: 0;
        pointer-events: none;
      }

      .chat-panel.is-closing .chat-header,
      .chat-panel.is-closing .chat-identity,
      .chat-panel.is-closing .chat-body-container {
        opacity: 0;
        transform: translateY(8px);
        transition-delay: 0s;
      }

      /* ========================================
         LA MESA ENTRY RITUAL (Identity → Room)
         ======================================== */
      .chat-panel.is-entering {
        pointer-events: none; /* No accidental taps during the cut */
      }

      .chat-panel.is-entering .chat-identity {
        opacity: 0;
        transform: translateY(10px) scale(0.99);
        filter: blur(2px);
        transition: opacity 0.22s ease, transform 0.22s ease, filter 0.22s ease;
      }

      .chat-panel.is-entering .chat-body-container {
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.28s ease, transform 0.28s ease;
      }

      .mesa-entry {
        position: absolute;
        inset: 0;
        z-index: 24; /* Above header (10) + wood edge (11) */
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.28s ease, visibility 0.28s ease;
      }

      .chat-panel.is-entering .mesa-entry {
        opacity: 1;
        visibility: visible;
      }

      .mesa-entry__fog {
        position: absolute;
        inset: -20%;
        background:
          radial-gradient(ellipse at 50% 30%, rgba(212, 165, 116, 0.14) 0%, transparent 55%),
          radial-gradient(ellipse at 65% 80%, rgba(183, 106, 59, 0.10) 0%, transparent 60%),
          radial-gradient(ellipse at 15% 85%, rgba(212, 165, 116, 0.08) 0%, transparent 55%),
          radial-gradient(ellipse at center, rgba(10, 7, 5, 0.92) 0%, rgba(10, 7, 5, 0.98) 55%, rgba(10, 7, 5, 1) 100%);
        opacity: 0.95;
        transform: translateY(12px) scale(1.06);
      }

      .chat-panel.is-entering .mesa-entry.is-live .mesa-entry__fog {
        animation: mesaEntryFog 1.05s ease-out both;
      }

      @keyframes mesaEntryFog {
        0% { transform: translateY(18px) scale(1.08); opacity: 0.8; }
        55% { transform: translateY(0) scale(1.03); opacity: 1; }
        100% { transform: translateY(-6px) scale(1.02); opacity: 0.95; }
      }

      .mesa-entry__grain {
        position: absolute;
        inset: -50%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.035;
        mix-blend-mode: overlay;
      }

      .mesa-entry__vignette {
        position: absolute;
        inset: 0;
        background: radial-gradient(ellipse at center, transparent 32%, rgba(0, 0, 0, 0.62) 100%);
        opacity: 0.9;
      }

      .mesa-entry__content {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 14px;
        opacity: 0;
        transform: translateY(10px) scale(0.98);
      }

      .chat-panel.is-entering .mesa-entry.is-live .mesa-entry__content {
        animation: mesaEntryContentIn 0.52s cubic-bezier(0.2, 1, 0.2, 1) 0.12s both;
      }

      @keyframes mesaEntryContentIn {
        0% { opacity: 0; transform: translateY(16px) scale(0.975); }
        60% { opacity: 1; transform: translateY(0) scale(1.01); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
      }

      .mesa-entry__seal {
        position: absolute;
        width: 148px;
        height: 148px;
        border-radius: 50%;
        background:
          radial-gradient(circle at 50% 45%, rgba(212, 165, 116, 0.18) 0%, transparent 55%),
          radial-gradient(circle at center, rgba(0, 0, 0, 0.35) 0%, rgba(0, 0, 0, 0.7) 70%, rgba(0, 0, 0, 0.9) 100%);
        border: 1px solid rgba(212, 165, 116, 0.28);
        box-shadow:
          0 18px 55px rgba(0, 0, 0, 0.65),
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          inset 0 0 22px rgba(212, 165, 116, 0.08);
        transform: translateY(-2px);
      }

      .chat-panel.is-entering .mesa-entry.is-live .mesa-entry__seal {
        animation: mesaEntrySealPulse 0.9s ease-out 0.18s both;
      }

      @keyframes mesaEntrySealPulse {
        0% { box-shadow: 0 18px 55px rgba(0, 0, 0, 0.65), inset 0 1px 0 rgba(255, 255, 255, 0.08), inset 0 0 22px rgba(212, 165, 116, 0.08); }
        45% { box-shadow: 0 18px 55px rgba(0, 0, 0, 0.65), inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 0 34px rgba(212, 165, 116, 0.22), 0 0 44px rgba(212, 165, 116, 0.18); }
        100% { box-shadow: 0 18px 55px rgba(0, 0, 0, 0.65), inset 0 1px 0 rgba(255, 255, 255, 0.08), inset 0 0 22px rgba(212, 165, 116, 0.1); }
      }

      .mesa-entry__flag {
        width: 84px;
        height: 84px;
        border-radius: 50%;
        border: 1px solid rgba(212, 165, 116, 0.34);
        background: rgba(255, 255, 255, 0.05);
        box-shadow:
          0 14px 48px rgba(0, 0, 0, 0.6),
          0 0 0 rgba(212, 165, 116, 0),
          inset 0 1px 0 rgba(255, 255, 255, 0.18);
        transform: translateZ(0);
      }

      .chat-panel.is-entering .mesa-entry.is-live .mesa-entry__flag {
        animation: mesaEntryFlagSlam 0.52s cubic-bezier(0.2, 0.85, 0.2, 1) 0.22s both;
      }

      @keyframes mesaEntryFlagSlam {
        0% { transform: scale(0.86); filter: brightness(0.96); box-shadow: 0 14px 48px rgba(0,0,0,0.6), 0 0 0 rgba(212, 165, 116, 0), inset 0 1px 0 rgba(255,255,255,0.18); }
        55% { transform: scale(1.12); filter: brightness(1.06); box-shadow: 0 18px 60px rgba(0,0,0,0.72), 0 0 40px rgba(212, 165, 116, 0.22), inset 0 1px 0 rgba(255,255,255,0.22); }
        100% { transform: scale(1); filter: brightness(1); box-shadow: 0 14px 48px rgba(0,0,0,0.6), 0 0 22px rgba(212, 165, 116, 0.12), inset 0 1px 0 rgba(255,255,255,0.18); }
      }

      .mesa-entry__text {
        text-align: center;
        display: grid;
        gap: 6px;
      }

      .mesa-entry__kicker {
        font-family: "IBM Plex Sans Condensed", system-ui, sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 0.72rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .mesa-entry__name {
        font-family: "Bodoni Moda", serif;
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--cream);
        letter-spacing: 0.02em;
        text-shadow: 0 0 18px rgba(212, 165, 116, 0.18);
      }

      .chat-panel.is-entering .mesa-entry.is-live .mesa-entry__text {
        animation: mesaEntryTextRise 0.56s cubic-bezier(0.2, 1, 0.2, 1) 0.32s both;
      }

      @keyframes mesaEntryTextRise {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
      }

      @media (prefers-reduced-motion: reduce) {
        .chat-panel.is-entering .chat-identity,
        .chat-panel.is-entering .chat-body-container,
        .chat-panel.is-entering .mesa-entry,
        .chat-panel.is-entering .mesa-entry * {
          animation: none !important;
          transition: none !important;
          filter: none !important;
        }
      }

      /* Background Dimming for Chat Overlay - Tobias: "Camera Cut" focus shift */
      .chat-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        z-index: 10000; /* Just below chat panel */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.35s ease-out, visibility 0.35s ease-out;
      }

      .chat-backdrop.is-visible {
        opacity: 1;
        visibility: visible;
      }

      /* Header - The Inscription */
      .chat-header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 20px 24px;
        position: relative;
        border-bottom: 1px solid rgba(212, 165, 116, 0.1);
        flex-shrink: 0;
        z-index: 100;
        background: rgba(20, 14, 11, 0.98);
        min-height: 60px;
      }

      /* Drag handle for mobile (visual affordance) */
      .chat-header__drag-handle {
        grid-column: 1;
        justify-self: start;
        width: 32px;
        height: 4px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 2px;
        display: none; /* Show only on mobile via media query */
      }

      .chat-header__title-group {
        grid-column: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .chat-header__title {
        font-family: "SF Sports Night", "Bodoni Moda", serif;
        font-weight: 400;
        font-size: 1.3rem;
        color: var(--brass);
        text-transform: uppercase;
        letter-spacing: 0.15em;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        position: relative;
        padding-bottom: 8px;
      }

      /* Brass underline - "Like a sign above a door" — Herb Lubalin
         LA MESA is a PLACE. You have arrived. */
      .chat-header__title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 80px;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--brass) 20%,
          var(--brass) 80%,
          transparent 100%
        );
        border-radius: 1px;
      }

      .chat-header__subtitle {
        font-family: "Bodoni Moda", serif;
        font-size: 0.6rem;
        color: var(--copper);
        opacity: 0.4; /* Wes: reduce opacity to 0.4 */
        letter-spacing: 0.08em;
        font-variant: small-caps; /* Wes: small-caps, not uppercase */
        margin-top: 6px;
      }

      .chat-header__status {
        margin-top: 8px;
        background: transparent;
        border: 0;
        padding: 0;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.72rem;
        color: rgba(255, 255, 255, 0.55);
        letter-spacing: 0.02em;
        font-weight: 500;
        transition: color 0.25s ease;
      }

      .chat-header__status:hover {
        color: rgba(255, 255, 255, 0.85);
      }

      .chat-header__status:focus-visible {
        outline: 2px solid rgba(212, 165, 116, 0.45);
        outline-offset: 6px;
        border-radius: 12px;
      }

      .chat-header__status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.55);
        flex-shrink: 0;
        animation: mesaStatusPulse 1.6s ease-in-out infinite;
      }

      @keyframes mesaStatusPulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.85); }
      }

      /* Decorative accent below subtitle */
      .chat-header__title-group::after {
        content: "";
        display: block;
        width: 6px;
        height: 6px;
        background: var(--copper);
        margin: 10px auto 0;
        opacity: 0.4;
        border-radius: 50%;
      }

      /* Seats strip - horizontal presence (no split screen) */
      .mesa-seats {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 18px 12px;
        border-bottom: 1px solid rgba(212, 165, 116, 0.08);
        background: linear-gradient(180deg, rgba(20, 14, 11, 0.65) 0%, rgba(20, 14, 11, 0) 100%);
      }

      .mesa-seats__label {
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-size: 0.65rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .mesa-seats__row {
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 1;
        min-width: 0;
        overflow: hidden;
      }

      .mesa-seat {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid rgba(212, 165, 116, 0.25);
        background: rgba(28, 19, 15, 0.6);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        color: var(--brass);
        flex-shrink: 0;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.35);
      }

      .mesa-seats__empty {
        font-family: "Bodoni Moda", serif;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.35);
        font-style: italic;
        white-space: nowrap;
      }

      .mesa-seats__more {
        background: rgba(212, 165, 116, 0.12);
        border: 1px solid rgba(212, 165, 116, 0.25);
        color: var(--brass);
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-weight: 700;
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        padding: 6px 10px;
        border-radius: 12px;
        cursor: pointer;
        flex-shrink: 0;
      }

      .chat-header__close {
        position: absolute;
        right: 16px;
        top: 16px;
        background: rgba(20, 14, 11, 0.55);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(212, 165, 116, 0.18);
        color: rgba(212, 165, 116, 0.8);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.62rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        z-index: 20;
      }

      .chat-header__close::before {
        content: "←";
        font-size: 0.95rem;
        transition: transform 0.3s ease;
      }

      .chat-header__close-label {
        display: inline-block;
        line-height: 1;
      }

      .chat-header__close:hover {
        background: rgba(28, 19, 15, 0.75);
        color: #fff;
        border-color: rgba(212, 165, 116, 0.35);
        transform: translateY(-1px);
      }

      .chat-header__close:hover::before {
        transform: translateX(-2px);
      }

      .chat-header__close:active {
        transform: translateY(0) scale(0.96);
      }

      .chat-header__dock {
        position: absolute;
        right: 132px; /* Leaves room for close button */
        top: 16px;
        background: rgba(20, 14, 11, 0.55);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(212, 165, 116, 0.18);
        color: rgba(212, 165, 116, 0.8);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.62rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        z-index: 20;
      }

      .chat-header__dock[aria-pressed="true"] {
        background: rgba(28, 19, 15, 0.85);
        border-color: rgba(212, 165, 116, 0.35);
        color: #fff;
        box-shadow: 0 0 0 1px rgba(212, 165, 116, 0.15), 0 0 18px rgba(212, 165, 116, 0.12);
      }

      .chat-header__dock:hover {
        background: rgba(28, 19, 15, 0.75);
        color: #fff;
        border-color: rgba(212, 165, 116, 0.35);
        transform: translateY(-1px);
      }

      .chat-header__dock:active {
        transform: translateY(0) scale(0.96);
      }

      .chat-header__dock-label {
        display: inline-block;
        line-height: 1;
      }

      .chat-header__dock::before {
        content: "⧉";
        font-size: 0.9rem;
        line-height: 1;
        transform: translateY(-0.5px);
      }

      .chat-header__dock[aria-pressed="true"]::before {
        content: "⤢";
      }

      /* Content Area */
      .chat-body-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow-y: auto; /* Allow scrolling when content exceeds height */
        overflow-x: hidden;
        min-height: 0; /* Required for nested flex scrolling */
      }

      /* Ritual strip - the room’s small “weenie” (presence + intent) */
      .mesa-ritual {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-bottom: 1px solid rgba(212, 165, 116, 0.12);
        background: rgba(20, 14, 11, 0.92);
      }

      .mesa-ritual__pill {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(212, 165, 116, 0.14);
        color: rgba(255, 255, 255, 0.82);
        font-family: "IBM Plex Sans", sans-serif;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        font-size: 0.62rem;
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
        white-space: nowrap;
      }

      .mesa-ritual__pill:active {
        transform: scale(0.98);
      }

      .mesa-ritual__pill--toggle[aria-pressed="true"] {
        background: rgba(212, 165, 116, 0.12);
        border-color: rgba(212, 165, 116, 0.3);
        color: rgba(212, 165, 116, 0.95);
        box-shadow: 0 0 0 1px rgba(212, 165, 116, 0.12), 0 0 18px rgba(212, 165, 116, 0.12);
      }

      .mesa-ritual__chips {
        display: flex;
        align-items: center;
        gap: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        margin-left: auto;
        padding-bottom: 2px;
      }

      .mesa-ritual__chips::-webkit-scrollbar { display: none; }

      .mesa-chip {
        min-width: 34px;
        height: 34px;
        display: grid;
        place-items: center;
        border-radius: 12px;
        border: 1px solid rgba(212, 165, 116, 0.16);
        background: rgba(255, 255, 255, 0.03);
        cursor: pointer;
        transition: transform 0.08s ease-out, background 0.2s ease, border-color 0.2s ease;
      }

      .mesa-chip:active {
        transform: translateY(1px) scale(0.96);
        background: rgba(212, 165, 116, 0.08);
        border-color: rgba(212, 165, 116, 0.28);
      }

      .chat-messages {
        flex: 1;
        min-height: 200px; /* Ensure messages area has minimum height */
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        scrollbar-width: thin;
        scrollbar-color: var(--muted) transparent;
        position: relative;
        /* Warm fog gradient - tobacco smoke atmosphere (Wes: amber in the shadows) */
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.25) 0%,
          rgba(20, 14, 11, 0.15) 30%,
          rgba(28, 19, 15, 0.05) 70%,
          transparent 100%
        );
      }

      /* Tobias: Live Smoke Filter for Chat Background */
      .chat-messages::after {
        content: '';
        position: absolute;
        inset: 0;
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.015' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        mix-blend-mode: overlay;
        opacity: 0.5;
        pointer-events: none;
        z-index: 1;
      }

      /* Ensure message cards render ABOVE the smoke texture layer */
      .chat-messages > * {
        position: relative;
        z-index: 2;
      }

      .chat-messages::-webkit-scrollbar { width: 4px; }
      .chat-messages::-webkit-scrollbar-track { background: transparent; }
      .chat-messages::-webkit-scrollbar-thumb { background: var(--muted); }

      /* Entrance Announcement - George: Make entrances MATTER */
      .chat-announcement {
        text-align: center;
        padding: 12px 16px;
        font-family: "Bodoni Moda", serif;
        font-size: 0.8rem;
        color: var(--copper);
        letter-spacing: 0.05em;
        opacity: 0.8;
        animation: announceFade 0.6s ease-out;
        position: relative;
      }

      .chat-announcement::before,
      .chat-announcement::after {
        content: '';
        position: absolute;
        top: 50%;
        width: 40px;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(183, 106, 59, 0.3), transparent);
      }

      .chat-announcement::before { left: 20px; }
      .chat-announcement::after { right: 20px; }

      /* Tobias: Brass pip instead of emoji - keeps the ritualistic tone */
      .chat-announcement__icon {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: radial-gradient(circle at 35% 35%, #e8c896 0%, var(--brass) 60%, var(--copper) 100%);
        border-radius: 50%;
        margin-right: 10px;
        vertical-align: middle;
        box-shadow: 0 0 8px rgba(212, 165, 116, 0.5);
      }

      .chat-announcement__name {
        color: var(--brass);
        font-weight: 600;
      }

      @keyframes announceFade {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 0.8;
          transform: scale(1);
        }
      }

      /* ===========================================
         LA MESA MESSAGE STYLING
         "Make them feel like they're at the table."
         =========================================== */

      .chat-message {
        padding: 14px 16px;
        border-radius: 12px;
        background: rgba(28, 19, 15, 0.62);
        border: 1px solid rgba(212, 165, 116, 0.09);
        animation: weightedArrival 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
        transition: all 0.2s ease;
        position: relative;
      }

      /* Tobias: Weighted Arrival - slide + blur + scale */
      @keyframes weightedArrival {
        from {
          opacity: 0;
          transform: translateY(12px) scale(0.98);
          filter: blur(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* Staggered message entry for rhythm */
      .chat-message:nth-child(3n+1) { animation-delay: 0ms; }
      .chat-message:nth-child(3n+2) { animation-delay: 40ms; }
      .chat-message:nth-child(3n) { animation-delay: 80ms; }

      /* Tobias: "Someone sat down" - heavier arrival for new speaker */
      .chat-message--new-voice {
        animation: newVoiceArrival 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
      }

      @keyframes newVoiceArrival {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
          filter: blur(6px);
        }
        70% {
          opacity: 1;
          transform: translateY(-2px) scale(1.01);
          filter: blur(0);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* Others - subtle left accent */
      .chat-message:not(.chat-message--self) {
        border-left: 3px solid rgba(183, 106, 59, 0.3);
      }

      /* Self messages - Ochún's gold accent */
      .chat-message--self {
        text-align: left;
        background: rgba(212, 165, 116, 0.06);
        border-left: 3px solid rgba(212, 165, 116, 0.4);
      }

      .chat-message--self:hover {
        background: rgba(212, 165, 116, 0.1);
      }

      /* Self message author styling */
      .chat-message--self .chat-message__author-name {
        color: var(--brass);
      }

      .chat-message:nth-child(3n+2) { animation-delay: 40ms; }
      .chat-message:nth-child(3n) { animation-delay: 80ms; }

      /* Avatar option image placeholders (for selector) */
      .avatar-option-img {
         width: 20px;
         height: 20px;
         background-size: contain;
      }

	      /* Circular flag assets (for selector) */
	      .avatar-flag-img {
	        position: relative;
	        width: 40px;
	        height: 40px;
	        display: block;
	        border-radius: 50%;
	        object-fit: cover;
	        object-position: center center;
	        user-select: none;
	        -webkit-user-drag: none;
	        pointer-events: none;
	        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.45);
	        transition: transform 0.2s ease, box-shadow 0.2s ease;
	        z-index: 2;
	      }

	      /* Country name label above flag - HIDDEN */
	      .avatar-option::before {
	        display: none !important;
	      }

	      @media (hover: hover) and (pointer: fine) {
	        .avatar-option:hover .avatar-flag-img {
	          transform: scale(1.08);
	        }
	      }

	      /* Selected flag - no ring, just subtle enhancement (ring is on center cue) */
	      .avatar-option.selected .avatar-flag-img {
	        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
	      }

      /* Flag in chat messages - inline with name */
      .chat-message__flag {
        font-size: 1.1rem;
        line-height: 1;
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4));
      }

      /* Legacy avatar-flag for selector */
      .avatar-flag {
        font-size: 24px;
        line-height: 1;
        display: block;
        text-align: center;
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      }

      .chat-message__content-wrapper {
        flex: 1;
        min-width: 0;
      }

      .chat-message__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 12px;
      }

      .chat-message__author {
        font-family: "Bodoni Moda", serif;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* Free Agent Pip - Single pip = "half of something, waiting for a partner"
         "One pip is incomplete. A soul looking for its other half." — Wifredo Lam */
      .free-agent-pip {
        color: var(--brass);
        font-size: 0.7rem;
        text-shadow: 0 0 6px rgba(212, 165, 116, 0.5);
        margin-left: 4px;
      }

      /* Author name - PROMINENT */
      .chat-message__author-name {
        font-family: "Bodoni Moda", serif;
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--brass);
        letter-spacing: 0.03em;
      }

      /* Self name highlighted */
      .chat-message--self .chat-message__author-name {
        color: #e8c896;
        text-shadow: 0 0 12px rgba(212, 165, 116, 0.3);
      }

      /* Others in warmer copper */
      .chat-message:not(.chat-message--self) .chat-message__author-name {
        color: #d4a574;
      }

      /* Timestamp - subtle, secondary */
      .chat-message__time {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.35);
        letter-spacing: 0.02em;
        font-weight: 500;
      }

      /* Message content */
      .chat-message__content {
        color: rgba(255, 255, 255, 0.9);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        line-height: 1.6;
        font-weight: 400;
      }

      /* ===========================================
         PINNED MESSAGES - Honored at the Table
         =========================================== */
      .chat-message--pinned {
        background: rgba(212, 165, 116, 0.1);
        border-color: rgba(212, 165, 116, 0.25);
        border-left: 3px solid var(--brass) !important;
      }
      .chat-message--pinned:hover {
        background: rgba(212, 165, 116, 0.14);
      }

      /* Pinned badge - elegant, not emoji */
      .pinned-badge {
        position: absolute;
        top: -10px;
        right: 12px;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--brass);
        background: rgba(28, 19, 15, 0.95);
        padding: 4px 10px;
        border-radius: 12px;
        border: 1px solid rgba(212, 165, 116, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      /* Pin functionality is admin-only (Erik via backend) */

      /* Pinned Section */
      .pinned-section {
        background: rgba(212, 165, 116, 0.04);
        border-bottom: 1px solid rgba(212, 165, 116, 0.12);
        padding: 12px 0 16px;
        margin-bottom: 12px;
      }
      .pinned-section__label {
        font-family: "Bodoni Moda", serif;
        font-size: 0.7rem;
        color: var(--brass);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        padding: 8px 16px;
        opacity: 0.7;
      }

      .chat-empty {
        text-align: center;
        color: rgba(255, 255, 255, 0.3);
        margin-top: 40px;
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-size: 0.9rem;
        letter-spacing: 0.05em;
      }

      /* ===========================================
         MESA PRESENCE - Who’s Here (The Heartbeat)
         =========================================== */
      .mesa-presence {
        position: absolute;
        inset: 0;
        z-index: 40;
        display: none;
      }

      .mesa-presence.is-open {
        display: block;
      }

      .mesa-presence__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .mesa-presence__sheet {
        position: absolute;
        left: 12px;
        right: 12px;
        bottom: 12px;
        max-height: min(70%, 520px);
        display: flex;
        flex-direction: column;
        background: rgba(20, 14, 11, 0.98);
        border: 1px solid rgba(212, 165, 116, 0.18);
        border-radius: 12px;
        box-shadow: 0 18px 60px rgba(0,0,0,0.7);
        overflow: hidden;
      }

      .mesa-presence__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 14px 12px;
        border-bottom: 1px solid rgba(212, 165, 116, 0.12);
      }

      .mesa-presence__title {
        font-family: "Bodoni Moda", serif;
        font-size: 0.9rem;
        color: var(--brass);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        font-style: italic;
      }

      .mesa-presence__close {
        background: rgba(28, 19, 15, 0.75);
        border: 1px solid rgba(212, 165, 116, 0.22);
        color: rgba(255, 255, 255, 0.8);
        font-family: "IBM Plex Sans", sans-serif;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 0.62rem;
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
      }

      .mesa-presence__close:active {
        transform: scale(0.98);
      }

      .mesa-presence__list {
        padding: 10px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .mesa-presence__row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(212, 165, 116, 0.12);
        background: rgba(255, 255, 255, 0.03);
      }

      .mesa-presence__who {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .mesa-presence__flag {
        width: 28px;
        height: 28px;
        display: grid;
        place-items: center;
        border-radius: 12px;
        background: rgba(212, 165, 116, 0.08);
        border: 1px solid rgba(212, 165, 116, 0.18);
        flex-shrink: 0;
      }

      .mesa-presence__name {
        font-family: "IBM Plex Sans", sans-serif;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.92);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .mesa-presence__badges {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;
      }

      .mesa-presence__badge {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.62rem;
        font-weight: 800;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        padding: 6px 8px;
        border-radius: 10px;
        border: 1px solid rgba(212, 165, 116, 0.22);
        background: rgba(212, 165, 116, 0.08);
        color: rgba(212, 165, 116, 0.95);
      }

      .mesa-presence__invite {
        width: 34px;
        height: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        background: rgba(212, 165, 116, 0.12);
        border: 1px solid rgba(212, 165, 116, 0.22);
        color: rgba(212, 165, 116, 0.95);
        border-radius: 12px;
        cursor: pointer;
        flex-shrink: 0;
        opacity: 0.65;
        transition: opacity 0.15s ease, transform 0.15s ease, background 0.15s ease, border-color 0.15s ease;
      }

      .mesa-presence__row:hover .mesa-presence__invite {
        opacity: 1;
      }

      .mesa-presence__invite:active {
        transform: scale(0.96);
      }

      .mesa-presence__empty {
        padding: 18px 12px;
        text-align: center;
        color: rgba(255, 255, 255, 0.45);
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        letter-spacing: 0.04em;
      }

      /* ===========================================
         MESA TICKER - ESPN Sports Broadcast Style
         =========================================== */
      .mesa-ticker {
        height: 46px;
        /* Tobias: "Dark UI needs fog - layers of smoke, not a black wall" */
        background: linear-gradient(
          90deg,
          #0a0604 0%,
          #0d0806 25%,
          #0a0604 50%,
          #0d0806 75%,
          #0a0604 100%
        );
        border-top: 1px solid rgba(212, 165, 116, 0.2);
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        overflow: hidden;
        z-index: 10002; /* Highest, remains above chat panel shadow */
        box-shadow:
          0 -4px 24px rgba(0,0,0,0.6),
          inset 0 2px 8px rgba(0, 0, 0, 0.9),
          inset 0 -1px 3px rgba(212, 165, 116, 0.03); /* Tobias: Deeper recess */
	        transition: background 0.3s ease;
	        pointer-events: auto;
	      }

      /* Ticker dimming when chat is open - Tobias: "The room recedes"
         Not "UI grayed out", but depth receding into background */
      .mesa-ticker.ticker-dimmed {
        background: rgba(10, 6, 4, 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .mesa-ticker.ticker-dimmed .mesa-ticker__track,
      .mesa-ticker.ticker-dimmed .mesa-ticker__badge {
        opacity: 0.35;
        filter: blur(1px) saturate(0.7);
        transform: scale(0.98) translateY(2px);
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }
      @media (min-width: 769px) {
        .mesa-ticker.ticker-dimmed:hover .mesa-ticker__track,
        .mesa-ticker.ticker-dimmed:hover .mesa-ticker__badge {
          opacity: 1;
          filter: blur(0);
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .mesa-ticker {
          height: 40px;
          z-index: 10005; /* Above chat panel on mobile */
        }
      }

      /* "LA MESA" badge on left - refined ESPN energy for CDL */
      .mesa-ticker__badge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 0 16px 0 14px;
        background: linear-gradient(180deg, #d40000 0%, #b30000 50%, #8a0000 100%);
        color: #ffffff;
        font-family: 'SF Sports Night', 'IBM Plex Sans Condensed', Impact, sans-serif;
        font-size: 0.95rem; /* Slightly larger - sports fonts render smaller */
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em; /* Wider tracking for sports font legibility */
        flex-shrink: 0;
        position: relative;
        z-index: 3;
        /* Refined skew — still dynamic but balanced */
        transform: skewX(-5deg);
        box-shadow:
          4px 0 15px rgba(0,0,0,0.6),
          inset 0 1px 0 rgba(255,255,255,0.25),
          inset 0 -1px 0 rgba(0,0,0,0.3),
          0 0 25px rgba(204, 0, 0, 0.4);
        /* Softer diagonal edge */
        clip-path: polygon(0 0, 100% 0, 94% 100%, 0 100%);
        border-left: 3px solid rgba(255,255,255,0.15);
      }

      /* Un-skew the text inside + refined text treatment */
      .mesa-ticker__badge-text {
        transform: skewX(5deg);
        text-shadow:
          1px 1px 0 rgba(0,0,0,0.3),
          0 0 2px rgba(255,255,255,0.05);
        font-weight: 700;
      }

      /* White pulsing indicator dot - refined "LIVE" style */
      .mesa-ticker__badge-dot {
        width: 7px;
        height: 7px;
        background: #ffffff;
        border-radius: 50%;
        transform: skewX(5deg);
        flex-shrink: 0;
        animation: dotPulse 1.5s ease-in-out infinite;
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
      }

      @keyframes dotPulse {
        0%, 100% {
          opacity: 1;
          transform: skewX(5deg) scale(1);
          box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
        }
        50% {
          opacity: 0.5;
          transform: skewX(5deg) scale(0.8);
          box-shadow: 0 0 4px rgba(255, 255, 255, 0.4);
        }
      }

      /* Scrolling content area */
      .mesa-ticker__scroll {
        flex: 1;
        overflow: hidden;
        position: relative;
      }

      /* Fade edge on right only */
      .mesa-ticker__scroll::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 60px;
        background: linear-gradient(90deg, transparent 0%, #0a0604 100%);
        z-index: 2;
        pointer-events: none;
      }

      /* Domino Tile Button in Ticker - Tobias: "Physical Digital" */
      .mesa-ticker__chat-btn {
        width: 60px;
        height: 100%;
        background: linear-gradient(135deg, var(--brass) 0%, var(--copper) 100%);
        border: none;
        color: #0a0604;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 4;
        flex-shrink: 0;
        transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        box-shadow: -4px 0 15px rgba(0,0,0,0.4);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
	        outline: none;
	        pointer-events: auto;
	      }

      /* Tobias: Bevel/texture overlay for material conviction */
      .mesa-ticker__chat-btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(
          145deg,
          rgba(255,255,255,0.12) 0%,
          transparent 40%,
          transparent 60%,
          rgba(0,0,0,0.08) 100%
        );
        pointer-events: none;
        border-radius: inherit;
      }

      .mesa-ticker__chat-btn.is-pressed::before {
        background: linear-gradient(
          145deg,
          rgba(0,0,0,0.05) 0%,
          transparent 40%,
          transparent 60%,
          rgba(255,255,255,0.05) 100%
        );
      }

      /* Hide chat button until registration - Tobias: Animate the reveal */
      .mesa-ticker__chat-btn--hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.8);
      }

      /* Reveal animation when button becomes visible */
      .mesa-ticker__chat-btn.is-revealing {
        animation: chatBtnReveal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }

      @keyframes chatBtnReveal {
        0% {
          opacity: 0;
          transform: scale(0.8);
        }
        60% {
          opacity: 1;
          transform: scale(1.08);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Tobias: "The Lift" - but keep it inside the ticker (no translate; ticker clips overflow) */
      @media (hover: hover) and (pointer: fine) {
        .mesa-ticker__chat-btn:hover {
          background: linear-gradient(135deg, #e8c896 0%, var(--brass) 100%);
          filter: brightness(1.04) saturate(1.05);
          box-shadow:
            -4px 0 22px rgba(0,0,0,0.55),
            inset 0 1px 0 rgba(255,255,255,0.25),
            0 0 18px rgba(212, 165, 116, 0.18);
        }
      }

      /* Tobias: "The Slam" - domino pressed into wood */
      .mesa-ticker__chat-btn:active,
      .mesa-ticker__chat-btn.is-pressed {
        transform: translateY(1px);
        filter: brightness(0.92) contrast(1.1);
        box-shadow:
          -2px 0 6px rgba(0,0,0,0.5),
          inset 0 4px 16px rgba(0, 0, 0, 0.45),
          inset 0 1px 4px rgba(0, 0, 0, 0.3);
        transition: transform 0.04s ease-out, filter 0.04s ease-out, box-shadow 0.04s ease-out;
      }

      .mesa-ticker__chat-btn:focus {
        outline: none;
      }
      .mesa-ticker__chat-btn:focus-visible {
        outline: 2px solid rgba(212, 165, 116, 0.55);
        outline-offset: -2px;
      }

      /* LA MESA Heartbeat Pulse - "The room is calling" (Walt's weenie) */
      @keyframes mesaPulse {
        0%, 100% {
          box-shadow: -4px 0 15px rgba(0,0,0,0.4), 0 0 0 0 rgba(212, 165, 116, 0.4);
        }
        50% {
          box-shadow: -4px 0 15px rgba(0,0,0,0.4), 0 0 0 8px rgba(212, 165, 116, 0);
        }
      }

      .mesa-ticker__chat-btn:not(.is-pressed):not(:hover) {
        animation: mesaPulse 2s ease-in-out infinite;
      }

      /* Tobias: Unread message pulse - stronger urgency */
      .mesa-ticker__chat-btn.has-unread {
        animation: chatBtnCalling 1.5s infinite;
      }

      @keyframes chatBtnCalling {
        0%, 100% { box-shadow: -4px 0 15px rgba(0,0,0,0.4); }
        50% {
          box-shadow:
            -4px 0 25px rgba(212, 165, 116, 0.5),
            0 0 0 6px rgba(212, 165, 116, 0.3),
            inset 0 0 10px rgba(212, 165, 116, 0.2);
        }
      }

      .mesa-ticker__chat-badge {
        position: absolute;
        top: 2px;
        right: 4px;
        background: #cc0000;
        color: white;
        font-size: 0.6rem;
        font-weight: 800;
        min-width: 14px;
        height: 14px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #0a0604;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }

      .mesa-ticker__track {
        display: inline-flex;
        align-items: center;
        height: 100%;
        animation: tickerScroll 31s linear infinite;
        white-space: nowrap;
        will-change: transform;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        /* Force GPU compositing for smoother animation */
        transform: translate3d(0, 0, 0);
        -webkit-transform: translate3d(0, 0, 0);
        perspective: 1000px;
        -webkit-perspective: 1000px;
      }

      /* Explicit visibility when NOT dimmed - Safari fix */
      .mesa-ticker:not(.ticker-dimmed) .mesa-ticker__track,
      .mesa-ticker:not(.ticker-dimmed) .mesa-ticker__badge {
        opacity: 1 !important;
      }

      /*
        iOS Safari: stabilize compositing for fixed + animated ticker.
        Safari can mis-paint fixed elements with transforms/backdrop-filters and full-screen overlays,
        making the ticker appear dimmed even when `.ticker-dimmed` is not set.
      */
      @supports (-webkit-touch-callout: none) {
        .story {
          -webkit-overflow-scrolling: touch;
        }
        .chat-widget {
          z-index: 20001;
        }
        .mesa-ticker {
          z-index: 20002;
          isolation: isolate;
          transform: translate3d(0, 0, 0);
          -webkit-transform: translate3d(0, 0, 0);
        }
        .mesa-ticker__badge {
          transform: skewX(-5deg) translate3d(0, 0, 0);
          -webkit-transform: skewX(-5deg) translate3d(0, 0, 0);
        }
        .mesa-ticker__track,
        .mesa-ticker__chat-btn {
          transform: translate3d(0, 0, 0);
          -webkit-transform: translate3d(0, 0, 0);
        }
        .chat-panel {
          z-index: 20003;
        }
        .chat-backdrop {
          z-index: 20000;
        }
        .mesa-help {
          z-index: 20010;
        }
        .chromatic-aberration {
          mix-blend-mode: normal;
          opacity: 0.18;
          transform: translateZ(0);
          -webkit-transform: translateZ(0);
        }

        /* iOS Safari stability: avoid blend-mode + heavy transforms during scroll-snap (can flicker). */
        .panel-bg::after {
          mix-blend-mode: normal;
          opacity: 0.16;
        }
        .fog-layer {
          filter: blur(45px);
          animation: none;
        }
        .smoke-layer {
          mix-blend-mode: normal;
          opacity: 0.16;
          animation: none;
        }
        .panel.in-view .smoke-layer {
          opacity: 0.16;
        }
        .panel-bg {
          transition: none;
          transform: none !important;
        }
        .panel.in-view .panel-bg {
          transform: none !important;
        }

        /* Revisit breath can flicker on iOS; keep re-entry stable. */
        .panel--whisper.reentering .whisper-top,
        .panel--whisper.reentering .whisper-bottom,
        .panel--build.reentering .build-top,
        .panel--build.reentering .build-center,
        .panel--build.reentering .build-bottom,
        .panel--slam.reentering .slam-top,
        .panel--slam.reentering .slam-center,
        .panel--slam.reentering .slam-bottom {
          animation: none !important;
        }

        .panel--rules.reentering .rules-plaque {
          animation: none !important;
        }
      }

      /* Pause on hover (desktop only) */
      @media (hover: hover) and (pointer: fine) {
        .mesa-ticker__track:hover {
          animation-play-state: paused;
        }
      }

      /* "Unlock La Mesa" — Compact speech bubble above domino button */
      .mesa-help {
        position: fixed;
        /* Position above the ticker chat button (60px wide, at right edge) */
        right: calc(14px + env(safe-area-inset-right));
        bottom: calc(46px + 60px + 12px + env(safe-area-inset-bottom)); /* ticker height + button height + gap */
        z-index: 15000;
        width: max-content;
        max-width: 200px;
        margin: 0;
        /* Rich dark background — brass plaque feel */
        background: linear-gradient(135deg, rgba(10, 7, 5, 0.98) 0%, rgba(6, 4, 3, 0.98) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        /* Warm brass border */
        border: 1px solid rgba(183, 106, 59, 0.4);
        border-radius: 12px;
        padding: 0;
        overflow: visible;
        box-shadow:
          0 12px 40px rgba(0, 0, 0, 0.6),
          0 4px 12px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(212, 165, 116, 0.1);
        opacity: 0;
        transform: translateY(8px);
        pointer-events: none;
        transition: opacity 200ms ease, transform 200ms ease;
      }

      .mesa-help__kicker {
        display: none;
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: rgba(212, 165, 116, 0.75);
        margin: 0 0 6px 0;
        text-align: center;
      }

      .mesa-help.is-visible {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      /* Variant previews: set via `?mesaTip=plaque|broadcast|whisper` */
      :root[data-mesa-tooltip="plaque"] .mesa-help__kicker {
        display: none;
      }

      :root[data-mesa-tooltip="broadcast"] .mesa-help {
        background: linear-gradient(135deg, rgba(8, 6, 5, 0.98) 0%, rgba(5, 4, 3, 0.98) 100%);
        border-color: rgba(212, 165, 116, 0.28);
        border-radius: 12px;
        box-shadow:
          0 14px 44px rgba(0, 0, 0, 0.72),
          0 0 40px rgba(212, 165, 116, 0.06),
          inset 0 1px 0 rgba(255, 255, 255, 0.06);
      }

      :root[data-mesa-tooltip="broadcast"] .mesa-help::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 10px;
        background: linear-gradient(180deg, #d40000 0%, #8a0000 100%);
        clip-path: polygon(0 0, 100% 0, 70% 100%, 0 100%);
        opacity: 0.9;
      }

      :root[data-mesa-tooltip="broadcast"] .mesa-help__content {
        padding-left: 18px;
      }

      :root[data-mesa-tooltip="broadcast"] .mesa-help__kicker {
        display: block;
        color: rgba(255, 255, 255, 0.75);
        letter-spacing: 0.18em;
      }

      :root[data-mesa-tooltip="broadcast"] .mesa-help__text {
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        line-height: 1.25;
      }

      :root[data-mesa-tooltip="broadcast"] .mesa-help__highlight {
        -webkit-text-fill-color: unset;
        color: #ffffff;
        background: none;
        text-shadow: 0 0 18px rgba(212, 165, 116, 0.22);
      }

      :root[data-mesa-tooltip="broadcast"] .mesa-help__arrow {
        border-top-color: rgba(8, 6, 5, 0.98);
      }

      :root[data-mesa-tooltip="broadcast"] .mesa-help__arrow::before {
        border-top-color: rgba(212, 165, 116, 0.28);
      }

      :root[data-mesa-tooltip="whisper"] .mesa-help {
        background: rgba(28, 19, 15, 0.72);
        border-color: rgba(212, 165, 116, 0.18);
        border-radius: 12px;
        box-shadow:
          0 10px 32px rgba(0, 0, 0, 0.45),
          0 0 50px rgba(212, 165, 116, 0.05),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }

      :root[data-mesa-tooltip="whisper"] .mesa-help__kicker {
        display: block;
        font-weight: 600;
        letter-spacing: 0.12em;
        opacity: 0.85;
      }

      :root[data-mesa-tooltip="whisper"] .mesa-help__text {
        color: rgba(255, 255, 255, 0.82);
      }

      :root[data-mesa-tooltip="whisper"] .mesa-help__arrow {
        border-top-color: rgba(28, 19, 15, 0.72);
      }

      :root[data-mesa-tooltip="whisper"] .mesa-help__arrow::before {
        border-top-color: rgba(212, 165, 116, 0.18);
      }

      /* Downward-pointing arrow */
      .mesa-help__arrow {
        position: absolute;
        bottom: -8px;
        right: 20px; /* Align with domino button center */
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid rgba(10, 7, 5, 0.98);
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      }

      /* Small brass accent on arrow tip */
      .mesa-help__arrow::before {
        content: '';
        position: absolute;
        top: -9px;
        left: -8px;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid rgba(183, 106, 59, 0.4);
      }

      @media (max-width: 768px) {
        .mesa-help {
          right: 8px;
          bottom: calc(46px + 52px + 10px + env(safe-area-inset-bottom)); /* Adjusted for mobile ticker */
          max-width: 180px;
        }
        .mesa-help__arrow {
          right: 18px;
        }
        .mesa-help__content {
          padding: 10px 14px;
        }
        .mesa-help__text {
          font-size: 0.75rem;
        }
      }

      .mesa-help__content {
        padding: 12px 16px;
      }

      .mesa-help__highlight {
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        white-space: nowrap;
      }

      .mesa-help__text {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.82rem;
        line-height: 1.45;
        margin: 0;
        text-align: center;
      }

      @keyframes tickerScroll {
        0% { transform: translate3d(0, 0, 0); }
        100% { transform: translate3d(-50%, 0, 0); }
      }

      /* ===========================================
         TICKER ITEMS - Simple, clean, Tobias-style
         =========================================== */

      :global(.ticker-item) {
        display: inline-block;
        padding: 0 28px;
        font-family: 'IBM Plex Sans', system-ui, sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      /* Spots remaining - white, clear urgency */
      :global(.ticker-spots) {
        color: rgba(255, 255, 255, 0.7);
      }

      /* Names - warm brass, the social proof */
      :global(.ticker-name) {
        color: var(--brass);
        text-shadow: 0 0 20px rgba(212, 165, 116, 0.3);
      }

      /* Waiting state - subtle */
      :global(.ticker-waiting) {
        color: rgba(255, 255, 255, 0.4);
        font-weight: 400;
        font-style: italic;
        text-transform: none;
      }

      /* Live count */
      :global(.ticker-live) {
        color: rgba(255, 255, 255, 0.6);
      }
      :global(.ticker-live-dot) {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        margin-right: 8px;
        animation: livePulse 1.5s ease-in-out infinite;
      }
      @keyframes livePulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }

      /* Action text - the whisper */
      :global(.ticker-action) {
        font-weight: 400;
        font-size: 0.7rem;
        opacity: 0.5;
        margin-left: 6px;
        text-transform: lowercase;
      }

      /* Tournament updates - copper, attention */
      :global(.ticker-update) {
        color: var(--copper);
        text-shadow: 0 0 15px rgba(183, 106, 59, 0.4);
        text-transform: none;
        font-weight: 500;
      }

      /* Spacer for seamless loop */
      :global(.ticker-spacer) {
        display: inline-block;
        width: 60px;
      }

      /* Input Area - The Ledger (lighter at bottom - where the action happens) */
      .chat-input-area {
        padding: 20px;
        padding-bottom: 60px; /* 40px ticker + 20px breathing room */
        display: flex;
        gap: 16px;
        border-top: 1px solid rgba(212, 165, 116, 0.15);
        background: linear-gradient(
          180deg,
          rgba(28, 19, 15, 0.4) 0%,
          rgba(28, 19, 15, 0.6) 100%
        );
        position: relative;
      }

      @media (max-width: 768px) {
        .chat-input-area {
          padding-bottom: 54px; /* 34px ticker + 20px breathing room */
        }
      }

      /* Warm glow above input - the fog clears here */
      .chat-input-area::before {
        content: '';
        position: absolute;
        top: -40px;
        left: 0;
        right: 0;
        height: 40px;
        background: linear-gradient(
          180deg,
          transparent 0%,
          rgba(183, 106, 59, 0.03) 100%
        );
        pointer-events: none;
      }

      /* Tobias: "Does typing feel like speaking at the table?" */
      .chat-input {
        flex: 1;
        background: rgba(0, 0, 0, 0.15);
        border: none;
        border-bottom: 2px solid rgba(255, 255, 255, 0.15);
        padding: 12px 16px;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 16px; /* Must be 16px+ to prevent iOS Safari auto-zoom on focus */
        outline: none;
        transition: all 0.3s ease;
        border-radius: 12px 12px 0 0;
      }

      .chat-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
        font-style: italic;
      }

      /* Inner glow on focus - the table lights up when you speak */
      .chat-input:focus {
        background: rgba(212, 165, 116, 0.08);
        border-bottom-color: var(--brass);
        box-shadow:
          inset 0 0 20px rgba(212, 165, 116, 0.1),
          0 4px 12px rgba(0, 0, 0, 0.2);
      }

      /* Send Button - The Domino Pip
         A solid brass pip like on a domino tile.
         "The pip is elegant. It echoes what we built." — Wifredo Lam */
      .chat-send {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: radial-gradient(
          circle at 35% 35%,
          #e8c896 0%,
          var(--brass) 40%,
          var(--copper) 100%
        );
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow:
          0 3px 8px rgba(0, 0, 0, 0.4),
          0 1px 3px rgba(0, 0, 0, 0.3),
          inset 0 1px 2px rgba(255, 255, 255, 0.3),
          inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      /* Hide the arrow - the pip IS the button */
      .chat-send svg {
        display: none;
      }

      /* Subtle pulse when ready to send */
      .chat-send:not(:disabled) {
        animation: pipReady 2s ease-in-out infinite;
      }

      @keyframes pipReady {
        0%, 100% {
          box-shadow:
            0 3px 8px rgba(0, 0, 0, 0.4),
            0 1px 3px rgba(0, 0, 0, 0.3),
            inset 0 1px 2px rgba(255, 255, 255, 0.3),
            inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }
        50% {
          box-shadow:
            0 3px 8px rgba(0, 0, 0, 0.4),
            0 1px 3px rgba(0, 0, 0, 0.3),
            0 0 12px rgba(212, 165, 116, 0.4),
            inset 0 1px 2px rgba(255, 255, 255, 0.3),
            inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }
      }

      .chat-send:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow:
          0 5px 12px rgba(0, 0, 0, 0.5),
          0 2px 4px rgba(0, 0, 0, 0.3),
          0 0 20px rgba(212, 165, 116, 0.3),
          inset 0 1px 2px rgba(255, 255, 255, 0.3),
          inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        animation: none;
      }

      /* SLAM - like slamming a domino on the table
         "The slam is ritual. When you play a domino, you're declaring." — Wifredo Lam */
      .chat-send:not(:disabled):active {
        transform: translateY(3px) scale(0.9);
        transition: transform 0.05s ease-out;
        box-shadow:
          0 1px 2px rgba(0, 0, 0, 0.6),
          0 0 0 4px rgba(212, 165, 116, 0.4),
          0 0 30px rgba(212, 165, 116, 0.3),
          inset 0 1px 2px rgba(255, 255, 255, 0.3),
          inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        animation: none;
      }

      /* Slam class for programmatic slam effect */
      .chat-send.slamming {
        animation: pipSlam 0.15s ease-out forwards;
      }

      /* Tobias: "Domino placed on wood" - deeper compression, brightness flash */
      @keyframes pipSlam {
        0% {
          transform: scale(1);
          filter: brightness(1);
        }
        35% {
          transform: translateY(5px) scale(0.82);
          filter: brightness(1.15);
        }
        50% {
          transform: translateY(3px) scale(0.88);
          filter: brightness(1.08);
          box-shadow:
            0 1px 2px rgba(0, 0, 0, 0.7),
            0 0 0 10px rgba(212, 165, 116, 0.35),
            0 0 50px rgba(212, 165, 116, 0.5),
            inset 0 1px 2px rgba(255, 255, 255, 0.3),
            inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }
        100% {
          transform: translateY(0) scale(1);
          filter: brightness(1);
        }
      }

      /* Tobias: Inward impact ring - radial gradient collapse */
      .chat-send::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: radial-gradient(circle, transparent 60%, rgba(212, 165, 116, 0) 100%);
        opacity: 0;
        pointer-events: none;
      }

      .chat-send.slamming::before {
        animation: pipImpactRing 0.18s ease-out forwards;
      }

      @keyframes pipImpactRing {
        0% {
          background: radial-gradient(circle, transparent 0%, rgba(212, 165, 116, 0.4) 60%, transparent 100%);
          opacity: 1;
          transform: scale(1.3);
        }
        100% {
          background: radial-gradient(circle, transparent 60%, rgba(212, 165, 116, 0) 100%);
          opacity: 0;
          transform: scale(1);
        }
      }

      /* Ripple burst on send */
      .chat-send::after {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 50%;
        background: transparent;
        border: 2px solid transparent;
        transition: all 0.15s ease-out;
        pointer-events: none;
      }

      .chat-send.slamming::after {
        animation: pipRipple 0.3s ease-out forwards;
      }

      @keyframes pipRipple {
        0% {
          border-color: rgba(212, 165, 116, 0.6);
          transform: scale(1);
          opacity: 1;
        }
        100% {
          border-color: rgba(212, 165, 116, 0);
          transform: scale(1.8);
          opacity: 0;
        }
      }

      .chat-send:disabled {
        background: radial-gradient(
          circle at 35% 35%,
          rgba(255, 255, 255, 0.15) 0%,
          rgba(255, 255, 255, 0.08) 40%,
          rgba(255, 255, 255, 0.03) 100%
        );
        box-shadow:
          0 2px 4px rgba(0, 0, 0, 0.2),
          inset 0 1px 2px rgba(255, 255, 255, 0.05);
        cursor: not-allowed;
      }

      /* ===========================================
         LEAVE TABLE MODAL - Tobias: "The room should never feel like a browser"
         Custom modal to replace native confirm() for theatrical immersion.
         =========================================== */
      .leave-modal {
        position: fixed;
        inset: 0;
        z-index: 10010;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.25s ease, visibility 0.25s ease;
      }

      .leave-modal.is-open {
        opacity: 1;
        visibility: visible;
      }

      .leave-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(10, 6, 4, 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      .leave-modal__dialog {
        position: relative;
        background: linear-gradient(
          135deg,
          rgba(28, 19, 15, 0.98) 0%,
          rgba(20, 14, 10, 0.98) 100%
        );
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px;
        padding: 32px 28px;
        max-width: 320px;
        width: calc(100% - 48px);
        text-align: center;
        box-shadow:
          0 24px 60px rgba(0, 0, 0, 0.6),
          0 0 0 1px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        transform: translateY(20px) scale(0.95);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .leave-modal.is-open .leave-modal__dialog {
        transform: translateY(0) scale(1);
      }

      .leave-modal__title {
        font-family: "Bodoni Moda", serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--brass);
        margin: 0 0 12px 0;
        letter-spacing: 0.05em;
      }

      .leave-modal__message {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
        margin: 0 0 28px 0;
        line-height: 1.5;
      }

      .leave-modal__actions {
        display: flex;
        gap: 12px;
      }

      .leave-modal__btn {
        flex: 1;
        padding: 14px 20px;
        border-radius: 12px;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .leave-modal__btn--stay {
        background: transparent;
        border: 1px solid var(--brass);
        color: var(--brass);
      }

      .leave-modal__btn--stay:hover {
        background: rgba(212, 165, 116, 0.1);
        transform: translateY(-1px);
      }

      .leave-modal__btn--stay:active {
        transform: scale(0.97);
      }

      .leave-modal__btn--leave {
        background: linear-gradient(135deg, var(--brass) 0%, var(--copper) 100%);
        border: none;
        color: #0d0906;
      }

      .leave-modal__btn--leave:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(212, 165, 116, 0.3);
      }

      .leave-modal__btn--leave:active {
        transform: scale(0.97);
      }

      /* ===========================================
         TEAMS SYSTEM - Invite Toast & Creation Modal
         "Dominoes is about teams. Make it a BIG moment."
         =========================================== */

      /* Team Invite Toast - Slides in from top */
      .team-invite-toast {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%) translateY(-100%);
        z-index: 10020;
        width: calc(100% - 32px);
        max-width: 380px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .team-invite-toast.is-visible {
        transform: translateX(-50%) translateY(16px);
        opacity: 1;
        visibility: visible;
      }

      @media (min-width: 768px) {
        .team-invite-toast.is-visible {
          transform: translateX(-50%) translateY(24px);
        }
      }

      .team-invite-toast__content {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 16px 18px;
        background: linear-gradient(
          135deg,
          rgba(28, 19, 15, 0.98) 0%,
          rgba(20, 14, 10, 0.98) 100%
        );
        border: 1px solid rgba(212, 165, 116, 0.3);
        border-radius: 12px;
        box-shadow:
          0 16px 48px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      .team-invite-toast__icon {
        flex-shrink: 0;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--brass) 0%, var(--copper) 100%);
        border-radius: 50%;
        color: #0d0906;
      }

      .team-invite-toast__text {
        flex: 1;
        min-width: 0;
      }

      .team-invite-toast__from {
        display: block;
        font-family: "Bodoni Moda", serif;
        font-size: 1rem;
        font-weight: 700;
        color: var(--brass);
        letter-spacing: 0.02em;
      }

      .team-invite-toast__message {
        display: block;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 2px;
      }

      .team-invite-toast__actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .team-invite-toast__btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .team-invite-toast__btn--accept {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
      }

      .team-invite-toast__btn--accept:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 16px rgba(34, 197, 94, 0.4);
      }

      .team-invite-toast__btn--decline {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.6);
      }

      .team-invite-toast__btn--decline:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
      }

      .team-invite-toast__btn:active {
        transform: scale(0.95);
      }

      /* Team Creation Modal */
      .team-modal {
        position: fixed;
        inset: 0;
        z-index: 10015;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .team-modal.is-open {
        opacity: 1;
        visibility: visible;
      }

      .team-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(10, 6, 4, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      .team-modal__dialog {
        position: relative;
        background: linear-gradient(
          145deg,
          rgba(28, 19, 15, 0.99) 0%,
          rgba(18, 12, 9, 0.99) 100%
        );
        border: 1px solid rgba(212, 165, 116, 0.25);
        border-radius: 12px;
        padding: 32px 28px;
        max-width: 420px;
        width: calc(100% - 32px);
        max-height: calc(100vh - 48px);
        overflow-y: auto;
        box-shadow:
          0 32px 80px rgba(0, 0, 0, 0.7),
          0 0 0 1px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.06);
        transform: translateY(30px) scale(0.95);
        transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .team-modal.is-open .team-modal__dialog {
        transform: translateY(0) scale(1);
      }

      .team-modal__header {
        text-align: center;
        margin-bottom: 28px;
      }

      .team-modal__title {
        font-family: "Bodoni Moda", serif;
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--brass);
        margin: 0 0 8px 0;
        letter-spacing: 0.04em;
      }

      .team-modal__subtitle {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.7);
        margin: 0;
      }

      .team-modal__subtitle span {
        color: var(--cream);
        font-weight: 600;
      }

      .team-modal__form {
        margin-bottom: 28px;
      }

      .team-modal__label {
        display: block;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 10px;
      }

      .team-modal__input {
        width: 100%;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px;
        color: var(--cream);
        font-family: "Bodoni Moda", serif;
        font-size: 1.2rem;
        font-weight: 600;
        text-align: center;
        letter-spacing: 0.05em;
        outline: none;
        transition: all 0.25s ease;
        margin-bottom: 24px;
      }

      .team-modal__input:focus {
        background: rgba(212, 165, 116, 0.08);
        border-color: var(--brass);
        box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.15);
      }

      .team-modal__input::placeholder {
        color: rgba(212, 165, 116, 0.35);
        font-style: italic;
      }

      /* Archetype Grid */
      .team-archetype-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .team-archetype {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 16px 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.25s ease;
        position: relative;
        overflow: hidden;
      }

      .team-archetype::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(212, 165, 116, 0.15) 0%, transparent 60%);
        opacity: 0;
        transition: opacity 0.25s ease;
      }

      .team-archetype:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(212, 165, 116, 0.2);
        transform: translateY(-2px);
      }

      .team-archetype:hover::before {
        opacity: 1;
      }

      .team-archetype.selected {
        background: rgba(212, 165, 116, 0.12);
        border-color: var(--brass);
        box-shadow: 0 0 0 2px rgba(212, 165, 116, 0.2);
      }

      .team-archetype.selected::before {
        opacity: 1;
      }

      .team-archetype__icon {
        width: 32px;
        height: 32px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, var(--brass) 0%, var(--copper) 100%);
        border-radius: 12px;
        opacity: 0.7;
        transition: opacity 0.2s ease;
      }

      .team-archetype:hover .team-archetype__icon,
      .team-archetype.selected .team-archetype__icon {
        opacity: 1;
      }

      .team-archetype__name {
        font-family: "Bodoni Moda", serif;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--cream);
        letter-spacing: 0.02em;
        text-align: center;
        position: relative;
        z-index: 1;
      }

      .team-archetype__desc {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.45);
        margin-top: 4px;
        text-align: center;
        position: relative;
        z-index: 1;
      }

      .team-archetype.selected .team-archetype__name {
        color: var(--brass);
      }

      /* Team Modal Actions */
      .team-modal__actions {
        display: flex;
        gap: 12px;
      }

      .team-modal__btn {
        flex: 1;
        padding: 16px 24px;
        border-radius: 12px;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.25s ease;
      }

      .team-modal__btn--cancel {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.6);
      }

      .team-modal__btn--cancel:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.8);
      }

      .team-modal__btn--create {
        background: linear-gradient(135deg, var(--brass) 0%, var(--copper) 100%);
        border: none;
        color: #0d0906;
      }

      .team-modal__btn--create:not(:disabled):hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(212, 165, 116, 0.35);
      }

      .team-modal__btn--create:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .team-modal__btn:active:not(:disabled) {
        transform: scale(0.97);
      }

      /* Team Badge - Shows next to player names */
      .team-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        background: rgba(212, 165, 116, 0.15);
        border: 1px solid rgba(212, 165, 116, 0.25);
        border-radius: 12px;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--brass);
        margin-left: 8px;
        vertical-align: middle;
      }

      .team-badge__icon {
        width: 10px;
        height: 10px;
        background: var(--brass);
        border-radius: 50%;
        opacity: 0.7;
      }

      /* Team Whisper Toggle in Chat Input */
      .whisper-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: rgba(212, 165, 116, 0.1);
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px;
        margin-right: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .whisper-toggle:hover {
        background: rgba(212, 165, 116, 0.15);
        border-color: rgba(212, 165, 116, 0.3);
      }

      .whisper-toggle.is-active {
        background: rgba(212, 165, 116, 0.2);
        border-color: var(--brass);
      }

      .whisper-toggle__icon {
        width: 16px;
        height: 16px;
        color: var(--brass);
        opacity: 0.7;
      }

      .whisper-toggle.is-active .whisper-toggle__icon {
        opacity: 1;
      }

      .whisper-toggle__label {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.6);
      }

      .whisper-toggle.is-active .whisper-toggle__label {
        color: var(--brass);
      }

      /* Team Whisper Message Styling */
      .chat-message--whisper {
        opacity: 0.85;
      }

      .chat-message--whisper .chat-message__content {
        background: rgba(212, 165, 116, 0.08);
        border-left: 2px solid var(--brass);
        padding-left: 12px;
      }

      .chat-message--whisper .chat-message__author::before {
        content: '🔒 ';
        font-size: 0.8em;
      }

      /* Whisper Indicator (for non-team members) */
      .chat-message--whisper-hidden {
        padding: 8px 16px;
        margin: 8px 0;
      }

      .chat-message--whisper-hidden .whisper-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.35);
        font-style: italic;
      }

      .whisper-indicator__icon {
        width: 14px;
        height: 14px;
        color: rgba(212, 165, 116, 0.5);
      }

      /* Team Announcement Message - Public celebration */
      .chat-message--team-announcement {
        text-align: center;
        padding: 16px 20px;
        margin: 16px 0;
        background: linear-gradient(
          135deg,
          rgba(212, 165, 116, 0.1) 0%,
          rgba(183, 106, 59, 0.05) 100%
        );
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px;
      }

      .team-announcement__text {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.8);
      }

      .team-announcement__names {
        color: var(--cream);
        font-weight: 600;
      }

      .team-announcement__team {
        font-family: "Bodoni Moda", serif;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--brass);
        display: block;
        margin-top: 6px;
        letter-spacing: 0.05em;
      }

      /* Player Name with Invite Action */
      .chat-message__author-name {
        position: relative;
        cursor: pointer;
      }

      .chat-message__author-name:hover {
        text-decoration: underline;
        text-decoration-color: rgba(212, 165, 116, 0.4);
        text-underline-offset: 2px;
      }

      /* Player Action Menu (appears on name click) */
      .player-action-menu {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 100;
        min-width: 160px;
        padding: 8px 0;
        background: rgba(28, 19, 15, 0.98);
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 10px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.2s ease;
      }

      .player-action-menu.is-visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(4px);
      }

      .player-action-menu__item {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 10px 16px;
        background: none;
        border: none;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: all 0.15s ease;
        text-align: left;
      }

      .player-action-menu__item:hover {
        background: rgba(212, 165, 116, 0.1);
        color: var(--brass);
      }

      .player-action-menu__item svg {
        width: 16px;
        height: 16px;
        opacity: 0.7;
      }

      .player-action-menu__item:hover svg {
        opacity: 1;
      }

      /* Identity Screen - Centered Cluster Layout */
	      .chat-identity {
	        padding: 40px 24px;
	        padding-top: 80px; /* Push content down from header */
	        /* Reserve room for the fixed CTA so it never covers content. */
	        padding-bottom: max(140px, calc(env(safe-area-inset-bottom) + 120px));
	        display: flex;
	        flex-direction: column;
	        align-items: center;
	        height: 100%;
	        text-align: center;
	        justify-content: center; /* CENTER the whole cluster */
	        gap: 0;
	        overflow-x: hidden;
	        overflow-y: auto;
	        -webkit-overflow-scrolling: touch;
	        width: 100%;
	        box-sizing: border-box;
	        position: absolute; /* Cover entire chat-main */
	        top: 0;
	        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10; /* Above header and seats */
        /* Solid base + Warm vignette atmosphere */
        background:
          radial-gradient(ellipse at 50% 30%, rgba(212, 165, 116, 0.06) 0%, transparent 50%),
          radial-gradient(ellipse at center, transparent 0%, rgba(10, 7, 5, 0.8) 100%),
          rgb(20, 14, 11); /* Solid base to prevent bleed-through */
      }

      /* Subtle grain texture overlay */
      .chat-identity::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.025;
        pointer-events: none;
        mix-blend-mode: overlay;
      }

      /* CDL Watermark - bold but barely there, like La Salida */
      .chat-identity::after {
        content: 'CDL';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: "Bodoni Moda", serif;
        font-size: 14rem;
        font-style: italic;
        font-weight: 700;
        letter-spacing: 0.02em;
        color: rgba(212, 165, 116, 0.012);
        pointer-events: none;
        line-height: 0.9;
      }

      /* Staggered entry animations
         NOTE: Some children (like the post-auth CTA) are revealed later via JS (`display: none` → `block`).
         Those elements must not be "born invisible" waiting on an animation that already elapsed. */
      .chat-identity > :not(#chatJoinBtn) {
        opacity: 0;
        transform: translateY(16px);
        animation: identityFadeUp 0.22s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }

      /* Primary CTA is revealed later; keep it visible and steady. */
      .chat-identity > #chatJoinBtn {
        opacity: 1 !important;
        transform: translateY(0) !important;
        animation: none !important;
        margin-left: auto !important;
        margin-right: auto !important;
        align-self: center !important;
        display: block;
      }

      @keyframes identityFadeUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Staggered, but fast: per design system guardrails */
      .chat-identity__title { animation-delay: 0ms; }
      .chat-identity__subtitle { animation-delay: 60ms; }
      .mesa-live-indicator { animation-delay: 120ms; }
      .avatar-selector-frame { animation-delay: 180ms; }
      .country-display { animation-delay: 180ms; }
      .custom-select { animation-delay: 180ms; }
      .chat-identity__select { animation-delay: 180ms; }
      .chat-identity__input { animation-delay: 180ms; }
      .chat-identity__register-hint { animation-delay: 180ms; }
      .chat-identity__btn { animation-delay: 180ms; }

      .identity-header {
        font-family: "Bodoni Moda", serif;
        font-size: 0.7rem;
        letter-spacing: 0.25em;
        font-variant: small-caps;
        color: var(--brass);
        margin-bottom: 28px;
        opacity: 0.6;
        position: relative;
        z-index: 1;
      }

      .chat-identity__title {
        font-family: "SF Sports Night", "IBM Plex Sans Condensed", system-ui, sans-serif;
        font-size: 1.8rem;
        color: var(--brass);
        margin-bottom: 0;
        font-weight: 400;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        text-shadow:
          0 0 40px rgba(212, 165, 116, 0.2),
          0 4px 24px rgba(0, 0, 0, 0.6);
        position: relative;
        z-index: 1;
      }

      /* Accent line under title - modern touch */
      .chat-identity__title::after {
        content: '';
        display: block;
        width: 40px;
        height: 1px;
        background: var(--brass);
        margin: 16px auto 0;
        opacity: 0.4;
      }

      .chat-identity__subtitle {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        font-weight: 400;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: var(--brass);
        opacity: 0.5;
        margin-top: 16px;
        margin-bottom: 0;
        position: relative;
        z-index: 1;
      }

      /* Live player count indicator - Bone Language */
      .mesa-live-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 20px;
        padding: 10px 20px;
        background: rgba(212, 165, 116, 0.08);
        border: 1px solid rgba(212, 165, 116, 0.15);
        border-radius: 12px;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
      }

      .mesa-live-dot {
        width: 8px;
        height: 8px;
        background: #4ade80;
        border-radius: 50%;
        animation: livePulse 2s ease-in-out infinite;
        box-shadow: 0 0 8px rgba(74, 222, 128, 0.5);
      }

      @keyframes livePulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.2); }
      }

      .mesa-live-text {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.8rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
        letter-spacing: 0.02em;
      }

      .mesa-live-text span {
        color: var(--brass);
        font-weight: 600;
      }

      /* Flag selector - Scrollable, starts with Cuba
         Tobias: "Micro-moments" — it should feel like a tray that settles. */
      .avatar-selector-frame {
        width: 100%;
        max-width: 500px; /* Reasonable constraint */
        margin: 14px auto;
        position: relative;
        z-index: 1;
        isolation: isolate;
        overflow: visible; /* Allow selector to expand */
      }

      /* Subtle edge fades to hint more content exists */
      .avatar-selector-frame::before,
      .avatar-selector-frame::after {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        width: 40px;
        pointer-events: none;
        z-index: 10;
        opacity: 0.85;
      }
      .avatar-selector-frame::before {
        left: 0;
        background: linear-gradient(to right, rgba(20, 14, 11, 1) 0%, transparent 100%);
      }
      .avatar-selector-frame::after {
        right: 0;
        background: linear-gradient(to left, rgba(20, 14, 11, 1) 0%, transparent 100%);
      }

	      /* Golden ring (center cue) */
	      /* Note: pseudo-elements do not reliably render on <img>, so attach to the option. */
	      .avatar-option.is-centered::after {
	        content: '';
	        position: absolute;
	        left: 50%;
	        top: 50%;
	        width: 54px;
	        height: 54px;
	        transform: translate(-50%, -50%);
	        border-radius: 999px;
	        background: transparent;
	        box-shadow:
	          0 0 0 2.5px rgba(212, 165, 116, 0.9),
	          0 0 18px rgba(212, 165, 116, 0.45),
	          inset 0 0 12px rgba(212, 165, 116, 0.14);
	        pointer-events: none;
	        z-index: 0;
	        animation: selectorRingPulse 2.5s ease-in-out infinite;
	      }

	      .avatar-option.selected.is-centered::after {
	        box-shadow:
	          0 0 0 3px rgba(212, 165, 116, 1),
	          0 0 26px rgba(212, 165, 116, 0.6),
	          inset 0 0 14px rgba(212, 165, 116, 0.2);
	      }

      @keyframes selectorRingPulse {
        0%, 100% {
          box-shadow:
            0 0 0 2.5px rgba(212, 165, 116, 0.85),
            0 0 16px rgba(212, 165, 116, 0.4),
            inset 0 0 12px rgba(212, 165, 116, 0.15);
        }
        50% {
          box-shadow:
            0 0 0 3px rgba(212, 165, 116, 1),
            0 0 24px rgba(212, 165, 116, 0.55),
            inset 0 0 12px rgba(212, 165, 116, 0.2);
        }
      }

      .avatar-selector {
        display: flex;
        flex-wrap: nowrap;
        justify-content: flex-start; /* Start from left so Cuba shows first */
        align-items: center;
        gap: 12px;
        /* Give the glow room so it never clips on pulse/slam */
        padding: 30px 0; /* Vertical only - horizontal spacing via pseudo-elements */
        overflow-x: auto;
        overflow-y: visible;
        width: 100%;
        box-sizing: border-box;
        position: relative;
        z-index: 1;
        flex-grow: 0;
        scroll-snap-type: x mandatory;
        scroll-padding-inline: 0; /* Spacers handle centering */
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      .avatar-selector::-webkit-scrollbar { display: none; }

            /* Scrollable spacers so edge flags can reach center */
            /* Use fixed width for desktop (400px panel) */
            .avatar-selector__spacer {
              flex-shrink: 0;
              width: calc(200px - 36px); /* Half of 400px panel minus offset */
              max-width: none;
              height: 1px;
              pointer-events: none;
            }
      /* Country name display - Olympic ceremony style */
      .country-display {
        text-align: center;
        margin: 8px 0 20px 0;
        min-height: 48px;
      }

      .country-display__name {
        font-family: "SF Sports Night", "Bodoni Moda", serif;
        font-size: 1.4rem;
        color: var(--brass);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        margin: 0;
        opacity: 0;
        transform: translateY(8px);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .country-display__name.is-visible {
        opacity: 1;
        transform: translateY(0);
      }

      .country-display__hint {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.4);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-top: 6px;
        opacity: 0;
        transition: opacity 0.3s ease 0.1s;
      }

      .country-display__hint.is-visible {
        opacity: 1;
      }

      .country-display.is-confirmed .country-display__name {
        animation: countryStamp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }

      @keyframes countryStamp {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
      }

      .avatar-hint {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.35);
        text-align: center;
        margin: -8px 0 16px 0;
        letter-spacing: 0.05em;
        animation: identityFadeUp 0.5s ease-out 280ms forwards;
        opacity: 0;
      }

      .avatar-option {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
        border-radius: 0;
        cursor: pointer;
        position: relative;
        background: transparent;
        border: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        user-select: none;
        touch-action: manipulation;
        scroll-snap-align: center;
        /* scroll-snap-stop: normal (default) - allows momentum to carry past multiple flags */
        z-index: 1;
        padding-top: 0;
      }

      @media (hover: hover) and (pointer: fine) {
        /* Hover: smooth lift */
        .avatar-option:hover {
          transform: translateY(-4px) scale(1.08);
          z-index: 10;
        }

        .avatar-option:active {
          transform: scale(0.96);
          transition: transform 0.1s ease;
        }
      }

      @media (hover: none) and (pointer: coarse) {
        /* iOS Safari: avoid transform-fighting between :active + slam animation */
        .avatar-option:active {
          filter: brightness(1.15) saturate(1.08);
        }
      }

      /* PLANT YOUR FLAG - selected state */
	      .avatar-option.selected {
	        transform: translateY(-6px) scale(1.12);
	        z-index: 20;
	      }

      /* Refined slam - smooth lift into place */
      .avatar-option.is-slamming {
        animation: flagSlam 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }

      @keyframes flagSlam {
        0% {
          transform: translateY(0) scale(1.0);
        }
        40% {
          transform: translateY(-10px) scale(1.18);
        }
        70% {
          transform: translateY(-5px) scale(1.14);
        }
        100% {
          transform: translateY(-6px) scale(1.15);
        }
      }

      /* Removed flagGlowPulse - replaced with ringSnap for crisp selection feel */

      /* Non-selected flags - smooth fade */
      .avatar-selector:has(.selected) .avatar-option:not(.selected) {
        opacity: 0.4;
        transform: scale(0.85);
        filter: grayscale(0.35);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .avatar-selector:has(.selected) .avatar-option:not(.selected):hover {
        opacity: 0.95;
        transform: translateY(-3px) scale(1.02);
        filter: grayscale(0);
        transition: all 0.2s ease-out;
      }
      @media (hover: none) and (pointer: coarse) {
        .avatar-selector:has(.selected) .avatar-option:not(.selected):hover {
          opacity: 0.4;
          transform: scale(0.85);
          filter: grayscale(0.35);
        }
      }

      /* While scrolling: the closest flag "breathes" toward center (not a selection) */
	      .avatar-option.is-centered:not(.selected) {
	        opacity: 0.95;
	        transform: translateY(-3px) scale(1.06);
	        filter: grayscale(0) contrast(1.15) saturate(1.3);
	      }
      .avatar-selector:has(.selected) .avatar-option.is-centered:not(.selected) {
        opacity: 0.85;
        transform: translateY(-2px) scale(0.98);
        filter: grayscale(0.08) contrast(1.2) saturate(1.25);
      }
	      /* Centered flag - just scale up, no ring (ring is on center cue) */
	      .avatar-option.is-centered:not(.selected) .avatar-flag-img {
	        transform: scale(1.08);
	        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
	      }

      /* Snap animation when flag enters center - tactile "click" feel */
      .avatar-option.just-centered:not(.selected) {
        animation: centerSnap 0.15s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }

      @keyframes centerSnap {
        0% {
          transform: translateY(0) scale(0.98);
        }
        50% {
          transform: translateY(-5px) scale(1.08);
        }
        100% {
          transform: translateY(-3px) scale(1.05);
        }
      }

      .avatar-option .check-mark { display: none; }

      /* ========================================
         CUSTOM SELECT DROPDOWN
         ======================================== */
      .custom-select {
        position: relative;
        width: 100%;
        max-width: 280px;
        margin: 0 auto 16px;
        z-index: 100;
      }

      .custom-select__trigger {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px 20px;
        background: rgba(20, 14, 10, 0.8);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.25s ease;
      }

      .custom-select__trigger:focus-visible {
        outline: 2px solid rgba(212, 165, 116, 0.35);
        outline-offset: 3px;
      }

      .custom-select__trigger:hover {
        border-color: rgba(212, 165, 116, 0.4);
        background: rgba(28, 19, 15, 0.9);
      }

      .custom-select.is-open .custom-select__trigger {
        border-color: var(--brass);
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        border-bottom-color: transparent;
      }

      .custom-select__value {
        flex: 1;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .custom-select__value--placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      .custom-select__arrow {
        color: var(--brass);
        opacity: 0.6;
        transition: transform 0.25s ease;
        display: flex;
        align-items: center;
      }

      .custom-select.is-open .custom-select__arrow {
        transform: rotate(180deg);
        opacity: 1;
      }

      .custom-select__dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(20, 14, 10, 0.95);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--brass);
        border-top: none;
        border-radius: 0 0 12px 12px;
        overflow: visible;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
      }

      .custom-select.is-open .custom-select__dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .custom-select__search {
        padding: 12px;
        border-bottom: 1px solid rgba(212, 165, 116, 0.15);
      }

      .custom-select__search-input {
        width: 100%;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.2s ease;
      }

      .custom-select__search-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
      }

      .custom-select__search-input:focus {
        border-color: rgba(212, 165, 116, 0.4);
      }

      .custom-select__search-input:focus-visible {
        outline: 2px solid rgba(212, 165, 116, 0.25);
        outline-offset: 2px;
      }

      .custom-select__options {
        list-style: none;
        margin: 0;
        padding: 8px 0;
        max-height: 200px;
        overflow-y: auto;
      }

      .custom-select__options::-webkit-scrollbar {
        width: 6px;
      }

      .custom-select__options::-webkit-scrollbar-track {
        background: transparent;
      }

      .custom-select__options::-webkit-scrollbar-thumb {
        background: rgba(212, 165, 116, 0.3);
        border-radius: 3px;
      }

      .custom-select__option {
        padding: 14px 20px;
        color: rgba(255, 255, 255, 0.6);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.15s ease;
        border-left: 3px solid transparent;
        margin: 4px 8px;
        border-radius: 8px;
        background: transparent;
      }

      .custom-select__option:hover {
        background: rgba(212, 165, 116, 0.4) !important;
        color: #ffffff !important;
        border-left-color: #d4a574 !important;
        padding-left: 28px;
      }

      .custom-select__option.is-focused {
        background: rgba(212, 165, 116, 0.18);
        color: rgba(255, 255, 255, 0.92);
        border-left-color: rgba(212, 165, 116, 0.7);
      }

      .custom-select__option.is-selected {
        background: rgba(212, 165, 116, 0.2);
        color: var(--brass);
        border-left-color: var(--brass);
      }

      .custom-select__option.is-selected::before {
        content: '✓';
        color: var(--brass);
        font-size: 0.8rem;
      }

      .custom-select__option.is-hidden {
        display: none;
      }

      .custom-select__empty {
        padding: 16px 20px;
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.9rem;
        text-align: center;
        font-style: italic;
      }

      /* Hide native select when custom is present */
      .chat-identity__select {
        width: 100%;
        margin-bottom: 16px;
        background: rgba(0, 0, 0, 0.3);
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--cream);
        padding: 12px 0;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 1rem;
        outline: none;
        text-align: center;
        text-align-last: center;
        border-radius: 0;
        -webkit-appearance: none;
        cursor: pointer;
      }
      
      .chat-identity__select:focus {
        border-bottom-color: var(--brass);
      }

      /* Input field - Vintage guestbook feel */
      .chat-identity__input {
        width: 100%;
        max-width: 260px;
        margin: 0 auto 8px;
        background: linear-gradient(
          135deg,
          rgba(212, 165, 116, 0.06) 0%,
          rgba(183, 106, 59, 0.03) 100%
        );
        border: 1px solid rgba(212, 165, 116, 0.15);
        border-bottom: 2px solid var(--brass);
        border-radius: 3px; /* Sharp, vintage - not rounded */
        color: var(--cream);
        padding: 14px 20px;
        font-family: "IBM Plex Serif", "IBM Plex Sans", serif;
        font-size: 16px;
        font-style: italic;
        outline: none;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      }
      .chat-identity__input:focus {
        background: rgba(212, 165, 116, 0.1);
        border-color: rgba(212, 165, 116, 0.3);
        border-bottom-color: var(--gold);
        box-shadow:
          0 0 0 1px rgba(212, 165, 116, 0.2),
          0 8px 24px rgba(0, 0, 0, 0.4);
      }
      .chat-identity__input::placeholder {
        color: rgba(212, 165, 116, 0.45);
        font-style: italic;
      }

      /* La Mesa Auth Gate (login required) */
      .mesa-auth {
        width: 100%;
        max-width: 360px;
        margin: 10px auto 18px;
        position: relative;
        z-index: 1;
      }

		      .mesa-auth__copy {
		        margin: 0 0 10px 0;
		        font-size: 0.8rem;
		        letter-spacing: 0.03em;
		        color: rgba(255, 255, 255, 0.62);
		        font-family: "IBM Plex Sans", sans-serif;
		        text-align: center;
		      }

		      .mesa-auth__subcopy {
		        display: block;
		        margin-top: 6px;
		        color: rgba(255, 255, 255, 0.48);
		        font-size: 0.76rem;
		      }

	      .mesa-auth__reveal {
	        display: inline-flex;
	        align-items: center;
	        justify-content: center;
	        margin: 0 auto 10px;
	        padding: 0;
	        border: 0;
	        background: transparent;
	        font-family: "IBM Plex Sans", sans-serif;
	        font-size: 0.78rem;
	        letter-spacing: 0.02em;
	        color: rgba(212, 165, 116, 0.9);
	        cursor: pointer;
	        text-decoration: underline;
	        text-underline-offset: 3px;
	      }

	      .mesa-auth__reveal:hover {
	        color: rgba(212, 165, 116, 1);
	      }

	      .mesa-auth__row {
	        display: flex;
	        gap: 10px;
	        align-items: stretch;
	        justify-content: center;
	        flex-wrap: wrap;
	      }

	      /* Author CSS overrides UA [hidden] — re-assert hidden for slow-disclose. */
	      .mesa-auth__row[hidden] {
	        display: none !important;
	      }

      .mesa-auth__input {
        flex: 1 1 220px;
        min-width: 200px;
        background: rgba(0, 0, 0, 0.28);
        border: 1px solid rgba(212, 165, 116, 0.18);
        border-radius: 12px;
        color: var(--cream);
        padding: 12px 14px;
        outline: none;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 14px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .mesa-auth__input:focus {
        border-color: rgba(212, 165, 116, 0.45);
        box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.12);
        background: rgba(0, 0, 0, 0.35);
      }

      .mesa-auth__btn {
        flex: 0 0 auto;
        border: none;
        border-radius: 12px;
        padding: 12px 14px;
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: #0d0906;
        background: linear-gradient(135deg, var(--brass) 0%, var(--copper) 100%);
        box-shadow:
          0 10px 24px rgba(0, 0, 0, 0.34),
          inset 0 1px 0 rgba(255, 255, 255, 0.08);
        cursor: pointer;
        transition: transform 0.15s ease, filter 0.15s ease, box-shadow 0.15s ease;
      }

      .mesa-auth__btn:disabled {
        opacity: 0.45;
        filter: grayscale(0.2);
        cursor: not-allowed;
        box-shadow: none;
      }

      .mesa-auth__btn:active {
        transform: translateY(1px) scale(0.98);
      }

      .mesa-auth__status {
        margin: 10px 0 0 0;
        font-size: 0.78rem;
        text-align: center;
        color: rgba(255, 255, 255, 0.58);
        min-height: 1.1em;
      }

      .mesa-auth__email {
        color: var(--brass);
        font-weight: 650;
      }

      .mesa-auth__signout {
        width: 100%;
        margin-top: 10px;
        border-radius: 12px;
        padding: 12px 14px;
        background: rgba(0, 0, 0, 0.26);
        border: 1px solid rgba(212, 165, 116, 0.18);
        color: rgba(255, 255, 255, 0.85);
        cursor: pointer;
        font-family: "IBM Plex Sans", sans-serif;
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      .mesa-auth__signout:hover {
        border-color: rgba(212, 165, 116, 0.35);
        background: rgba(0, 0, 0, 0.32);
      }

      .mesa-identity-locked {
        width: 100%;
        max-width: 360px;
        margin: 14px auto 0;
        padding: 14px 16px;
        border-radius: 12px;
        border: 1px solid rgba(212, 165, 116, 0.18);
        background: rgba(0, 0, 0, 0.22);
        text-align: center;
        position: relative;
        z-index: 1;
      }

      .mesa-identity-locked__label {
        margin: 0 0 6px 0;
        font-size: 11px;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.55);
        font-family: "IBM Plex Sans Condensed", sans-serif;
      }

      .mesa-identity-locked__name {
        margin: 0;
        color: var(--cream);
        font-family: "SF Sports Night", "IBM Plex Sans Condensed", system-ui, sans-serif;
        font-size: 22px;
        font-style: normal;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      /* Helper/hint text */
      .chat-identity__register-hint {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.45);
        margin-top: 12px;
        margin-bottom: 18px;
        font-family: "IBM Plex Sans", sans-serif;
        letter-spacing: 0.03em;
        position: relative;
        z-index: 1;
      }

      /* Button - Bone Language - Tobias: "Make it a declaration, not helper text" */
      /* SF Sports Night for broadcast energy - the ceremonial threshold moment */
      .chat-identity__btn {
        --mesa-ticker-height: 46px;
        margin-top: 24px;
        margin-left: auto !important;
        margin-right: auto !important;
        width: 100%;
        max-width: 320px;

        /* Centered in the identity cluster, not fixed to bottom */
        position: relative;
        left: 0 !important;
        right: auto !important;
        bottom: auto;
        z-index: 1;

        /* Ensure button is centered in flex container */
        align-self: center !important;
        display: block;
        
        /* Additional centering safeguard */
        text-align: center;

        /* Never allow the stagger system to hide this (revealed later via JS). */
        opacity: 1 !important;
        animation: none !important;

        /* Copper gradient - matches form button for consistency */
        background: linear-gradient(180deg, #c4784a 0%, var(--copper) 50%, #9a5a30 100%);
        border: none;
        border-radius: 2px;
        color: #fff;
        padding: 20px 48px;
        /* Bodoni Moda - elegant serif for the threshold moment */
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: 1rem;
        font-weight: 400;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                    filter 0.25s ease,
                    box-shadow 0.25s ease;
        min-height: 56px;
        overflow: hidden;
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.15) inset,
          0 -1px 0 rgba(0, 0, 0, 0.2) inset,
          0 10px 30px rgba(0, 0, 0, 0.4),
          0 0 0 0 rgba(183, 106, 59, 0);
        /* Tobias: The Lift - subtle elevation */
        transform: translateY(0);
      }

      /* Shimmer effect on hover */
      .chat-identity__btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.2) 0%,
          transparent 50%,
          rgba(255, 255, 255, 0.1) 100%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
        pointer-events: none;
      }

      .chat-identity__btn:not(:disabled):hover::before {
        opacity: 1;
      }

      /* Tobias: The Lift - elements rise on hover, suggesting they can be picked up */
      .chat-identity__btn:not(:disabled):hover {
        transform: translateY(-3px);
        background: linear-gradient(180deg, #d08555 0%, #c4784a 50%, #a86238 100%);
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.2) inset,
          0 -1px 0 rgba(0, 0, 0, 0.15) inset,
          0 15px 40px rgba(183, 106, 59, 0.35),
          0 0 60px rgba(183, 106, 59, 0.2);
      }

      /* Tobias: The Slam - on click, quick scale-down + subtle shadow spread */
      .chat-identity__btn:not(:disabled):active {
        transform: translateY(2px) scale(0.96);
        transition: transform 0.08s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        box-shadow:
          0 2px 8px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      .chat-identity__btn:disabled {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.25);
        cursor: not-allowed;
        box-shadow: none;
      }

      .chat-identity__btn:disabled::before {
        display: none;
      }

      /* Tobias: "The declaration moment" - glow pulse when ready */
      .chat-identity__btn.is-ready {
        animation: enterButtonReady 2s ease-in-out infinite;
      }

      @media (max-width: 768px) {
        .chat-identity__btn {
          --mesa-ticker-height: 40px;
          max-width: 280px;
          padding: 18px 40px;
          font-size: 0.9rem;
          min-height: 52px;
        }
      }

      @keyframes enterButtonReady {
        0%, 100% {
          box-shadow:
            0 4px 16px rgba(0, 0, 0, 0.3),
            0 2px 4px rgba(0, 0, 0, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.2),
            inset 0 -1px 0 rgba(0, 0, 0, 0.1),
            0 0 0 rgba(212, 165, 116, 0);
        }
        50% {
          box-shadow:
            0 4px 16px rgba(0, 0, 0, 0.3),
            0 2px 4px rgba(0, 0, 0, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.2),
            inset 0 -1px 0 rgba(0, 0, 0, 0.1),
            0 0 24px rgba(212, 165, 116, 0.4);
        }
      }

      .chat-identity__register-link {
        color: var(--brass);
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.2s;
      }

      .chat-identity__register-link:hover {
        border-bottom-color: var(--brass);
      }

      /* Mobile */
      @media (max-width: 768px) {
        .chat-widget {
          bottom: 16px;
          right: 16px;
          left: 16px; /* Centered button area */
          display: flex;
          justify-content: flex-end; /* Or center if preferred, keeping right for thumb */
        }

        /* Make domino tile bigger on mobile / easier to tap */
        .chat-toggle {
          width: 72px;
          height: 115px;
        }

        .chat-panel {
          position: fixed;
          top: 0;
          bottom: 40px; /* Leave room for ticker (40px on mobile) */
          left: 0;
          right: 0;
          width: 100%;
          height: calc(100dvh - 40px); /* Full height minus ticker */
          max-height: calc(100dvh - 40px);
          border-radius: 0;
          border: none;
          box-shadow: none;
          overflow: hidden;
          background: rgba(30, 20, 15, 1);
        }

        .chat-panel.is-open {
          animation: sheetOpen 0.4s cubic-bezier(0.32, 0.72, 0, 1);
        }

        .chat-panel.is-peek {
          top: auto;
          height: min(46dvh, 520px);
          max-height: min(46dvh, 520px);
          border-radius: 20px 20px 0 0;
          border: 1px solid rgba(212, 165, 116, 0.22);
          box-shadow: 0 -12px 48px rgba(0,0,0,0.7);
        }

        @keyframes sheetOpen {
          from { transform: translateY(100%); }
          to { transform: translateY(0); }
        }

        /* Show drag handle on mobile */
        .chat-header__drag-handle {
          display: block;
        }

        .chat-header {
          /* Safe area for notch/Dynamic Island - generous padding */
          padding: max(28px, calc(env(safe-area-inset-top) + 20px)) 20px 14px;
          min-height: 70px;
          background: rgba(20, 14, 11, 0.98);
          border-bottom: 1px solid rgba(212, 165, 116, 0.15);
        }

        .chat-header__title {
          font-size: 0.85rem;
        }

        /* Close button needs safe area too */
        .chat-header__close {
          top: max(24px, calc(env(safe-area-inset-top) + 16px));
          right: 14px;
          width: 44px;
          height: 44px;
          padding: 0;
          justify-content: center;
          gap: 0;
        }

        .chat-header__close-label {
          display: none;
        }

        .chat-header__dock {
          top: max(24px, calc(env(safe-area-inset-top) + 16px));
          right: 64px;
          width: 44px;
          height: 44px;
          padding: 0;
        }

        .chat-header__dock-label {
          display: none;
        }

        .chat-panel.is-peek .chat-header {
          padding: 18px 20px 12px;
        }

        .chat-panel.is-peek .chat-header__close {
          top: 12px;
        }

        .chat-panel.is-peek .chat-header__dock {
          top: 12px;
        }

        /* Adjust input area for safe areas (iPhone Home Bar) */
        .chat-input-area {
          padding: 12px 20px max(12px, calc(env(safe-area-inset-bottom) + 8px));
          background: rgba(20, 14, 11, 0.98); /* Opaque background behind input */
        }

        .chat-send {
          width: 48px;
          height: 48px; /* Larger tap target */
        }

        .pin-btn {
          min-width: 44px;
          min-height: 44px;
        }

        /* Avatar options need good tap targets */
        .avatar-option {
          width: 44px;
          height: 44px;
        }

        /* Identity screen mobile - centered cluster */
        .chat-identity {
          justify-content: center; /* Keep centered on mobile too */
          padding: max(28px, calc(env(safe-area-inset-top) + 16px)) 20px max(32px, calc(env(safe-area-inset-bottom) + 20px));
          overflow-y: auto;
          overflow-x: visible; /* Allow flag selector to scroll */
        }

        /* CDL watermark - adjusted for mobile */
        .chat-identity::after {
          font-size: 10rem;
        }

        .identity-header {
          margin-bottom: 20px;
        }

        .chat-identity__title {
          font-size: 1.5rem;
          margin-bottom: 6px;
          transform: none; /* Remove asymmetry on mobile */
        }

        .chat-identity__subtitle {
          margin-bottom: 0; /* Let space-between handle it */
          transform: none;
        }

        .avatar-selector-frame {
          margin: 12px 0 16px 0;
        }

	        .avatar-selector {
	          gap: 10px;
	          /* Mobile needs extra headroom for glow + slam */
	          padding: 26px 0; /* Vertical only - spacers handle horizontal */
	          flex-grow: 0;
	          scroll-padding-inline: 0;
	        }
	        .avatar-selector__spacer {
	          width: calc(50vw - 32px); /* Half viewport minus (half option width + gap) */
	          max-width: calc(250px - 32px);
	        }

        .chat-identity__input {
          max-width: 240px;
          margin-bottom: 4px;
        }

        .chat-identity__register-hint {
          margin-bottom: 0;
          font-size: 0.7rem;
        }

        .chat-identity__btn {
          width: 100%;
          max-width: 260px;
          padding: 16px 24px;
          font-size: 0.9rem;
          min-height: 48px;
          margin-top: 20px;
          margin-left: auto !important;
          margin-right: auto !important;
          align-self: center !important;
          display: block;
          border-radius: 2px;
        }
      }

      /* ========================================
         FORM PANEL - "The Roster"
         Scene 5: SIGN YOUR NAME
         The table awaits. Make it feel like
         pulling up a chair to sign the ledger.
         Tobias: "Float in the room, not pressed to ceiling"
         ======================================== */
      .panel--form {
        min-height: 100vh;
        min-height: 100dvh;
        padding: 5vh 24px 60px; /* Less bottom padding - no footer to clear */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* Start from top so button isn't cut off */
        box-sizing: border-box;
        position: relative;
        isolation: isolate;
        /* Base `.panel` uses `overflow: hidden`; allow the form scene to scroll when content exceeds the viewport. */
        overflow-x: hidden;
        overflow-y: auto;
        /* Atmospheric depth - Tobias: "Rooms, Not Hallways"
         * Self-contained scene - clean ending, no dissolving.
         */
        background:
          /* Top vignette - ceiling darkness */
          linear-gradient(to bottom, rgba(10, 7, 5, 0.95) 0%, transparent 20%),
          /* Bottom vignette - clean ending */
          linear-gradient(to top, rgba(10, 7, 5, 0.9) 0%, transparent 15%),
          /* Central warm glow - where the action is */
          radial-gradient(ellipse at 50% 45%, rgba(183, 106, 59, 0.12) 0%, transparent 45%),
          /* Ambient room depth */
          radial-gradient(ellipse at 50% 50%, rgba(28, 19, 15, 0.5) 0%, transparent 80%),
          /* Solid base - no transparency */
          linear-gradient(180deg, #0a0705 0%, #1a120d 35%, #120c08 70%, #0d0906 100%);
      }

      /* Bridge into the footer panel — a soft dissolve, not a hard cut */
      .panel--form::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: clamp(120px, 22dvh, 240px);
        background:
          radial-gradient(ellipse at 50% 0%, rgba(183, 106, 59, 0.08) 0%, transparent 55%),
          linear-gradient(to bottom, rgba(10, 7, 5, 0) 0%, rgba(10, 7, 5, 0.92) 55%, rgba(10, 7, 5, 1) 100%);
        pointer-events: none;
        z-index: 0;
      }

      /* Form panel content - cinematic entrance as its own scene */
      .panel--form .panel-content {
        opacity: 0;
        transform: translateY(8px);
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
        max-width: 480px;
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      }

      /* Form content fades in when panel is in view - "camera cut" moment */
      .panel--form.in-view .panel-content {
        opacity: 1;
        transform: translateY(0);
      }

      /* Form slogan - confident invitation, Cuban elegance meets UFC edge */
      .panel--form .panel-headline {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: clamp(2rem, 7vw, 3rem);
        margin-bottom: 24px;
        color: var(--cream);
        letter-spacing: 0.02em;
        text-shadow:
          0 2px 15px rgba(0, 0, 0, 0.9),
          0 0 50px rgba(212, 165, 116, 0.2);
      }

      .panel--form .panel-subtitle {
        margin-bottom: 24px;
      }

      /* ========================================
         EXIT PANEL - The Cigar Lounge Reveal
         A separate swipe - its own scene. The room reveals itself.
         Tobias: "a second swipe" - each panel is complete.
         ======================================== */
      .panel--exit {
        min-height: 100vh;
        min-height: 100dvh;
        padding: 48px 24px;
        padding-bottom: 100px; /* Ticker clearance */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        background: #0a0705; /* Dark base so the lounge reveal feels intentional */
        isolation: isolate;
      }

      /* Background image layer */
      .panel-bg--exit {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center 40%;
        z-index: 0;
        opacity: 0;
        filter: blur(2px) brightness(0.55) saturate(0.9);
        transform: scale(1.08);
        transition: opacity 0.8s ease-out, filter 0.9s ease-out, transform 1.2s cubic-bezier(0.16, 1, 0.3, 1);
      }

      /* Footer reveal — the lounge fades in as you arrive (prevents harsh snap cut) */
      .panel--exit.in-view .panel-bg--exit {
        opacity: 1;
        filter: blur(0) brightness(0.65) saturate(1);
        transform: scale(1.05);
      }

      /* Top dissolve — matches the form panel’s bottom vignette */
      .panel--exit::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(10, 7, 5, 1) 0%,
          rgba(10, 7, 5, 0.92) 18%,
          rgba(10, 7, 5, 0.55) 42%,
          rgba(10, 7, 5, 0) 70%
        );
        pointer-events: none;
        z-index: 1;
      }

      /* Overlay - deeper darkness for legibility, still cinematic */
      .panel-overlay--exit {
        position: absolute;
        inset: 0;
        z-index: 1;
        background:
          /* Vignette for depth */
          radial-gradient(ellipse 80% 70% at 50% 50%,
            rgba(10, 7, 5, 0.55) 0%,
            rgba(10, 7, 5, 0.78) 55%,
            rgba(10, 7, 5, 0.94) 100%
          ),
          /* Subtle overall dim */
          linear-gradient(180deg,
            rgba(10, 7, 5, 0.72) 0%,
            rgba(10, 7, 5, 0.62) 50%,
            rgba(10, 7, 5, 0.82) 100%
          );
      }

      /* Content layer above overlay */
      .exit-content {
        position: relative;
        z-index: 2;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 32px;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.65s ease-out, transform 0.85s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .panel--exit.in-view .exit-content {
        opacity: 1;
        transform: translateY(0);
      }

      /* Subtle warmth at center - ember memory */
      .panel--exit::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          ellipse 50% 40% at 50% 55%,
          rgba(183, 106, 59, 0.06) 0%,
          transparent 70%
        );
        pointer-events: none;
        z-index: 2;
      }

      /* Mobile adjustments */
      @media (max-width: 768px) {
        /* Exit panel: Cinematic sign-off - its own beat (Tobias: "a second swipe") */
        .panel--exit {
          min-height: 100dvh;           /* Full viewport for immersive feel */
          height: auto;
          padding: 48px 20px;
          padding-bottom: 100px;
          justify-content: center;
          scroll-snap-align: start;     /* Snap to this panel */
          scroll-snap-stop: always;     /* Firm stop for cinematic beat */
        }

        .exit-content {
          gap: 24px;
        }
      }

      /* Footer section — cinematic closing credits */
      .event-footer-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
      }

      /* ========================================
         RULES PANEL - "La Ley"
         Scene 4: THE LAW
         One unified plaque. Authoritative. Complete.
         ======================================== */
      .panel--rules {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        /* Background image now handles atmosphere */
      }

      /* Single unified container - THE PLAQUE - floating in the room */
      .rules-plaque {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        max-width: 540px;
        width: 100%;
        padding: 32px 5vw;
        isolation: isolate;
        /* Floating plaque effect */
        background:
          radial-gradient(ellipse at 50% 18%, rgba(212, 165, 116, 0.055) 0%, transparent 55%),
          linear-gradient(145deg, rgba(18, 12, 8, 0.92) 0%, rgba(10, 7, 5, 0.95) 100%);
        border: 1px solid rgba(212, 165, 116, 0.18);
        border-radius: 10px; /* Less "UI card", more machined plaque */
        /* Depth - floating in the room */
        box-shadow:
          0 0 60px rgba(0, 0, 0, 0.8),
          0 20px 60px rgba(0, 0, 0, 0.6),
          0 0 100px rgba(212, 165, 116, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        /* Subtle backdrop blur for depth */
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      .rules-plaque > * {
        position: relative;
        z-index: 2;
      }

      /* Engraved inner border - "carved/inlaid", not a big UI frame */
      .rules-plaque::before {
        content: "";
        position: absolute;
        inset: 14px;
        border-radius: 8px;
        border: 1px solid rgba(212, 165, 116, 0.12);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.04),
          inset 0 -1px 0 rgba(0, 0, 0, 0.45);
        pointer-events: none;
        opacity: 0.85;
        z-index: 1;
      }

      /* Subtle brushed grain - felt, not seen */
      .rules-plaque::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background: linear-gradient(
          115deg,
          rgba(255, 255, 255, 0.02) 0%,
          rgba(255, 255, 255, 0) 22%,
          rgba(255, 255, 255, 0.02) 45%,
          rgba(0, 0, 0, 0) 70%,
          rgba(255, 255, 255, 0.015) 100%
        );
        pointer-events: none;
        opacity: 0.22;
        mix-blend-mode: soft-light;
        z-index: 0;
      }

	      /* Header section - tightly coupled */
	      .rules-header {
	        margin-bottom: 24px;
	      }

	      /* Rules badge uses the same domino tile language as hero/slam */
	      .panel--rules .hero-badge {
	        width: 48px;
	        height: 68px;
	        margin: 0 auto 14px auto;
	        opacity: 0;
	      }

	      .rules-header__title {
	        display: flex;
	        flex-direction: column;
	        align-items: center;
	        gap: 0;
	        margin: 0 0 8px 0;
	        opacity: 0;
	      }

	      /* Stacked LA LEY - commanding presence like TAKE YOUR SEAT */
	      .rules-title__line {
	        font-family: "Bodoni Moda", serif;
	        font-weight: 900;
	        text-transform: uppercase;
	        letter-spacing: 0.04em;
	        line-height: 0.82;
	        color: rgba(255, 255, 255, 0.7);
	        text-shadow:
	          0 2px 20px rgba(0, 0, 0, 0.5);
	      }

	      /* "LA" - the setup */
	      .rules-title__line:first-child {
	        font-size: clamp(2rem, 8vw, 4rem);
	      }

	      /* "LEY" - THE LAW. Carved in stone. */
	      .rules-title__line--ley {
	        font-size: clamp(4rem, 18vw, 10rem);
	        color: #fff;
	        text-shadow:
	          0 0 40px rgba(212, 165, 116, 0.5),
	          0 0 80px rgba(212, 165, 116, 0.3),
	          0 0 120px rgba(212, 165, 116, 0.15),
	          0 4px 20px rgba(0, 0, 0, 0.9);
	        filter: brightness(1.04);
	      }

      .rules-header__subtitle {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.65rem;
        font-weight: 600;  /* Sports energy - upgraded from 400 */
        letter-spacing: 0.08em;  /* Consistent with rule cards */
        text-transform: uppercase;
        color: var(--brass);
        opacity: 0;
        margin: 0;
      }

      /* Grid - The Law carved in brass */
      .rules-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        width: 100%;
        margin-bottom: 20px;
      }

      /* Rule Cards - Subtle, receding into the room */
      .rule-card {
        background:
          linear-gradient(145deg, rgba(28, 20, 14, 0.8) 0%, rgba(14, 10, 7, 0.9) 100%);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: var(--radius);
        padding: 14px 12px;
        text-align: center;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        opacity: 0;
        transform: translateY(12px);
        position: relative;
        /* Subtle depth */
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.3),
          inset 0 -1px 0 rgba(255, 255, 255, 0.02),
          0 1px 0 rgba(255, 255, 255, 0.02);
      }

      /* Remove inner border accent */
      .rule-card::before {
        display: none;
      }

      /* Primary rules - subtle left accent, slightly more presence */
      .rule-card--primary {
        border: 1px solid rgba(212, 165, 116, 0.16);
        border-bottom-color: rgba(212, 165, 116, 0.28);
        background:
          linear-gradient(145deg, rgba(35, 25, 18, 0.85) 0%, rgba(18, 12, 8, 0.95) 100%);
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.03) inset,
          0 -1px 0 rgba(0, 0, 0, 0.3) inset,
          0 8px 24px rgba(0, 0, 0, 0.4);
        padding: 16px 12px;
      }

      .rule-card--primary .rule-card__title {
        color: rgba(212, 165, 116, 0.9);  /* Slightly brighter brass for primary rules */
      }

      .rule-card__title {
        font-family: "IBM Plex Sans", sans-serif;  /* Sports typography - matches ticker */
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(255, 255, 255, 0.85);
        line-height: 1.2;
        margin: 0 0 3px 0;
      }

      .rule-card__desc {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.48);
        letter-spacing: 0.02em;
        line-height: 1.3;
        margin: 0;
      }

      /* Hover - subtle lift, no brass */
      .rule-card:hover {
        border-color: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.04) inset,
          0 12px 32px rgba(0, 0, 0, 0.5);
      }

      .rule-card--primary:hover {
        border-color: rgba(212, 165, 116, 0.26);
        border-bottom-color: rgba(212, 165, 116, 0.35);
      }

      /* Footer section - tightly coupled */
      .rules-footer-section {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* Divider - brass domino artifact */
      .rules-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 14px;
        margin-bottom: 12px;
        opacity: 0;
      }

      .rules-divider::before,
      .rules-divider::after {
        content: '';
        height: 1px;
        width: 35px;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.4), transparent);
      }

      .rules-divider__domino {
        font-size: 1.4rem;
        opacity: 0.6;
        filter: grayscale(0.2) sepia(0.3);
      }

      /* "Respect the table." - The warning */
      .rules-footer {
        text-align: center;
        font-family: "Bodoni Moda", serif;
        font-size: clamp(1.1rem, 3.5vw, 1.4rem);
        font-style: italic;
        color: #fff;
        letter-spacing: 0.04em;
        margin: 0;
        opacity: 0;
        text-shadow:
          0 0 20px rgba(212, 165, 116, 0.35),
          0 0 40px rgba(212, 165, 116, 0.15),
          0 2px 15px rgba(0, 0, 0, 0.8);
      }

      /* Scroll hint - STATIC, no bounce */
      .rules-scroll-hint {
        margin-top: 24px;
        opacity: 0;
        display: flex;
        justify-content: center;
      }

      .rules-scroll-hint__chevron {
        width: 14px;
        height: 14px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.4;
      }

	      /* ========================================
	         RULES ANIMATIONS - The Law is revealed
	         ======================================== */

	      .panel--rules.in-view:not(.has-played) .hero-badge {
	        animation: fadeInOnly 0.6s ease-out 0.2s forwards;
	      }

      .panel--rules.in-view:not(.has-played) .rules-header__title {
        animation: rulesLawSlam 0.7s cubic-bezier(0.16, 1, 0.3, 1) 0.35s forwards;
      }

      .panel--rules.in-view:not(.has-played) .rules-header__subtitle {
        animation: rulesFadeIn 0.5s ease-out 0.7s forwards;
      }

      .panel--rules.in-view:not(.has-played) .rule-card {
        animation: ruleCardDeal 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      /* Staggered entry - dealt one by one */
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(1) { animation-delay: 0.85s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(2) { animation-delay: 0.95s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(3) { animation-delay: 1.05s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(4) { animation-delay: 1.15s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(5) { animation-delay: 1.25s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(6) { animation-delay: 1.35s; }

      .panel--rules.in-view:not(.has-played) .rules-divider {
        animation: rulesFadeIn 0.5s ease-out 1.6s forwards;
      }

      .panel--rules.in-view:not(.has-played) .rules-footer {
        animation: rulesWarning 0.6s cubic-bezier(0.16, 1, 0.3, 1) 1.8s forwards;
      }

      /* Scroll hint - fade in only, NO BOUNCE */
      .panel--rules.in-view:not(.has-played) .rules-scroll-hint {
        animation: scrollHintReveal 0.8s ease-out 2.5s forwards;  /* Standardized: 2.5s for consistent rhythm */
      }

	      .panel--rules.has-played .hero-badge,
	      .panel--rules.has-played .rules-header__title,
	      .panel--rules.has-played .rules-header__subtitle,
	      .panel--rules.has-played .rule-card,
	      .panel--rules.has-played .rules-divider,
      .panel--rules.has-played .rules-footer {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--rules.has-played .rules-scroll-hint {
        opacity: 1;
      }

      @keyframes rulesFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes rulesLawSlam {
        0% {
          opacity: 0;
          transform: translateY(-20px) scale(1.05);
          filter: blur(3px);
        }
        70% {
          opacity: 1;
          transform: translateY(2px) scale(0.99);
          filter: blur(0);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes ruleCardDeal {
        0% {
          opacity: 0;
          transform: translateY(15px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes rulesWarning {
        0% {
          opacity: 0;
          transform: translateY(8px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Mobile adjustments */
      @media (max-width: 768px) {
        .rules-header {
          margin-bottom: 20px;
        }

        .rules-title__line:first-child {
          font-size: clamp(1.6rem, 8vw, 2.5rem);
        }

        .rules-title__line--ley {
          font-size: clamp(3rem, 16vw, 6rem);
        }

        .rules-header__subtitle {
          font-size: 0.58rem;
          letter-spacing: 0.2em;
        }

        .rules-grid {
          gap: 8px;
          margin-bottom: 16px;
        }

        .rule-card {
          padding: 11px 10px;
        }

        .rule-card__title {
          font-size: 0.7rem;  /* Slightly smaller on mobile for uppercase */
        }

        .rule-card__desc {
          font-size: 0.6rem;
        }

        .rules-divider {
          margin-bottom: 10px;
        }

        .rules-divider__domino {
          font-size: 1.2rem;
        }

        .rules-footer {
          font-size: clamp(0.95rem, 3vw, 1.2rem);
        }

        .rules-scroll-hint {
          margin-top: 20px;
        }
      }

      /* Form Shell - Tobias: The Ledger Style, subtle borders */
      .form-shell {
        background:
          /* Inner vignette - the cigar smoke settling */
          radial-gradient(ellipse at 50% 0%, rgba(212, 165, 116, 0.03) 0%, transparent 50%),
          /* Depth gradient */
          linear-gradient(180deg, rgba(35, 25, 18, 0.7) 0%, rgba(20, 14, 10, 0.9) 100%),
          /* Noise texture */
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
        /* Bone Language - Brass border */
        border: 1px solid rgba(212, 165, 116, 0.25);
        border-radius: 12px;
        padding: 32px 32px;
        max-width: 480px;
        width: 100%;
        margin: 0 auto;
        /* Subtle glow */
        box-shadow:
          0 0 40px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.03);
        position: relative;
        /* Layered shadows for depth - Tobias: "Weight" */
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.04) inset,
          0 20px 50px rgba(0, 0, 0, 0.5),
          0 0 100px rgba(0, 0, 0, 0.3),
          /* Ambient glow cast onto background */
          0 0 80px rgba(183, 106, 59, 0.08),
          0 0 120px rgba(212, 165, 116, 0.05);
      }

      /* Corner accents - old ledger detail */
      .form-shell::before {
        content: "";
        position: absolute;
        top: 12px;
        left: 12px;
        right: 12px;
        bottom: 12px;
        border: 1px solid rgba(212, 165, 116, 0.06);
        border-radius: 2px;
        pointer-events: none;
      }

      .form-intro {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .form-intro p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.95rem;
        margin-bottom: 12px;
      }

      .form-intro ul {
        list-style: none;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 16px;
        margin-top: 14px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .form-intro li {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .form-intro li::before {
        content: "◆";
        color: var(--copper);
        font-size: 0.6rem;
      }

      form {
        display: grid;
        gap: 20px;
        padding-top: 8px;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-family: "IBM Plex Sans", sans-serif;
        font-weight: 500;
        font-style: normal;
        color: var(--brass);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        text-align: left;
      }

      .input-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
      }

      /* Tobias: The Drawn Line (Physical Digital) */
      .input-wrapper::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 1px;
        background: rgba(212, 165, 116, 0.2);
        transform: skewX(-2deg);
        transform-origin: left;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
      }

      .input-wrapper:focus-within::after {
        height: 2px;
        background: var(--brass);
        transform: skewX(0);
        box-shadow: 0 2px 10px rgba(212, 165, 116, 0.3);
      }

      input,
      textarea {
        padding: 12px 0;
        border-radius: 0;
        border: none;
        background: transparent;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 1.05rem;
        border: none;
        border-bottom: 1px solid rgba(212, 165, 116, 0.15);
        background: transparent !important;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 1.1rem;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
      }

      /* Tobias: Hand-drawn signature border effect */
      .form-group::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 1.5px;
        background: var(--brass);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        opacity: 0.8;
      }

      .form-group:focus-within::after {
        transform: scaleX(1);
      }

      .form-group:focus-within label {
        color: var(--brass);
      }

      input:focus,
      textarea:focus {
        outline: none;
        padding-left: 8px;
        text-shadow: 0 0 20px rgba(212, 165, 116, 0.15);
        /* Tobias: "Physical Digital" - inputs lift when active */
        transform: translateY(-1px);
        background: rgba(212, 165, 116, 0.02) !important;
        box-shadow:
          0 0 0 1px rgba(212, 165, 116, 0.08),
          0 4px 12px rgba(0, 0, 0, 0.2);
      }

      /* Validation error states */
      input.is-invalid,
      textarea.is-invalid {
        border-color: rgba(212, 0, 0, 0.6);
        box-shadow: 0 0 0 1px rgba(212, 0, 0, 0.3);
      }

      input.is-invalid:focus,
      textarea.is-invalid:focus {
        border-color: rgba(212, 0, 0, 0.7);
        box-shadow:
          0 0 0 1px rgba(212, 0, 0, 0.4),
          0 4px 12px rgba(212, 0, 0, 0.15);
        animation: inputShake 400ms ease-out;
      }

      .terms-checkbox.is-invalid .terms-checkbox__box {
        border-color: rgba(212, 0, 0, 0.6);
        box-shadow: 0 0 0 1px rgba(212, 0, 0, 0.3);
      }

      @keyframes inputShake {
        0%, 100% { transform: translateX(0) translateY(-1px); }
        15% { transform: translateX(-4px) translateY(-1px); }
        30% { transform: translateX(4px) translateY(-1px); }
        45% { transform: translateX(-3px) translateY(-1px); }
        60% { transform: translateX(3px) translateY(-1px); }
        75% { transform: translateX(-2px) translateY(-1px); }
        90% { transform: translateX(2px) translateY(-1px); }
      }

      @media (prefers-reduced-motion: reduce) {
        input.is-invalid:focus,
        textarea.is-invalid:focus {
          animation: none;
        }
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(212, 165, 116, 0.2);
        font-style: italic;
      }

      button[type="submit"] {
        border: none;
        border-radius: 2px;
        padding: 22px 42px;
        font-weight: 700;
        font-size: 1rem;
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        background: linear-gradient(180deg, #c4784a 0%, var(--copper) 50%, #9a5a30 100%);
        color: #fff;
        cursor: pointer;
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.15) inset,
          0 -1px 0 rgba(0, 0, 0, 0.2) inset,
          0 10px 30px rgba(0, 0, 0, 0.4),
          0 0 0 0 rgba(183, 106, 59, 0);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        margin-top: 16px;
        position: relative;
        overflow: hidden;
        animation: buttonBreath 4s ease-in-out infinite;
      }

      @keyframes buttonBreath {
        0%, 100% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.15) inset,
            0 -1px 0 rgba(0, 0, 0, 0.2) inset,
            0 10px 30px rgba(0, 0, 0, 0.4),
            0 0 0 0 rgba(183, 106, 59, 0);
        }
        50% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.15) inset,
            0 -1px 0 rgba(0, 0, 0, 0.2) inset,
            0 10px 30px rgba(0, 0, 0, 0.4),
            0 0 40px 2px rgba(183, 106, 59, 0.15);
        }
      }

      button[type="submit"]:hover {
        transform: translateY(-3px);
        background: linear-gradient(180deg, #d08555 0%, #c4784a 50%, #a86238 100%);
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.2) inset,
          0 -1px 0 rgba(0, 0, 0, 0.15) inset,
          0 15px 40px rgba(183, 106, 59, 0.35),
          0 0 60px rgba(183, 106, 59, 0.2);
        animation: none;
      }

      /* Tobias: The SLAM - Tactical Flash + Weight */
      button[type="submit"]:active {
        transform: scale(0.92);
        filter: brightness(1.6) contrast(1.1);
        box-shadow: 
          0 4px 10px rgba(0, 0, 0, 0.7),
          inset 0 0 20px rgba(255, 255, 255, 0.2);
        transition: all 0.05s ease;
      }

      button[type="submit"]::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.6s ease;
      }

      button[type="submit"]:hover::before {
        left: 100%;
      }

      button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: progress;
        transform: none;
      }

      /* Guidance pulse when the domino sends you to the form */
      button[type="submit"].is-unlock-hinted {
        animation: unlockPulse 1.15s ease-out 1;
      }
      @keyframes unlockPulse {
        0% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.15) inset,
            0 -1px 0 rgba(0, 0, 0, 0.2) inset,
            0 10px 30px rgba(0, 0, 0, 0.4),
            0 0 0 0 rgba(212, 165, 116, 0);
        }
        45% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.2) inset,
            0 -1px 0 rgba(0, 0, 0, 0.15) inset,
            0 18px 55px rgba(183, 106, 59, 0.35),
            0 0 0 3px rgba(212, 165, 116, 0.18),
            0 0 70px rgba(183, 106, 59, 0.25);
        }
        100% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.15) inset,
            0 -1px 0 rgba(0, 0, 0, 0.2) inset,
            0 10px 30px rgba(0, 0, 0, 0.4),
            0 0 0 0 rgba(212, 165, 116, 0);
        }
      }

      .payment-note {
        text-align: center;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        color: var(--brass);
        opacity: 0.7;
        margin-top: 12px;
        letter-spacing: 0.05em;
      }

      .status {
        min-height: 24px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        font-size: 0.95rem;
      }

      /* ========================================
         FORM PANEL ENHANCEMENTS - Tobias Approved
         "The Final Hand" - Story climax
         ======================================== */

	      /* Form Header — "The Entrance" */
	      .form-header {
	        text-align: center;
	        margin-bottom: 32px;
	        position: relative;
	      }

	      /* Two-line headline: arrival announcement */
	      .panel-headline--form {
	        font-family: "Bodoni Moda", serif;
	        font-style: italic;
	        font-weight: 400;
	        text-transform: none;
	        letter-spacing: 0.03em;
	        line-height: 1.05;
	        color: rgba(255, 255, 255, 0.95);
	        text-shadow:
	          0 0 40px rgba(212, 165, 116, 0.3),
	          0 4px 20px rgba(0, 0, 0, 0.5);
	      }

	      /* Brass underline — like an inscription plaque */
	      .panel-headline--form::after {
	        content: '';
	        display: block;
	        width: 60px;
	        height: 2px;
	        background: linear-gradient(90deg,
	          transparent 0%,
	          var(--brass) 20%,
	          var(--brass) 80%,
	          transparent 100%
	        );
	        margin: 16px auto 0;
	        opacity: 0.7;
	      }

	      .form-headline__line {
	        display: block;
	      }

      /* Edition badge - matches CDL 1 badges on other panels */
      .form-header__edition {
        display: inline-block;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.6rem;
        font-weight: 600;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: var(--tobacco, #1c130f);
        background: var(--brass);
        padding: 5px 14px;
        border-radius: 2px;
        margin: 0 0 14px 0;
        box-shadow:
          0 2px 8px rgba(0, 0, 0, 0.3),
          0 0 20px rgba(212, 165, 116, 0.15);
      }

      /* Inline Scarcity - Broadcast plaque (CDL-native) */
      .form-scarcity {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .form-scarcity__display {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 64px;
        height: 44px;
        padding: 0 14px;
        border-radius: 10px;
        background: linear-gradient(180deg, rgba(28, 19, 15, 0.95) 0%, rgba(14, 9, 6, 0.98) 100%);
        border: 1px solid rgba(212, 165, 116, 0.38);
        box-shadow:
          inset 0 1px 0 rgba(212, 165, 116, 0.08),
          inset 0 -1px 0 rgba(0, 0, 0, 0.35),
          0 14px 40px rgba(0, 0, 0, 0.45),
          0 0 40px rgba(212, 165, 116, 0.06);
        overflow: hidden;
      }

      .form-scarcity__display::before {
        content: "";
        position: absolute;
        inset: 2px;
        border-radius: 8px;
        border: 1px solid rgba(212, 165, 116, 0.12);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
        pointer-events: none;
      }

      .form-scarcity__display::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background:
          radial-gradient(ellipse at 30% 10%, rgba(212, 0, 0, 0.08) 0%, transparent 60%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.06) 0%, transparent 50%);
        pointer-events: none;
      }

      .form-scarcity__number {
        font-family: "Bodoni Moda", serif;
        font-size: 1.65rem;
        font-weight: 800;
        font-style: italic;
        line-height: 1;
        font-variant-numeric: tabular-nums;
        letter-spacing: 0.02em;
        color: rgba(212, 165, 116, 0.95);
        text-shadow:
          0 0 20px rgba(212, 165, 116, 0.45),
          0 0 40px rgba(212, 165, 116, 0.2),
          0 2px 6px rgba(0, 0, 0, 0.3);
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        transition:
          transform 240ms cubic-bezier(0.16, 1, 0.3, 1),
          opacity 240ms cubic-bezier(0.16, 1, 0.3, 1),
          filter 240ms cubic-bezier(0.16, 1, 0.3, 1);
      }

      .form-scarcity__number--next {
        opacity: 0;
        filter: blur(1px);
        transform: translate(-50%, -70%);
        pointer-events: none;
      }

      .form-scarcity__display.is-tick {
        border-color: rgba(212, 0, 0, 0.35);
        box-shadow:
          inset 0 1px 0 rgba(212, 165, 116, 0.12),
          inset 0 -1px 0 rgba(0, 0, 0, 0.4),
          0 14px 40px rgba(0, 0, 0, 0.5),
          0 0 60px rgba(212, 0, 0, 0.15),
          0 0 80px rgba(212, 165, 116, 0.12);
        animation: counterPunch 280ms cubic-bezier(0.34, 1.56, 0.64, 1) 1;
      }

      @keyframes counterPunch {
        0% { transform: scale(1); }
        30% { transform: scale(1.12); }
        50% { transform: scale(0.97); }
        70% { transform: scale(1.04); }
        100% { transform: scale(1); }
      }

      .form-scarcity__display.is-tick .form-scarcity__number {
        transform: translate(-50%, -45%) scale(0.8);
        opacity: 0;
        filter: blur(2px);
        color: rgba(212, 0, 0, 0.7);
      }

      .form-scarcity__display.is-tick .form-scarcity__number--next {
        transform: translate(-50%, -50%);
        opacity: 1;
        filter: blur(0);
        color: rgba(212, 165, 116, 1);
        text-shadow:
          0 0 20px rgba(212, 165, 116, 0.6),
          0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .form-scarcity__label {
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.78);
        text-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
        position: relative;
        padding-left: 14px;
      }

      .form-scarcity__label::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: linear-gradient(180deg, rgba(212, 0, 0, 0.9) 0%, rgba(138, 0, 0, 0.9) 100%);
        box-shadow: 0 0 10px rgba(212, 0, 0, 0.18);
      }

      /* Micro-moment: pop when updated */
      .form-scarcity.is-pop .form-scarcity__display {
        animation: scarcityPop 260ms cubic-bezier(0.16, 1, 0.3, 1);
      }

      @keyframes scarcityPop {
        0% { transform: translateY(0) scale(1); }
        45% { transform: translateY(-1px) scale(1.03); }
        100% { transform: translateY(0) scale(1); }
      }

      /* Heat mode (few seats left) — more broadcast urgency, still CDL */
      .form-scarcity.is-hot .form-scarcity__display {
        border-color: rgba(212, 0, 0, 0.42);
        box-shadow:
          inset 0 1px 0 rgba(212, 165, 116, 0.08),
          inset 0 -1px 0 rgba(0, 0, 0, 0.35),
          0 14px 40px rgba(0, 0, 0, 0.45),
          0 0 42px rgba(212, 0, 0, 0.06),
          0 0 40px rgba(212, 165, 116, 0.07);
      }

      .form-scarcity.is-hot .form-scarcity__label::before {
        animation: liveDotPulse 1.2s ease-in-out infinite;
      }

      @keyframes liveDotPulse {
        0%, 100% { transform: translateY(-50%) scale(1); opacity: 0.95; }
        50% { transform: translateY(-50%) scale(0.72); opacity: 0.55; }
      }

      .form-scarcity.is-hot .form-scarcity__label {
        color: rgba(255, 255, 255, 0.78);
      }

      .form-scarcity.is-alert .form-scarcity__label::before {
        animation: alertDot 700ms ease-in-out 2;
        box-shadow:
          0 0 10px rgba(212, 0, 0, 0.24),
          0 0 20px rgba(212, 165, 116, 0.12);
      }

      @keyframes alertDot {
        0%, 100% { transform: translateY(-50%) scale(1); opacity: 1; }
        45% { transform: translateY(-50%) scale(1.5); opacity: 0.85; }
      }

      @media (prefers-reduced-motion: reduce) {
        .form-scarcity.is-pop .form-scarcity__display {
          animation: none;
        }
        .form-scarcity.is-hot .form-scarcity__label::before {
          animation: none;
        }
        .form-scarcity.is-alert .form-scarcity__label::before {
          animation: none;
        }
        .form-scarcity__number {
          transition: none;
        }
        .form-scarcity__display.is-tick {
          animation: none;
        }
      }

      /* Subtle connection: when a seat ticks down, the form responds */
      .form-shell.is-seat-shift {
        border-color: rgba(212, 165, 116, 0.32);
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.04) inset,
          0 20px 50px rgba(0, 0, 0, 0.5),
          0 0 100px rgba(0, 0, 0, 0.3),
          0 0 80px rgba(183, 106, 59, 0.08),
          0 0 120px rgba(212, 165, 116, 0.07),
          0 0 70px rgba(212, 0, 0, 0.03);
      }

      .form-shell.is-seat-shift::before {
        border-color: rgba(212, 0, 0, 0.12);
      }

      .form-shell.is-seat-shift .form-section--primary {
        border-bottom-color: rgba(212, 0, 0, 0.16);
      }

      .form-shell.is-seat-shift .form-section--primary .input-wrapper::after {
        background: rgba(212, 0, 0, 0.35);
        height: 2px;
        transform: skewX(0);
        box-shadow: 0 2px 12px rgba(212, 0, 0, 0.12);
      }

      /* Form Header - Scarcity + Tagline */
      .form-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin-bottom: 28px;
        padding-bottom: 24px;
        border-bottom: 1px solid rgba(212, 165, 116, 0.1);
      }

      .form-header__tagline {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.8rem;
        font-style: italic;
        color: rgba(255, 255, 255, 0.4);
        letter-spacing: 0.02em;
        margin: 0;
      }

      /* Form Sections - Visual grouping */
      .form-section {
        margin-bottom: 8px;
      }

      .form-section--primary {
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(212, 165, 116, 0.08);
      }

      .form-section--primary .label--primary {
        border-left: none;
        padding-left: 0;
        box-shadow: none;
      }

      .form-section--primary input {
        font-size: 1.3rem;
        padding: 16px 0;
        font-weight: 500;
      }

      .form-section--secondary {
        display: grid;
        gap: 16px;
      }

      /* Label hierarchy */
      .label-main {
        display: block;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .label-sub {
        display: block;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        font-weight: 400;
        font-style: italic;
        text-transform: none;
        letter-spacing: 0.01em;
        color: rgba(255, 255, 255, 0.35);
        margin-bottom: 8px;
      }

      /* Terms Checkbox - Trash Talk Agreement */
      .form-terms {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid rgba(212, 165, 116, 0.08);
      }

      .terms-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }

      .terms-checkbox input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .terms-checkbox__box {
        flex-shrink: 0;
        width: 18px;
        height: 18px;
        border: 1.5px solid rgba(212, 165, 116, 0.5);
        border-radius: 4px;
        background: rgba(212, 165, 116, 0.05);
        position: relative;
        margin-top: 2px;
        transition: all 0.2s ease;
      }

      .terms-checkbox__box::after {
        content: '';
        position: absolute;
        left: 5px;
        top: 1px;
        width: 5px;
        height: 10px;
        border: solid var(--brass);
        border-width: 0 2px 2px 0;
        transform: rotate(45deg) scale(0);
        transition: transform 0.15s ease;
      }

      .terms-checkbox input:checked + .terms-checkbox__box {
        background: rgba(212, 165, 116, 0.15);
        border-color: var(--brass);
      }

      .terms-checkbox input:checked + .terms-checkbox__box::after {
        transform: rotate(45deg) scale(1);
      }

      .terms-checkbox input:focus-visible + .terms-checkbox__box {
        box-shadow: 0 0 0 2px rgba(212, 165, 116, 0.3);
      }

      .terms-checkbox:hover .terms-checkbox__box {
        border-color: var(--brass);
        background: rgba(212, 165, 116, 0.1);
      }

      .terms-checkbox__text {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        line-height: 1.5;
        color: rgba(255, 255, 255, 0.6);
      }

      .terms-checkbox__text em {
        font-style: italic;
        color: var(--brass);
      }

      .terms-highlight {
        display: inline-block;
        font-weight: 600;
        color: var(--gold);
        margin-left: 2px;
      }

      /* Form CTA Area */
      .form-cta {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin-top: 28px;
      }

      .form-cta button {
        /* Remove width: 100% to allow natural centering */
      }

      .form-cta__hint {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        font-style: italic;
        color: rgba(255, 255, 255, 0.3);
        margin: 0;
        letter-spacing: 0.02em;
      }

      /* Button Scarcity - Subtle status indicator, matches ticker energy */
      .button-scarcity {
        display: none; /* Hidden on desktop */
        margin: 14px 0 0 0;
        text-align: center;
      }

      .button-scarcity__inner {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .button-scarcity__pulse {
        width: 6px;
        height: 6px;
        background: rgba(212, 165, 116, 0.5);  /* Muted brass */
        border-radius: 50%;
        animation: scarcityPulse 2s ease-in-out infinite;
      }

      .button-scarcity__text {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.4);
      }

      .button-scarcity__text span {
        color: rgba(212, 165, 116, 0.7);  /* Muted brass */
        font-weight: 700;
      }

      /* Primary Label - WHO YOU ARE at the table */
      .label--primary {
        position: relative;
        padding-left: 16px;
        border-left: 3px solid var(--brass);
        box-shadow: -3px 0 12px rgba(212, 165, 116, 0.2);
      }

      /* Optional Label - Reduced emphasis */
      .label--optional {
        opacity: 0.7;
      }

      .label-hint {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        font-style: normal;
        font-weight: 400;
        color: rgba(212, 165, 116, 0.5);
      }

      /* Form Action - Button wrapper */
      .form-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        margin-top: 8px;
      }

      /* Payment Badge - $25 as text label, NOT a button */
      .payment-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 8px 0;
        background: transparent;
        border: none;
      }

      .payment-badge__amount {
        font-family: "Bodoni Moda", serif;
        font-size: 1.2rem;
        font-weight: 700;
        font-style: italic;
        color: var(--brass);
        letter-spacing: 0.02em;
      }

      .payment-badge__note {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        font-weight: 500;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.6);
      }

      /* Scroll Hint Divider - hidden everywhere (design changed to single viewport) */
      .scroll-hint-divider {
        display: none;
      }

      /* Footer Contact — ESPN Closing Credits Style */
      /* No boxy container — content floats on darkness */
      .footer-contact {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 48px;
        width: 100%;
        padding: 0;
        background: none;
        border: none;
      }

      .footer-contact__item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        gap: 10px;
        min-width: 180px; /* Equal width for balanced layout */
      }

      /* ESPN condensed typography for labels */
      .footer-contact__label {
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--brass);
        text-shadow: 0 2px 14px rgba(0, 0, 0, 0.85);
      }

      .footer-contact__link {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.85);
        text-decoration: none;
        transition: color 0.2s ease;
        position: relative;
        text-shadow: 0 2px 16px rgba(0, 0, 0, 0.9);
      }

      .footer-contact__link::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 0;
        width: 100%;
        height: 1px;
        background: var(--brass);
        transform: scaleX(0);
        transform-origin: center;
        transition: transform 0.25s ease;
      }

      .footer-contact__link:hover {
        color: var(--brass);
      }

      .footer-contact__link:hover::after {
        transform: scaleX(1);
      }

      /* Vertical divider — broadcast style */
      .footer-contact__divider {
        width: 1px;
        height: 40px;
        background: rgba(212, 165, 116, 0.25);
        align-self: center;
      }

      /* Mobile: Stack footer vertically */
      @media (max-width: 480px) {
        .form-header__edition {
          font-size: 0.6rem;
        }

        .form-scarcity {
          gap: 10px;
          margin-bottom: 20px;
        }

        .form-scarcity__display {
          min-width: 58px;
          height: 40px;
          padding: 0 12px;
        }

        .form-scarcity__number {
          font-size: 1.45rem;
        }

        .form-scarcity__label {
          font-size: 0.65rem;
        }

        .label--primary {
          padding-left: 12px;
        }

        .payment-badge {
          padding: 8px 16px;
        }

        .payment-badge__amount {
          font-size: 1rem;
        }

        .footer-contact {
          flex-direction: column;
          gap: 24px;
          align-items: center;
        }

        .footer-contact__item {
          align-items: center;
          text-align: center;
        }

        .footer-contact__divider {
          width: 40px;
          height: 1px;
          background: rgba(212, 165, 116, 0.2);
        }

        .footer-contact__link {
          font-size: 0.9rem;
        }

        .footer-contact__label {
          font-size: 0.65rem;
        }
      }

      /* Success Celebration State - Club 33 Earned Elegance */
      .success {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: radial-gradient(ellipse at center top, rgba(30, 20, 15, 0.98) 0%, rgba(10, 7, 5, 0.99) 100%);
        flex-direction: column;
        align-items: center;
        justify-content: center; /* Tobias: "The room feels full, not empty" */
        text-align: center;
        /* Keep content comfortably above fixed ticker + safe areas */
        padding:
          calc(env(safe-area-inset-top) + max(20px, 4dvh))
          24px
          calc(env(safe-area-inset-bottom) + 60px + max(16px, 3dvh));
        overflow-y: auto;
      }

      /* Film grain overlay - subtle texture */
      .success::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.025;
        pointer-events: none;
        z-index: 1;
      }

      /* Vignette - elegant dark edges */
      .success::after {
        content: '';
        position: fixed;
        inset: 0;
        background: radial-gradient(ellipse at center, transparent 30%, rgba(0, 0, 0, 0.5) 100%);
        pointer-events: none;
        z-index: 2;
      }

      /* Content layer above grain/vignette */
      .success > * {
        position: relative;
        z-index: 3;
      }

      .success.is-visible {
        display: flex;
        z-index: 100000; /* Above loading screen (99999) during handoff */
        opacity: 1; /* Instant - no fade, prevents flicker during loading transition */
        animation: roomWelcome 1.5s ease-in-out 0.2s; /* Room warmth effect only */
      }

      @keyframes successReveal {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Room warmth pulse - "The room welcomes you" */
      @keyframes roomWelcome {
        0% {
          filter: brightness(1);
        }
        30% {
          filter: brightness(1.15) saturate(1.1);
        }
        100% {
          filter: brightness(1) saturate(1);
        }
      }

      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Domino Hero */
      .domino-container {
        position: relative;
        margin-bottom: clamp(16px, 4dvh, 44px);
        perspective: 1000px;
      }

      .domino {
        width: 48px;  /* Compact: was 90px → 64px → 48px */
        height: 96px; /* Compact: was 180px → 128px → 96px */
        background: linear-gradient(165deg, #fefefe 0%, #f5f0eb 40%, #e8e2db 100%);
        border-radius: 8px; /* Compact: was 14px → 10px → 8px */
        margin: 0 auto;
        position: relative;
        box-shadow:
          0 16px 32px rgba(0, 0, 0, 0.6),
          0 0 48px rgba(212, 165, 116, 0.3),
          0 0 64px rgba(255, 215, 0, 0.1),
          inset 0 2px 0 rgba(255, 255, 255, 0.8);
        animation: dominoSlamSuccess 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) 0.6s both;
      }

      /* Success domino: lands with weight - realistic physics */
      @keyframes dominoSlamSuccess {
        0% {
          transform: rotateX(-75deg) translateY(-80px) scale(0.85);
          opacity: 0;
          filter: blur(2px);
          box-shadow:
            0 2px 4px rgba(0, 0, 0, 0.1),
            0 4px 8px rgba(0, 0, 0, 0.1),
            0 0 20px rgba(212, 165, 116, 0.1),
            inset 0 2px 0 rgba(255, 255, 255, 0.8);
        }
        /* Approaching - accelerating fall */
        40% {
          transform: rotateX(-15deg) translateY(-10px) scale(0.98);
          opacity: 1;
          filter: blur(0);
          box-shadow:
            0 6px 12px rgba(0, 0, 0, 0.3),
            0 12px 24px rgba(0, 0, 0, 0.4),
            0 0 32px rgba(212, 165, 116, 0.2),
            inset 0 2px 0 rgba(255, 255, 255, 0.8);
        }
        /* IMPACT - compression squash */
        55% {
          transform: rotateX(4deg) translateY(2px) scale(1.02, 0.96);
          box-shadow:
            0 10px 20px rgba(0, 0, 0, 0.5),
            0 20px 40px rgba(0, 0, 0, 0.7),
            0 0 48px rgba(212, 165, 116, 0.4),
            0 0 64px rgba(255, 215, 0, 0.15),
            inset 0 2px 0 rgba(255, 255, 255, 0.8);
        }
        /* Rebound - slight lift */
        70% {
          transform: rotateX(-2deg) translateY(-3px) scale(0.99, 1.01);
          box-shadow:
            0 8px 16px rgba(0, 0, 0, 0.4),
            0 16px 32px rgba(0, 0, 0, 0.5),
            0 0 48px rgba(212, 165, 116, 0.3),
            0 0 64px rgba(255, 215, 0, 0.1),
            inset 0 2px 0 rgba(255, 255, 255, 0.8);
        }
        /* Settle wobble */
        85% {
          transform: rotateX(1deg) scale(1.005);
          box-shadow:
            0 8px 16px rgba(0, 0, 0, 0.4),
            0 16px 32px rgba(0, 0, 0, 0.6),
            0 0 48px rgba(212, 165, 116, 0.3),
            0 0 64px rgba(255, 215, 0, 0.1),
            inset 0 2px 0 rgba(255, 255, 255, 0.8);
        }
        /* Rest - settled */
        100% {
          transform: rotateX(0deg) translateY(0) scale(1);
          opacity: 1;
          filter: blur(0);
          box-shadow:
            0 8px 16px rgba(0, 0, 0, 0.4),
            0 16px 32px rgba(0, 0, 0, 0.6),
            0 0 48px rgba(212, 165, 116, 0.3),
            0 0 64px rgba(255, 215, 0, 0.1),
            inset 0 2px 0 rgba(255, 255, 255, 0.8);
        }
      }

      .domino::before {
        content: '';
        position: absolute;
        left: 10%;
        right: 10%;
        top: 50%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--copper), transparent);
        border-radius: 2px;
        transform: translateY(-50%);
      }

      .domino::after {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 14px;
        background: radial-gradient(ellipse at center, rgba(212, 165, 116, 0.3) 0%, transparent 70%);
        animation: dominoGlowPulse 2s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes dominoGlowPulse {
        0%, 100% { opacity: 0.5; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.05); }
      }

      .domino-top, .domino-bottom {
        position: absolute;
        left: 0;
        right: 0;
        height: 50%;
      }

      .domino-top { top: 0; }
      .domino-bottom { bottom: 0; }

      .pip {
        position: absolute;
        width: 8px;  /* Compact: was 16px → 11px → 8px */
        height: 8px; /* Compact: was 16px → 11px → 8px */
        background: radial-gradient(circle at 30% 30%, var(--copper), #2a1810);
        border-radius: 50%;
        box-shadow:
          inset 0 1px 2px rgba(0, 0, 0, 0.5),
          0 1px 1px rgba(0, 0, 0, 0.2);
      }

      /* Double six pip positions - top half (48x96 compact domino) */
      .domino-top .pip:nth-child(1) { top: 8px; left: 9px; }
      .domino-top .pip:nth-child(2) { top: 8px; right: 9px; }
      .domino-top .pip:nth-child(3) { top: 50%; left: 9px; transform: translateY(-50%); }
      .domino-top .pip:nth-child(4) { top: 50%; right: 9px; transform: translateY(-50%); }
      .domino-top .pip:nth-child(5) { bottom: 10px; left: 9px; }
      .domino-top .pip:nth-child(6) { bottom: 10px; right: 9px; }

      /* Double six pip positions - bottom half (48x96 compact domino) */
      .domino-bottom .pip:nth-child(1) { top: 8px; left: 9px; }
      .domino-bottom .pip:nth-child(2) { top: 8px; right: 9px; }
      .domino-bottom .pip:nth-child(3) { top: 50%; left: 9px; transform: translateY(-50%); }
      .domino-bottom .pip:nth-child(4) { top: 50%; right: 9px; transform: translateY(-50%); }
      .domino-bottom .pip:nth-child(5) { bottom: 8px; left: 9px; }
      .domino-bottom .pip:nth-child(6) { bottom: 8px; right: 9px; }

      /* Shimmer particles */
      .shimmer {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--gold);
        border-radius: 50%;
        animation: shimmerFloat 3s ease-in-out infinite;
        opacity: 0;
      }

      .shimmer:nth-child(1) { left: 20%; top: 20%; animation-delay: 0s; }
      .shimmer:nth-child(2) { left: 80%; top: 30%; animation-delay: 0.5s; }
      .shimmer:nth-child(3) { left: 10%; top: 60%; animation-delay: 1s; }
      .shimmer:nth-child(4) { left: 90%; top: 70%; animation-delay: 1.5s; }
      .shimmer:nth-child(5) { left: 50%; top: 10%; animation-delay: 2s; }

      @keyframes shimmerFloat {
        0%, 100% { opacity: 0; transform: translateY(0) scale(0.5); }
        50% { opacity: 1; transform: translateY(-10px) scale(1); }
      }

      /* Success Headlines */
      .success-headline {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: clamp(2.5rem, 10vw, 3.5rem); /* Compact: was clamp(3rem, 12vw, 4.5rem) */
        font-weight: 600;
        color: var(--cream);
        letter-spacing: 0.05em;
        text-transform: uppercase;
        margin-bottom: clamp(8px, 1.6dvh, 14px);
        animation: fadeUp 0.6s ease-out 1.0s both; /* Cinematic: delayed to 1.0s */
        line-height: 1.1;
      }

      .success-headline span {
        color: var(--brass);
        display: inline-block;
        text-shadow:
          0 0 30px rgba(212, 165, 116, 0.5),
          0 0 60px rgba(183, 106, 59, 0.3);
        /* Club 33 entrance slam - HEAVY, earned elegance */
        animation: inSlamHeavy 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 1.4s both, brassShine 3s ease-in-out 2.2s infinite;
      }

      /* The "In" slam - HEAVY: larger scale, more dramatic compression, extended glow */
      @keyframes inSlamHeavy {
        0% {
          transform: scale(2);
          opacity: 0;
          text-shadow: 0 0 0 transparent;
        }
        50% {
          transform: scale(0.85);
          text-shadow: 0 0 80px rgba(212, 165, 116, 1),
                       0 0 120px rgba(183, 106, 59, 0.8);
        }
        75% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
          opacity: 1;
          text-shadow: 0 0 40px rgba(212, 165, 116, 0.6),
                       0 0 80px rgba(183, 106, 59, 0.4);
        }
      }

      @keyframes brassShine {
        0%, 100% {
          text-shadow: 0 0 40px rgba(212, 165, 116, 0.6), 0 0 80px rgba(183, 106, 59, 0.4);
          filter: brightness(1);
        }
        50% {
          text-shadow: 0 0 60px rgba(212, 165, 116, 0.8), 0 0 120px rgba(183, 106, 59, 0.5);
          filter: brightness(1.1);
        }
      }

      .success-subheadline {
        font-size: 0.95rem; /* Compact: was 1.1rem → 1rem → 0.95rem */
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: clamp(16px, 3.5dvh, 32px);
        animation: fadeUp 0.6s ease-out 2.3s both; /* Cinematic: after "In" slam breathes */
        letter-spacing: 0.03em;
      }

      /* Event Details Card - Engraved brass plaque feel */
      .event-details {
        background: linear-gradient(135deg, rgba(20, 14, 10, 0.95) 0%, rgba(30, 20, 15, 0.9) 100%);
        border: 1px solid rgba(212, 165, 116, 0.35);
        border-radius: 8px; /* Sharper, machined feel */
        padding: 12px 20px; /* Compact: was 28px 40px → 16px 28px → 12px 20px */
        margin-bottom: clamp(10px, 3dvh, 26px);
        position: relative;
        overflow: hidden;
        flex-shrink: 0; /* Prevent shrinking - content must stay visible */
        animation: cardRiseHeavy 0.8s ease-out 2.8s both; /* Cinematic: heavier, slower */
        width: 100%;
        max-width: 260px; /* Compact: was 320px → 280px → 260px */
        /* Engraved/inset feel */
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.4),
          inset 0 -1px 2px rgba(212, 165, 116, 0.08),
          0 8px 32px rgba(0, 0, 0, 0.5),
          0 0 1px rgba(212, 165, 116, 0.3);
      }

      /* Event card rises with weight - heavier, more presence */
      @keyframes cardRiseHeavy {
        0% {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }
        60% {
          transform: translateY(-5px) scale(1.01);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .event-details::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.06), transparent);
        animation: cardShine 5s ease-in-out 2s infinite;
      }

      @keyframes cardShine {
        0% { left: -100%; }
        50%, 100% { left: 200%; }
      }

      .event-date {
        font-family: "Bodoni Moda", serif;
        font-size: 1.25rem; /* Compact: was 1.6rem → 1.4rem → 1.25rem */
        font-weight: 700;
        color: var(--brass);
        margin-bottom: 2px; /* Compact: was 8px → 4px → 2px */
        letter-spacing: 0.02em;
      }

      .event-venue {
        font-size: 0.95rem; /* Compact: was 1.15rem → 1rem → 0.95rem */
        color: var(--cream);
        margin-bottom: 2px; /* Compact: was 6px → 4px → 2px */
        font-weight: 500;
        letter-spacing: 0.01em;
      }

      .event-time {
        font-size: 0.85rem; /* Compact: was 1rem → 0.9rem → 0.85rem */
        color: rgba(255, 255, 255, 0.6);
        letter-spacing: 0.02em;
      }

      .event-payment {
        font-family: "Bodoni Moda", serif;
        font-size: 0.95rem; /* Compact: was 1.1rem → 1rem → 0.95rem */
        font-style: italic;
        color: var(--brass);
        margin-top: 6px; /* Compact: was 12px → 8px → 6px */
        padding-top: 6px; /* Compact: was 12px → 8px → 6px */
        border-top: 1px solid rgba(212, 165, 116, 0.2);
      }

      /* Divider - Hidden on mobile to save space */
      .success-divider {
        display: none; /* Hidden on mobile for compact fit */
        align-items: center;
        gap: 12px;
        margin: 10px 0;
        width: 100%;
        max-width: 180px;
        animation: fadeUp 0.5s ease-out 2.0s both; /* Cinematic: after card */
      }

      .success-divider::before,
      .success-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.5), transparent);
      }

      .divider-pip {
        width: 10px;
        height: 10px;
        background: radial-gradient(circle at 30% 30%, var(--brass), var(--copper));
        border-radius: 50%;
        box-shadow: 0 0 12px rgba(212, 165, 116, 0.4);
      }

      /* Tagline - Hidden on mobile to save space */
      .success-tagline {
        display: none; /* Hidden on mobile for compact fit */
        font-family: "Bodoni Moda", serif;
        font-size: 1.1rem;
        font-style: italic;
        color: var(--brass);
        opacity: 0.9;
        animation: fadeUp 0.6s ease-out 3.5s both; /* Cinematic: after divider */
        letter-spacing: 0.02em;
      }

      /* La Mesa CTA - Club 33 artifact feel */
      .success-mesa-cta {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.9rem; /* Compact: was 1rem → 0.95rem → 0.9rem */
        font-weight: 600;
        color: var(--cream);
        background: linear-gradient(135deg, var(--copper), #6b3020);
        border: none;
        border-radius: 8px; /* Compact: was 12px → 10px → 8px */
        padding: 12px 24px; /* Compact: was 16px 32px → 14px 28px → 12px 24px */
        margin-top: clamp(12px, 4dvh, 40px);
        cursor: pointer;
        letter-spacing: 0.05em;
        box-shadow:
          0 4px 20px rgba(143, 60, 34, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.12),
          inset 0 -1px 0 rgba(0, 0, 0, 0.2);
        transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        animation: ctaRevealHeavy 0.6s ease-out 3.5s both; /* Cinematic: arrives with weight */
      }

      /* CTA arrives with presence, not float */
      @keyframes ctaRevealHeavy {
        0% {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        70% {
          transform: translateY(-2px) scale(1.02);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .success-mesa-cta:hover {
        transform: translateY(-2px);
        box-shadow:
          0 8px 28px rgba(143, 60, 34, 0.5),
          0 0 30px rgba(212, 165, 116, 0.15),
          inset 0 1px 0 rgba(255, 255, 255, 0.15),
          inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      }

      .success-mesa-cta:active {
        transform: translateY(0) scale(0.98);
        box-shadow:
          0 2px 12px rgba(143, 60, 34, 0.4),
          inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* Email reminder */
      .email-reminder {
        margin-top: clamp(16px, 5dvh, 52px);
        font-size: 0.8rem; /* Compact: was 0.95rem → 0.85rem → 0.8rem */
        color: rgba(255, 255, 255, 0.45);
        animation: fadeUp 0.5s ease-out 4.0s both; /* Cinematic: final element */
      }

      /* Taller phones: restore a touch of ritual to avoid "empty black" */
      @media (max-width: 1023px) and (min-height: 640px) {
        .success-divider {
          display: flex;
        }
        .success-tagline {
          display: block;
        }
      }

      .email-reminder a {
        color: rgba(212, 165, 116, 0.7);
        text-decoration: none;
        transition: color 0.2s ease;
        border-bottom: 1px solid rgba(212, 165, 116, 0.3);
        padding-bottom: 2px;
      }

      .email-reminder a:hover {
        color: var(--brass);
        border-bottom-color: var(--brass);
      }

      /* Reduced motion: Show success elements immediately */
      @media (prefers-reduced-motion: reduce) {
        .success.is-visible {
          animation: none; /* No animations for reduced motion */
        }
        .domino {
          animation: none;
          opacity: 1;
        }
        .success-headline,
        .success-headline span,
        .success-subheadline,
        .event-details,
        .success-divider,
        .success-tagline,
        .success-mesa-cta,
        .email-reminder {
          animation: none !important;
          opacity: 1 !important;
          transform: none !important;
        }
        .domino::after {
          animation: none;
          opacity: 0.6;
        }
        .shimmer {
          display: none;
        }
      }

      /* ========================================
         WAITING STATE - "The Domino Stands"
         Premium loading experience before success
         ======================================== */
      .registration-waiting {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9998;
        background: radial-gradient(ellipse at center top, rgba(30, 20, 15, 0.98) 0%, rgba(10, 7, 5, 0.99) 100%);
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 24px;
      }

      /* Film grain overlay */
      .registration-waiting::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.025;
        pointer-events: none;
        z-index: 1;
      }

      /* Vignette */
      .registration-waiting::after {
        content: '';
        position: fixed;
        inset: 0;
        background: radial-gradient(ellipse at center, transparent 30%, rgba(0, 0, 0, 0.5) 100%);
        pointer-events: none;
        z-index: 2;
      }

      .registration-waiting.is-visible {
        display: flex;
        animation: waitingFadeIn 0.3s ease-out;
      }

      @keyframes waitingFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .registration-waiting > * {
        position: relative;
        z-index: 3;
      }

      /* Standing domino container */
      .waiting-domino-container {
        position: relative;
        margin-bottom: 32px;
      }

      /* Standing domino - Double Six matching reference */
      .waiting-domino {
        width: 72px;
        height: 144px;
        background: linear-gradient(175deg, #fefefe 0%, #f8f4f0 30%, #f0ebe5 60%, #e8e2db 100%);
        border-radius: 12px;
        position: relative;
        box-shadow:
          0 25px 50px rgba(0, 0, 0, 0.5),
          0 0 80px rgba(212, 165, 116, 0.25),
          0 0 0 1px rgba(200, 180, 160, 0.3),
          inset 0 2px 0 rgba(255, 255, 255, 0.9),
          inset 0 -1px 0 rgba(0, 0, 0, 0.05);
        animation: dominoRock 2s ease-in-out infinite;
        transform-origin: center center;
      }

      /* Waiting state: Gentle confident rock */
      @keyframes dominoRock {
        0%, 100% { transform: rotate(-1.5deg); }
        50% { transform: rotate(1.5deg); }
      }

      /* Domino divider line - centered horizontal bar */
      .waiting-domino-divider {
        position: absolute;
        left: 8px;
        right: 8px;
        top: 50%;
        height: 3px;
        background: linear-gradient(180deg,
          rgba(120, 80, 50, 0.6) 0%,
          rgba(180, 130, 90, 0.8) 50%,
          rgba(100, 70, 45, 0.5) 100%);
        border-radius: 1.5px;
        transform: translateY(-50%);
        box-shadow:
          inset 0 1px 1px rgba(255, 255, 255, 0.3),
          0 1px 2px rgba(0, 0, 0, 0.15);
      }

      /* Waiting domino pip containers - 2x3 grid */
      .waiting-domino-top,
      .waiting-domino-bottom {
        position: absolute;
        left: 0;
        right: 0;
        height: calc(50% - 2px);
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr 1fr;
        padding: 10px 12px;
        box-sizing: border-box;
      }

      .waiting-domino-top { top: 0; }
      .waiting-domino-bottom { bottom: 0; }

      /* Pips - recessed copper circles with 3D depth */
      .waiting-domino-top .pip,
      .waiting-domino-bottom .pip {
        width: 14px;
        height: 14px;
        background: radial-gradient(ellipse at 35% 25%,
          #c49a6c 0%,
          #a67c52 30%,
          #7d5a3a 60%,
          #5a3d28 100%);
        border-radius: 50%;
        justify-self: center;
        align-self: center;
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.5),
          inset 0 -1px 2px rgba(255, 255, 255, 0.15),
          0 1px 1px rgba(255, 255, 255, 0.4);
      }

      /* Pulsing copper glow behind domino */
      .waiting-glow {
        position: absolute;
        width: 160px;
        height: 200px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: radial-gradient(ellipse at center,
          rgba(212, 165, 116, 0.35) 0%,
          rgba(183, 130, 80, 0.2) 40%,
          transparent 70%);
        border-radius: 50%;
        animation: glowPulse 2.5s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes glowPulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.9; }
      }

      /* Warm wash overlay - visual bridge during transition */
      .waiting-warm-wash {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at center,
          rgba(212, 165, 116, 0.4) 0%,
          rgba(183, 130, 80, 0.2) 50%,
          transparent 80%);
        opacity: 0;
        pointer-events: none;
        z-index: 10;
      }

      /* "Securing your seat..." text */
      .waiting-text {
        font-family: "Bodoni Moda", serif;
        font-size: 1.2rem;
        font-style: italic;
        color: var(--brass);
        opacity: 0.9;
        letter-spacing: 0.03em;
        animation: textPulse 2s ease-in-out infinite;
      }

      @keyframes textPulse {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
      }

      /* Transition state - glow bridge + weighted handoff */
      .registration-waiting.is-transitioning .waiting-domino {
        animation: dominoFadeQuick 0.3s ease-out forwards;
      }

      @keyframes dominoFadeQuick {
        0% { opacity: 1; transform: rotate(0); }
        100% { opacity: 0; transform: rotate(0) scale(0.9); }
      }

      .registration-waiting.is-transitioning .waiting-glow {
        animation: glowIntensify 0.4s ease-in forwards;
      }

      @keyframes glowIntensify {
        0% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;
          filter: blur(0);
        }
        60% {
          transform: translate(-50%, -50%) scale(1.8);
          opacity: 1;
          filter: blur(20px);
        }
        100% {
          transform: translate(-50%, -50%) scale(3);
          opacity: 0;
          filter: blur(40px);
        }
      }

      .registration-waiting.is-transitioning .waiting-warm-wash {
        animation: warmWash 0.6s ease-out forwards;
      }

      @keyframes warmWash {
        0% {
          opacity: 0;
          transform: scale(0.3);
        }
        40% {
          opacity: 1;
          transform: scale(1.5);
        }
        100% {
          opacity: 0;
          transform: scale(2);
        }
      }

      .registration-waiting.is-transitioning .waiting-text {
        animation: textFadeQuick 0.25s ease-out forwards;
      }

      @keyframes textFadeQuick {
        from { opacity: 0.9; }
        to { opacity: 0; }
      }

      .registration-waiting.is-transitioning {
        animation: waitingFadeOut 0.4s ease-out 0.2s forwards;
      }

      @keyframes waitingFadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }

      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        .waiting-domino {
          animation: none;
        }
        .waiting-glow {
          animation: none;
          opacity: 0.7;
        }
        .waiting-text {
          animation: none;
          opacity: 0.9;
        }
        .waiting-warm-wash {
          display: none;
        }
        .registration-waiting.is-transitioning .waiting-domino,
        .registration-waiting.is-transitioning .waiting-glow,
        .registration-waiting.is-transitioning .waiting-warm-wash,
        .registration-waiting.is-transitioning .waiting-text,
        .registration-waiting.is-transitioning {
          animation: none;
        }
      }

      /* ========================================
         DESKTOP POLISH - Success Screen
         "The room feels full, not empty" — Tobias
         ======================================== */
      @media (min-width: 1024px) {
        /* Success Screen - More generous padding on desktop */
        .success {
          padding: 5vh 48px 8vh;
        }

        /* More pronounced vignette on desktop */
        .success::after {
          background: radial-gradient(ellipse at center, transparent 20%, rgba(0, 0, 0, 0.6) 100%);
        }

        /* Domino - More presence */
        .domino-container {
          margin-bottom: 48px;
        }

        .domino {
          width: 120px;
          height: 240px;
          border-radius: 18px;
          box-shadow:
            0 35px 70px rgba(0, 0, 0, 0.7),
            0 0 120px rgba(212, 165, 116, 0.35),
            0 0 180px rgba(255, 215, 0, 0.15),
            inset 0 2px 0 rgba(255, 255, 255, 0.8);
        }

        .domino::before {
          height: 3px;
        }

        .domino::after {
          inset: -10px;
          border-radius: 18px;
          background: radial-gradient(ellipse at center, rgba(212, 165, 116, 0.4) 0%, transparent 70%);
        }

        /* Scale pips for larger domino (120x240) */
        .pip {
          width: 20px;
          height: 20px;
        }

        .domino-top .pip:nth-child(1) { top: 18px; left: 22px; }
        .domino-top .pip:nth-child(2) { top: 18px; right: 22px; }
        .domino-top .pip:nth-child(3) { top: 50%; left: 22px; transform: translateY(-50%); }
        .domino-top .pip:nth-child(4) { top: 50%; right: 22px; transform: translateY(-50%); }
        .domino-top .pip:nth-child(5) { bottom: 22px; left: 22px; }
        .domino-top .pip:nth-child(6) { bottom: 22px; right: 22px; }

        .domino-bottom .pip:nth-child(1) { top: 18px; left: 22px; }
        .domino-bottom .pip:nth-child(2) { top: 18px; right: 22px; }
        .domino-bottom .pip:nth-child(3) { top: 50%; left: 22px; transform: translateY(-50%); }
        .domino-bottom .pip:nth-child(4) { top: 50%; right: 22px; transform: translateY(-50%); }
        .domino-bottom .pip:nth-child(5) { bottom: 18px; left: 22px; }
        .domino-bottom .pip:nth-child(6) { bottom: 18px; right: 22px; }

        /* Headlines - More presence */
        .success-headline {
          font-size: 4.5rem;
          margin-bottom: 12px;
        }

        .success-subheadline {
          font-size: 1.15rem;
          margin-bottom: 32px;
        }

        /* Event Details Card - Wider, more generous */
        .event-details {
          max-width: 380px;
          padding: 28px 48px;
          border-radius: 10px;
          margin-bottom: 28px;
        }

        .event-date {
          font-size: 1.9rem;
          margin-bottom: 10px;
        }

        .event-venue {
          font-size: 1.3rem;
          margin-bottom: 8px;
        }

        .event-time {
          font-size: 1.1rem;
        }

        .event-payment {
          font-size: 1.2rem;
          margin-top: 16px;
          padding-top: 16px;
        }

        /* Divider - Restored on desktop */
        .success-divider {
          display: flex; /* Restore on desktop */
          margin: 24px 0;
          max-width: 260px;
        }

        .divider-pip {
          width: 10px;
          height: 10px;
        }

        /* Tagline - Restored on desktop */
        .success-tagline {
          display: block; /* Restore on desktop */
          font-size: 1.5rem;
        }

        /* CTA - Larger touch target */
        .success-mesa-cta {
          padding: 20px 48px;
          font-size: 1.1rem;
          border-radius: 14px;
          margin-top: 40px;
        }

        .email-reminder {
          margin-top: 52px;
          font-size: 1rem;
        }

        /* Shimmer particles - larger spread */
        .shimmer {
          width: 5px;
          height: 5px;
        }
      }

      /* Extra-wide screens - subtle refinement, not aggressive scaling */
      @media (min-width: 1440px) {
        .success {
          padding: 6vh 64px 10vh;
        }

        .success-headline {
          font-size: 5rem;
        }

        .event-details {
          max-width: 400px;
          padding: 32px 56px;
        }
      }

      /* ========================================
         DESKTOP POLISH - La Mesa Chat Panel
         "Centered modal - entering a room"
         ======================================== */
      @media (min-width: 1024px) {
        /* Darker backdrop - near opaque to hide page */
        .chat-backdrop {
          background: rgba(10, 7, 5, 0.92);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
        }

        /* Panel becomes centered modal */
        .chat-panel {
          width: 640px;
          height: 680px;
          max-height: 75vh;
          min-height: 540px;
          right: auto;
          left: 50%;
          bottom: auto;
          top: 50%;
          transform: translate(-50%, -50%) scale(0.96);
          transform-origin: center center;
          border-radius: 16px;
          box-shadow:
            0 32px 80px rgba(0, 0, 0, 0.8),
            0 0 100px rgba(212, 165, 116, 0.1);
        }

        .chat-panel.is-open {
          transform: translate(-50%, -50%) scale(1);
        }

        .chat-panel.is-closing {
          transform: translate(-50%, -50%) scale(0.96);
        }

        /* More generous header spacing */
        .chat-header {
          padding: 24px 32px;
        }

        .chat-header__title {
          font-size: 1.2rem;
        }
      }

      /* Hub Main Structure */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0; /* Allow inner areas to scroll instead of forcing the panel to scroll */
        position: relative;
      }

      .chat-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        position: relative;
      }

      .mesa-hub-stack {
        display: grid;
        gap: 16px;
        padding: 18px;
        flex-shrink: 0;
        background: rgba(40, 20, 15, 0.95);
      }

      /* Hub -> transcript cue (discoverability without feeling "app-y") */
      .mesa-chat-cue {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 18px 6px;
        color: rgba(212, 165, 116, 0.7);
      }

      .mesa-chat-cue__line {
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.25), transparent);
      }

      .mesa-chat-cue__text {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.16em;
        text-transform: uppercase;
      }

      .mesa-chat-cue__pip {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: rgba(212, 165, 116, 0.85);
        box-shadow: 0 0 10px rgba(212, 165, 116, 0.25);
      }

      .mesa-chat-cue__chevron {
        opacity: 0.85;
        transform: translateY(1px);
      }

      .chat-panel.is-open.is-peek .mesa-chat-cue {
        display: none;
      }

      /* Hub Modules - stacked cards */
      .mesa-hub-module {
        position: relative;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
        border: 1px solid rgba(212, 165, 116, 0.18);
        background:
          radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.35) 100%),
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E"),
          linear-gradient(180deg, rgba(28, 19, 15, 0.88) 0%, rgba(20, 14, 11, 0.95) 100%);
        background-blend-mode: normal, overlay, normal;
        padding: 16px;
        box-shadow: var(--shadow-sm);
      }

      .mesa-hub-module__title {
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--brass);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 12px;
        border-bottom: 1px solid rgba(212, 165, 116, 0.18);
        padding-bottom: 10px;
      }

      .mesa-hub-module__content {
        flex: 1;
      }

      .mesa-hub-more {
        margin-top: 12px;
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-size: 0.7rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(212, 165, 116, 0.7);
      }

      .mesa-hub-empty {
        text-align: center;
        margin-top: 40px;
        color: rgba(255, 255, 255, 0.4);
        font-family: "Bodoni Moda", serif;
        font-style: italic;
      }

      /* Module Content Styling */
      .mesa-hub-module__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        border-bottom: 1px solid rgba(212, 165, 116, 0.18);
        padding-bottom: 10px;
      }

      .mesa-hub-module__header .mesa-hub-module__title {
        margin-bottom: 0;
        border-bottom: none;
        padding-bottom: 0;
      }

      /* The Board Items - Broadcast Style */
      .mesa-board-feed {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .mesa-board-item {
        background: rgba(28, 19, 15, 0.5);
        border: 1px solid rgba(212, 165, 116, 0.1);
        border-radius: 12px;
        padding: 20px;
      }

      .mesa-board-item--priority {
        border-left: 4px solid var(--brass);
        background: rgba(183, 106, 59, 0.08);
      }

      .mesa-board-item__kicker {
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--brass);
        text-transform: uppercase;
        letter-spacing: 0.15em;
        margin-bottom: 4px;
      }

      .mesa-board-item__title {
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--cream);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
        line-height: 1.1;
      }

      .mesa-board-item__body {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.5;
      }

      /* Tonight Module Card */
      .mesa-ritual-card {
        background: radial-gradient(circle at top center, rgba(183, 106, 59, 0.15) 0%, rgba(20, 14, 11, 0.4) 100%);
        border: 1px solid rgba(212, 165, 116, 0.25);
        border-radius: 12px;
        padding: 32px 24px;
        text-align: center;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      }

      .mesa-ritual-card__countdown {
        font-family: "SF Sports Night", "IBM Plex Sans Condensed", sans-serif;
        font-size: clamp(2.3rem, 7.2vw, 3.5rem);
        color: var(--brass);
        letter-spacing: 0.05em;
        text-shadow: 0 0 30px rgba(212, 165, 116, 0.4);
        margin-bottom: 4px;
      }

      .mesa-ritual-card__label {
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-size: 0.8rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        margin-bottom: 24px;
      }

      .mesa-ritual-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.3), transparent);
        margin: 24px 0;
      }

      .mesa-ritual-detail {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 16px;
      }

      .mesa-ritual-detail__label {
        font-family: "IBM Plex Sans Condensed", sans-serif;
        font-size: 0.65rem;
        font-weight: 700;
        color: var(--brass);
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .mesa-ritual-detail__value {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 1rem;
        color: var(--cream);
        font-weight: 500;
      }

      /* ========================================
         LA MESA TUTORIAL PANEL
         ======================================== */
      .mesa-tutorial {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      .mesa-tutorial.is-visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .mesa-tutorial__content {
        background: rgba(28, 19, 15, 0.95);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px;
        padding: 24px;
        max-width: 300px;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.5),
          0 0 60px rgba(212, 165, 116, 0.08);
      }

      .mesa-tutorial__header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .mesa-tutorial__icon {
        width: 10px;
        height: 10px;
        background: radial-gradient(circle at 30% 30%, var(--brass), var(--copper));
        border-radius: 50%;
        box-shadow: 0 0 12px rgba(212, 165, 116, 0.5);
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
      }

      .mesa-tutorial__title {
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--brass);
        margin: 0;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .mesa-tutorial__desc {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.5;
        margin: 0 0 20px 0;
      }

      .mesa-tutorial__actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* Tutorial CTA - Bone Language */
      .mesa-tutorial__cta {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--cream);
        background: linear-gradient(135deg, var(--copper), #6b3020);
        border: none;
        border-radius: 12px;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(143, 60, 34, 0.3);
      }

      .mesa-tutorial__cta:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(143, 60, 34, 0.4);
      }

      .mesa-tutorial__dismiss {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.5);
        background: transparent;
        border: none;
        padding: 8px;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .mesa-tutorial__dismiss:hover {
        color: rgba(255, 255, 255, 0.8);
      }

      /* Footer */
      .footer-note {
        margin-top: 28px;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.85rem;
        text-align: center;
      }

      .footer-note a {
        color: var(--brass);
        text-decoration: none;
      }

      /* Responsive */
      @media (max-width: 640px) {
        .panel {
          padding: 20px 16px;
        }

        .form-shell {
          padding: 22px 18px;
        }

        .players {
          padding: 14px;
        }

        .progress-tracker {
          padding: 16px 20px;
        }

        .panel--form {
          padding-top: 8vh; /* Still breathe on tablet */
        }
      }

      /* Mobile form panel - breathe, don't cram */
      @media (max-width: 768px) {
        .progress-tracker {
          display: none;
        }

        /* Edition badge hidden on mobile - clean focus */
        .form-header__edition {
          display: none;
        }

        /* Headline on mobile - generous breathing room */
        .form-header {
          margin-bottom: 24px;
        }

        .panel--form .panel-headline {
          font-size: clamp(1.6rem, 6vw, 2.2rem);
          margin-bottom: 18px;
          line-height: 1.15;
        }

        /* Hide Notes field on mobile - it's optional and saves space */
        .label--optional {
          display: none;
        }

        /* Hide the scroll-hint divider - footer is always visible now */
        .scroll-hint-divider {
          display: none !important;
        }

        /* Unified scarcity - keep form-scarcity visible on mobile too */
        /* button-scarcity removed for consistency */

        /* Form spacing - comfortable, not cramped */
        form {
          gap: 16px;
        }

        /* Mobile: Mandatory scroll-snap for immersive "guided cinema" experience.
           Combined with shorter scroll locks (1.5s vs 3s) and escape hatch for aggressive swipes. */
        .story {
          scroll-snap-type: y mandatory;
        }

        /* All panels: Keep scroll-snap-stop: always (from desktop styles) for firm stops */
        /* No overrides needed - inherit desktop snap behavior */

        /* Rules panel: Snap to top on mobile for firm stops */
        .panel--rules {
          scroll-snap-align: start;
          scroll-snap-stop: always;
        }

        /* Form panel: Snap to TOP, then allow natural scroll within
           - Content can exceed viewport height (form + footer)
           - Snaps when entering, but user can scroll within to see all content
           - overflow-y: visible allows content to extend beyond panel bounds */
        .panel--form {
          min-height: 100dvh;
          height: auto; /* Allow growth beyond viewport */
          padding-top: max(60px, 10vh);
          padding-bottom: 60px; /* Ticker clearance */
          justify-content: flex-start;
          scroll-snap-align: start; /* Snap to TOP of form panel */
          scroll-snap-stop: always; /* Stop here */
          overflow-y: visible; /* Content can overflow */
        }

        .form-shell {
          padding: 28px 20px 24px; /* More top breathing room */
          margin-bottom: 24px; /* Clean ending - footer is its own panel */
        }

        /* Form scroll indicator - shows there's more content below */
        /* Per Tobias audit: visual cue that form is scrollable */
        .panel--form::before {
          content: "";
          position: fixed;
          left: 0;
          right: 0;
          bottom: 46px; /* Above ticker */
          height: 60px;
          background: linear-gradient(
            to top,
            rgba(10, 7, 5, 0.95) 0%,
            rgba(10, 7, 5, 0.6) 40%,
            transparent 100%
          );
          pointer-events: none;
          z-index: 10;
          opacity: 0;
          transition: opacity 0.3s ease-out;
        }

        /* Show indicator when form has scrollable content */
        .panel--form.has-scroll-content::before {
          opacity: 1;
        }

        /* Hide when user has scrolled to bottom */
        .panel--form.scrolled-to-bottom::before {
          opacity: 0;
        }

	        .footer-contact {
	          margin-top: 0;
	          gap: 28px;
	          flex-direction: column;
	          align-items: center;
	          width: 100%;
	        }

        /* Horizontal divider on mobile */
        .footer-contact__divider {
          width: 40px;
          height: 1px;
          background: rgba(212, 165, 116, 0.2);
        }

        .footer-contact__item {
          align-items: center;
          text-align: center;
          min-width: auto; /* Reset desktop min-width */
          width: 100%;
        }

        .footer-contact__label {
          font-size: 0.7rem;
        }

        .footer-contact__link {
          font-size: 0.95rem;
        }

        .brand-footer {
          margin-top: 40px;
          align-items: center;
        }

        .brand-footer__logo {
          font-size: 1.3rem;
        }

        .brand-footer__text {
          font-size: 0.7rem;
        }
      }

      /* Small phones - still breathe */
      @media (max-width: 480px) {
        .panel--form {
          padding-top: max(50px, 8vh); /* Never less than 50px */
          padding-bottom: 80px; /* Ticker clearance */
        }

        .form-shell {
          padding: 20px 16px 28px; /* Extra bottom for button clearance */
          margin-bottom: 20px; /* Clean ending */
        }

        form {
          gap: 14px;
        }

        label {
          font-size: 0.95rem;
        }

        input, textarea {
          padding: 8px 0;
          font-size: 0.95rem;
        }

        button[type="submit"] {
          padding: 16px 24px;
          font-size: 0.9rem;
          margin-top: 8px;
        }

        /* Terms checkbox - compact on mobile */
        .terms-checkbox__text {
          font-size: 0.7rem;
        }

      }

      /* Hide honeypot */
      .honeypot {
        position: absolute;
        left: -9999px;
      }

      /* Back to Top - Domino Pip */
      .back-to-top {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        width: 48px;
        height: 48px;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px) scale(0.9);
        transition:
          opacity 0.6s ease-out,
          visibility 0.6s ease-out,
          transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .back-to-top.is-visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }

      /* Base pip - static inner highlights only */
      .back-to-top__pip {
        position: relative;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: radial-gradient(
          circle at 35% 35%,
          #e8c089 0%,
          var(--brass) 40%,
          var(--copper) 100%
        );
        /* Static inset shadows - never animated */
        box-shadow:
          inset 0 -2px 4px rgba(0, 0, 0, 0.3),
          inset 0 2px 4px rgba(255, 255, 255, 0.2);
        transition: transform 0.2s ease;
        will-change: transform;
      }

      /* Dim glow layer - always visible baseline */
      .back-to-top__pip::before {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 50%;
        box-shadow:
          0 0 8px rgba(212, 165, 116, 0.4),
          0 0 16px rgba(212, 165, 116, 0.25),
          0 0 24px rgba(183, 106, 59, 0.12);
        pointer-events: none;
      }

      /* Bloom glow layer - animated opacity for breathing */
      .back-to-top__pip::after {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 50%;
        box-shadow:
          0 0 12px var(--glow-warm),
          0 0 24px rgba(212, 165, 116, 0.55),
          0 0 40px var(--glow-deep),
          0 0 56px rgba(183, 106, 59, 0.2);
        opacity: 0;
        pointer-events: none;
        will-change: opacity;
      }

      /* Smooth 2-step sine wave breathing */
      @keyframes pipBreath {
        0% { opacity: 0; }
        100% { opacity: 1; }
      }

      /* Visible state - continuous breathing */
      .back-to-top.is-visible .back-to-top__pip::after {
        animation: pipBreath calc(var(--heartbeat) / 2) var(--breath-ease) infinite alternate;
      }

      /* Flare layer - one-shot entrance burst */
      .back-to-top__pip .pip-flare {
        position: absolute;
        inset: -8px;
        border-radius: 50%;
        box-shadow:
          0 0 20px var(--glow-warm),
          0 0 40px rgba(212, 165, 116, 0.7),
          0 0 60px var(--glow-deep),
          0 0 80px rgba(183, 106, 59, 0.35);
        opacity: 0;
        pointer-events: none;
        will-change: opacity;
      }

      @keyframes pipFlareOut {
        0% { opacity: 1; }
        100% { opacity: 0; }
      }

      /* On ember-release: flare fades while breathing starts */
      .back-to-top.ember-release .back-to-top__pip .pip-flare {
        animation: pipFlareOut 1.2s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
      }

      /* ===== MICRO-EMBERS - wisps rising from the pip like cigar smoke ===== */
      .pip-ember {
        position: absolute;
        width: 3px;
        height: 3px;
        background: var(--ember-color);
        border-radius: 50%;
        filter: blur(0.5px);
        opacity: 0;
        pointer-events: none;
        /* Start at center of button (where pip lives) */
        top: 50%;
        left: 50%;
        margin-top: -1.5px;
        margin-left: -1.5px;
      }

      /* One-shot ember burst when page loads - visual handoff from loading screen */
      .back-to-top.ember-release .pip-ember {
        animation: emberRelease 2.5s ease-out forwards;
      }

      /* Ember Release - upward float matching loading screen's smoke aesthetic */
      @keyframes emberRelease {
        0% {
          opacity: 0;
          transform: translate(0, 0) scale(0.5);
        }
        10% {
          opacity: 0.9;  /* Quick fade in */
          transform: translate(calc(var(--drift-x) * 0.3), -5px) scale(1);
        }
        40% {
          opacity: 0.7;  /* Stay visible longer */
          transform: translate(var(--drift-x), -18px) scale(0.8);
        }
        100% {
          opacity: 0;
          transform: translate(calc(var(--drift-x) * 1.5), -40px) scale(0.3);
          filter: blur(2px);
        }
      }

      /* Each ember has unique upward drift path - like sparks from a struck match */
      .pip-ember:nth-child(2) { --drift-x: 6px;  animation-delay: 0s; }
      .pip-ember:nth-child(3) { --drift-x: -5px; animation-delay: 0.12s; }
      .pip-ember:nth-child(4) { --drift-x: -8px; animation-delay: 0.24s; }
      .pip-ember:nth-child(5) { --drift-x: 4px;  animation-delay: 0.36s; }
      .pip-ember:nth-child(6) { --drift-x: 10px; animation-delay: 0.48s; }

      /* Ember size variations - some brighter, some fainter */
      .pip-ember--bright {
        width: 3.5px;
        height: 3.5px;
        filter: blur(0.3px);
      }
      .pip-ember--faint {
        width: 2.5px;
        height: 2.5px;
        filter: blur(1px);
      }

      /* Embers are one-shot, so no hover pause needed - they'll have finished by the time user interacts */

      .back-to-top:hover .back-to-top__pip,
      .back-to-top:focus .back-to-top__pip {
        transform: scale(1.15);
      }

      /* Hover locks bloom to full */
      .back-to-top:hover .back-to-top__pip::after,
      .back-to-top:focus .back-to-top__pip::after {
        animation: none;
        opacity: 1;
      }

      .back-to-top:active .back-to-top__pip {
        transform: scale(0.9);
      }

      /* Mobile adjustments */
      @media (max-width: 768px) {
        .back-to-top {
          top: 16px;
          left: 16px;
          width: 44px;
          height: 44px;
        }

        .back-to-top__pip {
          width: 12px;
          height: 12px;
        }

        .back-to-top__pip::after {
          box-shadow:
            0 0 10px var(--glow-warm),
            0 0 20px rgba(212, 165, 116, 0.5),
            0 0 32px var(--glow-deep);
        }

        /* Scaled drift for smaller pip */
        .pip-ember:nth-child(2) { --drift-x: 4px; }
        .pip-ember:nth-child(3) { --drift-x: -3px; }
        .pip-ember:nth-child(4) { --drift-x: -5px; }
        .pip-ember:nth-child(5) { --drift-x: 3px; }
        .pip-ember:nth-child(6) { --drift-x: 7px; }
      }

      /* Chat button wrapper for tooltip positioning */
      .mesa-ticker__chat-wrap {
        position: relative;
        display: flex;
        align-items: center;
      }

      /* Chat Tooltip - subtle guide above domino button */
      .chat-tooltip {
        position: absolute;
        bottom: 100%;
        right: 0;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
        background: rgba(28, 19, 15, 0.95);
        border: 1px solid rgba(183, 106, 59, 0.5);
        border-radius: 16px;
        padding: 6px 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transform: translateY(4px);
        transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        pointer-events: none;
      }

      .chat-tooltip.is-visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .chat-tooltip__text {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 11px;
        font-weight: 500;
        color: #d4a574;
        letter-spacing: 0.02em;
      }

      /* Subtle breathing animation when visible - per Tobias: "felt, not coached" */
      .chat-tooltip.is-visible {
        animation: chatTooltipBreath 3s ease-in-out infinite;
      }

      @keyframes chatTooltipBreath {
        0%, 100% { opacity: 0.85; }
        50% { opacity: 1; }
      }

      /* Floating Music Toggle */
      .music-toggle {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(28, 19, 15, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(183, 106, 59, 0.4);
        border-radius: 50px;
        padding: 12px 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 13px;
        color: #d4a574;
      }

      .music-toggle:hover {
        background: rgba(28, 19, 15, 1);
        border-color: rgba(183, 106, 59, 0.7);
        transform: scale(1.02);
      }

      .music-toggle:active,
      .music-toggle:focus {
        transform: scale(0.95);
        background: rgba(28, 19, 15, 1);
      }

      /* Hide music toggle on mobile */
      @media (max-width: 768px) {
        .music-toggle {
          display: none !important;
        }
      }

      .music-toggle__icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .music-toggle__label {
        white-space: nowrap;
      }

      /* Playing state */
      .music-toggle.is-playing {
        border-color: #b76a3b;
        box-shadow: 0 0 20px rgba(183, 106, 59, 0.3);
      }

      .music-toggle.is-playing .music-toggle__icon {
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Sound wave bars animation */
      .sound-bars {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 16px;
      }

      .sound-bars span {
        display: block;
        width: 3px;
        background: #d4a574;
        border-radius: 2px;
        animation: soundBar 0.8s ease-in-out infinite;
      }

      .sound-bars span:nth-child(1) { height: 40%; animation-delay: 0s; }
      .sound-bars span:nth-child(2) { height: 70%; animation-delay: 0.15s; }
      .sound-bars span:nth-child(3) { height: 50%; animation-delay: 0.3s; }
      .sound-bars span:nth-child(4) { height: 80%; animation-delay: 0.45s; }

      @keyframes soundBar {
        0%, 100% { transform: scaleY(1); }
        50% { transform: scaleY(0.5); }
      }

      .music-toggle:not(.is-playing) .sound-bars span {
        animation: none;
        height: 30%;
      }

      /* Collapse label after first tap */
      .music-toggle.collapsed {
        padding: 12px;
      }

      .music-toggle.collapsed .music-toggle__label {
        display: none;
      }

      @media (max-width: 768px) {
        .music-toggle {
          top: 16px;
          right: 16px;
          padding: 10px 14px;
          font-size: 12px;
          transition: opacity 0.3s ease, transform 0.3s ease;
        }

      }

      /* @Mention highlighting in chat */
      .mention {
        color: var(--brass);
        font-weight: 600;
        background: rgba(212, 165, 116, 0.1);
        padding: 1px 4px;
        border-radius: 2px;
      }

      /* ========================================
         BRAND FOOTER — Film Credits Style
         ======================================== */
      .brand-footer {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        width: 100%;
        gap: 14px;
        margin-top: 48px;
        margin-bottom: 60px; /* Push above fixed ticker */
      }

      .brand-footer__wordmark {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .brand-footer__logo {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: 2rem;
        font-weight: 900;
        font-style: italic;
        letter-spacing: 0.08em;
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .brand-footer__line {
        width: 50px;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--brass), transparent);
      }

      .brand-footer__text {
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.7rem;
        font-weight: 500;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.3);
      }

      .brand-footer__tagline {
        font-family: "Bodoni Moda", "Didot", serif;
        font-style: italic;
        font-size: 0.95rem;
        color: rgba(212, 165, 116, 0.6);
        letter-spacing: 0.08em;
      }

      @media (max-width: 640px) {
        .brand-footer {
          margin-top: 40px;
          margin-bottom: 50px; /* Ticker clearance on mobile */
        }
        .brand-footer__logo {
          font-size: 1.8rem;
        }
        .brand-footer__line {
          width: 44px;
        }
      }

      /* ===========================================
         COLOR FLASH FIX TESTS - Toggle via body class
         Usage: Add class to <body> to test each fix
         Issue: Green/red flash during "Your abuelo sat here" animation
         Root cause: Chromatic aberration + blur transition interaction
         =========================================== */

      /* OPTION D: GPU Layer Isolation (preserves blur effect) */
      body.test-fix-d .build-word--primary {
        will-change: filter, opacity, transform;
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }

      /* OPTION A: Disable Screen Blend Globally (loses lens effect) */
      body.test-fix-a .chromatic-aberration {
        mix-blend-mode: normal;
        opacity: 0.18;
      }

      /* OPTION C: Remove Blur from Animation (loses memory effect) */
      body.test-fix-c .build-word--primary {
        animation-name: ancestorDescendNoBlur !important;
      }

      @keyframes ancestorDescendNoBlur {
        0% {
          opacity: 0;
          transform: translateY(-40px) scale(1.02);
          text-shadow:
            0 0 20px rgba(255, 255, 255, 0),
            0 0 40px rgba(212, 165, 116, 0),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
        50% {
          opacity: 0.85;
          transform: translateY(-5px) scale(1.0);
          text-shadow:
            0 0 25px rgba(255, 255, 255, 0.25),
            0 0 50px rgba(212, 165, 116, 0.4),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
        70% {
          opacity: 1;
          transform: translateY(0) scale(1.0);
          text-shadow:
            0 0 30px rgba(255, 255, 255, 0.35),
            0 0 60px rgba(212, 165, 116, 0.5),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
        85% {
          opacity: 1;
          transform: translateY(0) scale(1.0);
          text-shadow:
            0 0 50px rgba(255, 255, 255, 0.5),
            0 0 80px rgba(212, 165, 116, 0.8),
            0 0 120px rgba(212, 165, 116, 0.5),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1.0);
          text-shadow:
            0 0 35px rgba(255, 255, 255, 0.4),
            0 0 65px rgba(212, 165, 116, 0.65),
            0 0 100px rgba(212, 165, 116, 0.4),
            0 4px 30px rgba(0, 0, 0, 0.8);
        }
      }

      /* ===== REDUCED MOTION - Accessibility ===== */
      /* Disable all particle animations for users who prefer reduced motion */
      @media (prefers-reduced-motion: reduce) {
        .greeting-ember,
        .greeting-mote,
        .lineage-dust,
        .mesa-ember,
        .mesa-ember--pulse {
          animation: none !important;
          opacity: 0 !important;
        }
        .panel--whisper.in-view .whisper-greeting,
        .panel--build.in-view .build-family__line--generations,
        .panel--slam.in-view .slam-slogan {
          animation: none !important;
        }
      }
    </style>
  </head>
  <body class="is-loading">
    <script>
      // Supabase sometimes falls back to redirecting magic links to the site root (e.g. `/#access_token=...`).
      // If that happens, forward the auth payload to `/mesa/callback` so the session can be established.
      (function () {
        try {
          const hash = window.location.hash || '';
          const search = window.location.search || '';

          const isSupabaseAuthHash =
            /(^#|&)access_token=/.test(hash)
            || /(^#|&)refresh_token=/.test(hash)
            || /(^#|&)error=/.test(hash)
            || /(^#|&)error_code=/.test(hash);

          const isSupabaseAuthCode = /(^\\?|&)code=/.test(search);

          if (isSupabaseAuthHash || isSupabaseAuthCode) {
            const target = `/mesa/callback${search}${hash}`;
            window.location.replace(target);
          }
        } catch {
          // no-op
        }
      })();
    </script>
    <!-- Loading Screen - "The Ritual Before The Game" -->
    <div class="loading-screen" id="loadingScreen">
      <!-- Atmospheric fog - breathing warmth -->
      <div class="fog-container">
        <div class="fog-layer--ambient"></div>
      </div>

      <!-- Ember particles - like cigar smoke drifting upward -->
      <div class="ember-container">
        <div class="ember ember--lg"></div>
        <div class="ember"></div>
        <div class="ember ember--sm"></div>
        <div class="ember"></div>
        <div class="ember ember--lg"></div>
        <div class="ember ember--sm"></div>
        <div class="ember"></div>
        <div class="ember ember--sm"></div>
        <div class="ember ember--lg"></div>
        <div class="ember"></div>
        <div class="ember ember--sm"></div>
        <div class="ember"></div>
      </div>

      <!-- The CDL Tile - sacred geometry -->
      <div class="cdl-tile">
        <div class="cdl-tile__glow"></div>
        <div class="cdl-tile__upper">
          <span class="cdl-tile__letter cdl-tile__letter--c">C</span>
          <span class="cdl-tile__letter cdl-tile__letter--d">D</span>
        </div>
        <div class="cdl-tile__divider"></div>
        <div class="cdl-tile__lower">
          <span class="cdl-tile__letter cdl-tile__letter--l">L</span>
        </div>
      </div>
    </div>

	    <div class="story">
	      <div class="story-overlays" aria-hidden="true">
	        <div class="vignette-overlay"></div>
	        <div class="chromatic-aberration"></div>
	      </div>
	      <main>
      <!-- Panel 1: Brand Introduction -->
      <section class="panel panel--hero" id="heroPanel">
        <div class="panel-bg panel-bg--hero" style="background-image: url('/FRAMES/frame-hero.webp')"></div>
        <div class="panel-overlay"></div>
        <div class="panel-content">
          <!-- CDL 1 Domino Badge - Bone Language -->
          <div class="hero-badge">
            <span class="hero-badge__top">CDL</span>
            <div class="hero-badge__divider"></div>
            <span class="hero-badge__bottom">1</span>
          </div>

          <!-- THE HERO - Tournament Name -->
          <h1 class="event-title">
            <span class="event-numeral event-numeral--salida">
              <span class="salida-line">LA</span>
              <span class="salida-line salida-line--main">SALIDA</span>
            </span>
          </h1>

          <!-- Championship stamp -->
          <p class="hero-tagline">The First Cuban Domino League Championship</p>

          <!-- Date/Venue -->
	          <p class="hero-subtitle">{EVENT.dateLong}<span class="dot">•</span><a href={EVENT.venueMapUrl} target="_blank" rel="noreferrer">{EVENT.venueName}</a></p>
        </div>
        <div class="hero-scroll-hint" id="heroScrollHint" aria-hidden="true">
          <div class="hero-scroll-hint__chevron"></div>
        </div>
      </section>

      <!-- Panel 2: The Cinematic Frame -->
      <section class="panel panel--whisper" id="panelWhisper">
        <div class="panel-bg" style="background-image: url('/FRAMES/frame-2.webp')"></div>
        <div class="fog-layer"></div>
        <div class="panel-overlay"></div>

        <!-- TOP LETTERBOX - 3-beat reveal: Setup → Greeting → Recognition -->
        <div class="whisper-top">
          <p class="whisper-setup">This table remembers.</p>
          <div class="whisper-greeting-wrap">
            <p class="whisper-greeting">Que bola asere</p>
            <span class="greeting-ember greeting-ember--sm greeting-ember--cool"></span>
            <span class="greeting-ember greeting-ember--md"></span>
            <span class="greeting-ember greeting-ember--lg greeting-ember--hot"></span>
            <span class="greeting-ember greeting-ember--sm greeting-ember--spark"></span>
            <span class="greeting-ember greeting-ember--md greeting-ember--hot"></span>
            <span class="greeting-ember greeting-ember--sm greeting-ember--cool"></span>
            <span class="greeting-ember greeting-ember--lg"></span>
            <span class="greeting-ember greeting-ember--md greeting-ember--spark"></span>
            <span class="greeting-ember greeting-ember--sm greeting-ember--hot"></span>
            <span class="greeting-ember greeting-ember--md"></span>
            <!-- Micro-motes for atmospheric depth -->
            <span class="greeting-mote"></span>
            <span class="greeting-mote"></span>
            <span class="greeting-mote"></span>
          </div>
        </div>

        <!-- BOTTOM LETTERBOX - The recognition -->
        <div class="whisper-bottom">
          <p class="whisper-line whisper-line--ancestors">You've sat here before.</p>
          <!-- Scroll hint - appears after narrative -->
          <div class="whisper-scroll-hint">
            <div class="whisper-scroll-hint__chevron"></div>
          </div>
        </div>

        <div class="smoke-layer"></div>
      </section>

      <!-- Panel 3: The Revelation - Cinematic Climax -->
	      <section class="panel panel--build" id="panelBuild">
	        <div class="panel-bg" style="background-image: url('/FRAMES/frame-3.webp')"></div>
	        <div class="fog-layer"></div>
	        <div class="panel-overlay"></div>

        <!-- TOP LETTERBOX - Empty, let INHERITED command the space -->
        <div class="build-top"></div>

        <!-- CENTER - The heritage moment -->
        <div class="build-center">
          <div class="build-revelation">
	            <span class="build-word build-word--primary" data-text="Your abuelo sat here.">Your abuelo sat here.</span>
            <div class="build-family">
              <div class="lineage-dust-wrap">
                <span class="build-family__line build-family__line--generations">Your tío. Your father.</span>
                <span class="lineage-dust lineage-dust--sm lineage-dust--sepia"></span>
                <span class="lineage-dust lineage-dust--md"></span>
                <span class="lineage-dust lineage-dust--lg lineage-dust--sepia"></span>
                <span class="lineage-dust lineage-dust--sm"></span>
                <span class="lineage-dust lineage-dust--md lineage-dust--sepia"></span>
                <span class="lineage-dust lineage-dust--sm"></span>
                <span class="lineage-dust lineage-dust--lg"></span>
                <span class="lineage-dust lineage-dust--md lineage-dust--sepia"></span>
                <span class="lineage-dust lineage-dust--sm"></span>
                <span class="lineage-dust lineage-dust--md"></span>
              </div>
            </div>
            <div class="build-lifecycle">
              <span class="build-lifecycle__line">Every Sunday. Every celebration.</span>
              <span class="build-lifecycle__closer">Every goodbye.</span>
            </div>
          </div>
        </div>

        <!-- BOTTOM LETTERBOX - Torch pass as signature + scroll hint -->
        <div class="build-bottom">
          <span class="build-word build-word--torch">Te toca.</span>
          <div class="build-scroll-hint">
            <div class="build-scroll-hint__chevron"></div>
          </div>
        </div>

        <div class="smoke-layer"></div>
      </section>

      <!-- Panel 4: The Hype Card - "TAKE YOUR SEAT" -->
      <section class="panel panel--slam" id="panelSlam">
        <div class="panel-bg" style="background-image: url('/FRAMES/frame-4.webp')"></div>
        <div class="fog-layer"></div>
        <div class="panel-overlay"></div>

        <!-- TOP LETTERBOX - Event context sets the stage -->
        <div class="slam-top">
          <p class="slam-context">{EVENT.dateMonthDay}<span class="dot">•</span>{EVENT.venueName}</p>
        </div>

        <!-- CENTER - The call to action -->
        <div class="slam-center">
          <!-- CDL 1 Badge - Domino tile as championship marker -->
          <div class="slam-badge">
            <span class="slam-badge__top">CDL</span>
            <div class="slam-badge__divider"></div>
            <span class="slam-badge__bottom">1</span>
          </div>

          <div class="slam-container">
            <span class="slam-word slam-word--winner">Claim</span>
            <span class="slam-word slam-word--takes">Your</span>
            <span class="slam-word slam-word--all">SEAT</span>
          </div>
          <div class="slam-slogan-wrap">
            <p class="slam-slogan">La mesa te espera.</p>
            <span class="mesa-ember mesa-ember--sm mesa-ember--cool"></span>
            <span class="mesa-ember mesa-ember--md"></span>
            <span class="mesa-ember mesa-ember--lg mesa-ember--hot"></span>
            <span class="mesa-ember mesa-ember--sm"></span>
            <span class="mesa-ember mesa-ember--md mesa-ember--hot"></span>
            <span class="mesa-ember mesa-ember--sm mesa-ember--cool"></span>
            <span class="mesa-ember mesa-ember--lg"></span>
            <span class="mesa-ember mesa-ember--md mesa-ember--cool"></span>
            <span class="mesa-ember mesa-ember--sm mesa-ember--hot"></span>
            <span class="mesa-ember mesa-ember--md"></span>
            <!-- Pulse particle - heartbeat at center -->
            <span class="mesa-ember mesa-ember--pulse"></span>
          </div>
        </div>

        <!-- BOTTOM LETTERBOX - Scroll hint only -->
        <div class="slam-bottom">
          <div class="slam-scroll-hint" aria-hidden="true">
            <div class="slam-scroll-hint__chevron"></div>
          </div>
        </div>
      </section>

	      <!-- Panel 5: Rules - "La Ley" - THE LAW (Unified Plaque) -->
	      <section class="panel panel--rules" id="panelRules">
	        <div class="panel-bg" style="background-image: url('/FRAMES/rules-nyc-test.png')"></div>
	        <div class="fog-layer"></div>
	        <div class="panel-overlay"></div>

	        <div class="rules-plaque">
	          <!-- Header - tightly coupled -->
	          <div class="rules-header">
	            <div class="hero-badge hero-badge--rules" aria-hidden="true">
	              <span class="hero-badge__top">CDL</span>
	              <div class="hero-badge__divider"></div>
	              <span class="hero-badge__bottom">1</span>
	            </div>
	            <h2 class="rules-header__title">
	              <span class="rules-title__line">LA</span>
	              <span class="rules-title__line rules-title__line--ley">LEY</span>
	            </h2>
	            <p class="rules-header__subtitle">The Law of the Table</p>
	          </div>

          <!-- The Law carved in brass -->
          <div class="rules-grid">
            <!-- Primary Rules - The essentials -->
            <div class="rule-card rule-card--primary">
              <p class="rule-card__title">Race to 150</p>
              <p class="rule-card__desc">First team to 150 points wins</p>
            </div>

            <div class="rule-card rule-card--primary">
              <p class="rule-card__title">The Buy-In</p>
              <p class="rule-card__desc">$25 Cash on arrival</p>
            </div>

            <!-- Secondary Rules -->
            <div class="rule-card">
              <p class="rule-card__title">5 Doubles? Dead Hand</p>
              <p class="rule-card__desc">Reshuffle if you draw 5+</p>
            </div>

            <div class="rule-card">
              <p class="rule-card__title">Tie Breaker</p>
              <p class="rule-card__desc">The opener loses the turn</p>
            </div>

            <div class="rule-card">
              <p class="rule-card__title">The Roster</p>
              <p class="rule-card__desc">16 Players. 8 Teams.</p>
            </div>

            <div class="rule-card">
              <p class="rule-card__title">The Lineup</p>
              <p class="rule-card__desc">Team up in La Mesa</p>
            </div>
          </div>

          <!-- Footer - tightly coupled -->
          <div class="rules-footer-section">
            <div class="rules-divider">
              <span class="rules-divider__domino">🁣</span>
            </div>
            <p class="rules-footer">Respeta la mesa.</p>
            <div class="rules-scroll-hint" aria-hidden="true">
              <div class="rules-scroll-hint__chevron"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Panel 6: Registration Form - "The Final Hand" -->
      <section class="panel panel--form">
        <div class="panel-bg-gradient"></div>
          <div class="panel-content">
          <!-- Progress Tracker (Desktop) -->
          <div class="progress-tracker">
            <div class="progress-header">
              <span class="progress-count"><span class="number" id="playerCount">0</span> Seats Taken</span>
              <span class="progress-spots" id="spotsLeft">{PLAYERS_GOAL - PLAYERS_REGISTERED} seats left</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
          </div>

          <!-- Registration Form -->
          <div class="form-shell" id="formShell">
            <!-- Scarcity Counter -->
            <div class="form-scarcity" id="formScarcity">
              <div class="form-scarcity__display">
                <span class="form-scarcity__number" id="spotsLeftInline">{PLAYERS_GOAL - PLAYERS_REGISTERED}</span>
                <span class="form-scarcity__number form-scarcity__number--next" id="spotsLeftInlineNext" aria-hidden="true"></span>
              </div>
              <span class="form-scarcity__label">SEATS LEFT</span>
            </div>

<form id="signup" novalidate>
              <input
                type="text"
                name="company"
                autocomplete="off"
                tabindex="-1"
                aria-hidden="true"
                class="honeypot"
              />

              <!-- Hidden field - rules accepted by submitting -->
              <input type="hidden" name="ruleConfirm" value="true" />

              <!-- Full Name - PRIMARY input, WHO YOU ARE -->
              <div class="form-section form-section--primary">
                <label class="label--primary">
                  <span class="label-main">Full Name</span>
                  <span class="label-sub">As it'll be remembered</span>
                  <div class="input-wrapper">
                    <input name="playerName" required placeholder="Desi Arnaz" />
                  </div>
                </label>
              </div>

              <!-- Contact Details - Secondary -->
              <div class="form-section form-section--secondary">
                <label>
                  Email
                  <div class="input-wrapper">
                    <input name="email" type="email" required placeholder="desi@havana.club" />
                  </div>
                </label>

                <label>
                  Phone
                  <div class="input-wrapper">
                    <input name="phone" type="tel" required placeholder="(305) 555-1952" />
                  </div>
                </label>
              </div>

              <label class="label--optional">
                Notes <span class="label-hint">(optional)</span>
                <div class="input-wrapper">
                  <textarea name="notes" placeholder="Special requests? Team up in La Mesa after you register!"></textarea>
                </div>
              </label>

              <!-- Terms - Trash Talk Agreement -->
              <div class="form-terms">
                <label class="terms-checkbox">
                  <input type="checkbox" name="termsAccepted" required />
                  <span class="terms-checkbox__box"></span>
                  <span class="terms-checkbox__text">
                    I accept that <em>Aquí se habla mierda. El que no aguanta, no juega.</em>
                  </span>
                </label>
              </div>

              <div class="form-cta">
                <button type="submit" id="submitBtn">Claim Your Seat</button>
                <p class="form-cta__hint">Your information stays at the table.</p>
              </div>
              <!-- Mobile scarcity - larger pulsing badge -->
              <div class="button-scarcity">
                <div class="button-scarcity__inner">
                  <span class="button-scarcity__pulse"></span>
                  <span class="button-scarcity__text"><span id="spotsLeftButton">{PLAYERS_GOAL - PLAYERS_REGISTERED}</span> SEATS REMAIN</span>
                </div>
              </div>
	              <p class="status" id="status" aria-live="polite"></p>
	            </form>
	          </div>
	        </div>
	      </section>

      <!-- Panel 7: Exit - "The Room Reveals" -->
      <section class="panel panel--exit">
        <div class="panel-bg panel-bg--exit" style="background-image: url('/FRAMES/frame-footer.webp')"></div>
        <div class="panel-overlay panel-overlay--exit"></div>
        <div class="exit-content">
          <div class="footer-contact">
            <div class="footer-contact__item">
              <span class="footer-contact__label">Direct Line</span>
              <a href="mailto:Erik@CubanDominoLeague.com" class="footer-contact__link">Erik@CubanDominoLeague.com</a>
            </div>
            <div class="footer-contact__divider"></div>
            <div class="footer-contact__item">
              <span class="footer-contact__label">Venue</span>
              <a href={EVENT.venueMapUrl} target="_blank" rel="noreferrer" class="footer-contact__link">{EVENT.venueName}</a>
            </div>
          </div>
          <footer class="brand-footer">
            <div class="brand-footer__wordmark">
              <span class="brand-footer__logo">CDL</span>
              <span class="brand-footer__line"></span>
            </div>
            <span class="brand-footer__text">© 2026 Cuban Domino League</span>
          </footer>
        </div>
      </section>
	    </main>
	    </div>

    <!-- Success Overlay (outside scroll container for position:fixed to work reliably on iOS Safari) -->
    <div class="success" id="success">
      <!-- Domino Hero Element -->
      <div class="domino-container">
        <span class="shimmer"></span>
        <span class="shimmer"></span>
        <span class="shimmer"></span>
        <span class="shimmer"></span>
        <span class="shimmer"></span>

        <div class="domino">
          <div class="domino-top">
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
          </div>
          <div class="domino-bottom">
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
          </div>
        </div>
      </div>

      <!-- Headlines -->
      <h2 class="success-headline">You're <span>In</span></h2>
      <p class="success-subheadline">Your Table Key is in your email</p>

      <!-- Event Details -->
      <div class="event-details">
        <div class="event-date">{EVENT.dateLong}</div>
        <div class="event-venue">{EVENT.venueName}</div>
        <div class="event-time">{EVENT.doorsOpenLabel}</div>
        <div class="event-payment">$25 cash on arrival</div>
      </div>

      <!-- Tagline -->
      <div class="success-divider">
        <span class="divider-pip"></span>
      </div>
      <p class="success-tagline">"La mesa te espera."</p>

      <!-- La Mesa CTA -->
      <button class="success-mesa-cta" id="successMesaCta">
        Claim Your Seat →
      </button>

      <!-- Email reminder -->
      <p class="email-reminder">
        Questions? <a href="mailto:Erik@cubandominoleague.com">Erik@cubandominoleague.com</a>
      </p>
    </div>

    <!-- Registration Waiting State - "The Domino Stands" -->
    <div class="registration-waiting" id="registrationWaiting">
      <div class="waiting-domino-container">
        <div class="waiting-domino">
          <div class="waiting-domino-top">
            <!-- Row 1 -->
            <span class="pip"></span>
            <span class="pip"></span>
            <!-- Row 2 -->
            <span class="pip"></span>
            <span class="pip"></span>
            <!-- Row 3 -->
            <span class="pip"></span>
            <span class="pip"></span>
          </div>
          <div class="waiting-domino-divider"></div>
          <div class="waiting-domino-bottom">
            <!-- Row 1 -->
            <span class="pip"></span>
            <span class="pip"></span>
            <!-- Row 2 -->
            <span class="pip"></span>
            <span class="pip"></span>
            <!-- Row 3 -->
            <span class="pip"></span>
            <span class="pip"></span>
          </div>
        </div>
        <div class="waiting-glow"></div>
        <div class="waiting-warm-wash"></div>
      </div>
      <p class="waiting-text">Securing your seat...</p>
    </div>

    <!-- La Mesa Tutorial Panel (shows if user dismisses success without joining) -->
    <div class="mesa-tutorial" id="mesaTutorial">
      <div class="mesa-tutorial__content">
        <div class="mesa-tutorial__header">
          <span class="mesa-tutorial__icon"></span>
          <h3 class="mesa-tutorial__title">La Mesa</h3>
        </div>
        <p class="mesa-tutorial__desc">The player's table. Chat with fellow competitors before the big day.</p>
        <div class="mesa-tutorial__actions">
          <button class="mesa-tutorial__cta" id="tutorialMesaCta">Join the Table →</button>
          <button class="mesa-tutorial__dismiss" id="tutorialDismiss">Maybe Later</button>
        </div>
      </div>
    </div>

    <!-- Back to Top - Domino Pip (with ember particles from loading screen's soul) -->
    <button class="back-to-top" id="backToTop" aria-label="Back to top">
      <span class="back-to-top__pip">
        <span class="pip-flare"></span>
      </span>
      <!-- Micro-embers - wisps of the cigar lounge following the pip -->
      <span class="pip-ember pip-ember--bright"></span>
      <span class="pip-ember"></span>
      <span class="pip-ember pip-ember--faint"></span>
      <span class="pip-ember pip-ember--bright"></span>
      <span class="pip-ember pip-ember--faint"></span>
    </button>

    <!-- Music Toggle Button -->
    <button class="music-toggle" id="musicToggle" aria-label="Toggle background music">
      <span class="music-toggle__icon">
        <span class="sound-bars">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </span>
      </span>
      <span class="music-toggle__label">Tap for music</span>
    </button>

    <!-- Background Audio (desktop only) -->
    <audio id="bgMusic" loop preload="none">
      <source src="/AUDIO/background-music.mp3" type="audio/mpeg">
    </audio>

    <!-- Chat Widget - The Sacred Table -->
    <div class="chat-widget" id="chatWidget">
      <!-- Mesa Ticker: ESPN-style activity feed -->
      <div class="mesa-ticker" id="mesaTicker">
        <div class="mesa-ticker__badge">
          <span class="mesa-ticker__badge-dot"></span>
          <span class="mesa-ticker__badge-text">LAMESA</span>
        </div>
        <div class="mesa-ticker__scroll">
          <div class="mesa-ticker__track" id="tickerTrack">
            <!-- Populated by JS - duplicated for seamless loop -->
          </div>
        </div>
        <div class="mesa-ticker__chat-wrap">
          <!-- Tooltip above chat button -->
          <span class="chat-tooltip" id="chatTooltip">
            <span class="chat-tooltip__text">Chat here</span>
          </span>
          <button class="mesa-ticker__chat-btn" id="tickerChatBtn" type="button" aria-label="Open La Mesa">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5">
              <rect x="6" y="2" width="12" height="20" rx="2" ry="2"/>
              <line x1="6" y1="12" x2="18" y2="12"/>
            </svg>
            <span class="mesa-ticker__chat-badge" id="chatBadge" style="display: none;">0</span>
          </button>
        </div>
      </div>

        <div class="chat-panel" id="chatPanel">
        <!-- Header as direct child of chat-panel for proper flex layout -->
        <div class="chat-header" id="chatHeader">
          <div class="chat-header__drag-handle"></div>
          <div class="chat-header__title-group">
            <span class="chat-header__title">La Mesa</span>
            <button class="chat-header__status" id="mesaPresenceBtn" type="button" aria-label="Who's at the table">
              <span class="chat-header__status-dot" aria-hidden="true"></span>
              <span class="chat-header__status-text" id="mesaHeaderStatusText">Who's here</span>
            </button>
          </div>
          <button class="chat-header__dock" id="chatDock" type="button" aria-label="Dock La Mesa (second screen)" aria-pressed="false">
            <span class="chat-header__dock-label">Dock</span>
          </button>
          <button class="chat-header__close" id="chatClose" type="button" aria-label="Leave table">
            <span class="chat-header__close-label">Leave Table</span>
          </button>
        </div>
        
        <div class="chat-main">
          <!-- Seat strip: people-first, not channel-first -->
          <div class="mesa-seats" id="mesaSeatStrip">
            <span class="mesa-seats__label">Seats</span>
            <div class="mesa-seats__row" id="mesaSeatRow"></div>
            <button class="mesa-seats__more" id="mesaSeatMore" type="button" aria-label="View who's here">+0</button>
          </div>

	        <!-- La Mesa Entry Ritual (covers identity → chat transition) -->
	        <div class="mesa-entry" id="mesaEntry" aria-hidden="true">
	          <div class="mesa-entry__fog" aria-hidden="true"></div>
	          <div class="mesa-entry__grain" aria-hidden="true"></div>
	          <div class="mesa-entry__vignette" aria-hidden="true"></div>
	          <div class="mesa-entry__content" aria-hidden="true">
	            <div class="mesa-entry__seal" aria-hidden="true"></div>
	            <img class="mesa-entry__flag" id="mesaEntryFlag" alt="" width="84" height="84" decoding="async" loading="eager" />
	            <div class="mesa-entry__text" aria-hidden="true">
	              <div class="mesa-entry__kicker" id="mesaEntryKicker">Pulling up a chair</div>
	              <div class="mesa-entry__name" id="mesaEntryName"></div>
	            </div>
	          </div>
	        </div>
	
          <div class="chat-content">
	        <!-- Identity selection -->
		        <div class="chat-identity" id="chatIdentity">
		          <p class="chat-identity__title">Claim Your Seat</p>

            <!-- Auth gate: La Mesa is login-required -->
		            <div class="mesa-auth" id="mesaAuthGate">
		              <p class="mesa-auth__copy">
		                Your Table Key is in your email.
		                <span class="mesa-auth__subcopy">Open it to enter La Mesa. Then plant your flag.</span>
		              </p>
		              <button class="mesa-auth__reveal" id="mesaLoginReveal" type="button" aria-expanded="false">Resend Table Key</button>
			              <div class="mesa-auth__row" id="mesaLoginRow" hidden style="display:none;">
	                <input
	                  class="mesa-auth__input"
	                  id="mesaLoginEmail"
	                  type="email"
                  inputmode="email"
                  autocomplete="email"
                  placeholder="you@domain.com"
                />
	                <button class="mesa-auth__btn" id="mesaLoginBtn" type="button">Send Table Key</button>
	              </div>
	              <p class="mesa-auth__status" id="mesaLoginStatus"></p>
	            </div>

            <div class="mesa-auth mesa-auth--signed" id="mesaAuthSigned" style="display: none;">
              <p class="mesa-auth__copy">
                Signed in as <span class="mesa-auth__email" id="mesaAuthedEmail">—</span>
              </p>
              <button class="mesa-auth__signout" id="mesaSignOutBtn" type="button">Sign out</button>
            </div>

          <!-- Live player count for FOMO -->
          <div class="mesa-live-indicator" id="mesaLiveIndicator">
            <span class="mesa-live-dot"></span>
            <span class="mesa-live-text"><span id="mesaPlayerCount">0</span> active today</span>
          </div>

		          <p class="chat-identity__subtitle" id="chatIdentitySubtitle" style="display:none;">Show them where you're from.</p>

	          <div class="avatar-selector-frame" id="mesaFlagPickerFrame" style="display:none;">
            <div class="avatar-selector">
	              <!-- Spacer for scroll centering -->
	              <div class="avatar-selector__spacer" aria-hidden="true"></div>
              <!-- 1. PRIORITY: Cuba & USA -->
              <div class="avatar-option selected" data-avatar="cuba" title="Cuba">
                <img class="avatar-flag-img" src="https://flagcdn.com/cu.svg" alt="Cuba" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="usa" title="USA">
                <img class="avatar-flag-img" src="https://flagcdn.com/us.svg" alt="USA" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <!-- 2. CARIBBEAN -->
              <div class="avatar-option" data-avatar="puerto-rico" title="Puerto Rico">
                <img class="avatar-flag-img" src="https://flagcdn.com/pr.svg" alt="Puerto Rico" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="dominican-republic" title="Dominican Republic">
                <img class="avatar-flag-img" src="https://flagcdn.com/do.svg" alt="Dominican Republic" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="jamaica" title="Jamaica">
                <img class="avatar-flag-img" src="https://flagcdn.com/jm.svg" alt="Jamaica" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="haiti" title="Haiti">
                <img class="avatar-flag-img" src="https://flagcdn.com/ht.svg" alt="Haiti" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="trinidad-and-tobago" title="Trinidad and Tobago">
                <img class="avatar-flag-img" src="https://flagcdn.com/tt.svg" alt="Trinidad and Tobago" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="bahamas" title="Bahamas">
                <img class="avatar-flag-img" src="https://flagcdn.com/bs.svg" alt="Bahamas" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="barbados" title="Barbados">
                <img class="avatar-flag-img" src="https://flagcdn.com/bb.svg" alt="Barbados" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="saint-lucia" title="Saint Lucia">
                <img class="avatar-flag-img" src="https://flagcdn.com/lc.svg" alt="Saint Lucia" width="32" height="32" decoding="async" loading="eager" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="grenada" title="Grenada">
                <img class="avatar-flag-img" src="https://flagcdn.com/gd.svg" alt="Grenada" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="saint-vincent" title="Saint Vincent and the Grenadines">
                <img class="avatar-flag-img" src="https://flagcdn.com/vc.svg" alt="Saint Vincent and the Grenadines" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="antigua-and-barbuda" title="Antigua and Barbuda">
                <img class="avatar-flag-img" src="https://flagcdn.com/ag.svg" alt="Antigua and Barbuda" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="dominica" title="Dominica">
                <img class="avatar-flag-img" src="https://flagcdn.com/dm.svg" alt="Dominica" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="saint-kitts-and-nevis" title="Saint Kitts and Nevis">
                <img class="avatar-flag-img" src="https://flagcdn.com/kn.svg" alt="Saint Kitts and Nevis" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="curacao" title="Curaçao">
                <img class="avatar-flag-img" src="https://flagcdn.com/cw.svg" alt="Curaçao" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="aruba" title="Aruba">
                <img class="avatar-flag-img" src="https://flagcdn.com/aw.svg" alt="Aruba" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="us-virgin-islands" title="U.S. Virgin Islands">
                <img class="avatar-flag-img" src="https://flagcdn.com/vi.svg" alt="U.S. Virgin Islands" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="british-virgin-islands" title="British Virgin Islands">
                <img class="avatar-flag-img" src="https://flagcdn.com/vg.svg" alt="British Virgin Islands" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="cayman-islands" title="Cayman Islands">
                <img class="avatar-flag-img" src="https://flagcdn.com/ky.svg" alt="Cayman Islands" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="turks-and-caicos" title="Turks and Caicos Islands">
                <img class="avatar-flag-img" src="https://flagcdn.com/tc.svg" alt="Turks and Caicos Islands" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="bermuda" title="Bermuda">
                <img class="avatar-flag-img" src="https://flagcdn.com/bm.svg" alt="Bermuda" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="anguilla" title="Anguilla">
                <img class="avatar-flag-img" src="https://flagcdn.com/ai.svg" alt="Anguilla" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="montserrat" title="Montserrat">
                <img class="avatar-flag-img" src="https://flagcdn.com/ms.svg" alt="Montserrat" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="sint-maarten" title="Sint Maarten">
                <img class="avatar-flag-img" src="https://flagcdn.com/sx.svg" alt="Sint Maarten" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="guadeloupe" title="Guadeloupe">
                <img class="avatar-flag-img" src="https://flagcdn.com/gp.svg" alt="Guadeloupe" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="martinique" title="Martinique">
                <img class="avatar-flag-img" src="https://flagcdn.com/mq.svg" alt="Martinique" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="bonaire" title="Bonaire">
                <img class="avatar-flag-img" src="https://flagcdn.com/bq.svg" alt="Bonaire" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <!-- 3. CENTRAL AMERICA -->
              <div class="avatar-option" data-avatar="mexico" title="Mexico">
                <img class="avatar-flag-img" src="https://flagcdn.com/mx.svg" alt="Mexico" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="guatemala" title="Guatemala">
                <img class="avatar-flag-img" src="https://flagcdn.com/gt.svg" alt="Guatemala" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="belize" title="Belize">
                <img class="avatar-flag-img" src="https://flagcdn.com/bz.svg" alt="Belize" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="honduras" title="Honduras">
                <img class="avatar-flag-img" src="https://flagcdn.com/hn.svg" alt="Honduras" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="el-salvador" title="El Salvador">
                <img class="avatar-flag-img" src="https://flagcdn.com/sv.svg" alt="El Salvador" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="nicaragua" title="Nicaragua">
                <img class="avatar-flag-img" src="https://flagcdn.com/ni.svg" alt="Nicaragua" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="costa-rica" title="Costa Rica">
                <img class="avatar-flag-img" src="https://flagcdn.com/cr.svg" alt="Costa Rica" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="panama" title="Panama">
                <img class="avatar-flag-img" src="https://flagcdn.com/pa.svg" alt="Panama" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <!-- 4. SOUTH AMERICA -->
              <div class="avatar-option" data-avatar="venezuela" title="Venezuela">
                <img class="avatar-flag-img" src="https://flagcdn.com/ve.svg" alt="Venezuela" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="colombia" title="Colombia">
                <img class="avatar-flag-img" src="https://flagcdn.com/co.svg" alt="Colombia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="brazil" title="Brazil">
                <img class="avatar-flag-img" src="https://flagcdn.com/br.svg" alt="Brazil" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="argentina" title="Argentina">
                <img class="avatar-flag-img" src="https://flagcdn.com/ar.svg" alt="Argentina" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="peru" title="Peru">
                <img class="avatar-flag-img" src="https://flagcdn.com/pe.svg" alt="Peru" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="chile" title="Chile">
                <img class="avatar-flag-img" src="https://flagcdn.com/cl.svg" alt="Chile" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="ecuador" title="Ecuador">
                <img class="avatar-flag-img" src="https://flagcdn.com/ec.svg" alt="Ecuador" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="bolivia" title="Bolivia">
                <img class="avatar-flag-img" src="https://flagcdn.com/bo.svg" alt="Bolivia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="paraguay" title="Paraguay">
                <img class="avatar-flag-img" src="https://flagcdn.com/py.svg" alt="Paraguay" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="uruguay" title="Uruguay">
                <img class="avatar-flag-img" src="https://flagcdn.com/uy.svg" alt="Uruguay" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="guyana" title="Guyana">
                <img class="avatar-flag-img" src="https://flagcdn.com/gy.svg" alt="Guyana" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="suriname" title="Suriname">
                <img class="avatar-flag-img" src="https://flagcdn.com/sr.svg" alt="Suriname" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="french-guiana" title="French Guiana">
                <img class="avatar-flag-img" src="https://flagcdn.com/gf.svg" alt="French Guiana" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <!-- 5. NORTH AMERICA -->
              <div class="avatar-option" data-avatar="canada" title="Canada">
                <img class="avatar-flag-img" src="https://flagcdn.com/ca.svg" alt="Canada" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <!-- 6. EUROPE -->
              <div class="avatar-option" data-avatar="spain" title="Spain">
                <img class="avatar-flag-img" src="https://flagcdn.com/es.svg" alt="Spain" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="portugal" title="Portugal">
                <img class="avatar-flag-img" src="https://flagcdn.com/pt.svg" alt="Portugal" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="italy" title="Italy">
                <img class="avatar-flag-img" src="https://flagcdn.com/it.svg" alt="Italy" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="france" title="France">
                <img class="avatar-flag-img" src="https://flagcdn.com/fr.svg" alt="France" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="germany" title="Germany">
                <img class="avatar-flag-img" src="https://flagcdn.com/de.svg" alt="Germany" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="united-kingdom" title="United Kingdom">
                <img class="avatar-flag-img" src="https://flagcdn.com/gb.svg" alt="United Kingdom" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="ireland" title="Ireland">
                <img class="avatar-flag-img" src="https://flagcdn.com/ie.svg" alt="Ireland" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="netherlands" title="Netherlands">
                <img class="avatar-flag-img" src="https://flagcdn.com/nl.svg" alt="Netherlands" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="belgium" title="Belgium">
                <img class="avatar-flag-img" src="https://flagcdn.com/be.svg" alt="Belgium" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="switzerland" title="Switzerland">
                <img class="avatar-flag-img" src="https://flagcdn.com/ch.svg" alt="Switzerland" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="austria" title="Austria">
                <img class="avatar-flag-img" src="https://flagcdn.com/at.svg" alt="Austria" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="poland" title="Poland">
                <img class="avatar-flag-img" src="https://flagcdn.com/pl.svg" alt="Poland" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="czechia" title="Czechia">
                <img class="avatar-flag-img" src="https://flagcdn.com/cz.svg" alt="Czechia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="slovakia" title="Slovakia">
                <img class="avatar-flag-img" src="https://flagcdn.com/sk.svg" alt="Slovakia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="hungary" title="Hungary">
                <img class="avatar-flag-img" src="https://flagcdn.com/hu.svg" alt="Hungary" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="romania" title="Romania">
                <img class="avatar-flag-img" src="https://flagcdn.com/ro.svg" alt="Romania" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="bulgaria" title="Bulgaria">
                <img class="avatar-flag-img" src="https://flagcdn.com/bg.svg" alt="Bulgaria" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="greece" title="Greece">
                <img class="avatar-flag-img" src="https://flagcdn.com/gr.svg" alt="Greece" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="croatia" title="Croatia">
                <img class="avatar-flag-img" src="https://flagcdn.com/hr.svg" alt="Croatia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="slovenia" title="Slovenia">
                <img class="avatar-flag-img" src="https://flagcdn.com/si.svg" alt="Slovenia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="serbia" title="Serbia">
                <img class="avatar-flag-img" src="https://flagcdn.com/rs.svg" alt="Serbia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="bosnia" title="Bosnia and Herzegovina">
                <img class="avatar-flag-img" src="https://flagcdn.com/ba.svg" alt="Bosnia and Herzegovina" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="montenegro" title="Montenegro">
                <img class="avatar-flag-img" src="https://flagcdn.com/me.svg" alt="Montenegro" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="north-macedonia" title="North Macedonia">
                <img class="avatar-flag-img" src="https://flagcdn.com/mk.svg" alt="North Macedonia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="albania" title="Albania">
                <img class="avatar-flag-img" src="https://flagcdn.com/al.svg" alt="Albania" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="kosovo" title="Kosovo">
                <img class="avatar-flag-img" src="https://flagcdn.com/xk.svg" alt="Kosovo" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="ukraine" title="Ukraine">
                <img class="avatar-flag-img" src="https://flagcdn.com/ua.svg" alt="Ukraine" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="russia" title="Russia">
                <img class="avatar-flag-img" src="https://flagcdn.com/ru.svg" alt="Russia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="belarus" title="Belarus">
                <img class="avatar-flag-img" src="https://flagcdn.com/by.svg" alt="Belarus" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="moldova" title="Moldova">
                <img class="avatar-flag-img" src="https://flagcdn.com/md.svg" alt="Moldova" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="lithuania" title="Lithuania">
                <img class="avatar-flag-img" src="https://flagcdn.com/lt.svg" alt="Lithuania" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="latvia" title="Latvia">
                <img class="avatar-flag-img" src="https://flagcdn.com/lv.svg" alt="Latvia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="estonia" title="Estonia">
                <img class="avatar-flag-img" src="https://flagcdn.com/ee.svg" alt="Estonia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="finland" title="Finland">
                <img class="avatar-flag-img" src="https://flagcdn.com/fi.svg" alt="Finland" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="sweden" title="Sweden">
                <img class="avatar-flag-img" src="https://flagcdn.com/se.svg" alt="Sweden" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="norway" title="Norway">
                <img class="avatar-flag-img" src="https://flagcdn.com/no.svg" alt="Norway" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="denmark" title="Denmark">
                <img class="avatar-flag-img" src="https://flagcdn.com/dk.svg" alt="Denmark" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="iceland" title="Iceland">
                <img class="avatar-flag-img" src="https://flagcdn.com/is.svg" alt="Iceland" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="luxembourg" title="Luxembourg">
                <img class="avatar-flag-img" src="https://flagcdn.com/lu.svg" alt="Luxembourg" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="liechtenstein" title="Liechtenstein">
                <img class="avatar-flag-img" src="https://flagcdn.com/li.svg" alt="Liechtenstein" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="monaco" title="Monaco">
                <img class="avatar-flag-img" src="https://flagcdn.com/mc.svg" alt="Monaco" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="andorra" title="Andorra">
                <img class="avatar-flag-img" src="https://flagcdn.com/ad.svg" alt="Andorra" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="san-marino" title="San Marino">
                <img class="avatar-flag-img" src="https://flagcdn.com/sm.svg" alt="San Marino" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="vatican" title="Vatican City">
                <img class="avatar-flag-img" src="https://flagcdn.com/va.svg" alt="Vatican City" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="malta" title="Malta">
                <img class="avatar-flag-img" src="https://flagcdn.com/mt.svg" alt="Malta" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="cyprus" title="Cyprus">
                <img class="avatar-flag-img" src="https://flagcdn.com/cy.svg" alt="Cyprus" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="turkey" title="Turkey">
                <img class="avatar-flag-img" src="https://flagcdn.com/tr.svg" alt="Turkey" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="georgia" title="Georgia">
                <img class="avatar-flag-img" src="https://flagcdn.com/ge.svg" alt="Georgia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="armenia" title="Armenia">
                <img class="avatar-flag-img" src="https://flagcdn.com/am.svg" alt="Armenia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="azerbaijan" title="Azerbaijan">
                <img class="avatar-flag-img" src="https://flagcdn.com/az.svg" alt="Azerbaijan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <!-- 7. ASIA -->
              <div class="avatar-option" data-avatar="china" title="China">
                <img class="avatar-flag-img" src="https://flagcdn.com/cn.svg" alt="China" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="japan" title="Japan">
                <img class="avatar-flag-img" src="https://flagcdn.com/jp.svg" alt="Japan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="south-korea" title="South Korea">
                <img class="avatar-flag-img" src="https://flagcdn.com/kr.svg" alt="South Korea" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="north-korea" title="North Korea">
                <img class="avatar-flag-img" src="https://flagcdn.com/kp.svg" alt="North Korea" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="taiwan" title="Taiwan">
                <img class="avatar-flag-img" src="https://flagcdn.com/tw.svg" alt="Taiwan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="hong-kong" title="Hong Kong">
                <img class="avatar-flag-img" src="https://flagcdn.com/hk.svg" alt="Hong Kong" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="macau" title="Macau">
                <img class="avatar-flag-img" src="https://flagcdn.com/mo.svg" alt="Macau" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="mongolia" title="Mongolia">
                <img class="avatar-flag-img" src="https://flagcdn.com/mn.svg" alt="Mongolia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="vietnam" title="Vietnam">
                <img class="avatar-flag-img" src="https://flagcdn.com/vn.svg" alt="Vietnam" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="thailand" title="Thailand">
                <img class="avatar-flag-img" src="https://flagcdn.com/th.svg" alt="Thailand" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="philippines" title="Philippines">
                <img class="avatar-flag-img" src="https://flagcdn.com/ph.svg" alt="Philippines" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="indonesia" title="Indonesia">
                <img class="avatar-flag-img" src="https://flagcdn.com/id.svg" alt="Indonesia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="malaysia" title="Malaysia">
                <img class="avatar-flag-img" src="https://flagcdn.com/my.svg" alt="Malaysia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="singapore" title="Singapore">
                <img class="avatar-flag-img" src="https://flagcdn.com/sg.svg" alt="Singapore" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="brunei" title="Brunei">
                <img class="avatar-flag-img" src="https://flagcdn.com/bn.svg" alt="Brunei" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="cambodia" title="Cambodia">
                <img class="avatar-flag-img" src="https://flagcdn.com/kh.svg" alt="Cambodia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="laos" title="Laos">
                <img class="avatar-flag-img" src="https://flagcdn.com/la.svg" alt="Laos" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="myanmar" title="Myanmar">
                <img class="avatar-flag-img" src="https://flagcdn.com/mm.svg" alt="Myanmar" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="timor-leste" title="Timor-Leste">
                <img class="avatar-flag-img" src="https://flagcdn.com/tl.svg" alt="Timor-Leste" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="india" title="India">
                <img class="avatar-flag-img" src="https://flagcdn.com/in.svg" alt="India" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="pakistan" title="Pakistan">
                <img class="avatar-flag-img" src="https://flagcdn.com/pk.svg" alt="Pakistan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="bangladesh" title="Bangladesh">
                <img class="avatar-flag-img" src="https://flagcdn.com/bd.svg" alt="Bangladesh" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="nepal" title="Nepal">
                <img class="avatar-flag-img" src="https://flagcdn.com/np.svg" alt="Nepal" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="bhutan" title="Bhutan">
                <img class="avatar-flag-img" src="https://flagcdn.com/bt.svg" alt="Bhutan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="sri-lanka" title="Sri Lanka">
                <img class="avatar-flag-img" src="https://flagcdn.com/lk.svg" alt="Sri Lanka" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="maldives" title="Maldives">
                <img class="avatar-flag-img" src="https://flagcdn.com/mv.svg" alt="Maldives" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="afghanistan" title="Afghanistan">
                <img class="avatar-flag-img" src="https://flagcdn.com/af.svg" alt="Afghanistan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="iran" title="Iran">
                <img class="avatar-flag-img" src="https://flagcdn.com/ir.svg" alt="Iran" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="iraq" title="Iraq">
                <img class="avatar-flag-img" src="https://flagcdn.com/iq.svg" alt="Iraq" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="syria" title="Syria">
                <img class="avatar-flag-img" src="https://flagcdn.com/sy.svg" alt="Syria" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="lebanon" title="Lebanon">
                <img class="avatar-flag-img" src="https://flagcdn.com/lb.svg" alt="Lebanon" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="jordan" title="Jordan">
                <img class="avatar-flag-img" src="https://flagcdn.com/jo.svg" alt="Jordan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="israel" title="Israel">
                <img class="avatar-flag-img" src="https://flagcdn.com/il.svg" alt="Israel" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="palestine" title="Palestine">
                <img class="avatar-flag-img" src="https://flagcdn.com/ps.svg" alt="Palestine" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="saudi-arabia" title="Saudi Arabia">
                <img class="avatar-flag-img" src="https://flagcdn.com/sa.svg" alt="Saudi Arabia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="yemen" title="Yemen">
                <img class="avatar-flag-img" src="https://flagcdn.com/ye.svg" alt="Yemen" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="oman" title="Oman">
                <img class="avatar-flag-img" src="https://flagcdn.com/om.svg" alt="Oman" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="uae" title="United Arab Emirates">
                <img class="avatar-flag-img" src="https://flagcdn.com/ae.svg" alt="United Arab Emirates" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="qatar" title="Qatar">
                <img class="avatar-flag-img" src="https://flagcdn.com/qa.svg" alt="Qatar" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="bahrain" title="Bahrain">
                <img class="avatar-flag-img" src="https://flagcdn.com/bh.svg" alt="Bahrain" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="kuwait" title="Kuwait">
                <img class="avatar-flag-img" src="https://flagcdn.com/kw.svg" alt="Kuwait" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="kazakhstan" title="Kazakhstan">
                <img class="avatar-flag-img" src="https://flagcdn.com/kz.svg" alt="Kazakhstan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="uzbekistan" title="Uzbekistan">
                <img class="avatar-flag-img" src="https://flagcdn.com/uz.svg" alt="Uzbekistan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="turkmenistan" title="Turkmenistan">
                <img class="avatar-flag-img" src="https://flagcdn.com/tm.svg" alt="Turkmenistan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="tajikistan" title="Tajikistan">
                <img class="avatar-flag-img" src="https://flagcdn.com/tj.svg" alt="Tajikistan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="kyrgyzstan" title="Kyrgyzstan">
                <img class="avatar-flag-img" src="https://flagcdn.com/kg.svg" alt="Kyrgyzstan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <!-- 8. AFRICA -->
              <div class="avatar-option" data-avatar="egypt" title="Egypt">
                <img class="avatar-flag-img" src="https://flagcdn.com/eg.svg" alt="Egypt" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="morocco" title="Morocco">
                <img class="avatar-flag-img" src="https://flagcdn.com/ma.svg" alt="Morocco" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="algeria" title="Algeria">
                <img class="avatar-flag-img" src="https://flagcdn.com/dz.svg" alt="Algeria" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="tunisia" title="Tunisia">
                <img class="avatar-flag-img" src="https://flagcdn.com/tn.svg" alt="Tunisia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="libya" title="Libya">
                <img class="avatar-flag-img" src="https://flagcdn.com/ly.svg" alt="Libya" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="sudan" title="Sudan">
                <img class="avatar-flag-img" src="https://flagcdn.com/sd.svg" alt="Sudan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="south-sudan" title="South Sudan">
                <img class="avatar-flag-img" src="https://flagcdn.com/ss.svg" alt="South Sudan" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="ethiopia" title="Ethiopia">
                <img class="avatar-flag-img" src="https://flagcdn.com/et.svg" alt="Ethiopia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="eritrea" title="Eritrea">
                <img class="avatar-flag-img" src="https://flagcdn.com/er.svg" alt="Eritrea" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="djibouti" title="Djibouti">
                <img class="avatar-flag-img" src="https://flagcdn.com/dj.svg" alt="Djibouti" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="somalia" title="Somalia">
                <img class="avatar-flag-img" src="https://flagcdn.com/so.svg" alt="Somalia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="kenya" title="Kenya">
                <img class="avatar-flag-img" src="https://flagcdn.com/ke.svg" alt="Kenya" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="uganda" title="Uganda">
                <img class="avatar-flag-img" src="https://flagcdn.com/ug.svg" alt="Uganda" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="tanzania" title="Tanzania">
                <img class="avatar-flag-img" src="https://flagcdn.com/tz.svg" alt="Tanzania" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="rwanda" title="Rwanda">
                <img class="avatar-flag-img" src="https://flagcdn.com/rw.svg" alt="Rwanda" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="burundi" title="Burundi">
                <img class="avatar-flag-img" src="https://flagcdn.com/bi.svg" alt="Burundi" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="dr-congo" title="DR Congo">
                <img class="avatar-flag-img" src="https://flagcdn.com/cd.svg" alt="DR Congo" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="congo" title="Republic of the Congo">
                <img class="avatar-flag-img" src="https://flagcdn.com/cg.svg" alt="Republic of the Congo" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="central-african-republic" title="Central African Republic">
                <img class="avatar-flag-img" src="https://flagcdn.com/cf.svg" alt="Central African Republic" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="cameroon" title="Cameroon">
                <img class="avatar-flag-img" src="https://flagcdn.com/cm.svg" alt="Cameroon" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="nigeria" title="Nigeria">
                <img class="avatar-flag-img" src="https://flagcdn.com/ng.svg" alt="Nigeria" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="ghana" title="Ghana">
                <img class="avatar-flag-img" src="https://flagcdn.com/gh.svg" alt="Ghana" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="ivory-coast" title="Ivory Coast">
                <img class="avatar-flag-img" src="https://flagcdn.com/ci.svg" alt="Ivory Coast" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="senegal" title="Senegal">
                <img class="avatar-flag-img" src="https://flagcdn.com/sn.svg" alt="Senegal" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="mali" title="Mali">
                <img class="avatar-flag-img" src="https://flagcdn.com/ml.svg" alt="Mali" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="burkina-faso" title="Burkina Faso">
                <img class="avatar-flag-img" src="https://flagcdn.com/bf.svg" alt="Burkina Faso" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="niger" title="Niger">
                <img class="avatar-flag-img" src="https://flagcdn.com/ne.svg" alt="Niger" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="chad" title="Chad">
                <img class="avatar-flag-img" src="https://flagcdn.com/td.svg" alt="Chad" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="mauritania" title="Mauritania">
                <img class="avatar-flag-img" src="https://flagcdn.com/mr.svg" alt="Mauritania" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="gambia" title="Gambia">
                <img class="avatar-flag-img" src="https://flagcdn.com/gm.svg" alt="Gambia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="guinea-bissau" title="Guinea-Bissau">
                <img class="avatar-flag-img" src="https://flagcdn.com/gw.svg" alt="Guinea-Bissau" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="guinea" title="Guinea">
                <img class="avatar-flag-img" src="https://flagcdn.com/gn.svg" alt="Guinea" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="sierra-leone" title="Sierra Leone">
                <img class="avatar-flag-img" src="https://flagcdn.com/sl.svg" alt="Sierra Leone" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="liberia" title="Liberia">
                <img class="avatar-flag-img" src="https://flagcdn.com/lr.svg" alt="Liberia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="togo" title="Togo">
                <img class="avatar-flag-img" src="https://flagcdn.com/tg.svg" alt="Togo" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="benin" title="Benin">
                <img class="avatar-flag-img" src="https://flagcdn.com/bj.svg" alt="Benin" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="gabon" title="Gabon">
                <img class="avatar-flag-img" src="https://flagcdn.com/ga.svg" alt="Gabon" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="equatorial-guinea" title="Equatorial Guinea">
                <img class="avatar-flag-img" src="https://flagcdn.com/gq.svg" alt="Equatorial Guinea" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="sao-tome" title="São Tomé and Príncipe">
                <img class="avatar-flag-img" src="https://flagcdn.com/st.svg" alt="São Tomé and Príncipe" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="angola" title="Angola">
                <img class="avatar-flag-img" src="https://flagcdn.com/ao.svg" alt="Angola" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="zambia" title="Zambia">
                <img class="avatar-flag-img" src="https://flagcdn.com/zm.svg" alt="Zambia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="zimbabwe" title="Zimbabwe">
                <img class="avatar-flag-img" src="https://flagcdn.com/zw.svg" alt="Zimbabwe" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="malawi" title="Malawi">
                <img class="avatar-flag-img" src="https://flagcdn.com/mw.svg" alt="Malawi" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="mozambique" title="Mozambique">
                <img class="avatar-flag-img" src="https://flagcdn.com/mz.svg" alt="Mozambique" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="madagascar" title="Madagascar">
                <img class="avatar-flag-img" src="https://flagcdn.com/mg.svg" alt="Madagascar" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="mauritius" title="Mauritius">
                <img class="avatar-flag-img" src="https://flagcdn.com/mu.svg" alt="Mauritius" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="seychelles" title="Seychelles">
                <img class="avatar-flag-img" src="https://flagcdn.com/sc.svg" alt="Seychelles" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="comoros" title="Comoros">
                <img class="avatar-flag-img" src="https://flagcdn.com/km.svg" alt="Comoros" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="south-africa" title="South Africa">
                <img class="avatar-flag-img" src="https://flagcdn.com/za.svg" alt="South Africa" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="namibia" title="Namibia">
                <img class="avatar-flag-img" src="https://flagcdn.com/na.svg" alt="Namibia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="botswana" title="Botswana">
                <img class="avatar-flag-img" src="https://flagcdn.com/bw.svg" alt="Botswana" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="eswatini" title="Eswatini">
                <img class="avatar-flag-img" src="https://flagcdn.com/sz.svg" alt="Eswatini" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="lesotho" title="Lesotho">
                <img class="avatar-flag-img" src="https://flagcdn.com/ls.svg" alt="Lesotho" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="cabo-verde" title="Cabo Verde">
                <img class="avatar-flag-img" src="https://flagcdn.com/cv.svg" alt="Cabo Verde" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <!-- 9. OCEANIA -->
              <div class="avatar-option" data-avatar="australia" title="Australia">
                <img class="avatar-flag-img" src="https://flagcdn.com/au.svg" alt="Australia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="new-zealand" title="New Zealand">
                <img class="avatar-flag-img" src="https://flagcdn.com/nz.svg" alt="New Zealand" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="papua-new-guinea" title="Papua New Guinea">
                <img class="avatar-flag-img" src="https://flagcdn.com/pg.svg" alt="Papua New Guinea" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="fiji" title="Fiji">
                <img class="avatar-flag-img" src="https://flagcdn.com/fj.svg" alt="Fiji" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="samoa" title="Samoa">
                <img class="avatar-flag-img" src="https://flagcdn.com/ws.svg" alt="Samoa" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="tonga" title="Tonga">
                <img class="avatar-flag-img" src="https://flagcdn.com/to.svg" alt="Tonga" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="vanuatu" title="Vanuatu">
                <img class="avatar-flag-img" src="https://flagcdn.com/vu.svg" alt="Vanuatu" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="solomon-islands" title="Solomon Islands">
                <img class="avatar-flag-img" src="https://flagcdn.com/sb.svg" alt="Solomon Islands" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="kiribati" title="Kiribati">
                <img class="avatar-flag-img" src="https://flagcdn.com/ki.svg" alt="Kiribati" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="micronesia" title="Micronesia">
                <img class="avatar-flag-img" src="https://flagcdn.com/fm.svg" alt="Micronesia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="marshall-islands" title="Marshall Islands">
                <img class="avatar-flag-img" src="https://flagcdn.com/mh.svg" alt="Marshall Islands" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="palau" title="Palau">
                <img class="avatar-flag-img" src="https://flagcdn.com/pw.svg" alt="Palau" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="nauru" title="Nauru">
                <img class="avatar-flag-img" src="https://flagcdn.com/nr.svg" alt="Nauru" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="tuvalu" title="Tuvalu">
                <img class="avatar-flag-img" src="https://flagcdn.com/tv.svg" alt="Tuvalu" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="guam" title="Guam">
                <img class="avatar-flag-img" src="https://flagcdn.com/gu.svg" alt="Guam" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="american-samoa" title="American Samoa">
                <img class="avatar-flag-img" src="https://flagcdn.com/as.svg" alt="American Samoa" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="northern-mariana-islands" title="Northern Mariana Islands">
                <img class="avatar-flag-img" src="https://flagcdn.com/mp.svg" alt="Northern Mariana Islands" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="french-polynesia" title="French Polynesia">
                <img class="avatar-flag-img" src="https://flagcdn.com/pf.svg" alt="French Polynesia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="new-caledonia" title="New Caledonia">
                <img class="avatar-flag-img" src="https://flagcdn.com/nc.svg" alt="New Caledonia" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="cook-islands" title="Cook Islands">
                <img class="avatar-flag-img" src="https://flagcdn.com/ck.svg" alt="Cook Islands" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="niue" title="Niue">
                <img class="avatar-flag-img" src="https://flagcdn.com/nu.svg" alt="Niue" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <div class="avatar-option" data-avatar="tokelau" title="Tokelau">
                <img class="avatar-flag-img" src="https://flagcdn.com/tk.svg" alt="Tokelau" width="32" height="32" decoding="async" loading="lazy" draggable="false" />
              </div>
              <!-- Spacer for scroll centering -->
              <div class="avatar-selector__spacer" aria-hidden="true"></div>
            </div>
          </div>

          <!-- Country Name Display - Olympic ceremony style -->
	          <div class="country-display" id="mesaCountryDisplay" style="display:none;">
	            <p class="country-display__name" id="countryName">Cuba</p>
	            <p class="country-display__hint" id="countryHint">Tap to represent</p>
	          </div>

          <!-- Locked identity: after login we show your registered name (no list-picking / no impersonation) -->
          <div class="mesa-identity-locked" id="mesaIdentityLocked" style="display: none;">
            <p class="mesa-identity-locked__label">Representing</p>
            <p class="mesa-identity-locked__name" id="mesaLockedName">—</p>
          </div>

	          <button class="chat-identity__btn" id="chatJoinBtn" disabled style="display:none; margin-left:auto; margin-right:auto;">Enter</button>

          <!-- Custom Dropdown -->
	          <div class="custom-select" id="customSelect" style="display: none;">
            <button class="custom-select__trigger" id="selectTrigger" type="button">
              <span class="custom-select__value" id="selectValue">Select Your Name...</span>
              <span class="custom-select__arrow">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </button>
            <div class="custom-select__dropdown" id="selectDropdown">
              <div class="custom-select__search">
                <input type="text" class="custom-select__search-input" id="selectSearch" placeholder="Search..." />
              </div>
              <ul class="custom-select__options" id="selectOptions">
                <!-- Options populated by JS -->
              </ul>
            </div>
          </div>
          <!-- Hidden native select for form compatibility -->
          <select class="chat-identity__select" id="chatPlayerSelect" style="display: none;">
            <option value="">Select Your Name</option>
          </select>
          <input type="text" class="chat-identity__input" id="chatNameInput" placeholder="Your name..." style="display: none;" />
          <p class="chat-identity__register-hint" id="chatRegisterHint">
            Not registered yet? <a href="#signup" class="chat-identity__register-link" id="chatRegisterLink">Register first</a>
          </p>
        </div>

        <!-- Chat Screen Area -->
        <div class="chat-body-container" id="chatBodyContainer" style="display: none;">
          <!-- Hub Stack (Full mode) -->
          <div class="mesa-hub-stack" id="mesaHubStack">
            <div class="mesa-hub-module" id="mesaHubWho">
              <div class="mesa-hub-module__header">
                <h3 class="mesa-hub-module__title">Who's Here</h3>
                <button class="mesa-ritual__pill mesa-ritual__pill--toggle" id="mesaHubLfgToggle" type="button" aria-pressed="false">Looking for partner</button>
              </div>
              <div class="mesa-hub-module__content" id="mesaHubWhoList">
                 <!-- Populated by JS -->
              </div>
            </div>

            <div class="mesa-hub-module" id="mesaHubBoard">
              <h3 class="mesa-hub-module__title">The Board</h3>
              <div class="mesa-hub-module__content">
                 <div class="mesa-board-feed">
                   <div class="mesa-board-item mesa-board-item--priority">
                     <div class="mesa-board-item__kicker">Tournament Update</div>
                     <div class="mesa-board-item__title">REGISTRATION 75% COMPLETE</div>
                     <div class="mesa-board-item__body">Claim your seat before they're gone. The table is filling up fast.</div>
                   </div>
                   <div class="mesa-board-item">
                     <div class="mesa-board-item__kicker">Tonight's Stakes</div>
                     <div class="mesa-board-item__title">OCHÚN'S GOLD TROPHY + $200 POT</div>
                     <div class="mesa-board-item__body">Winner takes the prestige and the pot. Respect the game.</div>
                   </div>
                 </div>
              </div>
            </div>

            <div class="mesa-hub-module" id="mesaHubTonight">
              <h3 class="mesa-hub-module__title">Tonight</h3>
              <div class="mesa-hub-module__content">
                 <div class="mesa-ritual-card">
                   <div class="mesa-ritual-card__countdown" id="mesaHubCountdown" data-first-slam-at={EVENT.firstSlamAt}>00:00:00</div>
                   <div class="mesa-ritual-card__label">UNTIL FIRST SLAM</div>
                   <div class="mesa-ritual-divider"></div>
                   <div class="mesa-ritual-detail">
                     <span class="mesa-ritual-detail__label">VENUE</span>
                     <span class="mesa-ritual-detail__value">{EVENT.venueName}, {EVENT.venueCityState}</span>
                   </div>
                   <div class="mesa-ritual-detail">
                     <span class="mesa-ritual-detail__label">CALL TIME</span>
                     <span class="mesa-ritual-detail__value">{EVENT.callTimeLabel}</span>
                   </div>
                 </div>
              </div>
            </div>
          </div>

          <div class="mesa-chat-cue" aria-hidden="true">
            <span class="mesa-chat-cue__line"></span>
            <span class="mesa-chat-cue__text">
              <span class="mesa-chat-cue__pip"></span>
              CHAT
              <span class="mesa-chat-cue__chevron" aria-hidden="true">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </span>
            <span class="mesa-chat-cue__line"></span>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div class="chat-empty">The calm before the storm.</div>
          </div>


          <div class="chat-input-area" id="chatInputArea">
            <input type="text" class="chat-input" id="chatInput" placeholder="Habla..." maxlength="500">
            <button class="chat-send" id="chatSend" disabled>
              <svg viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Presence List - "Who's here" (second screen + room heartbeat) -->
        <div class="mesa-presence" id="mesaPresence" aria-hidden="true">
          <div class="mesa-presence__backdrop" id="mesaPresenceBackdrop"></div>
          <div class="mesa-presence__sheet" role="dialog" aria-label="Who's at the table">
            <div class="mesa-presence__header">
              <div class="mesa-presence__title">Who's here</div>
              <button class="mesa-presence__close" id="mesaPresenceClose" type="button" aria-label="Close list">Close</button>
            </div>
            <div class="mesa-presence__list" id="mesaPresenceList"></div>
          </div>
        </div>
        </div> <!-- closes .chat-content -->
      </div> <!-- closes .chat-main -->
    </div> <!-- closes .chat-panel -->

      <!-- Leave Table Confirmation Modal - Tobias: "The room should never feel like a browser" -->
      <div class="leave-modal" id="leaveModal">
        <div class="leave-modal__backdrop"></div>
      <div class="leave-modal__dialog">
          <h3 class="leave-modal__title">Leave the Table?</h3>
          <p class="leave-modal__message">You'll need to claim your seat again to re-enter.</p>
          <div class="leave-modal__actions">
            <button class="leave-modal__btn leave-modal__btn--stay" id="leaveModalStay" type="button">Stay</button>
            <button class="leave-modal__btn leave-modal__btn--leave" id="leaveModalLeave" type="button">Leave</button>
          </div>
        </div>
      </div>

      <!-- Team Invite Notification Toast -->
      <div class="team-invite-toast" id="teamInviteToast">
        <div class="team-invite-toast__content">
          <div class="team-invite-toast__icon">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </div>
          <div class="team-invite-toast__text">
            <span class="team-invite-toast__from" id="inviteFromPlayer">Carmen</span>
            <span class="team-invite-toast__message">wants to form a team</span>
          </div>
          <div class="team-invite-toast__actions">
            <button class="team-invite-toast__btn team-invite-toast__btn--accept" id="acceptInviteBtn">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </button>
            <button class="team-invite-toast__btn team-invite-toast__btn--decline" id="declineInviteBtn">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="3">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Team Creation Modal - "Make it a BIG moment" -->
      <div class="team-modal" id="teamModal">
        <div class="team-modal__backdrop"></div>
        <div class="team-modal__dialog">
          <div class="team-modal__header">
            <h3 class="team-modal__title">Form Your Team</h3>
            <p class="team-modal__subtitle">
              <span id="teamPartner1">You</span> & <span id="teamPartner2">Partner</span>
            </p>
          </div>

          <div class="team-modal__form">
            <label class="team-modal__label">Team Name</label>
            <input type="text" class="team-modal__input" id="teamNameInput" placeholder="Los..." maxlength="24" />

            <label class="team-modal__label">Choose Your Archetype</label>
            <div class="team-archetype-grid" id="archetypeGrid">
              <button class="team-archetype" data-archetype="los_viejos">
                <span class="team-archetype__icon"></span>
                <span class="team-archetype__name">Los Viejos</span>
                <span class="team-archetype__desc">The Wise Ones</span>
              </button>
              <button class="team-archetype" data-archetype="los_venenos">
                <span class="team-archetype__icon"></span>
                <span class="team-archetype__name">Los Venenos</span>
                <span class="team-archetype__desc">The Poisoners</span>
              </button>
              <button class="team-archetype" data-archetype="la_tranca">
                <span class="team-archetype__icon"></span>
                <span class="team-archetype__name">La Tranca</span>
                <span class="team-archetype__desc">The Blockers</span>
              </button>
              <button class="team-archetype" data-archetype="la_carreta">
                <span class="team-archetype__icon"></span>
                <span class="team-archetype__name">La Carreta</span>
                <span class="team-archetype__desc">The Rollers</span>
              </button>
              <button class="team-archetype" data-archetype="los_capicuas">
                <span class="team-archetype__icon"></span>
                <span class="team-archetype__name">Los Capicuas</span>
                <span class="team-archetype__desc">The Precision</span>
              </button>
              <button class="team-archetype" data-archetype="los_pesados">
                <span class="team-archetype__icon"></span>
                <span class="team-archetype__name">Los Pesados</span>
                <span class="team-archetype__desc">The Heavy Hitters</span>
              </button>
              <button class="team-archetype" data-archetype="los_amarradores">
                <span class="team-archetype__icon"></span>
                <span class="team-archetype__name">Los Amarradores</span>
                <span class="team-archetype__desc">The Trappers</span>
              </button>
              <button class="team-archetype" data-archetype="la_mula">
                <span class="team-archetype__icon"></span>
                <span class="team-archetype__name">La Mula</span>
                <span class="team-archetype__desc">The Mules</span>
              </button>
            </div>
          </div>

          <div class="team-modal__actions">
            <button class="team-modal__btn team-modal__btn--cancel" id="teamModalCancel" type="button">Cancel</button>
            <button class="team-modal__btn team-modal__btn--create" id="teamModalCreate" type="button" disabled>Create Team</button>
          </div>
        </div>
      </div>
    </div>

    <!-- "Unlock La Mesa" — Speech bubble above domino button, not bottom sheet -->
    <div class="mesa-help" id="mesaHelp" role="status" aria-live="polite" aria-atomic="true">
      <div class="mesa-help__content">
        <p class="mesa-help__kicker">Table Access</p>
        <p class="mesa-help__text">Claim your seat above to unlock <span class="mesa-help__highlight">La Mesa</span></p>
      </div>
      <span class="mesa-help__arrow"></span>
    </div>

    <!-- Background Dimming Overlay -->
    <div class="chat-backdrop" id="chatBackdrop"></div>

	    <script define:vars={{ PLAYERS_REGISTERED, PLAYERS_GOAL, SUPABASE_URL, SUPABASE_ANON_KEY }}>
	      // Loading Screen Dismissal Logic - Pure CSS
	      let didDismissLoadingScreen = false;
	      function dismissLoadingScreen() {
	        if (didDismissLoadingScreen) return;
	        didDismissLoadingScreen = true;
	        const loadingScreen = document.getElementById('loadingScreen');
	        document.body.classList.remove('is-loading');

	        const markReady = () => {
          if (document.body.classList.contains('is-ready')) return;
          document.body.classList.add('is-ready');
          window.dispatchEvent(new Event('cdl:ready'));
        };

	        if (!loadingScreen) {
	          markReady();
	          return;
	        }

	        // Let the loading screen breathe, but stop blocking scroll/taps quickly.
	        // The ritual takes ~3s, then heartbeat begins. Hold for one full breath.
	        const REDUCED_MOTION = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
	        const INTERACTION_RELEASE_MS = 180;
	        const BREATHING_START_MS = REDUCED_MOTION ? 500 : 2700;  // Entrance completes, room starts breathing
	        const ANTICIPATION_MS = REDUCED_MOTION ? 1000 : 3300;     // Final breath before release (700ms held breath)
	        const VISUAL_HOLD_MS = REDUCED_MOTION ? 1500 : 4000;      // Shortened for reduced motion users
	        const EXIT_ANIMATION_MS = 200;    // Start exit animation before fade

	        setTimeout(() => {
	          loadingScreen.classList.add('is-passive');
	        }, INTERACTION_RELEASE_MS);

	        // "The Room Breathes" — entrance complete, begin meditative pulse
	        setTimeout(() => {
	          loadingScreen.classList.add('is-breathing');
	        }, BREATHING_START_MS);

	        // "The Final Breath" — glow intensifies before release
	        setTimeout(() => {
	          loadingScreen.classList.add('is-anticipating');
	        }, ANTICIPATION_MS);

		        // "The Smoke Clears" — start exit animation (embers accelerate, tile recedes)
		        setTimeout(() => {
		          loadingScreen.classList.add('is-exiting');
		        }, VISUAL_HOLD_MS - EXIT_ANIMATION_MS);

		        const getMaxTransitionMs = (el) => {
		          const style = window.getComputedStyle(el);
		          const durations = style.transitionDuration.split(',').map((value) => value.trim());
		          const delays = style.transitionDelay.split(',').map((value) => value.trim());

		          const parseMs = (value) => {
		            if (!value) return 0;
		            if (value.endsWith('ms')) return Number.parseFloat(value);
		            if (value.endsWith('s')) return Number.parseFloat(value) * 1000;
		            return Number.parseFloat(value) || 0;
		          };

		          const totalMs = durations.map((duration, idx) => {
		            const delay = delays[idx] ?? delays[0] ?? '0s';
		            return parseMs(duration) + parseMs(delay);
		          });

		          return Math.max(0, ...totalMs);
		        };

		        setTimeout(() => {
		          loadingScreen.classList.add('is-hidden');
		          // Only hand off once the loader actually finishes fading.
		          // This prevents hero/pip animations from running "under" the loader mid-fade (common flicker trigger).
		          const DARK_BEAT_MS = 80;
		          const fadeMs = getMaxTransitionMs(loadingScreen);
		          const fallbackMs = Math.max(650, fadeMs + 250);

		          let didHandoff = false;
		          const handoff = () => {
		            if (didHandoff) return;
		            didHandoff = true;
		            setTimeout(() => {
		              markReady();
		              if (loadingScreen.parentNode) loadingScreen.remove();
		            }, DARK_BEAT_MS);
		          };

		          const onTransitionEnd = (event) => {
		            if (event.target !== loadingScreen) return;
		            if (event.propertyName !== 'opacity') return;
		            cleanup();
		            handoff();
		          };

		          let fallbackTimer = null;
		          const cleanup = () => {
		            loadingScreen.removeEventListener('transitionend', onTransitionEnd);
		            if (fallbackTimer) clearTimeout(fallbackTimer);
		          };

		          loadingScreen.addEventListener('transitionend', onTransitionEnd);
		          fallbackTimer = setTimeout(() => {
		            cleanup();
		            handoff();
		          }, fallbackMs);
		        }, VISUAL_HOLD_MS);
		      }

	      // Trigger dismissal as soon as DOM is ready (don't wait for full window load).
	      if (document.readyState === 'complete' || document.readyState === 'interactive') {
	        dismissLoadingScreen();
	      } else {
	        document.addEventListener('DOMContentLoaded', dismissLoadingScreen, { once: true });
	      }

	      // Fallback: Force dismissal after 6 seconds (ritual ~4s + buffer)
	      setTimeout(dismissLoadingScreen, 6000);

      // Panel parallax and content animations
      const allPanels = document.querySelectorAll('.panel');
      const storyEl = document.querySelector('.story');
      const heroScrollHint = document.getElementById('heroScrollHint');
      let heroHintTimer = null;
      const jumpTarget = new URLSearchParams(window.location.search).get('jump');

      if (jumpTarget === 'form') {
        const doJump = () => {
          document.querySelector('.panel--form')?.scrollIntoView({ behavior: 'auto', block: 'start' });
        };
        if (document.body.classList.contains('is-ready')) doJump();
        else window.addEventListener('cdl:ready', doJump, { once: true });
      }

      const inViewRatioThreshold = 0.4;
      const enterThreshold = 0.45;
      const exitThreshold = 0.25;

      const panelObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const ratio = typeof entry.intersectionRatio === 'number' ? entry.intersectionRatio : 0;

          if (ratio >= enterThreshold) {
            entry.target.classList.add('in-view');
            if (entry.target.classList.contains('has-played') && !entry.target.classList.contains('reentering')) {
              entry.target.classList.add('reentering');
              setTimeout(() => entry.target.classList.remove('reentering'), 420);
            }
          } else if (ratio <= exitThreshold) {
            entry.target.classList.remove('in-view');
          }
        });
      }, { threshold: [0, exitThreshold, enterThreshold, 1] });

      // Skip observing the first panel (hero) - it should always be visible
      allPanels.forEach((panel, index) => {
        if (index > 0) {
          panelObserver.observe(panel);
        }
      });

      // First panel is always in view
      allPanels[0]?.classList.add('in-view');

      // Tobias: Let the hero breathe, then nudge (subtle scroll cue).
      if (storyEl && heroScrollHint) {
        const hideHeroHint = () => {
          heroScrollHint.classList.remove('is-ready');
          if (heroHintTimer) {
            clearTimeout(heroHintTimer);
            heroHintTimer = null;
          }
        };

        const scheduleHeroHint = () => {
          if (heroHintTimer) clearTimeout(heroHintTimer);
          heroHintTimer = setTimeout(() => {
            // Only hint when at the very top and no modal/overlay is taking focus.
            if (storyEl.scrollTop > 10) return;
            if (document.body.classList.contains('chat-open')) return;
            heroScrollHint.classList.add('is-ready');
          }, 2600);
        };

        const onStoryScroll = () => {
          if (storyEl.scrollTop <= 10) scheduleHeroHint();
          else hideHeroHint();
        };

        storyEl.addEventListener('scroll', onStoryScroll, { passive: true });

        const startWhenReady = () => onStoryScroll();
        if (document.body.classList.contains('is-ready')) startWhenReady();
        else window.addEventListener('cdl:ready', startWhenReady, { once: true });
      }

      // Back to Top - CDL Monogram
      // Shows on all panels (including hero), hides only on form panel
      {
        const backToTop = document.getElementById('backToTop');
        const heroPanel = document.getElementById('heroPanel');
        const formPanel = document.querySelector('.panel--form');

        if (backToTop && storyEl && heroPanel) {
          // Show/hide based on form fields position (not entire panel)
          const updateBackToTopVisibility = () => {
            // Get the actual form element (the inputs, not the counter above)
            const signupForm = document.getElementById('signup');

            // Hide pip when form fields would collide with it
            // Pip is at top: 20px, so hide when form top approaches that area
            let formFieldsInWay = false;
            if (signupForm) {
              const formRect = signupForm.getBoundingClientRect();
              // Hide when form's top edge is within 80px of viewport top
              // (pip is at 20px + its height ~50px + breathing room)
              // BUT only if form is actually visible (bottom > 0 means form is on screen)
              formFieldsInWay = formRect.top < 80 && formRect.bottom > 0;
            }

            if (!formFieldsInWay) {
              backToTop.classList.add('is-visible');
            } else {
              backToTop.classList.remove('is-visible');
            }
          };

          storyEl.addEventListener('scroll', updateBackToTopVisibility, { passive: true });

          // Initial check
          updateBackToTopVisibility();

          // Fire ember release when loading screen completes - visual handoff
          const triggerEmberRelease = () => {
            // Skip if success screen is showing (prevents golden pip flash during registration flow)
            if (document.body.dataset.successActive === 'true') return;
            backToTop.classList.add('ember-release');
          };

          // Listen for loading complete event
          if (document.body.classList.contains('is-ready')) {
            // Already ready (fast load or reload)
            triggerEmberRelease();
          } else {
            window.addEventListener('cdl:ready', triggerEmberRelease, { once: true });
          }

          // Tooltip: guide users to the chat button when pip is touched
          const chatTooltip = document.getElementById('chatTooltip');
          let tooltipTimer = null;
          let tooltipShown = false; // Only show once per session

          const showChatTooltip = () => {
            if (!chatTooltip || tooltipShown) return;
            tooltipShown = true;
            chatTooltip.classList.add('is-visible');

            // Auto-hide after 3 seconds
            if (tooltipTimer) clearTimeout(tooltipTimer);
            tooltipTimer = setTimeout(() => {
              chatTooltip.classList.remove('is-visible');
            }, 3000);
          };

          // Story trigger: pip click initiates the narrative journey
          // First click FROM HERO → Begin story at Panel 2
          // All other clicks → Return to hero (back to top)
          let storyStarted = false;

          backToTop.addEventListener('click', (e) => {
            unlockScroll();

            // Detect if user is at hero panel by checking scroll position
            // Hero is the first panel, so scrollTop near 0 means we're at hero
            const scrollTop = storyEl?.scrollTop || 0;
            const isAtHero = scrollTop < 100; // Within 100px of top = at hero

            if (!storyStarted && isAtHero) {
              // First click from hero: Teleport to Panel 2 (Whisper) to begin story
              storyStarted = true;
              const whisperPanel = document.getElementById('panelWhisper');
              if (whisperPanel) {
                snapToPanelTop(whisperPanel);
              }
              return;
            }

            // All other cases: Back to hero
            storyStarted = true; // Mark story as started since user has explored
            snapToPanelTop(heroPanel);
          });

          // Wire tooltip to chat button hover (desktop) and first touch (mobile)
          const tickerChatBtn = document.getElementById('tickerChatBtn');
          tickerChatBtn?.addEventListener('mouseenter', showChatTooltip);
          tickerChatBtn?.addEventListener('touchstart', showChatTooltip, { passive: true, once: true });
        }
      }


      // Scroll-lock system for cinematic panels
      // Prevents scrolling until animations complete
      // DISABLED on mobile (<=768px) - CSS uses proximity snap for natural flow
      const isMobile = window.innerWidth <= 768;
      const whisperPanel = document.getElementById('panelWhisper');
      const buildPanel = document.getElementById('panelBuild');
      const slamPanel = document.getElementById('panelSlam');
      const rulesPanel = document.getElementById('panelRules');
      let scrollLocked = false;
      let whisperHasPlayed = false;
      let buildHasPlayed = false;
      let slamHasPlayed = false;
      let rulesHasPlayed = false;
      let lastTouchY = null;
      let scrollLockTimer = null;

      const scrollBlockTarget = storyEl ?? document;

      // Track touch direction so we can block "skip ahead" without trapping users.
      if (storyEl) {
        storyEl.addEventListener(
          'touchstart',
          (e) => {
            const y = e.touches?.[0]?.clientY;
            if (typeof y === 'number') lastTouchY = y;
          },
          { passive: true }
        );
        // Reset tracking when touch ends to avoid stale values on next gesture
        storyEl.addEventListener('touchend', () => { lastTouchY = null; }, { passive: true });
      }

      // Track when scroll-snap is disabled for form panel navigation
      let scrollSnapDisabledForForm = false;

      function snapToPanelTop(panelEl) {
        if (!storyEl || !panelEl) return;
        const storyRect = storyEl.getBoundingClientRect();
        const panelRect = panelEl.getBoundingClientRect();
        const delta = panelRect.top - storyRect.top;
        if (Math.abs(delta) <= 2) return; // only skip if truly at destination

        // iOS Safari fix: disable scroll-snap during programmatic scroll
        // Without this, iOS snaps to the last valid snap-point (Build panel)
        // instead of our target (Form panel, which has scroll-snap-align: none)
        const originalSnapType = storyEl.style.scrollSnapType;
        storyEl.style.scrollSnapType = 'none';

        const targetTop = storyEl.scrollTop + delta;
        storyEl.scrollTo({ top: targetTop, behavior: 'instant' });

        // Check if target panel has a snap anchor
        // If scroll-snap-align is "none", DON'T re-enable scroll-snap
        // (iOS would snap back to last valid anchor like Build panel)
        const panelSnapAlign = getComputedStyle(panelEl).scrollSnapAlign;
        if (panelSnapAlign.includes('none')) {
          // Panel has no snap anchor - leave scroll-snap disabled
          // This allows natural scroll flow on Form panel (mobile)
          scrollSnapDisabledForForm = true;
          return;
        }

        // Re-enable scroll-snap after a small delay to let iOS settle
        // The RAF loop caused conflicts with iOS momentum scrolling
        // Increased from 80ms to 150ms to allow snap correction to complete smoothly
        setTimeout(() => {
          storyEl.style.scrollSnapType = originalSnapType || 'y mandatory';
        }, 150);
      }

      // Track form interaction state - prevents snap re-engaging while user is filling form
      let formIsBeingInteracted = false;
      let formInteractionTimeout = null;

      // Mark form as being interacted with when user touches/focuses form elements
      const formShellEl = document.getElementById('formShell');
      if (formShellEl) {
        formShellEl.addEventListener('focusin', () => {
          formIsBeingInteracted = true;
          if (formInteractionTimeout) clearTimeout(formInteractionTimeout);
        });
        formShellEl.addEventListener('focusout', () => {
          formInteractionTimeout = setTimeout(() => { formIsBeingInteracted = false; }, 1500);
        });
        formShellEl.addEventListener('touchstart', () => {
          formIsBeingInteracted = true;
          if (formInteractionTimeout) clearTimeout(formInteractionTimeout);
        }, { passive: true });
      }

      // Re-enable scroll-snap when user scrolls away from form panel
      // Per Tobias audit: Only re-enable on explicit "back" gesture (not while interacting)
      storyEl?.addEventListener('scroll', () => {
        if (!scrollSnapDisabledForForm) return;

        const formPanel = document.querySelector('.panel--form');
        if (!formPanel) return;

        // Don't re-enable snap while user is actively filling out the form
        if (formIsBeingInteracted) return;

        const formRect = formPanel.getBoundingClientRect();
        const viewportHeight = window.innerHeight;

        // Update scroll indicator visibility
        const formContent = formPanel.querySelector('.panel-content');
        if (formContent) {
          const contentBottom = formContent.getBoundingClientRect().bottom;
          formPanel.classList.toggle('has-scroll-content', contentBottom > viewportHeight - 46);
          formPanel.classList.toggle('scrolled-to-bottom', contentBottom <= viewportHeight);
        }

        // If form panel is mostly out of view (less than 30% visible), re-enable snap
        if (formRect.top > viewportHeight * 0.7 || formRect.bottom < viewportHeight * 0.3) {
          storyEl.style.scrollBehavior = 'smooth';
          storyEl.style.scrollSnapType = '';
          scrollSnapDisabledForForm = false;
          formPanel.classList.remove('has-scroll-content', 'scrolled-to-bottom');

          setTimeout(() => {
            if (storyEl) storyEl.style.scrollBehavior = '';
          }, 500);
        }
      }, { passive: true });

      function alignPanelAfterSettle(panelEl) {
        if (!storyEl || !panelEl) return;
        let lastTop = storyEl.scrollTop;
        let stableFrames = 0;
        let frames = 0;

        const step = () => {
          frames += 1;
          const top = storyEl.scrollTop;
          if (Math.abs(top - lastTop) < 0.5) stableFrames += 1;
          else stableFrames = 0;
          lastTop = top;

          if (stableFrames >= 3) {
            if (typeof getPanelVisibilityRatio === 'function' && getPanelVisibilityRatio(panelEl) >= 0.9) {
              snapToPanelTop(panelEl);
            }
            return;
          }
          if (frames < 28) requestAnimationFrame(step);
        };

        requestAnimationFrame(step);
      }

      // Track touch velocity for escape hatch
      let touchVelocity = 0;
      let lastTouchTime = 0;

      function preventScroll(e) {
        if (scrollLocked) {
          // Escape hatch threshold - aggressive scroll breaks the lock
          const escapeThreshold = 150;

          // Allow scrolling BACK (up) while locked; only block skipping forward (down).
          if (e.type === 'wheel') {
            if (e.deltaY < 0) return;
            // Escape hatch: Hard scroll (delta > threshold) breaks the lock
            if (Math.abs(e.deltaY) > escapeThreshold) {
              unlockScroll();
              return; // Allow the scroll through
            }
          } else if (e.type === 'touchmove') {
            const currentY = e.touches?.[0]?.clientY;
            const currentTime = Date.now();
            if (typeof currentY === 'number') {
              // First touchmove of gesture - record position, don't block
              if (lastTouchY == null) {
                lastTouchY = currentY;
                lastTouchTime = currentTime;
                touchVelocity = 0;
                return;
              }
              const delta = currentY - lastTouchY;
              const timeDelta = currentTime - lastTouchTime;

              // Calculate velocity (pixels per 16ms frame)
              if (timeDelta > 0) {
                touchVelocity = Math.abs(delta) / (timeDelta / 16);
              }

              lastTouchY = currentY;
              lastTouchTime = currentTime;

              // Finger moving DOWN => content scrolls UP (allow).
              if (delta > 0) return;

              // Escape hatch: Fast swipe (high velocity) breaks the lock
              if (touchVelocity > 10) { // ~10px per frame = fast swipe
                unlockScroll();
                return; // Allow the scroll through
              }
            }
          }

          e.preventDefault();
          e.stopPropagation();
        }
      }

      function lockScroll(duration, afterUnlock) {
        // Allow full lock duration on mobile - animations need time to land
        // Escape hatch (fast swipe) still works for impatient users
        const effectiveDuration = duration;

        scrollLocked = true;
        scrollBlockTarget.addEventListener('wheel', preventScroll, { passive: false });
        scrollBlockTarget.addEventListener('touchmove', preventScroll, { passive: false });

        if (scrollLockTimer) clearTimeout(scrollLockTimer);
        scrollLockTimer = setTimeout(() => {
          unlockScroll();
          if (typeof afterUnlock === 'function') afterUnlock();
        }, effectiveDuration);
      }

      function unlockScroll() {
        // "Breath" delay before unlock - per Tobias: transitions should feel like camera cuts
        // This prevents the jarring micro-jerk when snap correction kicks in
        setTimeout(() => {
          scrollLocked = false;
          scrollBlockTarget.removeEventListener('wheel', preventScroll);
          scrollBlockTarget.removeEventListener('touchmove', preventScroll);

          // Enable smooth scroll temporarily so any snap correction feels cinematic
          // This prevents the "browser nudged the page" feeling
          if (storyEl) {
            storyEl.style.scrollBehavior = 'smooth';
            // Reset after any snap correction completes
            setTimeout(() => {
              if (storyEl) storyEl.style.scrollBehavior = '';
            }, 400);
          }
        }, 100); // 100ms breath - enough to feel intentional, not enough to feel laggy

        if (scrollLockTimer) {
          clearTimeout(scrollLockTimer);
          scrollLockTimer = null;
        }
      }

      // Panel 2 (Whisper) scroll-lock - 6.5 seconds
      // Tobias: "Rooms you can leave freely" - shorter lock feels like room holding you, not trapped
      const whisperObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !whisperHasPlayed) {
            whisperHasPlayed = true;
            alignPanelAfterSettle(whisperPanel);
            lockScroll(6500, () => {
              // Double-RAF: Let browser complete any pending paints before class toggle
              // Prevents "light flicker" from abrupt state change
              requestAnimationFrame(() => {
                requestAnimationFrame(() => whisperPanel?.classList.add('has-played'));
              });
            });
          }
        });
      }, { threshold: 0.6 });

      // Panel 3 (Build/Revelation) scroll-lock - 12.5 seconds
      // Full sequence: "Te toca" at 10.5s + 2.0s animation = 12.5s total
      const buildObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !buildHasPlayed) {
            buildHasPlayed = true;
            alignPanelAfterSettle(buildPanel);
            lockScroll(12500, () => {
              // Double-RAF: Let browser complete any pending paints before class toggle
              // Prevents "light flicker" from abrupt state change
              requestAnimationFrame(() => {
                requestAnimationFrame(() => buildPanel?.classList.add('has-played'));
              });
            });
          }
        });
      }, { threshold: 0.6 });

      // Panel 4 (Slam/Stakes) scroll-lock - 5 seconds
      // Tobias: Just enough for SEAT slam to land, slogan at 3.8s + buffer
      const slamObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !slamHasPlayed) {
            slamHasPlayed = true;
            alignPanelAfterSettle(slamPanel);
            lockScroll(5000, () => {
              // Double-RAF: Let browser complete any pending paints before class toggle
              // Prevents "light flicker" from abrupt state change
              requestAnimationFrame(() => {
                requestAnimationFrame(() => slamPanel?.classList.add('has-played'));
              });
            });

            // Haptic feedback at SEAT impact moment (1.8s delay + 45% of 1.2s animation = 2.34s)
            setTimeout(() => {
              if (navigator.vibrate) {
                navigator.vibrate([25, 50, 15]); // slam-settle-rest pattern
              }
            }, 2340);
          }
        });
      }, { threshold: 0.6 });

	      // Panel 5 (Rules/La Ley) scroll-lock - 2.5 seconds
	      // Tobias: Quick but complete - all cards animate in by 1.8s
	      const rulesObserver = new IntersectionObserver((entries) => {
	        entries.forEach(entry => {
	          if (entry.isIntersecting && !rulesHasPlayed) {
	            rulesHasPlayed = true;
	            alignPanelAfterSettle(rulesPanel);
	            lockScroll(2500, () => {
	              // Let Safari finish its snap/momentum and the unlock paint before we flip to the static state.
	              requestAnimationFrame(() => {
	                requestAnimationFrame(() => rulesPanel?.classList.add('has-played'));
	              });
	            });
	          }
	        });
	      }, { threshold: 0.6 });

      if (whisperPanel) whisperObserver.observe(whisperPanel);
      if (buildPanel) buildObserver.observe(buildPanel);
      if (slamPanel) slamObserver.observe(slamPanel);
      if (rulesPanel) rulesObserver.observe(rulesPanel);

      // La Mesa button bypass - unlock scroll and go to form
      const laMesaButton = document.querySelector('.la-mesa-toggle');
	      if (laMesaButton) {
	        laMesaButton.addEventListener('click', () => {
	          unlockScroll();
	          // Mark all as played so they don't re-lock
	          whisperHasPlayed = true;
	          buildHasPlayed = true;
	          slamHasPlayed = true;
	          rulesHasPlayed = true;
	          whisperPanel?.classList.add('has-played');
	          buildPanel?.classList.add('has-played');
	          slamPanel?.classList.add('has-played');
	          rulesPanel?.classList.add('has-played');
	        });
	      }

      // Progress counter animation
      const playerCountEl = document.getElementById("playerCount");
      const spotsLeftEl = document.getElementById("spotsLeft");
      const spotsLeftButtonEl = document.getElementById("spotsLeftButton");
      const spotsLeftInlineEl = document.getElementById("spotsLeftInline");
      const spotsLeftInlineNextEl = document.getElementById("spotsLeftInlineNext");
      const progressFillEl = document.getElementById("progressFill");
      const formScarcityEl = document.getElementById("formScarcity");
      let seatsRemainingActual = PLAYERS_GOAL - PLAYERS_REGISTERED;

      function animateInlineSeatTick(nextValue) {
        if (!spotsLeftInlineEl || !spotsLeftInlineNextEl) return;
        const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (reduceMotion) return;

        const display = spotsLeftInlineEl.closest('.form-scarcity__display');
        if (!display) return;

        spotsLeftInlineNextEl.textContent = String(nextValue);
        display.classList.remove('is-tick');
        requestAnimationFrame(() => {
          display.classList.add('is-tick');
        });

        window.setTimeout(() => {
          spotsLeftInlineEl.textContent = String(nextValue);
          spotsLeftInlineNextEl.textContent = '';
          display.classList.remove('is-tick');
        }, 260);
      }

      function updateSpotsRemaining(actualRemaining, { animate = false, tick = false } = {}) {
        seatsRemainingActual = actualRemaining;
        const remaining = Math.max(actualRemaining, 0);

        if (spotsLeftEl) spotsLeftEl.textContent = remaining + " seats left";
        if (spotsLeftButtonEl) spotsLeftButtonEl.textContent = remaining;
        if (spotsLeftInlineEl) {
          const currentInline = Number.parseInt(spotsLeftInlineEl.textContent || '', 10);
          const shouldTick = tick && !(Number.isFinite(currentInline) && currentInline === remaining);
          if (shouldTick) animateInlineSeatTick(remaining);
          else spotsLeftInlineEl.textContent = remaining;
        }

        if (formScarcityEl) {
          formScarcityEl.classList.toggle("is-hot", remaining <= 4);
          if (animate) {
            formScarcityEl.classList.remove("is-pop");
            requestAnimationFrame(() => {
              formScarcityEl.classList.add("is-pop");
            });
            window.setTimeout(() => {
              formScarcityEl.classList.remove("is-pop");
            }, 360);
          }
        }
      }

      function animateCounter(target, duration = 1000) {
        let start = 0;
        const startTime = performance.now();

        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic

          const current = Math.floor(eased * target);
          playerCountEl.textContent = current;

          if (progress < 1) {
            requestAnimationFrame(update);
          } else {
            playerCountEl.textContent = target;
          }
        }

        requestAnimationFrame(update);
      }

	      // Track live count (updated by fetch, used by observer)
	      let livePlayerCount = PLAYERS_REGISTERED;
	      let liveFetched = false;

	      function applyRealSeatClaim(delta) {
	        const nextCount = Number(livePlayerCount) + Number(delta);
	        if (!Number.isFinite(nextCount)) return;

	        livePlayerCount = Math.max(0, nextCount);
	        const remaining = PLAYERS_GOAL - livePlayerCount;

	        if (playerCountEl) playerCountEl.textContent = livePlayerCount;
	        seatsRemainingActual = remaining;
	        updateSpotsRemaining(remaining, { animate: false, tick: true });

	        const percentage = (livePlayerCount / PLAYERS_GOAL) * 100;
	        if (progressFillEl) progressFillEl.style.width = percentage + '%';
	      }

	      // Fetch live registration count from Google Sheets BEFORE observer setup
	      fetch('/api/players')
	        .then(r => r.json())
	        .then(data => {
          livePlayerCount = data.players?.length || 0;
          liveFetched = true;

          // If observer already fired, update now with live data
          if (hasAnimated) {
            const remaining = PLAYERS_GOAL - livePlayerCount;
            if (playerCountEl) playerCountEl.textContent = livePlayerCount;
            seatsRemainingActual = remaining;
            updateSpotsRemaining(remaining, { animate: false });
            const percentage = (livePlayerCount / PLAYERS_GOAL) * 100;
            if (progressFillEl) progressFillEl.style.width = percentage + '%';
          }
        })
        .catch(err => console.warn('Could not fetch live count:', err));

      // Animate progress bar and counter when panel comes into view
      const formPanel = document.querySelector(".panel--form");
      let hasAnimated = false;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !hasAnimated) {
            hasAnimated = true;

            // Animate counter using live count (or fallback to static)
            animateCounter(livePlayerCount);

            // Animate progress bar
            const percentage = (livePlayerCount / PLAYERS_GOAL) * 100;
            setTimeout(() => {
              progressFillEl.style.width = percentage + "%";
            }, 100);

            // Update spots left (desktop and mobile button)
            updateSpotsRemaining(PLAYERS_GOAL - livePlayerCount, { animate: true });

            // Mark as played for re-entry animation consistency
            formPanel?.classList.add('has-played');
          }
        });
      }, { threshold: 0.3 });

      observer.observe(formPanel);

      // Form submission
      const form = document.getElementById("signup");
      const statusEl = document.getElementById("status");
      const successEl = document.getElementById("success");
      const submitBtn = document.getElementById("submitBtn");
      const waitingEl = document.getElementById("registrationWaiting");
      const formShell = document.getElementById("formShell");

      // === Form Validation ===
      // Email: RFC-compliant pattern
      function isValidEmail(email) {
        const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return pattern.test(email);
      }

      // Phone: US 10-digit format (strips non-digits, allows leading 1)
      function isValidPhone(phone) {
        const digitsOnly = phone.replace(/\D/g, '');
        // Accept 10 digits, or 11 digits if starts with 1
        if (digitsOnly.length === 10) return true;
        if (digitsOnly.length === 11 && digitsOnly.startsWith('1')) return true;
        return false;
      }

      // Generic field validator
      function validateField(input, validatorFn, errorMessage) {
        if (!input) return true;
        const value = input.value.trim();
        const isValid = validatorFn(value);

        if (isValid) {
          input.classList.remove('is-invalid');
          input.setCustomValidity('');
        } else {
          input.classList.add('is-invalid');
          input.setCustomValidity(errorMessage);
        }
        return isValid;
      }

      // Terms checkbox validator
      function validateTerms() {
        const termsInput = form?.querySelector('input[name="termsAccepted"]');
        const termsLabel = termsInput?.closest('.terms-checkbox');
        if (!termsInput) return true;

        const isValid = termsInput.checked;
        if (isValid) {
          termsLabel?.classList.remove('is-invalid');
          termsInput.setCustomValidity('');
        } else {
          termsLabel?.classList.add('is-invalid');
          termsInput.setCustomValidity('Please accept the terms');
        }
        return isValid;
      }

      // Full form validation
      function validateRegistrationForm() {
        const emailInput = form?.querySelector('input[name="email"]');
        const phoneInputEl = form?.querySelector('input[name="phone"]');

        const emailValid = validateField(emailInput, isValidEmail, 'Please enter a valid email address');
        const phoneValid = validateField(phoneInputEl, isValidPhone, 'Please enter a valid 10-digit phone number');
        const termsValid = validateTerms();

        return emailValid && phoneValid && termsValid;
      }

      // Real-time validation on blur
      const emailInputEl = form?.querySelector('input[name="email"]');
      const phoneInputEl = form?.querySelector('input[name="phone"]');
      const termsInputEl = form?.querySelector('input[name="termsAccepted"]');

      emailInputEl?.addEventListener('blur', () => {
        if (emailInputEl.value.trim()) {
          validateField(emailInputEl, isValidEmail, 'Please enter a valid email address');
        }
      }, { passive: true });

      phoneInputEl?.addEventListener('blur', () => {
        if (phoneInputEl.value.trim()) {
          validateField(phoneInputEl, isValidPhone, 'Please enter a valid 10-digit phone number');
        }
      }, { passive: true });

      termsInputEl?.addEventListener('change', () => {
        validateTerms();
      }, { passive: true });

      // Helper: Show waiting state with premium feel
      const showWaitingState = () => {
        // Fade out form smoothly
        formShell.style.transition = 'opacity 0.2s ease-out';
        formShell.style.opacity = '0';
        // Hide progress tracker and headline
        const headline = document.querySelector(".panel--form .panel-headline");
        const tracker = document.querySelector(".progress-tracker");
        if (headline) headline.style.transition = 'opacity 0.2s ease-out';
        if (headline) headline.style.opacity = '0';
        if (tracker) tracker.style.transition = 'opacity 0.2s ease-out';
        if (tracker) tracker.style.opacity = '0';

        setTimeout(() => {
          formShell.style.display = 'none';
          waitingEl.classList.add('is-visible');
        }, 200);
      };

      // Helper: Transition from waiting to success
	      const transitionToSuccess = (playerName, playerEmail = '') => {
	        // Flag to prevent back-to-top pip from activating during success screen
	        document.body.dataset.successActive = 'true';

        // Trigger subtle fade transition
        waitingEl.classList.add('is-transitioning');

        // Transition to success (smooth handoff)
        setTimeout(() => {
          waitingEl.classList.remove('is-visible', 'is-transitioning');
          waitingEl.style.display = 'none';
          successEl.classList.add('is-visible');
          statusEl.textContent = '';

	          // Mark user as registered
	          localStorage.setItem('cdl_registered', 'true');
	          if (playerEmail) {
	            try {
	              localStorage.setItem('cdl_mesa_last_email', String(playerEmail).trim().toLowerCase());
	            } catch {}
	          }

	          // Let the ticker react immediately on this device (even if Supabase isn't configured).
	          window.dispatchEvent(new CustomEvent('cdl:new-registration', {
	            detail: { playerName, clientId: CLIENT_ID }
	          }));

	          // Broadcast to ticker
		          if (supabase && playerName) {
		            supabase.channel('registrations').send({
		              type: 'broadcast',
		              event: 'new-registration',
		              payload: { playerName, clientId: CLIENT_ID }
		            });
		          }
		
		          // Post-register: drop them straight into La Mesa (no extra click).
		          // This triggers the same flow as the success screen CTA.
		          try {
		            const cta = document.getElementById('successMesaCta');
		            if (cta) cta.click();
		          } catch {}

	          // Hide everything for clean full-screen takeover
	          document.querySelector(".panel--form .panel-headline").style.display = "none";
	          document.querySelector(".progress-tracker").style.display = "none";
          const footer = document.querySelector(".footer-note");
          if (footer) footer.style.display = "none";
        }, 600); // Warm wash timing - success appears during wash clearing
      };

      // Helper: Return to form on error
      const returnToForm = (errorMessage) => {
        waitingEl.classList.remove('is-visible', 'is-transitioning');
        waitingEl.style.display = 'none';
        formShell.style.display = 'block';
        formShell.style.opacity = '1';
        const headline = document.querySelector(".panel--form .panel-headline");
        const tracker = document.querySelector(".progress-tracker");
        if (headline) headline.style.opacity = '1';
        if (tracker) tracker.style.opacity = '1';
        statusEl.textContent = errorMessage;
        submitBtn.disabled = false;
      };

      // DEV ONLY: Test success screen without submitting form
      // Call window.testSuccess() from console to trigger
      window.testSuccess = () => {
        showWaitingState();
        setTimeout(() => transitionToSuccess('Test Player'), 1500);
        console.log('✅ Success screen triggered. localStorage set.');
      };
      // DEV ONLY: Reset registration state
      window.testReset = () => {
        localStorage.removeItem('cdl_registered');
        location.reload();
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        // Run custom validation first
        if (!validateRegistrationForm()) {
          // Focus first invalid field
          const firstInvalid = form.querySelector('.is-invalid, input:invalid');
          firstInvalid?.focus();
          return;
        }

        // Then check native HTML5 validation
        if (!form.reportValidity()) return;

        // Disable button immediately
        submitBtn.disabled = true;
        statusEl.textContent = "";

        // Show waiting state (premium loading)
        showWaitingState();

        const payload = Object.fromEntries(new FormData(form).entries());
        const startTime = Date.now();
        const MIN_WAIT_TIME = 1500; // Minimum 1.5s for premium feel

        try {
          const response = await fetch("/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await response.json().catch(() => ({}));

          if (data && data.ok) {
            form.reset();

            // Ensure minimum wait time for premium feel
            const elapsed = Date.now() - startTime;
            const remainingWait = Math.max(0, MIN_WAIT_TIME - elapsed);

            setTimeout(() => {
              transitionToSuccess(payload.playerName, payload.email);
            }, remainingWait);
          } else {
            // Error - return to form
            const elapsed = Date.now() - startTime;
            const remainingWait = Math.max(0, 500 - elapsed); // Brief pause before showing error
            setTimeout(() => {
              returnToForm("Error. Try again or contact the host.");
            }, remainingWait);
          }
        } catch (error) {
          // Network error - return to form
          const elapsed = Date.now() - startTime;
          const remainingWait = Math.max(0, 500 - elapsed);
          setTimeout(() => {
            returnToForm("Network error. Please try again.");
          }, remainingWait);
        }
      });

      // Music Toggle - Desktop only
      const musicToggle = document.getElementById('musicToggle');
      const bgMusic = document.getElementById('bgMusic');
      let isPlaying = false;

      bgMusic.volume = 0.08;

      musicToggle.addEventListener('click', function() {
        musicToggle.classList.add('collapsed');

        if (isPlaying) {
          bgMusic.pause();
          musicToggle.classList.remove('is-playing');
          isPlaying = false;
        } else {
          bgMusic.volume = 0;
          bgMusic.play();
          // Fade in
          let vol = 0;
          const fadeIn = setInterval(() => {
            vol += 0.004;
            if (vol >= 0.08) {
              bgMusic.volume = 0.08;
              clearInterval(fadeIn);
            } else {
              bgMusic.volume = vol;
            }
          }, 25);
          musicToggle.classList.add('is-playing');
          isPlaying = true;
        }
      });

      // Smooth volume fade
      function fadeAudio(audio, targetVolume, duration, callback) {
        const startVolume = audio.volume;
        const volumeDiff = targetVolume - startVolume;
        const steps = 20;
        const stepTime = duration / steps;
        let currentStep = 0;

        const fadeInterval = setInterval(() => {
          currentStep++;
          audio.volume = Math.max(0, Math.min(1, startVolume + (volumeDiff * (currentStep / steps))));

          if (currentStep >= steps) {
            clearInterval(fadeInterval);
            audio.volume = targetVolume;
            if (callback) callback();
          }
        }, stepTime);
      }

      // ========================================
      // WHO'S IN - Load registered players
      // ========================================
      let registeredPlayers = [];

      // DEV ONLY: Mock players for local testing
      const MOCK_PLAYERS = [
        { name: 'Erik Rodriguez' },
        { name: 'Jordan Martinez' },
        { name: 'Carlos Fernández' },
        { name: 'Maria Santos' },
        { name: 'Luis Herrera' },
        { name: 'Ana García' },
      ];

      async function loadPlayers() {
        const chatPlayerSelect = document.getElementById('chatPlayerSelect');

	        try {
	          const response = await fetch('/api/players');
	          const data = await response.json();
	          // Use mock data if API returns empty or errors
	          registeredPlayers = (data.players && data.players.length > 0) ? data.players : MOCK_PLAYERS;
	          livePlayerCount = registeredPlayers.length;

	          // Update progress counter
	          const playerCount = document.getElementById('playerCount');
	          const spotsLeft = document.getElementById('spotsLeft');
	          const spotsLeftButton = document.getElementById('spotsLeftButton');
          const progressFill = document.getElementById('progressFill');
          if (playerCount) playerCount.textContent = registeredPlayers.length;
          updateSpotsRemaining(PLAYERS_GOAL - registeredPlayers.length);
          if (progressFill) progressFill.style.width = `${(registeredPlayers.length / 16) * 100}%`;

	          // Populate chat player selector
	          const chatNameInput = document.getElementById('chatNameInput');

		          // La Mesa is login-required: never expose a name picker (prevents impersonation).
		          if (customSelect) customSelect.style.display = 'none';
		          if (chatPlayerSelect) chatPlayerSelect.style.display = 'none';
		          if (chatNameInput) chatNameInput.style.display = 'none';
		        } catch (err) {
	          console.error('Failed to load players, using mock data:', err);
	          // On error, use mock data for local dev testing
	          registeredPlayers = MOCK_PLAYERS;
	          livePlayerCount = registeredPlayers.length;
		          const chatNameInput = document.getElementById('chatNameInput');
			          // Keep name pickers hidden (La Mesa is login-required).
		          if (customSelect) customSelect.style.display = 'none';
		          if (chatPlayerSelect) chatPlayerSelect.style.display = 'none';
		          if (chatNameInput) chatNameInput.style.display = 'none';
		        }
		      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ========================================
      // CUSTOM DROPDOWN LOGIC
      // ========================================
      const customSelect = document.getElementById('customSelect');
      const selectTrigger = document.getElementById('selectTrigger');
      const selectValue = document.getElementById('selectValue');
      const selectDropdown = document.getElementById('selectDropdown');
      const selectOptions = document.getElementById('selectOptions');
      const selectSearch = document.getElementById('selectSearch');
      let selectedPlayer = null;

      // Toggle dropdown
      selectTrigger?.addEventListener('click', () => {
        customSelect.classList.toggle('is-open');
        if (customSelect.classList.contains('is-open')) {
          selectSearch.focus();
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (customSelect && !customSelect.contains(e.target)) {
          customSelect.classList.remove('is-open');
        }
      });

      // Search/filter functionality
      selectSearch?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const options = selectOptions.querySelectorAll('.custom-select__option');
        let hasVisible = false;

        options.forEach(option => {
          const name = option.textContent.toLowerCase();
          if (name.includes(query)) {
            option.classList.remove('is-hidden');
            hasVisible = true;
          } else {
            option.classList.add('is-hidden');
          }
        });

        // Show/hide empty state
        let emptyEl = selectOptions.querySelector('.custom-select__empty');
        if (!hasVisible) {
          if (!emptyEl) {
            emptyEl = document.createElement('li');
            emptyEl.className = 'custom-select__empty';
            emptyEl.textContent = 'No matches found';
            selectOptions.appendChild(emptyEl);
          }
          emptyEl.style.display = 'block';
        } else if (emptyEl) {
          emptyEl.style.display = 'none';
        }
      });

      // Populate custom dropdown
      function populateCustomDropdown(players) {
        if (!selectOptions) return;

        // Hide search for small lists (less than 8 players)
        const searchContainer = document.querySelector('.custom-select__search');
        if (searchContainer) {
          searchContainer.style.display = players.length < 8 ? 'none' : 'block';
        }

        selectOptions.innerHTML = players.map(player =>
          `<li class="custom-select__option" data-value="${escapeHtml(player.name)}">${escapeHtml(player.name)}</li>`
        ).join('');

        // Add click handlers to options
        selectOptions.querySelectorAll('.custom-select__option').forEach(option => {
          option.addEventListener('click', () => {
            const value = option.dataset.value;
            selectPlayer(value);
          });
        });

        // Reset selected state
        if (selectValue) {
          selectValue.textContent = 'Select Your Name...';
          selectValue.classList.add('custom-select__value--placeholder');
        }
        selectedPlayer = null;
        const joinBtn = document.getElementById('chatJoinBtn');
        if (joinBtn) joinBtn.disabled = true;
      }

      // Select a player
      function selectPlayer(name) {
        selectedPlayer = name;

        // Update display
        selectValue.textContent = name;
        selectValue.classList.remove('custom-select__value--placeholder');

        // Update selected state
        selectOptions.querySelectorAll('.custom-select__option').forEach(opt => {
          opt.classList.toggle('is-selected', opt.dataset.value === name);
        });

        // Update hidden native select for form compatibility
        if (chatPlayerSelect) {
          chatPlayerSelect.value = name;
        }

        // Enable the Enter button
        const joinBtn = document.getElementById('chatJoinBtn');
        if (joinBtn) joinBtn.disabled = false;

        // Close dropdown
        customSelect.classList.remove('is-open');
        selectSearch.value = '';
        selectOptions.querySelectorAll('.custom-select__option').forEach(opt => opt.classList.remove('is-hidden'));
      }

      // Keyboard navigation
      selectSearch?.addEventListener('keydown', (e) => {
        const visibleOptions = [...selectOptions.querySelectorAll('.custom-select__option:not(.is-hidden)')];
        const currentIndex = visibleOptions.findIndex(opt => opt.classList.contains('is-focused'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const nextIndex = currentIndex < visibleOptions.length - 1 ? currentIndex + 1 : 0;
          visibleOptions.forEach((opt, i) => opt.classList.toggle('is-focused', i === nextIndex));
          visibleOptions[nextIndex]?.scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          const prevIndex = currentIndex > 0 ? currentIndex - 1 : visibleOptions.length - 1;
          visibleOptions.forEach((opt, i) => opt.classList.toggle('is-focused', i === prevIndex));
          visibleOptions[prevIndex]?.scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const focused = visibleOptions.find(opt => opt.classList.contains('is-focused')) || visibleOptions[0];
          if (focused) selectPlayer(focused.dataset.value);
        } else if (e.key === 'Escape') {
          customSelect.classList.remove('is-open');
        }
      });

      // Highlight @mentions in chat messages
      function highlightMentions(text) {
        // Match @followed by word characters (letters, numbers, spaces in names)
        return text.replace(/@([A-Za-z0-9\s]+?)(?=\s|$|[.,!?])/g, '<span class="mention">@$1</span>');
      }

	      // Load players on page load
	      const playersReady = loadPlayers();

      // ========================================
      // MESA LIVE COUNT & CLAIMED SEATS
      // ========================================
      let claimedSeats = new Set(); // Players who have already joined the chat

      async function loadMesaStats() {
        const countEl = document.getElementById('mesaPlayerCount');
        if (!countEl) return;

        // Try to get active players from Supabase
        try {
          // Wait for Supabase to be ready
          if (typeof supabase === 'undefined' || !supabase) {
            // Show mock count for local dev
            countEl.textContent = '3';
            return;
          }

          // Get unique players who have posted messages (last 24 hours = active)
          const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
          const { data, error } = await supabase
            .from('messages')
            .select('player_name')
            .gte('created_at', oneDayAgo);

          if (error) throw error;

          // Get unique player names
          const uniquePlayers = [...new Set(data.map(m => m.player_name))];
          claimedSeats = new Set(uniquePlayers);

          // Update count
          countEl.textContent = uniquePlayers.length.toString();

          // Refresh dropdown to filter out claimed seats
          if (registeredPlayers.length > 0) {
            const availablePlayers = registeredPlayers.filter(p => !claimedSeats.has(p.name));
            populateCustomDropdown(availablePlayers.length > 0 ? availablePlayers : registeredPlayers);
          }
        } catch (err) {
          console.error('Failed to load mesa stats:', err);
          // Show mock count
          countEl.textContent = '3';
        }
      }

      // Load mesa stats after a short delay (wait for Supabase init)
      setTimeout(loadMesaStats, 1500);

      // ========================================
      // CHAT - Supabase real-time chat
      // ========================================
	      // Chat state (declare early so it's available)
	      let chatIdentity = JSON.parse(localStorage.getItem('cdl_chat_identity') || 'null');
	      const CLIENT_ID = (() => {
	        try {
	          const key = 'cdl_client_id';
	          let id = localStorage.getItem(key);
	          if (!id) {
	            id = (typeof crypto !== 'undefined' && crypto.randomUUID)
	              ? crypto.randomUUID()
	              : `${Date.now()}-${Math.random().toString(16).slice(2)}`;
	            localStorage.setItem(key, id);
	          }
	          return id;
	        } catch {
	          return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
	        }
	      })();
	      let unreadCount = 0;
	      let chatOpen = false;
	      let selectedAvatar = 'cuba'; // Default
	      let messagesChannel = null;
	      let registrationsChannel = null;
	      let announcementsChannel = null;
	      let lastSpeakerId = null; // Tobias: Track for "new voice" arrivals

      // Initialize Supabase
      let supabase = null;

      // Dynamically load Supabase script
      function loadSupabaseScript() {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/dist/umd/supabase.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

	      function initSupabase() {
	        if (window.supabase && !supabase) {
	          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
	          return true;
	        }
	        return !!supabase;
	      }

	      // Load Supabase and initialize (only if configured)
	      let supabaseReady = Promise.resolve(false);
	      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
	        supabaseReady = loadSupabaseScript()
	          .then(() => {
	            if (!initSupabase()) return false;
	            // Always listen for new registrations so the form + ticker can react in real-time.
	            subscribeToRegistrations();
	            if (chatIdentity) {
	              loadMessages();
	              subscribeToMessages();
	            }
	            return true;
	          })
	          .catch(err => {
	            console.error('Failed to load Supabase:', err);
	            return false;
	          });
	      }

      // ========================================
      // CHAT WIDGET LOGIC
      // ========================================
      const chatWidget = document.getElementById('chatWidget');
      const chatToggle = document.getElementById('chatToggle');
      const chatPanel = document.getElementById('chatPanel');
      const chatClose = document.getElementById('chatClose');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
	      const chatMessages = document.getElementById('chatMessages');
	      const chatIdentityScreen = document.getElementById('chatIdentity');
	      const chatBodyContainer = document.getElementById('chatBodyContainer');
	      const mesaEntry = document.getElementById('mesaEntry');
	      const mesaEntryFlag = document.getElementById('mesaEntryFlag');
	      const mesaEntryKicker = document.getElementById('mesaEntryKicker');
	      const mesaEntryName = document.getElementById('mesaEntryName');
	      const chatBadge = document.getElementById('chatBadge');
      const mesaPresenceBtn = document.getElementById('mesaPresenceBtn');
      const mesaHeaderStatusTextEl = document.getElementById('mesaHeaderStatusText');
      const mesaPresenceEl = document.getElementById('mesaPresence');
      const mesaPresenceBackdrop = document.getElementById('mesaPresenceBackdrop');
      const mesaPresenceClose = document.getElementById('mesaPresenceClose');
      const mesaPresenceList = document.getElementById('mesaPresenceList');
      const mesaRitualWho = document.getElementById('mesaRitualWho');
      const mesaLfgToggle = document.getElementById('mesaLfgToggle');
      const mesaQuickTalk = document.getElementById('mesaQuickTalk');
      // Hub-only controls (must be defined before any functions reference them).
      const mesaHubLfgToggle = document.getElementById('mesaHubLfgToggle');
      const hubCountdownEl = document.getElementById('mesaHubCountdown');
      const mesaSeatStrip = document.getElementById('mesaSeatStrip');
      const mesaSeatRow = document.getElementById('mesaSeatRow');
      const mesaSeatMore = document.getElementById('mesaSeatMore');

      // Leave modal elements - Tobias: Custom modal replaces browser confirm()
      const leaveModal = document.getElementById('leaveModal');
      const leaveModalStay = document.getElementById('leaveModalStay');
      const leaveModalLeave = document.getElementById('leaveModalLeave');

      // La Mesa registration flow elements
      const successMesaCta = document.getElementById('successMesaCta');
      const mesaTutorial = document.getElementById('mesaTutorial');
      const tutorialMesaCta = document.getElementById('tutorialMesaCta');
      const tutorialDismiss = document.getElementById('tutorialDismiss');

      const tickerChatBtn = document.getElementById('tickerChatBtn');
      const chatDockBtn = document.getElementById('chatDock');
      const MESA_DOCKED_KEY = 'cdl_mesa_docked_v2';
      let chatDocked = localStorage.getItem(MESA_DOCKED_KEY) === 'true';
      let mesaLookingForPartner = localStorage.getItem('cdl_mesa_lfg') === 'true';
      const MESA_LAST_EMAIL_KEY = 'cdl_mesa_last_email';

      // Mesa Auth (login required)
      let mesaAuthVerified = false;
      let mesaAuthUserId = null;
      let mesaAuthEmail = null;
      let mesaAuthPlayer = null;

	      const mesaAuthGate = document.getElementById('mesaAuthGate');
	      const mesaLoginReveal = document.getElementById('mesaLoginReveal');
	      const mesaLoginRow = document.getElementById('mesaLoginRow');
	      const mesaLoginEmail = document.getElementById('mesaLoginEmail');
	      const mesaLoginBtn = document.getElementById('mesaLoginBtn');
	      const mesaLoginStatus = document.getElementById('mesaLoginStatus');
      const mesaAuthSigned = document.getElementById('mesaAuthSigned');
      const mesaAuthedEmailEl = document.getElementById('mesaAuthedEmail');
      const mesaSignOutBtn = document.getElementById('mesaSignOutBtn');
      const mesaIdentityLocked = document.getElementById('mesaIdentityLocked');
      const mesaLockedName = document.getElementById('mesaLockedName');

      if (!localStorage.getItem(MESA_DOCKED_KEY)) {
        // Reset legacy docked preference so the hub opens full by default after the redesign.
        localStorage.removeItem('cdl_mesa_docked');
        localStorage.setItem(MESA_DOCKED_KEY, 'false');
        chatDocked = false;
      }

      function applyMesaLfgUI() {
        mesaLfgToggle?.setAttribute('aria-pressed', mesaLookingForPartner ? 'true' : 'false');
        mesaHubLfgToggle?.setAttribute('aria-pressed', mesaLookingForPartner ? 'true' : 'false');
      }
      applyMesaLfgUI();

      async function handleMesaLfgToggle() {
        mesaLookingForPartner = !mesaLookingForPartner;
        localStorage.setItem('cdl_mesa_lfg', mesaLookingForPartner ? 'true' : 'false');
        applyMesaLfgUI();
        vibrate(8);

        // Broadcast state via presence so the room can respond.
        try {
          if (presenceChannel && chatIdentity) {
            await presenceChannel.track({
              playerName: chatIdentity.playerName,
              teamName: chatIdentity.teamName,
              avatar: chatIdentity.avatar,
              joinedAt: new Date().toISOString(),
              docked: chatDocked,
              lookingForPartner: mesaLookingForPartner,
            });
          }
        } catch {}
      }

      mesaHubLfgToggle?.addEventListener('click', handleMesaLfgToggle);

      mesaRitualWho?.addEventListener('click', () => {
        if (mesaPresenceEl?.classList.contains('is-open')) closeMesaPresence();
        else openMesaPresence();
      });

      mesaLfgToggle?.addEventListener('click', handleMesaLfgToggle);

      mesaQuickTalk?.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-chip]');
        if (!btn || !chatInput) return;
        const chip = btn.getAttribute('data-chip');
        if (!chip) return;

        const current = chatInput.value;
        const needsSpace = current && !current.endsWith(' ') && !current.endsWith('\n');
        chatInput.value = current + (needsSpace ? ' ' : '') + chip + ' ';
        chatInput.dispatchEvent(new Event('input', { bubbles: true }));
        chatInput.focus();
        vibrate(5);
      });

      // Helper to reveal chat button with animation - Tobias: "No hard cuts"
      function revealChatButton(animate = true) {
        if (!tickerChatBtn) return;
        if (!tickerChatBtn.classList.contains('mesa-ticker__chat-btn--hidden')) return; // Already visible

        if (animate) {
          tickerChatBtn.classList.add('is-revealing');
          tickerChatBtn.classList.remove('mesa-ticker__chat-btn--hidden');

          // Clean up animation class after it completes
          setTimeout(() => {
            tickerChatBtn.classList.remove('is-revealing');
          }, 400);
        } else {
          tickerChatBtn.classList.remove('mesa-ticker__chat-btn--hidden');
        }
      }

      try {
        const lastEmail = localStorage.getItem(MESA_LAST_EMAIL_KEY);
        if (mesaLoginEmail && lastEmail && !mesaLoginEmail.value) mesaLoginEmail.value = lastEmail;
      } catch {}

	      function setMesaLoginStatus(text = '') {
	        if (mesaLoginStatus) mesaLoginStatus.textContent = text;
	      }

		      function setMesaLoginRowVisible(visible) {
		        if (!mesaLoginRow) return;
		        if (visible) {
		          mesaLoginRow.hidden = false;
		          mesaLoginRow.style.display = 'flex';
		          mesaLoginReveal?.setAttribute('aria-expanded', 'true');
		          try { mesaLoginEmail?.focus(); } catch {}
		        } else {
		          mesaLoginRow.hidden = true;
		          mesaLoginRow.style.display = 'none';
		          mesaLoginReveal?.setAttribute('aria-expanded', 'false');
		        }
		      }

	      function showMesaAuthGate({ message = '' } = {}) {
	        mesaAuthVerified = false;
	        mesaAuthUserId = null;
	        mesaAuthEmail = null;
	        mesaAuthPlayer = null;

	        if (mesaAuthGate) mesaAuthGate.style.display = 'block';
	        if (mesaAuthSigned) mesaAuthSigned.style.display = 'none';
	        if (mesaIdentityLocked) mesaIdentityLocked.style.display = 'none';

	        // Keep "Show them where you're from" and the flag moment for after the seat is verified.
	        const chatIdentitySubtitle = document.getElementById('chatIdentitySubtitle');
	        if (chatIdentitySubtitle) {
	          chatIdentitySubtitle.textContent = '';
	          chatIdentitySubtitle.style.display = 'none';
	        }
	        const mesaFlagPickerFrame = document.getElementById('mesaFlagPickerFrame');
	        if (mesaFlagPickerFrame) mesaFlagPickerFrame.style.display = 'none';
		        if (countryDisplay) countryDisplay.style.display = 'none';
		        const joinBtn = document.getElementById('chatJoinBtn');
		        if (joinBtn) {
		          joinBtn.style.display = 'none';
		          joinBtn.style.opacity = '';
		          joinBtn.style.visibility = '';
		        }

	        // Keep legacy name pickers hidden by default (La Mesa is login-required now).
	        if (customSelect) customSelect.style.display = 'none';
	        const chatPlayerSelect = document.getElementById('chatPlayerSelect');
	        const chatNameInput = document.getElementById('chatNameInput');
	        if (chatPlayerSelect) chatPlayerSelect.style.display = 'none';
	        if (chatNameInput) chatNameInput.style.display = 'none';

	        const chatRegisterHint = document.getElementById('chatRegisterHint');
	        if (chatRegisterHint) {
	          chatRegisterHint.innerHTML = 'Not registered yet? <a href="#signup" class="chat-identity__register-link" id="chatRegisterLink">Register first</a>';
	          chatRegisterHint.style.display = 'block';
	        }

	        setMesaLoginRowVisible(false);
	        setMesaLoginStatus(message);
	        try {
	          if (typeof updateJoinReadyState === 'function') updateJoinReadyState();
	        } catch {}
	      }

	      function showMesaAuthed({ email, playerName } = {}) {
	        if (mesaAuthGate) mesaAuthGate.style.display = 'none';
	        if (mesaAuthSigned) mesaAuthSigned.style.display = 'block';
	        if (mesaAuthedEmailEl) mesaAuthedEmailEl.textContent = email || '—';

	        if (mesaIdentityLocked) mesaIdentityLocked.style.display = 'block';
	        if (mesaLockedName) mesaLockedName.textContent = playerName || '—';

	        const chatIdentitySubtitle = document.getElementById('chatIdentitySubtitle');
	        if (chatIdentitySubtitle) {
	          chatIdentitySubtitle.textContent = "Show them where you're from.";
	          chatIdentitySubtitle.style.display = '';
	        }
	        const mesaFlagPickerFrame = document.getElementById('mesaFlagPickerFrame');
	        if (mesaFlagPickerFrame) mesaFlagPickerFrame.style.display = '';
		        if (countryDisplay) countryDisplay.style.display = '';
		        const joinBtn = document.getElementById('chatJoinBtn');
		        if (joinBtn) {
		          joinBtn.style.display = 'block';
		          joinBtn.style.opacity = '1';
		          joinBtn.style.visibility = 'visible';
		        }

	        const chatRegisterHint = document.getElementById('chatRegisterHint');
	        if (chatRegisterHint) {
	          // Keep the CTA as the primary object, not instruction copy.
	          chatRegisterHint.style.display = 'none';
	        }

	        // No name list once authenticated (prevents impersonation).
	        if (customSelect) customSelect.style.display = 'none';
	        const chatPlayerSelect = document.getElementById('chatPlayerSelect');
	        const chatNameInput = document.getElementById('chatNameInput');
	        if (chatPlayerSelect) chatPlayerSelect.style.display = 'none';
	        if (chatNameInput) chatNameInput.style.display = 'none';

        try {
          if (typeof updateJoinReadyState === 'function') updateJoinReadyState();
        } catch {}
      }

      async function ensureMesaAuth({ silent = false } = {}) {
        mesaAuthVerified = false;
        mesaAuthUserId = null;
        mesaAuthEmail = null;
        mesaAuthPlayer = null;

        const supabaseOk = await supabaseReady;
        if (!supabaseOk || !supabase) {
          if (!silent) showMesaAuthGate({ message: 'La Mesa is offline right now.' });
          return false;
        }

        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          if (!silent) showMesaAuthGate();
          return false;
        }

        mesaAuthUserId = session.user?.id || null;
        mesaAuthEmail = String(session.user?.email || '').trim().toLowerCase();
        if (!mesaAuthEmail) {
          try { await supabase.auth.signOut(); } catch {}
          if (!silent) showMesaAuthGate({ message: 'No email found for this session.' });
          return false;
        }

	        // Preferred: verify against Sheets via server (Sheets is source-of-truth).
	        // Fallback: local/dev direct check against Supabase `players`.
	        let player = null;
	        let verifyHit = false;
	        try {
	          const res = await fetch('/api/mesa/verify', {
	            method: 'GET',
	            headers: { authorization: `Bearer ${session.access_token}` },
	          });
	          verifyHit = true;
	          if (res.ok) {
	            const payload = await res.json().catch(() => null);
	            if (payload && typeof payload === 'object' && payload.player) player = payload.player;
	          } else if (res.status === 403) {
	            const payload = await res.json().catch(() => null);
	            const errCode = payload && typeof payload === 'object' ? String(payload.error || '') : '';
	            if (errCode === 'not_registered') {
	              try { await supabase.auth.signOut(); } catch {}
	              if (!silent) showMesaAuthGate({ message: 'Seat not found. Register first.' });
	              return false;
	            }
	          } else if (res.status !== 404) {
	            try { await supabase.auth.signOut(); } catch {}
	            if (!silent) showMesaAuthGate({ message: 'Could not verify your seat. Try again.' });
	            return false;
	          }
	        } catch {
	          // fall through to fallback
	        }

	        if (!player && !verifyHit) {
	          // If the endpoint isn't available, skip immediately to fallback.
	        }

	        if (!player) {
	          const { data, error } = await supabase
	            .from('players')
	            .select('id, name, email, status')
	            .eq('email', mesaAuthEmail)
	            .in('status', ['registered', 'confirmed'])
	            .maybeSingle();
	          if (!error) player = data;
	        }

	        if (!player) {
	          try { await supabase.auth.signOut(); } catch {}
	          if (!silent) showMesaAuthGate({ message: 'Seat not found. Register first.' });
	          return false;
	        }

        mesaAuthPlayer = player;
        mesaAuthVerified = true;
        showMesaAuthed({ email: mesaAuthEmail, playerName: player.name });

        // Defensive: prevent stale/impersonated local identity from bypassing auth.
        if (chatIdentity && chatIdentity.playerName && chatIdentity.playerName !== player.name) {
          chatIdentity = null;
          try { localStorage.removeItem('cdl_chat_identity'); } catch {}
        }

        try {
          if (typeof updateJoinReadyState === 'function') updateJoinReadyState();
        } catch {}

        return true;
      }

	      async function startMesaLogin(email) {
	        const cleaned = String(email || '').trim().toLowerCase();
	        if (!cleaned) return;

	        const supabaseOk = await supabaseReady;
	        if (!supabaseOk || !supabase) {
	          showMesaAuthGate({ message: 'La Mesa is offline right now.' });
	          return;
	        }

	        if (mesaLoginBtn) mesaLoginBtn.disabled = true;
		        setMesaLoginStatus('Sending Table Key…');

	        try {
	          try { localStorage.setItem(MESA_LAST_EMAIL_KEY, cleaned); } catch {}
		          // Preferred: send a branded Table Key email via server (Apps Script + Supabase admin link).
		          // Only fall back to Supabase OTP when running locally (dev convenience).
		          const isLocal =
		            window.location.hostname === 'localhost'
		            || window.location.hostname === '127.0.0.1'
		            || window.location.hostname.endsWith('.local');

		          try {
		            const res = await fetch('/api/mesa/table-key', {
		              method: 'POST',
		              headers: { 'content-type': 'application/json' },
		              body: JSON.stringify({ email: cleaned }),
		            });

		            if (res.ok) {
		              setMesaLoginStatus('Check your email for your Table Key.');
		              return;
		            }

		            if (!isLocal) {
		              const payload = await res.json().catch(() => null);
		              const errCode = payload && typeof payload === 'object' ? String(payload.error || '') : '';
		              if (errCode === 'not_registered') {
		                setMesaLoginStatus('Seat not found. Register first.');
		              } else {
		                setMesaLoginStatus('Could not send Table Key. Try again.');
		              }
		              return;
		            }
		          } catch {
		            if (!isLocal) {
		              setMesaLoginStatus('Could not send Table Key. Try again.');
		              return;
		            }
		          }

		          const redirectOrigin = (() => {
		            const host = String(window.location.hostname || '');
		            const isLocalHost = host === 'localhost' || host === '127.0.0.1';
		            // Keep local Table Key redirects stable even if the browser is on a different loopback origin.
		            // (Prevents “link opens but localhost refuses” when ports drift during testing.)
		            if (isLocalHost) return `${window.location.protocol}//localhost:3005`;
		            return window.location.origin;
		          })();
		          const redirectTo = `${redirectOrigin}/mesa/callback`;
	          const { error } = await supabase.auth.signInWithOtp({
	            email: cleaned,
	            options: { emailRedirectTo: redirectTo },
	          });
	          if (error) setMesaLoginStatus(error.message || 'Could not send Table Key.');
	          else setMesaLoginStatus('Check your email for your Table Key.');
	        } catch (err) {
	          console.error('[MESA_AUTH] signInWithOtp error:', err);
	          setMesaLoginStatus('Could not send Table Key. Try again.');
	        } finally {
	          if (mesaLoginBtn) mesaLoginBtn.disabled = false;
	        }
	      }

	      mesaLoginBtn?.addEventListener('click', async () => {
	        await startMesaLogin(mesaLoginEmail?.value);
	      });

	      mesaLoginReveal?.addEventListener('click', () => {
	        const isHidden = !!mesaLoginRow?.hidden;
	        setMesaLoginRowVisible(isHidden);
	        if (isHidden) setMesaLoginStatus('');
	      });

	      mesaLoginEmail?.addEventListener('keydown', (e) => {
	        if (e.key === 'Enter') {
	          e.preventDefault();
	          void startMesaLogin(mesaLoginEmail?.value);
        }
      });

      mesaSignOutBtn?.addEventListener('click', async () => {
        try {
          if (supabase) await supabase.auth.signOut();
        } catch {}
        showMesaAuthGate({ message: 'Signed out.' });
      });

      function applyChatPresentation(mode) {
        const isPeek = mode === 'peek';
        chatDocked = isPeek;
        localStorage.setItem(MESA_DOCKED_KEY, isPeek ? 'true' : 'false');
        chatDockBtn?.setAttribute('aria-pressed', isPeek ? 'true' : 'false');
        if (chatDockBtn) {
          chatDockBtn.setAttribute('aria-label', isPeek ? 'Expand La Mesa' : 'Dock La Mesa (second screen)');
          const labelEl = chatDockBtn.querySelector('.chat-header__dock-label');
          if (labelEl) labelEl.textContent = isPeek ? 'Expand' : 'Dock';
        }

        chatPanel.classList.toggle('is-peek', isPeek);

        if (isPeek) {
          chatBackdrop?.classList.remove('is-visible');
          mesaTicker?.classList.remove('ticker-dimmed');
          document.body.classList.remove('chat-open');
        } else {
          chatBackdrop?.classList.add('is-visible');
          mesaTicker?.classList.add('ticker-dimmed');
          if (window.innerWidth <= 768) document.body.classList.add('chat-open');
        }

        // Keep presence metadata honest for second-screen mode.
        try {
          if (presenceChannel && chatIdentity) {
            presenceChannel.track({
              playerName: chatIdentity.playerName,
              teamName: chatIdentity.teamName,
              avatar: chatIdentity.avatar,
              joinedAt: new Date().toISOString(),
              docked: chatDocked,
              lookingForPartner: mesaLookingForPartner,
            });
          }
        } catch {}
      }

      async function openMesa(mode = (chatDocked ? 'peek' : 'full')) {
        console.log('[OPEN_MESA] Opening La Mesa, mode:', mode, 'chatIdentity:', chatIdentity);
        // Auth gate: La Mesa is login-required
        const authed = await ensureMesaAuth({ silent: false });
        if (!authed) {
          console.log('[OPEN_MESA] Not authenticated/verified, showing auth gate');
          chatPanel.style.display = 'flex';
          void chatPanel.offsetWidth;
          chatPanel.classList.add('is-open', 'is-identity-mode');
          chatPanel.scrollTop = 0;
          if (chatIdentityScreen) chatIdentityScreen.style.display = 'flex';
          if (chatBodyContainer) chatBodyContainer.style.display = 'none';
          applyChatPresentation('full');
          return;
        }

        revealChatButton(true);
        chatPanel.style.display = 'flex';
        void chatPanel.offsetWidth;
        chatPanel.classList.add('is-open');
        // The panel itself should never scroll (header/hub must stay pinned).
        chatPanel.scrollTop = 0;
        
        // Show identity mode (hide header/seats) if user hasn't claimed seat yet
        if (!chatIdentity) {
          console.log('[OPEN_MESA] No identity, adding is-identity-mode');
          chatPanel.classList.add('is-identity-mode');
          if (chatIdentityScreen) chatIdentityScreen.style.display = 'flex';
          if (chatBodyContainer) chatBodyContainer.style.display = 'none';
        } else {
          console.log('[OPEN_MESA] Has identity, removing is-identity-mode');
          chatPanel.classList.remove('is-identity-mode');
          if (chatIdentityScreen) chatIdentityScreen.style.display = 'none';
          if (chatBodyContainer) chatBodyContainer.style.display = 'flex';
        }
        console.log('[OPEN_MESA] Panel classes:', chatPanel.className);
        
        const params = new URLSearchParams(window.location.search);
        const forcePeek = params.has('mesaPeek');
        const resolvedMode = (!forcePeek && window.innerWidth <= 768) ? 'full' : mode;
        applyChatPresentation(resolvedMode);

        // For returning users with saved identity, load messages and join presence
        if (chatIdentity && supabase) {
          loadMessages();
          subscribeToMessages();
          joinMesaPresence();
        }

        // Optional: force the entry ritual for debugging via ?mesaRitual=1
        if (params.has('mesaRitual')) {
          setTimeout(() => {
            if (chatIdentity) enterLaMesaRitual();
          }, 80);
        }
      }

      function closeMesa() {
        chatPanel.classList.remove('is-open', 'is-peek');
        chatPanel.scrollTop = 0;
        chatBackdrop?.classList.remove('is-visible');
        mesaTicker?.classList.remove('ticker-dimmed');
        document.body.classList.remove('chat-open');
        closeMesaPresence();
      }

      // ========================================
      // PRESENCE LIST UI — "Who’s here"
      // ========================================
      let lastMesaPresenceState = {};

      function getMesaPresenceUsers(state) {
        const users = [];
        if (!state) return users;
        for (const presences of Object.values(state)) {
          if (Array.isArray(presences) && presences[0]) users.push(presences[0]);
        }
        users.sort((a, b) => String(a.playerName || '').localeCompare(String(b.playerName || '')));
        return users;
      }

      function updateMesaHeaderPresence(state) {
        const liveCount = getMesaPresenceUsers(state).length;
        if (mesaHeaderStatusTextEl) mesaHeaderStatusTextEl.textContent = `${liveCount} at the table`;
      }

      function renderMesaPresenceList() {
        if (!mesaPresenceList) return;
        const users = getMesaPresenceUsers(lastMesaPresenceState);

        if (users.length === 0) {
          const copy = (!presenceChannel || !chatIdentity)
            ? 'Join La Mesa to see who’s here.'
            : 'No one’s in the room yet.';
          mesaPresenceList.innerHTML = `<div class="mesa-presence__empty">${copy}</div>`;
          return;
        }

        mesaPresenceList.innerHTML = users.map((user) => {
          const playerName = user.playerName || '';
          const isSelf = chatIdentity && playerName === chatIdentity.playerName;
          const emoji = (typeof FLAG_MAP !== 'undefined' && FLAG_MAP[user.avatar]) ? FLAG_MAP[user.avatar] : '🇨🇺';
          const lfg = user.lookingForPartner ? '<span class="mesa-presence__badge">LFG</span>' : '';

          return `
            <div class="mesa-presence__row" data-player="${escapeHtml(playerName)}">
              <div class="mesa-presence__who">
                <div class="mesa-presence__flag">${emoji}</div>
                <div class="mesa-presence__name">${escapeHtml(playerName || '—')}</div>
              </div>
              <div class="mesa-presence__badges">
                ${lfg}
                ${(!isSelf && playerName) ? `
                  <button class="mesa-presence__invite" type="button" data-invite="${escapeHtml(playerName)}" aria-label="Invite ${escapeHtml(playerName)}">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                      <path d="M12 5v14"/>
                      <path d="M5 12h14"/>
                    </svg>
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      function openMesaPresence() {
        if (!mesaPresenceEl) return;
        mesaPresenceEl.classList.add('is-open');
        mesaPresenceEl.setAttribute('aria-hidden', 'false');
        renderMesaPresenceList();
        vibrate(5);
      }

      function closeMesaPresence() {
        if (!mesaPresenceEl) return;
        mesaPresenceEl.classList.remove('is-open');
        mesaPresenceEl.setAttribute('aria-hidden', 'true');
      }

      mesaPresenceBtn?.addEventListener('click', () => {
        if (mesaPresenceEl?.classList.contains('is-open')) closeMesaPresence();
        else openMesaPresence();
      });
      mesaPresenceBackdrop?.addEventListener('click', closeMesaPresence);
      mesaPresenceClose?.addEventListener('click', closeMesaPresence);

      // Click actions in list: tap row to @mention, tap Invite to send invite
      mesaPresenceList?.addEventListener('click', (e) => {
        const inviteBtn = e.target.closest('[data-invite]');
        if (inviteBtn) {
          const toPlayer = inviteBtn.getAttribute('data-invite');
          if (toPlayer) {
            if (typeof window.sendTeamInvite === 'function') window.sendTeamInvite(toPlayer);
            else if (typeof sendTeamInvite === 'function') sendTeamInvite(toPlayer);
          }
          return;
        }

        const row = e.target.closest('[data-player]');
        const player = row?.getAttribute('data-player');
        if (!player || !chatInput) return;
        const trimmed = chatInput.value.trim();
        chatInput.value = (trimmed ? `${trimmed} ` : '') + `@${player} `;
        chatInput.focus();
      });

      // Success CTA: Close success overlay, open chat
      if (successMesaCta) {
        successMesaCta.addEventListener('click', () => {
          successEl.classList.remove('is-visible');
          void openMesa();
          // The confirmation email is the primary Table Key. Don't spam more OTP emails here.
          showMesaAuthGate({ message: 'Check your email for your Table Key.' });
        });
      }

      // Track if user opened La Mesa from success screen
      let openedFromSuccess = false;
      if (successMesaCta) {
        successMesaCta.addEventListener('click', () => {
          openedFromSuccess = true;
        });
      }

      // Show tutorial if user dismisses success without clicking La Mesa
      // Listen for clicks outside success content area
      if (successEl) {
        successEl.addEventListener('click', (e) => {
          // Only trigger if clicking the backdrop, not the content
          if (e.target === successEl && !openedFromSuccess) {
            successEl.classList.remove('is-visible');
            // Show tutorial after short delay
            setTimeout(() => {
              if (mesaTutorial) {
                mesaTutorial.classList.add('is-visible');
              }
            }, 300);
          }
        });
      }

      // Tutorial CTA: Join the table
      if (tutorialMesaCta) {
        tutorialMesaCta.addEventListener('click', () => {
          mesaTutorial.classList.remove('is-visible');
          openMesa();
        });
      }

      // Tutorial Dismiss: Just show the button, don't open chat
      if (tutorialDismiss) {
        tutorialDismiss.addEventListener('click', () => {
          mesaTutorial.classList.remove('is-visible');
          revealChatButton(true); // Animate the reveal
        });
      }

      // Haptics Helper
      const vibrate = (pattern = 5) => {
        if (navigator.vibrate) navigator.vibrate(pattern);
      };

      const chatBackdrop = document.getElementById('chatBackdrop');
      const mesaTicker = document.getElementById('mesaTicker');
      const mesaHelp = document.getElementById('mesaHelp');
      const mesaHelpDismiss = document.getElementById('mesaHelpDismiss');
      let mesaHelpTimeout = null;
      const registrationPanel = document.querySelector('.panel--form');
      let lastTickerActivateAt = 0;
      const mesaTipParams = new URLSearchParams(window.location.search);
      const mesaTipVariant = mesaTipParams.get('mesaTip');
      const mesaTipPreview = mesaTipParams.has('mesaTipPreview');

      // Default to the chosen direction: "Broadcast" (guide + hype), overridable for concept previews.
      const DEFAULT_MESA_TOOLTIP = 'broadcast';
      const resolvedMesaTipVariant =
        mesaTipVariant && ['plaque', 'broadcast', 'whisper'].includes(mesaTipVariant)
          ? mesaTipVariant
          : DEFAULT_MESA_TOOLTIP;
      document.documentElement.dataset.mesaTooltip = resolvedMesaTipVariant;

      function getPanelVisibilityRatio(panelEl) {
        if (!storyEl || !panelEl) return 0;
        const storyRect = storyEl.getBoundingClientRect();
        const panelRect = panelEl.getBoundingClientRect();
        const visibleTop = Math.max(storyRect.top, panelRect.top);
        const visibleBottom = Math.min(storyRect.bottom, panelRect.bottom);
        const visible = Math.max(0, visibleBottom - visibleTop);
        return panelRect.height > 0 ? visible / panelRect.height : 0;
      }

      function isRegistrationPanelActive() {
        return getPanelVisibilityRatio(registrationPanel) >= 0.7;
      }

	      function showMesaHelp({ force = false } = {}) {
	        if (!mesaHelp) return;
	        // Only show this bubble while the registration panel is actually on screen.
	        if (!force && !isRegistrationPanelActive()) return;
	        if (mesaHelpTimeout) clearTimeout(mesaHelpTimeout);
	        mesaHelp.classList.add('is-visible');
	        mesaHelpTimeout = setTimeout(() => {
	          mesaHelp.classList.remove('is-visible');
	          mesaHelpTimeout = null;
	        }, 6500);
	      }

	      function hideMesaHelp() {
	        if (!mesaHelp) return;
	        if (mesaHelpTimeout) clearTimeout(mesaHelpTimeout);
	        mesaHelpTimeout = null;
	        mesaHelp.classList.remove('is-visible');
	      }

        if (mesaTipPreview) {
          setTimeout(() => showMesaHelp({ force: true }), 650);
        }

	      // Make the bubble feel like a toast, not a modal: tapping it dismisses immediately.
	      mesaHelp?.addEventListener('click', hideMesaHelp);
	      mesaHelpDismiss?.addEventListener('click', hideMesaHelp);

	      // Dismiss tooltip when clicking the domino button (only if registered)
	      tickerChatBtn?.addEventListener('click', () => {
	        // Only hide tooltip when user is registered (opening chat)
	        // Unregistered users get routed to form where tooltip should show
	        if (localStorage.getItem('cdl_registered') === 'true') {
	          hideMesaHelp();
	        }
	      });

	      // Dismiss tooltip when clicking anywhere outside it
	      document.addEventListener('click', (e) => {
	        if (!mesaHelp?.classList.contains('is-visible')) return;
	        // Don't dismiss if clicking inside the tooltip itself
	        if (mesaHelp.contains(e.target)) return;
	        // Don't dismiss if clicking the domino button (handled separately)
	        if (tickerChatBtn?.contains(e.target)) return;
	        hideMesaHelp();
	      });

      storyEl?.addEventListener(
        'scroll',
        () => {
          if (!isRegistrationPanelActive()) hideMesaHelp();
        },
        { passive: true }
      );

      // Toggle Chat & Scroll Lock
      function toggleChat() {
        const isOpen = chatPanel.classList.contains('is-open');

        if (isOpen) {
          closeMesa();
          vibrate(5);
        } else {
          // Open (honor last mode)
          void openMesa(chatDocked ? 'peek' : 'full');

          // Tobias: Clear unread state when entering the room
          tickerChatBtn.classList.remove('has-unread');
          if (chatBadge) chatBadge.style.display = 'none';
          unreadCount = 0;
          vibrate(10);

	          // Re-initialize spacers now that panel is visible
	          setTimeout(() => {
	            if (window.updateSpacerWidth) window.updateSpacerWidth();
	            const cubaFlag = document.querySelector('[data-avatar="cuba"]');
	            if (cubaFlag) centerAvatarOption(cubaFlag, 'instant');
	          }, 50);

          // Peek mode is "chat-first"; full mode is "hub-first" (don't auto-scroll the panel).
          if (chatBodyContainer && chatBodyContainer.style.display !== 'none' && chatPanel.classList.contains('is-peek')) {
             setTimeout(() => chatInput.focus(), 100);
          }
        }
      }

      function updateHubCountdown() {
        if (!hubCountdownEl) return 60000;

        const targetISO = hubCountdownEl.getAttribute('data-first-slam-at') || '';
        const targetDate = new Date(targetISO || '2026-01-31T19:00:00-05:00');
        const diff = targetDate.getTime() - Date.now();

        if (diff <= 0) {
          hubCountdownEl.textContent = '0M';
          return 60000;
        }

        const totalSeconds = Math.floor(diff / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        // Calm, human-readable countdown (avoid HH exceeding 99 like a "timer bug").
        if (days > 0) {
          hubCountdownEl.textContent = `${days}D ${String(hours).padStart(2, '0')}H ${String(minutes).padStart(2, '0')}M`;
          return 30000;
        }

        if (hours > 0) {
          hubCountdownEl.textContent = `${hours}H ${String(minutes).padStart(2, '0')}M`;
          return 30000;
        }

        if (minutes > 10) {
          hubCountdownEl.textContent = `${minutes}M`;
          return 10000;
        }

        hubCountdownEl.textContent = `${minutes}M ${String(seconds).padStart(2, '0')}S`;
        return 1000;
      }

      let hubCountdownTimer = null;
      function scheduleHubCountdown() {
        if (hubCountdownTimer) window.clearTimeout(hubCountdownTimer);
        const next = updateHubCountdown();
        hubCountdownTimer = window.setTimeout(scheduleHubCountdown, next);
      }
      scheduleHubCountdown();


      function renderMesaHubWhoList() {
        const hubWhoList = document.getElementById('mesaHubWhoList');
        if (!hubWhoList) return;

        const users = getMesaPresenceUsers(lastMesaPresenceState);
        if (users.length === 0) {
          hubWhoList.innerHTML = '<div class="mesa-hub-empty">Pull up a chair. You\'re among friends.</div>';
          return;
        }

        // Reuse the presence list row template (limit to keep the hub scannable)
        const visible = users.slice(0, 8);
        hubWhoList.innerHTML = visible.map((user) => {
          const playerName = user.playerName || '';
          const isSelf = chatIdentity && playerName === chatIdentity.playerName;
          const emoji = (typeof FLAG_MAP !== 'undefined' && FLAG_MAP[user.avatar]) ? FLAG_MAP[user.avatar] : '🇨🇺';
          const lfg = user.lookingForPartner ? '<span class="mesa-presence__badge">LFG</span>' : '';

          return `
            <div class="mesa-presence__row" data-player="${escapeHtml(playerName)}">
              <div class="mesa-presence__who">
                <div class="mesa-presence__flag">${emoji}</div>
                <div class="mesa-presence__name">${escapeHtml(playerName || '—')}</div>
              </div>
              <div class="mesa-presence__badges">
                ${lfg}
                ${(!isSelf && playerName) ? `
                  <button class="mesa-presence__invite" type="button" data-invite="${escapeHtml(playerName)}" aria-label="Invite ${escapeHtml(playerName)}">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                      <path d="M12 5v14"/>
                      <path d="M5 12h14"/>
                    </svg>
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');

        if (users.length > visible.length) {
          hubWhoList.innerHTML += `<div class="mesa-hub-more">+${users.length - visible.length} more in the room</div>`;
        }
      }

      function renderMesaSeatStrip() {
        if (!mesaSeatRow) return;
        const users = getMesaPresenceUsers(lastMesaPresenceState);
        if (users.length === 0) {
          mesaSeatRow.innerHTML = '<span class="mesa-seats__empty">Quiet right now.</span>';
          if (mesaSeatMore) mesaSeatMore.textContent = '0';
          return;
        }
        const visible = users.slice(0, 10);
        mesaSeatRow.innerHTML = visible.map((user) => {
          const emoji = (typeof FLAG_MAP !== 'undefined' && FLAG_MAP[user.avatar]) ? FLAG_MAP[user.avatar] : '🇨🇺';
          return `<span class="mesa-seat" aria-hidden="true">${emoji}</span>`;
        }).join('');
        if (mesaSeatMore) {
          const extra = users.length - visible.length;
          mesaSeatMore.textContent = extra > 0 ? `+${extra}` : `${users.length}`;
        }
      }

      mesaSeatStrip?.addEventListener('click', () => {
        openMesaPresence();
      });

      renderMesaSeatStrip();

      chatDockBtn?.addEventListener('click', () => {
        if (!chatPanel.classList.contains('is-open')) return;
        const nextMode = chatPanel.classList.contains('is-peek') ? 'full' : 'peek';
        applyChatPresentation(nextMode);
        vibrate(8);
      });

	      function routeUnregisteredToRegistration() {
	        // Ensure nothing can "fight" the teleport.
	        unlockScroll();
        whisperHasPlayed = true;
        buildHasPlayed = true;
        slamHasPlayed = true;
        rulesHasPlayed = true;
        whisperPanel?.classList.add('has-played');
        buildPanel?.classList.add('has-played');
        slamPanel?.classList.add('has-played');
        rulesPanel?.classList.add('has-played');

	        // Teleport to the registration panel - instant, no delay
	        if (registrationPanel) {
	          if (typeof snapToPanelTop === 'function') snapToPanelTop(registrationPanel);
	          else registrationPanel.scrollIntoView({ behavior: 'instant', block: 'start' });
	        }

	        // Show the prompt after teleport completes
	        requestAnimationFrame(() => {
	          showMesaHelp({ force: true });
	        });

	        // Reinforce once we're actually on the form panel.
	        let tries = 0;
	        const tryShow = () => {
	          tries += 1;
	          if (isRegistrationPanelActive()) {
	            showMesaHelp({ force: true });
	            if (submitBtn) {
	              submitBtn.classList.remove('is-unlock-hinted');
	              void submitBtn.offsetWidth;
	              submitBtn.classList.add('is-unlock-hinted');
	              setTimeout(() => submitBtn.classList.remove('is-unlock-hinted'), 1300);
	            }
	            return;
	          }
	          if (tries < 20) requestAnimationFrame(tryShow);
	        };
	        requestAnimationFrame(tryShow);
	      }

      function handleTickerActivate() {
        const now = Date.now();
        // Reduced debounce: 100ms prevents accidental double-taps while staying snappy
        if (now - lastTickerActivateAt < 100) return;
        lastTickerActivateAt = now;

        // If they haven't registered on this device and haven't ever tried to claim a seat,
        // treat the chat button as a "Register" shortcut (teleport + tooltip).
        // This keeps true first-time visitors out of the auth gate while still letting returning
        // players on new devices use "Resend Table Key" once they've entered an email at least once.
        try {
          const isRegisteredLocal = localStorage.getItem('cdl_registered') === 'true';
          const hasTriedMesaLogin = !!localStorage.getItem(MESA_LAST_EMAIL_KEY);
          const isChatOpen = chatPanel?.classList.contains('is-open');
          if (!isChatOpen && !isRegisteredLocal && !hasTriedMesaLogin) {
            routeUnregisteredToRegistration();
            return;
          }
        } catch {}

        toggleChat();
      }

      // Touch: use touchstart/touchend for reliable iOS Safari support
      // (pointerup doesn't fire if finger moves even slightly during tap)
      tickerChatBtn?.addEventListener('touchstart', (e) => {
        tickerChatBtn.classList.add('is-pressed');
        vibrate([8, 20, 12, 8, 4]); // Tobias: tap-pause-land-settle-rest (domino lands and settles)
      }, { passive: true });

      tickerChatBtn?.addEventListener('touchend', (e) => {
        tickerChatBtn.classList.remove('is-pressed');
        // Prevent the synthetic click from also firing
        e.preventDefault();
        handleTickerActivate();
      }, { passive: false });

      tickerChatBtn?.addEventListener('touchcancel', () => {
        tickerChatBtn.classList.remove('is-pressed');
      });

      // Mouse/keyboard: use click (more accessible, works with Enter key)
      // Touch already handled via touchend with preventDefault, so click only fires for mouse/keyboard
      tickerChatBtn?.addEventListener('click', (e) => {
        handleTickerActivate();
      });

      // Auto-open La Mesa after auth redirect (/mesa/callback -> /?mesa=1)
      try {
        const autoParams = new URLSearchParams(window.location.search);
        if (autoParams.get('mesa') === '1') {
          setTimeout(() => {
            void openMesa('full');
            // Clean the URL so refresh doesn't keep forcing entry.
            try {
              const url = new URL(window.location.href);
              url.searchParams.delete('mesa');
              window.history.replaceState({}, '', url.toString());
            } catch {}
          }, 120);
        }
      } catch {}

      // Visual feedback for mouse (iOS :active is unreliable, so we handle this manually)
      tickerChatBtn?.addEventListener('pointerdown', (e) => {
        if (e.pointerType === 'mouse') {
          tickerChatBtn.classList.add('is-pressed');
        }
      });
      tickerChatBtn?.addEventListener('pointerup', () => {
        tickerChatBtn.classList.remove('is-pressed');
      });
      tickerChatBtn?.addEventListener('pointerleave', () => {
        tickerChatBtn.classList.remove('is-pressed');
      });
      chatBackdrop.addEventListener('click', toggleChat);

      // Leave modal helpers - Tobias: "The room should never feel like a browser"
      function showLeaveModal() {
        leaveModal?.classList.add('is-open');
        vibrate(5);
      }

      function hideLeaveModal() {
        leaveModal?.classList.remove('is-open');
      }

      function executeLeaveTable() {
        // Leave presence and any live subscriptions tied to the current identity
        leaveMesaPresence();
        if (messagesChannel) {
          messagesChannel.unsubscribe();
          messagesChannel = null;
        }
        if (registrationsChannel) {
          registrationsChannel.unsubscribe();
          registrationsChannel = null;
        }

        // Reset identity
        chatIdentity = null;
        localStorage.removeItem('cdl_chat_identity');

        // Reset UI back to identity screen
        try {
          resetDropdown();
        } catch {}

        // Theatrical exit: brief fade before reset
        chatBodyContainer.style.opacity = '0';
        chatBodyContainer.style.transition = 'opacity 0.2s ease';

        setTimeout(() => {
          chatBodyContainer.style.display = 'none';
          chatBodyContainer.style.opacity = '1';
          chatIdentityScreen.style.display = 'flex';
          chatPanel.classList.add('is-identity-mode');
          chatSend.disabled = true;
          chatInput.value = '';

          // Clear message list for clean slate
          if (chatMessages) {
            chatMessages.innerHTML = '<div class="chat-empty">The calm before the storm.</div>';
          }

          hideLeaveModal();
          closeMesa();
        }, 200);
      }

      // Leave modal button handlers
      leaveModalStay?.addEventListener('click', () => {
        hideLeaveModal();
        vibrate(5);
      });

      leaveModalLeave?.addEventListener('click', () => {
        vibrate(10);
        executeLeaveTable();
      });

      // Click backdrop to stay (cancel)
      leaveModal?.querySelector('.leave-modal__backdrop')?.addEventListener('click', () => {
        hideLeaveModal();
      });

      // Leave the table: show custom modal instead of browser confirm
      chatClose.addEventListener('click', () => {
        // If user never joined, treat as a normal close
        if (!chatIdentity) {
          closeMesa();
          return;
        }

        showLeaveModal();
      });

	      // Register link in chat - close chat and scroll to registration
	      // (delegated so the hint can swap between "Register first" and "Pick your flag…" without breaking)
	      document.addEventListener('click', (e) => {
	        const target = e.target;
	        const link = target?.closest?.('#chatRegisterHint a[href="#signup"]');
	        if (!link) return;
	        e.preventDefault();
	        closeMesa();
	        // Scroll to registration form
	        const signupForm = document.getElementById('signup');
	        if (signupForm) signupForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
	      });

      // Swipe to Close (Mobile)
      let touchStartY = 0;
      let touchEndY = 0;

      chatPanel.addEventListener('touchstart', (e) => {
        touchStartY = e.changedTouches[0].screenY;
      }, {passive: true});

      chatPanel.addEventListener('touchmove', (e) => {
         // Prevent closing if scrolling messages
         if (chatMessages.contains(e.target) && chatMessages.scrollTop > 0) return;
         touchEndY = e.changedTouches[0].screenY;
      }, {passive: true});

      chatPanel.addEventListener('touchend', (e) => {
        touchEndY = e.changedTouches[0].screenY;
        const swipeDistance = touchEndY - touchStartY;
        
        // If swiped down more than 100px (and not scrolling messages)
        if (swipeDistance > 100 && (!chatMessages.contains(e.target) || chatMessages.scrollTop <= 0)) {
          // Full → Peek (second screen) before closing
          if (chatPanel.classList.contains('is-open') && !chatPanel.classList.contains('is-peek')) {
            applyChatPresentation('peek');
            vibrate(8);
            return;
          }
          closeMesa();
          vibrate(5);
        }

        // Swipe up in peek to expand
        if (swipeDistance < -80 && chatPanel.classList.contains('is-open') && chatPanel.classList.contains('is-peek')) {
          applyChatPresentation('full');
          vibrate(10);
        }
      });
      
      // Prevent background scroll when touching the chat on mobile
      const avatarSelectorEl = document.querySelector('.avatar-selector');
      chatPanel.addEventListener('touchmove', (e) => {
         // Allow scrolling in chat messages AND avatar selector (flag picker)
         if (!chatMessages.contains(e.target) && !avatarSelectorEl?.contains(e.target)) {
            e.preventDefault();
         }
      }, {passive: false});


      // Identity State (Continued)

	      // Avatar selection - Tobias: "Does picking your seat feel like pulling up a chair?"
	      const avatarOptions = document.querySelectorAll('.avatar-option');
	      const avatarSelector = document.querySelector('.avatar-selector');

      // Country display elements - Olympic ceremony style
      const countryDisplay = document.getElementById('mesaCountryDisplay');
      const countryNameEl = document.getElementById('countryName');
      const countryHintEl = document.getElementById('countryHint');
      let isCountryConfirmed = false;

      // Scroll polish: subtle "magnetic" settle + centered focus (minimal, no UI chrome)
      let avatarScrollEndTimer = null;
      let avatarScrollRaf = null;
      let avatarPointerDown = false;
      let centeredAvatar = null;
      let suppressSettleHapticUntil = 0;

      // Update country name display
	      function updateCountryDisplay(countryName, isConfirmed = false) {
	        if (!countryNameEl || !countryHintEl) return;

        countryNameEl.textContent = countryName || '';
        countryNameEl.classList.toggle('is-visible', !!countryName);
        countryHintEl.classList.toggle('is-visible', !!countryName && !isConfirmed);

        if (isConfirmed) {
          countryDisplay?.classList.add('is-confirmed');
          countryHintEl.textContent = 'Representing';
          countryHintEl.classList.add('is-visible');
          setTimeout(() => countryDisplay?.classList.remove('is-confirmed'), 400);
        } else {
          countryHintEl.textContent = 'Tap to represent';
	        }
	      }

	      function getAvatarRingCenterX() {
	        const selectorRect = avatarSelector?.getBoundingClientRect();
	        if (selectorRect) return selectorRect.left + (selectorRect.width / 2);
	        return null;
	      }

	      function getAvatarOptionCenterX(opt) {
	        if (!opt) return null;
	        const img = opt.querySelector?.('.avatar-flag-img');
	        const rect = (img || opt).getBoundingClientRect?.();
	        if (!rect) return null;
	        return rect.left + (rect.width / 2);
	      }

	      function getAvatarOptionCenterDeltaFromRing(opt) {
	        if (!opt) return 0;
	        const ringCenterX = getAvatarRingCenterX();
	        if (ringCenterX == null) return 0;
	        const centerX = getAvatarOptionCenterX(opt);
	        if (centerX == null) return 0;
	        return centerX - ringCenterX;
	      }

	      function centerAvatarOption(opt, behavior = 'smooth') {
	        if (!avatarSelector || !opt) return;
	        // First ask the browser to center the item (Safari tends to respect this more reliably),
	        // then do a tiny pixel correction so the flag image center matches the ring center.
	        const normalizedBehavior = behavior === 'instant' ? 'auto' : behavior;
	        if (behavior !== 'instant') {
	          try {
	            opt.scrollIntoView({ behavior: normalizedBehavior, inline: 'center', block: 'nearest' });
	          } catch {}
	        }

	        const correct = () => {
	          const delta = getAvatarOptionCenterDeltaFromRing(opt);
	          if (!Number.isFinite(delta)) return;
	          if (Math.abs(delta) < 0.5) return;
	          avatarSelector.scrollTo({
	            left: avatarSelector.scrollLeft + delta,
	            behavior: 'auto',
	          });
	        };

	        requestAnimationFrame(correct);
	        if (behavior !== 'instant') setTimeout(correct, 120);
	      }

	      avatarOptions.forEach(opt => {
	        opt.addEventListener('click', () => {
	          if (opt.dataset.avatar === selectedAvatar && opt.classList.contains('selected')) return;

          // Remove selected from others (keep the chosen one stable)
          avatarOptions.forEach(o => {
            if (o !== opt) o.classList.remove('selected');
            o.classList.remove('is-slamming');
          });

          // Restart slam cleanly in the same frame as selection to avoid "double flicker" on iOS
          opt.classList.remove('is-slamming');
          // Force reflow so the animation reliably restarts
          void opt.offsetWidth;
	          opt.classList.add('selected');
	          opt.classList.add('is-slamming');
	          vibrate([8, 20, 8]); // Tobias: Flag selection haptic burst
	          if (typeof playTick === 'function') playTick(); // Audio feedback for iOS (guarded)

          selectedAvatar = opt.dataset.avatar;
          isCountryConfirmed = true;
          try { updateJoinReadyState(); } catch {}

          // Olympic stamp effect - confirm country selection
          const countryName = opt.getAttribute('title') || selectedAvatar;
	          updateCountryDisplay(countryName, true);

	          // Center the selected flag precisely to the golden ring (Safari can be off by a few px with scrollIntoView)
	          centerAvatarOption(opt, 'smooth');
	          // Re-run after the slam/scale applies to avoid any transient fractional layout drift.
	          requestAnimationFrame(() => centerAvatarOption(opt, 'instant'));
	          setTimeout(() => centerAvatarOption(opt, 'instant'), 120);

	          suppressSettleHapticUntil = Date.now() + 400;
	        });
	      });

	      function getClosestAvatarOptionToCenter() {
	        if (!avatarSelector || !avatarOptions.length) return null;
	        const ringCenterX = getAvatarRingCenterX();
	        if (ringCenterX == null) return null;
	        let closest = null;
	        let closestDistance = Infinity;
	        avatarOptions.forEach((opt) => {
	          const centerX = getAvatarOptionCenterX(opt);
	          if (centerX == null) return;
	          const distance = Math.abs(centerX - ringCenterX);
	          if (distance < closestDistance) {
	            closestDistance = distance;
	            closest = opt;
	          }
	        });
	        return closest;
	      }

      function setCenteredAvatarOption(opt) {
        if (!opt) return;
        const prev = document.querySelector('.avatar-option.is-centered');

        avatarOptions.forEach((o) => {
          o.classList.remove('is-centered', 'just-centered');
        });

        opt.classList.add('is-centered');

        // Add snap animation if this is a new centered flag
        if (opt !== prev && !opt.classList.contains('selected')) {
          opt.classList.add('just-centered');
          setTimeout(() => opt.classList.remove('just-centered'), 150);
        }

        centeredAvatar = opt.dataset.avatar || null;

        // Update country name display (use title attribute for display name)
        const countryName = opt.getAttribute('title') || centeredAvatar;
        const isSelected = opt.classList.contains('selected');
        updateCountryDisplay(countryName, isSelected);

      }

      function updateAvatarCenteredState() {
        const closest = getClosestAvatarOptionToCenter();
        if (!closest) return;
        setCenteredAvatarOption(closest);
      }

	      function settleAvatarScroll() {
	        if (!avatarSelector) return;
	        if (avatarPointerDown) return;
	        const closest = getClosestAvatarOptionToCenter();
	        if (!closest) return;

        const nextCentered = closest.dataset.avatar || null;
        const shouldHaptic =
          Date.now() > suppressSettleHapticUntil
          && centeredAvatar
          && nextCentered
          && nextCentered !== centeredAvatar;
	        setCenteredAvatarOption(closest);

	        // Safari can land a pixel or two off the ring even after scroll-snap; nudge to perfection.
	        centerAvatarOption(closest, 'instant');
	        setTimeout(() => centerAvatarOption(closest, 'instant'), 80);

	        // UX: selecting via scroll should feel like choosing (not “it looks clickable but isn’t”).
	        // When the user settles on a new centered flag, treat it as the selection.
	        if (!closest.classList.contains('selected')) {
	          avatarOptions.forEach(o => {
	            if (o !== closest) o.classList.remove('selected');
	            o.classList.remove('is-slamming');
	          });
	          closest.classList.add('selected');
	          selectedAvatar = closest.dataset.avatar;
	          isCountryConfirmed = true;
	          try { updateJoinReadyState(); } catch {}
	          const countryName = closest.getAttribute('title') || selectedAvatar;
	          updateCountryDisplay(countryName, true);
	          suppressSettleHapticUntil = Date.now() + 250;
	        }

	        if (shouldHaptic) vibrate(6);
	      }

      if (avatarSelector) {
        const scheduleScrollEnd = () => {
          if (avatarScrollEndTimer) clearTimeout(avatarScrollEndTimer);
          avatarScrollEndTimer = setTimeout(settleAvatarScroll, 250);
        };

        avatarSelector.addEventListener('scroll', () => {
          if (avatarScrollRaf) cancelAnimationFrame(avatarScrollRaf);
          avatarScrollRaf = requestAnimationFrame(updateAvatarCenteredState);
          scheduleScrollEnd();
        }, { passive: true });

        avatarSelector.addEventListener('touchstart', () => {
          avatarPointerDown = true;
          if (avatarScrollEndTimer) clearTimeout(avatarScrollEndTimer);
        }, { passive: true });
        avatarSelector.addEventListener('touchend', () => {
          avatarPointerDown = false;
          scheduleScrollEnd();
        }, { passive: true });
        avatarSelector.addEventListener('touchcancel', () => {
          avatarPointerDown = false;
          scheduleScrollEnd();
        }, { passive: true });

        avatarSelector.addEventListener('pointerdown', (e) => {
          if (e.pointerType === 'mouse') return;
          avatarPointerDown = true;
          if (avatarScrollEndTimer) clearTimeout(avatarScrollEndTimer);
        }, { passive: true });
        avatarSelector.addEventListener('pointerup', (e) => {
          if (e.pointerType === 'mouse') return;
          avatarPointerDown = false;
          scheduleScrollEnd();
        }, { passive: true });
        avatarSelector.addEventListener('pointercancel', () => {
          avatarPointerDown = false;
          scheduleScrollEnd();
        }, { passive: true });

        // Initial centered state once the layout is ready.
        requestAnimationFrame(updateAvatarCenteredState);

        // Set spacer width dynamically based on container width
        // Make global so it can be called when chat panel opens
        window.updateSpacerWidth = function() {
          const frame = document.querySelector('.avatar-selector-frame');
          const selector = frame?.querySelector('.avatar-selector');
          const spacers = frame?.querySelectorAll('.avatar-selector__spacer');
          if (!frame || !selector || !spacers?.length) return;

          const containerWidth = selector.clientWidth || selector.getBoundingClientRect().width;
          if (!containerWidth) return; // Panel not visible yet

          const option = selector.querySelector('.avatar-option');
          const optionWidth = option?.offsetWidth || 44;
          const styles = getComputedStyle(selector);
          const rawGap = styles.columnGap || styles.gap || '0';
          const gap = Number.parseFloat(rawGap) || 0;

          // Calculate: half container - half option width - gap
          const spacerWidth = (containerWidth / 2) - (optionWidth / 2) - gap;
          spacers.forEach(s => s.style.width = Math.max(0, spacerWidth) + 'px');
        };
        window.updateSpacerWidth();
        window.addEventListener('resize', window.updateSpacerWidth);

        // Runway animation: center Cuba then peek to hint more flags exist
	        function initializeAvatarRunway() {
	          const cubaFlag = avatarSelector.querySelector('[data-avatar="cuba"]');
	          if (!cubaFlag) return;
	          const usaFlag = avatarSelector.querySelector('[data-avatar="usa"]');

	          // Ensure spacers are sized before centering
	          updateSpacerWidth();

	          // Center Cuba first (instant, no animation)
	          centerAvatarOption(cubaFlag, 'instant');
	          setCenteredAvatarOption(cubaFlag);

          // Cuba starts selected - show as confirmed
          if (cubaFlag.classList.contains('selected')) {
            isCountryConfirmed = true;
            updateCountryDisplay('Cuba', true);
            try { updateJoinReadyState(); } catch {}
          }

	          // After entrance animation completes, peek right to hint more flags exist
	          setTimeout(() => {
	            const peekStep = usaFlag && cubaFlag ? (usaFlag.offsetLeft - cubaFlag.offsetLeft) : 60;
	            avatarSelector.scrollBy({ left: peekStep, behavior: 'smooth' });
	            setTimeout(() => {
	              centerAvatarOption(cubaFlag, 'smooth');
	            }, 400);
	          }, 900);
	        }

        // Run runway when identity screen is visible
        requestAnimationFrame(initializeAvatarRunway);
      }

      // Player identity (La Mesa is login-required; name is derived from verified registration)
      const chatJoinBtn = document.getElementById('chatJoinBtn');

      function updateJoinReadyState() {
        const isReady = !!(mesaAuthVerified && mesaAuthPlayer && isCountryConfirmed);
        if (chatJoinBtn) {
          chatJoinBtn.disabled = !isReady;
          chatJoinBtn.classList.toggle('is-ready', isReady);
        }
      }

      updateJoinReadyState();

	      // Join chat handler - Free Agent status until team assignment
	      chatJoinBtn?.addEventListener('click', async () => {
	        const authed = await ensureMesaAuth({ silent: false });
	        if (!authed) return;
	        const playerName = mesaAuthPlayer?.name ? String(mesaAuthPlayer.name).trim() : '';
	        if (!playerName) return;

	        // All players are Free Agents until the team assignment
	        chatIdentity = {
	          teamName: null,
	          playerId: mesaAuthPlayer.id,
	          playerName,
	          avatar: selectedAvatar,
	          status: 'free_agent'
	        };

	        try {
	          localStorage.setItem('cdl_chat_identity', JSON.stringify(chatIdentity));
	        } catch {}
	        enterLaMesaRitual();
	      });

	      function enterLaMesaRitual() {
        console.log('[RITUAL] Starting entry ritual, chatIdentity:', chatIdentity);
        if (!chatIdentity) {
          console.log('[RITUAL] No identity, calling showChatInterface');
          showChatInterface();
          return;
        }

        // ALWAYS open in full mode when entering for the first time (hub should be visible)
        console.log('[RITUAL] Applying full presentation mode');
        applyChatPresentation('full');
        // Ensure panel is marked as open and NOT in peek mode
        chatPanel.classList.add('is-open');
        // Force remove peek mode - applyChatPresentation might re-add it based on saved state
        chatPanel.classList.remove('is-peek');
        // Keep the panel pinned at the top so the hub modules are visible after entry.
        chatPanel.scrollTop = 0;
        chatBodyContainer.scrollTop = 0;

	        const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
	        if (reduceMotion || !chatPanel || !mesaEntry) {
	          showChatInterface();
	          return;
	        }

	        const firstName = String(chatIdentity.playerName || '').trim().split(' ')[0];
	        if (mesaEntryKicker) mesaEntryKicker.textContent = 'Pulling up a chair';
	        if (mesaEntryName) mesaEntryName.textContent = firstName ? firstName : '';

	        const selectedFlagImg = document.querySelector('.avatar-option.selected .avatar-flag-img');
	        const flagSrc = selectedFlagImg?.getAttribute('src') || '';
	        if (mesaEntryFlag) {
	          if (flagSrc) mesaEntryFlag.src = flagSrc;
	          else mesaEntryFlag.removeAttribute('src');
	          mesaEntryFlag.alt = selectedFlagImg?.getAttribute('alt') || '';
	          mesaEntryFlag.style.visibility = flagSrc ? 'visible' : 'hidden';
	        }

	        // Restart the ritual animation every time.
	        chatPanel.classList.add('is-entering');
	        mesaEntry.setAttribute('aria-hidden', 'false');
	        mesaEntry.classList.remove('is-live');
	        void mesaEntry.offsetWidth;
	        mesaEntry.classList.add('is-live');

	        // Tobias: The slam should be felt, not heard.
	        vibrate([12, 28, 10]);

        // Wait for ritual overlay to fully cover before swapping content underneath
        // Don't remove is-identity-mode yet - the entry overlay doesn't cover the header
        setTimeout(() => {
          console.log('[RITUAL @180ms] Switching to chat interface, hiding identity screen');
          // Hide identity first
          chatIdentityScreen.style.display = 'none';
          // Show body container and force reflow for smooth transition
          chatBodyContainer.style.display = 'flex';
          void chatBodyContainer.offsetWidth; // Force reflow
          showChatInterface({ silent: true, hideIdentity: false });
          // Some browsers will try to scroll the nearest scroll container to reveal the input.
          // The hub lives at the top, so explicitly pin the panel there during this transition.
          chatPanel.scrollTop = 0;
          chatBodyContainer.scrollTop = 0;
        }, 180);

	        // Let the room breathe before the announcement lands.
	        setTimeout(() => {
	          console.log('[RITUAL @880ms] Showing entrance announcement for:', firstName);
	          if (firstName) showEntranceAnnouncement(firstName);
	        }, 880);

	        // Fade ritual away
	        setTimeout(() => {
	          console.log('[RITUAL @980ms] Removing is-entering (overlay starts fading)');
	          chatPanel.classList.remove('is-entering');
	          console.log('[RITUAL @980ms] Panel classes now:', chatPanel.className);
	        }, 980);
	        
	        // Show header/seats AFTER overlay is fully gone
	        setTimeout(() => {
	          mesaEntry.setAttribute('aria-hidden', 'true');
	          mesaEntry.classList.remove('is-live');
	          chatPanel.classList.remove('is-identity-mode');
	          // Land at the top so the user sees the hub modules first (not the empty chat well).
	          chatPanel.scrollTop = 0;
	          chatBodyContainer.scrollTop = 0;
	        }, 1320);
	      }

	      function showChatInterface({ silent = false, hideIdentity = true } = {}) {
	        if (hideIdentity) {
	          chatIdentityScreen.style.display = 'none';
	          chatPanel.classList.remove('is-identity-mode');
	        }
	        chatBodyContainer.style.display = 'flex'; // Use flex for the container
	        chatPanel.scrollTop = 0;
	        chatBodyContainer.scrollTop = 0;
	        chatSend.disabled = false;
	
	        // Only load if supabase is ready, otherwise the interval will handle it
	        if (supabase) {
          loadMessages();
          subscribeToMessages();
          joinMesaPresence(); // Mesa Mode: Show who's at the table
	        }
	
	        // George: Make entrances MATTER - show announcement
	        if (!silent && chatIdentity?.playerName) showEntranceAnnouncement(chatIdentity.playerName);
	      }

      // Entrance announcement - brass pip + "[Name] pulled up a chair"
      function showEntranceAnnouncement(playerName) {
        const announcement = document.createElement('div');
        announcement.className = 'chat-announcement';
        announcement.innerHTML = `
          <span class="chat-announcement__icon"></span>
          <span class="chat-announcement__name">${escapeHtml(playerName)}</span>
          <span> pulled up a chair</span>
        `;
        chatMessages.appendChild(announcement);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Remove after 5 seconds to keep chat clean
        setTimeout(() => {
          if (announcement.parentNode) {
            announcement.style.opacity = '0';
            announcement.style.transition = 'opacity 0.5s';
            setTimeout(() => announcement.remove(), 500);
          }
        }, 5000);
      }

      // Helper to escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

	      // If already have identity, prepare for direct entry (but don't show yet - wait for panel open)
	      if (chatIdentity) {
	        // Restore selected avatar if saved, otherwise default
	        if(chatIdentity.avatar) selectedAvatar = chatIdentity.avatar;
	        // Pre-hide identity screen so when panel opens, user goes directly to chat
	        chatIdentityScreen.style.display = 'none';
	        chatBodyContainer.style.display = 'flex';
	      }

      // Load existing messages
      async function loadMessages() {
        if (!supabase) return;
        try {
          const { data, error } = await supabase
            .from('messages')
            .select('*')
            .order('created_at', { ascending: true })
            .limit(50);

          if (error) throw error;

          if (data && data.length > 0) {
            renderMessages(data);
          }
        } catch (err) {
          console.error('Failed to load messages:', err);
        }
      }

      function renderMessages(messages) {
        if (messages.length === 0) {
          chatMessages.innerHTML = '<div class="chat-empty">-- NO MESSAGES --</div>';
          return;
        }

        // Separate pinned and regular messages
        const pinned = messages.filter(m => m.is_pinned);
        const regular = messages.filter(m => !m.is_pinned);

        let html = '';

        // Show pinned messages section if any - Tobias: "HONORED" not "📌 Pinned"
        if (pinned.length > 0) {
          html += '<div class="pinned-section"><div class="pinned-section__label">● HONORED</div>';
          html += pinned.map(msg => createMessageHTML(msg)).join('');
          html += '</div>';
        }

        // Show regular messages
        html += regular.map(msg => createMessageHTML(msg)).join('');

        chatMessages.innerHTML = html;

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Map of avatar codes to emojis
      const FLAG_MAP = {
        // Priority: Cuba & USA
        'cuba': '🇨🇺',
        'usa': '🇺🇸',
        // Caribbean
        'puerto-rico': '🇵🇷',
        'dominican-republic': '🇩🇴',
        'jamaica': '🇯🇲',
        'haiti': '🇭🇹',
        'trinidad-and-tobago': '🇹🇹',
        'bahamas': '🇧🇸',
        'barbados': '🇧🇧',
        'saint-lucia': '🇱🇨',
        'grenada': '🇬🇩',
        'saint-vincent': '🇻🇨',
        'antigua-and-barbuda': '🇦🇬',
        'dominica': '🇩🇲',
        'saint-kitts-and-nevis': '🇰🇳',
        'curacao': '🇨🇼',
        'aruba': '🇦🇼',
        'us-virgin-islands': '🇻🇮',
        'british-virgin-islands': '🇻🇬',
        'cayman-islands': '🇰🇾',
        'turks-and-caicos': '🇹🇨',
        'bermuda': '🇧🇲',
        'anguilla': '🇦🇮',
        'montserrat': '🇲🇸',
        'sint-maarten': '🇸🇽',
        'guadeloupe': '🇬🇵',
        'martinique': '🇲🇶',
        'bonaire': '🇧🇶',
        // Central America
        'mexico': '🇲🇽',
        'guatemala': '🇬🇹',
        'belize': '🇧🇿',
        'honduras': '🇭🇳',
        'el-salvador': '🇸🇻',
        'nicaragua': '🇳🇮',
        'costa-rica': '🇨🇷',
        'panama': '🇵🇦',
        // South America
        'venezuela': '🇻🇪',
        'colombia': '🇨🇴',
        'brazil': '🇧🇷',
        'argentina': '🇦🇷',
        'peru': '🇵🇪',
        'chile': '🇨🇱',
        'ecuador': '🇪🇨',
        'bolivia': '🇧🇴',
        'paraguay': '🇵🇾',
        'uruguay': '🇺🇾',
        'guyana': '🇬🇾',
        'suriname': '🇸🇷',
        'french-guiana': '🇬🇫',
        // North America
        'canada': '🇨🇦',
        // Europe
        'spain': '🇪🇸',
        'portugal': '🇵🇹',
        'italy': '🇮🇹',
        'france': '🇫🇷',
        'germany': '🇩🇪',
        'united-kingdom': '🇬🇧',
        'ireland': '🇮🇪',
        'netherlands': '🇳🇱',
        'belgium': '🇧🇪',
        'switzerland': '🇨🇭',
        'austria': '🇦🇹',
        'poland': '🇵🇱',
        'czechia': '🇨🇿',
        'slovakia': '🇸🇰',
        'hungary': '🇭🇺',
        'romania': '🇷🇴',
        'bulgaria': '🇧🇬',
        'greece': '🇬🇷',
        'croatia': '🇭🇷',
        'slovenia': '🇸🇮',
        'serbia': '🇷🇸',
        'bosnia': '🇧🇦',
        'montenegro': '🇲🇪',
        'north-macedonia': '🇲🇰',
        'albania': '🇦🇱',
        'kosovo': '🇽🇰',
        'ukraine': '🇺🇦',
        'russia': '🇷🇺',
        'belarus': '🇧🇾',
        'moldova': '🇲🇩',
        'lithuania': '🇱🇹',
        'latvia': '🇱🇻',
        'estonia': '🇪🇪',
        'finland': '🇫🇮',
        'sweden': '🇸🇪',
        'norway': '🇳🇴',
        'denmark': '🇩🇰',
        'iceland': '🇮🇸',
        'luxembourg': '🇱🇺',
        'liechtenstein': '🇱🇮',
        'monaco': '🇲🇨',
        'andorra': '🇦🇩',
        'san-marino': '🇸🇲',
        'vatican': '🇻🇦',
        'malta': '🇲🇹',
        'cyprus': '🇨🇾',
        'turkey': '🇹🇷',
        'georgia': '🇬🇪',
        'armenia': '🇦🇲',
        'azerbaijan': '🇦🇿',
        // Asia
        'china': '🇨🇳',
        'japan': '🇯🇵',
        'south-korea': '🇰🇷',
        'north-korea': '🇰🇵',
        'taiwan': '🇹🇼',
        'hong-kong': '🇭🇰',
        'macau': '🇲🇴',
        'mongolia': '🇲🇳',
        'vietnam': '🇻🇳',
        'thailand': '🇹🇭',
        'philippines': '🇵🇭',
        'indonesia': '🇮🇩',
        'malaysia': '🇲🇾',
        'singapore': '🇸🇬',
        'brunei': '🇧🇳',
        'cambodia': '🇰🇭',
        'laos': '🇱🇦',
        'myanmar': '🇲🇲',
        'timor-leste': '🇹🇱',
        'india': '🇮🇳',
        'pakistan': '🇵🇰',
        'bangladesh': '🇧🇩',
        'nepal': '🇳🇵',
        'bhutan': '🇧🇹',
        'sri-lanka': '🇱🇰',
        'maldives': '🇲🇻',
        'afghanistan': '🇦🇫',
        'iran': '🇮🇷',
        'iraq': '🇮🇶',
        'syria': '🇸🇾',
        'lebanon': '🇱🇧',
        'jordan': '🇯🇴',
        'israel': '🇮🇱',
        'palestine': '🇵🇸',
        'saudi-arabia': '🇸🇦',
        'yemen': '🇾🇪',
        'oman': '🇴🇲',
        'uae': '🇦🇪',
        'qatar': '🇶🇦',
        'bahrain': '🇧🇭',
        'kuwait': '🇰🇼',
        'kazakhstan': '🇰🇿',
        'uzbekistan': '🇺🇿',
        'turkmenistan': '🇹🇲',
        'tajikistan': '🇹🇯',
        'kyrgyzstan': '🇰🇬',
        // Africa
        'egypt': '🇪🇬',
        'morocco': '🇲🇦',
        'algeria': '🇩🇿',
        'tunisia': '🇹🇳',
        'libya': '🇱🇾',
        'sudan': '🇸🇩',
        'south-sudan': '🇸🇸',
        'ethiopia': '🇪🇹',
        'eritrea': '🇪🇷',
        'djibouti': '🇩🇯',
        'somalia': '🇸🇴',
        'kenya': '🇰🇪',
        'uganda': '🇺🇬',
        'tanzania': '🇹🇿',
        'rwanda': '🇷🇼',
        'burundi': '🇧🇮',
        'dr-congo': '🇨🇩',
        'congo': '🇨🇬',
        'central-african-republic': '🇨🇫',
        'cameroon': '🇨🇲',
        'nigeria': '🇳🇬',
        'ghana': '🇬🇭',
        'ivory-coast': '🇨🇮',
        'senegal': '🇸🇳',
        'mali': '🇲🇱',
        'burkina-faso': '🇧🇫',
        'niger': '🇳🇪',
        'chad': '🇹🇩',
        'mauritania': '🇲🇷',
        'gambia': '🇬🇲',
        'guinea-bissau': '🇬🇼',
        'guinea': '🇬🇳',
        'sierra-leone': '🇸🇱',
        'liberia': '🇱🇷',
        'togo': '🇹🇬',
        'benin': '🇧🇯',
        'gabon': '🇬🇦',
        'equatorial-guinea': '🇬🇶',
        'sao-tome': '🇸🇹',
        'angola': '🇦🇴',
        'zambia': '🇿🇲',
        'zimbabwe': '🇿🇼',
        'malawi': '🇲🇼',
        'mozambique': '🇲🇿',
        'madagascar': '🇲🇬',
        'mauritius': '🇲🇺',
        'seychelles': '🇸🇨',
        'comoros': '🇰🇲',
        'south-africa': '🇿🇦',
        'namibia': '🇳🇦',
        'botswana': '🇧🇼',
        'eswatini': '🇸🇿',
        'lesotho': '🇱🇸',
        'cabo-verde': '🇨🇻',
        // Oceania
        'australia': '🇦🇺',
        'new-zealand': '🇳🇿',
        'papua-new-guinea': '🇵🇬',
        'fiji': '🇫🇯',
        'samoa': '🇼🇸',
        'tonga': '🇹🇴',
        'vanuatu': '🇻🇺',
        'solomon-islands': '🇸🇧',
        'kiribati': '🇰🇮',
        'micronesia': '🇫🇲',
        'marshall-islands': '🇲🇭',
        'palau': '🇵🇼',
        'nauru': '🇳🇷',
        'tuvalu': '🇹🇻',
        'guam': '🇬🇺',
        'american-samoa': '🇦🇸',
        'northern-mariana-islands': '🇲🇵',
        'french-polynesia': '🇵🇫',
        'new-caledonia': '🇳🇨',
        'cook-islands': '🇨🇰',
        'niue': '🇳🇺',
        'tokelau': '🇹🇰'
      };

      // Simple hash function for consistent avatars for others
      function getHashAvatar(name) {
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const avatars = Object.keys(FLAG_MAP);
        return avatars[Math.abs(hash) % avatars.length];
      }

      function createMessageHTML(msg) {
        // For individual sign-ups, check by player name (no teams until draft)
        const isSelf = chatIdentity && msg.player_name === chatIdentity.playerName;
        const selfClass = isSelf ? 'chat-message--self' : '';
        const pinnedClass = msg.is_pinned ? 'chat-message--pinned' : '';

        // Check if Free Agent (no team assigned yet)
        const isFreeAgent = !msg.team_name || msg.team_name === 'Free Agent';

        // Use stored avatar, fallback to hash for old messages
        // Default to 'cuba' if local, or hash if remote
        let avatarType = msg.avatar || (isSelf ? (chatIdentity.avatar || 'cuba') : getHashAvatar(msg.player_name));

        // Handle legacy avatars (map old codes to new human-readable codes)
        if (!FLAG_MAP[avatarType]) {
             // Legacy pixel avatars
             if (avatarType === 'domino') avatarType = 'cuba';
             else if (avatarType === 'cigar') avatarType = 'usa';
             else if (avatarType === 'cafecito') avatarType = 'puerto-rico';
             else if (avatarType === 'carro') avatarType = 'dominican-republic';
             else if (avatarType === 'palma') avatarType = 'venezuela';
             else if (avatarType === 'bandera') avatarType = 'colombia';
             else if (avatarType === 'conga') avatarType = 'spain';
             // Legacy shorthand codes
             else if (avatarType === 'pr') avatarType = 'puerto-rico';
             else if (avatarType === 'dr') avatarType = 'dominican-republic';
             else if (avatarType === 'uk') avatarType = 'united-kingdom';
             else avatarType = 'cuba'; // Fallback
        }

        const emoji = FLAG_MAP[avatarType] || '🇨🇺';

        // Free Agent pip - single pip = "half of something, waiting for partner"
        const freeAgentBadge = isFreeAgent ? '<span class="free-agent-pip">●</span>' : '';

        return `
          <div class="chat-message ${selfClass} ${pinnedClass}" data-msg-id="${msg.id}">
            ${msg.is_pinned ? '<div class="pinned-badge">PINNED</div>' : ''}
            <div class="chat-message__content-wrapper">
              <div class="chat-message__header">
                <span class="chat-message__author">
                  <span class="chat-message__flag">${emoji}</span>
                  <span class="chat-message__author-name">${escapeHtml(msg.player_name)}</span>
                  ${freeAgentBadge}
                </span>
                <span class="chat-message__time">${formatTime(msg.created_at)}</span>
              </div>
              <div class="chat-message__content">${highlightMentions(escapeHtml(msg.content))}</div>
            </div>
          </div>
        `;
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'NOW';
        if (diffMins < 60) return `${diffMins}m`;
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h`;
        return date.toLocaleDateString();
      }

      // Subscribe to new messages
      function subscribeToMessages() {
        if (!supabase) return;
        if (messagesChannel) return;

        messagesChannel = supabase
          .channel('messages')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
            const msg = payload.new;
            appendMessage(msg);

            // Add to ticker as "talking" activity
            if (msg.player_name && !msg.is_pinned) {
              addTickerEvent('chat', msg.player_name);
              updateTicker(presenceChannel ? presenceChannel.presenceState() : {});
            }

            // Update unread count if chat is closed
            const isOpen = chatPanel && chatPanel.classList.contains('is-open');
            if (!isOpen) {
              unreadCount++;
              // Tobias: Make the room feel like it's calling for you
              if (tickerChatBtn) tickerChatBtn.classList.add('has-unread');
              if (chatBadge) {
                chatBadge.textContent = unreadCount;
                chatBadge.style.display = 'flex';
              }
            }
          })
          .subscribe();
      }

      // Subscribe to real-time registrations
	      function subscribeToRegistrations() {
	        if (!supabase) return;
	        if (registrationsChannel) return;

	        registrationsChannel = supabase
	          .channel('registrations')
	          .on('broadcast', { event: 'new-registration' }, (payload) => {
	            const playerName = payload?.payload?.playerName;
	            const clientId = payload?.payload?.clientId;
	            if (!playerName) return;
	            if (clientId && clientId === CLIENT_ID) return;

	            addTickerEvent('register', playerName);
	            updateTicker(presenceChannel ? presenceChannel.presenceState() : {});

	            // Update the seats remaining counter
	            applyRealSeatClaim(1);
	          })
	          .subscribe();
	      }

	      // ========================================
	      // MESA TICKER - ESPN-style activity feed
	      // ========================================
	      const tickerTrack = document.getElementById('tickerTrack');
	      let presenceChannel = null;
	      let tickerAnnouncements = []; // Admin-controlled messages (Supabase)
	      let tickerRegistrations = []; // Recent signups (Google Sheets via /api/players)
	      let tickerRendered = false;
	      let lastTickerContent = ''; // Track content changes to skip unnecessary updates

	      function normalizeTickerName(name) {
	        return String(name ?? '').trim().split(' ')[0];
	      }

		      function seedTickerRegistrations() {
		        const roster = Array.isArray(registeredPlayers) ? registeredPlayers : [];
		        const names = roster
		          .map((p) => normalizeTickerName(p?.name))
		          .filter(Boolean);

		        // Google Sheets comes back in signup order; take the most recent.
		        tickerRegistrations = names.slice(-8).reverse();
		      }

		      async function refreshTickerRoster() {
		        try {
		          const response = await fetch('/api/players');
		          const data = await response.json();
		          const roster = Array.isArray(data?.players) ? data.players : [];
		          const names = roster
		            .map((p) => normalizeTickerName(p?.name))
		            .filter(Boolean);

		          const nextRegistrations = names.slice(-8).reverse();
		          const nextCount = names.length;

		          const didRegistrationsChange = nextRegistrations.join('|') !== tickerRegistrations.join('|');
		          const didCountChange = Number.isFinite(nextCount) && nextCount !== livePlayerCount;

		          if (didRegistrationsChange) {
		            tickerRegistrations = nextRegistrations;
		          }

		          if (didCountChange) {
		            livePlayerCount = nextCount;
		            const remaining = PLAYERS_GOAL - livePlayerCount;
		            seatsRemainingActual = remaining;
		            updateSpotsRemaining(remaining, { animate: false, tick: true });
		            if (playerCountEl) playerCountEl.textContent = livePlayerCount;
		            const percentage = (livePlayerCount / PLAYERS_GOAL) * 100;
		            if (progressFillEl) progressFillEl.style.width = percentage + '%';
		          }

		          if (didRegistrationsChange || didCountChange) {
		            updateTicker(presenceChannel ? presenceChannel.presenceState() : {});
		          }
		        } catch {}
		      }

		      async function refreshTickerAnnouncements() {
		        if (!supabase) return;
		        const { data } = await supabase
		          .from('announcements')
	          .select('content, priority, is_active, expires_at, created_at')
	          .order('priority', { ascending: false })
	          .order('created_at', { ascending: false });

	        const now = new Date().toISOString();
	        const active = (data || []).filter((a) =>
	          a.is_active && (!a.expires_at || a.expires_at > now)
	        );

	        tickerAnnouncements = active
	          .map((a) => String(a.content || '').trim())
	          .filter(Boolean)
	          .slice(0, 6);
	      }

	      function subscribeToTickerAnnouncements() {
	        if (!supabase) return;
	        if (announcementsChannel) return;

	        announcementsChannel = supabase
	          .channel('announcements-changes')
	          .on('postgres_changes', { event: '*', schema: 'public', table: 'announcements' }, async () => {
	            await refreshTickerAnnouncements();
	            updateTicker(presenceChannel ? presenceChannel.presenceState() : {});
	          })
	          .subscribe();
	      }

		      async function initTicker() {
		        if (!tickerTrack) return;

		        await Promise.resolve(playersReady).catch(() => null);
		        seedTickerRegistrations();
		        void refreshTickerRoster();

		        const supabaseOk = await supabaseReady;
		        if (supabaseOk && supabase) {
		          await refreshTickerAnnouncements();
		          subscribeToTickerAnnouncements();
		        }

		        // Polling fallback so ticker stays accurate even if realtime is unavailable (or RLS hides some changes).
		        const rosterPoll = window.setInterval(refreshTickerRoster, 35_000);
		        const announcementsPoll = supabaseOk && supabase
		          ? window.setInterval(async () => {
		              await refreshTickerAnnouncements();
		              updateTicker(presenceChannel ? presenceChannel.presenceState() : {});
		            }, 60_000)
		          : null;

		        window.addEventListener('beforeunload', () => {
		          window.clearInterval(rosterPoll);
		          if (announcementsPoll) window.clearInterval(announcementsPoll);
		        }, { once: true });

		        window.addEventListener('cdl:new-registration', (event) => {
		          const playerName = normalizeTickerName(event?.detail?.playerName);
		          const clientId = event?.detail?.clientId;
		          if (!playerName) return;
	          if (clientId && clientId !== CLIENT_ID) return;

	          addTickerEvent('register', playerName);
	          updateTicker(presenceChannel ? presenceChannel.presenceState() : {});
	          applyRealSeatClaim(1);
	        }, { passive: true });

	        updateTicker(presenceChannel ? presenceChannel.presenceState() : {});
	      }

	      void initTicker();

	      // Note: ticker should never pause/stop on touch; keep it continuously scrolling.

	      function joinMesaPresence() {
        if (!supabase || !chatIdentity) return;

        presenceChannel = supabase.channel('mesa-presence', {
          config: {
            presence: {
              key: mesaAuthUserId || chatIdentity.playerId || chatIdentity.playerName,
            },
          },
        });

        presenceChannel
          .on('presence', { event: 'sync' }, () => {
            const state = presenceChannel.presenceState();
            lastMesaPresenceState = state;
            updateMesaHeaderPresence(state);
            if (mesaPresenceEl?.classList.contains('is-open')) renderMesaPresenceList();
            renderMesaHubWhoList(); // Keep hub list in sync
            renderMesaSeatStrip(); // Update seat strip
            updateTicker(state);
          })
          .on('presence', { event: 'join' }, ({ key, newPresences }) => {
            // Add join event to ticker
            if (newPresences[0] && (!chatIdentity || newPresences[0].playerName !== chatIdentity.playerName)) {
              addTickerEvent('join', newPresences[0].playerName);
              const state = presenceChannel.presenceState();
              lastMesaPresenceState = state;
              updateMesaHeaderPresence(state);
              if (mesaPresenceEl?.classList.contains('is-open')) renderMesaPresenceList();
              renderMesaHubWhoList(); // Keep hub list in sync
              renderMesaSeatStrip();
              updateTicker(state);
            }
          })
          .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
            // Could add leave events if desired
            const state = presenceChannel.presenceState();
            lastMesaPresenceState = state;
            updateMesaHeaderPresence(state);
            if (mesaPresenceEl?.classList.contains('is-open')) renderMesaPresenceList();
            renderMesaHubWhoList(); // Keep hub list in sync
            renderMesaSeatStrip();
          })
          .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
              await presenceChannel.track({
                playerName: chatIdentity.playerName,
                teamName: chatIdentity.teamName,
                avatar: chatIdentity.avatar,
                joinedAt: new Date().toISOString(),
                docked: chatDocked,
                lookingForPartner: mesaLookingForPartner,
              });
            }
	          });
	      }

	      function addTickerEvent(type, playerName) {
	        if (type === 'register') {
	          tickerRegistrations.unshift(normalizeTickerName(playerName));
	          tickerRegistrations = tickerRegistrations.filter(Boolean).slice(0, 8);
	        } else if (type === 'update') {
	          tickerAnnouncements.unshift(String(playerName || '').trim());
	          tickerAnnouncements = tickerAnnouncements.filter(Boolean).slice(0, 6);
	        }

	        // Tobias: Add micro-moment feel with subtle vibration for registrations
	        if (type === 'register' || type === 'update') {
	          vibrate([10, 30, 20]);
	          // Note: Removed dynamic animationDuration changes - they caused visible jerks on mobile
        }
      }

	      function updateTicker(state, forceUpdate = false) {
	        const users = [];

	        // Collect all users from presence state
	        for (const [key, presences] of Object.entries(state)) {
	          if (presences.length > 0) {
            users.push(presences[0]);
          }
        }

        const liveCount = users.length;

        // Build ticker - simple, clean
        let items = [];

	        // Live count
	        items.push(`<span class="ticker-item ticker-live"><span class="ticker-live-dot"></span>${liveCount} at the table</span>`);

	        // Spots remaining
	        const spotsRemaining = Number.isFinite(seatsRemainingActual)
	          ? Math.max(seatsRemainingActual, 0)
	          : Math.max(PLAYERS_GOAL - (Number.isFinite(livePlayerCount) ? livePlayerCount : 0), 0);
	        items.push(`<span class="ticker-item ticker-spots">${spotsRemaining} seats left</span>`);

	        // Tournament updates (copper, important)
	        tickerAnnouncements.slice(0, 2).forEach((message) => {
	          items.push(`<span class="ticker-item ticker-update">${escapeHtml(message)}</span>`);
	        });

	        // Recent registrations with action
	        tickerRegistrations.slice(0, 4).forEach((name) => {
	          items.push(`<span class="ticker-item ticker-name">${escapeHtml(name)}<span class="ticker-action">just joined</span></span>`);
	        });

	        // If no registrations yet
	        if (items.length === 2) {
	          items.push(`<span class="ticker-item ticker-waiting">Be the first to join</span>`);
	        }

        const content = items.join('');

	        // Skip if content hasn't changed (prevents unnecessary animation resets)
	        if (!forceUpdate && tickerRendered && content === lastTickerContent) {
	          return;
	        }
	        lastTickerContent = content;

	        // Duplicate for seamless infinite scroll - add spacer for clean loop
	        const newHTML = content + '<span class="ticker-spacer"></span>' + content + '<span class="ticker-spacer"></span>';

	        // Update DOM - guards above prevent unnecessary updates
	        tickerTrack.innerHTML = newHTML;
	        tickerRendered = true;
	      }

      function leaveMesaPresence() {
        if (presenceChannel) {
          presenceChannel.unsubscribe();
          presenceChannel = null;
        }
        lastMesaPresenceState = {};
        if (mesaHeaderStatusTextEl) mesaHeaderStatusTextEl.textContent = 'Who’s here';
        if (mesaPresenceEl?.classList.contains('is-open')) renderMesaPresenceList();
        renderMesaHubWhoList(); // Clear hub list
        renderMesaSeatStrip(); // Clear seats
      }

      // Leave presence when tab closes
      window.addEventListener('beforeunload', leaveMesaPresence);

      function appendMessage(msg) {
        // Remove empty state if present
        const emptyEl = chatMessages.querySelector('.chat-empty');
        if (emptyEl) emptyEl.remove();

        // Tobias: "Someone sat down" - detect new voice
        const speakerId = msg.player_name;
        const isNewVoice = lastSpeakerId && speakerId !== lastSpeakerId;
        lastSpeakerId = speakerId;

        const msgHTML = createMessageHTML(msg);
        const tempContainer = document.createElement('div');
        tempContainer.innerHTML = msgHTML;

        const msgEl = tempContainer.firstElementChild;
        if (isNewVoice) {
          msgEl.classList.add('chat-message--new-voice');
        }

        chatMessages.appendChild(msgEl);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Send message with THE SLAM
      async function sendMessage() {
        const content = chatInput.value.trim();
        if (!content || !chatIdentity) return;

        // Make sure Supabase is initialized
        if (!supabase) {
          initSupabase();
          if (!supabase) {
            alert('Chat is still loading...');
            return;
          }
        }

        // THE SLAM - "When you play a domino, you're declaring." — Wifredo Lam
        chatSend.classList.add('slamming');
        vibrate([15, 40]); // Tobias: thump-settle haptic pattern
        setTimeout(() => chatSend.classList.remove('slamming'), 300);

        chatSend.disabled = true;
        chatInput.disabled = true;

        try {
          const { error } = await supabase
            .from('messages')
            .insert({
              team_name: chatIdentity.teamName || null, // null = Free Agent
              player_name: chatIdentity.playerName,
              content: content,
              avatar: chatIdentity.avatar || 'cuba'
            });

          if (error) throw error;

          chatInput.value = '';
        } catch (err) {
          console.error('Failed to send message:', err);
          alert('Failed to send. Signal lost.');
        } finally {
          chatSend.disabled = false;
          chatInput.disabled = false;
          chatInput.focus();
        }
      }

      chatSend.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Enable send button when there's input
      chatInput.addEventListener('input', () => {
        chatSend.disabled = !chatInput.value.trim();
      });

      // ========================================
      // PINNED MESSAGES - Handle pinning
      // ========================================

      // Handle pin button clicks
      chatMessages.addEventListener('click', async (e) => {
        const pinBtn = e.target.closest('.pin-btn');
        if (pinBtn) {
          e.stopPropagation();
          const msgId = pinBtn.dataset.msgId;
          await togglePin(msgId);
        }
      });

      // Toggle pin on a message
      async function togglePin(msgId) {
        if (!supabase || !chatIdentity) return;

        try {
          // Get current message
          const { data: msg, error: fetchError } = await supabase
            .from('messages')
            .select('is_pinned')
            .eq('id', msgId)
            .single();

          if (fetchError) throw fetchError;

          const newPinState = !msg.is_pinned;

          // Save to Supabase
          const { error: updateError } = await supabase
            .from('messages')
            .update({ is_pinned: newPinState })
            .eq('id', msgId);

          if (updateError) throw updateError;

          // Re-render messages
          loadMessages();

        } catch (err) {
          console.error('Failed to toggle pin:', err);
        }
      }

      // ===========================================
      // TEAMS SYSTEM - "Dominoes is about teams"
      // ===========================================
      let currentTeam = null;
      let pendingInvite = null;
      let selectedArchetype = null;
      let teamPartner1Id = null;
      let teamPartner2Id = null;

      const teamInviteToast = document.getElementById('teamInviteToast');
      const inviteFromPlayer = document.getElementById('inviteFromPlayer');
      const acceptInviteBtn = document.getElementById('acceptInviteBtn');
      const declineInviteBtn = document.getElementById('declineInviteBtn');
      const teamModal = document.getElementById('teamModal');
      const teamPartner1 = document.getElementById('teamPartner1');
      const teamPartner2 = document.getElementById('teamPartner2');
      const teamNameInput = document.getElementById('teamNameInput');
      const archetypeGrid = document.getElementById('archetypeGrid');
      const teamModalCancel = document.getElementById('teamModalCancel');
      const teamModalCreate = document.getElementById('teamModalCreate');

      const archetypeNames = {
        los_viejos: 'Los Viejos', los_venenos: 'Los Venenos', la_tranca: 'La Tranca',
        la_carreta: 'La Carreta', los_capicuas: 'Los Capicúas', los_pesados: 'Los Pesados',
        los_amarradores: 'Los Amarradores', la_mula: 'La Mula'
      };

      async function checkPlayerTeam(playerId, { store = true } = {}) {
        if (!supabase) return null;
        try {
          const { data, error } = await supabase.from('mesa_teams').select('*')
            .or(`player1_id.eq.${playerId},player2_id.eq.${playerId}`).maybeSingle();
          if (error) throw error;
          if (data) {
            const team = {
              id: data.id,
              name: data.name,
              archetype: data.archetype,
              teammate: String(data.player1_id) === String(playerId) ? data.player2_name : data.player1_name
            };

            if (store) {
              currentTeam = team;
              if (chatIdentity) {
                chatIdentity.teamName = data.name;
                chatIdentity.status = 'teamed';
                try { localStorage.setItem('cdl_chat_identity', JSON.stringify(chatIdentity)); } catch {}
              }
            }

            return team;
          }
        } catch (err) { console.error('Failed to check team:', err); }
        return null;
      }

      async function checkPendingInvites(playerId) {
        if (!supabase) return;
        try {
          const { data, error } = await supabase.from('mesa_team_invites').select('*')
            .eq('to_player_id', playerId).eq('status', 'pending')
            .order('created_at', { ascending: false }).limit(1);
          if (error) throw error;
          if (data && data.length > 0) showInviteToast(data[0]);
        } catch (err) { console.error('Failed to check invites:', err); }
      }

      function showInviteToast(invite) {
        pendingInvite = invite;
        if (inviteFromPlayer) inviteFromPlayer.textContent = invite.from_player;
        if (teamInviteToast) {
          teamInviteToast.classList.add('is-visible');
          setTimeout(() => { if (pendingInvite?.id === invite.id) hideInviteToast(); }, 30000);
        }
      }

      function hideInviteToast() {
        if (teamInviteToast) teamInviteToast.classList.remove('is-visible');
        pendingInvite = null;
      }

      async function lookupPlayerByName(playerName) {
        const name = String(playerName || '').trim();
        if (!name) return null;

        const { data, error } = await supabase
          .from('players')
          .select('id, name, status')
          .eq('name', name)
          .in('status', ['registered', 'confirmed'])
          .maybeSingle();

        if (error) throw error;
        return data || null;
      }

      async function sendTeamInvite(toPlayer) {
        if (!supabase || !chatIdentity || currentTeam) return;
        try {
          if (toPlayer === chatIdentity.playerName) return;

          const toRecord = await lookupPlayerByName(toPlayer);
          if (!toRecord?.id) {
            alert(`Could not find "${toPlayer}". They may not be registered yet.`);
            return;
          }

          const existingTeam = await checkPlayerTeam(toRecord.id, { store: false });
          if (existingTeam) { alert(`${toPlayer} is already on a team.`); return; }
          const { data: existing } = await supabase.from('mesa_team_invites').select('id')
            .eq('from_player_id', chatIdentity.playerId).eq('to_player_id', toRecord.id)
            .eq('status', 'pending').maybeSingle();
          if (existing) { alert('You already sent an invite to this player.'); return; }
          const { error } = await supabase.from('mesa_team_invites').insert({
            from_player_id: chatIdentity.playerId,
            to_player_id: toRecord.id,
            from_player: chatIdentity.playerName,
            to_player: toPlayer
          });
          if (error) throw error;
          alert(`Invite sent to ${toPlayer}!`);
        } catch (err) { console.error('Failed to send invite:', err); alert('Failed to send invite.'); }
      }

      async function acceptTeamInvite() {
        if (!supabase || !pendingInvite || !chatIdentity) return;
        try {
          const { error } = await supabase.from('mesa_team_invites').update({
            status: 'accepted', responded_at: new Date().toISOString()
          }).eq('id', pendingInvite.id);
          if (error) throw error;
          hideInviteToast();
          openTeamModal(pendingInvite);
        } catch (err) { console.error('Failed to accept invite:', err); }
      }

      async function declineTeamInvite() {
        if (!supabase || !pendingInvite) return;
        try {
          await supabase.from('mesa_team_invites').update({
            status: 'declined', responded_at: new Date().toISOString()
          }).eq('id', pendingInvite.id);
          hideInviteToast();
        } catch (err) { console.error('Failed to decline invite:', err); }
      }

      function openTeamModal(invite) {
        const fromName = invite?.from_player;
        const toName = invite?.to_player;
        const fromId = invite?.from_player_id;
        const toId = invite?.to_player_id;

        if (teamPartner1) teamPartner1.textContent = fromName;
        if (teamPartner2) teamPartner2.textContent = toName;
        teamPartner1Id = fromId || null;
        teamPartner2Id = toId || null;
        if (teamNameInput) teamNameInput.value = '';
        selectedArchetype = null;
        document.querySelectorAll('.team-archetype').forEach(btn => btn.classList.remove('selected'));
        if (teamModalCreate) teamModalCreate.disabled = true;
        if (teamModal) teamModal.classList.add('is-open');
      }

      function closeTeamModal() {
        if (teamModal) teamModal.classList.remove('is-open');
        selectedArchetype = null;
      }

      async function createTeam() {
        if (!supabase || !chatIdentity || !selectedArchetype) return;
        const teamName = teamNameInput?.value.trim();
        if (!teamName) { alert('Please enter a team name.'); return; }
        const partner1 = teamPartner1?.textContent;
        const partner2 = teamPartner2?.textContent;
        if (!teamPartner1Id || !teamPartner2Id) { alert('Missing team members.'); return; }

        // Deterministic ordering: mesa_teams enforces player1_id::text < player2_id::text
        const aId = String(teamPartner1Id);
        const bId = String(teamPartner2Id);
        const ordered = aId.localeCompare(bId) < 0
          ? { p1Id: aId, p1Name: partner1, p2Id: bId, p2Name: partner2 }
          : { p1Id: bId, p1Name: partner2, p2Id: aId, p2Name: partner1 };
        try {
          const { data: team, error } = await supabase.from('mesa_teams').insert({
            name: teamName,
            archetype: selectedArchetype,
            player1_id: ordered.p1Id,
            player2_id: ordered.p2Id,
            player1_name: ordered.p1Name,
            player2_name: ordered.p2Name
          }).select().single();
          if (error) throw error;
          currentTeam = { id: team.id, name: team.name, archetype: team.archetype,
            teammate: partner1 === chatIdentity.playerName ? partner2 : partner1 };

          chatIdentity.teamName = team.name;
          chatIdentity.status = 'teamed';
          try { localStorage.setItem('cdl_chat_identity', JSON.stringify(chatIdentity)); } catch {}

          closeTeamModal();
          await postTeamAnnouncement(partner1, partner2, teamName, selectedArchetype);
        } catch (err) {
          console.error('Failed to create team:', err);
          alert(err.message?.includes('unique') ? 'That team name is already taken!' : 'Failed to create team.');
        }
      }

      async function postTeamAnnouncement(player1, player2, teamName, archetype) {
        if (!supabase) return;
        try {
          await supabase.from('messages').insert({
            team_name: teamName, player_name: 'System',
            content: `🤝 ${player1} & ${player2} are now **${teamName}** (${archetypeNames[archetype] || archetype})`,
            avatar: 'domino'
          });
        } catch (err) { console.error('Failed to post announcement:', err); }
      }

      function validateTeamForm() {
        if (teamModalCreate) teamModalCreate.disabled = !(teamNameInput?.value.trim() && selectedArchetype);
      }

      if (acceptInviteBtn) acceptInviteBtn.addEventListener('click', acceptTeamInvite);
      if (declineInviteBtn) declineInviteBtn.addEventListener('click', declineTeamInvite);
      if (teamModalCancel) teamModalCancel.addEventListener('click', closeTeamModal);
      if (teamModalCreate) teamModalCreate.addEventListener('click', createTeam);
      if (teamNameInput) teamNameInput.addEventListener('input', validateTeamForm);

      if (archetypeGrid) {
        archetypeGrid.addEventListener('click', (e) => {
          const btn = e.target.closest('.team-archetype');
          if (!btn) return;
          document.querySelectorAll('.team-archetype').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedArchetype = btn.dataset.archetype;
          validateTeamForm();
        });
      }

      if (teamModal) teamModal.querySelector('.team-modal__backdrop')?.addEventListener('click', closeTeamModal);

      function subscribeToTeamInvites(playerName) {
        if (!supabase || !chatIdentity?.playerId) return;
        supabase.channel('team-invites').on('postgres_changes', {
          event: 'INSERT', schema: 'public', table: 'mesa_team_invites', filter: `to_player_id=eq.${chatIdentity?.playerId}`
        }, (payload) => { if (payload.new.status === 'pending') showInviteToast(payload.new); }).subscribe();
      }

      if (chatJoinBtn) {
        chatJoinBtn.addEventListener('click', async () => {
          setTimeout(async () => {
            if (chatIdentity) {
              await checkPlayerTeam(chatIdentity.playerId);
              await checkPendingInvites(chatIdentity.playerId);
              subscribeToTeamInvites(chatIdentity.playerName);
            }
          }, 100);
        });
      }
      window.sendTeamInvite = sendTeamInvite;

      // ===========================================
      // COLOR FLASH FIX TESTER
      // Usage in console: toggleFix('d'), toggleFix('a'), toggleFix('c'), toggleFix(null)
      // ===========================================
      window.toggleFix = (option) => {
        document.body.classList.remove('test-fix-d', 'test-fix-a', 'test-fix-c');
        if (option) {
          document.body.classList.add(`test-fix-${option}`);
          console.log(`%c Testing fix: Option ${option.toUpperCase()} `, 'background: #D4A574; color: #1a1a1a; padding: 4px 8px; border-radius: 4px;');
          const descriptions = {
            'd': 'GPU Layer Isolation - preserves blur effect',
            'a': 'Disable Screen Blend - loses lens effect',
            'c': 'Remove Blur from Animation - loses memory effect'
          };
          console.log(`   → ${descriptions[option] || 'Unknown option'}`);
        } else {
          console.log('%c All fixes disabled (original behavior) ', 'background: #666; color: #fff; padding: 4px 8px; border-radius: 4px;');
        }
        // Reset Panel 3 animation to re-test
        const panel = document.getElementById('panelBuild');
        if (panel) {
          panel.classList.remove('in-view', 'has-played');
          setTimeout(() => {
            panel.classList.add('in-view');
            console.log('   → Animation reset. Watch for green/red flash.');
          }, 100);
        }
      };
      console.log('%c Color flash fix tester loaded ', 'background: #2a2a2a; color: #D4A574; padding: 4px 8px; border-radius: 4px;');
      console.log('   Use toggleFix("d"), toggleFix("a"), or toggleFix("c") in console');
      console.log('   Use toggleFix(null) to reset to original');
    </script>
  </body>
</html>
