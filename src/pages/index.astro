---
// Update this number manually when players sign up
const PLAYERS_REGISTERED = 0;
const PLAYERS_GOAL = 16; // 8 teams × 2 players

const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>La Salida | Cuban Domino League</title>
    <meta
      name="description"
      content="La Salida — The first Cuban Domino League tournament at Mr Garcia Cigars. January 31, 2025. They taught you for this moment. Make them proud."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:opsz,wght@6..96,400;6..96,700;6..96,800;6..96,900&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Sans+Condensed:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --ink: #1c130f;
        --muted: #594a3f;
        --copper: #b76a3b;
        --cream: #f8efe6;
        --bone: #fff7ef;
        --brass: #d4a574;
        --gold: #ffd700;
        --shadow: 0 18px 45px rgba(20, 10, 6, 0.18);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        overflow-x: hidden;
        max-width: 100vw;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        background: #0a0705;
        color: #fff;
      }

      /* ============================================
         LOADING SCREEN - HYPNOTIC CDL
         "The ritual before the game"
         ============================================ */

      /* Master timing - synchronized heartbeat (3.5s = meditative rhythm) */
      :root {
        --heartbeat: 3.5s;
        --ember-color: rgba(255, 180, 100, 0.9);
        --glow-warm: rgba(232, 190, 140, 1);
        --glow-deep: rgba(183, 106, 59, 0.8);
      }

      .loading-screen {
        position: fixed;
        inset: 0;
        z-index: 99999;
        background: radial-gradient(ellipse at center, #1a120d 0%, #080503 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: opacity 0.6s ease-out, visibility 0.6s ease-out;
        overflow: hidden;
      }

      /* Keep the loader visible, but stop blocking scroll/taps quickly. */
      .loading-screen.is-passive {
        pointer-events: none;
      }

      .loading-screen.is-hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      /* Film grain overlay - cinematic texture */
      .loading-screen::before {
        content: '';
        position: absolute;
        inset: -50%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.035;
        pointer-events: none;
        z-index: 10;
        animation: grainShift 0.4s steps(10) infinite;
      }

      @keyframes grainShift {
        0%, 100% { transform: translate(0, 0); }
        25% { transform: translate(-3%, -3%); }
        50% { transform: translate(3%, 1%); }
        75% { transform: translate(-1%, 2%); }
      }

      /* Deep vignette - pulls focus to center */
      .loading-screen::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(
          ellipse at center,
          transparent 0%,
          transparent 30%,
          rgba(0, 0, 0, 0.5) 70%,
          rgba(0, 0, 0, 0.8) 100%
        );
        pointer-events: none;
        z-index: 5;
      }

      /* ===== EMBER PARTICLES - floating upward like cigar smoke ===== */
      .ember-container {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 3;
        overflow: hidden;
      }

      .ember {
        position: absolute;
        width: 3px;
        height: 3px;
        background: var(--ember-color);
        border-radius: 50%;
        filter: blur(1px);
        opacity: 0;
        animation: emberFloat 8s ease-in-out infinite;
      }

      .ember:nth-child(1) { left: 45%; bottom: 30%; animation-delay: 0s; }
      .ember:nth-child(2) { left: 52%; bottom: 35%; animation-delay: 1.2s; }
      .ember:nth-child(3) { left: 48%; bottom: 28%; animation-delay: 2.4s; }
      .ember:nth-child(4) { left: 55%; bottom: 32%; animation-delay: 3.6s; }
      .ember:nth-child(5) { left: 43%; bottom: 38%; animation-delay: 4.8s; }
      .ember:nth-child(6) { left: 50%; bottom: 25%; animation-delay: 6s; }

      @keyframes emberFloat {
        0% {
          opacity: 0;
          transform: translateY(0) scale(0.5);
        }
        10% {
          opacity: 0.8;
          transform: translateY(-20px) scale(1);
        }
        90% {
          opacity: 0.3;
          transform: translateY(-150px) translateX(20px) scale(0.3);
        }
        100% {
          opacity: 0;
          transform: translateY(-180px) translateX(25px) scale(0);
        }
      }

      /* ===== ATMOSPHERIC FOG - breathing warmth ===== */
      .fog-container {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
        z-index: 1;
      }

      .fog-layer--ambient {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 150%;
        height: 150%;
        transform: translate(-50%, -50%);
        background: radial-gradient(
          ellipse 60% 50% at 50% 48%,
          rgba(183, 106, 59, 0.20) 0%,
          rgba(139, 69, 19, 0.12) 30%,
          rgba(100, 50, 20, 0.06) 50%,
          transparent 70%
        );
        /* Phase 1: Fog breathes alone in darkness, then syncs to heartbeat */
        animation:
          fogAlone 2s ease-in-out,
          ambientBreath var(--heartbeat) ease-in-out 3.5s infinite;
      }

      /* Phase 1: Fog breathes alone — gentler, less dramatic */
      @keyframes fogAlone {
        0% {
          transform: translate(-50%, -50%) scale(0.9);
          opacity: 0.3;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.05);
          opacity: 0.7;
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;
        }
      }

      @keyframes ambientBreath {
        0%, 100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.15);
          opacity: 1;
        }
      }

      /* ===== THE CDL TILE - sacred geometry ===== */
      .cdl-tile {
        z-index: 4;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        position: relative;
        padding: 20px 0;
        /* Phase 6: Float begins with heartbeat */
        animation:
          tileAppear 1.2s cubic-bezier(0.16, 1, 0.3, 1) 0.8s forwards,
          tileFloat 8s ease-in-out 3.5s infinite;
      }

      @keyframes tileAppear {
        0% {
          opacity: 0;
          transform: scale(0.9);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Gentle orbital float - hypnotic drift */
      @keyframes tileFloat {
        0%, 100% {
          transform: translateY(0) rotate(0deg);
        }
        25% {
          transform: translateY(-3px) rotate(0.3deg);
        }
        50% {
          transform: translateY(0) rotate(0deg);
        }
        75% {
          transform: translateY(3px) rotate(-0.3deg);
        }
      }

      /* Letter arrangement */
      .cdl-tile__upper {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        width: 200px;
        margin-bottom: 0;
      }

      .cdl-tile__letter {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: 100px;
        color: #f0d4a8; /* Solid luminous color — the letters ARE the light */
        line-height: 1;
        letter-spacing: 0;
        opacity: 0;
        /* The letters ARE the light source — intense mystical glow */
        text-shadow:
          0 0 5px rgba(255, 255, 255, 0.5),
          0 0 15px var(--glow-warm),
          0 0 30px var(--glow-warm),
          0 0 60px rgba(212, 165, 116, 0.8),
          0 0 100px var(--glow-deep),
          0 0 150px rgba(183, 106, 59, 0.4);
        /* Phase 3: Letters emerge from the light, subtler entrance */
        animation:
          letterReveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards,
          letterPulse var(--heartbeat) ease-in-out infinite;
        animation-delay: 1.5s, 3.5s;  /* Earlier emergence, earlier pulse */
      }

      /* Subtler letter entrance - emerge, don't crash */
      @keyframes letterReveal {
        0% {
          opacity: 0;
          transform: translateY(15px) scale(0.95);
          filter: blur(8px);
        }
        60% {
          filter: blur(0);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* Synchronized heartbeat glow - all letters breathe together */
      @keyframes letterPulse {
        0%, 100% {
          /* Softer but still present — letters never feel "off" */
          text-shadow:
            0 0 5px rgba(255, 255, 255, 0.4),
            0 0 15px rgba(232, 190, 140, 0.7),
            0 0 30px rgba(212, 165, 116, 0.5),
            0 0 60px rgba(183, 106, 59, 0.3);
          filter: brightness(1);
        }
        50% {
          text-shadow:
            0 0 8px rgba(255, 255, 255, 0.6),
            0 0 20px var(--glow-warm),
            0 0 50px rgba(212, 165, 116, 0.9),
            0 0 100px var(--glow-deep),
            0 0 150px rgba(183, 106, 59, 0.5);
          filter: brightness(1.1);
        }
      }

      .cdl-tile__letter--c {
        align-self: flex-start;
        margin-left: 16px;  /* Proportional to container */
        animation-delay: 1.5s, 3.5s;  /* First to emerge */
      }

      .cdl-tile__letter--d {
        align-self: flex-end;
        margin-right: 16px;  /* Proportional to container */
        margin-top: -20px;  /* Tighter diagonal — leaning together */
        animation-delay: 1.9s, 3.5s;  /* 0.4s after C (tighter stagger) */
      }

      .cdl-tile__letter--l {
        animation-delay: 2.3s, 3.5s;  /* 0.4s after D */
      }

      /* ===== THE DIVIDER - "The Bone" placed on the table ===== */
      .cdl-tile__divider {
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent 0%, #f0d4a8 50%, transparent 100%);
        margin: 18px 0;
        opacity: 0;
        box-shadow:
          0 0 10px var(--glow-warm),
          0 0 25px rgba(212, 165, 116, 0.7),
          0 0 50px var(--glow-deep);
        /* Phase 4: The Bone slams between C/D and L */
        animation:
          dividerSlam 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 2.1s forwards,
          dividerPulse var(--heartbeat) ease-in-out 3.5s infinite;
      }

      /* The slam - like placing a domino tile */
      @keyframes dividerSlam {
        0% {
          opacity: 0;
          transform: scaleX(0) scaleY(3);
          filter: blur(4px);
        }
        50% {
          opacity: 1;
          transform: scaleX(1.1) scaleY(1);
          filter: blur(0);
        }
        70% {
          transform: scaleX(0.95) scaleY(1);
        }
        100% {
          opacity: 0.9;
          transform: scaleX(1) scaleY(1);
        }
      }

      /* Synchronized with letter heartbeat */
      @keyframes dividerPulse {
        0%, 100% {
          opacity: 0.8;
          box-shadow:
            0 0 6px rgba(232, 190, 140, 0.5),
            0 0 15px rgba(212, 165, 116, 0.3),
            0 0 30px rgba(183, 106, 59, 0.15);
        }
        50% {
          opacity: 1;
          box-shadow:
            0 0 12px var(--glow-warm),
            0 0 30px rgba(212, 165, 116, 0.7),
            0 0 60px var(--glow-deep);
        }
      }

      .cdl-tile__lower {
        display: flex;
        justify-content: center;
        width: 200px;
      }

      /* Inner glow behind the tile — reinforces that letters emit light */
      .cdl-tile__glow {
        position: absolute;
        width: 280px;
        height: 280px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: radial-gradient(
          circle,
          rgba(212, 165, 116, 0.30) 0%,
          rgba(183, 106, 59, 0.18) 35%,
          transparent 65%
        );
        border-radius: 50%;
        opacity: 0;
        /* Phase 2: Glow crescendo — light appears before letters */
        animation:
          glowCrescendo 1.5s ease-out 0.8s forwards,
          glowPulse var(--heartbeat) ease-in-out 3.5s infinite;
        pointer-events: none;
        z-index: -1;
      }

      /* Phase 2: Glow crescendo — smooth, no overshoot */
      @keyframes glowCrescendo {
        0% {
          transform: translate(-50%, -50%) scale(0.6);
          opacity: 0;
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.5;
        }
      }

      @keyframes glowPulse {
        0%, 100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.4;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.2);
          opacity: 0.8;
        }
      }

      /* Mobile adjustments */
	      @media (max-width: 768px) {
        .cdl-tile__upper,
        .cdl-tile__lower {
          width: 100px;
        }
        .cdl-tile__letter {
          font-size: 44px;
        }
        .cdl-tile__letter--d {
          margin-top: -14px;
        }
        .cdl-tile__divider {
          margin: 12px 0;
        }
        .cdl-tile__tagline {
          font-size: 8px;
          letter-spacing: 0.4em;
          margin-top: 24px;
        }
      }

      /* CSS-based scroll lock when chat is open (no JS needed) */
      body.chat-open {
        overflow: hidden !important;
      }

      /* Modern browsers: use :has() selector */
      @supports selector(:has(*)) {
        body:has(.chat-panel.is-open) {
          overflow: hidden !important;
        }
      }

      /* Scroll Container */
      .story {
        height: 100vh;
        height: 100dvh; /* iOS Safari fix - uses actual visible viewport */
        overflow-x: hidden;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        overscroll-behavior: contain;
        scroll-padding-bottom: 46px; /* Account for fixed ticker */
        position: relative;
      }

      /* Panel Base */
      .panel {
        min-height: 100vh;
        min-height: 100dvh;
        height: 100vh;
        height: 100dvh;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 24px;
        overflow: hidden; /* Prevent horizontal scroll from parallax bg */
      }

      .panel-bg {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        z-index: 0; /* Establish a stacking context so film grain never floats above typography (iOS quirk) */
        isolation: isolate; /* Contain blend/film layers to the background only (don’t trap typography) */
      }

      /* Global overlays live INSIDE the scroll container (sticky) so iOS Safari stacking stays correct. */
      .story-overlays {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 4; /* Above panel overlays (2), below text (10+) */
      }

      /* Global Cinematic Vignette - Tobias Signature */
      .vignette-overlay {
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at center,
          transparent 15%,
          rgba(0, 0, 0, 0.35) 60%,
          rgba(0, 0, 0, 0.85) 100%
        );
        pointer-events: none;
        z-index: 1;
      }

      /* Film grain overlay - "Like photos from 1978" — Wes Anderson
         2-3% noise - not visible, but felt. Memory texture. */
      .panel-bg::after {
        content: '';
        position: absolute;
        inset: 0;
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)' opacity='0.03'/%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 1;
        mix-blend-mode: overlay;
        opacity: 0.4;
      }

      /* Tobias: Chromatic Aberration - Edge Distortion
         Gives it that vintage lens feel, pulling the digital into the physical world. */
      .chromatic-aberration {
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        opacity: 0.4;
        mix-blend-mode: screen;
        background: 
          radial-gradient(circle at 49.8% 50%, rgba(255, 0, 0, 0.08) 0%, transparent 80%),
          radial-gradient(circle at 50.2% 50%, rgba(0, 0, 255, 0.08) 0%, transparent 80%);
      }

      /* Tobias: Tobacco Fog Layer - Depth Through Layers */
      .fog-layer {
        position: absolute;
        inset: -20%; /* Bleed for movement */
        width: 140%;
        height: 140%;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(183, 106, 59, 0.12) 0%,
          rgba(28, 19, 15, 0.18) 45%,
          transparent 75%
        );
        filter: blur(70px);
        pointer-events: none;
        z-index: 1;
        opacity: 0;
        transition: opacity 3s ease;
        animation: fogDrift 60s cubic-bezier(0.45, 0.05, 0.55, 0.95) infinite; /* Tobias: Breath-like cadence */
      }

      @keyframes fogDrift {
        0% { transform: translate(0, 0) rotate(0deg); }
        33% { transform: translate(-3%, 2%) rotate(2deg); }
        66% { transform: translate(2%, -3%) rotate(-1deg); }
        100% { transform: translate(0, 0) rotate(0deg); }
      }

      .panel.in-view .fog-layer {
        opacity: 1;
      }

      /* Tobias: Smoke Layer - Foreground Atmosphere */
      /* z-index: 3 - BELOW text (z-index 10+) but above fog (z-index 1) */
      .smoke-layer {
        position: absolute;
        inset: -10%;
        width: 120%;
        height: 120%;
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.005' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 3;
        opacity: 0;
        mix-blend-mode: screen;
        transition: opacity 4s ease;
        animation: smokeDrift 40s linear infinite;
      }

      @keyframes smokeDrift {
        from { transform: translate(0, 0) scale(1); }
        to { transform: translate(-5%, 5%) scale(1.1); }
      }

      .panel.in-view .smoke-layer {
        opacity: 0.6;
      }

      /* Lens Push - Subtle background motion when in view */
      .panel-bg {
        transition: transform 12s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 1s ease;
      }

      .panel.in-view .panel-bg {
        transform: scale(1.05); /* Tobias: Lens Push - subtle walking-in feel */
      }

      /* Hero "walking in" effect */
      .panel--hero {
        overflow: hidden;
      }

      .panel--hero .panel-bg {
        inset: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center center;
      }

      /* Hero overlay - HIDDEN to prevent flicker */
      .panel--hero .panel-overlay {
        display: none !important;
      }

      /* Combined overlay baked into ::before to prevent flicker */
      .panel--hero .panel-bg::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          /* Tobias: Smoke Texture - "Fog, not a wall" */
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E"),
          /* Vertical gradient */
          linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.55) 0%,
            rgba(0, 0, 0, 0.1) 40%,
            rgba(0, 0, 0, 0.1) 60%,
            rgba(0, 0, 0, 0.85) 100%
          ),
          /* Tobias: Deeper Schneider Vignette */
          radial-gradient(
            circle at 50% 50%,
            transparent 30%,
            rgba(0, 0, 0, 0.3) 65%,
            rgba(0, 0, 0, 0.75) 100%
          ),
          /* Side vignettes - deeper for center focus */
          linear-gradient(
            90deg,
            rgba(0, 0, 0, 0.8) 0%,
            rgba(0, 0, 0, 0.3) 15%,
            transparent 30%,
            transparent 70%,
            rgba(0, 0, 0, 0.3) 85%,
            rgba(0, 0, 0, 0.8) 100%
          );
        pointer-events: none;
        z-index: 1;
      }

      /* Tobias: Ember Burn - Cinematic Light Leak */
      .panel--hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at 90% 10%,
          rgba(183, 106, 59, 0.15) 0%,
          transparent 60%
        );
        mix-blend-mode: color-dodge;
        pointer-events: none;
        z-index: 3;
        animation: emberBreath 8s ease-in-out infinite alternate;
      }

      @keyframes emberBreath {
        0% { opacity: 0.4; transform: scale(1); }
        100% { opacity: 0.7; transform: scale(1.1); }
      }

      /* Tobias: Lens Focus Load transition */
      .is-loading .panel--hero .panel-bg {
        filter: blur(8px) brightness(0.7);
        transform: scale(1.05);
      }

      .panel--hero .panel-bg {
        transition: filter 2.5s cubic-bezier(0.16, 1, 0.3, 1), transform 3s cubic-bezier(0.16, 1, 0.3, 1);
        filter: blur(0) brightness(1);
        transform: scale(1);
      }

      @media (max-width: 768px) {
        /* Smooth momentum scrolling on iOS */
        .story {
          -webkit-overflow-scrolling: touch;
          touch-action: pan-y;
          scroll-snap-type: y mandatory;
          scroll-padding-bottom: 40px; /* Mobile ticker is 40px */
        }

        /* Disable parallax bg overhang on mobile for performance */
        .panel-bg {
          inset: 0;
          width: 100%;
          height: 100%;
        }

        /* Disable hero scroll transitions on mobile */
        .panel--hero .panel-bg {
          transition: none;
        }

        .panel--hero .panel-bg::before {
          background:
            /* Deepened mobile vignette to match desktop mood */
            linear-gradient(
              to bottom,
              rgba(0, 0, 0, 0.75) 0%,
              rgba(0, 0, 0, 0.2) 40%,
              rgba(0, 0, 0, 0.85) 100%
            ),
            /* Side vignettes */
            linear-gradient(
              90deg,
              rgba(0, 0, 0, 0.8) 0%,
              transparent 25%,
              transparent 75%,
              rgba(0, 0, 0, 0.8) 100%
            );
        }

        /* Use portrait-optimized hero on mobile */
        .panel-bg--hero {
          background-image: url('/FRAMES/frame-hero-mobile.webp') !important;
          background-position: center center;
        }
      }

      /* Vignette overlay - disabled to prevent flicker */
      .panel--hero::after {
        display: none;
      }

      /* Hero panel - disable ALL transitions to prevent flicker */
      .panel--hero,
      .panel--hero *,
      .panel--hero::before,
      .panel--hero::after {
        transition: none !important;
        animation-play-state: running; /* Keep intentional animations running */
      }

      /* Hero content always visible - no fade in */
      .panel--hero .panel-content {
        opacity: 1 !important;
        transform: none !important;
      }

      /* Isolate hero to reduce repaints (avoid forcing GPU on text) */
      .panel--hero {
        contain: layout style paint;
        isolation: isolate;
      }

      .panel--hero .panel-bg {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }

      /* Tobias: "The Settle" - Elements arrive with weight */
      @keyframes heroSettle {
        0% {
          opacity: 0;
          transform: translate3d(0, 20px, 0) scale(1.02);  /* More lift, less scale */
          filter: blur(8px);  /* Cleaner entry */
        }
        100% {
          opacity: 1;
          transform: translate3d(0, 0, 0) scale(1);
          filter: blur(0);
        }
      }

      /* Keep simple fade for secondary elements to avoid chaos */
      @keyframes fadeInOnly {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      /* Gate hero animations until the loading screen is dismissed */
      body:not(.is-ready) .panel--hero .event-title,
      body:not(.is-ready) .panel--hero .hero-badge,
      body:not(.is-ready) .panel--hero .hero-tagline,
      body:not(.is-ready) .panel--hero .hero-subtitle,
      body:not(.is-ready) .panel--hero .event-numeral {
        opacity: 0 !important;
      }

      body.is-ready .panel--hero .event-title {
        animation: heroSettle 1.4s cubic-bezier(0.22, 1, 0.36, 1) both !important;
        will-change: transform, filter, opacity;
      }

      body.is-ready .panel--hero .hero-badge,
      body.is-ready .panel--hero .hero-tagline,
      body.is-ready .panel--hero .hero-subtitle,
      body.is-ready .panel--hero .event-numeral {
        animation: fadeInOnly 0.9s ease-out both !important;
        transform: none !important;
      }

      /* Stagger the fade-in timing - CDL 1 badge first, then cascade down */
      /* Tighter stagger = unified reveal, like one "scene" appearing */
      body.is-ready .panel--hero .hero-badge { animation-delay: 0s !important; }
      body.is-ready .panel--hero .event-title { animation-delay: 0.08s !important; }
      body.is-ready .panel--hero .event-numeral { animation-delay: 0.14s !important; }
      body.is-ready .panel--hero .hero-tagline { animation-delay: 0.22s !important; }
      body.is-ready .panel--hero .hero-subtitle { animation-delay: 0.32s !important; }

      /* Kill any ::after shine effects on hero text */
      .panel--hero .event-numeral::after {
        display: none !important;
      }


      /* z-index: 2 - BELOW text (z-index 10+) */
      .panel-overlay {
        position: absolute;
        inset: 0;
        background:
          radial-gradient(
            circle at 50% 50%,
            transparent 20%,
            rgba(0, 0, 0, 0.5) 60%,
            rgba(0, 0, 0, 0.9) 100%
          ),
          linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.4) 0%,
            transparent 30%,
            transparent 70%,
            rgba(0, 0, 0, 0.7) 100%
          );
        pointer-events: none;
        z-index: 2;
      }

      .panel--form .panel-overlay {
        background: 
          radial-gradient(
            circle at 50% 50%,
            transparent 20%,
            rgba(28, 19, 15, 0.5) 60%,
            rgba(28, 19, 15, 0.95) 100%
          ),
          linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.3) 0%,
            rgba(0, 0, 0, 0.6) 100%
          );
      }

      /* Form panel gradient background */
      .panel-bg-gradient {
        position: absolute;
        inset: 0;
        background:
          radial-gradient(ellipse at 50% 0%, rgba(183, 106, 59, 0.15) 0%, transparent 50%),
          radial-gradient(ellipse at 80% 80%, rgba(212, 165, 116, 0.1) 0%, transparent 40%),
          linear-gradient(180deg, #0d0906 0%, #1a120d 50%, #0a0705 100%);
      }

      .panel-headline--form {
        font-size: clamp(2.2rem, 7vw, 3.5rem);
      }

      .panel-content {
        position: relative;
        z-index: 10;
        text-align: center;
        max-width: 900px;
        width: 100%;
        opacity: 0;
        transform: translateY(30px);
        transition:
          opacity 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94),
          transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      .panel.in-view .panel-content {
        opacity: 1;
        transform: translateY(0);
      }

      /* First panel starts visible */
      .panel:first-child .panel-content {
        opacity: 1;
        transform: translateY(0);
      }

      /* ========================================
         BRAND LOCKUP - THE TILE
         The "Primary Mark" (C D over L)
         ======================================== */
      .brand-tile {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 24px;
      }

      .brand-tile__upper {
        display: flex;
        gap: 12px;
        margin-bottom: 16px; /* Negative space spine */
      }

      .brand-tile__letter {
        font-family: "Bodoni Moda", serif;
        font-weight: 700;
        font-size: 56px;
        color: var(--brass);
        line-height: 1;
        letter-spacing: -0.02em;
        text-align: center;
      }

      .brand-tile__lower {
        display: flex;
        justify-content: center;
      }

      /* Event Title - TOURNAMENT I - Tobias: "The Settle" */
      .event-title {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin-bottom: 18px;
      }

      .event-name {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(2.2rem, 11vw, 8rem);
        font-weight: 900;
        font-optical-sizing: auto;
        line-height: 0.85;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.9),
          0 4px 20px rgba(0, 0, 0, 0.7),
          0 8px 40px rgba(0, 0, 0, 0.5);
      }

      @media (min-width: 768px) {
        .event-name {
          letter-spacing: 0.08em;
        }
      }

      .event-numeral {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(5rem, 25vw, 14rem);
        font-weight: 900;
        line-height: 0.75;
        color: var(--cream);
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.9),
          0 6px 20px rgba(0, 0, 0, 0.5),
          0 0 80px rgba(212, 165, 116, 0.2);
        position: relative;
      }

      /* La Salida - THE HERO (cream = brightest, unmissable) */
      /* Tobias: "The headline should RADIATE" - luminous glow that cuts through darkness */
      .event-numeral--salida {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: clamp(4.5rem, 16vw, 11rem);
        color: var(--cream);
        line-height: 0.9;
        margin: 0;
        /* Layered glow: inner light → mid aureole → outer atmosphere → depth shadow */
        text-shadow:
          0 0 10px rgba(255, 252, 245, 0.6),
          0 0 30px rgba(255, 252, 245, 0.3),
          0 0 50px rgba(212, 165, 116, 0.5),
          0 0 90px rgba(212, 165, 116, 0.35),
          0 0 140px rgba(212, 165, 116, 0.2),
          0 4px 20px rgba(0, 0, 0, 0.9),
          0 8px 40px rgba(0, 0, 0, 0.7);
        letter-spacing: -0.02em;
        position: relative;
        display: inline-block;
        /* Slight brightness boost for mobile readability */
        filter: brightness(1.05);
      }

      .event-numeral--salida::before {
        content: none;
      }

      .event-numeral--salida::after {
        content: none;
      }

      /* Metallic shine effect on numeral */
      .event-numeral::after {
        content: "I";
        position: absolute;
        left: 0;
        top: 0;
        background: linear-gradient(
          135deg,
          transparent 20%,
          rgba(255, 255, 255, 0.4) 40%,
          rgba(255, 255, 255, 0.4) 60%,
          transparent 80%
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 3s ease-in-out infinite;
      }

      @keyframes shine {
        0%, 100% { opacity: 0; }
        50% { opacity: 1; }
      }

      /* ============================================
         HERO BADGE - Domino tile (Bone Language)
         Smaller version of slam-badge for hero
         ============================================ */
      .hero-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 52px;
        height: 72px;
        margin: 0 auto 20px auto;
        background: linear-gradient(
          145deg,
          rgba(20, 14, 10, 0.9) 0%,
          rgba(12, 8, 5, 0.95) 100%
        );
        border: 2px solid var(--brass);
        border-radius: 10px;
        position: relative;
        box-shadow:
          0 0 20px rgba(212, 165, 116, 0.25),
          0 0 40px rgba(212, 165, 116, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 6px 24px rgba(0, 0, 0, 0.5);
      }

      .hero-badge::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 8px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.1) 100%
        );
        pointer-events: none;
      }

      .hero-badge__top,
      .hero-badge__bottom {
        font-family: "Bodoni Moda", serif;
        font-weight: 900;
        font-style: italic;
        letter-spacing: 0.08em;
        /* Brass-to-copper gradient — matches footer CDL */
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .hero-badge__top {
        font-size: 0.85rem;
        margin-top: 8px;
      }

      .hero-badge__divider {
        width: 36px;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--brass) 20%,
          var(--brass) 80%,
          transparent 100%
        );
        margin: 5px 0;
        opacity: 0.6;
      }

      .hero-badge__bottom {
        font-size: 1.4rem;
        font-style: italic;
        margin-bottom: 6px;
      }

      /* Mobile - slightly smaller */
      @media (max-width: 768px) {
        .hero-badge {
          width: 46px;
          height: 64px;
          margin: 0 auto 16px auto;
        }

        .hero-badge__top {
          font-size: 0.75rem;
          margin-top: 7px;
        }

        .hero-badge__divider {
          width: 30px;
          margin: 4px 0;
        }

        .hero-badge__bottom {
          font-size: 1.2rem;
          margin-bottom: 5px;
        }
      }

      /* Hero tagline - Championship stamp with decorative lines */
      /* Tobias: Clear hierarchy - this is the WHAT */
      .hero-tagline {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: clamp(0.65rem, 2.2vw, 0.85rem);
        font-weight: 600;
        color: var(--cream);
        text-transform: uppercase;
        letter-spacing: 0.18em;
        margin-top: 24px;
        margin-bottom: 14px;
        opacity: 1;
        text-shadow:
          0 0 20px rgba(0, 0, 0, 0.95),
          0 2px 15px rgba(0, 0, 0, 0.9);
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        position: relative;
      }

      /* Decorative lines on sides - championship banner feel */
      .hero-tagline::before,
      .hero-tagline::after {
        content: "";
        width: clamp(20px, 8vw, 60px);
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, var(--brass) 50%, transparent 100%);
        opacity: 0.6;
      }

      /* Hero subtitle - practical info (date + venue) */
      /* Tobias: WHERE/WHEN - readable but doesn't compete with title */
      .hero-subtitle {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: clamp(0.7rem, 1.6vw, 0.85rem);
        font-weight: 500;
        color: var(--cream);
        opacity: 0.78;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        margin-top: 6px;
        text-shadow:
          0 0 15px rgba(0, 0, 0, 0.95),
          0 2px 10px rgba(0, 0, 0, 0.9);
      }
      .hero-subtitle a {
        color: var(--brass);
        text-decoration: none;
        border-bottom: 1px solid rgba(212, 165, 116, 0.3);
        transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        display: inline-block; /* Required for transform */
      }
      .hero-subtitle a:hover {
        color: var(--cream);
        border-bottom-color: var(--cream);
        transform: translateY(-2px); /* Tobias: The Lift */
        text-shadow: 0 4px 12px rgba(0,0,0,0.5);
      }

      .hero-subtitle .dot {
        display: inline-block;
        margin: 0 0.5em;
        opacity: 0.5;
      }

      /* MOBILE HERO ENHANCEMENTS - 99% of users are on iPhone */
      @media (max-width: 768px) {
        /* La Salida needs MAXIMUM presence on mobile */
        .event-numeral--salida {
          filter: brightness(1.1);
          text-shadow:
            0 0 12px rgba(255, 252, 245, 0.7),
            0 0 35px rgba(255, 252, 245, 0.4),
            0 0 60px rgba(212, 165, 116, 0.6),
            0 0 100px rgba(212, 165, 116, 0.4),
            0 4px 20px rgba(0, 0, 0, 0.95),
            0 8px 40px rgba(0, 0, 0, 0.8);
        }

        /* Tagline bigger on mobile for readability */
        .hero-tagline {
          font-size: clamp(0.6rem, 3vw, 0.8rem);
          letter-spacing: 0.14em;
          gap: 12px;
        }

        /* Date/venue more prominent on mobile */
        .hero-subtitle {
          font-size: clamp(0.68rem, 2.8vw, 0.82rem);
          opacity: 0.82;
          letter-spacing: 0.1em;
        }
      }

      .mesa-live-text span {
        color: var(--brass);
        font-weight: 600;
      }

      /* Typography - Bodoni Moda Black for vintage cigar lounge elegance */
      .panel-headline {
        font-family: "Bodoni Moda", "Didot", "Times New Roman", serif;
        font-size: clamp(2.2rem, 10vw, 6.5rem);
        font-weight: 900;
        font-optical-sizing: auto;
        line-height: 1.1;
        margin-bottom: 20px;
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.9),
          0 4px 20px rgba(0, 0, 0, 0.7),
          0 8px 40px rgba(0, 0, 0, 0.5);
        letter-spacing: 0.06em;
      }

      /* Panel 3 crescendo - extra tension */
      .panel:nth-child(3) .panel-headline {
        letter-spacing: 0.04em;
        font-size: clamp(2.4rem, 11vw, 7rem);
      }

      @media (min-width: 768px) {
        .panel-headline {
          font-size: clamp(3.2rem, 12vw, 6.5rem);
          letter-spacing: 0.08em;
        }

        .panel:nth-child(3) .panel-headline {
          letter-spacing: 0.06em;
          font-size: clamp(3.5rem, 13vw, 7rem);
        }
      }

      .nowrap {
        white-space: nowrap;
      }

      .panel-headline .accent {
        color: inherit;
        font-style: italic;
      }

      .panel-headline .accent--italic {
        font-family: "Bodoni Moda", "Didot", serif;
        font-weight: 400;
        font-style: italic;
      }

      .panel-subtitle {
        font-size: clamp(1.1rem, 3.5vw, 1.6rem);
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        text-shadow:
          0 2px 8px rgba(0, 0, 0, 0.8),
          0 4px 20px rgba(0, 0, 0, 0.5);
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .panel-subtitle--italic {
        font-family: "Bodoni Moda", "Didot", serif;
        font-style: italic;
        font-weight: 400;
        text-transform: none;
        letter-spacing: 0.02em;
      }

      /* Panel greeting - small Cuban welcome quote */
      .panel-greeting {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        font-style: italic;
        font-weight: 400;
        color: var(--brass);
        letter-spacing: 0.15em;
        margin-bottom: 1.5em;
        opacity: 0.9;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        animation: fadeInUp 0.8s ease-out 0.2s both;
      }

      /* Whisper subtitle - elegant italic like "presents" */
      .panel-whisper {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: clamp(1rem, 3.5vw, 1.8rem);
        font-style: italic;
        font-weight: 400;
        color: rgba(248, 239, 230, 0.55); /* Softer cream for "memory" feel */
        letter-spacing: 0.15em;
        margin-top: 0.6em;
        text-shadow:
          0 2px 10px rgba(0, 0, 0, 0.9);
        animation: fadeIn 2s ease-out 0.5s both;
      }

      /* ========================================
         CINEMATIC STORYTELLING - Three Scenes
         Scene 1: The Whisper (greeting + tension)
         Scene 2: The Revelation (the twist)
         Scene 3: The Stakes (winner takes all)
         ======================================== */

      /* ================================================
         SCENE 1: THE CINEMATIC FRAME
         Letterbox bars create intentional text zones.
         This is CINEMA, not a legibility hack.
         Top = His greeting. Bottom = The tension.
         Center = The man, unobstructed.
         ================================================ */

      .panel--whisper {
        justify-content: center;
        align-items: center;
        padding: 0;
      }

      .panel--whisper .whisper-top,
      .panel--whisper .whisper-bottom {
        opacity: 0;
        transition: opacity 420ms ease;
      }

      .panel--whisper.in-view .whisper-top,
      .panel--whisper.in-view .whisper-bottom {
        opacity: 1;
      }

      /* Revisit: subtle "breath" (not a full replay) to keep the room alive */
      .panel--whisper.reentering .whisper-top,
      .panel--whisper.reentering .whisper-bottom,
      .panel--build.reentering .build-top,
      .panel--build.reentering .build-center,
      .panel--build.reentering .build-bottom,
      .panel--slam.reentering .slam-top,
      .panel--slam.reentering .slam-center,
      .panel--slam.reentering .slam-bottom {
        animation: revisitBreath 380ms ease-out both;
      }

      /* Rules plaque - separate animation without opacity (has transparent bg) */
      .panel--rules.reentering .rules-plaque {
        animation: revisitBreathNoOpacity 380ms ease-out both;
      }

      @keyframes revisitBreathNoOpacity {
        from { transform: translateY(2px) scale(1.01); }
        to { transform: translateY(0) scale(1); }
      }

      @keyframes revisitBreath {
        from { opacity: 0.82; transform: translateY(2px) scale(1.01); }
        to { opacity: 1; transform: translateY(0) scale(1); }
      }

      /* iOS fix: ensure full opacity when panel is in view */
      .panel--whisper.in-view .whisper-top,
      .panel--whisper.in-view .whisper-bottom {
        opacity: 1;
      }

      /* TOP LETTERBOX - The Greeting descends from darkness */
      .whisper-top {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 8vh 8vw 12vh; /* Left padding for dialogue feel */
        background: linear-gradient(
          to bottom,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.9) 30%,
          rgba(10, 7, 5, 0.6) 60%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        justify-content: flex-start; /* Left-aligned — he's talking to you */
        pointer-events: none;
      }

      .whisper-greeting {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: clamp(1.3rem, 5vw, 2rem);
        color: rgba(255, 255, 255, 0.95);
        letter-spacing: 0.15em;
        text-align: left; /* Left-aligned — feels like dialogue, he's talking to you */
        opacity: 0;
        /* Cinematic text shadow — words forming from smoke */
        text-shadow:
          0 0 40px rgba(212, 165, 116, 0.5),
          0 0 80px rgba(212, 165, 116, 0.3),
          0 4px 20px rgba(0, 0, 0, 0.8);
      }

      /* BOTTOM LETTERBOX - Dialogue continues from him */
      .whisper-bottom {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 12vh 8vw 14vh; /* Match top padding for dialogue feel */
        background: linear-gradient(
          to top,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.9) 30%,
          rgba(10, 7, 5, 0.6) 60%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* Left-aligned — continuous dialogue */
        text-align: left;
        pointer-events: none;
      }

      .whisper-narrative {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.2vh;
      }

      .whisper-line {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        color: var(--brass);
        opacity: 0;
        transition: opacity 420ms ease;
        letter-spacing: 0.05em;
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      }

      /* THE LINE - "You've been waiting for this." - the moment arrives */
      .whisper-line--ancestors {
        font-size: clamp(1.4rem, 5vw, 2.2rem); /* Slightly smaller to fit on one line */
        color: rgba(255, 255, 255, 0.85);
        letter-spacing: 0.06em;
        margin-bottom: 3vh;
        white-space: nowrap; /* Keep on one line */
        text-shadow:
          0 0 40px rgba(212, 165, 116, 0.4),
          0 4px 25px rgba(0, 0, 0, 0.7);
      }

      /* "They" — the ancestors, emphasized in brass */
      .ancestors-they {
        font-style: normal;
        color: var(--brass);
        text-shadow:
          0 0 30px rgba(212, 165, 116, 0.8),
          0 0 60px rgba(212, 165, 116, 0.5),
          0 0 100px rgba(212, 165, 116, 0.3);
      }

      /* Animation for ancestors line - delayed, weighted, the truth arrives */
      .panel--whisper.in-view:not(.has-played) .whisper-line--ancestors {
        animation: ancestorsTruth 2s cubic-bezier(0.16, 1, 0.3, 1) 3.5s forwards;
      }

      /* The ancestors speak - slow dawning realization */
      @keyframes ancestorsTruth {
        0% {
          opacity: 0;
          transform: translateY(30px) scale(0.95);
          filter: blur(12px);
          letter-spacing: 0.15em;
        }
        40% {
          opacity: 0.7;
          filter: blur(4px);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
          letter-spacing: 0.08em;
        }
      }

      .panel--whisper.has-played .whisper-line--ancestors {
        opacity: 1;
        transform: none;
        filter: none;
      }

      /* THE LINE - The challenge that sets up INHERITED */
      .whisper-line--mystery {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.3em;
        font-style: italic;
        font-weight: 400;
        color: var(--cream);
        letter-spacing: 0.02em;
        margin-top: 2vh;
        text-shadow:
          0 0 30px rgba(212, 165, 116, 0.4),
          0 4px 25px rgba(0, 0, 0, 0.6);
      }

      /* Top line - smaller setup */
      .whisper-line__top {
        font-size: clamp(1.4rem, 5vw, 2rem);
        opacity: 0.85;
      }

      /* Bottom line - THE moment with "learned" */
      .whisper-line__bottom {
        font-size: clamp(2.2rem, 9vw, 4rem);
        font-weight: 500;
      }

      /* Callback word "learned" - brass glow thread to Panel 3 */
      .callback-word {
        font-style: italic;
        color: var(--brass);
        text-shadow:
          0 0 25px rgba(212, 165, 116, 0.7),
          0 0 50px rgba(212, 165, 116, 0.4);
      }

      /* Cinematic animations - slow, weighted, like memories surfacing */
      .panel--whisper.in-view:not(.has-played) .whisper-greeting {
        animation: greetingSmoke 2.5s cubic-bezier(0.16, 1, 0.3, 1) 0.5s forwards;
      }

      .panel--whisper.in-view:not(.has-played) .whisper-line--mystery {
        animation: mysterySlam 1.4s cubic-bezier(0.16, 1, 0.3, 1) 2.2s forwards;
      }

      /* Mystery slam - THE LINE hits with weight */
      @keyframes mysterySlam {
        0% {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
          filter: blur(8px);
        }
        50% {
          opacity: 1;
          transform: translateY(-3px) scale(1.01);
          filter: blur(0);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
          text-shadow:
            0 0 40px rgba(212, 165, 116, 0.5),
            0 2px 20px rgba(0, 0, 0, 0.6);
        }
      }

      /* Greeting forms from cigar smoke - slow, deliberate, intimate */
      @keyframes greetingSmoke {
        0% {
          opacity: 0;
          transform: translateY(15px) scale(0.92);
          filter: blur(20px);
          letter-spacing: 0.25em;
        }
        30% {
          opacity: 0.5;
          filter: blur(10px);
        }
        60% {
          opacity: 0.85;
          filter: blur(3px);
          letter-spacing: 0.18em;
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
          letter-spacing: 0.15em;
          text-shadow:
            0 0 50px rgba(212, 165, 116, 0.6),
            0 0 100px rgba(212, 165, 116, 0.3),
            0 4px 20px rgba(0, 0, 0, 0.8);
        }
      }

      /* Simple greeting reveal - fallback */
      @keyframes greetingReveal {
        0% {
          opacity: 0;
          transform: translateY(8px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Greeting reveals right-to-left - smoother, smoky, jazz-like */
      @keyframes greetingRevealRTL {
        0% {
          opacity: 0;
          transform: translateX(30px) scale(0.98);
          filter: blur(12px);
        }
        100% {
          opacity: 1;
          transform: translateX(0) scale(1);
          filter: blur(0);
        }
      }

      @keyframes cinematicReveal {
        0% {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
          filter: blur(8px);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      @keyframes wordBuild {
        0% {
          opacity: 0;
          transform: translateY(15px);
          filter: blur(4px);
        }
        100% {
          opacity: 0.8;
          transform: translateY(0);
          filter: blur(0);
        }
      }

      @keyframes wordBuildFinal {
        0% {
          opacity: 0;
          transform: translateY(15px) scale(0.9);
          filter: blur(4px);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* Scroll indicator - appears after narrative completes */
      /* Part of flex flow inside whisper-bottom, not absolutely positioned */
      .whisper-scroll-hint {
        margin-top: 3vh;
        opacity: 0;
        transition: opacity 420ms ease;
        pointer-events: none;
        display: flex;
        justify-content: center;
      }

      .whisper-scroll-hint__chevron {
        width: 18px;
        height: 18px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.5;
      }

      .panel--whisper.in-view .whisper-scroll-hint {
        animation: scrollHintReveal 1s ease-out 4s forwards;
      }

      /* Once played: returning should feel "static" and inevitable (no replays). */
      .panel--whisper.has-played .whisper-greeting {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--whisper.has-played .whisper-line--mystery {
        opacity: 1;
        transform: none;
        filter: none;
        text-shadow:
          0 0 40px rgba(212, 165, 116, 0.5),
          0 2px 20px rgba(0, 0, 0, 0.6);
      }
      .panel--whisper.has-played .whisper-scroll-hint {
        opacity: 1;
      }

      @keyframes scrollHintReveal {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      /* Hero scroll hint - appears after the hero has time to breathe */
      .hero-scroll-hint {
        position: absolute;
        left: 0;
        right: 0;
        bottom: calc(46px + 80px); /* Higher - consistent with other panels */
        z-index: 12;
        display: flex;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
      }
      @media (max-width: 768px) {
        .hero-scroll-hint {
          bottom: calc(40px + 60px);
        }
      }
      .hero-scroll-hint__chevron {
        width: 18px;
        height: 18px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.45;
      }
      .hero-scroll-hint.is-ready {
        animation: scrollHintReveal 1s ease-out forwards;
      }

      /* ================================================
         SCENE 2: THE REVELATION - The Cinematic Climax
         "You didn't learn this game. You inherited it."
         The word "inherited" is the SLAM moment.
         ================================================ */

      .panel--build {
        justify-content: center;
        align-items: center;
        padding: 0;
      }

      /* TOP LETTERBOX - The setup whispered from darkness */
      .build-top {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 8vh 6vw 14vh; /* Generous top breathing */
        background: linear-gradient(
          to bottom,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.9) 30%,
          rgba(10, 7, 5, 0.5) 70%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        justify-content: center;
        pointer-events: none;
      }

      .build-setup {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: clamp(1rem, 4vw, 1.5rem);
        color: rgba(255, 255, 255, 0.88);
        letter-spacing: 0.12em;
        text-align: center;
        opacity: 0;
        transition: opacity 420ms ease;
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      }

      /* CENTER - The revelation commands the space */
      .build-center {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        pointer-events: none;
      }

      .build-revelation {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
      }

      .build-word {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        opacity: 0;
        transition: opacity 420ms ease;
      }

      /* "It was" - the setup on one line */
      .build-word--itwas {
        font-size: clamp(1.4rem, 5vw, 2.2rem);
        color: rgba(212, 165, 116, 0.98);
        letter-spacing: 0.06em;
        margin-bottom: 1.5vh;
        text-shadow:
          0 0 16px rgba(212, 165, 116, 0.22),
          0 2px 15px rgba(0, 0, 0, 0.5);
      }

      /* "INHERITED." - THE SINGLE WORD. Alone. Massive. The truth. */
      .build-word--inherited {
        font-size: clamp(3.5rem, 18vw, 10rem); /* Massive — it stands alone */
        font-style: normal;
        color: #fff;
        font-weight: 500;
        letter-spacing: 0.1em;
        line-height: 0.85;
        /* Luminous glow - the ancestors are speaking through this word */
        text-shadow:
          0 0 25px rgba(255, 255, 255, 0.35),
          0 0 50px rgba(212, 165, 116, 0.7),
          0 0 100px rgba(212, 165, 116, 0.5),
          0 0 150px rgba(212, 165, 116, 0.25),
          0 8px 50px rgba(0, 0, 0, 0.8);
      }

      /* BOTTOM LETTERBOX - Scroll hint emerges after revelation */
      .build-bottom {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 10vh 6vw 14vh;
        background: linear-gradient(
          to top,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.85) 30%,
          rgba(10, 7, 5, 0.4) 70%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        pointer-events: none;
      }

      .build-scroll-hint {
        opacity: 0;
        transition: opacity 420ms ease;
        display: flex;
        justify-content: center;
      }

      .build-scroll-hint__chevron {
        width: 18px;
        height: 18px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.5;
      }

      /* Scene 2 animation sequence - timed for impact */
      .panel--build.in-view:not(.has-played) .build-setup {
        animation: cinematicReveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) 0.2s forwards;
      }

      /* "INHERITED." appears alone - slow dawning, not a slam */
      .panel--build.in-view:not(.has-played) .build-word--inherited {
        animation: inheritedDawning 3s cubic-bezier(0.16, 1, 0.3, 1) 0.8s forwards;
      }

      .panel--build.in-view:not(.has-played) .build-scroll-hint {
        animation: scrollHintReveal 1s ease-out 4s forwards;
      }

      .panel--build.has-played .build-setup {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--build.has-played .build-word--itwas {
        opacity: 1;
        transform: none;
        filter: none;
      }

      /* Like wordBuild, but lands at full presence */
      @keyframes wordBuildBright {
        0% {
          opacity: 0;
          transform: translateY(15px);
          filter: blur(4px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
        }
      }
      .panel--build.has-played .build-word--inherited {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--build.has-played .build-scroll-hint {
        opacity: 1;
      }

      /* The SLAM - "inherited" hits like a domino on the table */
      @keyframes revelationSlam {
        0% {
          opacity: 0;
          transform: translateY(50px) scale(0.8);
          filter: blur(15px);
        }
        40% {
          opacity: 1;
          filter: blur(0);
        }
        55% {
          transform: translateY(-5px) scale(1.02);
        }
        70% {
          transform: translateY(2px) scale(0.99);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* "INHERITED." dawns like a memory surfacing - slow, weighted, inevitable */
      @keyframes inheritedDawning {
        0% {
          opacity: 0;
          transform: scale(0.85);
          filter: blur(25px);
          letter-spacing: 0.2em;
        }
        20% {
          opacity: 0.3;
          filter: blur(15px);
        }
        50% {
          opacity: 0.7;
          filter: blur(5px);
          letter-spacing: 0.12em;
        }
        80% {
          opacity: 0.95;
          filter: blur(1px);
        }
        100% {
          opacity: 1;
          transform: scale(1);
          filter: blur(0);
          letter-spacing: 0.1em;
          text-shadow:
            0 0 30px rgba(255, 255, 255, 0.4),
            0 0 60px rgba(212, 165, 116, 0.8),
            0 0 120px rgba(212, 165, 116, 0.5),
            0 0 180px rgba(212, 165, 116, 0.3);
        }
      }

      /* ================================================
         SCENE 3: THE MISSION - Make Them Proud
         The final word "PROUD" is the emotional slam.
         This is why you're here. For them.
         ================================================ */

      .panel--slam {
        justify-content: center;
        align-items: center;
        padding: 0;
      }

      /* TOP LETTERBOX - Event context sets the stage */
      .slam-top {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 14vh 6vw 8vh;
        background: linear-gradient(
          to bottom,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.85) 40%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        pointer-events: none;
      }

      /* CENTER - The stakes command attention */
      .slam-center {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        pointer-events: none;
      }

      /* ============================================
         CDL 1 BADGE - The Bone Language
         A domino tile as championship marker
         ============================================ */
      .slam-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 70px;
        height: 100px;
        margin-bottom: 3vh;
        background: linear-gradient(
          145deg,
          rgba(20, 14, 10, 0.95) 0%,
          rgba(12, 8, 5, 0.98) 100%
        );
        border: 2px solid var(--brass);
        border-radius: 12px; /* Bone Language */
        position: relative;
        opacity: 0;
        /* Brass glow - championship energy */
        box-shadow:
          0 0 20px rgba(212, 165, 116, 0.3),
          0 0 40px rgba(212, 165, 116, 0.15),
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 8px 32px rgba(0, 0, 0, 0.5);
      }

      /* Subtle shine overlay - metallic feel */
      .slam-badge::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.1) 100%
        );
        pointer-events: none;
      }

      .slam-badge__top,
      .slam-badge__bottom {
        font-family: "Bodoni Moda", serif;
        font-weight: 900;
        font-style: italic;
        letter-spacing: 0.08em;
        /* Brass-to-copper gradient — matches footer CDL */
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .slam-badge__top {
        font-size: 1.1rem;
        margin-top: 12px;
      }

      .slam-badge__divider {
        width: 50px;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--brass) 20%,
          var(--brass) 80%,
          transparent 100%
        );
        margin: 8px 0;
        opacity: 0.7;
      }

      .slam-badge__bottom {
        font-size: 1.8rem;
        font-style: italic;
        margin-bottom: 8px;
      }

      /* Badge animation - appears first, sets the stage */
      .panel--slam.in-view:not(.has-played) .slam-badge {
        animation: badgeReveal 1s cubic-bezier(0.16, 1, 0.3, 1) 0.1s forwards;
      }

      .panel--slam.has-played .slam-badge {
        opacity: 1;
      }

      @keyframes badgeReveal {
        0% {
          opacity: 0;
          transform: scale(0.8) translateY(10px);
          filter: blur(4px);
        }
        60% {
          transform: scale(1.02) translateY(0);
        }
        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
          filter: blur(0);
        }
      }

      .slam-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
      }

      .slam-word {
        font-family: "Bodoni Moda", serif;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        line-height: 0.85;
        opacity: 0;
        transition: opacity 420ms ease;
      }

      .slam-word--winner {
        font-size: clamp(2.2rem, 10vw, 5rem);
        color: rgba(255, 255, 255, 0.65);
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      }

      .slam-word--takes {
        font-size: clamp(2.6rem, 12vw, 6rem);
        color: rgba(255, 255, 255, 0.8);
        text-shadow: 0 2px 25px rgba(0, 0, 0, 0.5);
      }

      /* "ALL" - THE MONEY. Everything on the line. */
      .slam-word--all {
        font-size: clamp(4.5rem, 22vw, 14rem);
        color: #fff;
        line-height: 0.8;
        /* Gold glow - money should SHINE */
        text-shadow:
          0 0 40px rgba(212, 165, 116, 0.6),
          0 0 80px rgba(212, 165, 116, 0.4),
          0 0 120px rgba(212, 165, 116, 0.2),
          0 4px 40px rgba(0, 0, 0, 0.6);
      }

      /* BOTTOM LETTERBOX - Scroll hint after the stakes */
      .slam-bottom {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
        padding: 8vh 6vw 14vh;
        background: linear-gradient(
          to top,
          rgba(10, 7, 5, 0.98) 0%,
          rgba(10, 7, 5, 0.85) 40%,
          rgba(10, 7, 5, 0) 100%
        );
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        pointer-events: none;
      }

      .slam-scroll-hint {
        opacity: 0;
        transition: opacity 420ms ease;
        display: flex;
        justify-content: center;
      }

      .slam-scroll-hint__chevron {
        width: 18px;
        height: 18px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.5;
      }

      /* Scene 3 animation sequence - context first, then rapid fire SLAM */
      .panel--slam.in-view:not(.has-played) .slam-word--winner {
        animation: slamWord 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.5s forwards;
      }

      .panel--slam.in-view:not(.has-played) .slam-word--takes {
        animation: slamWord 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.8s forwards;
      }

      .panel--slam.in-view:not(.has-played) .slam-word--all {
        animation: slamFinal 1.2s cubic-bezier(0.16, 1, 0.3, 1) 1.2s forwards;
      }

      .panel--slam.in-view:not(.has-played) .slam-scroll-hint {
        animation: scrollHintReveal 1s ease-out 2.8s forwards;
      }

      .panel--slam.has-played .slam-word {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--slam.has-played .slam-scroll-hint {
        opacity: 1;
      }

      /* Event context - grounds the stakes in reality */
      .slam-context {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: clamp(0.65rem, 2vw, 0.8rem);
        font-weight: 500;
        color: var(--cream);
        opacity: 0;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        margin-bottom: 3vh;
        text-shadow: 0 2px 15px rgba(0, 0, 0, 0.9);
      }

      .slam-context .dot {
        display: inline-block;
        margin: 0 0.6em;
        color: var(--brass);
        opacity: 0.6;
      }

      /* Animation - context loads FIRST, sets the stage */
      .panel--slam.in-view:not(.has-played) .slam-context {
        animation: fadeInDown 0.8s ease-out 0s forwards;
      }

      .panel--slam.has-played .slam-context {
        opacity: 0.75;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 0.75;
          transform: translateY(0);
        }
      }

      @keyframes slamWord {
        0% {
          opacity: 0;
          transform: translateY(-20px) scale(1.1);
          filter: blur(4px);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      @keyframes slamFinal {
        0% {
          opacity: 0;
          transform: translateY(-40px) scale(1.3);
          filter: blur(10px);
        }
        50% {
          opacity: 1;
          transform: translateY(8px) scale(0.96);
          filter: blur(0);
        }
        70% {
          transform: translateY(-4px) scale(1.01);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* Mobile adjustments for cinematic panels */
      @media (max-width: 768px) {
        /* Cinematic frame - still breathe on mobile */
        .whisper-top {
          padding: max(50px, 6vh) 5vw 10vh; /* Never less than 50px from top */
        }

        .whisper-bottom {
          padding: 10vh 5vw 16vh; /* Extra space for La Mesa */
        }

        .whisper-greeting {
          font-size: clamp(0.9rem, 3.5vw, 1.2rem); /* Small whisper */
        }

        /* Mobile: Larger, bolder for impact on small screens */
        .whisper-line--challenge {
          font-size: clamp(1.2rem, 5vw, 1.6rem);
        }

        .whisper-line--counter {
          font-size: clamp(1.4rem, 6vw, 1.9rem);
        }

        .whisper-line__top {
          font-size: clamp(1.2rem, 4.5vw, 1.6rem);
        }

        .whisper-line__bottom {
          font-size: clamp(1.8rem, 8vw, 2.8rem);
        }

        /* Panel 3 mobile - cinematic frame */
        .build-top {
          padding: max(50px, 6vh) 5vw 12vh; /* Never less than 50px from top */
        }

        .build-bottom {
          padding: 8vh 5vw 16vh;
        }

        .build-setup {
          font-size: clamp(0.9rem, 3.5vw, 1.2rem);
        }

        .build-word--itwas {
          font-size: clamp(1.2rem, 5vw, 1.8rem);
        }

        .build-word--inherited {
          font-size: clamp(2.2rem, 11vw, 4rem); /* Reduced for uppercase */
        }

        /* Panel 4 mobile - cinematic frame */
        .slam-top {
          padding: 12vh 5vw 6vh;
        }

        .slam-bottom {
          padding: 6vh 5vw 16vh;
        }

        /* CDL badge mobile - slightly smaller */
        .slam-badge {
          width: 60px;
          height: 85px;
          margin-bottom: 2.5vh;
        }

        .slam-badge__top {
          font-size: 0.95rem;
          margin-top: 10px;
        }

        .slam-badge__divider {
          width: 40px;
          margin: 6px 0;
        }

        .slam-badge__bottom {
          font-size: 1.5rem;
          margin-bottom: 6px;
        }

        .slam-word--winner {
          font-size: clamp(2rem, 12vw, 4rem);
        }

        .slam-word--takes {
          font-size: clamp(2.4rem, 14vw, 5rem);
        }

        .slam-word--all {
          font-size: clamp(3.5rem, 22vw, 9rem);
        }

        /* Event context - slightly larger on mobile for readability */
        .slam-context {
          font-size: clamp(0.6rem, 2.8vw, 0.75rem);
          letter-spacing: 0.1em;
          margin-bottom: 2.5vh;
        }
      }

      .panel-subtitle--attitude {
        font-style: italic;
        text-transform: none;
        font-size: clamp(1.3rem, 4vw, 2rem);
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 12px;
        letter-spacing: 0.02em;
      }

      .panel-subtitle--details {
        font-size: clamp(0.9rem, 2.5vw, 1.2rem);
        margin-top: 8px;
      }

      .panel-subtitle .dot {
        color: var(--copper);
        margin: 0 10px;
      }

      /* Scroll Indicator */
      .scroll-indicator {
        position: absolute;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
        animation: bounce 2s infinite;
      }

      .scroll-indicator svg {
        width: 24px;
        height: 24px;
      }

      @keyframes bounce {
        0%, 100% { transform: translateX(-50%) translateY(0); }
        50% { transform: translateX(-50%) translateY(8px); }
      }

      /* Progress Tracker */
      .progress-tracker {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 14px 18px;
        margin-top: 18px;
        margin-bottom: 18px;
        max-width: 400px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .progress-count {
        font-size: 1.1rem;
      }

      .progress-count .number {
        color: var(--brass);
        font-family: "Bodoni Moda", serif;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .progress-spots {
        color: var(--copper);
        font-size: 0.95rem;
      }

      .progress-bar {
        height: 10px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 99px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--copper), var(--brass));
        border-radius: 99px;
        transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
      }

      /* Shimmer effect on progress bar */
      .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s ease-in-out infinite;
        animation-delay: 1.5s;
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      .progress-cta {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        text-align: center;
      }

      /* Who's In Section */
      .whos-in {
        max-width: 400px;
        width: 100%;
        margin: 0 auto 20px;
        text-align: center;
      }

      .whos-in__title {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 12px;
      }

      .whos-in__list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }

      .whos-in__team {
        background: rgba(183, 106, 59, 0.15);
        border: 1px solid rgba(183, 106, 59, 0.3);
        border-radius: 12px;
        padding: 10px 14px;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .whos-in__team:hover {
        background: rgba(183, 106, 59, 0.25);
        transform: translateY(-4px); /* Tobias: The Lift */
        box-shadow: 
          0 8px 24px rgba(0, 0, 0, 0.4),
          0 0 15px rgba(212, 165, 116, 0.1);
      }

      .whos-in__team-name {
        font-family: "Bodoni Moda", serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--brass);
        margin-bottom: 2px;
      }

      .whos-in__players {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .whos-in__empty {
        color: rgba(255, 255, 255, 0.4);
        font-style: italic;
        font-size: 0.9rem;
      }

      /* Individual Player Display */
      .whos-in__player {
        background: rgba(183, 106, 59, 0.12);
        border: 1px solid rgba(183, 106, 59, 0.25);
        border-radius: 20px;
        padding: 8px 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .whos-in__player:hover {
        background: rgba(183, 106, 59, 0.2);
        transform: translateY(-3px); /* Tobias: The Lift */
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
      }

      .whos-in__player-name {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--cream);
      }

      .whos-in__player-badge {
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--copper);
        background: rgba(183, 106, 59, 0.2);
        border-radius: 4px;
        padding: 2px 6px;
      }

      /* Chat Widget - The Sacred Table (Amber Glass & Brass) */
      .chat-widget--hidden {
        display: none !important;
      }

      .chat-widget {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10001; /* Must be higher than chat-backdrop (10000) */
        font-family: "IBM Plex Sans", sans-serif;
        background: transparent;
        pointer-events: none; /* Allow interaction with content behind ticker */
      }
      .chat-widget > * {
        pointer-events: auto; /* Re-enable for children */
      }

      /* ===========================================
         THE BONE LANGUAGE - Domino Tile Button
         "Put the bone in their face." — George Lois
         =========================================== */
      .chat-toggle {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        gap: 0;
        width: 84px;
        height: 135px;
        background: linear-gradient(
          180deg,
          #f5f0e6 0%,
          #e8e0d0 50%,
          #ddd5c5 100%
        );
        border: none;
        border-radius: 14px;
        padding: 0;
        cursor: pointer;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(212, 165, 116, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.5),
          inset 0 -2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        position: relative;
        overflow: visible;
        animation: boneHeartbeat 3s ease-in-out infinite;
      }

      /* Heartbeat pulse - the bone is alive */
      @keyframes boneHeartbeat {
        0%, 100% {
          transform: scale(1);
          box-shadow:
            0 8px 32px rgba(0, 0, 0, 0.5),
            0 0 0 1px rgba(212, 165, 116, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.5),
            inset 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
        50% {
          transform: scale(1.02);
          box-shadow:
            0 10px 40px rgba(0, 0, 0, 0.55),
            0 0 0 1px rgba(212, 165, 116, 0.5),
            0 0 30px rgba(212, 165, 116, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.5),
            inset 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
      }

      /* Domino pip pattern - 5 pips like the "5" side of a die */
      .chat-toggle::before {
        content: '';
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: 54px;
        height: 54px;
        background:
          radial-gradient(circle at 25% 25%, rgba(183, 106, 59, 0.45) 6px, transparent 6px),
          radial-gradient(circle at 75% 25%, rgba(183, 106, 59, 0.45) 6px, transparent 6px),
          radial-gradient(circle at 50% 50%, rgba(183, 106, 59, 0.45) 6px, transparent 6px),
          radial-gradient(circle at 25% 75%, rgba(183, 106, 59, 0.45) 6px, transparent 6px),
          radial-gradient(circle at 75% 75%, rgba(183, 106, 59, 0.45) 6px, transparent 6px);
        pointer-events: none;
      }

      /* Horizontal divider line - the bone's spine */
      .chat-toggle::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 10px;
        right: 10px;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(183, 106, 59, 0.4) 15%,
          rgba(183, 106, 59, 0.4) 85%,
          transparent 100%
        );
        pointer-events: none;
      }

      .chat-toggle:hover {
        animation: none;
        transform: translateY(-8px) scale(1.04); /* Tobias: Enhanced Lift */
        box-shadow:
          0 24px 60px rgba(0, 0, 0, 0.7),
          0 0 0 1px rgba(212, 165, 116, 0.6),
          0 0 80px rgba(212, 165, 116, 0.25),
          inset 0 1px 0 rgba(255, 255, 255, 0.5),
          inset 0 -2px 4px rgba(0, 0, 0, 0.1);
      }

      .chat-toggle__text {
        font-family: "Bodoni Moda", serif;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--copper);
        padding: 8px 6px 14px;
        text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
      }

      /* Hide the old pulsing dot - pips are the new icon */
      .chat-toggle__icon {
        display: none;
      }

      .chat-toggle__badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--copper);
        color: #fff;
        font-family: "Bodoni Moda", serif;
        font-size: 0.75rem;
        min-width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        box-shadow: 0 3px 12px rgba(0,0,0,0.5);
        border: 2px solid #f5f0e6;
      }

      /* Chat Panel - The Vessel */
      .chat-panel {
        position: fixed;
        bottom: 0;
        right: 24px;
        width: 400px;
        height: 600px;
        max-height: 80vh;
        overscroll-behavior: contain; /* Prevent scroll chaining to body */
        background:
          radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.4) 100%),
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E"),
          linear-gradient(180deg, rgb(28, 19, 15) 0%, rgb(20, 14, 11) 100%);
        background-blend-mode: normal, overlay, normal;
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 16px 16px 0 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 -12px 48px rgba(0,0,0,0.6);
        z-index: 10003; /* Above ticker (10002) */
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
        opacity: 0;
        pointer-events: none; /* Prevent interaction when closed */
      }

      @media (max-width: 768px) {
        .chat-panel {
          right: 0;
          left: 0;
          width: 100%;
          bottom: 0;
          height: 80vh;
          border-radius: 20px 20px 0 0;

        }
      }

      /* Subtle wood grain accent on left edge */
      .chat-panel::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: repeating-linear-gradient(
          180deg,
          rgba(139, 90, 43, 0.15) 0px,
          rgba(139, 90, 43, 0.08) 2px,
          transparent 2px,
          transparent 6px
        );
        pointer-events: none;
        z-index: 11;
      }

      .chat-panel.is-open {
        transform: translateY(0);
        opacity: 1;
        pointer-events: auto; /* Enable interaction when open */
      }

      .chat-panel.is-closing {
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
      }

      /* Background Dimming for Chat Overlay */
      .chat-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 10000; /* Just below chat panel */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease, visibility 0.4s ease;
      }

      .chat-backdrop.is-visible {
        opacity: 1;
        visibility: visible;
      }

      /* Header - The Inscription */
      .chat-header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 20px 24px;
        position: relative;
        border-bottom: 1px solid rgba(212, 165, 116, 0.1);
        flex-shrink: 0;
        z-index: 10;
        background: inherit;
      }

      /* Drag handle for mobile (visual affordance) */
      .chat-header__drag-handle {
        grid-column: 1;
        justify-self: start;
        width: 32px;
        height: 4px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 2px;
        display: none; /* Show only on mobile via media query */
      }

      .chat-header__title-group {
        grid-column: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .chat-header__title {
        font-family: "Bodoni Moda", serif;
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--brass);
        text-transform: uppercase;
        letter-spacing: 0.15em; /* Wes: precisely 0.15em */
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        position: relative;
        padding-bottom: 8px;
      }

      /* Brass underline - "Like a sign above a door" — Herb Lubalin
         LA MESA is a PLACE. You have arrived. */
      .chat-header__title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 80px;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--brass) 20%,
          var(--brass) 80%,
          transparent 100%
        );
        border-radius: 1px;
      }

      .chat-header__subtitle {
        font-family: "Bodoni Moda", serif;
        font-size: 0.6rem;
        color: var(--copper);
        opacity: 0.4; /* Wes: reduce opacity to 0.4 */
        letter-spacing: 0.08em;
        font-variant: small-caps; /* Wes: small-caps, not uppercase */
        margin-top: 6px;
      }

      /* Decorative accent below subtitle */
      .chat-header__title-group::after {
        content: "";
        display: block;
        width: 6px;
        height: 6px;
        background: var(--copper);
        margin: 10px auto 0;
        opacity: 0.4;
        border-radius: 50%;
      }

      .chat-header__close {
        position: absolute;
        right: 16px;
        top: 16px;
        background: rgba(20, 14, 11, 0.55);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(212, 165, 116, 0.18);
        color: rgba(212, 165, 116, 0.8);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.62rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        z-index: 20;
      }

      .chat-header__close::before {
        content: "←";
        font-size: 0.95rem;
        transition: transform 0.3s ease;
      }

      .chat-header__close-label {
        display: inline-block;
        line-height: 1;
      }

      .chat-header__close:hover {
        background: rgba(28, 19, 15, 0.75);
        color: #fff;
        border-color: rgba(212, 165, 116, 0.35);
        transform: translateY(-1px);
      }

      .chat-header__close:hover::before {
        transform: translateX(-2px);
      }

      .chat-header__close:active {
        transform: translateY(0) scale(0.96);
      }

      /* Content Area */
      .chat-body-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scrollbar-width: thin;
        scrollbar-color: var(--muted) transparent;
        position: relative;
        /* Warm fog gradient - tobacco smoke atmosphere (Wes: amber in the shadows) */
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.25) 0%,
          rgba(20, 14, 11, 0.15) 30%,
          rgba(28, 19, 15, 0.05) 70%,
          transparent 100%
        );
      }

      /* Tobias: Live Smoke Filter for Chat Background */
      .chat-messages::after {
        content: '';
        position: absolute;
        inset: 0;
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.015' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        mix-blend-mode: overlay;
        opacity: 0.5;
        pointer-events: none;
        z-index: 1;
      }

      .chat-messages::-webkit-scrollbar { width: 4px; }
      .chat-messages::-webkit-scrollbar-track { background: transparent; }
      .chat-messages::-webkit-scrollbar-thumb { background: var(--muted); }

      /* Entrance Announcement - George: Make entrances MATTER */
      .chat-announcement {
        text-align: center;
        padding: 12px 16px;
        font-family: "Bodoni Moda", serif;
        font-size: 0.8rem;
        color: var(--copper);
        letter-spacing: 0.05em;
        opacity: 0.8;
        animation: announceFade 0.6s ease-out;
        position: relative;
      }

      .chat-announcement::before,
      .chat-announcement::after {
        content: '';
        position: absolute;
        top: 50%;
        width: 40px;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(183, 106, 59, 0.3), transparent);
      }

      .chat-announcement::before { left: 20px; }
      .chat-announcement::after { right: 20px; }

      .chat-announcement__icon {
        margin-right: 8px;
      }

      .chat-announcement__name {
        color: var(--brass);
        font-weight: 600;
      }

      @keyframes announceFade {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 0.8;
          transform: scale(1);
        }
      }

      /* ===========================================
         LA MESA MESSAGE STYLING
         "Make them feel like they're at the table."
         =========================================== */

      .chat-message {
        padding: 14px 16px;
        margin: 6px 0;
        border-radius: 12px;
        background: rgba(28, 19, 15, 0.5);
        border: 1px solid rgba(212, 165, 116, 0.06);
        animation: weightedArrival 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
        transition: all 0.2s ease;
        position: relative;
      }

      /* Tobias: Weighted Arrival - slide + blur + scale */
      @keyframes weightedArrival {
        from {
          opacity: 0;
          transform: translateY(12px) scale(0.98);
          filter: blur(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }

      /* Staggered message entry for rhythm */
      .chat-message:nth-child(3n+1) { animation-delay: 0ms; }
      .chat-message:nth-child(3n+2) { animation-delay: 40ms; }
      .chat-message:nth-child(3n) { animation-delay: 80ms; }

      /* Others - subtle left accent */
      .chat-message:not(.chat-message--self) {
        border-left: 3px solid rgba(183, 106, 59, 0.3);
      }

      /* Self messages - Ochún's gold accent */
      .chat-message--self {
        text-align: left;
        background: rgba(212, 165, 116, 0.06);
        border-left: 3px solid rgba(212, 165, 116, 0.4);
      }

      .chat-message--self:hover {
        background: rgba(212, 165, 116, 0.1);
      }

      /* Self message author styling */
      .chat-message--self .chat-message__author-name {
        color: var(--brass);
      }

      .chat-message:nth-child(3n+2) { animation-delay: 40ms; }
      .chat-message:nth-child(3n) { animation-delay: 80ms; }

      /* Avatar option image placeholders (for selector) */
      .avatar-option-img {
         width: 20px;
         height: 20px;
         background-size: contain;
      }

      /* Pixel Flag Emoji - retro game aesthetic (for selector) */
      .avatar-flag-pixel {
        font-size: 28px;
        line-height: 1;
        display: block;
        text-align: center;
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        position: relative;
        z-index: 1;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        filter: contrast(1.15) saturate(1.3) drop-shadow(0 2px 4px rgba(0,0,0,0.4));
        transition: transform 0.15s ease;
      }

      .avatar-option:hover .avatar-flag-pixel {
        transform: scale(1.15);
      }

      .avatar-option.selected .avatar-flag-pixel {
        filter: contrast(1.2) saturate(1.4) drop-shadow(0 0 8px rgba(255,215,0,0.4));
      }

      /* Flag in chat messages - inline with name */
      .chat-message__flag {
        font-size: 1.1rem;
        line-height: 1;
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4));
      }

      /* Legacy avatar-flag for selector */
      .avatar-flag {
        font-size: 24px;
        line-height: 1;
        display: block;
        text-align: center;
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      }

      .chat-message__content-wrapper {
        flex: 1;
        min-width: 0;
      }

      .chat-message__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 12px;
      }

      .chat-message__author {
        font-family: "Bodoni Moda", serif;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* Free Agent Pip - Single pip = "half of something, waiting for a partner"
         "One pip is incomplete. A soul looking for its other half." — Wifredo Lam */
      .free-agent-pip {
        color: var(--brass);
        font-size: 0.7rem;
        text-shadow: 0 0 6px rgba(212, 165, 116, 0.5);
        margin-left: 4px;
      }

      /* Author name - PROMINENT */
      .chat-message__author-name {
        font-family: "Bodoni Moda", serif;
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--brass);
        letter-spacing: 0.03em;
      }

      /* Self name highlighted */
      .chat-message--self .chat-message__author-name {
        color: #e8c896;
        text-shadow: 0 0 12px rgba(212, 165, 116, 0.3);
      }

      /* Others in warmer copper */
      .chat-message:not(.chat-message--self) .chat-message__author-name {
        color: #d4a574;
      }

      /* Timestamp - subtle, secondary */
      .chat-message__time {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.35);
        letter-spacing: 0.02em;
        font-weight: 500;
      }

      /* Message content */
      .chat-message__content {
        color: rgba(255, 255, 255, 0.9);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        line-height: 1.6;
        font-weight: 400;
      }

      /* ===========================================
         PINNED MESSAGES - Honored at the Table
         =========================================== */
      .chat-message--pinned {
        background: rgba(212, 165, 116, 0.1);
        border-color: rgba(212, 165, 116, 0.25);
        border-left: 3px solid var(--brass) !important;
      }
      .chat-message--pinned:hover {
        background: rgba(212, 165, 116, 0.14);
      }

      /* Pinned badge - elegant, not emoji */
      .pinned-badge {
        position: absolute;
        top: -10px;
        right: 12px;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--brass);
        background: rgba(28, 19, 15, 0.95);
        padding: 4px 10px;
        border-radius: 6px;
        border: 1px solid rgba(212, 165, 116, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      /* Pin functionality is admin-only (Erik via backend) */

      /* Pinned Section */
      .pinned-section {
        background: rgba(212, 165, 116, 0.04);
        border-bottom: 1px solid rgba(212, 165, 116, 0.12);
        padding: 12px 0 16px;
        margin-bottom: 12px;
      }
      .pinned-section__label {
        font-family: "Bodoni Moda", serif;
        font-size: 0.7rem;
        color: var(--brass);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        padding: 8px 16px;
        opacity: 0.7;
      }

      .chat-empty {
        text-align: center;
        color: rgba(255, 255, 255, 0.3);
        margin-top: 40px;
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-size: 0.9rem;
        letter-spacing: 0.05em;
      }

      /* ===========================================
         MESA TICKER - ESPN Sports Broadcast Style
         =========================================== */
      .mesa-ticker {
        height: 46px;
        /* Tobias: "Dark UI needs fog - layers of smoke, not a black wall" */
        background: linear-gradient(
          90deg,
          #0a0604 0%,
          #0d0806 25%,
          #0a0604 50%,
          #0d0806 75%,
          #0a0604 100%
        );
        border-top: 1px solid rgba(212, 165, 116, 0.2);
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        overflow: hidden;
        z-index: 10002; /* Highest, remains above chat panel shadow */
        box-shadow:
          0 -4px 24px rgba(0,0,0,0.6),
          inset 0 2px 8px rgba(0, 0, 0, 0.9),
          inset 0 -1px 3px rgba(212, 165, 116, 0.03); /* Tobias: Deeper recess */
        transition: background 0.3s ease;
      }

      /* Ticker dimming when chat is open - controlled via JS class */
      .mesa-ticker.ticker-dimmed {
        background: rgba(10, 6, 4, 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .mesa-ticker.ticker-dimmed .mesa-ticker__track,
      .mesa-ticker.ticker-dimmed .mesa-ticker__badge {
        opacity: 0.5;
        transition: opacity 0.3s ease;
      }
      @media (min-width: 769px) {
        .mesa-ticker.ticker-dimmed:hover .mesa-ticker__track,
        .mesa-ticker.ticker-dimmed:hover .mesa-ticker__badge {
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .mesa-ticker {
          height: 40px;
          z-index: 10005; /* Above chat panel on mobile */
        }
      }

      /* "LA MESA" badge on left - ESPN sporty energy */
      .mesa-ticker__badge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 0 18px;
        background: linear-gradient(135deg, #cc0000 0%, #8a0000 100%);
        color: #ffffff;
        font-family: 'IBM Plex Sans Condensed', 'Arial Narrow', system-ui, sans-serif;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.02em; /* Tighter — sporty condensed feel */
        flex-shrink: 0;
        position: relative;
        z-index: 3;
        /* Slight skew — motion energy */
        transform: skewX(-6deg);
        box-shadow:
          4px 0 15px rgba(0,0,0,0.6),
          inset 0 1px 0 rgba(255,255,255,0.2),
          0 0 25px rgba(204, 0, 0, 0.4);
        /* Hard edge on right — ESPN style */
        clip-path: polygon(0 0, 100% 0, 95% 100%, 0 100%);
      }

      /* Un-skew the text inside */
      .mesa-ticker__badge-dot,
      .mesa-ticker__badge-text {
        transform: skewX(6deg);
      }

      .mesa-ticker__badge-dot {
        width: 8px;
        height: 8px;
        background: #ffffff;
        border-radius: 50%;
        animation: badgePulse 1.2s ease-in-out infinite;
        box-shadow: 0 0 10px rgba(255,255,255,0.8);
      }

      @keyframes badgePulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.4; transform: scale(0.8); }
      }

      /* Scrolling content area */
      .mesa-ticker__scroll {
        flex: 1;
        overflow: hidden;
        position: relative;
      }

      /* Fade edge on right only */
      .mesa-ticker__scroll::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 60px;
        background: linear-gradient(90deg, transparent 0%, #0a0604 100%);
        z-index: 2;
        pointer-events: none;
      }

      /* Domino Tile Button in Ticker - Tobias: "Physical Digital" */
      .mesa-ticker__chat-btn {
        width: 60px;
        height: 100%;
        background: linear-gradient(135deg, var(--brass) 0%, var(--copper) 100%);
        border: none;
        color: #0a0604;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 4;
        flex-shrink: 0;
        transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        box-shadow: -4px 0 15px rgba(0,0,0,0.4);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        outline: none;
      }

      /* Hide chat button until registration */
      .mesa-ticker__chat-btn--hidden {
        display: none !important;
      }

      /* Tobias: "The Lift" - but keep it inside the ticker (no translate; ticker clips overflow) */
      @media (hover: hover) and (pointer: fine) {
        .mesa-ticker__chat-btn:hover {
          background: linear-gradient(135deg, #e8c896 0%, var(--brass) 100%);
          filter: brightness(1.04) saturate(1.05);
          box-shadow:
            -4px 0 22px rgba(0,0,0,0.55),
            inset 0 1px 0 rgba(255,255,255,0.25),
            0 0 18px rgba(212, 165, 116, 0.18);
        }
      }

      /* Tobias: "The Slam" - quick scale-down on click */
      .mesa-ticker__chat-btn:active {
        transform: scale(0.96);
        filter: brightness(1.02) contrast(1.05);
        box-shadow:
          -4px 0 12px rgba(0,0,0,0.45),
          inset 0 2px 10px rgba(0, 0, 0, 0.25);
      }

      .mesa-ticker__chat-btn:focus {
        outline: none;
      }
      .mesa-ticker__chat-btn:focus-visible {
        outline: 2px solid rgba(212, 165, 116, 0.55);
        outline-offset: -2px;
      }

      /* Tobias: Unread message pulse - "The room is calling" */
      .mesa-ticker__chat-btn.has-unread {
        animation: chatBtnCalling 2s infinite;
      }

      @keyframes chatBtnCalling {
        0%, 100% { box-shadow: -4px 0 15px rgba(0,0,0,0.4); }
        50% { 
          box-shadow: 
            -4px 0 25px rgba(212, 165, 116, 0.4),
            inset 0 0 10px rgba(212, 165, 116, 0.2); 
        }
      }

      .mesa-ticker__chat-badge {
        position: absolute;
        top: 2px;
        right: 4px;
        background: #cc0000;
        color: white;
        font-size: 0.6rem;
        font-weight: 800;
        min-width: 14px;
        height: 14px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #0a0604;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }

      .mesa-ticker__track {
        display: inline-flex;
        align-items: center;
        height: 100%;
        animation: tickerScroll 28s linear infinite;
        white-space: nowrap;
        will-change: transform;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
      }

      /* Explicit visibility when NOT dimmed - Safari fix */
      .mesa-ticker:not(.ticker-dimmed) .mesa-ticker__track,
      .mesa-ticker:not(.ticker-dimmed) .mesa-ticker__badge {
        opacity: 1 !important;
      }

      /*
        iOS Safari: stabilize compositing for fixed + animated ticker.
        Safari can mis-paint fixed elements with transforms/backdrop-filters and full-screen overlays,
        making the ticker appear dimmed even when `.ticker-dimmed` is not set.
      */
      @supports (-webkit-touch-callout: none) {
        .story {
          -webkit-overflow-scrolling: touch;
        }
        .chat-widget {
          z-index: 20001;
        }
        .mesa-ticker {
          z-index: 20002;
          isolation: isolate;
          transform: translate3d(0, 0, 0);
          -webkit-transform: translate3d(0, 0, 0);
        }
        .mesa-ticker__badge,
        .mesa-ticker__track,
        .mesa-ticker__chat-btn {
          transform: translate3d(0, 0, 0);
          -webkit-transform: translate3d(0, 0, 0);
        }
        .chat-panel {
          z-index: 20003;
        }
        .chat-backdrop {
          z-index: 20000;
        }
        .mesa-help {
          z-index: 20010;
        }
        .chromatic-aberration {
          mix-blend-mode: normal;
          opacity: 0.18;
          transform: translateZ(0);
          -webkit-transform: translateZ(0);
        }

        /* iOS Safari stability: avoid blend-mode + heavy transforms during scroll-snap (can flicker). */
        .panel-bg::after {
          mix-blend-mode: normal;
          opacity: 0.16;
        }
        .fog-layer {
          filter: blur(45px);
          animation: none;
        }
        .smoke-layer {
          mix-blend-mode: normal;
          opacity: 0.16;
          animation: none;
        }
        .panel.in-view .smoke-layer {
          opacity: 0.16;
        }
        .panel-bg {
          transition: none;
          transform: none !important;
        }
        .panel.in-view .panel-bg {
          transform: none !important;
        }

        /* Revisit breath can flicker on iOS; keep re-entry stable. */
        .panel--whisper.reentering .whisper-top,
        .panel--whisper.reentering .whisper-bottom,
        .panel--build.reentering .build-top,
        .panel--build.reentering .build-center,
        .panel--build.reentering .build-bottom,
        .panel--slam.reentering .slam-top,
        .panel--slam.reentering .slam-center,
        .panel--slam.reentering .slam-bottom {
          animation: none !important;
        }

        .panel--rules.reentering .rules-plaque {
          animation: none !important;
        }
      }

      /* Pause on hover (desktop only) */
      @media (hover: hover) and (pointer: fine) {
        .mesa-ticker__track:hover {
          animation-play-state: paused;
        }
      }

      /* "Unlock La Mesa" — ESPN credential / press pass aesthetic */
      .mesa-help {
        position: fixed;
        right: calc(14px + env(safe-area-inset-right));
        left: auto;
        bottom: calc(46px + 14px + env(safe-area-inset-bottom));
        z-index: 15000;
        width: min(280px, calc(100vw - 28px));
        margin: 0;
        background: linear-gradient(135deg, rgba(18, 12, 8, 0.98) 0%, rgba(12, 8, 5, 0.98) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        /* Sharp edges — credential, not notification */
        border: 1px solid rgba(212, 165, 116, 0.3);
        border-left: 3px solid var(--brass);
        border-radius: 2px;
        padding: 0;
        overflow: hidden;
        box-shadow:
          0 20px 60px rgba(0, 0, 0, 0.6),
          0 4px 16px rgba(0, 0, 0, 0.4);
        opacity: 0;
        transform: translateX(20px);
        pointer-events: none;
        transition: opacity 180ms ease, transform 180ms ease;
      }

      .mesa-help.is-visible {
        opacity: 1;
        transform: translateX(0);
        pointer-events: auto;
      }

      @media (max-width: 768px) {
        .mesa-help {
          right: calc(12px + env(safe-area-inset-right));
          width: min(300px, calc(100vw - 24px));
          bottom: calc(40px + 12px + env(safe-area-inset-bottom));
        }
      }

      /* ACCESS badge — like a credential strip */
      .mesa-help__badge {
        background: var(--brass);
        color: #0a0705;
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        font-weight: 700;
        font-size: 0.65rem;
        letter-spacing: 0.12em;
        padding: 5px 14px;
        text-transform: uppercase;
      }

      .mesa-help__content {
        padding: 14px 16px 12px;
      }

      .mesa-help__title {
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        font-weight: 700;
        color: #fff;
        font-size: 0.95rem;
        margin-bottom: 6px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .mesa-help__text {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8rem;
        line-height: 1.4;
        margin: 0;
      }

      .mesa-help__dismiss {
        appearance: none;
        width: 100%;
        border: none;
        border-top: 1px solid rgba(212, 165, 116, 0.15);
        background: rgba(212, 165, 116, 0.06);
        color: var(--brass);
        padding: 11px 16px;
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        font-weight: 600;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: background 150ms ease;
      }

      .mesa-help__dismiss:hover {
        background: rgba(212, 165, 116, 0.12);
      }

      .mesa-help__dismiss:active {
        background: rgba(212, 165, 116, 0.08);
      }

      @keyframes tickerScroll {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
      }

      /* ===========================================
         TICKER ITEMS - Simple, clean, Tobias-style
         =========================================== */

      :global(.ticker-item) {
        display: inline-block;
        padding: 0 28px;
        font-family: 'IBM Plex Sans', system-ui, sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      /* Spots remaining - white, clear urgency */
      :global(.ticker-spots) {
        color: rgba(255, 255, 255, 0.7);
      }

      /* Names - warm brass, the social proof */
      :global(.ticker-name) {
        color: var(--brass);
        text-shadow: 0 0 20px rgba(212, 165, 116, 0.3);
      }

      /* Waiting state - subtle */
      :global(.ticker-waiting) {
        color: rgba(255, 255, 255, 0.4);
        font-weight: 400;
        font-style: italic;
        text-transform: none;
      }

      /* Live count */
      :global(.ticker-live) {
        color: rgba(255, 255, 255, 0.6);
      }
      :global(.ticker-live-dot) {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        margin-right: 8px;
        animation: livePulse 1.5s ease-in-out infinite;
      }
      @keyframes livePulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }

      /* Action text - the whisper */
      :global(.ticker-action) {
        font-weight: 400;
        font-size: 0.7rem;
        opacity: 0.5;
        margin-left: 6px;
        text-transform: lowercase;
      }

      /* Tournament updates - copper, attention */
      :global(.ticker-update) {
        color: var(--copper);
        text-shadow: 0 0 15px rgba(183, 106, 59, 0.4);
        text-transform: none;
        font-weight: 500;
      }

      /* Spacer for seamless loop */
      :global(.ticker-spacer) {
        display: inline-block;
        width: 60px;
      }

      /* Input Area - The Ledger (lighter at bottom - where the action happens) */
      .chat-input-area {
        padding: 20px;
        padding-bottom: 60px; /* 40px ticker + 20px breathing room */
        display: flex;
        gap: 16px;
        border-top: 1px solid rgba(212, 165, 116, 0.15);
        background: linear-gradient(
          180deg,
          rgba(28, 19, 15, 0.4) 0%,
          rgba(28, 19, 15, 0.6) 100%
        );
        position: relative;
      }

      @media (max-width: 768px) {
        .chat-input-area {
          padding-bottom: 54px; /* 34px ticker + 20px breathing room */
        }
      }

      /* Warm glow above input - the fog clears here */
      .chat-input-area::before {
        content: '';
        position: absolute;
        top: -40px;
        left: 0;
        right: 0;
        height: 40px;
        background: linear-gradient(
          180deg,
          transparent 0%,
          rgba(183, 106, 59, 0.03) 100%
        );
        pointer-events: none;
      }

      .chat-input {
        flex: 1;
        background: transparent;
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding: 8px 0;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 16px; /* Must be 16px+ to prevent iOS Safari auto-zoom on focus */
        outline: none;
        transition: border-color 0.3s;
        border-radius: 0;
      }

      .chat-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
        font-style: italic;
      }

      .chat-input:focus {
        border-color: var(--brass);
      }

      /* Send Button - The Domino Pip
         A solid brass pip like on a domino tile.
         "The pip is elegant. It echoes what we built." — Wifredo Lam */
      .chat-send {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: radial-gradient(
          circle at 35% 35%,
          #e8c896 0%,
          var(--brass) 40%,
          var(--copper) 100%
        );
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow:
          0 3px 8px rgba(0, 0, 0, 0.4),
          0 1px 3px rgba(0, 0, 0, 0.3),
          inset 0 1px 2px rgba(255, 255, 255, 0.3),
          inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      /* Hide the arrow - the pip IS the button */
      .chat-send svg {
        display: none;
      }

      /* Subtle pulse when ready to send */
      .chat-send:not(:disabled) {
        animation: pipReady 2s ease-in-out infinite;
      }

      @keyframes pipReady {
        0%, 100% {
          box-shadow:
            0 3px 8px rgba(0, 0, 0, 0.4),
            0 1px 3px rgba(0, 0, 0, 0.3),
            inset 0 1px 2px rgba(255, 255, 255, 0.3),
            inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }
        50% {
          box-shadow:
            0 3px 8px rgba(0, 0, 0, 0.4),
            0 1px 3px rgba(0, 0, 0, 0.3),
            0 0 12px rgba(212, 165, 116, 0.4),
            inset 0 1px 2px rgba(255, 255, 255, 0.3),
            inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }
      }

      .chat-send:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow:
          0 5px 12px rgba(0, 0, 0, 0.5),
          0 2px 4px rgba(0, 0, 0, 0.3),
          0 0 20px rgba(212, 165, 116, 0.3),
          inset 0 1px 2px rgba(255, 255, 255, 0.3),
          inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        animation: none;
      }

      /* SLAM - like slamming a domino on the table
         "The slam is ritual. When you play a domino, you're declaring." — Wifredo Lam */
      .chat-send:not(:disabled):active {
        transform: translateY(3px) scale(0.9);
        transition: transform 0.05s ease-out;
        box-shadow:
          0 1px 2px rgba(0, 0, 0, 0.6),
          0 0 0 4px rgba(212, 165, 116, 0.4),
          0 0 30px rgba(212, 165, 116, 0.3),
          inset 0 1px 2px rgba(255, 255, 255, 0.3),
          inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        animation: none;
      }

      /* Slam class for programmatic slam effect */
      .chat-send.slamming {
        animation: pipSlam 0.15s ease-out forwards;
      }

      @keyframes pipSlam {
        0% {
          transform: scale(1);
        }
        40% {
          transform: translateY(4px) scale(0.85);
        }
        60% {
          transform: translateY(2px) scale(0.95);
          box-shadow:
            0 1px 2px rgba(0, 0, 0, 0.6),
            0 0 0 8px rgba(212, 165, 116, 0.3),
            0 0 40px rgba(212, 165, 116, 0.4),
            inset 0 1px 2px rgba(255, 255, 255, 0.3),
            inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }
        100% {
          transform: translateY(0) scale(1);
        }
      }

      /* Ripple burst on send */
      .chat-send::after {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 50%;
        background: transparent;
        border: 2px solid transparent;
        transition: all 0.15s ease-out;
        pointer-events: none;
      }

      .chat-send.slamming::after {
        animation: pipRipple 0.3s ease-out forwards;
      }

      @keyframes pipRipple {
        0% {
          border-color: rgba(212, 165, 116, 0.6);
          transform: scale(1);
          opacity: 1;
        }
        100% {
          border-color: rgba(212, 165, 116, 0);
          transform: scale(1.8);
          opacity: 0;
        }
      }

      .chat-send:disabled {
        background: radial-gradient(
          circle at 35% 35%,
          rgba(255, 255, 255, 0.15) 0%,
          rgba(255, 255, 255, 0.08) 40%,
          rgba(255, 255, 255, 0.03) 100%
        );
        box-shadow:
          0 2px 4px rgba(0, 0, 0, 0.2),
          inset 0 1px 2px rgba(255, 255, 255, 0.05);
        cursor: not-allowed;
      }

      /* Identity Screen - Centered Cluster Layout */
      .chat-identity {
        padding: 40px 24px;
        padding-top: 80px; /* Push content down from header */
        padding-bottom: max(48px, calc(env(safe-area-inset-bottom) + 32px));
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        text-align: center;
        justify-content: center; /* CENTER the whole cluster */
        gap: 0;
        overflow: hidden;
        width: 100%;
        box-sizing: border-box;
        position: relative;
        /* Warm vignette atmosphere */
        background:
          radial-gradient(ellipse at 50% 30%, rgba(212, 165, 116, 0.06) 0%, transparent 50%),
          radial-gradient(ellipse at center, transparent 0%, rgba(10, 7, 5, 0.8) 100%);
      }

      /* Subtle grain texture overlay */
      .chat-identity::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.025;
        pointer-events: none;
        mix-blend-mode: overlay;
      }

      /* CDL Watermark - bold but barely there, like La Salida */
      .chat-identity::after {
        content: 'CDL';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: "Bodoni Moda", serif;
        font-size: 14rem;
        font-style: italic;
        font-weight: 700;
        letter-spacing: 0.02em;
        color: rgba(212, 165, 116, 0.012);
        pointer-events: none;
        line-height: 0.9;
      }

      /* Staggered entry animations */
      .chat-identity > * {
        opacity: 0;
        transform: translateY(16px);
        animation: identityFadeUp 0.5s ease-out forwards;
      }

      @keyframes identityFadeUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .chat-identity__title { animation-delay: 0ms; }
      .chat-identity__subtitle { animation-delay: 60ms; }
      .mesa-live-indicator { animation-delay: 100ms; }
      .avatar-selector { animation-delay: 140ms; }
      .chat-identity__select { animation-delay: 180ms; }
      .chat-identity__input { animation-delay: 180ms; }
      .chat-identity__register-hint { animation-delay: 220ms; }
      .chat-identity__btn { animation-delay: 260ms; }

      .identity-header {
        font-family: "Bodoni Moda", serif;
        font-size: 0.7rem;
        letter-spacing: 0.25em;
        font-variant: small-caps;
        color: var(--brass);
        margin-bottom: 28px;
        opacity: 0.6;
        position: relative;
        z-index: 1;
      }

      .chat-identity__title {
        font-family: "Bodoni Moda", serif;
        font-size: 2rem;
        color: var(--brass);
        margin-bottom: 0;
        font-weight: 700;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        text-shadow:
          0 0 40px rgba(212, 165, 116, 0.2),
          0 4px 24px rgba(0, 0, 0, 0.6);
        position: relative;
        z-index: 1;
      }

      /* Accent line under title - modern touch */
      .chat-identity__title::after {
        content: '';
        display: block;
        width: 40px;
        height: 1px;
        background: var(--brass);
        margin: 16px auto 0;
        opacity: 0.4;
      }

      .chat-identity__subtitle {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        font-weight: 400;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: var(--brass);
        opacity: 0.5;
        margin-top: 16px;
        margin-bottom: 0;
        position: relative;
        z-index: 1;
      }

      /* Live player count indicator - Bone Language */
      .mesa-live-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 20px;
        padding: 10px 20px;
        background: rgba(212, 165, 116, 0.08);
        border: 1px solid rgba(212, 165, 116, 0.15);
        border-radius: 12px;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
      }

      .mesa-live-dot {
        width: 8px;
        height: 8px;
        background: #4ade80;
        border-radius: 50%;
        animation: livePulse 2s ease-in-out infinite;
        box-shadow: 0 0 8px rgba(74, 222, 128, 0.5);
      }

      @keyframes livePulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.2); }
      }

      .mesa-live-text {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.8rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
        letter-spacing: 0.02em;
      }

      .mesa-live-text span {
        color: var(--brass);
        font-weight: 600;
      }

      /* Flag selector - Scrollable, starts with Cuba */
      .avatar-selector {
        display: flex;
        flex-wrap: nowrap;
        justify-content: flex-start; /* Start from left so Cuba shows first */
        align-items: center;
        gap: 12px;
        margin: 24px auto;
        padding: 16px 32px;
        overflow-x: auto;
        overflow-y: visible;
        max-width: 500px; /* Reasonable constraint */
        width: 100%;
        box-sizing: border-box;
        position: relative;
        z-index: 1;
        flex-grow: 0;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        /* Fade edges hint */
        mask-image: linear-gradient(to right, transparent 0%, black 6%, black 94%, transparent 100%);
        -webkit-mask-image: linear-gradient(to right, transparent 0%, black 6%, black 94%, transparent 100%);
      }
      .avatar-selector::-webkit-scrollbar { display: none; }

      .avatar-hint {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.35);
        text-align: center;
        margin: -8px 0 16px 0;
        letter-spacing: 0.05em;
        animation: identityFadeUp 0.5s ease-out 280ms forwards;
        opacity: 0;
      }

      .avatar-option {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
        background: transparent;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        user-select: none;
        touch-action: manipulation;
        scroll-snap-align: center;
        z-index: 1;
      }

      /* Hover: pop up */
      .avatar-option:hover {
        transform: translateY(-4px) scale(1.1);
        z-index: 10;
      }

      .avatar-option:active {
        transform: scale(0.95);
      }

      /* PLANT YOUR FLAG - selected state */
      .avatar-option.selected {
        transform: translateY(-6px) scale(1.15);
        z-index: 20;
      }

      /* Non-selected flags fade when one is selected */
      .avatar-selector:has(.selected) .avatar-option:not(.selected) {
        opacity: 0.5;
        transform: scale(0.85);
        filter: grayscale(0.3);
      }

      .avatar-selector:has(.selected) .avatar-option:not(.selected):hover {
        opacity: 0.9;
        transform: translateY(-3px) scale(1.0);
        filter: grayscale(0);
      }

      /* Selected flag - clean, no glow, just lift */
      .avatar-option.selected {
        /* No box-shadow glow - clean look */
      }

      /* No glow dot - clean minimal look */

      .avatar-option .check-mark { display: none; }

      /* ========================================
         CUSTOM SELECT DROPDOWN
         ======================================== */
      .custom-select {
        position: relative;
        width: 100%;
        max-width: 280px;
        margin: 0 auto 16px;
        animation: identityFadeUp 0.5s ease-out 320ms forwards;
        opacity: 0;
        z-index: 100;
      }

      .custom-select__trigger {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px 20px;
        background: rgba(20, 14, 10, 0.8);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.25s ease;
      }

      .custom-select__trigger:hover {
        border-color: rgba(212, 165, 116, 0.4);
        background: rgba(28, 19, 15, 0.9);
      }

      .custom-select.is-open .custom-select__trigger {
        border-color: var(--brass);
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        border-bottom-color: transparent;
      }

      .custom-select__value {
        flex: 1;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .custom-select__value--placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      .custom-select__arrow {
        color: var(--brass);
        opacity: 0.6;
        transition: transform 0.25s ease;
        display: flex;
        align-items: center;
      }

      .custom-select.is-open .custom-select__arrow {
        transform: rotate(180deg);
        opacity: 1;
      }

      .custom-select__dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(20, 14, 10, 0.95);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--brass);
        border-top: none;
        border-radius: 0 0 12px 12px;
        overflow: visible;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
      }

      .custom-select.is-open .custom-select__dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .custom-select__search {
        padding: 12px;
        border-bottom: 1px solid rgba(212, 165, 116, 0.15);
      }

      .custom-select__search-input {
        width: 100%;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.2s ease;
      }

      .custom-select__search-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
      }

      .custom-select__search-input:focus {
        border-color: rgba(212, 165, 116, 0.4);
      }

      .custom-select__options {
        list-style: none;
        margin: 0;
        padding: 8px 0;
        max-height: 200px;
        overflow-y: auto;
      }

      .custom-select__options::-webkit-scrollbar {
        width: 6px;
      }

      .custom-select__options::-webkit-scrollbar-track {
        background: transparent;
      }

      .custom-select__options::-webkit-scrollbar-thumb {
        background: rgba(212, 165, 116, 0.3);
        border-radius: 3px;
      }

      .custom-select__option {
        padding: 14px 20px;
        color: rgba(255, 255, 255, 0.6);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.15s ease;
        border-left: 3px solid transparent;
        margin: 4px 8px;
        border-radius: 8px;
        background: transparent;
      }

      .custom-select__option:hover {
        background: rgba(212, 165, 116, 0.4) !important;
        color: #ffffff !important;
        border-left-color: #d4a574 !important;
        padding-left: 28px;
      }

      .custom-select__option.is-selected {
        background: rgba(212, 165, 116, 0.2);
        color: var(--brass);
        border-left-color: var(--brass);
      }

      .custom-select__option.is-selected::before {
        content: '✓';
        color: var(--brass);
        font-size: 0.8rem;
      }

      .custom-select__option.is-hidden {
        display: none;
      }

      .custom-select__empty {
        padding: 16px 20px;
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.9rem;
        text-align: center;
        font-style: italic;
      }

      /* Hide native select when custom is present */
      .chat-identity__select {
        width: 100%;
        margin-bottom: 16px;
        background: rgba(0, 0, 0, 0.3);
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--cream);
        padding: 12px 0;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 1rem;
        outline: none;
        text-align: center;
        text-align-last: center;
        border-radius: 0;
        -webkit-appearance: none;
        cursor: pointer;
      }
      
      .chat-identity__select:focus {
        border-bottom-color: var(--brass);
      }

      /* Input field - Vintage guestbook feel */
      .chat-identity__input {
        width: 100%;
        max-width: 260px;
        margin: 0 auto 8px;
        background: linear-gradient(
          135deg,
          rgba(212, 165, 116, 0.06) 0%,
          rgba(183, 106, 59, 0.03) 100%
        );
        border: 1px solid rgba(212, 165, 116, 0.15);
        border-bottom: 2px solid var(--brass);
        border-radius: 3px; /* Sharp, vintage - not rounded */
        color: var(--cream);
        padding: 14px 20px;
        font-family: "IBM Plex Serif", "IBM Plex Sans", serif;
        font-size: 16px;
        font-style: italic;
        outline: none;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      }
      .chat-identity__input:focus {
        background: rgba(212, 165, 116, 0.1);
        border-color: rgba(212, 165, 116, 0.3);
        border-bottom-color: var(--gold);
        box-shadow:
          0 0 0 1px rgba(212, 165, 116, 0.2),
          0 8px 24px rgba(0, 0, 0, 0.4);
      }
      .chat-identity__input::placeholder {
        color: rgba(212, 165, 116, 0.45);
        font-style: italic;
      }

      /* Helper/hint text */
      .chat-identity__register-hint {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.35);
        margin-bottom: 20px;
        font-family: "IBM Plex Sans", sans-serif;
        letter-spacing: 0.03em;
        position: relative;
        z-index: 1;
      }

      /* Button - Bone Language */
      .chat-identity__btn {
        margin-top: 24px; /* Fixed spacing, not auto */
        width: 100%;
        max-width: 280px;
        background: transparent;
        border: 1px solid var(--brass);
        border-radius: 12px;
        color: var(--brass);
        padding: 18px 44px;
        font-family: "Bodoni Moda", serif;
        font-size: 0.85rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.25s ease;
        min-height: 52px;
        position: relative;
        overflow: hidden;
        z-index: 1;
      }

      /* Brass fill sweep on hover */
      .chat-identity__btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: var(--brass);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: -1;
      }

      .chat-identity__btn:not(:disabled):hover::before {
        transform: scaleX(1);
      }

      .chat-identity__btn:not(:disabled):hover {
        color: #0d0906;
        border-color: var(--brass);
        transform: scale(1.02);
        box-shadow: 0 0 30px rgba(212, 165, 116, 0.35);
      }

      /* SLAM effect on click - like slamming a domino */
      .chat-identity__btn:not(:disabled):active {
        transform: scale(0.95) translateY(2px);
        transition: transform 0.08s ease-out;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .chat-identity__btn:disabled {
        border-color: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.15);
        cursor: not-allowed;
      }

      .chat-identity__btn:disabled::before {
        display: none;
      }

      .chat-identity__register-hint {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
        margin-top: 12px;
        font-family: "IBM Plex Sans", sans-serif;
      }

      .chat-identity__register-link {
        color: var(--brass);
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.2s;
      }

      .chat-identity__register-link:hover {
        border-bottom-color: var(--brass);
      }

      /* Mobile */
      @media (max-width: 768px) {
        .chat-widget {
          bottom: 16px;
          right: 16px;
          left: 16px; /* Centered button area */
          display: flex;
          justify-content: flex-end; /* Or center if preferred, keeping right for thumb */
        }

        /* Make domino tile bigger on mobile / easier to tap */
        .chat-toggle {
          width: 72px;
          height: 115px;
        }

        .chat-panel {
          position: fixed;
          top: 0;
          bottom: 34px; /* Leave room for ticker (34px on mobile) */
          left: 0;
          right: 0;
          width: 100%;
          height: calc(100dvh - 34px); /* Full height minus ticker */
          max-height: calc(100dvh - 34px);
          border-radius: 0;
          border: none;
          box-shadow: none;
          overflow: hidden;
        }

        .chat-panel.is-open {
          animation: sheetOpen 0.4s cubic-bezier(0.32, 0.72, 0, 1);
        }

        @keyframes sheetOpen {
          from { transform: translateY(100%); }
          to { transform: translateY(0); }
        }

        /* Show drag handle on mobile */
        .chat-header__drag-handle {
          display: block;
        }

        .chat-header {
          /* Safe area for notch/Dynamic Island - generous padding */
          padding: max(28px, calc(env(safe-area-inset-top) + 20px)) 20px 14px;
          min-height: 56px;
          background: rgba(20, 14, 11, 0.98); /* Solid dark background for visibility */
          border-bottom: 1px solid rgba(212, 165, 116, 0.15);
        }

        .chat-header__title {
          font-size: 0.85rem;
        }

        /* Close button needs safe area too */
        .chat-header__close {
          top: max(24px, calc(env(safe-area-inset-top) + 16px));
          right: 14px;
          width: 44px;
          height: 44px;
          padding: 0;
          justify-content: center;
          gap: 0;
        }

        .chat-header__close-label {
          display: none;
        }

        /* Adjust input area for safe areas (iPhone Home Bar) */
        .chat-input-area {
          padding: 12px 20px max(12px, calc(env(safe-area-inset-bottom) + 8px));
          background: rgba(20, 14, 11, 0.98); /* Opaque background behind input */
        }

        .chat-send {
          width: 48px;
          height: 48px; /* Larger tap target */
        }

        .pin-btn {
          min-width: 44px;
          min-height: 44px;
        }

        /* Avatar options need good tap targets */
        .avatar-option {
          width: 44px;
          height: 44px;
        }

        /* Identity screen mobile - centered cluster */
        .chat-identity {
          justify-content: center; /* Keep centered on mobile too */
          padding: max(28px, calc(env(safe-area-inset-top) + 16px)) 20px max(32px, calc(env(safe-area-inset-bottom) + 20px));
          overflow-y: auto;
          overflow-x: hidden;
        }

        /* CDL watermark - adjusted for mobile */
        .chat-identity::after {
          font-size: 10rem;
        }

        .identity-header {
          margin-bottom: 20px;
        }

        .chat-identity__title {
          font-size: 1.5rem;
          margin-bottom: 6px;
          transform: none; /* Remove asymmetry on mobile */
        }

        .chat-identity__subtitle {
          margin-bottom: 0; /* Let space-between handle it */
          transform: none;
        }

        .avatar-selector {
          margin: 16px 0 20px 0;
          gap: 10px;
          padding: 12px 20px;
          flex-grow: 0;
        }

        .chat-identity__input {
          max-width: 240px;
          margin-bottom: 4px;
        }

        .chat-identity__register-hint {
          margin-bottom: 0;
          font-size: 0.7rem;
        }

        .chat-identity__btn {
          width: 100%;
          max-width: 260px;
          padding: 16px 36px;
          font-size: 0.8rem;
          min-height: 48px;
          margin-top: 20px; /* Fixed spacing */
        }
      }

      /* ========================================
         FORM PANEL - "The Roster"
         Scene 5: SIGN YOUR NAME
         The table awaits. Make it feel like
         pulling up a chair to sign the ledger.
         Tobias: "Float in the room, not pressed to ceiling"
         ======================================== */
      .panel--form {
        min-height: 100vh;
        min-height: 100dvh;
        height: 100vh;
        height: 100dvh;
        padding: 5vh 24px 90px; /* Top breathing room + ticker clearance */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* Start from top so button isn't cut off */
        box-sizing: border-box;
        /* Base `.panel` uses `overflow: hidden`; allow the form scene to scroll when content exceeds the viewport. */
        overflow-x: hidden;
        overflow-y: hidden;
        /* Atmospheric depth - Tobias: "Rooms, Not Hallways" */
        background:
          /* Top vignette - darkness descends */
          linear-gradient(to bottom, rgba(10, 7, 5, 0.9) 0%, transparent 15%),
          /* Bottom vignette - grounds the space */
          linear-gradient(to top, rgba(10, 7, 5, 0.95) 0%, transparent 20%),
          /* Central warmth - brass glow where the action is */
          radial-gradient(ellipse at 50% 40%, rgba(183, 106, 59, 0.06) 0%, transparent 50%),
          /* Ambient depth */
          radial-gradient(ellipse at 50% 50%, rgba(28, 19, 15, 0.4) 0%, transparent 70%),
          /* Base - tobacco room */
          linear-gradient(180deg, #0a0705 0%, #1a120d 40%, #0d0906 100%);
      }

      /* Form panel content always visible (no fade-in animation) */
      .panel--form .panel-content {
        opacity: 1;
        transform: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
        max-width: 480px;
      }

      /* Form slogan - confident invitation, Cuban elegance meets UFC edge */
      .panel--form .panel-headline {
        font-family: "Bodoni Moda", serif;
        font-style: italic;
        font-weight: 400;
        font-size: clamp(2rem, 7vw, 3rem);
        margin-bottom: 24px;
        color: var(--cream);
        letter-spacing: 0.02em;
        text-shadow:
          0 2px 15px rgba(0, 0, 0, 0.9),
          0 0 50px rgba(212, 165, 116, 0.2);
      }

      .panel--form .panel-subtitle {
        margin-bottom: 24px;
      }

      /* ========================================
         POSTSCRIPT PANEL - The Room at Rest
         Pure visual punctuation. No text. Just atmosphere.
         "Dark UI is about depth, not darkness.
          It's layers of smoke, not a black wall." — Tobias
         ======================================== */
      .panel--postscript {
        min-height: 100vh;
        min-height: 100dvh;
        height: 100vh;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 1;
        box-sizing: border-box;
        overflow: hidden;
      }

      /* Cinematic overlay - deep vignette, the room recedes into memory */
      .panel-overlay--postscript {
        background:
          /* Film grain texture - the room breathes */
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E"),
          /* Heavy top vignette - darkness descends like closing eyes */
          linear-gradient(to bottom, rgba(10, 7, 5, 0.85) 0%, rgba(10, 7, 5, 0.4) 25%, transparent 50%),
          /* Heavy bottom vignette - grounds the space, fades to credits */
          linear-gradient(to top, rgba(10, 7, 5, 0.95) 0%, rgba(10, 7, 5, 0.6) 20%, transparent 45%),
          /* Side vignettes - tunnel vision, focus on center */
          linear-gradient(90deg, rgba(10, 7, 5, 0.7) 0%, transparent 25%, transparent 75%, rgba(10, 7, 5, 0.7) 100%),
          /* Deep radial vignette - the room is a memory */
          radial-gradient(ellipse 80% 70% at 50% 50%, transparent 20%, rgba(10, 7, 5, 0.5) 60%, rgba(10, 7, 5, 0.85) 100%);
      }

      /* Ember glow - warm light leak from the chandelier */
      .panel--postscript::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
          /* Chandelier glow - top center warm bloom */
          radial-gradient(ellipse 40% 30% at 50% 15%, rgba(212, 165, 116, 0.15) 0%, transparent 70%),
          /* Table warmth - where the game was played */
          radial-gradient(ellipse 60% 40% at 50% 70%, rgba(183, 106, 59, 0.08) 0%, transparent 60%);
        mix-blend-mode: color-dodge;
        pointer-events: none;
        z-index: 4;
        animation: postscriptEmber 12s ease-in-out infinite alternate;
      }

      @keyframes postscriptEmber {
        0% { opacity: 0.5; }
        100% { opacity: 0.8; }
      }

      /* Chromatic aberration - vintage film feel */
      .panel--postscript::before {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.3;
        mix-blend-mode: screen;
        background:
          radial-gradient(circle at 49.5% 50%, rgba(255, 100, 50, 0.06) 0%, transparent 70%),
          radial-gradient(circle at 50.5% 50%, rgba(50, 100, 255, 0.06) 0%, transparent 70%);
        pointer-events: none;
        z-index: 5;
      }

      /* Mobile: Balanced overlays - moody but visible */
      @media (max-width: 768px) {
        .panel-overlay--postscript {
          background:
            /* Film grain */
            url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E"),
            /* Heavy top vignette - darkness descends */
            linear-gradient(to bottom, rgba(10, 7, 5, 0.75) 0%, rgba(10, 7, 5, 0.3) 30%, transparent 50%),
            /* Heavy bottom vignette - fades to credits */
            linear-gradient(to top, rgba(10, 7, 5, 0.85) 0%, rgba(10, 7, 5, 0.5) 25%, transparent 45%),
            /* Side vignettes - tunnel focus */
            linear-gradient(90deg, rgba(10, 7, 5, 0.6) 0%, transparent 20%, transparent 80%, rgba(10, 7, 5, 0.6) 100%),
            /* Deep radial vignette - room as memory */
            radial-gradient(ellipse 85% 75% at 50% 50%, transparent 25%, rgba(10, 7, 5, 0.45) 65%, rgba(10, 7, 5, 0.75) 100%);
        }

        /* Full fog on mobile */
        .panel--postscript.in-view .fog-layer {
          opacity: 0.8 !important;
        }

        /* Smoke layer on mobile */
        .panel--postscript.in-view .smoke-layer {
          opacity: 0.5 !important;
        }

        /* Ember glow */
        .panel--postscript::after {
          background:
            radial-gradient(ellipse 50% 35% at 50% 20%, rgba(212, 165, 116, 0.18) 0%, transparent 70%),
            radial-gradient(ellipse 70% 50% at 50% 65%, rgba(183, 106, 59, 0.1) 0%, transparent 60%);
        }
      }

      /* Footer panel - clean dark credits */
      .panel--footer {
        min-height: 60vh;
        min-height: 60dvh;
        height: auto;
        padding: 48px 24px;
        padding-bottom: 100px; /* Ticker clearance */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 1;
        box-sizing: border-box;
        background:
          radial-gradient(ellipse at 50% 30%, rgba(183, 106, 59, 0.04) 0%, transparent 50%),
          linear-gradient(180deg, #0a0705 0%, #0d0906 100%);
      }

      /* Footer section — cinematic closing credits */
      .event-footer-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
      }

      /* ========================================
         RULES PANEL - "La Ley"
         Scene 4: THE LAW
         One unified plaque. Authoritative. Complete.
         ======================================== */
      .panel--rules {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        /* Background image now handles atmosphere */
      }

      /* Single unified container - THE PLAQUE - floating in the room */
      .rules-plaque {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        max-width: 540px;
        width: 100%;
        padding: 32px 5vw;
        /* Floating plaque effect */
        background: linear-gradient(
          145deg,
          rgba(18, 12, 8, 0.92) 0%,
          rgba(10, 7, 5, 0.95) 100%
        );
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px;
        /* Depth - floating in the room */
        box-shadow:
          0 0 60px rgba(0, 0, 0, 0.8),
          0 20px 60px rgba(0, 0, 0, 0.6),
          0 0 100px rgba(212, 165, 116, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        /* Subtle backdrop blur for depth */
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

	      /* Header section - tightly coupled */
	      .rules-header {
	        margin-bottom: 24px;
	      }

	      /* Rules badge uses the same domino tile language as hero/slam */
	      .panel--rules .hero-badge {
	        width: 48px;
	        height: 68px;
	        margin: 0 auto 14px auto;
	        opacity: 0;
	      }

	      .rules-header__title {
	        font-family: "Bodoni Moda", serif;
	        font-size: clamp(3.1rem, 12vw, 5rem);
	        font-weight: 400;
	        font-style: italic;
	        color: #fff;
	        letter-spacing: -0.02em;
	        line-height: 0.9;
	        margin: 0 0 8px 0;
	        opacity: 0;
	        text-shadow:
	          0 0 10px rgba(255, 252, 245, 0.55),
	          0 0 30px rgba(255, 252, 245, 0.25),
	          0 0 60px rgba(212, 165, 116, 0.35),
	          0 0 100px rgba(212, 165, 116, 0.18),
	          0 4px 20px rgba(0, 0, 0, 0.9),
	          0 8px 40px rgba(0, 0, 0, 0.7);
	        filter: brightness(1.04);
	        display: inline-block;
	      }

      .rules-header__subtitle {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.65rem;
        font-weight: 400;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: var(--brass);
        opacity: 0;
        margin: 0;
      }

      /* Grid - The Law carved in brass */
      .rules-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        width: 100%;
        margin-bottom: 20px;
      }

      /* Rule Cards - Etched brass plaques */
      .rule-card {
        background:
          linear-gradient(145deg, rgba(28, 20, 14, 0.9) 0%, rgba(14, 10, 7, 0.95) 100%);
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: var(--radius);
        padding: 14px 12px;
        text-align: center;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        opacity: 0;
        transform: translateY(12px);
        position: relative;
        /* Etched/pressed effect - inset shadows */
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.4),
          inset 0 -1px 0 rgba(212, 165, 116, 0.1),
          0 1px 0 rgba(255, 255, 255, 0.03);
      }

      /* Brass corner accents - subtle */
      .rule-card::before {
        content: "";
        position: absolute;
        top: 4px;
        left: 4px;
        right: 4px;
        bottom: 4px;
        border: 1px solid rgba(212, 165, 116, 0.08);
        border-radius: calc(var(--radius) - 3px);
        pointer-events: none;
      }

      /* Primary rules - brass accent */
      .rule-card--primary {
        border-left: 3px solid var(--brass);
        background:
          linear-gradient(145deg, rgba(40, 28, 20, 0.9) 0%, rgba(22, 15, 10, 0.98) 100%);
        box-shadow:
          0 1px 0 rgba(212, 165, 116, 0.15) inset,
          0 -1px 0 rgba(0, 0, 0, 0.3) inset,
          0 8px 24px rgba(0, 0, 0, 0.5),
          0 0 20px rgba(212, 165, 116, 0.05);
      }

      .rule-card--primary .rule-card__title {
        color: var(--brass);
        text-shadow: 0 0 20px rgba(212, 165, 116, 0.3);
      }

      .rule-card__title {
        font-family: "Bodoni Moda", serif;
        font-size: 0.92rem;
        font-weight: 500;
        color: var(--cream);
        letter-spacing: 0.02em;
        line-height: 1.2;
        margin: 0 0 3px 0;
      }

      .rule-card__desc {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.45);
        letter-spacing: 0.01em;
        line-height: 1.3;
        margin: 0;
      }

      /* Hover - subtle lift */
      .rule-card:hover {
        border-color: rgba(212, 165, 116, 0.25);
        transform: translateY(-2px);
        box-shadow:
          0 1px 0 rgba(212, 165, 116, 0.1) inset,
          0 12px 32px rgba(0, 0, 0, 0.5),
          0 0 20px rgba(212, 165, 116, 0.08);
      }

      .rule-card--primary:hover {
        border-left-color: var(--copper);
      }

      /* Footer section - tightly coupled */
      .rules-footer-section {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* Divider - brass domino artifact */
      .rules-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 14px;
        margin-bottom: 12px;
        opacity: 0;
      }

      .rules-divider::before,
      .rules-divider::after {
        content: '';
        height: 1px;
        width: 35px;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.4), transparent);
      }

      .rules-divider__domino {
        font-size: 1.4rem;
        opacity: 0.6;
        filter: grayscale(0.2) sepia(0.3);
      }

      /* "Respect the table." - The warning */
      .rules-footer {
        text-align: center;
        font-family: "Bodoni Moda", serif;
        font-size: clamp(1.1rem, 3.5vw, 1.4rem);
        font-style: italic;
        color: #fff;
        letter-spacing: 0.04em;
        margin: 0;
        opacity: 0;
        text-shadow:
          0 0 20px rgba(212, 165, 116, 0.35),
          0 0 40px rgba(212, 165, 116, 0.15),
          0 2px 15px rgba(0, 0, 0, 0.8);
      }

      /* Scroll hint - STATIC, no bounce */
      .rules-scroll-hint {
        margin-top: 24px;
        opacity: 0;
        display: flex;
        justify-content: center;
      }

      .rules-scroll-hint__chevron {
        width: 14px;
        height: 14px;
        border-right: 2px solid var(--brass);
        border-bottom: 2px solid var(--brass);
        transform: rotate(45deg);
        opacity: 0.4;
      }

	      /* ========================================
	         RULES ANIMATIONS - The Law is revealed
	         ======================================== */

	      .panel--rules.in-view:not(.has-played) .hero-badge {
	        animation: fadeInOnly 0.6s ease-out 0.2s forwards;
	      }

      .panel--rules.in-view:not(.has-played) .rules-header__title {
        animation: rulesLawSlam 0.7s cubic-bezier(0.16, 1, 0.3, 1) 0.35s forwards;
      }

      .panel--rules.in-view:not(.has-played) .rules-header__subtitle {
        animation: rulesFadeIn 0.5s ease-out 0.7s forwards;
      }

      .panel--rules.in-view:not(.has-played) .rule-card {
        animation: ruleCardDeal 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      /* Staggered entry - dealt one by one */
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(1) { animation-delay: 0.85s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(2) { animation-delay: 0.95s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(3) { animation-delay: 1.05s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(4) { animation-delay: 1.15s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(5) { animation-delay: 1.25s; }
      .panel--rules.in-view:not(.has-played) .rule-card:nth-child(6) { animation-delay: 1.35s; }

      .panel--rules.in-view:not(.has-played) .rules-divider {
        animation: rulesFadeIn 0.5s ease-out 1.6s forwards;
      }

      .panel--rules.in-view:not(.has-played) .rules-footer {
        animation: rulesWarning 0.6s cubic-bezier(0.16, 1, 0.3, 1) 1.8s forwards;
      }

      /* Scroll hint - fade in only, NO BOUNCE */
      .panel--rules.in-view:not(.has-played) .rules-scroll-hint {
        animation: scrollHintReveal 0.8s ease-out 2.2s forwards;
      }

	      .panel--rules.has-played .hero-badge,
	      .panel--rules.has-played .rules-header__title,
	      .panel--rules.has-played .rules-header__subtitle,
	      .panel--rules.has-played .rule-card,
	      .panel--rules.has-played .rules-divider,
      .panel--rules.has-played .rules-footer {
        opacity: 1;
        transform: none;
        filter: none;
      }
      .panel--rules.has-played .rules-scroll-hint {
        opacity: 1;
      }

      @keyframes rulesFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes rulesLawSlam {
        0% {
          opacity: 0;
          transform: translateY(-20px) scale(1.05);
          filter: blur(3px);
        }
        70% {
          opacity: 1;
          transform: translateY(2px) scale(0.99);
          filter: blur(0);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes ruleCardDeal {
        0% {
          opacity: 0;
          transform: translateY(15px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes rulesWarning {
        0% {
          opacity: 0;
          transform: translateY(8px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Mobile adjustments */
      @media (max-width: 768px) {
        .rules-header {
          margin-bottom: 20px;
        }

        .rules-header__title {
          font-size: clamp(2.4rem, 10vw, 3.5rem);
        }

        .rules-header__subtitle {
          font-size: 0.58rem;
          letter-spacing: 0.2em;
        }

        .rules-grid {
          gap: 8px;
          margin-bottom: 16px;
        }

        .rule-card {
          padding: 11px 10px;
        }

        .rule-card__title {
          font-size: 0.82rem;
        }

        .rule-card__desc {
          font-size: 0.6rem;
        }

        .rules-divider {
          margin-bottom: 10px;
        }

        .rules-divider__domino {
          font-size: 1.2rem;
        }

        .rules-footer {
          font-size: clamp(0.95rem, 3vw, 1.2rem);
        }

        .rules-scroll-hint {
          margin-top: 20px;
        }
      }

      /* Form Shell - Tobias: The Ledger Style */
      .form-shell {
        background:
          /* Inner vignette - the cigar smoke settling */
          radial-gradient(ellipse at 50% 0%, rgba(212, 165, 116, 0.03) 0%, transparent 50%),
          /* Depth gradient */
          linear-gradient(180deg, rgba(35, 25, 18, 0.6) 0%, rgba(20, 14, 10, 0.8) 100%),
          /* Noise texture */
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
        border: 1px solid rgba(183, 106, 59, 0.2);
        border-top-color: rgba(212, 165, 116, 0.25);
        border-radius: 4px;
        padding: 34px 34px;
        max-width: 520px;
        width: 100%;
        margin: 0 auto;
        position: relative;
        /* Layered shadows for depth - Tobias: "Weight" */
        box-shadow:
          0 1px 0 rgba(212, 165, 116, 0.1) inset,
          0 20px 50px rgba(0, 0, 0, 0.5),
          0 0 100px rgba(0, 0, 0, 0.3);
      }

      /* Corner accents - old ledger detail */
      .form-shell::before {
        content: "";
        position: absolute;
        top: 12px;
        left: 12px;
        right: 12px;
        bottom: 12px;
        border: 1px solid rgba(212, 165, 116, 0.06);
        border-radius: 2px;
        pointer-events: none;
      }

      .form-intro {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .form-intro p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.95rem;
        margin-bottom: 12px;
      }

      .form-intro ul {
        list-style: none;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 16px;
        margin-top: 14px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .form-intro li {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .form-intro li::before {
        content: "◆";
        color: var(--copper);
        font-size: 0.6rem;
      }

      form {
        display: grid;
        gap: 20px;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-family: "Bodoni Moda", serif;
        font-weight: 400;
        font-style: italic;
        color: var(--brass);
        font-size: 1.15rem;
        text-align: left;
      }

      .input-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
      }

      /* Tobias: The Drawn Line (Physical Digital) */
      .input-wrapper::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 1px;
        background: rgba(212, 165, 116, 0.2);
        transform: skewX(-2deg);
        transform-origin: left;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
      }

      .input-wrapper:focus-within::after {
        height: 2px;
        background: var(--brass);
        transform: skewX(0);
        box-shadow: 0 2px 10px rgba(212, 165, 116, 0.3);
      }

      input,
      textarea {
        padding: 12px 0;
        border-radius: 0;
        border: none;
        background: transparent;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 1.05rem;
        border: none;
        border-bottom: 1px solid rgba(212, 165, 116, 0.15);
        background: transparent !important;
        color: var(--cream);
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 1.1rem;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
      }

      /* Tobias: Hand-drawn signature border effect */
      .form-group::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 1.5px;
        background: var(--brass);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        opacity: 0.8;
      }

      .form-group:focus-within::after {
        transform: scaleX(1);
      }

      .form-group:focus-within label {
        color: var(--brass);
      }

      input:focus,
      textarea:focus {
        outline: none;
        padding-left: 8px;
        text-shadow: 0 0 20px rgba(212, 165, 116, 0.15);
        /* Tobias: "Physical Digital" - inputs lift when active */
        transform: translateY(-1px);
        background: rgba(212, 165, 116, 0.02) !important;
        box-shadow:
          0 0 0 1px rgba(212, 165, 116, 0.08),
          0 4px 12px rgba(0, 0, 0, 0.2);
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(212, 165, 116, 0.2);
        font-style: italic;
      }

      button[type="submit"] {
        border: none;
        border-radius: 2px;
        padding: 22px 42px;
        font-weight: 700;
        font-size: 1.1rem;
        font-family: "Bodoni Moda", serif;
        text-transform: uppercase;
        letter-spacing: 0.25em;
        background: linear-gradient(180deg, #c4784a 0%, var(--copper) 50%, #9a5a30 100%);
        color: #fff;
        cursor: pointer;
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.15) inset,
          0 -1px 0 rgba(0, 0, 0, 0.2) inset,
          0 10px 30px rgba(0, 0, 0, 0.4),
          0 0 0 0 rgba(183, 106, 59, 0);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        margin-top: 16px;
        position: relative;
        overflow: hidden;
        animation: buttonBreath 4s ease-in-out infinite;
      }

      @keyframes buttonBreath {
        0%, 100% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.15) inset,
            0 -1px 0 rgba(0, 0, 0, 0.2) inset,
            0 10px 30px rgba(0, 0, 0, 0.4),
            0 0 0 0 rgba(183, 106, 59, 0);
        }
        50% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.15) inset,
            0 -1px 0 rgba(0, 0, 0, 0.2) inset,
            0 10px 30px rgba(0, 0, 0, 0.4),
            0 0 40px 2px rgba(183, 106, 59, 0.15);
        }
      }

      button[type="submit"]:hover {
        transform: translateY(-3px);
        background: linear-gradient(180deg, #d08555 0%, #c4784a 50%, #a86238 100%);
        box-shadow:
          0 1px 0 rgba(255, 255, 255, 0.2) inset,
          0 -1px 0 rgba(0, 0, 0, 0.15) inset,
          0 15px 40px rgba(183, 106, 59, 0.35),
          0 0 60px rgba(183, 106, 59, 0.2);
        animation: none;
      }

      /* Tobias: The SLAM - Tactical Flash + Weight */
      button[type="submit"]:active {
        transform: scale(0.92);
        filter: brightness(1.6) contrast(1.1);
        box-shadow: 
          0 4px 10px rgba(0, 0, 0, 0.7),
          inset 0 0 20px rgba(255, 255, 255, 0.2);
        transition: all 0.05s ease;
      }

      button[type="submit"]::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.6s ease;
      }

      button[type="submit"]:hover::before {
        left: 100%;
      }

      button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: progress;
        transform: none;
      }

      /* Guidance pulse when the domino sends you to the form */
      button[type="submit"].is-unlock-hinted {
        animation: unlockPulse 1.15s ease-out 1;
      }
      @keyframes unlockPulse {
        0% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.15) inset,
            0 -1px 0 rgba(0, 0, 0, 0.2) inset,
            0 10px 30px rgba(0, 0, 0, 0.4),
            0 0 0 0 rgba(212, 165, 116, 0);
        }
        45% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.2) inset,
            0 -1px 0 rgba(0, 0, 0, 0.15) inset,
            0 18px 55px rgba(183, 106, 59, 0.35),
            0 0 0 3px rgba(212, 165, 116, 0.18),
            0 0 70px rgba(183, 106, 59, 0.25);
        }
        100% {
          box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.15) inset,
            0 -1px 0 rgba(0, 0, 0, 0.2) inset,
            0 10px 30px rgba(0, 0, 0, 0.4),
            0 0 0 0 rgba(212, 165, 116, 0);
        }
      }

      .payment-note {
        text-align: center;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.85rem;
        color: var(--brass);
        opacity: 0.7;
        margin-top: 12px;
        letter-spacing: 0.05em;
      }

      .status {
        min-height: 24px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        font-size: 0.95rem;
      }

      /* ========================================
         FORM PANEL ENHANCEMENTS - Tobias Approved
         "The Final Hand" - Story climax
         ======================================== */

	      /* Form Header — "The Entrance" */
	      .form-header {
	        text-align: center;
	        margin-bottom: 32px;
	        position: relative;
	      }

	      /* Two-line headline: arrival announcement */
	      .panel-headline--form {
	        font-family: "Bodoni Moda", serif;
	        font-style: italic;
	        font-weight: 400;
	        text-transform: none;
	        letter-spacing: 0.03em;
	        line-height: 1.05;
	        color: rgba(255, 255, 255, 0.95);
	        text-shadow:
	          0 0 40px rgba(212, 165, 116, 0.3),
	          0 4px 20px rgba(0, 0, 0, 0.5);
	      }

	      /* Brass underline — like an inscription plaque */
	      .panel-headline--form::after {
	        content: '';
	        display: block;
	        width: 60px;
	        height: 2px;
	        background: linear-gradient(90deg,
	          transparent 0%,
	          var(--brass) 20%,
	          var(--brass) 80%,
	          transparent 100%
	        );
	        margin: 16px auto 0;
	        opacity: 0.7;
	      }

	      .form-headline__line {
	        display: block;
	      }

      /* Edition badge - matches CDL 1 badges on other panels */
      .form-header__edition {
        display: inline-block;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.6rem;
        font-weight: 600;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: var(--tobacco, #1c130f);
        background: var(--brass);
        padding: 5px 14px;
        border-radius: 2px;
        margin: 0 0 14px 0;
        box-shadow:
          0 2px 8px rgba(0, 0, 0, 0.3),
          0 0 20px rgba(212, 165, 116, 0.15);
      }

      /* Inline Scarcity - Urgency inside the form */
      .form-scarcity {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px 20px;
        background: rgba(183, 106, 59, 0.08);
        border: 1px solid rgba(183, 106, 59, 0.2);
        border-radius: 2px;
        margin-bottom: 16px;
      }

      .form-scarcity__pulse {
        width: 8px;
        height: 8px;
        background: var(--copper);
        border-radius: 50%;
        animation: scarcityPulse 2s ease-in-out infinite;
      }

      @keyframes scarcityPulse {
        0%, 100% {
          opacity: 1;
          box-shadow: 0 0 0 0 rgba(183, 106, 59, 0.4);
        }
        50% {
          opacity: 0.6;
          box-shadow: 0 0 0 6px rgba(183, 106, 59, 0);
        }
      }

      .form-scarcity__text {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--cream);
      }

      .form-scarcity__text span {
        color: var(--brass);
        font-weight: 700;
      }

      /* Button Scarcity - small text below button, mobile only */
      .button-scarcity {
        display: none; /* Hidden on desktop */
        margin: 12px 0 0 0;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.7rem;
        font-weight: 500;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.5);
        text-align: center;
      }

      .button-scarcity span {
        color: var(--brass);
        font-weight: 600;
      }

      /* Primary Label - WHO YOU ARE at the table */
      .label--primary {
        position: relative;
        padding-left: 16px;
        border-left: 3px solid var(--brass);
        box-shadow: -3px 0 12px rgba(212, 165, 116, 0.2);
      }

      /* Optional Label - Reduced emphasis */
      .label--optional {
        opacity: 0.7;
      }

      .label-hint {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        font-style: normal;
        font-weight: 400;
        color: rgba(212, 165, 116, 0.5);
      }

      /* Form Action - Button wrapper */
      .form-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        margin-top: 8px;
      }

      /* Payment Badge - $25 as text label, NOT a button */
      .payment-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 8px 0;
        background: transparent;
        border: none;
      }

      .payment-badge__amount {
        font-family: "Bodoni Moda", serif;
        font-size: 1.2rem;
        font-weight: 700;
        font-style: italic;
        color: var(--brass);
        letter-spacing: 0.02em;
      }

      .payment-badge__note {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.75rem;
        font-weight: 500;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.6);
      }

      /* Scroll Hint Divider - hidden everywhere (design changed to single viewport) */
      .scroll-hint-divider {
        display: none;
      }

      /* Footer Contact — ESPN Closing Credits Style */
      /* No boxy container — content floats on darkness */
      .footer-contact {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 48px;
        width: 100%;
        padding: 0;
        background: none;
        border: none;
      }

      .footer-contact__item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        gap: 10px;
        min-width: 180px; /* Equal width for balanced layout */
      }

      /* ESPN condensed typography for labels */
      .footer-contact__label {
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--brass);
      }

      .footer-contact__link {
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.85);
        text-decoration: none;
        transition: color 0.2s ease;
        position: relative;
      }

      .footer-contact__link::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 0;
        width: 100%;
        height: 1px;
        background: var(--brass);
        transform: scaleX(0);
        transform-origin: center;
        transition: transform 0.25s ease;
      }

      .footer-contact__link:hover {
        color: var(--brass);
      }

      .footer-contact__link:hover::after {
        transform: scaleX(1);
      }

      /* Vertical divider — broadcast style */
      .footer-contact__divider {
        width: 1px;
        height: 40px;
        background: rgba(212, 165, 116, 0.25);
        align-self: center;
      }

      /* Mobile: Stack footer vertically */
      @media (max-width: 480px) {
        .form-header__edition {
          font-size: 0.6rem;
        }

        .form-scarcity {
          padding: 10px 16px;
          margin-bottom: 20px;
        }

        .form-scarcity__text {
          font-size: 0.7rem;
        }

        .label--primary {
          padding-left: 12px;
        }

        .payment-badge {
          padding: 8px 16px;
        }

        .payment-badge__amount {
          font-size: 1rem;
        }

        .footer-contact {
          flex-direction: column;
          gap: 24px;
          align-items: center;
        }

        .footer-contact__item {
          align-items: center;
          text-align: center;
        }

        .footer-contact__divider {
          width: 40px;
          height: 1px;
          background: rgba(212, 165, 116, 0.2);
        }

        .footer-contact__link {
          font-size: 0.9rem;
        }

        .footer-contact__label {
          font-size: 0.65rem;
        }
      }

      /* Success Celebration State - Full viewport takeover */
      .success {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: radial-gradient(ellipse at center top, rgba(30, 20, 15, 0.98) 0%, rgba(10, 7, 5, 0.99) 100%);
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px 24px;
        overflow-y: auto;
      }

      .success.is-visible {
        display: flex;
        animation: successReveal 0.5s ease-out;
      }

      @keyframes successReveal {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Domino Hero */
      .domino-container {
        position: relative;
        margin-bottom: 40px;
        perspective: 1000px;
      }

      .domino {
        width: 90px;
        height: 180px;
        background: linear-gradient(165deg, #fefefe 0%, #f5f0eb 40%, #e8e2db 100%);
        border-radius: 14px;
        margin: 0 auto;
        position: relative;
        box-shadow:
          0 25px 50px rgba(0, 0, 0, 0.6),
          0 0 80px rgba(212, 165, 116, 0.3),
          0 0 120px rgba(255, 215, 0, 0.1),
          inset 0 2px 0 rgba(255, 255, 255, 0.8);
        animation: dominoSlam 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
      }

      @keyframes dominoSlam {
        0% { transform: rotateX(-90deg) translateY(-40px); opacity: 0; }
        60% { transform: rotateX(10deg); }
        100% { transform: rotateX(0deg) translateY(0); opacity: 1; }
      }

      .domino::before {
        content: '';
        position: absolute;
        left: 10%;
        right: 10%;
        top: 50%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--copper), transparent);
        border-radius: 2px;
        transform: translateY(-50%);
      }

      .domino::after {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 14px;
        background: radial-gradient(ellipse at center, rgba(212, 165, 116, 0.3) 0%, transparent 70%);
        animation: glowPulse 2s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes glowPulse {
        0%, 100% { opacity: 0.5; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.05); }
      }

      .domino-top, .domino-bottom {
        position: absolute;
        left: 0;
        right: 0;
        height: 50%;
      }

      .domino-top { top: 0; }
      .domino-bottom { bottom: 0; }

      .pip {
        position: absolute;
        width: 16px;
        height: 16px;
        background: radial-gradient(circle at 30% 30%, var(--copper), #2a1810);
        border-radius: 50%;
        box-shadow:
          inset 0 2px 4px rgba(0, 0, 0, 0.5),
          0 1px 2px rgba(0, 0, 0, 0.2);
      }

      /* Double six pip positions - top half (90x180 domino) */
      .domino-top .pip:nth-child(1) { top: 14px; left: 16px; }
      .domino-top .pip:nth-child(2) { top: 14px; right: 16px; }
      .domino-top .pip:nth-child(3) { top: 50%; left: 16px; transform: translateY(-50%); }
      .domino-top .pip:nth-child(4) { top: 50%; right: 16px; transform: translateY(-50%); }
      .domino-top .pip:nth-child(5) { bottom: 18px; left: 16px; }
      .domino-top .pip:nth-child(6) { bottom: 18px; right: 16px; }

      /* Double six pip positions - bottom half */
      .domino-bottom .pip:nth-child(1) { top: 14px; left: 16px; }
      .domino-bottom .pip:nth-child(2) { top: 14px; right: 16px; }
      .domino-bottom .pip:nth-child(3) { top: 50%; left: 16px; transform: translateY(-50%); }
      .domino-bottom .pip:nth-child(4) { top: 50%; right: 16px; transform: translateY(-50%); }
      .domino-bottom .pip:nth-child(5) { bottom: 14px; left: 16px; }
      .domino-bottom .pip:nth-child(6) { bottom: 14px; right: 16px; }

      /* Shimmer particles */
      .shimmer {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--gold);
        border-radius: 50%;
        animation: shimmerFloat 3s ease-in-out infinite;
        opacity: 0;
      }

      .shimmer:nth-child(1) { left: 20%; top: 20%; animation-delay: 0s; }
      .shimmer:nth-child(2) { left: 80%; top: 30%; animation-delay: 0.5s; }
      .shimmer:nth-child(3) { left: 10%; top: 60%; animation-delay: 1s; }
      .shimmer:nth-child(4) { left: 90%; top: 70%; animation-delay: 1.5s; }
      .shimmer:nth-child(5) { left: 50%; top: 10%; animation-delay: 2s; }

      @keyframes shimmerFloat {
        0%, 100% { opacity: 0; transform: translateY(0) scale(0.5); }
        50% { opacity: 1; transform: translateY(-10px) scale(1); }
      }

      /* Success Headlines */
      .success-headline {
        font-family: "Bodoni Moda", serif;
        font-size: clamp(3rem, 12vw, 4.5rem);
        font-weight: 700;
        color: var(--cream);
        letter-spacing: 0.02em;
        margin-bottom: 12px;
        animation: fadeUp 0.6s ease-out 0.4s both;
        line-height: 1.1;
      }

      .success-headline span {
        color: var(--brass);
        display: inline-block;
        text-shadow:
          0 0 30px rgba(212, 165, 116, 0.5),
          0 0 60px rgba(183, 106, 59, 0.3);
        animation: brassShine 3s ease-in-out infinite;
      }

      @keyframes brassShine {
        0%, 100% {
          text-shadow: 0 0 30px rgba(212, 165, 116, 0.5), 0 0 60px rgba(183, 106, 59, 0.3);
          filter: brightness(1);
        }
        50% {
          text-shadow: 0 0 50px rgba(212, 165, 116, 0.7), 0 0 100px rgba(183, 106, 59, 0.4);
          filter: brightness(1.1);
        }
      }

      .success-subheadline {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 36px;
        animation: fadeUp 0.6s ease-out 0.5s both;
        letter-spacing: 0.03em;
      }

      /* Event Details Card */
      .event-details {
        background: linear-gradient(135deg, rgba(183, 106, 59, 0.15) 0%, rgba(183, 106, 59, 0.05) 100%);
        border: 1px solid rgba(212, 165, 116, 0.3);
        border-radius: 20px;
        padding: 28px 40px;
        margin-bottom: 32px;
        position: relative;
        overflow: hidden;
        animation: fadeUp 0.6s ease-out 0.6s both;
        width: 100%;
        max-width: 320px;
      }

      .event-details::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.1), transparent);
        animation: cardShine 4s ease-in-out infinite;
      }

      @keyframes cardShine {
        0% { left: -100%; }
        50%, 100% { left: 200%; }
      }

      .event-date {
        font-family: "Bodoni Moda", serif;
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--brass);
        margin-bottom: 8px;
        letter-spacing: 0.02em;
      }

      .event-venue {
        font-size: 1.15rem;
        color: var(--cream);
        margin-bottom: 6px;
        font-weight: 500;
        letter-spacing: 0.01em;
      }

      .event-time {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.6);
        letter-spacing: 0.02em;
      }

      .event-payment {
        font-family: "Bodoni Moda", serif;
        font-size: 1.1rem;
        font-style: italic;
        color: var(--brass);
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(212, 165, 116, 0.2);
      }

      /* Divider */
      .success-divider {
        display: flex;
        align-items: center;
        gap: 20px;
        margin: 28px 0;
        width: 100%;
        max-width: 240px;
        animation: fadeUp 0.6s ease-out 0.7s both;
      }

      .success-divider::before,
      .success-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.5), transparent);
      }

      .divider-pip {
        width: 10px;
        height: 10px;
        background: radial-gradient(circle at 30% 30%, var(--brass), var(--copper));
        border-radius: 50%;
        box-shadow: 0 0 12px rgba(212, 165, 116, 0.4);
      }

      /* Tagline */
      .success-tagline {
        font-family: "Bodoni Moda", serif;
        font-size: 1.4rem;
        font-style: italic;
        color: var(--brass);
        opacity: 0.9;
        animation: fadeUp 0.6s ease-out 0.8s both;
        letter-spacing: 0.02em;
      }

      /* La Mesa CTA - The reward after registration - Bone Language */
      .success-mesa-cta {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: var(--cream);
        background: linear-gradient(135deg, var(--copper), #6b3020);
        border: none;
        border-radius: 12px;
        padding: 16px 32px;
        margin-top: 32px;
        cursor: pointer;
        letter-spacing: 0.05em;
        box-shadow:
          0 4px 20px rgba(143, 60, 34, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
        transition: all 0.3s ease;
        animation: fadeUp 0.6s ease-out 1s both;
      }

      .success-mesa-cta:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow:
          0 8px 30px rgba(143, 60, 34, 0.5),
          0 0 40px rgba(212, 165, 116, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }

      .success-mesa-cta:active {
        transform: translateY(-1px) scale(1);
      }

      /* Email reminder */
      .email-reminder {
        margin-top: 40px;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.45);
        animation: fadeUp 0.6s ease-out 0.9s both;
      }

      .email-reminder a {
        color: rgba(212, 165, 116, 0.7);
        text-decoration: none;
        transition: color 0.2s ease;
        border-bottom: 1px solid rgba(212, 165, 116, 0.3);
        padding-bottom: 2px;
      }

      .email-reminder a:hover {
        color: var(--brass);
        border-bottom-color: var(--brass);
      }

      /* ========================================
         LA MESA TUTORIAL PANEL
         ======================================== */
      .mesa-tutorial {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      .mesa-tutorial.is-visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .mesa-tutorial__content {
        background: rgba(28, 19, 15, 0.95);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(212, 165, 116, 0.2);
        border-radius: 12px;
        padding: 24px;
        max-width: 300px;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.5),
          0 0 60px rgba(212, 165, 116, 0.08);
      }

      .mesa-tutorial__header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .mesa-tutorial__icon {
        width: 10px;
        height: 10px;
        background: radial-gradient(circle at 30% 30%, var(--brass), var(--copper));
        border-radius: 50%;
        box-shadow: 0 0 12px rgba(212, 165, 116, 0.5);
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
      }

      .mesa-tutorial__title {
        font-family: "Bodoni Moda", serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--brass);
        margin: 0;
        letter-spacing: 0.02em;
      }

      .mesa-tutorial__desc {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.5;
        margin: 0 0 20px 0;
      }

      .mesa-tutorial__actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* Tutorial CTA - Bone Language */
      .mesa-tutorial__cta {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--cream);
        background: linear-gradient(135deg, var(--copper), #6b3020);
        border: none;
        border-radius: 12px;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(143, 60, 34, 0.3);
      }

      .mesa-tutorial__cta:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(143, 60, 34, 0.4);
      }

      .mesa-tutorial__dismiss {
        font-family: "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.5);
        background: transparent;
        border: none;
        padding: 8px;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .mesa-tutorial__dismiss:hover {
        color: rgba(255, 255, 255, 0.8);
      }

      /* Footer */
      .footer-note {
        margin-top: 28px;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.85rem;
        text-align: center;
      }

      .footer-note a {
        color: var(--brass);
        text-decoration: none;
      }

      /* Responsive */
      @media (max-width: 640px) {
        .panel {
          padding: 20px 16px;
        }

        .form-shell {
          padding: 22px 18px;
        }

        .players {
          padding: 14px;
        }

        .progress-tracker {
          padding: 16px 20px;
        }

        .panel--form {
          padding-top: 8vh; /* Still breathe on tablet */
        }
      }

      /* Mobile form panel - breathe, don't cram */
      @media (max-width: 768px) {
        .progress-tracker {
          display: none;
        }

        /* Edition badge hidden on mobile - clean focus */
        .form-header__edition {
          display: none;
        }

        /* Headline on mobile - generous breathing room */
        .form-header {
          margin-bottom: 24px;
        }

        .panel--form .panel-headline {
          font-size: clamp(1.6rem, 6vw, 2.2rem);
          margin-bottom: 18px;
          line-height: 1.15;
        }

        /* Hide Notes field on mobile - it's optional and saves space */
        .label--optional {
          display: none;
        }

        /* Hide the scroll-hint divider - footer is always visible now */
        .scroll-hint-divider {
          display: none !important;
        }

        /* Hide TOP scarcity on mobile - moved below button */
        .form-scarcity {
          display: none;
        }

        /* Show button scarcity on mobile */
        .button-scarcity {
          display: block;
        }

        /* Form spacing - comfortable, not cramped */
        form {
          gap: 16px;
        }

        /* Panel needs room to BREATHE at the top */
        .panel--form {
          padding-top: max(60px, 10vh); /* At least 60px, scales with screen */
          padding-bottom: 60px; /* Ticker clearance */
          justify-content: flex-start;
          scroll-snap-align: start; /* Snap to start, not center */
        }

        .form-shell {
          padding: 24px 20px;
          margin-bottom: 0;
        }

	        .footer-contact {
	          margin-top: 0;
	          gap: 28px;
	          flex-direction: column;
	          align-items: center;
	          width: 100%;
	        }

        /* Horizontal divider on mobile */
        .footer-contact__divider {
          width: 40px;
          height: 1px;
          background: rgba(212, 165, 116, 0.2);
        }

        .footer-contact__item {
          align-items: center;
          text-align: center;
          min-width: auto; /* Reset desktop min-width */
          width: 100%;
        }

        .footer-contact__label {
          font-size: 0.7rem;
        }

        .footer-contact__link {
          font-size: 0.95rem;
        }

        .brand-footer {
          margin-top: 40px;
          align-items: center;
        }

        .brand-footer__logo {
          font-size: 1.3rem;
        }

        .brand-footer__text {
          font-size: 0.7rem;
        }
      }

      /* Small phones - still breathe */
      @media (max-width: 480px) {
        .panel--form {
          padding-top: max(50px, 8vh); /* Never less than 50px */
        }

        .form-shell {
          padding: 20px 16px;
        }

        form {
          gap: 14px;
        }

        label {
          font-size: 0.95rem;
        }

        input, textarea {
          padding: 8px 0;
          font-size: 0.95rem;
        }

        button[type="submit"] {
          padding: 16px 24px;
          font-size: 0.9rem;
          margin-top: 8px;
        }

      }

      /* Hide honeypot */
      .honeypot {
        position: absolute;
        left: -9999px;
      }

      /* Floating Music Toggle */
      .music-toggle {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(28, 19, 15, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(183, 106, 59, 0.4);
        border-radius: 50px;
        padding: 12px 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: "IBM Plex Sans", sans-serif;
        font-size: 13px;
        color: #d4a574;
      }

      .music-toggle:hover {
        background: rgba(28, 19, 15, 1);
        border-color: rgba(183, 106, 59, 0.7);
        transform: scale(1.02);
      }

      .music-toggle:active,
      .music-toggle:focus {
        transform: scale(0.95);
        background: rgba(28, 19, 15, 1);
      }

      /* Hide music toggle on mobile */
      @media (max-width: 768px) {
        .music-toggle {
          display: none !important;
        }
      }

      .music-toggle__icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .music-toggle__label {
        white-space: nowrap;
      }

      /* Playing state */
      .music-toggle.is-playing {
        border-color: #b76a3b;
        box-shadow: 0 0 20px rgba(183, 106, 59, 0.3);
      }

      .music-toggle.is-playing .music-toggle__icon {
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Sound wave bars animation */
      .sound-bars {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 16px;
      }

      .sound-bars span {
        display: block;
        width: 3px;
        background: #d4a574;
        border-radius: 2px;
        animation: soundBar 0.8s ease-in-out infinite;
      }

      .sound-bars span:nth-child(1) { height: 40%; animation-delay: 0s; }
      .sound-bars span:nth-child(2) { height: 70%; animation-delay: 0.15s; }
      .sound-bars span:nth-child(3) { height: 50%; animation-delay: 0.3s; }
      .sound-bars span:nth-child(4) { height: 80%; animation-delay: 0.45s; }

      @keyframes soundBar {
        0%, 100% { transform: scaleY(1); }
        50% { transform: scaleY(0.5); }
      }

      .music-toggle:not(.is-playing) .sound-bars span {
        animation: none;
        height: 30%;
      }

      /* Collapse label after first tap */
      .music-toggle.collapsed {
        padding: 12px;
      }

      .music-toggle.collapsed .music-toggle__label {
        display: none;
      }

      @media (max-width: 768px) {
        .music-toggle {
          top: 16px;
          right: 16px;
          padding: 10px 14px;
          font-size: 12px;
          transition: opacity 0.3s ease, transform 0.3s ease;
        }

      }

      /* @Mention highlighting in chat */
      .mention {
        color: var(--brass);
        font-weight: 600;
        background: rgba(212, 165, 116, 0.1);
        padding: 1px 4px;
        border-radius: 2px;
      }

      /* ========================================
         BRAND FOOTER — Film Credits Style
         ======================================== */
      .brand-footer {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        width: 100%;
        gap: 14px;
        margin-top: 48px;
      }

      .brand-footer__logo {
        font-family: "Bodoni Moda", "Didot", serif;
        font-size: 2rem;
        font-weight: 900;
        font-style: italic;
        letter-spacing: 0.2em;
        background: linear-gradient(180deg, var(--brass) 0%, var(--copper) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .brand-footer__text {
        font-family: "IBM Plex Sans Condensed", "IBM Plex Sans", system-ui, sans-serif;
        font-size: 0.7rem;
        font-weight: 500;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.3);
      }

      .brand-footer__tagline {
        font-family: "Bodoni Moda", "Didot", serif;
        font-style: italic;
        font-size: 0.95rem;
        color: rgba(212, 165, 116, 0.6);
        letter-spacing: 0.08em;
      }

      @media (max-width: 640px) {
        .brand-footer {
          margin-top: 40px;
        }
        .brand-footer__logo {
          font-size: 1.8rem;
        }
      }
    </style>
  </head>
  <body class="is-loading">
    <!-- Loading Screen - "The Ritual Before The Game" -->
    <div class="loading-screen" id="loadingScreen">
      <!-- Atmospheric fog - breathing warmth -->
      <div class="fog-container">
        <div class="fog-layer--ambient"></div>
      </div>

      <!-- Ember particles - like cigar smoke drifting upward -->
      <div class="ember-container">
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
      </div>

      <!-- The CDL Tile - sacred geometry -->
      <div class="cdl-tile">
        <div class="cdl-tile__glow"></div>
        <div class="cdl-tile__upper">
          <span class="cdl-tile__letter cdl-tile__letter--c">C</span>
          <span class="cdl-tile__letter cdl-tile__letter--d">D</span>
        </div>
        <div class="cdl-tile__divider"></div>
        <div class="cdl-tile__lower">
          <span class="cdl-tile__letter cdl-tile__letter--l">L</span>
        </div>
      </div>
    </div>

	    <div class="story">
	      <div class="story-overlays" aria-hidden="true">
	        <div class="vignette-overlay"></div>
	        <div class="chromatic-aberration"></div>
	      </div>
	      <main>
      <!-- Panel 1: Brand Introduction -->
      <section class="panel panel--hero" id="heroPanel">
        <div class="panel-bg panel-bg--hero" style="background-image: url('/FRAMES/frame-hero.webp')"></div>
        <div class="panel-overlay"></div>
        <div class="panel-content">
          <!-- CDL 1 Domino Badge - Bone Language -->
          <div class="hero-badge">
            <span class="hero-badge__top">CDL</span>
            <div class="hero-badge__divider"></div>
            <span class="hero-badge__bottom">1</span>
          </div>

          <!-- THE HERO - Tournament Name -->
          <h1 class="event-title">
            <span class="event-numeral event-numeral--salida" data-text="La Salida">La Salida</span>
          </h1>

          <!-- Championship stamp -->
          <p class="hero-tagline">The First Cuban Domino League Championship</p>

          <!-- Date/Venue -->
	          <p class="hero-subtitle">January 31, 2025<span class="dot">•</span><a href="https://share.google/Bd3ZofPsvccfdT7EC" target="_blank" rel="noreferrer">Mr Garcia Cigars</a></p>
        </div>
        <div class="hero-scroll-hint" id="heroScrollHint" aria-hidden="true">
          <div class="hero-scroll-hint__chevron"></div>
        </div>
      </section>

      <!-- Panel 2: The Cinematic Frame -->
      <section class="panel panel--whisper" id="panelWhisper">
        <div class="panel-bg" style="background-image: url('/FRAMES/frame-2.webp')"></div>
        <div class="fog-layer"></div>
        <div class="panel-overlay"></div>

        <!-- TOP LETTERBOX - His greeting descends from darkness -->
        <div class="whisper-top">
          <p class="whisper-greeting">Que Bola Asere</p>
        </div>

        <!-- BOTTOM LETTERBOX - The moment arrives -->
        <div class="whisper-bottom">
          <p class="whisper-line whisper-line--ancestors">You've been waiting for this.</p>
          <!-- Scroll hint - appears after narrative -->
          <div class="whisper-scroll-hint">
            <div class="whisper-scroll-hint__chevron"></div>
          </div>
        </div>

        <div class="smoke-layer"></div>
      </section>

      <!-- Panel 3: The Revelation - Cinematic Climax -->
	      <section class="panel panel--build" id="panelBuild">
	        <div class="panel-bg" style="background-image: url('/FRAMES/frame-3.webp')"></div>
	        <div class="fog-layer"></div>
	        <div class="panel-overlay"></div>

        <!-- TOP LETTERBOX - Empty, let INHERITED command the space -->
        <div class="build-top"></div>

        <!-- CENTER - The ancestors are watching too -->
        <div class="build-center">
          <div class="build-revelation">
            <span class="build-word build-word--inherited">SO HAVE THEY.</span>
          </div>
        </div>

        <!-- BOTTOM LETTERBOX - Scroll hint after revelation -->
        <div class="build-bottom">
          <div class="build-scroll-hint">
            <div class="build-scroll-hint__chevron"></div>
          </div>
        </div>

        <div class="smoke-layer"></div>
      </section>

      <!-- Panel 4: The Mission - "Make Them Proud" -->
      <section class="panel panel--slam" id="panelSlam">
        <div class="panel-bg" style="background-image: url('/FRAMES/frame-4.webp')"></div>
        <div class="fog-layer"></div>
        <div class="panel-overlay"></div>

        <!-- TOP LETTERBOX - Event context sets the stage -->
        <div class="slam-top">
          <p class="slam-context">January 31<span class="dot">•</span>Mr Garcia Cigars</p>
        </div>

        <!-- CENTER - The mission commands attention -->
        <div class="slam-center">
          <!-- CDL 1 Badge - Domino tile as championship marker -->
          <div class="slam-badge">
            <span class="slam-badge__top">CDL</span>
            <div class="slam-badge__divider"></div>
            <span class="slam-badge__bottom">1</span>
          </div>

          <div class="slam-container">
            <span class="slam-word slam-word--winner">Make</span>
            <span class="slam-word slam-word--takes">Them</span>
            <span class="slam-word slam-word--all">PROUD</span>
          </div>
        </div>

        <!-- BOTTOM LETTERBOX - Scroll hint after animation -->
        <div class="slam-bottom">
          <div class="slam-scroll-hint" aria-hidden="true">
            <div class="slam-scroll-hint__chevron"></div>
          </div>
        </div>
      </section>

	      <!-- Panel 5: Rules - "La Ley" - THE LAW (Unified Plaque) -->
	      <section class="panel panel--rules" id="panelRules">
	        <div class="panel-bg" style="background-image: url('/FRAMES/rules-nyc-test.png')"></div>
	        <div class="fog-layer"></div>
	        <div class="panel-overlay"></div>

	        <div class="rules-plaque">
	          <!-- Header - tightly coupled -->
	          <div class="rules-header">
	            <div class="hero-badge hero-badge--rules" aria-hidden="true">
	              <span class="hero-badge__top">CDL</span>
	              <div class="hero-badge__divider"></div>
	              <span class="hero-badge__bottom">1</span>
	            </div>
	            <h2 class="rules-header__title">La Ley</h2>
	            <p class="rules-header__subtitle">The Law of the Table</p>
	          </div>

          <!-- The Law carved in brass -->
          <div class="rules-grid">
            <!-- Primary Rules - The essentials -->
            <div class="rule-card rule-card--primary">
              <p class="rule-card__title">Race to 150</p>
              <p class="rule-card__desc">First team to 150 points wins</p>
            </div>

            <div class="rule-card rule-card--primary">
              <p class="rule-card__title">The Buy-In</p>
              <p class="rule-card__desc">$25 Cash on arrival</p>
            </div>

            <!-- Secondary Rules -->
            <div class="rule-card">
              <p class="rule-card__title">5 Doubles? Dead Hand</p>
              <p class="rule-card__desc">Reshuffle if you draw 5+</p>
            </div>

            <div class="rule-card">
              <p class="rule-card__title">Tie Breaker</p>
              <p class="rule-card__desc">The opener loses the turn</p>
            </div>

            <div class="rule-card">
              <p class="rule-card__title">The Roster</p>
              <p class="rule-card__desc">16 Players. 8 Teams.</p>
            </div>

            <div class="rule-card">
              <p class="rule-card__title">The Lineup</p>
              <p class="rule-card__desc">Paired by the Commissioner</p>
            </div>
          </div>

          <!-- Footer - tightly coupled -->
          <div class="rules-footer-section">
            <div class="rules-divider">
              <span class="rules-divider__domino">🁣</span>
            </div>
            <p class="rules-footer">Respect the table.</p>
            <div class="rules-scroll-hint" aria-hidden="true">
              <div class="rules-scroll-hint__chevron"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Panel 6: Registration Form - "The Final Hand" -->
      <section class="panel panel--form">
        <div class="panel-bg-gradient"></div>
          <div class="panel-content">
          <!-- Story-connected headline -->
          <div class="form-header">
            <h2 class="panel-headline panel-headline--form">La mesa te espera</h2>
          </div>

          <!-- Progress Tracker (Desktop) -->
          <div class="progress-tracker">
            <div class="progress-header">
              <span class="progress-count"><span class="number" id="playerCount">0</span> Seats Taken</span>
              <span class="progress-spots" id="spotsLeft">{PLAYERS_GOAL - PLAYERS_REGISTERED} spots left</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
          </div>

          <!-- Form -->
          <div class="form-shell">
            <!-- Inline scarcity - always visible -->
            <div class="form-scarcity" id="formScarcity">
              <span class="form-scarcity__pulse"></span>
              <span class="form-scarcity__text"><span id="spotsLeftInline">{PLAYERS_GOAL - PLAYERS_REGISTERED}</span> seats remain</span>
            </div>

<form id="signup" novalidate>
              <input
                type="text"
                name="company"
                autocomplete="off"
                tabindex="-1"
                aria-hidden="true"
                class="honeypot"
              />

              <!-- Hidden field - rules accepted by submitting -->
              <input type="hidden" name="ruleConfirm" value="true" />

              <!-- Player Name - PRIMARY input, WHO YOU ARE -->
              <label class="label--primary">
                Player Name
                <div class="input-wrapper">
                  <input name="playerName" required placeholder="Desi Arnaz" />
                </div>
              </label>

              <label>
                Email
                <div class="input-wrapper">
                  <input name="email" type="email" required placeholder="you@email.com" />
                </div>
              </label>

              <label>
                Phone
                <div class="input-wrapper">
                  <input name="phone" type="tel" required placeholder="(555) 123-4567" />
                </div>
              </label>

              <label class="label--optional">
                Notes <span class="label-hint">(optional)</span>
                <div class="input-wrapper">
                  <textarea name="notes" placeholder="Any special requirements?"></textarea>
                </div>
              </label>

              <button type="submit" id="submitBtn">Claim Your Seat</button>
              <!-- Mobile scarcity - below button -->
              <p class="button-scarcity"><span id="spotsLeftButton">{PLAYERS_GOAL - PLAYERS_REGISTERED}</span> seats remain</p>
	              <p class="status" id="status" aria-live="polite"></p>
	            </form>
	          </div>
	        </div>
	      </section>
	
	      <!-- Panel 7: Postscript - The Room at Rest (visual punctuation, no text) -->
      <section class="panel panel--postscript" id="panelPostscript">
        <div class="panel-bg" style="background-image: url('/FRAMES/frame-footer.webp')"></div>
        <div class="fog-layer"></div>
        <div class="smoke-layer"></div>
        <div class="panel-overlay panel-overlay--postscript"></div>
      </section>

      <!-- Panel 8: Footer - Credits -->
      <section class="panel panel--footer" id="eventFooter">
        <div class="panel-content">
          <div class="event-footer-section">
            <div class="footer-contact">
              <div class="footer-contact__item">
                <span class="footer-contact__label">Direct Line</span>
                <a href="mailto:Erik@CubanDominoLeague.com" class="footer-contact__link">Erik@CubanDominoLeague.com</a>
              </div>
              <div class="footer-contact__divider"></div>
              <div class="footer-contact__item">
                <span class="footer-contact__label">Venue</span>
                <a href="https://share.google/Bd3ZofPsvccfdT7EC" target="_blank" rel="noreferrer" class="footer-contact__link">Mr Garcia Cigars</a>
              </div>
            </div>

            <footer class="brand-footer">
              <span class="brand-footer__logo">CDL</span>
              <span class="brand-footer__text">© 2025 Cuban Domino League</span>
            </footer>
          </div>
        </div>
      </section>
	    </main>
	    </div>

    <!-- Success Overlay (outside scroll container for position:fixed to work reliably on iOS Safari) -->
    <div class="success" id="success">
      <!-- Domino Hero Element -->
      <div class="domino-container">
        <span class="shimmer"></span>
        <span class="shimmer"></span>
        <span class="shimmer"></span>
        <span class="shimmer"></span>
        <span class="shimmer"></span>

        <div class="domino">
          <div class="domino-top">
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
          </div>
          <div class="domino-bottom">
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
            <span class="pip"></span>
          </div>
        </div>
      </div>

      <!-- Headlines -->
      <h2 class="success-headline">You're <span>In</span>.</h2>
      <p class="success-subheadline">Check your email for confirmation details</p>

      <!-- Event Details -->
      <div class="event-details">
        <div class="event-date">January 31, 2025</div>
        <div class="event-venue">Mr Garcia Cigars</div>
        <div class="event-time">Doors open at 6PM</div>
        <div class="event-payment">$25 cash on arrival</div>
      </div>

      <!-- Tagline -->
      <div class="success-divider">
        <span class="divider-pip"></span>
      </div>
      <p class="success-tagline">"Your seat's waiting."</p>

      <!-- La Mesa CTA -->
      <button class="success-mesa-cta" id="successMesaCta">
        Pull up a chair at La Mesa →
      </button>

      <!-- Email reminder -->
      <p class="email-reminder">
        Questions? <a href="mailto:Erik@cubandominoleague.com">Erik@cubandominoleague.com</a>
      </p>
    </div>

    <!-- La Mesa Tutorial Panel (shows if user dismisses success without joining) -->
    <div class="mesa-tutorial" id="mesaTutorial">
      <div class="mesa-tutorial__content">
        <div class="mesa-tutorial__header">
          <span class="mesa-tutorial__icon"></span>
          <h3 class="mesa-tutorial__title">La Mesa</h3>
        </div>
        <p class="mesa-tutorial__desc">The player's table. Chat with fellow competitors before the big day.</p>
        <div class="mesa-tutorial__actions">
          <button class="mesa-tutorial__cta" id="tutorialMesaCta">Join the Table →</button>
          <button class="mesa-tutorial__dismiss" id="tutorialDismiss">Maybe Later</button>
        </div>
      </div>
    </div>

    <!-- Music Toggle Button -->
    <button class="music-toggle" id="musicToggle" aria-label="Toggle background music">
      <span class="music-toggle__icon">
        <span class="sound-bars">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </span>
      </span>
      <span class="music-toggle__label">Tap for music</span>
    </button>

    <!-- Background Audio (desktop only) -->
    <audio id="bgMusic" loop preload="none">
      <source src="/AUDIO/background-music.mp3" type="audio/mpeg">
    </audio>

    <!-- Chat Widget - The Sacred Table -->
    <div class="chat-widget" id="chatWidget">
      <!-- Mesa Ticker: ESPN-style activity feed -->
      <div class="mesa-ticker" id="mesaTicker">
        <div class="mesa-ticker__badge">
          <span class="mesa-ticker__badge-dot"></span>
          <span class="mesa-ticker__badge-text">LA MESA</span>
        </div>
        <div class="mesa-ticker__scroll">
          <div class="mesa-ticker__track" id="tickerTrack">
            <!-- Populated by JS - duplicated for seamless loop -->
          </div>
        </div>
        <button class="mesa-ticker__chat-btn" id="tickerChatBtn" type="button" aria-label="Open La Mesa">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5">
            <rect x="6" y="2" width="12" height="20" rx="2" ry="2"/>
            <line x1="6" y1="12" x2="18" y2="12"/>
          </svg>
          <span class="mesa-ticker__chat-badge" id="chatBadge" style="display: none;">0</span>
        </button>
      </div>

      <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
          <div class="chat-header__drag-handle"></div>
          <div class="chat-header__title-group">
            <span class="chat-header__title">La Mesa</span>
          </div>
          <button class="chat-header__close" id="chatClose" type="button" aria-label="Leave table">
            <span class="chat-header__close-label">Leave Table</span>
          </button>
        </div>

        <!-- Identity selection -->
        <div class="chat-identity" id="chatIdentity">
          <p class="chat-identity__title">Take Your Seat</p>
          <p class="chat-identity__subtitle">Represent.</p>

          <!-- Live player count for FOMO -->
          <div class="mesa-live-indicator" id="mesaLiveIndicator">
            <span class="mesa-live-dot"></span>
            <span class="mesa-live-text"><span id="mesaPlayerCount">0</span> at the table</span>
          </div>

          <div class="avatar-selector">
            <!-- Priority: Cuba, USA, then Caribbean & Latin America -->
            <div class="avatar-option selected" data-avatar="cuba" title="Cuba">
              <span class="avatar-flag-pixel">🇨🇺</span>
            </div>
            <div class="avatar-option" data-avatar="usa" title="USA">
              <span class="avatar-flag-pixel">🇺🇸</span>
            </div>
            <!-- Caribbean -->
            <div class="avatar-option" data-avatar="pr" title="Puerto Rico">
              <span class="avatar-flag-pixel">🇵🇷</span>
            </div>
            <div class="avatar-option" data-avatar="dr" title="Dominican Republic">
              <span class="avatar-flag-pixel">🇩🇴</span>
            </div>
            <div class="avatar-option" data-avatar="jamaica" title="Jamaica">
              <span class="avatar-flag-pixel">🇯🇲</span>
            </div>
            <div class="avatar-option" data-avatar="haiti" title="Haiti">
              <span class="avatar-flag-pixel">🇭🇹</span>
            </div>
            <!-- Central & South America -->
            <div class="avatar-option" data-avatar="mexico" title="Mexico">
              <span class="avatar-flag-pixel">🇲🇽</span>
            </div>
            <div class="avatar-option" data-avatar="venezuela" title="Venezuela">
              <span class="avatar-flag-pixel">🇻🇪</span>
            </div>
            <div class="avatar-option" data-avatar="colombia" title="Colombia">
              <span class="avatar-flag-pixel">🇨🇴</span>
            </div>
            <div class="avatar-option" data-avatar="panama" title="Panama">
              <span class="avatar-flag-pixel">🇵🇦</span>
            </div>
            <div class="avatar-option" data-avatar="nicaragua" title="Nicaragua">
              <span class="avatar-flag-pixel">🇳🇮</span>
            </div>
            <div class="avatar-option" data-avatar="honduras" title="Honduras">
              <span class="avatar-flag-pixel">🇭🇳</span>
            </div>
            <div class="avatar-option" data-avatar="brazil" title="Brazil">
              <span class="avatar-flag-pixel">🇧🇷</span>
            </div>
            <div class="avatar-option" data-avatar="argentina" title="Argentina">
              <span class="avatar-flag-pixel">🇦🇷</span>
            </div>
            <div class="avatar-option" data-avatar="peru" title="Peru">
              <span class="avatar-flag-pixel">🇵🇪</span>
            </div>
            <div class="avatar-option" data-avatar="ecuador" title="Ecuador">
              <span class="avatar-flag-pixel">🇪🇨</span>
            </div>
            <div class="avatar-option" data-avatar="chile" title="Chile">
              <span class="avatar-flag-pixel">🇨🇱</span>
            </div>
            <!-- North America & Europe -->
            <div class="avatar-option" data-avatar="canada" title="Canada">
              <span class="avatar-flag-pixel">🇨🇦</span>
            </div>
            <div class="avatar-option" data-avatar="spain" title="Spain">
              <span class="avatar-flag-pixel">🇪🇸</span>
            </div>
            <div class="avatar-option" data-avatar="italy" title="Italy">
              <span class="avatar-flag-pixel">🇮🇹</span>
            </div>
            <div class="avatar-option" data-avatar="france" title="France">
              <span class="avatar-flag-pixel">🇫🇷</span>
            </div>
            <div class="avatar-option" data-avatar="germany" title="Germany">
              <span class="avatar-flag-pixel">🇩🇪</span>
            </div>
            <div class="avatar-option" data-avatar="uk" title="United Kingdom">
              <span class="avatar-flag-pixel">🇬🇧</span>
            </div>
            <div class="avatar-option" data-avatar="portugal" title="Portugal">
              <span class="avatar-flag-pixel">🇵🇹</span>
            </div>
          </div>
          <p class="avatar-hint">Scroll to find your flag</p>

          <!-- Custom Dropdown -->
          <div class="custom-select" id="customSelect">
            <button class="custom-select__trigger" id="selectTrigger" type="button">
              <span class="custom-select__value" id="selectValue">Select Your Name...</span>
              <span class="custom-select__arrow">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </button>
            <div class="custom-select__dropdown" id="selectDropdown">
              <div class="custom-select__search">
                <input type="text" class="custom-select__search-input" id="selectSearch" placeholder="Search..." />
              </div>
              <ul class="custom-select__options" id="selectOptions">
                <!-- Options populated by JS -->
              </ul>
            </div>
          </div>
          <!-- Hidden native select for form compatibility -->
          <select class="chat-identity__select" id="chatPlayerSelect" style="display: none;">
            <option value="">Select Your Name</option>
          </select>
          <input type="text" class="chat-identity__input" id="chatNameInput" placeholder="Your name..." style="display: none;" />
          <p class="chat-identity__register-hint" id="chatRegisterHint">
            Don't see your name? <a href="#signup" class="chat-identity__register-link" id="chatRegisterLink">Register first</a>
          </p>
          <button class="chat-identity__btn" id="chatJoinBtn" disabled>Enter</button>
        </div>

        <!-- Chat Screen Area -->
        <div class="chat-body-container" id="chatBodyContainer" style="display: none;">
          <div class="chat-messages" id="chatMessages">
            <div class="chat-empty">The table is quiet.</div>
          </div>


          <div class="chat-input-area" id="chatInputArea">
            <input type="text" class="chat-input" id="chatInput" placeholder="Habla..." maxlength="500">
            <button class="chat-send" id="chatSend" disabled>
              <svg viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- "Unlock La Mesa" — ESPN credential, not app notification -->
    <div class="mesa-help" id="mesaHelp" role="status" aria-live="polite" aria-atomic="true">
      <div class="mesa-help__badge">ACCESS</div>
      <div class="mesa-help__content">
        <div class="mesa-help__title">UNLOCK LA MESA</div>
        <p class="mesa-help__text">Register first. Then the domino opens.</p>
      </div>
      <button class="mesa-help__dismiss" id="mesaHelpDismiss" type="button">DISMISS</button>
    </div>

    <!-- Background Dimming Overlay -->
    <div class="chat-backdrop" id="chatBackdrop"></div>

	    <script define:vars={{ PLAYERS_REGISTERED, PLAYERS_GOAL, SUPABASE_URL, SUPABASE_ANON_KEY }}>
	      // Loading Screen Dismissal Logic - Pure CSS
	      let didDismissLoadingScreen = false;
	      function dismissLoadingScreen() {
	        if (didDismissLoadingScreen) return;
	        didDismissLoadingScreen = true;
	        const loadingScreen = document.getElementById('loadingScreen');
	        document.body.classList.remove('is-loading');

	        const markReady = () => {
          if (document.body.classList.contains('is-ready')) return;
          document.body.classList.add('is-ready');
          window.dispatchEvent(new Event('cdl:ready'));
        };

	        if (!loadingScreen) {
	          markReady();
	          return;
	        }

	        // Let the loading screen breathe, but stop blocking scroll/taps quickly.
	        // The ritual takes ~3.5s, then heartbeat begins. Hold for one full breath.
	        const INTERACTION_RELEASE_MS = 180;
	        const VISUAL_HOLD_MS = 5500;  // 5.5 seconds — tighter, less waiting

	        setTimeout(() => {
	          loadingScreen.classList.add('is-passive');
	        }, INTERACTION_RELEASE_MS);

	        setTimeout(() => {
	          loadingScreen.classList.add('is-hidden');
	          // "Darkness beat" — wait for loading to fade before hero reveals
	          // This creates a brief moment of darkness (the "cut") before the scene begins
	          setTimeout(() => {
	            markReady();
	          }, 300);
	          // Fully remove from DOM after fade completes (600ms fade + buffer)
	          setTimeout(() => {
	            if (loadingScreen.parentNode) {
	              loadingScreen.remove();
	            }
	          }, 800);
	        }, VISUAL_HOLD_MS);
	      }

	      // Trigger dismissal as soon as DOM is ready (don't wait for full window load).
	      if (document.readyState === 'complete' || document.readyState === 'interactive') {
	        dismissLoadingScreen();
	      } else {
	        document.addEventListener('DOMContentLoaded', dismissLoadingScreen, { once: true });
	      }

	      // Fallback: Force dismissal after 8 seconds (ritual takes ~5.5s now)
	      setTimeout(dismissLoadingScreen, 8000);

      // Panel parallax and content animations
      const allPanels = document.querySelectorAll('.panel');
      const storyEl = document.querySelector('.story');
      const heroScrollHint = document.getElementById('heroScrollHint');
      let heroHintTimer = null;

      const inViewRatioThreshold = 0.4;
      const enterThreshold = 0.45;
      const exitThreshold = 0.25;

      const panelObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const ratio = typeof entry.intersectionRatio === 'number' ? entry.intersectionRatio : 0;

          if (ratio >= enterThreshold) {
            entry.target.classList.add('in-view');
            if (entry.target.classList.contains('has-played') && !entry.target.classList.contains('reentering')) {
              entry.target.classList.add('reentering');
              setTimeout(() => entry.target.classList.remove('reentering'), 420);
            }
          } else if (ratio <= exitThreshold) {
            entry.target.classList.remove('in-view');
          }
        });
      }, { threshold: [0, exitThreshold, enterThreshold, 1] });

      // Skip observing the first panel (hero) - it should always be visible
      allPanels.forEach((panel, index) => {
        if (index > 0) {
          panelObserver.observe(panel);
        }
      });

      // First panel is always in view
      allPanels[0]?.classList.add('in-view');

      // Tobias: Let the hero breathe, then nudge (subtle scroll cue).
      if (storyEl && heroScrollHint) {
        const hideHeroHint = () => {
          heroScrollHint.classList.remove('is-ready');
          if (heroHintTimer) {
            clearTimeout(heroHintTimer);
            heroHintTimer = null;
          }
        };

        const scheduleHeroHint = () => {
          if (heroHintTimer) clearTimeout(heroHintTimer);
          heroHintTimer = setTimeout(() => {
            // Only hint when at the very top and no modal/overlay is taking focus.
            if (storyEl.scrollTop > 10) return;
            if (document.body.classList.contains('chat-open')) return;
            heroScrollHint.classList.add('is-ready');
          }, 2600);
        };

        const onStoryScroll = () => {
          if (storyEl.scrollTop <= 10) scheduleHeroHint();
          else hideHeroHint();
        };

        storyEl.addEventListener('scroll', onStoryScroll, { passive: true });

        const startWhenReady = () => onStoryScroll();
        if (document.body.classList.contains('is-ready')) startWhenReady();
        else window.addEventListener('cdl:ready', startWhenReady, { once: true });
      }

      // Scroll-lock system for cinematic panels
      // Prevents scrolling until animations complete
      const whisperPanel = document.getElementById('panelWhisper');
      const buildPanel = document.getElementById('panelBuild');
      const slamPanel = document.getElementById('panelSlam');
      const rulesPanel = document.getElementById('panelRules');
      let scrollLocked = false;
      let whisperHasPlayed = false;
      let buildHasPlayed = false;
      let slamHasPlayed = false;
      let rulesHasPlayed = false;
      let lastTouchY = null;
      let scrollLockTimer = null;

      const scrollBlockTarget = storyEl ?? document;

      // Track touch direction so we can block "skip ahead" without trapping users.
      if (storyEl) {
        storyEl.addEventListener(
          'touchstart',
          (e) => {
            const y = e.touches?.[0]?.clientY;
            if (typeof y === 'number') lastTouchY = y;
          },
          { passive: true }
        );
      }

      function snapToPanelTop(panelEl) {
        if (!storyEl || !panelEl) return;
        const storyRect = storyEl.getBoundingClientRect();
        const panelRect = panelEl.getBoundingClientRect();
        const delta = panelRect.top - storyRect.top;
        if (Math.abs(delta) <= 24) return; // close enough; avoid iOS flicker/jump
        const targetTop = storyEl.scrollTop + delta;
        storyEl.scrollTo({ top: targetTop, behavior: 'auto' });
      }

      function alignPanelAfterSettle(panelEl) {
        if (!storyEl || !panelEl) return;
        let lastTop = storyEl.scrollTop;
        let stableFrames = 0;
        let frames = 0;

        const step = () => {
          frames += 1;
          const top = storyEl.scrollTop;
          if (Math.abs(top - lastTop) < 0.5) stableFrames += 1;
          else stableFrames = 0;
          lastTop = top;

          if (stableFrames >= 3) {
            if (typeof getPanelVisibilityRatio === 'function' && getPanelVisibilityRatio(panelEl) >= 0.9) {
              snapToPanelTop(panelEl);
            }
            return;
          }
          if (frames < 28) requestAnimationFrame(step);
        };

        requestAnimationFrame(step);
      }

      function preventScroll(e) {
        if (scrollLocked) {
          // Allow scrolling BACK (up) while locked; only block skipping forward (down).
          if (e.type === 'wheel') {
            if (e.deltaY < 0) return;
          } else if (e.type === 'touchmove') {
            const currentY = e.touches?.[0]?.clientY;
            if (typeof currentY === 'number') {
              const delta = lastTouchY == null ? 0 : currentY - lastTouchY;
              lastTouchY = currentY;
              // Finger moving DOWN => content scrolls UP (allow).
              if (delta > 0) return;
            }
          }

          e.preventDefault();
          e.stopPropagation();
        }
      }

      function lockScroll(duration, afterUnlock) {
        scrollLocked = true;
        scrollBlockTarget.addEventListener('wheel', preventScroll, { passive: false });
        scrollBlockTarget.addEventListener('touchmove', preventScroll, { passive: false });

        if (scrollLockTimer) clearTimeout(scrollLockTimer);
        scrollLockTimer = setTimeout(() => {
          unlockScroll();
          if (typeof afterUnlock === 'function') afterUnlock();
        }, duration);
      }

      function unlockScroll() {
        scrollLocked = false;
        scrollBlockTarget.removeEventListener('wheel', preventScroll);
        scrollBlockTarget.removeEventListener('touchmove', preventScroll);
        if (scrollLockTimer) {
          clearTimeout(scrollLockTimer);
          scrollLockTimer = null;
        }
      }

      // Panel 2 (Whisper) scroll-lock - 4.5 seconds
      const whisperObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !whisperHasPlayed) {
            whisperHasPlayed = true;
            alignPanelAfterSettle(whisperPanel);
            lockScroll(4500, () => whisperPanel?.classList.add('has-played'));
          }
        });
      }, { threshold: 0.6 });

      // Panel 3 (Build/Revelation) scroll-lock - 5.5 seconds
      const buildObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !buildHasPlayed) {
            buildHasPlayed = true;
            alignPanelAfterSettle(buildPanel);
            lockScroll(5500, () => buildPanel?.classList.add('has-played'));
          }
        });
      }, { threshold: 0.6 });

      // Panel 4 (Slam/Stakes) scroll-lock - 3.5 seconds
      const slamObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !slamHasPlayed) {
            slamHasPlayed = true;
            alignPanelAfterSettle(slamPanel);
            lockScroll(3500, () => slamPanel?.classList.add('has-played'));
          }
        });
      }, { threshold: 0.6 });

	      // Panel 5 (Rules/La Ley) scroll-lock - 3 seconds
	      const rulesObserver = new IntersectionObserver((entries) => {
	        entries.forEach(entry => {
	          if (entry.isIntersecting && !rulesHasPlayed) {
	            rulesHasPlayed = true;
	            alignPanelAfterSettle(rulesPanel);
	            lockScroll(3000, () => {
	              // Let Safari finish its snap/momentum and the unlock paint before we flip to the static state.
	              requestAnimationFrame(() => {
	                requestAnimationFrame(() => rulesPanel?.classList.add('has-played'));
	              });
	            });
	          }
	        });
	      }, { threshold: 0.6 });

      if (whisperPanel) whisperObserver.observe(whisperPanel);
      if (buildPanel) buildObserver.observe(buildPanel);
      if (slamPanel) slamObserver.observe(slamPanel);
      if (rulesPanel) rulesObserver.observe(rulesPanel);

      // La Mesa button bypass - unlock scroll and go to form
      const laMesaButton = document.querySelector('.la-mesa-toggle');
	      if (laMesaButton) {
	        laMesaButton.addEventListener('click', () => {
	          unlockScroll();
	          // Mark all as played so they don't re-lock
	          whisperHasPlayed = true;
	          buildHasPlayed = true;
	          slamHasPlayed = true;
	          rulesHasPlayed = true;
	          whisperPanel?.classList.add('has-played');
	          buildPanel?.classList.add('has-played');
	          slamPanel?.classList.add('has-played');
	          rulesPanel?.classList.add('has-played');
	        });
	      }

      // Progress counter animation
      const playerCountEl = document.getElementById("playerCount");
      const spotsLeftEl = document.getElementById("spotsLeft");
      const spotsLeftButtonEl = document.getElementById("spotsLeftButton");
      const progressFillEl = document.getElementById("progressFill");

      function animateCounter(target, duration = 1000) {
        let start = 0;
        const startTime = performance.now();

        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic

          const current = Math.floor(eased * target);
          playerCountEl.textContent = current;

          if (progress < 1) {
            requestAnimationFrame(update);
          } else {
            playerCountEl.textContent = target;
          }
        }

        requestAnimationFrame(update);
      }

      // Animate progress bar and counter when panel comes into view
      const formPanel = document.querySelector(".panel--form");
      let hasAnimated = false;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !hasAnimated) {
            hasAnimated = true;

            // Animate counter
            animateCounter(PLAYERS_REGISTERED);

            // Animate progress bar
            const percentage = (PLAYERS_REGISTERED / PLAYERS_GOAL) * 100;
            setTimeout(() => {
              progressFillEl.style.width = percentage + "%";
            }, 100);

            // Update spots left (desktop and mobile button)
            spotsLeftEl.textContent = (PLAYERS_GOAL - PLAYERS_REGISTERED) + " spots left";
            if (spotsLeftButtonEl) spotsLeftButtonEl.textContent = (PLAYERS_GOAL - PLAYERS_REGISTERED);
          }
        });
      }, { threshold: 0.3 });

      observer.observe(formPanel);

      // Form submission
      const form = document.getElementById("signup");
      const statusEl = document.getElementById("status");
      const successEl = document.getElementById("success");
      const submitBtn = document.getElementById("submitBtn");

      // DEV ONLY: Test success screen without submitting form
      // Call window.testSuccess() from console to trigger
      window.testSuccess = () => {
        form.style.display = "none";
        successEl.classList.add("is-visible");
        localStorage.setItem('cdl_registered', 'true');
        document.querySelector(".panel--form .panel-headline").style.display = "none";
        document.querySelector(".progress-tracker").style.display = "none";
        const footer = document.querySelector(".footer-note");
        if (footer) footer.style.display = "none";
        console.log('✅ Success screen triggered. localStorage set.');
      };
      // DEV ONLY: Reset registration state
      window.testReset = () => {
        localStorage.removeItem('cdl_registered');
        location.reload();
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!form.reportValidity()) return;
        statusEl.textContent = "Submitting…";
        submitBtn.disabled = true;

        const payload = Object.fromEntries(new FormData(form).entries());

        try {
          const response = await fetch("/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await response.json().catch(() => ({}));
          if (data && data.ok) {
            form.reset();
            form.style.display = "none";
            successEl.classList.add("is-visible");
            statusEl.textContent = "";
            // Mark user as registered
            localStorage.setItem('cdl_registered', 'true');

            // Broadcast to ticker
            if (supabase) {
              supabase.channel('registrations').send({
                type: 'broadcast',
                event: 'new-registration',
                payload: { playerName: payload.playerName }
              });
            }

            // Hide everything except success for clean full-screen takeover
            document.querySelector(".panel--form .panel-headline").style.display = "none";
            document.querySelector(".progress-tracker").style.display = "none";
            const footer = document.querySelector(".footer-note");
            if (footer) footer.style.display = "none";
          } else {
            statusEl.textContent = "Error. Try again or contact the host.";
          }
        } catch (error) {
          statusEl.textContent = "Network error. Please try again.";
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Music Toggle - Desktop only
      const musicToggle = document.getElementById('musicToggle');
      const bgMusic = document.getElementById('bgMusic');
      let isPlaying = false;

      bgMusic.volume = 0.08;

      musicToggle.addEventListener('click', function() {
        musicToggle.classList.add('collapsed');

        if (isPlaying) {
          bgMusic.pause();
          musicToggle.classList.remove('is-playing');
          isPlaying = false;
        } else {
          bgMusic.volume = 0;
          bgMusic.play();
          // Fade in
          let vol = 0;
          const fadeIn = setInterval(() => {
            vol += 0.004;
            if (vol >= 0.08) {
              bgMusic.volume = 0.08;
              clearInterval(fadeIn);
            } else {
              bgMusic.volume = vol;
            }
          }, 25);
          musicToggle.classList.add('is-playing');
          isPlaying = true;
        }
      });

      // Smooth volume fade
      function fadeAudio(audio, targetVolume, duration, callback) {
        const startVolume = audio.volume;
        const volumeDiff = targetVolume - startVolume;
        const steps = 20;
        const stepTime = duration / steps;
        let currentStep = 0;

        const fadeInterval = setInterval(() => {
          currentStep++;
          audio.volume = Math.max(0, Math.min(1, startVolume + (volumeDiff * (currentStep / steps))));

          if (currentStep >= steps) {
            clearInterval(fadeInterval);
            audio.volume = targetVolume;
            if (callback) callback();
          }
        }, stepTime);
      }

      // ========================================
      // WHO'S IN - Load registered players
      // ========================================
      let registeredPlayers = [];

      // DEV ONLY: Mock players for local testing
      const MOCK_PLAYERS = [
        { name: 'Erik Rodriguez' },
        { name: 'Jordan Martinez' },
        { name: 'Carlos Fernández' },
        { name: 'Maria Santos' },
        { name: 'Luis Herrera' },
        { name: 'Ana García' },
      ];

      async function loadPlayers() {
        const chatPlayerSelect = document.getElementById('chatPlayerSelect');

        try {
          const response = await fetch('/api/players');
          const data = await response.json();
          // Use mock data if API returns empty or errors
          registeredPlayers = (data.players && data.players.length > 0) ? data.players : MOCK_PLAYERS;

          // Update progress counter
          const playerCount = document.getElementById('playerCount');
          const spotsLeft = document.getElementById('spotsLeft');
          const spotsLeftButton = document.getElementById('spotsLeftButton');
          const progressFill = document.getElementById('progressFill');
          if (playerCount) playerCount.textContent = registeredPlayers.length;
          if (spotsLeft) spotsLeft.textContent = `${16 - registeredPlayers.length} spots left`;
          if (spotsLeftButton) spotsLeftButton.textContent = 16 - registeredPlayers.length;
          if (progressFill) progressFill.style.width = `${(registeredPlayers.length / 16) * 100}%`;

          // Populate chat player selector
          const chatNameInput = document.getElementById('chatNameInput');
          const chatRegisterHint = document.getElementById('chatRegisterHint');

          if (registeredPlayers.length > 0) {
            // Show custom dropdown with registered players
            populateCustomDropdown(registeredPlayers);
            if (customSelect) customSelect.style.display = 'block';
            if (chatPlayerSelect) chatPlayerSelect.style.display = 'none';
            if (chatNameInput) chatNameInput.style.display = 'none';
            if (chatRegisterHint) chatRegisterHint.innerHTML = 'Don\'t see your name? <a href="#signup" class="chat-identity__register-link">Register first</a>';
          } else {
            // No players - show text input instead
            if (customSelect) customSelect.style.display = 'none';
            if (chatPlayerSelect) chatPlayerSelect.style.display = 'none';
            if (chatNameInput) chatNameInput.style.display = 'block';
            if (chatRegisterHint) chatRegisterHint.textContent = 'Enter the name you registered with';
          }
        } catch (err) {
          console.error('Failed to load players, using mock data:', err);
          // On error, use mock data for local dev testing
          registeredPlayers = MOCK_PLAYERS;
          const chatNameInput = document.getElementById('chatNameInput');
          const chatRegisterHint = document.getElementById('chatRegisterHint');
          // Show custom dropdown with mock players
          populateCustomDropdown(registeredPlayers);
          if (customSelect) customSelect.style.display = 'block';
          if (chatPlayerSelect) chatPlayerSelect.style.display = 'none';
          if (chatNameInput) chatNameInput.style.display = 'none';
          if (chatRegisterHint) chatRegisterHint.innerHTML = 'Don\'t see your name? <a href="#signup" class="chat-identity__register-link">Register first</a>';
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ========================================
      // CUSTOM DROPDOWN LOGIC
      // ========================================
      const customSelect = document.getElementById('customSelect');
      const selectTrigger = document.getElementById('selectTrigger');
      const selectValue = document.getElementById('selectValue');
      const selectDropdown = document.getElementById('selectDropdown');
      const selectOptions = document.getElementById('selectOptions');
      const selectSearch = document.getElementById('selectSearch');
      let selectedPlayer = null;

      // Toggle dropdown
      selectTrigger?.addEventListener('click', () => {
        customSelect.classList.toggle('is-open');
        if (customSelect.classList.contains('is-open')) {
          selectSearch.focus();
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (customSelect && !customSelect.contains(e.target)) {
          customSelect.classList.remove('is-open');
        }
      });

      // Search/filter functionality
      selectSearch?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const options = selectOptions.querySelectorAll('.custom-select__option');
        let hasVisible = false;

        options.forEach(option => {
          const name = option.textContent.toLowerCase();
          if (name.includes(query)) {
            option.classList.remove('is-hidden');
            hasVisible = true;
          } else {
            option.classList.add('is-hidden');
          }
        });

        // Show/hide empty state
        let emptyEl = selectOptions.querySelector('.custom-select__empty');
        if (!hasVisible) {
          if (!emptyEl) {
            emptyEl = document.createElement('li');
            emptyEl.className = 'custom-select__empty';
            emptyEl.textContent = 'No matches found';
            selectOptions.appendChild(emptyEl);
          }
          emptyEl.style.display = 'block';
        } else if (emptyEl) {
          emptyEl.style.display = 'none';
        }
      });

      // Populate custom dropdown
      function populateCustomDropdown(players) {
        if (!selectOptions) return;

        // Hide search for small lists (less than 8 players)
        const searchContainer = document.querySelector('.custom-select__search');
        if (searchContainer) {
          searchContainer.style.display = players.length < 8 ? 'none' : 'block';
        }

        selectOptions.innerHTML = players.map(player =>
          `<li class="custom-select__option" data-value="${escapeHtml(player.name)}">${escapeHtml(player.name)}</li>`
        ).join('');

        // Add click and hover handlers to options
        selectOptions.querySelectorAll('.custom-select__option').forEach(option => {
          option.addEventListener('click', () => {
            const value = option.dataset.value;
            selectPlayer(value);
          });
          // JS-based hover for reliable highlighting
          option.addEventListener('mouseenter', () => {
            option.style.background = 'rgba(212, 165, 116, 0.4)';
            option.style.color = '#ffffff';
            option.style.borderLeftColor = '#d4a574';
            option.style.paddingLeft = '28px';
            option.style.cursor = 'pointer';
          });
          option.addEventListener('mouseleave', () => {
            option.style.background = 'transparent';
            option.style.color = 'rgba(255, 255, 255, 0.6)';
            option.style.borderLeftColor = 'transparent';
            option.style.paddingLeft = '20px';
            option.style.cursor = 'pointer';
          });
        });

        // Reset selected state
        if (selectValue) {
          selectValue.textContent = 'Select Your Name...';
          selectValue.classList.add('custom-select__value--placeholder');
        }
        selectedPlayer = null;
        const joinBtn = document.getElementById('chatJoinBtn');
        if (joinBtn) joinBtn.disabled = true;
      }

      // Select a player
      function selectPlayer(name) {
        selectedPlayer = name;

        // Update display
        selectValue.textContent = name;
        selectValue.classList.remove('custom-select__value--placeholder');

        // Update selected state
        selectOptions.querySelectorAll('.custom-select__option').forEach(opt => {
          opt.classList.toggle('is-selected', opt.dataset.value === name);
        });

        // Update hidden native select for form compatibility
        if (chatPlayerSelect) {
          chatPlayerSelect.value = name;
        }

        // Enable the Enter button
        const joinBtn = document.getElementById('chatJoinBtn');
        if (joinBtn) joinBtn.disabled = false;

        // Close dropdown
        customSelect.classList.remove('is-open');
        selectSearch.value = '';
        selectOptions.querySelectorAll('.custom-select__option').forEach(opt => opt.classList.remove('is-hidden'));
      }

      // Keyboard navigation
      selectSearch?.addEventListener('keydown', (e) => {
        const visibleOptions = [...selectOptions.querySelectorAll('.custom-select__option:not(.is-hidden)')];
        const currentIndex = visibleOptions.findIndex(opt => opt.classList.contains('is-focused'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const nextIndex = currentIndex < visibleOptions.length - 1 ? currentIndex + 1 : 0;
          visibleOptions.forEach((opt, i) => opt.classList.toggle('is-focused', i === nextIndex));
          visibleOptions[nextIndex]?.scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          const prevIndex = currentIndex > 0 ? currentIndex - 1 : visibleOptions.length - 1;
          visibleOptions.forEach((opt, i) => opt.classList.toggle('is-focused', i === prevIndex));
          visibleOptions[prevIndex]?.scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const focused = visibleOptions.find(opt => opt.classList.contains('is-focused')) || visibleOptions[0];
          if (focused) selectPlayer(focused.dataset.value);
        } else if (e.key === 'Escape') {
          customSelect.classList.remove('is-open');
        }
      });

      // Highlight @mentions in chat messages
      function highlightMentions(text) {
        // Match @followed by word characters (letters, numbers, spaces in names)
        return text.replace(/@([A-Za-z0-9\s]+?)(?=\s|$|[.,!?])/g, '<span class="mention">@$1</span>');
      }

      // Load players on page load
      loadPlayers();

      // ========================================
      // MESA LIVE COUNT & CLAIMED SEATS
      // ========================================
      let claimedSeats = new Set(); // Players who have already joined the chat

      async function loadMesaStats() {
        const countEl = document.getElementById('mesaPlayerCount');
        if (!countEl) return;

        // Try to get active players from Supabase
        try {
          // Wait for Supabase to be ready
          if (typeof supabase === 'undefined' || !supabase) {
            // Show mock count for local dev
            countEl.textContent = '3';
            return;
          }

          // Get unique players who have posted messages (last 24 hours = active)
          const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
          const { data, error } = await supabase
            .from('messages')
            .select('player_name')
            .gte('created_at', oneDayAgo);

          if (error) throw error;

          // Get unique player names
          const uniquePlayers = [...new Set(data.map(m => m.player_name))];
          claimedSeats = new Set(uniquePlayers);

          // Update count
          countEl.textContent = uniquePlayers.length.toString();

          // Refresh dropdown to filter out claimed seats
          if (registeredPlayers.length > 0) {
            const availablePlayers = registeredPlayers.filter(p => !claimedSeats.has(p.name));
            populateCustomDropdown(availablePlayers.length > 0 ? availablePlayers : registeredPlayers);
          }
        } catch (err) {
          console.error('Failed to load mesa stats:', err);
          // Show mock count
          countEl.textContent = '3';
        }
      }

      // Load mesa stats after a short delay (wait for Supabase init)
      setTimeout(loadMesaStats, 1500);

      // ========================================
      // CHAT - Supabase real-time chat
      // ========================================
      // Chat state (declare early so it's available)
      let chatIdentity = JSON.parse(localStorage.getItem('cdl_chat_identity') || 'null');
      let unreadCount = 0;
      let chatOpen = false;
      let selectedAvatar = 'cuba'; // Default
      let messagesChannel = null;
      let registrationsChannel = null;

      // Initialize Supabase
      let supabase = null;

      // Dynamically load Supabase script
      function loadSupabaseScript() {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/dist/umd/supabase.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      function initSupabase() {
        if (window.supabase && !supabase) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          return true;
        }
        return !!supabase;
      }

      // Load Supabase and initialize (only if configured)
      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        loadSupabaseScript().then(() => {
          if (initSupabase() && chatIdentity) {
            loadMessages();
            subscribeToMessages();
          }
        }).catch(err => {
          console.error('Failed to load Supabase:', err);
        });
      }

      // ========================================
      // CHAT WIDGET LOGIC
      // ========================================
      const chatWidget = document.getElementById('chatWidget');
      const chatToggle = document.getElementById('chatToggle');
      const chatPanel = document.getElementById('chatPanel');
      const chatClose = document.getElementById('chatClose');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
      const chatMessages = document.getElementById('chatMessages');
      const chatIdentityScreen = document.getElementById('chatIdentity');
      const chatBodyContainer = document.getElementById('chatBodyContainer');
      const chatBadge = document.getElementById('chatBadge');

      // La Mesa registration flow elements
      const successMesaCta = document.getElementById('successMesaCta');
      const mesaTutorial = document.getElementById('mesaTutorial');
      const tutorialMesaCta = document.getElementById('tutorialMesaCta');
      const tutorialDismiss = document.getElementById('tutorialDismiss');

      // Check if user is already registered → show chat button
      const isRegistered = localStorage.getItem('cdl_registered') === 'true';
      const tickerChatBtn = document.getElementById('tickerChatBtn');
      if (isRegistered && tickerChatBtn) {
        tickerChatBtn.classList.remove('mesa-ticker__chat-btn--hidden');
      }

      // Helper to open chat
      function openChat() {
        // DEFENSIVE CHECK: Never open La Mesa for unregistered users
        const isRegistered = localStorage.getItem('cdl_registered') === 'true';
        if (!isRegistered) {
          routeUnregisteredToRegistration();
          return;
        }

        // Show chat button if hidden
        if (tickerChatBtn) tickerChatBtn.classList.remove('mesa-ticker__chat-btn--hidden');
        chatPanel.style.display = 'flex';
        void chatPanel.offsetWidth;
        chatPanel.classList.add('is-open');
        document.body.classList.add('chat-open'); // Lock scroll via CSS class
        // Dim ticker when chat is open
        if (mesaTicker) mesaTicker.classList.add('ticker-dimmed');
      }

      // Success CTA: Close success overlay, open chat
      if (successMesaCta) {
        successMesaCta.addEventListener('click', () => {
          successEl.classList.remove('is-visible');
          openChat();
        });
      }

      // Track if user opened La Mesa from success screen
      let openedFromSuccess = false;
      if (successMesaCta) {
        successMesaCta.addEventListener('click', () => {
          openedFromSuccess = true;
        });
      }

      // Show tutorial if user dismisses success without clicking La Mesa
      // Listen for clicks outside success content area
      if (successEl) {
        successEl.addEventListener('click', (e) => {
          // Only trigger if clicking the backdrop, not the content
          if (e.target === successEl && !openedFromSuccess) {
            successEl.classList.remove('is-visible');
            // Show tutorial after short delay
            setTimeout(() => {
              if (mesaTutorial) {
                mesaTutorial.classList.add('is-visible');
              }
            }, 300);
          }
        });
      }

      // Tutorial CTA: Join the table
      if (tutorialMesaCta) {
        tutorialMesaCta.addEventListener('click', () => {
          mesaTutorial.classList.remove('is-visible');
          openChat();
        });
      }

      // Tutorial Dismiss: Just show the button, don't open chat
      if (tutorialDismiss) {
        tutorialDismiss.addEventListener('click', () => {
          mesaTutorial.classList.remove('is-visible');
          if (tickerChatBtn) tickerChatBtn.classList.remove('mesa-ticker__chat-btn--hidden');
        });
      }

      // Haptics Helper
      const vibrate = (pattern = 5) => {
        if (navigator.vibrate) navigator.vibrate(pattern);
      };

      const chatBackdrop = document.getElementById('chatBackdrop');
      const mesaTicker = document.getElementById('mesaTicker');
      const mesaHelp = document.getElementById('mesaHelp');
      const mesaHelpDismiss = document.getElementById('mesaHelpDismiss');
      let mesaHelpTimeout = null;
      const registrationPanel = document.querySelector('.panel--form');
      let lastTickerActivateAt = 0;

      function getPanelVisibilityRatio(panelEl) {
        if (!storyEl || !panelEl) return 0;
        const storyRect = storyEl.getBoundingClientRect();
        const panelRect = panelEl.getBoundingClientRect();
        const visibleTop = Math.max(storyRect.top, panelRect.top);
        const visibleBottom = Math.min(storyRect.bottom, panelRect.bottom);
        const visible = Math.max(0, visibleBottom - visibleTop);
        return panelRect.height > 0 ? visible / panelRect.height : 0;
      }

      function isRegistrationPanelActive() {
        return getPanelVisibilityRatio(registrationPanel) >= 0.7;
      }

      function showMesaHelp() {
        if (!mesaHelp) return;
        // Only show this bubble while the registration panel is actually on screen.
        if (!isRegistrationPanelActive()) return;
        if (mesaHelpTimeout) clearTimeout(mesaHelpTimeout);
        mesaHelp.classList.add('is-visible');
        mesaHelpTimeout = setTimeout(() => {
          mesaHelp.classList.remove('is-visible');
          mesaHelpTimeout = null;
        }, 6500);
      }

	      function hideMesaHelp() {
	        if (!mesaHelp) return;
	        if (mesaHelpTimeout) clearTimeout(mesaHelpTimeout);
	        mesaHelpTimeout = null;
	        mesaHelp.classList.remove('is-visible');
	      }

	      // Make the bubble feel like a toast, not a modal: tapping it dismisses immediately.
	      mesaHelp?.addEventListener('click', hideMesaHelp);
	      mesaHelpDismiss?.addEventListener('click', hideMesaHelp);
      storyEl?.addEventListener(
        'scroll',
        () => {
          if (!isRegistrationPanelActive()) hideMesaHelp();
        },
        { passive: true }
      );

      // DEBUG: Track ticker class changes
      if (mesaTicker) {
        const tickerObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === 'class') {
              console.log('[TICKER DEBUG] Class changed:', mesaTicker.className);
              console.log('[TICKER DEBUG] Has ticker-dimmed:', mesaTicker.classList.contains('ticker-dimmed'));
            }
          });
        });
        tickerObserver.observe(mesaTicker, { attributes: true });
        console.log('[TICKER DEBUG] Initial class:', mesaTicker.className);
      }

      // Toggle Chat & Scroll Lock
      function toggleChat() {
        const isOpen = chatPanel.classList.contains('is-open');

        if (isOpen) {
          // Close
          chatPanel.classList.remove('is-open');
          chatBackdrop.classList.remove('is-visible');
          mesaTicker.classList.remove('ticker-dimmed'); // JS fallback for :has()
          document.body.classList.remove('chat-open'); // Unlock scroll via CSS class
          vibrate(5);
        } else {
          // DEFENSIVE CHECK: Never open La Mesa for unregistered users
          const isRegistered = localStorage.getItem('cdl_registered') === 'true';
          if (!isRegistered) {
            routeUnregisteredToRegistration();
            return;
          }

          // Open
          chatBackdrop.classList.add('is-visible');
          mesaTicker.classList.add('ticker-dimmed'); // JS fallback for :has()

          // Tobias: Clear unread state when entering the room
          tickerChatBtn.classList.remove('has-unread');
          if (chatBadge) chatBadge.style.display = 'none';
          unreadCount = 0;

          // Force reflow for animation
          void chatPanel.offsetWidth;
          chatPanel.classList.add('is-open');

          if (window.innerWidth <= 768) {
            document.body.classList.add('chat-open'); // Lock scroll via CSS class
          }
          vibrate(10);

          // Focus input if joined
          if (chatBodyContainer && chatBodyContainer.style.display !== 'none') {
             setTimeout(() => chatInput.focus(), 100);
          }
        }
      }

      function routeUnregisteredToRegistration() {
        // Ensure nothing can "fight" the teleport.
        unlockScroll();
        whisperHasPlayed = true;
        buildHasPlayed = true;
        slamHasPlayed = true;
        rulesHasPlayed = true;
        whisperPanel?.classList.add('has-played');
        buildPanel?.classList.add('has-played');
        slamPanel?.classList.add('has-played');
        rulesPanel?.classList.add('has-played');

        // Teleport to the registration panel (smooth scroll + scroll-snap is unreliable on iOS Safari).
        if (registrationPanel) snapToPanelTop(registrationPanel);

        // Show the bubble only once we're actually on the form panel.
        let tries = 0;
        const tryShow = () => {
          tries += 1;
          if (isRegistrationPanelActive()) {
            showMesaHelp();
            if (submitBtn) {
              submitBtn.classList.remove('is-unlock-hinted');
              void submitBtn.offsetWidth;
              submitBtn.classList.add('is-unlock-hinted');
              setTimeout(() => submitBtn.classList.remove('is-unlock-hinted'), 1300);
            }
            return;
          }
          if (tries < 20) requestAnimationFrame(tryShow);
        };
        requestAnimationFrame(tryShow);
      }

      function handleTickerActivate() {
        const now = Date.now();
        if (now - lastTickerActivateAt < 350) return;
        lastTickerActivateAt = now;

        const isRegistered = localStorage.getItem('cdl_registered') === 'true';
        if (!isRegistered) {
          routeUnregisteredToRegistration();
          return;
        }
        toggleChat();
      }

      tickerChatBtn?.addEventListener('click', handleTickerActivate);
      // iOS Safari reliability: treat a touch pointer-up as activation (guarded to avoid double fire).
      tickerChatBtn?.addEventListener('pointerup', (e) => {
        if (e.pointerType === 'touch') handleTickerActivate();
      });
      chatBackdrop.addEventListener('click', toggleChat);
      // Leave the table: clears identity + presence, then closes the panel
      chatClose.addEventListener('click', () => {
        // If user never joined, treat as a normal close
        if (!chatIdentity) {
          toggleChat();
          return;
        }

        const ok = window.confirm("Leave the table? You'll need to pick your name again to re-enter.");
        if (!ok) return;

        // Leave presence and any live subscriptions tied to the current identity
        leaveMesaPresence();
        if (messagesChannel) {
          messagesChannel.unsubscribe();
          messagesChannel = null;
        }
        if (registrationsChannel) {
          registrationsChannel.unsubscribe();
          registrationsChannel = null;
        }

        // Reset identity
        chatIdentity = null;
        localStorage.removeItem('cdl_chat_identity');

        // Reset UI back to identity screen
        try {
          resetDropdown();
        } catch {}

        chatBodyContainer.style.display = 'none';
        chatIdentityScreen.style.display = 'flex';
        chatSend.disabled = true;
        chatInput.value = '';

        // Optional: clear current message list; rejoin will re-fetch
        // Keep a clean slate so the identity screen doesn't "collect" messages in the background.
        if (chatMessages) {
          chatMessages.innerHTML = '<div class="chat-empty">The table is quiet.</div>';
        }

        toggleChat();
      });

      // Register link in chat - close chat and scroll to registration
      const chatRegisterLink = document.getElementById('chatRegisterLink');
      chatRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        toggleChat(); // Close the chat
        // Scroll to registration form
        const signupForm = document.getElementById('signup');
        if (signupForm) {
          signupForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });

      // Swipe to Close (Mobile)
      let touchStartY = 0;
      let touchEndY = 0;

      chatPanel.addEventListener('touchstart', (e) => {
        touchStartY = e.changedTouches[0].screenY;
      }, {passive: true});

      chatPanel.addEventListener('touchmove', (e) => {
         // Prevent closing if scrolling messages
         if (chatMessages.contains(e.target) && chatMessages.scrollTop > 0) return;
         touchEndY = e.changedTouches[0].screenY;
      }, {passive: true});

      chatPanel.addEventListener('touchend', (e) => {
        touchEndY = e.changedTouches[0].screenY;
        const swipeDistance = touchEndY - touchStartY;
        
        // If swiped down more than 100px (and not scrolling messages)
        if (swipeDistance > 100 && (!chatMessages.contains(e.target) || chatMessages.scrollTop <= 0)) {
           toggleChat(); // Close
        }
      });
      
      // Prevent background scroll when touching the chat on mobile
      chatPanel.addEventListener('touchmove', (e) => {
         if (!chatMessages.contains(e.target)) {
            e.preventDefault();
         }
      }, {passive: false});


      // Identity State (Continued)

      // Avatar selection
      const avatarOptions = document.querySelectorAll('.avatar-option');
      avatarOptions.forEach(opt => {
        opt.addEventListener('click', () => {
          avatarOptions.forEach(o => o.classList.remove('selected'));
          opt.classList.add('selected');
          selectedAvatar = opt.dataset.avatar;
        });
      });

      // Player selection handler (individual sign-ups, no teams until draft)
      const chatPlayerSelect = document.getElementById('chatPlayerSelect');
      const chatNameInput = document.getElementById('chatNameInput');
      const chatJoinBtn = document.getElementById('chatJoinBtn');

      // Enable button when select changes
      chatPlayerSelect.addEventListener('change', (e) => {
        chatJoinBtn.disabled = !e.target.value;
      });

      // Enable button when typing in text input
      chatNameInput.addEventListener('input', (e) => {
        chatJoinBtn.disabled = !e.target.value.trim();
      });

      // Join chat handler - Free Agent status until team assignment
      chatJoinBtn.addEventListener('click', () => {
        // Get name from custom dropdown, native select, or text input
        const playerName = selectedPlayer
          || (chatPlayerSelect.style.display !== 'none' ? chatPlayerSelect.value : null)
          || chatNameInput.value.trim();
        // Using selectedAvatar from global state

        if (playerName) {
          // All players are Free Agents until the team assignment
          chatIdentity = { teamName: null, playerName, avatar: selectedAvatar, status: 'free_agent' };
          localStorage.setItem('cdl_chat_identity', JSON.stringify(chatIdentity));
          showChatInterface();
        }
      });

      function showChatInterface() {
        chatIdentityScreen.style.display = 'none';
        chatBodyContainer.style.display = 'flex'; // Use flex for the container
        chatSend.disabled = false;

        // Only load if supabase is ready, otherwise the interval will handle it
        if (supabase) {
          loadMessages();
          subscribeToMessages();
          subscribeToRegistrations();
          joinMesaPresence(); // Mesa Mode: Show who's at the table
        }

        // George: Make entrances MATTER - show announcement
        showEntranceAnnouncement(chatIdentity.playerName);
      }

      // Entrance announcement - "🎯 [Name] has joined the table"
      function showEntranceAnnouncement(playerName) {
        const announcement = document.createElement('div');
        announcement.className = 'chat-announcement';
        announcement.innerHTML = `
          <span class="chat-announcement__icon">🎯</span>
          <span class="chat-announcement__name">${escapeHtml(playerName)}</span>
          <span> has joined the table</span>
        `;
        chatMessages.appendChild(announcement);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Remove after 5 seconds to keep chat clean
        setTimeout(() => {
          if (announcement.parentNode) {
            announcement.style.opacity = '0';
            announcement.style.transition = 'opacity 0.5s';
            setTimeout(() => announcement.remove(), 500);
          }
        }, 5000);
      }

      // Helper to escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // If already have identity, show chat interface
      if (chatIdentity) {
        // Restore selected avatar if saved, otherwise default
        if(chatIdentity.avatar) selectedAvatar = chatIdentity.avatar;
        showChatInterface();
      }

      // Load existing messages
      async function loadMessages() {
        if (!supabase) return;
        try {
          const { data, error } = await supabase
            .from('messages')
            .select('*')
            .order('created_at', { ascending: true })
            .limit(50);

          if (error) throw error;

          if (data && data.length > 0) {
            renderMessages(data);
          }
        } catch (err) {
          console.error('Failed to load messages:', err);
        }
      }

      function renderMessages(messages) {
        if (messages.length === 0) {
          chatMessages.innerHTML = '<div class="chat-empty">-- NO MESSAGES --</div>';
          return;
        }

        // Separate pinned and regular messages
        const pinned = messages.filter(m => m.is_pinned);
        const regular = messages.filter(m => !m.is_pinned);

        let html = '';

        // Show pinned messages section if any
        if (pinned.length > 0) {
          html += '<div class="pinned-section"><div class="pinned-section__label">📌 Pinned</div>';
          html += pinned.map(msg => createMessageHTML(msg)).join('');
          html += '</div>';
        }

        // Show regular messages
        html += regular.map(msg => createMessageHTML(msg)).join('');

        chatMessages.innerHTML = html;

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Map of avatar codes to emojis
      const FLAG_MAP = {
        'cuba': '🇨🇺',
        'usa': '🇺🇸',
        'pr': '🇵🇷',
        'dr': '🇩🇴',
        'venezuela': '🇻🇪',
        'colombia': '🇨🇴',
        'spain': '🇪🇸'
      };

      // Simple hash function for consistent avatars for others
      function getHashAvatar(name) {
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const avatars = Object.keys(FLAG_MAP);
        return avatars[Math.abs(hash) % avatars.length];
      }

      function createMessageHTML(msg) {
        // For individual sign-ups, check by player name (no teams until draft)
        const isSelf = chatIdentity && msg.player_name === chatIdentity.playerName;
        const selfClass = isSelf ? 'chat-message--self' : '';
        const pinnedClass = msg.is_pinned ? 'chat-message--pinned' : '';

        // Check if Free Agent (no team assigned yet)
        const isFreeAgent = !msg.team_name || msg.team_name === 'Free Agent';

        // Use stored avatar, fallback to hash for old messages
        // Default to 'cuba' if local, or hash if remote
        let avatarType = msg.avatar || (isSelf ? (chatIdentity.avatar || 'cuba') : getHashAvatar(msg.player_name));

        // Handle legacy avatars (map old pixel types to flags if they exist in DB)
        if (!FLAG_MAP[avatarType]) {
             // quick map for legacy data
             if (avatarType === 'domino') avatarType = 'cuba';
             else if (avatarType === 'cigar') avatarType = 'usa';
             else if (avatarType === 'cafecito') avatarType = 'pr';
             else if (avatarType === 'carro') avatarType = 'dr';
             else if (avatarType === 'palma') avatarType = 'venezuela';
             else if (avatarType === 'bandera') avatarType = 'colombia';
             else if (avatarType === 'conga') avatarType = 'spain';
             else avatarType = 'cuba'; // Fallback
        }

        const emoji = FLAG_MAP[avatarType] || '🇨🇺';

        // Free Agent pip - single pip = "half of something, waiting for partner"
        const freeAgentBadge = isFreeAgent ? '<span class="free-agent-pip">●</span>' : '';

        return `
          <div class="chat-message ${selfClass} ${pinnedClass}" data-msg-id="${msg.id}">
            ${msg.is_pinned ? '<div class="pinned-badge">PINNED</div>' : ''}
            <div class="chat-message__content-wrapper">
              <div class="chat-message__header">
                <span class="chat-message__author">
                  <span class="chat-message__flag">${emoji}</span>
                  <span class="chat-message__author-name">${escapeHtml(msg.player_name)}</span>
                  ${freeAgentBadge}
                </span>
                <span class="chat-message__time">${formatTime(msg.created_at)}</span>
              </div>
              <div class="chat-message__content">${highlightMentions(escapeHtml(msg.content))}</div>
            </div>
          </div>
        `;
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'NOW';
        if (diffMins < 60) return `${diffMins}m`;
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h`;
        return date.toLocaleDateString();
      }

      // Subscribe to new messages
      function subscribeToMessages() {
        if (!supabase) return;
        if (messagesChannel) return;

        messagesChannel = supabase
          .channel('messages')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
            const msg = payload.new;
            appendMessage(msg);

            // Add to ticker as "talking" activity
            if (msg.player_name && !msg.is_pinned) {
              addTickerEvent('chat', msg.player_name);
              updateTicker(presenceChannel ? presenceChannel.presenceState() : {});
            }

            // Update unread count if chat is closed
            const isOpen = chatPanel && chatPanel.classList.contains('is-open');
            if (!isOpen) {
              unreadCount++;
              // Tobias: Make the room feel like it's calling for you
              if (tickerChatBtn) tickerChatBtn.classList.add('has-unread');
              if (chatBadge) {
                chatBadge.textContent = unreadCount;
                chatBadge.style.display = 'flex';
              }
            }
          })
          .subscribe();
      }

      // Subscribe to real-time registrations
      function subscribeToRegistrations() {
        if (!supabase) return;
        if (registrationsChannel) return;

        registrationsChannel = supabase
          .channel('registrations')
          .on('broadcast', { event: 'new-registration' }, (payload) => {
            addTickerEvent('register', payload.payload.playerName);
            updateTicker(presenceChannel ? presenceChannel.presenceState() : {});
          })
          .subscribe();
      }

      // ========================================
      // MESA TICKER - ESPN-style activity feed
      // ========================================
      const tickerTrack = document.getElementById('tickerTrack');
      let presenceChannel = null;
      let tickerEvents = []; // Store recent events for the ticker
      let tickerInitialized = false; // Prevent resets after initial load

      // Initialize ticker with mock data for preview
      function initTickerMock() {
        const mockEvents = [
          { type: 'register', playerName: 'Alex Torres' },
          { type: 'register', playerName: 'Carmen Ruiz' },
          { type: 'update', playerName: 'Registration closes Friday' },
          { type: 'register', playerName: 'Danny Rodriguez' },
          { type: 'register', playerName: 'Maria Elena' },
          { type: 'update', playerName: '$500 prize pool' },
          { type: 'register', playerName: 'Jorge Mendez' },
          { type: 'register', playerName: 'Sofia Vega' }
        ];

        tickerEvents = mockEvents;
        updateTicker({}, true); // true = force update
      }

      // Show mock data initially
      initTickerMock();

      // Mobile: Pause ticker on touch (touchend may not fire on the same element if user drags)
      function pauseTickerOnTouch() {
        if (!tickerTrack) return;
        tickerTrack.style.animationPlayState = 'paused';

        const resume = () => {
          // Resume after a brief moment so user can read (and avoid "stuck paused" states)
          setTimeout(() => {
            if (tickerTrack) tickerTrack.style.animationPlayState = 'running';
          }, 900);
        };

        window.addEventListener('touchend', resume, { passive: true, once: true });
        window.addEventListener('touchcancel', resume, { passive: true, once: true });
      }

      tickerTrack.addEventListener('touchstart', pauseTickerOnTouch, { passive: true });

      function joinMesaPresence() {
        if (!supabase || !chatIdentity) return;

        presenceChannel = supabase.channel('mesa-presence', {
          config: {
            presence: {
              key: chatIdentity.playerName,
            },
          },
        });

        presenceChannel
          .on('presence', { event: 'sync' }, () => {
            const state = presenceChannel.presenceState();
            updateTicker(state);
          })
          .on('presence', { event: 'join' }, ({ key, newPresences }) => {
            // Add join event to ticker
            if (newPresences[0] && (!chatIdentity || newPresences[0].playerName !== chatIdentity.playerName)) {
              addTickerEvent('join', newPresences[0].playerName);
              updateTicker(presenceChannel.presenceState());
            }
          })
          .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
            // Could add leave events if desired
          })
          .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
              await presenceChannel.track({
                playerName: chatIdentity.playerName,
                teamName: chatIdentity.teamName,
                avatar: chatIdentity.avatar,
                joinedAt: new Date().toISOString(),
              });
            }
          });
      }

      function addTickerEvent(type, playerName) {
        tickerEvents.unshift({ type, playerName, time: Date.now() });
        // Keep only last 10 events
        tickerEvents = tickerEvents.slice(0, 10);

        // Tobias: Add micro-moment feel with subtle vibration for registrations
        if (type === 'register' || type === 'update') {
          vibrate([10, 30, 20]);
          
          // Tobias: "Breath spacing" - slow down the room when big news arrives
          if (tickerTrack) {
            tickerTrack.style.animationDuration = '60s'; // Slow down to let it breathe
            setTimeout(() => {
              if (tickerTrack) tickerTrack.style.animationDuration = '24s'; // Resume normal pace
            }, 3000);
          }
        }
      }

      function updateTicker(state, forceUpdate = false) {
        // Skip if already initialized (prevents animation reset)
        if (tickerInitialized && !forceUpdate) return;

        const users = [];

        // Collect all users from presence state
        for (const [key, presences] of Object.entries(state)) {
          if (presences.length > 0) {
            users.push(presences[0]);
          }
        }

        const liveCount = users.length;

        // Build ticker - simple, clean
        let items = [];

        // Live count
        items.push(`<span class="ticker-item ticker-live"><span class="ticker-live-dot"></span>${liveCount} at the table</span>`);

        // Spots remaining
        const spotsRemaining = PLAYERS_GOAL - PLAYERS_REGISTERED;
        items.push(`<span class="ticker-item ticker-spots">${spotsRemaining} spots left</span>`);

        // Tournament updates (copper, important)
        tickerEvents
          .filter(event => event.type === 'update')
          .slice(0, 2)
          .forEach(event => {
            items.push(`<span class="ticker-item ticker-update">${escapeHtml(event.playerName)}</span>`);
          });

        // Recent registrations with action
        tickerEvents
          .filter(event => event.type === 'register')
          .slice(0, 4)
          .forEach(event => {
            items.push(`<span class="ticker-item ticker-name">${escapeHtml(event.playerName)}<span class="ticker-action">just joined</span></span>`);
          });

        // If no registrations yet
        if (items.length === 2) {
          items.push(`<span class="ticker-item ticker-waiting">Be the first to join</span>`);
        }

        const content = items.join('');
        // Duplicate for seamless infinite scroll - add spacer for clean loop
        const newHTML = content + '<span class="ticker-spacer"></span>' + content + '<span class="ticker-spacer"></span>';
        tickerTrack.innerHTML = newHTML;
        tickerInitialized = true;
      }

      function leaveMesaPresence() {
        if (presenceChannel) {
          presenceChannel.unsubscribe();
          presenceChannel = null;
        }
      }

      // Leave presence when tab closes
      window.addEventListener('beforeunload', leaveMesaPresence);

      function appendMessage(msg) {
        // Remove empty state if present
        const emptyEl = chatMessages.querySelector('.chat-empty');
        if (emptyEl) emptyEl.remove();

        const msgHTML = createMessageHTML(msg);
        const tempContainer = document.createElement('div');
        tempContainer.innerHTML = msgHTML;
        
        chatMessages.appendChild(tempContainer.firstElementChild);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Send message with THE SLAM
      async function sendMessage() {
        const content = chatInput.value.trim();
        if (!content || !chatIdentity) return;

        // Make sure Supabase is initialized
        if (!supabase) {
          initSupabase();
          if (!supabase) {
            alert('Chat is still loading...');
            return;
          }
        }

        // THE SLAM - "When you play a domino, you're declaring." — Wifredo Lam
        chatSend.classList.add('slamming');
        setTimeout(() => chatSend.classList.remove('slamming'), 300);

        chatSend.disabled = true;
        chatInput.disabled = true;

        try {
          const { error } = await supabase
            .from('messages')
            .insert({
              team_name: chatIdentity.teamName || null, // null = Free Agent
              player_name: chatIdentity.playerName,
              content: content,
              avatar: chatIdentity.avatar || 'cuba'
            });

          if (error) throw error;

          chatInput.value = '';
        } catch (err) {
          console.error('Failed to send message:', err);
          alert('Failed to send. Signal lost.');
        } finally {
          chatSend.disabled = false;
          chatInput.disabled = false;
          chatInput.focus();
        }
      }

      chatSend.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Enable send button when there's input
      chatInput.addEventListener('input', () => {
        chatSend.disabled = !chatInput.value.trim();
      });

      // ========================================
      // PINNED MESSAGES - Handle pinning
      // ========================================

      // Handle pin button clicks
      chatMessages.addEventListener('click', async (e) => {
        const pinBtn = e.target.closest('.pin-btn');
        if (pinBtn) {
          e.stopPropagation();
          const msgId = pinBtn.dataset.msgId;
          await togglePin(msgId);
        }
      });

      // Toggle pin on a message
      async function togglePin(msgId) {
        if (!supabase || !chatIdentity) return;

        try {
          // Get current message
          const { data: msg, error: fetchError } = await supabase
            .from('messages')
            .select('is_pinned')
            .eq('id', msgId)
            .single();

          if (fetchError) throw fetchError;

          const newPinState = !msg.is_pinned;

          // Save to Supabase
          const { error: updateError } = await supabase
            .from('messages')
            .update({ is_pinned: newPinState })
            .eq('id', msgId);

          if (updateError) throw updateError;

          // Re-render messages
          loadMessages();

        } catch (err) {
          console.error('Failed to toggle pin:', err);
        }
      }
    </script>
  </body>
</html>
